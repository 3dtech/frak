function lerp(e,t,i){return e+(t-e)*i}function clampAngle(e,t,i){return e<-2*Math.PI&&(e+=2*Math.PI),e>2*Math.PI&&(e-=2*Math.PI),e=Math.max(t,e),e=Math.min(i,e)}function nextLowestPowerOfTwo(e){return Math.max(Math.min(Math.pow(2,Math.floor(Math.log(e)/Math.log(2))),2048),1)}function nextHighestPowerOfTwo(e){return Math.max(Math.min(Math.pow(2,Math.ceil(Math.log(e)/Math.log(2))),2048),1)}function FrakCallback(e,t){return function(){return t.apply(e,arguments)}}function FRAK(e){"function"==typeof e&&e()}function CollectionReference(e){this.list=e}function CollectionView(e,t,i){this.listReference=e,this.view=[],this.keepExact=!!i,this.fnFilter=t,this.length=0;var n=this;this.update=function(){(n.keepExact||n.view.length<n.listReference.list.length)&&(n.view.length=n.listReference.list.length)},this.filter=function(){n.update();for(var e,t=0,i=0;i<n.listReference.list.length&&(e=n.listReference.list[i]);++i)n.fnFilter(e)&&(n.view[t++]=e);for(n.length=t,i=t;i<n.listReference.list.length;++i)n.view[t++]=null},this.forEach=function(e){for(var t=0;t<n.length;++t)e(n.view[t],t)},this.get=function(e){if(e>=0&&e<n.length)return n.view[e];throw Error("Accessing element out of bounds")}}function SamplerAccumulator(){this.samplers=new Array,this.length=0;var e=this;this.add=function(t){e.samplers[e.length++]=t},this.clear=function(){for(var t=0;t<e.samplers.length;++t)e.samplers[t]=null;e.length=0}}function TransparencySort(e,t){if(!e&&!t)return 0;if(e&&!t)return-1;if(!e&&t)return 1;var i=vec3.squaredDistance(TransparencySort.cmpValue,e.globalBoundingSphere.center),n=vec3.squaredDistance(TransparencySort.cmpValue,t.globalBoundingSphere.center);return i>n?-1:i<n?1:0}function Batch(e){this.indices=new Array,this.length=0;var t=this;this.clear=function(){for(var e=0,i=t.indices.length;e<i;++e)t.indices[e]=-1;t.length=0},this.add=function(e){(function(e,t){for(var i=0,n=e.length;i<n;i++)if(e[i]===t)return!0;return!1})(t.indices,e)||(t.indices[t.length++]=e)},this.get=function(i){if(i>=0&&i<t.indices.length){var n=t.indices[i];if(n>=0&&n<e.length)return e[n]}}}function ScreenQuad(e,t,i,n,r){t=t||-1,i=i||-1,n=n||2,r=r||2;var s=[0,1,2,0,2,3];if(e.engine&&!0===e.engine.options.useVAO)try{this.quad=new TrianglesRenderBufferVAO(e,s)}catch(t){this.quad=new TrianglesRenderBuffer(e,s)}else this.quad=new TrianglesRenderBuffer(e,s);this.vertices=new Float32Array(12),this.vertices[0]=t,this.vertices[1]=i,this.vertices[3]=t,this.vertices[4]=i+r,this.vertices[6]=t+n,this.vertices[7]=i+r,this.vertices[9]=t+n,this.vertices[10]=i,this.quad.add("position",this.vertices,3),this.quad.add("uv0",[0,0,0,1,1,1,1,0],2)}function DownloadBinary(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){t(200==this.status?this.response:!1)},i.send()}function LineLineIntersection2D(e,t,i,n,r){var s=(t[0]-e[0])*(n[1]-i[1])-(t[1]-e[1])*(n[0]-i[0]);if(0==s)return!1;var a=((e[1]-i[1])*(n[0]-i[0])-(e[0]-i[0])*(n[1]-i[1]))/s,o=((e[1]-i[1])*(t[0]-e[0])-(e[0]-i[0])*(t[1]-e[1]))/s;return!(a<0||a>1||o<0||o>1)&&(r&&(r[0]=e[0]+a*(t[0]-e[0]),r[1]=e[1]+a*(t[1]-e[1])),!0)}function LineRectIntersection2D(e,t,i,n){return!!(LineLineIntersection2D(e,t,i,[i[0],n[1]])||LineLineIntersection2D(e,t,[i[0],n[1]],n)||LineLineIntersection2D(e,t,n,[n[0],i[1]])||LineLineIntersection2D(e,t,i,[n[0],i[1]]))}function PointInTriangle2D(e,t,i,n){var r=(t[1]-i[1])*(e[0]-i[0])+(i[0]-t[0])*(e[1]-i[1]);if(0==r)return!1;var s=((t[1]-i[1])*(n[0]-i[0])+(i[0]-t[0])*(n[1]-i[1]))/r,a=((i[1]-e[1])*(n[0]-i[0])+(e[0]-i[0])*(n[1]-i[1]))/r;return s>=0&&a>=0&&s+a<=1}function TerrainMesh(){var e=this;this.generate=function(t,i,n){function r(e){return(e+m)/f}function s(e,t,i,n){o.push(e[0],e[1],e[2]),h.push(r(e[0]),r(e[2])),u.push(0,1,0),l.push(0,0,1),o.push(e[0]-.5*t,e[1],e[2]-.5*t),h.push(r(e[0]-.5*t),r(e[2]-.5*t)),u.push(0,1,0),l.push(0,1,0),i!==p&&n!==p&&(o.push(e[0]-.5*t,e[1],e[2]),h.push(r(e[0]-.5*t),r(e[2])),u.push(0,1,0),l.push(0,0,0)),o.push(e[0]-.5*t,e[1],e[2]+.5*t),h.push(r(e[0]-.5*t),r(e[2]+.5*t)),u.push(0,1,0),l.push(1,0,0),i!==v&&n!==v&&(o.push(e[0],e[1],e[2]+.5*t),h.push(r(e[0]),r(e[2]+.5*t)),u.push(0,1,0),l.push(0,0,0)),o.push(e[0]+.5*t,e[1],e[2]+.5*t),h.push(r(e[0]+.5*t),r(e[2]+.5*t)),u.push(0,1,0),l.push(1,1,0),i!==g&&n!==g&&(o.push(e[0]+.5*t,e[1],e[2]),h.push(r(e[0]+.5*t),r(e[2])),u.push(0,1,0),l.push(0,0,0)),o.push(e[0]+.5*t,e[1],e[2]-.5*t),h.push(r(e[0]+.5*t),r(e[2]-.5*t)),u.push(0,1,0),l.push(0,1,1),i!==b&&n!==b&&(o.push(e[0],e[1],e[2]-.5*t),h.push(r(e[0]),r(e[2]-.5*t)),u.push(0,1,0),l.push(0,0,0)),i&&n?(c.push(d+0,d+1,d+2,d+0,d+2,d+3,d+0,d+3,d+4,d+0,d+4,d+5,d+0,d+5,d+6,d+0,d+6,d+1),d+=7):i||n?(c.push(d+0,d+1,d+2,d+0,d+2,d+3,d+0,d+3,d+4,d+0,d+4,d+5,d+0,d+5,d+6,d+0,d+6,d+7,d+0,d+7,d+1),d+=8):(c.push(d+0,d+1,d+2,d+0,d+2,d+3,d+0,d+3,d+4,d+0,d+4,d+5,d+0,d+5,d+6,d+0,d+6,d+7,d+0,d+7,d+8,d+0,d+8,d+1),d+=9)}function a(e,t,i,n){for(var r=vec3.create(),a=e/t,o=-(e-t)/2,h=0;h<a;h++){for(var u=-(e-t)/2,c=0;c<a;c++)if(n&&o>n[0]&&o<n[1]&&u>n[0]&&u<n[1])u+=t;else{if(r[0]=o,r[2]=u,r[1]=i,0==h||h==a-1||0==c||c==a-1){var l=null,d=null;0==h?l=p:h==a-1&&(l=g),0==c?d=b:c==a-1&&(d=v),s(r,t,l,d)}else s(r,t);u+=t}o+=t}}if(n<1)throw"TerrainMesh: numCones must be at least 1";var o=[],h=[],u=[],c=[],l=[],d=0,f=t*Math.pow(2,n-1),m=f/2,p=1,g=2,v=3,b=4,x=.5;a(t,i,x);for(var T=vec2.create(),E=1;E<n;E++)vec2.set(T,-(t-i)/2,(t-i)/2),a(t*=2,i*=2,x*=2,T);e.positions=o,e.barycentric=l,e.normals=u,e.uv=h,e.faces=c}}!function(){"use strict";var e={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(e.exports={},define(function(){return e.exports})):e.exports=window:e.exports=exports,function(e){var t={};if(!d)d=1e-6;t.create=function(){return new Float32Array(2)},t.clone=function(e){var t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t},t.fromValues=function(e,t){var i=new Float32Array(2);return i[0]=e,i[1]=t,i},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},t.set=function(e,t,i){return e[0]=t,e[1]=i,e},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e},t.sub=t.subtract=function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e},t.mul=t.multiply=function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e},t.div=t.divide=function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e},t.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e},t.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e},t.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e},t.dist=t.distance=function(e,t){var i=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(i*i+n*n)},t.sqrDist=t.squaredDistance=function(e,t){var i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n},t.len=t.length=function(e){var t=e[0],i=e[1];return Math.sqrt(t*t+i*i)},t.sqrLen=t.squaredLength=function(e){var t=e[0],i=e[1];return t*t+i*i},t.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},t.normalize=function(e,t){var i=t[0],n=t[1],r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r),e[0]=t[0]*r,e[1]=t[1]*r),e},t.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},t.cross=function(e,t,i){var n=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=n,e},t.lerp=function(e,t,i,n){var r=t[0],s=t[1];return e[0]=r+n*(i[0]-r),e[1]=s+n*(i[1]-s),e},t.transformMat2=function(e,t,i){var n=t[0],r=t[1];return e[0]=n*i[0]+r*i[1],e[1]=n*i[2]+r*i[3],e},t.forEach=function(){var e=new Float32Array(2);return function(t,i,n,r,s,a){var o,h;for(i||(i=2),n||(n=0),h=r?Math.min(r*i+n,t.length):t.length,o=n;o<h;o+=i)e[0]=t[o],e[1]=t[o+1],s(e,e,a),t[o]=e[0],t[o+1]=e[1];return t}}(),t.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},void 0!==e&&(e.vec2=t);var i={};if(!d)d=1e-6;i.create=function(){return new Float32Array(3)},i.clone=function(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},i.fromValues=function(e,t,i){var n=new Float32Array(3);return n[0]=e,n[1]=t,n[2]=i,n},i.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},i.set=function(e,t,i,n){return e[0]=t,e[1]=i,e[2]=n,e},i.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e},i.sub=i.subtract=function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e},i.mul=i.multiply=function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e},i.div=i.divide=function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e},i.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e},i.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e},i.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e},i.dist=i.distance=function(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(i*i+n*n+r*r)},i.sqrDist=i.squaredDistance=function(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return i*i+n*n+r*r},i.len=i.length=function(e){var t=e[0],i=e[1],n=e[2];return Math.sqrt(t*t+i*i+n*n)},i.sqrLen=i.squaredLength=function(e){var t=e[0],i=e[1],n=e[2];return t*t+i*i+n*n},i.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},i.normalize=function(e,t){var i=t[0],n=t[1],r=t[2],s=i*i+n*n+r*r;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s),e},i.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},i.cross=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=i[0],o=i[1],h=i[2];return e[0]=r*h-s*o,e[1]=s*a-n*h,e[2]=n*o-r*a,e},i.lerp=function(e,t,i,n){var r=t[0],s=t[1],a=t[2];return e[0]=r+n*(i[0]-r),e[1]=s+n*(i[1]-s),e[2]=a+n*(i[2]-a),e},i.transformMat4=function(e,t,i){var n=t[0],r=t[1],s=t[2];return e[0]=i[0]*n+i[4]*r+i[8]*s+i[12],e[1]=i[1]*n+i[5]*r+i[9]*s+i[13],e[2]=i[2]*n+i[6]*r+i[10]*s+i[14],e},i.transformQuat=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=i[0],o=i[1],h=i[2],u=i[3],c=u*n+o*s-h*r,l=u*r+h*n-a*s,d=u*s+a*r-o*n,f=-a*n-o*r-h*s;return e[0]=c*u+f*-a+l*-h-d*-o,e[1]=l*u+f*-o+d*-a-c*-h,e[2]=d*u+f*-h+c*-o-l*-a,e},i.forEach=function(){var e=new Float32Array(3);return function(t,i,n,r,s,a){var o,h;for(i||(i=3),n||(n=0),h=r?Math.min(r*i+n,t.length):t.length,o=n;o<h;o+=i)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],s(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}}(),i.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},void 0!==e&&(e.vec3=i);var n={};if(!d)d=1e-6;n.create=function(){return new Float32Array(4)},n.clone=function(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},n.fromValues=function(e,t,i,n){var r=new Float32Array(4);return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r},n.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},n.set=function(e,t,i,n,r){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e},n.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},n.sub=n.subtract=function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e},n.mul=n.multiply=function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e},n.div=n.divide=function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e},n.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e},n.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e},n.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},n.dist=n.distance=function(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2],s=t[3]-e[3];return Math.sqrt(i*i+n*n+r*r+s*s)},n.sqrDist=n.squaredDistance=function(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2],s=t[3]-e[3];return i*i+n*n+r*r+s*s},n.len=n.length=function(e){var t=e[0],i=e[1],n=e[2],r=e[3];return Math.sqrt(t*t+i*i+n*n+r*r)},n.sqrLen=n.squaredLength=function(e){var t=e[0],i=e[1],n=e[2],r=e[3];return t*t+i*i+n*n+r*r},n.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},n.normalize=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=i*i+n*n+r*r+s*s;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e[3]=t[3]*a),e},n.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},n.lerp=function(e,t,i,n){var r=t[0],s=t[1],a=t[2],o=t[3];return e[0]=r+n*(i[0]-r),e[1]=s+n*(i[1]-s),e[2]=a+n*(i[2]-a),e[3]=o+n*(i[3]-o),e},n.transformMat4=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3];return e[0]=i[0]*n+i[4]*r+i[8]*s+i[12]*a,e[1]=i[1]*n+i[5]*r+i[9]*s+i[13]*a,e[2]=i[2]*n+i[6]*r+i[10]*s+i[14]*a,e[3]=i[3]*n+i[7]*r+i[11]*s+i[15]*a,e},n.transformQuat=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=i[0],o=i[1],h=i[2],u=i[3],c=u*n+o*s-h*r,l=u*r+h*n-a*s,d=u*s+a*r-o*n,f=-a*n-o*r-h*s;return e[0]=c*u+f*-a+l*-h-d*-o,e[1]=l*u+f*-o+d*-a-c*-h,e[2]=d*u+f*-h+c*-o-l*-a,e},n.forEach=function(){var e=new Float32Array(4);return function(t,i,n,r,s,a){var o,h;for(i||(i=4),n||(n=0),h=r?Math.min(r*i+n,t.length):t.length,o=n;o<h;o+=i)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],s(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}(),n.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},void 0!==e&&(e.vec4=n);var r={},s=new Float32Array([1,0,0,1]);if(!d)d=1e-6;r.create=function(){return new Float32Array(s)},r.clone=function(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},r.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},r.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},r.transpose=function(e,t){if(e===t){var i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},r.invert=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=i*s-r*n;return a?(a=1/a,e[0]=s*a,e[1]=-n*a,e[2]=-r*a,e[3]=i*a,e):null},r.adjoint=function(e,t){var i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},r.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},r.mul=r.multiply=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=i[0],h=i[1],u=i[2],c=i[3];return e[0]=n*o+r*u,e[1]=n*h+r*c,e[2]=s*o+a*u,e[3]=s*h+a*c,e},r.rotate=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=Math.sin(i),h=Math.cos(i);return e[0]=n*h+r*o,e[1]=n*-o+r*h,e[2]=s*h+a*o,e[3]=s*-o+a*h,e},r.scale=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=i[0],h=i[1];return e[0]=n*o,e[1]=r*h,e[2]=s*o,e[3]=a*h,e},r.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},void 0!==e&&(e.mat2=r);var a={},o=new Float32Array([1,0,0,0,1,0,0,0,1]);if(!d)d=1e-6;a.create=function(){return new Float32Array(o)},a.clone=function(e){var t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},a.transpose=function(e,t){if(e===t){var i=t[1],n=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=n,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},a.invert=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5],h=t[6],u=t[7],c=t[8],l=c*a-o*u,d=-c*s+o*h,f=u*s-a*h,m=i*l+n*d+r*f;return m?(m=1/m,e[0]=l*m,e[1]=(-c*n+r*u)*m,e[2]=(o*n-r*a)*m,e[3]=d*m,e[4]=(c*i-r*h)*m,e[5]=(-o*i+r*s)*m,e[6]=f*m,e[7]=(-u*i+n*h)*m,e[8]=(a*i-n*s)*m,e):null},a.adjoint=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5],h=t[6],u=t[7],c=t[8];return e[0]=a*c-o*u,e[1]=r*u-n*c,e[2]=n*o-r*a,e[3]=o*h-s*c,e[4]=i*c-r*h,e[5]=r*s-i*o,e[6]=s*u-a*h,e[7]=n*h-i*u,e[8]=i*a-n*s,e},a.determinant=function(e){var t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=e[6],h=e[7],u=e[8];return t*(u*s-a*h)+i*(-u*r+a*o)+n*(h*r-s*o)},a.mul=a.multiply=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=t[4],h=t[5],u=t[6],c=t[7],l=t[8],d=i[0],f=i[1],m=i[2],p=i[3],g=i[4],v=i[5],b=i[6],x=i[7],T=i[8];return e[0]=d*n+f*a+m*u,e[1]=d*r+f*o+m*c,e[2]=d*s+f*h+m*l,e[3]=p*n+g*a+v*u,e[4]=p*r+g*o+v*c,e[5]=p*s+g*h+v*l,e[6]=b*n+x*a+T*u,e[7]=b*r+x*o+T*c,e[8]=b*s+x*h+T*l,e},a.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},void 0!==e&&(e.mat3=a);var h={},u=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);if(!d)d=1e-6;h.create=function(){return new Float32Array(u)},h.clone=function(e){var t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},h.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},h.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},h.transpose=function(e,t){if(e===t){var i=t[1],n=t[2],r=t[3],s=t[6],a=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=s,e[11]=t[14],e[12]=r,e[13]=a,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},h.invert=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5],h=t[6],u=t[7],c=t[8],l=t[9],d=t[10],f=t[11],m=t[12],p=t[13],g=t[14],v=t[15],b=i*o-n*a,x=i*h-r*a,T=i*u-s*a,E=n*h-r*o,w=n*u-s*o,S=r*u-s*h,R=c*p-l*m,y=c*g-d*m,_=c*v-f*m,C=l*g-d*p,M=l*v-f*p,D=d*v-f*g,F=b*D-x*M+T*C+E*_-w*y+S*R;return F?(F=1/F,e[0]=(o*D-h*M+u*C)*F,e[1]=(r*M-n*D-s*C)*F,e[2]=(p*S-g*w+v*E)*F,e[3]=(d*w-l*S-f*E)*F,e[4]=(h*_-a*D-u*y)*F,e[5]=(i*D-r*_+s*y)*F,e[6]=(g*T-m*S-v*x)*F,e[7]=(c*S-d*T+f*x)*F,e[8]=(a*M-o*_+u*R)*F,e[9]=(n*_-i*M-s*R)*F,e[10]=(m*w-p*T+v*b)*F,e[11]=(l*T-c*w-f*b)*F,e[12]=(o*y-a*C-h*R)*F,e[13]=(i*C-n*y+r*R)*F,e[14]=(p*x-m*E-g*b)*F,e[15]=(c*E-l*x+d*b)*F,e):null},h.adjoint=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5],h=t[6],u=t[7],c=t[8],l=t[9],d=t[10],f=t[11],m=t[12],p=t[13],g=t[14],v=t[15];return e[0]=o*(d*v-f*g)-l*(h*v-u*g)+p*(h*f-u*d),e[1]=-(n*(d*v-f*g)-l*(r*v-s*g)+p*(r*f-s*d)),e[2]=n*(h*v-u*g)-o*(r*v-s*g)+p*(r*u-s*h),e[3]=-(n*(h*f-u*d)-o*(r*f-s*d)+l*(r*u-s*h)),e[4]=-(a*(d*v-f*g)-c*(h*v-u*g)+m*(h*f-u*d)),e[5]=i*(d*v-f*g)-c*(r*v-s*g)+m*(r*f-s*d),e[6]=-(i*(h*v-u*g)-a*(r*v-s*g)+m*(r*u-s*h)),e[7]=i*(h*f-u*d)-a*(r*f-s*d)+c*(r*u-s*h),e[8]=a*(l*v-f*p)-c*(o*v-u*p)+m*(o*f-u*l),e[9]=-(i*(l*v-f*p)-c*(n*v-s*p)+m*(n*f-s*l)),e[10]=i*(o*v-u*p)-a*(n*v-s*p)+m*(n*u-s*o),e[11]=-(i*(o*f-u*l)-a*(n*f-s*l)+c*(n*u-s*o)),e[12]=-(a*(l*g-d*p)-c*(o*g-h*p)+m*(o*d-h*l)),e[13]=i*(l*g-d*p)-c*(n*g-r*p)+m*(n*d-r*l),e[14]=-(i*(o*g-h*p)-a*(n*g-r*p)+m*(n*h-r*o)),e[15]=i*(o*d-h*l)-a*(n*d-r*l)+c*(n*h-r*o),e},h.determinant=function(e){var t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=e[6],h=e[7],u=e[8],c=e[9],l=e[10],d=e[11],f=e[12],m=e[13],p=e[14],g=e[15];return(t*a-i*s)*(l*g-d*p)-(t*o-n*s)*(c*g-d*m)+(t*h-r*s)*(c*p-l*m)+(i*o-n*a)*(u*g-d*f)-(i*h-r*a)*(u*p-l*f)+(n*h-r*o)*(u*m-c*f)},h.mul=h.multiply=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=t[4],h=t[5],u=t[6],c=t[7],l=t[8],d=t[9],f=t[10],m=t[11],p=t[12],g=t[13],v=t[14],b=t[15],x=i[0],T=i[1],E=i[2],w=i[3];return e[0]=x*n+T*o+E*l+w*p,e[1]=x*r+T*h+E*d+w*g,e[2]=x*s+T*u+E*f+w*v,e[3]=x*a+T*c+E*m+w*b,x=i[4],T=i[5],E=i[6],w=i[7],e[4]=x*n+T*o+E*l+w*p,e[5]=x*r+T*h+E*d+w*g,e[6]=x*s+T*u+E*f+w*v,e[7]=x*a+T*c+E*m+w*b,x=i[8],T=i[9],E=i[10],w=i[11],e[8]=x*n+T*o+E*l+w*p,e[9]=x*r+T*h+E*d+w*g,e[10]=x*s+T*u+E*f+w*v,e[11]=x*a+T*c+E*m+w*b,x=i[12],T=i[13],E=i[14],w=i[15],e[12]=x*n+T*o+E*l+w*p,e[13]=x*r+T*h+E*d+w*g,e[14]=x*s+T*u+E*f+w*v,e[15]=x*a+T*c+E*m+w*b,e},h.translate=function(e,t,i){var n,r,s,a,o,h,u,c,l,d,f,m,p=i[0],g=i[1],v=i[2];return t===e?(e[12]=t[0]*p+t[4]*g+t[8]*v+t[12],e[13]=t[1]*p+t[5]*g+t[9]*v+t[13],e[14]=t[2]*p+t[6]*g+t[10]*v+t[14],e[15]=t[3]*p+t[7]*g+t[11]*v+t[15]):(n=t[0],r=t[1],s=t[2],a=t[3],o=t[4],h=t[5],u=t[6],c=t[7],l=t[8],d=t[9],f=t[10],m=t[11],e[0]=n,e[1]=r,e[2]=s,e[3]=a,e[4]=o,e[5]=h,e[6]=u,e[7]=c,e[8]=l,e[9]=d,e[10]=f,e[11]=m,e[12]=n*p+o*g+l*v+t[12],e[13]=r*p+h*g+d*v+t[13],e[14]=s*p+u*g+f*v+t[14],e[15]=a*p+c*g+m*v+t[15]),e},h.scale=function(e,t,i){var n=i[0],r=i[1],s=i[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},h.rotate=function(e,t,i,n){var r,s,a,o,h,u,c,l,f,m,p,g,v,b,x,T,E,w,S,R,y,_,C,M,D=n[0],F=n[1],A=n[2],P=Math.sqrt(D*D+F*F+A*A);return Math.abs(P)<d?null:(P=1/P,D*=P,F*=P,A*=P,r=Math.sin(i),s=Math.cos(i),a=1-s,o=t[0],h=t[1],u=t[2],c=t[3],l=t[4],f=t[5],m=t[6],p=t[7],g=t[8],v=t[9],b=t[10],x=t[11],T=D*D*a+s,E=F*D*a+A*r,w=A*D*a-F*r,S=D*F*a-A*r,R=F*F*a+s,y=A*F*a+D*r,_=D*A*a+F*r,C=F*A*a-D*r,M=A*A*a+s,e[0]=o*T+l*E+g*w,e[1]=h*T+f*E+v*w,e[2]=u*T+m*E+b*w,e[3]=c*T+p*E+x*w,e[4]=o*S+l*R+g*y,e[5]=h*S+f*R+v*y,e[6]=u*S+m*R+b*y,e[7]=c*S+p*R+x*y,e[8]=o*_+l*C+g*M,e[9]=h*_+f*C+v*M,e[10]=u*_+m*C+b*M,e[11]=c*_+p*C+x*M,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},h.rotateX=function(e,t,i){var n=Math.sin(i),r=Math.cos(i),s=t[4],a=t[5],o=t[6],h=t[7],u=t[8],c=t[9],l=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*r+u*n,e[5]=a*r+c*n,e[6]=o*r+l*n,e[7]=h*r+d*n,e[8]=u*r-s*n,e[9]=c*r-a*n,e[10]=l*r-o*n,e[11]=d*r-h*n,e},h.rotateY=function(e,t,i){var n=Math.sin(i),r=Math.cos(i),s=t[0],a=t[1],o=t[2],h=t[3],u=t[8],c=t[9],l=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*r-u*n,e[1]=a*r-c*n,e[2]=o*r-l*n,e[3]=h*r-d*n,e[8]=s*n+u*r,e[9]=a*n+c*r,e[10]=o*n+l*r,e[11]=h*n+d*r,e},h.rotateZ=function(e,t,i){var n=Math.sin(i),r=Math.cos(i),s=t[0],a=t[1],o=t[2],h=t[3],u=t[4],c=t[5],l=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*r+u*n,e[1]=a*r+c*n,e[2]=o*r+l*n,e[3]=h*r+d*n,e[4]=u*r-s*n,e[5]=c*r-a*n,e[6]=l*r-o*n,e[7]=d*r-h*n,e},h.fromRotationTranslation=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=n+n,h=r+r,u=s+s,c=n*o,l=n*h,d=n*u,f=r*h,m=r*u,p=s*u,g=a*o,v=a*h,b=a*u;return e[0]=1-(f+p),e[1]=l+b,e[2]=d-v,e[3]=0,e[4]=l-b,e[5]=1-(c+p),e[6]=m+g,e[7]=0,e[8]=d+v,e[9]=m-g,e[10]=1-(c+f),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e},h.frustum=function(e,t,i,n,r,s,a){var o=1/(i-t),h=1/(r-n),u=1/(s-a);return e[0]=2*s*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*h,e[6]=0,e[7]=0,e[8]=(i+t)*o,e[9]=(r+n)*h,e[10]=(a+s)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*s*2*u,e[15]=0,e},h.perspective=function(e,t,i,n,r){var s=1/Math.tan(t/2),a=1/(n-r);return e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(r+n)*a,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*r*n*a,e[15]=0,e},h.ortho=function(e,t,i,n,r,s,a){var o=1/(t-i),h=1/(n-r),u=1/(s-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+i)*o,e[13]=(r+n)*h,e[14]=(a+s)*u,e[15]=1,e},h.lookAt=function(e,t,i,n){var r,s,a,o,u,c,l,f,m,p,g=t[0],v=t[1],b=t[2],x=n[0],T=n[1],E=n[2],w=i[0],S=i[1],R=i[2];return Math.abs(g-w)<d&&Math.abs(v-S)<d&&Math.abs(b-R)<d?h.identity(e):(l=g-w,f=v-S,m=b-R,p=1/Math.sqrt(l*l+f*f+m*m),l*=p,f*=p,m*=p,r=T*m-E*f,s=E*l-x*m,a=x*f-T*l,p=Math.sqrt(r*r+s*s+a*a),p?(r*=p=1/p,s*=p,a*=p):(r=0,s=0,a=0),o=f*a-m*s,u=m*r-l*a,c=l*s-f*r,p=Math.sqrt(o*o+u*u+c*c),p?(o*=p=1/p,u*=p,c*=p):(o=0,u=0,c=0),e[0]=r,e[1]=o,e[2]=l,e[3]=0,e[4]=s,e[5]=u,e[6]=f,e[7]=0,e[8]=a,e[9]=c,e[10]=m,e[11]=0,e[12]=-(r*g+s*v+a*b),e[13]=-(o*g+u*v+c*b),e[14]=-(l*g+f*v+m*b),e[15]=1,e)},h.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},void 0!==e&&(e.mat4=h);var c={},l=new Float32Array([0,0,0,1]);if(!d)var d=1e-6;c.create=function(){return new Float32Array(l)},c.clone=n.clone,c.fromValues=n.fromValues,c.copy=n.copy,c.set=n.set,c.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},c.setAxisAngle=function(e,t,i){i*=.5;var n=Math.sin(i);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(i),e},c.add=n.add,c.mul=c.multiply=function(e,t,i){var n=t[0],r=t[1],s=t[2],a=t[3],o=i[0],h=i[1],u=i[2],c=i[3];return e[0]=n*c+a*o+r*u-s*h,e[1]=r*c+a*h+s*o-n*u,e[2]=s*c+a*u+n*h-r*o,e[3]=a*c-n*o-r*h-s*u,e},c.scale=n.scale,c.rotateX=function(e,t,i){i*=.5;var n=t[0],r=t[1],s=t[2],a=t[3],o=Math.sin(i),h=Math.cos(i);return e[0]=n*h+a*o,e[1]=r*h+s*o,e[2]=s*h-r*o,e[3]=a*h-n*o,e},c.rotateY=function(e,t,i){i*=.5;var n=t[0],r=t[1],s=t[2],a=t[3],o=Math.sin(i),h=Math.cos(i);return e[0]=n*h-s*o,e[1]=r*h+a*o,e[2]=s*h+n*o,e[3]=a*h-r*o,e},c.rotateZ=function(e,t,i){i*=.5;var n=t[0],r=t[1],s=t[2],a=t[3],o=Math.sin(i),h=Math.cos(i);return e[0]=n*h+r*o,e[1]=r*h-n*o,e[2]=s*h+a*o,e[3]=a*h-s*o,e},c.calculateW=function(e,t){var i=t[0],n=t[1],r=t[2];return e[0]=i,e[1]=n,e[2]=r,e[3]=-Math.sqrt(Math.abs(1-i*i-n*n-r*r)),e},c.dot=n.dot,c.lerp=n.lerp,c.slerp=function(e,t,i,n){var r,s,a,o,h=t[0],u=t[1],c=t[2],l=t[3],d=i[0],f=i[1],m=i[2],p=t[3],g=h*d+u*f+c*m+l*p;return Math.abs(g)>=1?(e!==t&&(e[0]=h,e[1]=u,e[2]=c,e[3]=l),e):(r=Math.acos(g),s=Math.sqrt(1-g*g),Math.abs(s)<.001?(e[0]=.5*h+.5*d,e[1]=.5*u+.5*f,e[2]=.5*c+.5*m,e[3]=.5*l+.5*p,e):(a=Math.sin((1-n)*r)/s,o=Math.sin(n*r)/s,e[0]=h*a+d*o,e[1]=u*a+f*o,e[2]=c*a+m*o,e[3]=l*a+p*o,e))},c.invert=function(e,t){var i=t[0],n=t[1],r=t[2],s=t[3],a=i*i+n*n+r*r+s*s,o=a?1/a:0;return e[0]=-i*o,e[1]=-n*o,e[2]=-r*o,e[3]=s*o,e},c.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},c.len=c.length=n.length,c.sqrLen=c.squaredLength=n.squaredLength,c.normalize=n.normalize,c.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},void 0!==e&&(e.quat=c)}(e.exports)}();var EPSILON=1e-6;mat3.normalize=function(e,t){var i;return i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,i=Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]),e[3]=t[3]/i,e[4]=t[4]/i,e[5]=t[5]/i,i=Math.sqrt(t[6]*t[6]+t[7]*t[7]+t[8]*t[8]),e[6]=t[6]/i,e[7]=t[7]/i,e[8]=t[8]/i,e},mat4.submat3=function(e,t,i){return e[0]=t[0+i[0]+4*i[1]],e[1]=t[1+i[0]+4*i[1]],e[2]=t[2+i[0]+4*i[1]],e[3]=t[4+i[0]+4*i[1]],e[4]=t[5+i[0]+4*i[1]],e[5]=t[6+i[0]+4*i[1]],e[6]=t[8+i[0]+4*i[1]],e[7]=t[9+i[0]+4*i[1]],e[8]=t[10+i[0]+4*i[1]],e},mat4.setsubmat3=function(e,t,i){return e[0+i[0]+4*i[1]]=t[0],e[1+i[0]+4*i[1]]=t[1],e[2+i[0]+4*i[1]]=t[2],e[4+i[0]+4*i[1]]=t[3],e[5+i[0]+4*i[1]]=t[4],e[6+i[0]+4*i[1]]=t[5],e[8+i[0]+4*i[1]]=t[6],e[9+i[0]+4*i[1]]=t[7],e[10+i[0]+4*i[1]]=t[8],e},mat4.rotation=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.translation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},mat4.getScale=function(e,t){return e[0]=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]),e[1]=Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]+t[7]*t[7]),e[2]=Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]+t[11]*t[11]),e},mat4.normalize=function(e,t){var i;return i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]),e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i,i=Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]+t[7]*t[7]),e[4]=t[4]/i,e[5]=t[5]/i,e[6]=t[6]/i,e[7]=t[7]/i,i=Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]+t[11]*t[11]),e[8]=t[8]/i,e[9]=t[9]/i,e[10]=t[10]/i,e[11]=t[11]/i,i=Math.sqrt(t[12]*t[12]+t[13]*t[13]+t[14]*t[14]+t[15]*t[15]),e[12]=t[12]/i,e[13]=t[13]/i,e[14]=t[14]/i,e[15]=t[15]/i,e},mat4.fromRotationTranslationScale=function(e,t,i,n){return mat4.fromRotationTranslation(e,t,i),mat4.scale(e,e,n),e},mat4.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},mat4.decompose=function(e,t,i,n){mat4.translation(e,n),quat.fromMat4(t,n),mat4.getScale(i,n)},mat4.isIdentity=function(e){return!(Math.abs(e[0]-1)>EPSILON)&&(!(Math.abs(e[5]-1)>EPSILON)&&(!(Math.abs(e[10]-1)>EPSILON)&&(!(Math.abs(e[15]-1)>EPSILON)&&(!(Math.abs(e[1])>EPSILON)&&(!(Math.abs(e[2])>EPSILON)&&(!(Math.abs(e[3])>EPSILON)&&(!(Math.abs(e[4])>EPSILON)&&(!(Math.abs(e[6])>EPSILON)&&(!(Math.abs(e[7])>EPSILON)&&(!(Math.abs(e[8])>EPSILON)&&(!(Math.abs(e[9])>EPSILON)&&(!(Math.abs(e[11])>EPSILON)&&(!(Math.abs(e[12])>EPSILON)&&(!(Math.abs(e[13])>EPSILON)&&!(Math.abs(e[14])>EPSILON)))))))))))))))},quat.euler=function(e,t,i,n){var r=2*Math.PI/360,s=quat.create(),a=vec3.fromValues(0,0,1);return quat.setAxisAngle(e,a,r*n),vec3.set(a,0,1,0),quat.setAxisAngle(s,a,r*i),quat.mul(e,e,s),vec3.set(a,1,0,0),quat.setAxisAngle(s,a,r*t),quat.mul(e,e,s),e},quat.getEuler=function(e,t){var i=360/(2*Math.PI),n=mat4.fromRotationTranslation(mat4.create(),t,[0,0,0]),r=function(e,t){return Math.abs(e-t)<=EPSILON};if(r(Math.abs(n[2]),1))r(n[2],-1)?(e[0]=0,e[1]=90,e[2]=-i*Math.atan2(n[4],n[8])):(e[0]=0,e[1]=-90,e[2]=i*Math.atan2(-n[4],-n[8]));else{var s=function(t){var r=Math.cos(t);e[0]=Math.atan2(n[6]/r,n[10]/r)*i,e[1]=t*i,e[2]=Math.atan2(n[1]/r,n[0]/r)*i},a=-Math.asin(n[2]);s(a),function(e,t){var i=quat.euler(quat.create(),t[0],t[1],t[2]);quat.normalize(i,i);var n=quat.rotationDifference(quat.create(),e,i);return Math.abs(1-n[3])<EPSILON}(t,e)||s(a=Math.PI-a)}return e},quat.fromMat3=function(e,t){var i=t[0]+t[4]+t[8];if(i>EPSILON){n=2*Math.sqrt(1+i);e[3]=.25*n,e[0]=(t[5]-t[7])/n,e[1]=(t[6]-t[2])/n,e[2]=(t[1]-t[3])/n}else if(t[0]>t[4]&&t[0]>t[8]){n=2*Math.sqrt(1+t[0]-t[4]-t[8]);e[3]=(t[5]-t[7])/n,e[0]=.25*n,e[1]=(t[1]+t[3])/n,e[2]=(t[6]+t[2])/n}else if(t[4]>t[8]){n=2*Math.sqrt(1+t[4]-t[0]-t[8]);e[3]=(t[6]-t[2])/n,e[0]=(t[1]+t[3])/n,e[1]=.25*n,e[2]=(t[5]+t[7])/n}else{var n=2*Math.sqrt(1+t[8]-t[0]-t[4]);e[3]=(t[1]-t[3])/n,e[0]=(t[6]+t[2])/n,e[1]=(t[5]+t[7])/n,e[2]=.25*n}return e},quat.fromMat4=function(e,t){var i=mat4.submat3(mat3.create(),t,[0,0]);return mat3.normalize(i,i),quat.fromMat3(e,i),quat.normalize(e,e),e},quat.rotationDifference=function(e,t,i){return quat.multiply(e,i,quat.conjugate(quat.create(),t)),e},quat.angle=function(e,t){var i=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(1-i)<EPSILON&&(i=1),Math.abs(1+i)<EPSILON&&(i=-1),2*Math.acos(i)},quat.slerp=function(e,t,i,n){var r=t[0]*i[0]+t[1]*i[1]+t[2]*i[2]+t[3]*i[3];Math.abs(1-r)<EPSILON&&(r=1),Math.abs(1+r)<EPSILON&&(r=-1);var s,a;if(1-Math.abs(r)>EPSILON){var o=Math.acos(Math.abs(r)),h=Math.sin(o);s=Math.sin((1-n)*o/h),a=Math.sin(n*o/h)}else s=1-n,a=n;r<0&&(a=-a);var u=quat.scale(quat.create(),t,s),c=quat.scale(quat.create(),i,a);return quat.add(e,u,c),e},quat.getTwist=function(e,t){var i=vec3.create(),n=vec3.transformQuat(vec3.create(),t,quat.euler(quat.create(),90,0,0)),r=vec3.dot(t,n);Math.abs(r)>.6&&(n=vec3.transformQuat(t,quat.euler(quat.create(),0,90,0))),vec3.normalize(n,n),vec3.cross(i,t,n),vec3.normalize(i,i);var s=vec3.transformQuat(vec3.create(),i,e),a=vec3.sub(vec3.create(),s,vec3.scale(vec3.create(),t,vec3.dot(s,t)));return vec3.normalize(a,a),Math.acos(vec3.dot(i,a))},vec3.transformVertexArrayMat4=function(e,t,i){for(var n=0,r=0,s=0,a=i;a<e.length;a+=3)n=e[a],r=e[a+1],s=e[a+2],e[a]=t[0]*n+t[4]*r+t[8]*s+t[12],e[a+1]=t[1]*n+t[5]*r+t[9]*s+t[13],e[a+2]=t[2]*n+t[6]*r+t[10]*s+t[14];return e},vec3.transformVertexArrayQuat=function(e,t,i){for(var n=0,r=0,s=0,a=t[0],o=t[1],h=t[2],u=t[3],c=0,l=0,d=0,f=0,m=i;m<e.length;m+=3)n=e[m],r=e[m+1],c=u*n+o*(s=e[m+2])-h*r,l=u*r+h*n-a*s,d=u*s+a*r-o*n,f=-a*n-o*r-h*s,e[m]=c*u+f*-a+l*-h-d*-o,e[m+1]=l*u+f*-o+d*-a-c*-h,e[m+2]=d*u+f*-h+c*-o-l*-a;return e},vec3.scaleAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e},function(e){var t={ArrayBuffer:"undefined"!=typeof ArrayBuffer,DataView:"undefined"!=typeof DataView&&("getFloat64"in DataView.prototype||"getFloat64"in new DataView(new ArrayBuffer(1))),NodeBuffer:"undefined"!=typeof Buffer&&"readInt16LE"in Buffer.prototype},i={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8},n={Int8:"Int8",Int16:"Int16",Int32:"Int32",Uint8:"UInt8",Uint16:"UInt16",Uint32:"UInt32",Float32:"Float",Float64:"Double"},r=function(s,a,o,h){if(!(this instanceof r))throw new Error("jDataView constructor may not be called as a function");if(this.buffer=s,!(t.NodeBuffer&&s instanceof Buffer||t.ArrayBuffer&&s instanceof ArrayBuffer||"string"==typeof s))throw new TypeError("jDataView buffer has an incompatible type");this._isArrayBuffer=t.ArrayBuffer&&s instanceof ArrayBuffer,this._isDataView=t.DataView&&this._isArrayBuffer,this._isNodeBuffer=t.NodeBuffer&&s instanceof Buffer,this._littleEndian=void 0!==h&&h;var u=this._isArrayBuffer?s.byteLength:s.length;if(void 0===a&&(a=0),this.byteOffset=a,void 0===o&&(o=u-a),this.byteLength=o,!this._isDataView){if("number"!=typeof a)throw new TypeError("jDataView byteOffset is not a number");if("number"!=typeof o)throw new TypeError("jDataView byteLength is not a number");if(a<0)throw new Error("jDataView byteOffset is negative");if(o<0)throw new Error("jDataView byteLength is negative")}if(this._isDataView&&(this._view=new DataView(s,a,o),this._start=0),this._start=a,a+o>u)throw new Error("jDataView (byteOffset + byteLength) value is out of bounds");if(this._offset=0,this._isDataView)for(var c in i)i.hasOwnProperty(c)&&function(e,t){var n=i[e];t["get"+e]=function(i,r){return void 0===r&&(r=t._littleEndian),void 0===i&&(i=t._offset),t._offset=i+n,t._view["get"+e](i,r)}}(c,this);else if(this._isNodeBuffer&&t.NodeBuffer){for(var c in i)if(i.hasOwnProperty(c)){(function(e,t,n){var r=i[e];t["get"+e]=function(e,i){return void 0===i&&(i=t._littleEndian),void 0===e&&(e=t._offset),t._offset=e+r,t.buffer[n](t._start+e)}})(c,this,"Int8"===c||"Uint8"===c?"read"+n[c]:h?"read"+n[c]+"LE":"read"+n[c]+"BE")}}else for(var c in i)i.hasOwnProperty(c)&&function(t,n){var r=i[t];n["get"+t]=function(i,s){if(void 0===s&&(s=n._littleEndian),void 0===i&&(i=n._offset),n._offset=i+r,n._isArrayBuffer&&(n._start+i)%r==0&&(1===r||s))return new e[t+"Array"](n.buffer,n._start+i,1)[0];if("number"!=typeof i)throw new TypeError("jDataView byteOffset is not a number");if(i+r>n.byteLength)throw new Error("jDataView (byteOffset + size) value is out of bounds");return n["_get"+t](n._start+i,s)}}(c,this)};if(r.createBuffer=t.NodeBuffer?function(){for(var e=new Buffer(arguments.length),t=0;t<arguments.length;++t)e[t]=arguments[t];return e}:t.ArrayBuffer?function(){for(var e=new ArrayBuffer(arguments.length),t=new Int8Array(e),i=0;i<arguments.length;++i)t[i]=arguments[i];return e}:function(){return String.fromCharCode.apply(null,arguments)},r.prototype={compatibility:t,getString:function(e,t){var i;if(void 0===t&&(t=this._offset),"number"!=typeof t)throw new TypeError("jDataView byteOffset is not a number");if(e<0||t+e>this.byteLength)throw new Error("jDataView length or (byteOffset+length) value is out of bounds");if(this._isNodeBuffer)i=this.buffer.toString("ascii",this._start+t,this._start+t+e);else{i="";for(var n=0;n<e;++n){var r=this.getUint8(t+n);i+=String.fromCharCode(r>127?65533:r)}}return this._offset=t+e,i},getChar:function(e){return this.getString(1,e)},tell:function(){return this._offset},seek:function(e){if("number"!=typeof e)throw new TypeError("jDataView byteOffset is not a number");if(e<0||e>this.byteLength)throw new Error("jDataView byteOffset value is out of bounds");return this._offset=e},_endianness:function(e,t,i,n){return e+(n?i-t-1:t)},_getFloat64:function(e,t){var i=this._getUint8(this._endianness(e,0,8,t)),n=this._getUint8(this._endianness(e,1,8,t)),r=this._getUint8(this._endianness(e,2,8,t)),s=this._getUint8(this._endianness(e,3,8,t)),a=this._getUint8(this._endianness(e,4,8,t)),o=this._getUint8(this._endianness(e,5,8,t)),h=this._getUint8(this._endianness(e,6,8,t)),u=this._getUint8(this._endianness(e,7,8,t)),c=1-2*(i>>7),l=((i<<1&255)<<3|n>>4)-(Math.pow(2,10)-1),d=(15&n)*Math.pow(2,48)+r*Math.pow(2,40)+s*Math.pow(2,32)+a*Math.pow(2,24)+o*Math.pow(2,16)+h*Math.pow(2,8)+u;return 1024===l?0!==d?NaN:c*(1/0):-1023===l?c*d*Math.pow(2,-1074):c*(1+d*Math.pow(2,-52))*Math.pow(2,l)},_getFloat32:function(e,t){var i=this._getUint8(this._endianness(e,0,4,t)),n=this._getUint8(this._endianness(e,1,4,t)),r=1-2*(i>>7),s=(i<<1&255|n>>7)-127,a=(127&n)<<16|this._getUint8(this._endianness(e,2,4,t))<<8|this._getUint8(this._endianness(e,3,4,t));return 128===s?0!==a?NaN:r*(1/0):-127===s?r*a*Math.pow(2,-149):r*(1+a*Math.pow(2,-23))*Math.pow(2,s)},_getInt32:function(e,t){var i=this._getUint32(e,t);return i>Math.pow(2,31)-1?i-Math.pow(2,32):i},_getUint32:function(e,t){var i=this._getUint8(this._endianness(e,0,4,t)),n=this._getUint8(this._endianness(e,1,4,t)),r=this._getUint8(this._endianness(e,2,4,t)),s=this._getUint8(this._endianness(e,3,4,t));return i*Math.pow(2,24)+(n<<16)+(r<<8)+s},_getInt16:function(e,t){var i=this._getUint16(e,t);return i>Math.pow(2,15)-1?i-Math.pow(2,16):i},_getUint16:function(e,t){return(this._getUint8(this._endianness(e,0,2,t))<<8)+this._getUint8(this._endianness(e,1,2,t))},_getInt8:function(e){var t=this._getUint8(e);return t>Math.pow(2,7)-1?t-Math.pow(2,8):t},_getUint8:function(e){return this._isArrayBuffer?new Uint8Array(this.buffer,e,1)[0]:this._isNodeBuffer?this.buffer[e]:255&this.buffer.charCodeAt(e)}},"undefined"!=typeof jQuery&&jQuery.fn.jquery>="1.6.2"){var s=function(e){var t;try{t=IEBinaryToArray_ByteStr(e)}catch(i){window.execScript("Function IEBinaryToArray_ByteStr(Binary)\r\n\tIEBinaryToArray_ByteStr = CStr(Binary)\r\nEnd Function\r\nFunction IEBinaryToArray_ByteStr_Last(Binary)\r\n\tDim lastIndex\r\n\tlastIndex = LenB(Binary)\r\n\tif lastIndex mod 2 Then\r\n\t\tIEBinaryToArray_ByteStr_Last = AscB( MidB( Binary, lastIndex, 1 ) )\r\n\tElse\r\n\t\tIEBinaryToArray_ByteStr_Last = -1\r\n\tEnd If\r\nEnd Function\r\n","vbscript"),t=IEBinaryToArray_ByteStr(e)}for(var i,n=IEBinaryToArray_ByteStr_Last(e),r="",s=0,a=t.length%8;s<a;)i=t.charCodeAt(s++),r+=String.fromCharCode(255&i,i>>8);for(a=t.length;s<a;)r+=String.fromCharCode(255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8,255&(i=t.charCodeAt(s++)),i>>8);return n>-1&&(r+=String.fromCharCode(n)),r};jQuery.ajaxSetup({converters:{"* dataview":function(e){return new r(e)}},accepts:{dataview:"text/plain; charset=x-user-defined"},responseHandler:{dataview:function(e,t,i){"mozResponseArrayBuffer"in i?e.text=i.mozResponseArrayBuffer:"responseType"in i&&"arraybuffer"===i.responseType&&i.response?e.text=i.response:e.text="responseBody"in i?s(i.responseBody):i.responseText}}}),jQuery.ajaxPrefilter("dataview",function(e,t,i){jQuery.support.ajaxResponseType&&(e.hasOwnProperty("xhrFields")||(e.xhrFields={}),e.xhrFields.responseType="arraybuffer"),e.mimeType="text/plain; charset=x-user-defined"})}e.jDataView=(e.module||{}).exports=r,"undefined"!=typeof module&&(module.exports=r)}(this),function(){var e=!1,t=/\b_super\b/;this.FrakClass=function(){},FrakClass.extend=function(i){function n(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var s=new this;e=!1;for(var a in i)s[a]="function"==typeof i[a]&&"function"==typeof r[a]&&t.test(i[a])?function(e,t){return function(){var i=this._super;this._super=r[e];var n=t.apply(this,arguments);return this._super=i,n}}(a,i[a]):i[a];return s._getset=function(e,t){var n,r=function(){return e},a=function(t){e=t};s[n="get"+t]=n in i?function(e){return function(){var t=this._super;this._super=r;var i=e.apply(this,arguments);return this._super=t,i}}(i[n]):r,s[n="set"+t]=n in i?function(e){return function(){var t=this._super;this._super=a;var i=e.apply(this,arguments);return this._super=t,i}}(i[n]):a},n.prototype=s,n.prototype.constructor=n,n.extend=arguments.callee,n}}(),window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,16)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,i){return void 0!==e[i]?e[i]:t})}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)});var Logistics=function(){var e=!1;"undefined"!=typeof window&&(e="localStorage"in window&&null!==window.localStorage);var t=[],i=[],n=0,r=!1,s=null,a=null,o=null,h={loadFromLocalStorage:!1,storeToLocalStorage:!1,loadFromFile:!1,enableCORS:!0,useCookies:!1,fallbackFromStorage:!1},u={text:{load:function(e){E(e)},parse:function(e,t){e.data=t.responseText},store:function(e){return e.data},restore:function(e,t){return t}},json:{load:function(e){E(e)},parse:function(e,t){try{e.data=JSON.parse(t.responseText)}catch(t){"undefined"!=typeof console&&console.error&&console.error("JSON parsing failed for "+e.url,t)}},store:function(e){return JSON.stringify(e.data)},restore:function(e,t){return t?JSON.parse(t):{}}},xml:{load:function(e){E(e)},parse:function(e,t){t.responseXML?e.data=t.responseXML:e.data=w(t.responseText)},store:function(e){return XMLSerializer?(new XMLSerializer).serializeToString(e.data):""},restore:function(e,t){return w(t)}},image:{load:function(e){e&&(e.data=new Image,e.useCORS&&(e.data.crossOrigin="Anonymous"),e.data.onload=function(){e.ready()},e.data.onerror=function(){e.failed()},e.data.src=e.url)},parse:function(e){},store:function(e){var t=document.createElement("canvas");t.width=e.data.width,t.height=e.data.height,t.getContext("2d").drawImage(e.data,0,0);var i=t.toDataURL("image/png");return t=null,i},restore:function(e,t){var i=new Image;return i.src=t,i}},binary:{load:function(e){E(e)},parse:function(e,t){e.data=t.response},store:function(e){for(var t="",i=new Uint8Array(e.data),n=i.byteLength,r=0;r<n;r++)t+=String.fromCharCode(i[r]);return window.btoa(t)},restore:function(e,t){for(var i=new ArrayBuffer(2*t.length),n=new Uint16Array(i),r=0,s=t.length;r<s;r++)n[r]=t.charCodeAt(r);return i}}},c=function(e,t,i,r,s){this.url=e,this.params=t,this.success=i,this.dataType=r,this.loaded=!1,this.data=!1,this.requestType=s,this.useCORS=!1,this.options={},this.successCallback=i,this.errorCallback=!1,this.alwaysCallback=!1,this.progressCallback=!1,this.setOption=function(e,t){this.options[e]=t},this.getOption=function(e){return this.options[e]},this.ready=function(){this.loaded=!0,n++,D(this),A()},this.failed=function(){n++,A(),F(this)},this.done=function(e){this.successCallback=e},this.fail=function(e){this.errorCallback=e},this.error=function(e){this.errorCallback=e},this.always=function(e){this.alwaysCallback=e},this.progress=function(e){this.progressCallback=e},this.toString=function(){return this.data}},l=function(e,t){this.urls=e,this.results={},this.loadedCount=0,this.count=0,this.successCallback=t,this.load=function(){var e=null,t=null;for(var i in this.urls)this.urls.hasOwnProperty(i)&&this.count++;for(var n in this.urls)(t=this.urls[n])&&t.url&&t.type&&((e=d(t.url,void 0,B(this,this.ready,n),t.type)).setOption("logistics.multi.key",n),e.fail(B(this,this.fail)))},this.ready=function(e,t,i){var n=i.getOption("logistics.multi.key");this.results[n]=e,this.loadedCount++,this.checkIfAllReady()},this.fail=function(e){this.loadedCount++,this.checkIfAllReady()},this.getKeyForURL=function(e){},this.checkIfAllReady=function(){this.loadedCount>=this.count&&"function"==typeof this.successCallback&&this.successCallback(this.results)}},d=function(e,i,n,r){var s="GET";"function"==typeof i?(n=i,i=void 0):i&&"object"==typeof i&&(s="POST");var a=new c(e,i,n,r,s);return h.enableCORS&&(a.useCORS=m(e)),a&&(t.push(a),p(a)),a},f=function(e,t){var n=new l(e,t);i.push(n),n.load()},m=function(e){if("undefined"==typeof document)return!1;var t=e.match(/(https?:)?\/\/([^\/]+)\/(.*)/);return!!t&&t[1]!==document.location.origin},p=function(e){return g(e),!0},g=function(e){h.loadFromLocalStorage&&v(e)?b(e):x(e.dataType,"load")(e)},v=function(t){return!(!e||null===localStorage.getItem(t.url))},b=function(e){e.data=x(e.dataType,"restore")(e,M(e)),e.ready()},x=function(e,t){return u&&u[e]&&u[e][t]?u[e][t]:u&&u[e]?u[e]:function(){"undefined"!=typeof console&&console.warn&&console.warn("Method "+t+" for "+e+" not found")}},T=function(e,t){e&&t&&(u[e]=t)},E=function(e){var t=S(e);if(!t||!e)throw"http failed";var i=e.url;t.open(e.requestType,i,!0),t.overrideMimeType&&t.overrideMimeType("text/xml"),"binary"==e.dataType&&(t.responseType="arraybuffer",e.useCORS&&t.setRequestHeader("Content-Type","application/x-3dtechdata")),e.useCORS&&h.useCookies&&(t.withCredentials=!0),t.onreadystatechange=function(){4==t.readyState?200==t.status?(e.loaded=!0,n++,x(e.dataType,"parse")(e,t),D(e)):(n++,F(e)):"function"==typeof e.progressCallback&&e.progressCallback(t)},t.ontimeout=function(){n++,F(e)},A(),t.send(null)},w=function(e){var t=null;if(!e||"string"!=typeof e)return t;if(window.DOMParser?t=(new DOMParser).parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async=!1,t.loadXML(e)),!t||t.getElementsByTagName("parsererror").length)throw"XML parsing failed";return t},S=function(e){var t=!1;if(e.useCORS&&window.XDomainRequest)try{t=new XDomainRequest}catch(e){t=!1}else if(XMLHttpRequest)try{t=new XMLHttpRequest}catch(e){t=!1}else if("undefined"!=typeof ActiveXObject)try{t=new ActiveXObject("Msxml2.XMLHTTP"),alert(2)}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP"),alert(3)}catch(e){t=!1}}return t},R=function(){t=[],i=[],n=0,r=!1},y=function(){if(e)for(var i in t)C(t[i]);else console.warn("localStorage isn't supported")},_=function(){localStorage.clear()},C=function(t){if(e)try{localStorage[t.url]=x(t.dataType,"store")(t)}catch(e){console.warn("localStorage limit exceeded")}else console.warn("localStorage isn't supported")},M=function(e){return localStorage[e.url]},D=function(e){e&&"function"==typeof e.successCallback&&(e.successCallback(e.data,"success",e),P()),e&&h.storeToLocalStorage&&C(e)},F=function(e){e&&h.fallbackFromStorage&&v(e)?b(e):(e&&"function"==typeof e.errorCallback&&e.errorCallback(e,"error",""),P())},A=function(){a&&"function"==typeof a&&t.length&&n&&a(n/t.length)},P=function(){null===o&&(o=setTimeout(U,5))},U=function(){o=null,t.length==n&&s&&"function"==typeof s&&s()},B=function(e,t){return function(){return t.apply(e,arguments)}},N=function(e,t){h[e]=t},I=function(e){return h[e]};return{count:function(){return t.length},loadedCount:function(){return n},clear:function(){R()},get:function(e,t,i,n,r){return d(e,t,i,toLowerCase(n))},getJSON:function(e,t,i,n){return d(e,t,i,"json",n)},getImage:function(e,t,i,n){return d(e,t,i,"image",n)},getBinary:function(e,t,i,n){return d(e,t,i,"binary",n)},getXML:function(e,t,i,n){return d(e,t,i,"xml",n)},getText:function(e,t,i,n){return d(e,t,i,"text",n)},getMultiple:function(e,t,i){f(e,t)},store:function(){y()},clearStorage:function(){_()},types:function(){return u},onFinishedLoading:function(e){s=e},onProgress:function(e){a=e},getQueue:function(){return t},getTypeFunction:function(e,t){return x(e,t)},setTypeFunction:function(e,t){return T(e,t)},getOption:function(e){return I(e)},setOption:function(e,t){N(e,t)}}}();!function(e,t,i,n){"use strict";function r(e,t,i){return setTimeout(c(e,i),t)}function s(e,t,i){return!!Array.isArray(e)&&(a(e,i[t],i),!0)}function a(e,t,i){var r;if(e)if(e.forEach)e.forEach(t,i);else if(e.length!==n)for(r=0;r<e.length;)t.call(i,e[r],r,e),r++;else for(r in e)e.hasOwnProperty(r)&&t.call(i,e[r],r,e)}function o(e,t,i){for(var r=Object.keys(t),s=0;s<r.length;)(!i||i&&e[r[s]]===n)&&(e[r[s]]=t[r[s]]),s++;return e}function h(e,t){return o(e,t,!0)}function u(e,t,i){var n,r=t.prototype;(n=e.prototype=Object.create(r)).constructor=e,n._super=r,i&&o(n,i)}function c(e,t){return function(){return e.apply(t,arguments)}}function l(e,t){return typeof e==ce?e.apply(t?t[0]||n:n,t):e}function d(e,t){return e===n?t:e}function f(e,t,i){a(v(t),function(t){e.addEventListener(t,i,!1)})}function m(e,t,i){a(v(t),function(t){e.removeEventListener(t,i,!1)})}function p(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function g(e,t){return e.indexOf(t)>-1}function v(e){return e.trim().split(/\s+/g)}function b(e,t,i){if(e.indexOf&&!i)return e.indexOf(t);for(var n=0;n<e.length;){if(i&&e[n][i]==t||!i&&e[n]===t)return n;n++}return-1}function x(e){return Array.prototype.slice.call(e,0)}function T(e,t,i){for(var n=[],r=[],s=0;s<e.length;){var a=t?e[s][t]:e[s];b(r,a)<0&&n.push(e[s]),r[s]=a,s++}return i&&(n=t?n.sort(function(e,i){return e[t]>i[t]}):n.sort()),n}function E(e,t){for(var i,r,s=t[0].toUpperCase()+t.slice(1),a=0;a<he.length;){if(i=he[a],(r=i?i+s:t)in e)return r;a++}return n}function w(){return me++}function S(t){var i=t.ownerDocument||t;return i.defaultView||i.parentWindow||e}function R(e,t){var i=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){l(e.options.enable,[e])&&i.handler(t)},this.init()}function y(e){var t=e.options.inputClass;return new(t||(ve?z:be?q:ge?G:O))(e,_)}function _(e,t,i){var n=i.pointers.length,r=i.changedPointers.length,s=t&we&&n-r==0,a=t&(Re|ye)&&n-r==0;i.isFirst=!!s,i.isFinal=!!a,s&&(e.session={}),i.eventType=t,C(e,i),e.emit("hammer.input",i),e.recognize(i),e.session.prevInput=i}function C(e,t){var i=e.session,n=t.pointers,r=n.length;i.firstInput||(i.firstInput=F(t)),r>1&&!i.firstMultiple?i.firstMultiple=F(t):1===r&&(i.firstMultiple=!1);var s=i.firstInput,a=i.firstMultiple,o=a?a.center:s.center,h=t.center=A(n);t.timeStamp=fe(),t.deltaTime=t.timeStamp-s.timeStamp,t.angle=N(o,h),t.distance=B(o,h),M(i,t),t.offsetDirection=U(t.deltaX,t.deltaY),t.scale=a?L(a.pointers,n):1,t.rotation=a?I(a.pointers,n):0,D(i,t);var u=e.element;p(t.srcEvent.target,u)&&(u=t.srcEvent.target),t.target=u}function M(e,t){var i=t.center,n=e.offsetDelta||{},r=e.prevDelta||{},s=e.prevInput||{};(t.eventType===we||s.eventType===Re)&&(r=e.prevDelta={x:s.deltaX||0,y:s.deltaY||0},n=e.offsetDelta={x:i.x,y:i.y}),t.deltaX=r.x+(i.x-n.x),t.deltaY=r.y+(i.y-n.y)}function D(e,t){var i,r,s,a,o=e.lastInterval||t,h=t.timeStamp-o.timeStamp;if(t.eventType!=ye&&(h>Ee||o.velocity===n)){var u=o.deltaX-t.deltaX,c=o.deltaY-t.deltaY,l=P(h,u,c);r=l.x,s=l.y,i=de(l.x)>de(l.y)?l.x:l.y,a=U(u,c),e.lastInterval=t}else i=o.velocity,r=o.velocityX,s=o.velocityY,a=o.direction;t.velocity=i,t.velocityX=r,t.velocityY=s,t.direction=a}function F(e){for(var t=[],i=0;i<e.pointers.length;)t[i]={clientX:le(e.pointers[i].clientX),clientY:le(e.pointers[i].clientY)},i++;return{timeStamp:fe(),pointers:t,center:A(t),deltaX:e.deltaX,deltaY:e.deltaY}}function A(e){var t=e.length;if(1===t)return{x:le(e[0].clientX),y:le(e[0].clientY)};for(var i=0,n=0,r=0;t>r;)i+=e[r].clientX,n+=e[r].clientY,r++;return{x:le(i/t),y:le(n/t)}}function P(e,t,i){return{x:t/e||0,y:i/e||0}}function U(e,t){return e===t?_e:de(e)>=de(t)?e>0?Ce:Me:t>0?De:Fe}function B(e,t,i){i||(i=Be);var n=t[i[0]]-e[i[0]],r=t[i[1]]-e[i[1]];return Math.sqrt(n*n+r*r)}function N(e,t,i){i||(i=Be);var n=t[i[0]]-e[i[0]],r=t[i[1]]-e[i[1]];return 180*Math.atan2(r,n)/Math.PI}function I(e,t){return N(t[1],t[0],Ne)-N(e[1],e[0],Ne)}function L(e,t){return B(t[0],t[1],Ne)/B(e[0],e[1],Ne)}function O(){this.evEl=Le,this.evWin=Oe,this.allow=!0,this.pressed=!1,R.apply(this,arguments)}function z(){this.evEl=Ve,this.evWin=qe,R.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function k(){this.evTarget=Ge,this.evWin=He,this.started=!1,R.apply(this,arguments)}function V(e,t){var i=x(e.touches),n=x(e.changedTouches);return t&(Re|ye)&&(i=T(i.concat(n),"identifier",!0)),[i,n]}function q(){this.evTarget=je,this.targetIds={},R.apply(this,arguments)}function X(e,t){var i=x(e.touches),n=this.targetIds;if(t&(we|Se)&&1===i.length)return n[i[0].identifier]=!0,[i,i];var r,s,a=x(e.changedTouches),o=[],h=this.target;if(s=i.filter(function(e){return p(e.target,h)}),t===we)for(r=0;r<s.length;)n[s[r].identifier]=!0,r++;for(r=0;r<a.length;)n[a[r].identifier]&&o.push(a[r]),t&(Re|ye)&&delete n[a[r].identifier],r++;return o.length?[T(s.concat(o),"identifier",!0),o]:void 0}function G(){R.apply(this,arguments);var e=c(this.handler,this);this.touch=new q(this.manager,e),this.mouse=new O(this.manager,e)}function H(e,t){this.manager=e,this.set(t)}function W(e){if(g(e,$e))return $e;var t=g(e,et),i=g(e,tt);return t&&i?et+" "+tt:t||i?t?et:tt:g(e,Ze)?Ze:Je}function j(e){this.id=w(),this.manager=null,this.options=h(e||{},this.defaults),this.options.enable=d(this.options.enable,!0),this.state=it,this.simultaneous={},this.requireFail=[]}function Y(e){return e&ot?"cancel":e&st?"end":e&rt?"move":e&nt?"start":""}function K(e){return e==Fe?"down":e==De?"up":e==Ce?"left":e==Me?"right":""}function Q(e,t){var i=t.manager;return i?i.get(e):e}function J(){j.apply(this,arguments)}function Z(){J.apply(this,arguments),this.pX=null,this.pY=null}function $(){J.apply(this,arguments)}function ee(){j.apply(this,arguments),this._timer=null,this._input=null}function te(){J.apply(this,arguments)}function ie(){J.apply(this,arguments)}function ne(){j.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function re(e,t){return t=t||{},t.recognizers=d(t.recognizers,re.defaults.preset),new se(e,t)}function se(e,t){t=t||{},this.options=h(t,re.defaults),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.element=e,this.input=y(this),this.touchAction=new H(this,this.options.touchAction),ae(this,!0),a(t.recognizers,function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])},this)}function ae(e,t){var i=e.element;i.style&&a(e.options.cssProps,function(e,n){i.style[E(i.style,n)]=t?e:""})}function oe(e,i){var n=t.createEvent("Event");n.initEvent(e,!0,!0),n.gesture=i,i.target.dispatchEvent(n)}var he=["","webkit","moz","MS","ms","o"],ue=t.createElement("div"),ce="function",le=Math.round,de=Math.abs,fe=Date.now,me=1,pe=/mobile|tablet|ip(ad|hone|od)|android/i,ge="ontouchstart"in e,ve=E(e,"PointerEvent")!==n,be=ge&&pe.test(navigator.userAgent),xe="touch",Te="mouse",Ee=25,we=1,Se=2,Re=4,ye=8,_e=1,Ce=2,Me=4,De=8,Fe=16,Ae=Ce|Me,Pe=De|Fe,Ue=Ae|Pe,Be=["x","y"],Ne=["clientX","clientY"];R.prototype={handler:function(){},init:function(){this.evEl&&f(this.element,this.evEl,this.domHandler),this.evTarget&&f(this.target,this.evTarget,this.domHandler),this.evWin&&f(S(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&m(this.element,this.evEl,this.domHandler),this.evTarget&&m(this.target,this.evTarget,this.domHandler),this.evWin&&m(S(this.element),this.evWin,this.domHandler)}};var Ie={mousedown:we,mousemove:Se,mouseup:Re},Le="mousedown",Oe="mousemove mouseup";u(O,R,{handler:function(e){var t=Ie[e.type];t&we&&0===e.button&&(this.pressed=!0),t&Se&&1!==e.which&&(t=Re),this.pressed&&this.allow&&(t&Re&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:Te,srcEvent:e}))}});var ze={pointerdown:we,pointermove:Se,pointerup:Re,pointercancel:ye,pointerout:ye},ke={2:xe,3:"pen",4:Te,5:"kinect"},Ve="pointerdown",qe="pointermove pointerup pointercancel";e.MSPointerEvent&&(Ve="MSPointerDown",qe="MSPointerMove MSPointerUp MSPointerCancel"),u(z,R,{handler:function(e){var t=this.store,i=!1,n=e.type.toLowerCase().replace("ms",""),r=ze[n],s=ke[e.pointerType]||e.pointerType,a=s==xe,o=b(t,e.pointerId,"pointerId");r&we&&(0===e.button||a)?0>o&&(t.push(e),o=t.length-1):r&(Re|ye)&&(i=!0),0>o||(t[o]=e,this.callback(this.manager,r,{pointers:t,changedPointers:[e],pointerType:s,srcEvent:e}),i&&t.splice(o,1))}});var Xe={touchstart:we,touchmove:Se,touchend:Re,touchcancel:ye},Ge="touchstart",He="touchstart touchmove touchend touchcancel";u(k,R,{handler:function(e){var t=Xe[e.type];if(t===we&&(this.started=!0),this.started){var i=V.call(this,e,t);t&(Re|ye)&&i[0].length-i[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:xe,srcEvent:e})}}});var We={touchstart:we,touchmove:Se,touchend:Re,touchcancel:ye},je="touchstart touchmove touchend touchcancel";u(q,R,{handler:function(e){var t=We[e.type],i=X.call(this,e,t);i&&this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:xe,srcEvent:e})}}),u(G,R,{handler:function(e,t,i){var n=i.pointerType==xe,r=i.pointerType==Te;if(n)this.mouse.allow=!1;else if(r&&!this.mouse.allow)return;t&(Re|ye)&&(this.mouse.allow=!0),this.callback(e,t,i)},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var Ye=E(ue.style,"touchAction"),Ke=Ye!==n,Qe="compute",Je="auto",Ze="manipulation",$e="none",et="pan-x",tt="pan-y";H.prototype={set:function(e){e==Qe&&(e=this.compute()),Ke&&this.manager.element.style&&(this.manager.element.style[Ye]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[];return a(this.manager.recognizers,function(t){l(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))}),W(e.join(" "))},preventDefaults:function(e){if(!Ke){var t=e.srcEvent,i=e.offsetDirection;if(this.manager.session.prevented)return void t.preventDefault();var n=this.actions,r=g(n,$e),s=g(n,tt),a=g(n,et);return r||s&&i&Ae||a&&i&Pe?this.preventSrc(t):void 0}},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var it=1,nt=2,rt=4,st=8,at=st,ot=16;j.prototype={defaults:{},set:function(e){return o(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(s(e,"recognizeWith",this))return this;var t=this.simultaneous;return e=Q(e,this),t[e.id]||(t[e.id]=e,e.recognizeWith(this)),this},dropRecognizeWith:function(e){return s(e,"dropRecognizeWith",this)?this:(e=Q(e,this),delete this.simultaneous[e.id],this)},requireFailure:function(e){if(s(e,"requireFailure",this))return this;var t=this.requireFail;return e=Q(e,this),-1===b(t,e)&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(s(e,"dropRequireFailure",this))return this;e=Q(e,this);var t=b(this.requireFail,e);return t>-1&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(e){function t(t){i.manager.emit(i.options.event+(t?Y(n):""),e)}var i=this,n=this.state;st>n&&t(!0),t(),n>=st&&t(!0)},tryEmit:function(e){return this.canEmit()?this.emit(e):void(this.state=32)},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(this.requireFail[e].state&(32|it)))return!1;e++}return!0},recognize:function(e){var t=o({},e);return l(this.options.enable,[this,t])?(this.state&(at|ot|32)&&(this.state=it),this.state=this.process(t),void(this.state&(nt|rt|st|ot)&&this.tryEmit(t))):(this.reset(),void(this.state=32))},process:function(){},getTouchAction:function(){},reset:function(){}},u(J,j,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,i=e.eventType,n=t&(nt|rt),r=this.attrTest(e);return n&&(i&ye||!r)?t|ot:n||r?i&Re?t|st:t&nt?t|rt:nt:32}}),u(Z,J,{defaults:{event:"pan",threshold:10,pointers:1,direction:Ue},getTouchAction:function(){var e=this.options.direction,t=[];return e&Ae&&t.push(tt),e&Pe&&t.push(et),t},directionTest:function(e){var t=this.options,i=!0,n=e.distance,r=e.direction,s=e.deltaX,a=e.deltaY;return r&t.direction||(t.direction&Ae?(r=0===s?_e:0>s?Ce:Me,i=s!=this.pX,n=Math.abs(e.deltaX)):(r=0===a?_e:0>a?De:Fe,i=a!=this.pY,n=Math.abs(e.deltaY))),e.direction=r,i&&n>t.threshold&&r&t.direction},attrTest:function(e){return J.prototype.attrTest.call(this,e)&&(this.state&nt||!(this.state&nt)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=K(e.direction);t&&this.manager.emit(this.options.event+t,e),this._super.emit.call(this,e)}}),u($,J,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[$e]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||this.state&nt)},emit:function(e){if(this._super.emit.call(this,e),1!==e.scale){var t=e.scale<1?"in":"out";this.manager.emit(this.options.event+t,e)}}}),u(ee,j,{defaults:{event:"press",pointers:1,time:500,threshold:5},getTouchAction:function(){return[Je]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,n=e.distance<t.threshold,s=e.deltaTime>t.time;if(this._input=e,!n||!i||e.eventType&(Re|ye)&&!s)this.reset();else if(e.eventType&we)this.reset(),this._timer=r(function(){this.state=at,this.tryEmit()},t.time,this);else if(e.eventType&Re)return at;return 32},reset:function(){clearTimeout(this._timer)},emit:function(e){this.state===at&&(e&&e.eventType&Re?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=fe(),this.manager.emit(this.options.event,this._input)))}}),u(te,J,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[$e]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||this.state&nt)}}),u(ie,J,{defaults:{event:"swipe",threshold:10,velocity:.65,direction:Ae|Pe,pointers:1},getTouchAction:function(){return Z.prototype.getTouchAction.call(this)},attrTest:function(e){var t,i=this.options.direction;return i&(Ae|Pe)?t=e.velocity:i&Ae?t=e.velocityX:i&Pe&&(t=e.velocityY),this._super.attrTest.call(this,e)&&i&e.direction&&e.distance>this.options.threshold&&de(t)>this.options.velocity&&e.eventType&Re},emit:function(e){var t=K(e.direction);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),u(ne,j,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:2,posThreshold:10},getTouchAction:function(){return[Ze]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,n=e.distance<t.threshold,s=e.deltaTime<t.time;if(this.reset(),e.eventType&we&&0===this.count)return this.failTimeout();if(n&&s&&i){if(e.eventType!=Re)return this.failTimeout();var a=!this.pTime||e.timeStamp-this.pTime<t.interval,o=!this.pCenter||B(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,o&&a?this.count+=1:this.count=1,this._input=e,0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=r(function(){this.state=at,this.tryEmit()},t.interval,this),nt):at}return 32},failTimeout:function(){return this._timer=r(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==at&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),re.VERSION="2.0.4",re.defaults={domEvents:!1,touchAction:Qe,enable:!0,inputTarget:null,inputClass:null,preset:[[te,{enable:!1}],[$,{enable:!1},["rotate"]],[ie,{direction:Ae}],[Z,{direction:Ae},["swipe"]],[ne],[ne,{event:"doubletap",taps:2},["tap"]],[ee]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};se.prototype={set:function(e){return o(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){this.touchAction.preventDefaults(e);var i,n=this.recognizers,r=t.curRecognizer;(!r||r&&r.state&at)&&(r=t.curRecognizer=null);for(var s=0;s<n.length;)i=n[s],2===t.stopped||r&&i!=r&&!i.canRecognizeWith(r)?i.reset():i.recognize(e),!r&&i.state&(nt|rt|st)&&(r=t.curRecognizer=i),s++}},get:function(e){if(e instanceof j)return e;for(var t=this.recognizers,i=0;i<t.length;i++)if(t[i].options.event==e)return t[i];return null},add:function(e){if(s(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e},remove:function(e){if(s(e,"remove",this))return this;var t=this.recognizers;return e=this.get(e),t.splice(b(t,e),1),this.touchAction.update(),this},on:function(e,t){var i=this.handlers;return a(v(e),function(e){i[e]=i[e]||[],i[e].push(t)}),this},off:function(e,t){var i=this.handlers;return a(v(e),function(e){t?i[e].splice(b(i[e],t),1):delete i[e]}),this},emit:function(e,t){this.options.domEvents&&oe(e,t);var i=this.handlers[e]&&this.handlers[e].slice();if(i&&i.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var n=0;n<i.length;)i[n](t),n++}},destroy:function(){this.element&&ae(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},o(re,{INPUT_START:we,INPUT_MOVE:Se,INPUT_END:Re,INPUT_CANCEL:ye,STATE_POSSIBLE:it,STATE_BEGAN:nt,STATE_CHANGED:rt,STATE_ENDED:st,STATE_RECOGNIZED:at,STATE_CANCELLED:ot,STATE_FAILED:32,DIRECTION_NONE:_e,DIRECTION_LEFT:Ce,DIRECTION_RIGHT:Me,DIRECTION_UP:De,DIRECTION_DOWN:Fe,DIRECTION_HORIZONTAL:Ae,DIRECTION_VERTICAL:Pe,DIRECTION_ALL:Ue,Manager:se,Input:R,TouchAction:H,TouchInput:q,MouseInput:O,PointerEventInput:z,TouchMouseInput:G,SingleTouchInput:k,Recognizer:j,AttrRecognizer:J,Tap:ne,Pan:Z,Swipe:ie,Pinch:$,Rotate:te,Press:ee,on:f,off:m,each:a,merge:h,extend:o,inherit:u,bindFn:c,prefixed:E}),typeof define==ce&&define.amd?define(function(){return re}):"undefined"!=typeof module&&module.exports?module.exports=re:e.HammerWF=re}(window,document),frakVersion="1.3.10",FRAK.extend=function(){for(var e=1;e<arguments.length;e++)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]},FRAK.isFunction=function(e){return"function"==typeof e},FRAK.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},FRAK.parseJSON=function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e);if(window.jQuery&&window.jQuery.parseJSON)return window.jQuery.parseJSON(e);throw"FRAK.parseJSON: No JSON parser available."},FRAK.timestamp=window.performance&&window.performance.now?function(){return window.performance.now.apply(window.performance)}:Date.now,FRAK.requestAnimationFrame=function(){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame;return e?function(){return e.apply(window,arguments)}:function(e){return window.setTimeout(e,1e3/60)}}(),FRAK.cancelAnimationFrame=function(){var e=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame;return e?function(){return e.apply(window,arguments)}:clearTimeout}(),FRAK.fullscreenEnabled=document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled,FRAK.requestFullscreen=function(e){(e.requestFullscreen||e.requestFullScreen||e.webkitRequestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen||e.msRequestFullScreen||function(){}).call(e)},FRAK.exitFullscreen=function(){(document.exitFullscreen||document.exitFullScreen||document.webkitExitFullscreen||document.webkitExitFullScreen||document.mozExitFullscreen||document.mozExitFullScreen||document.msExitFullscreen||document.msExitFullScreen||function(){}).call(document)},FRAK.isFullscreen=function(){return document.isFullScreen||document.isFullscreen||document.webkitIsFullscreen||document.webkitIsFullScreen||document.mozIsFullscreen||document.mozIsFullScreen||document.msIsFullscreen||document.msIsFullScreen};var Cloneable=FrakClass.extend({type:function(){return!1},clone:function(){return"function"==typeof window[this.type()]?new(window[this.type()]):{}}}),nextSerializableID=1,Serializable=Cloneable.extend({init:function(){this.serializable=!0,this.id=nextSerializableID++},included:function(){return!0},excluded:function(){return[]},getSerializableFields:function(e){var t=this.included();if(excluded=this.excluded(),!0===t&&!0===excluded)throw"Quantum classes not allowed. A subclass of Serializable tries to both include and exclude all fields.";if(!1===t&&!1===excluded)throw"Quantum classes not allowed. A subclass of Serializable tries both not to include and not to exclude all fields.";if(!1===t||!0===excluded)return{};var i={};if(!0===t){for(var n in this){a={};this[n]&&"[object Function]"==a.toString.call(this[n])||"serializable"==n||"_super"==n||(i[n]=this[n])}if(excluded instanceof Array){excluded=excluded.concat(e);for(var r=0;r<excluded.length;r++)i[excluded[r]]&&delete i[excluded[r]]}}if(!0===excluded){i=[];for(var s=0;s<t.length;s++){var a={};this[n=t[s]]&&"[object Function]"==a.toString.call(this[n])||"serializable"==n||"_super"==n||(i[n]=this[n])}}return i},serialize:function(e){try{return(new Serializer).serialize(this,e,32)}catch(e){throw console.warn("Caught serialization exception: ",e),e}},unserialize:function(e){FRAK.parseJSON(e);return!1},serializeCyclic:function(e){try{return(new CyclicSerializer).serialize(this,e,32)}catch(e){throw console.warn("Caught serialization exception: ",e),e}},unserializeCyclic:function(e){try{return(new CyclicSerializer).unserialize(e)}catch(e){throw console.warn("Caught serialization exception: ",e),e}},onBeforeSerialize:function(){},onAfterSerialize:function(){},onBeforeUnserialize:function(){},onAfterUnserialize:function(){}}),Serializer=FrakClass.extend({init:function(){this.serializables={}},serializableCopy:function(e,t,i,n,r){var s={},a=t.getSerializableFields(i);if(n>=r){var o=[];for(var h in e)o.push(e[h].type());throw"Reached maximum depth for serialization: "+n+" at "+t.type()}(e=e.slice(0)).splice(0,0,t);for(var u in a){var c=a[u];if(c instanceof Serializable)s[u]=this.serializableCopy(e,c,i,n+1,r);else if(c instanceof Array||c instanceof Float32Array){var l=[];for(var d in c)c[d]instanceof Serializable?l.push(this.serializableCopy(e,c[d],i,n+1,r)):l.push(c[d]);s[u]=l}else s[u]=a[u]}return{_type_:t.type(),_properties_:s}},serialize:function(e,t,i){this.serializables={};var n=this.serializableCopy([],e,t,0,i);return JSON.stringify({_root_:n,_serializables_:this.serializables},void 0,2)},unserializeSerializables:function(e){for(var t in e)this.serializables[t]=this.unserializeCopy(e[t])},unserializeCopy:function(e){if(e instanceof Array){for(var t in e)e[t]=this.unserializeCopy(e[t]);return e}if(e instanceof Object){if(e._reference_)return e;if(e._type_){var i=new window[e._type_];i.onBeforeUnserialize();for(var t in e._properties_)i[t]=this.unserializeCopy(e._properties_[t]);return i.onAfterUnserialize(),i}return e}return i},resolveReferences:function(e,t){if(e[t]instanceof Array)for(var i in e[t])e[t][i]=this.resolveReferences(e[t],i);else if(e[t]instanceof Object)if(e[t]._reference_)e[t]=this.serializables[e[t]._id_];else for(var i in e[t])e[t][i]=this.resolveReferences(e[t],i)},unserialize:function(e){var t=FRAK.parseJSON(e);this.serializables={},this.unserializeSerializables(t._serializables_);var i=this.unserializeCopy(t._root_);for(var n in this.serializables)this.resolveReferences(this.serializables,n);return this.resolveReferences(t,"_serializables_"),i}}),CyclicSerializer=FrakClass.extend({init:function(){this.serializables={},this.visited=[]},serializableCopy:function(e,t,i,n,r){if(n>=r)return{};(e=e.slice(0)).push(t);try{if("object"==typeof t){if(!t)return null;if(t instanceof Serializable){if(!this.serializables[t.id]){this.serializables[t.id]=!0,t.onBeforeSerialize();o=t.getSerializableFields(t,i);for(var s in o)o[s]=this.serializableCopy(e,o[s],i,n+1,r);t.onAfterSerialize(),this.serializables[t.id]={_type_:t.type(),_properties_:o}}return{_reference_:!0,_id_:t.id}}if(t instanceof Array||t instanceof Float32Array){var a=[];for(var s in t)a.push(this.serializableCopy(e,t[s],i,n+1,r));return a}if(t._visited_)return void console.warn("Already visited object: ",t);t._visited_=!0;var o={};for(var s in t)o[s]=this.serializableCopy(e,t[s],i,n+1,r);return o}return t}catch(i){throw console.warn("Caught: ",t,i),console.warn("Stack: "),console.warn(e),i}},serialize:function(e,t,i){this.serializables={};var n=this.serializableCopy([],e,t,0,i);return JSON.stringify({_root_:n,_serializables_:this.serializables},void 0,2)},unserializeSerializables:function(e){for(var t in e)this.serializables[t]=this.unserializeCopy(e[t])},unserializeCopy:function(e){if(e instanceof Array){for(var t in e)e[t]=this.unserializeCopy(e[t]);return e}if(e instanceof Object){if(e._reference_)return e;if(e._type_){var i=new window[e._type_];i.onBeforeUnserialize();for(var t in e._properties_)i[t]=this.unserializeCopy(e._properties_[t]);return i}return e}return e},resolveReferences:function(e,t,i){if(!(i>32))if(e[t]instanceof Array)for(var n in e[t])this.resolveReferences(e[t],n,i+1);else if(e[t]instanceof Object&&!("_visited_"in e[t]))if(e[t]._reference_)e[t]=this.serializables[e[t]._id_];else if(e[t]instanceof Serializable){e[t]._visited_=!0,this.visited.push(e[t]);for(var r in e[t])this.resolveReferences(e[t],r,i+1)}},unserialize:function(e){var t=FRAK.parseJSON(e);this.serializables={},this.unserializeSerializables(t._serializables_);var i={_root_:this.unserializeCopy(t._root_)};this.resolveReferences(i,"_root_",0);for(var n in this.serializables)this.resolveReferences(this.serializables,n,0);for(var n in this.visited)this.visited[n]instanceof Serializable&&this.visited[n].onAfterUnserialize();for(var n in this.visited)delete this.visited[n]._visited_;return i._root_}}),TypeReference=Serializable.extend({init:function(e,t){this._super(),this.valueType=e,this.value=t},type:function(){return"TypeReference"},isNull:function(){return!this.value}}),Color=function(e,t,i,n){this.r=1,this.g=1,this.b=1,this.a=1,this.clone=function(){return new Color(this.r,this.g,this.b,this.a)},this.fromHex=function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i.exec(e);return t&&(this.r=parseInt(t[1],16)/255,this.g=parseInt(t[2],16)/255,this.b=parseInt(t[3],16)/255,t[4]&&(this.a=parseInt(t[4],16)/255)),this},this.toHex=function(){return"#"+("0"+Math.round(255*this.r).toString(16)).slice(-2)+("0"+Math.round(255*this.g).toString(16)).slice(-2)+("0"+Math.round(255*this.b).toString(16)).slice(-2)+("0"+Math.round(255*this.a).toString(16)).slice(-2)},this.toString=function(){return"rgba("+Math.floor(255*this.r)+", "+Math.floor(255*this.g)+", "+Math.floor(255*this.b)+", "+this.a+")"},this.toVector=function(e){return e||(e=vec4.create()),vec4.set(e,this.r,this.g,this.b,this.a),e},this.set=function(e,t,i,n){return"number"==typeof e&&(this.r=e),"number"==typeof t&&(this.g=t),"number"==typeof i&&(this.b=i),"number"==typeof n&&(this.a=n),this},this.set(e,t,i,n)},MatrixStack=FrakClass.extend({init:function(){this.stack=[mat4.identity(mat4.create())],this.allocated=[];for(var e=0;e<64;e++)this.allocated.push(mat4.create())},top:function(){return this.stack[this.stack.length-1]},push:function(){0==this.allocated.length&&this.allocated.push(mat4.create()),this.stack.push(mat4.copy(this.allocated.pop(),this.stack[this.stack.length-1]))},pop:function(){this.allocated.push(this.stack.pop())},multiply:function(e){mat4.multiply(this.stack[this.stack.length-1],this.stack[this.stack.length-1],e)},load:function(e){mat4.copy(this.stack[this.stack.length-1],e)},size:function(){return this.stack.length}}),RenderingContext=FrakClass.extend({init:function(e,t,i){if(!("WebGLRenderingContext"in window))throw"Unable to create rendering context, because browser doesn't support WebGL";if("string"==typeof e&&(e=document.getElementById(e)),window.jQuery&&e instanceof jQuery&&(e=e[0]),!e)throw"RenderingContext requires a canvas element";if(this.canvas=e,"undefined"!=typeof WebGLDebugUtils&&(this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(e),this.canvas.setRestoreTimeout(2e3)),t=t||{alpha:!1},this.gl=this.canvas.getContext("webgl",t),this.gl||(this.gl=this.canvas.getContext("experimental-webgl",t)),this.gl||(this.gl=this.canvas.getContext("moz-webgl",t)),this.gl||(this.gl=this.canvas.getContext("webkit-3d",t)),!this.gl){var n=!1;if(FRAK.isFunction(i)&&(n=i()),!n){var r=document.createElement("div");r.style.position="relative",r.style.zIndex=100,r.style.backgroundColor="red",r.style.padding="8px",r.textContent="WebGL seems to be unavailable in this browser.";var s=e.parentNode;s.insertBefore(r,s.firstChild)}throw"Failed to acquire GL context from canvas"}"undefined"!=typeof WebGLDebugUtils&&(this.gl=WebGLDebugUtils.makeDebugContext(this.gl,function(e,t,i){throw WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t+JSON.stringify(i)}),console.warn("Using WebGLDebugUtils")),this.modelview=new MatrixStack,this.projection=new MatrixStack,this.light=!1,this.shadow=!1,this.camera=!1,this.engine=!1},error:function(){if(this.isContextLost())throw Error("Context lost");var e=this.gl.getError();if(e>0&&"undefined"!=typeof WebGLDebugUtils)throw Error("GL_ERROR: "+WebGLDebugUtils.glEnumToString(e));return e},isContextLost:function(){return!this.gl||this.gl.isContextLost()},restore:function(){if(!this.engine)return!1;this.gl.getError();var e=this,t=this.engine,i=t.assetsManager.texturesManager;for(var n in i.cache)i.cache[n].onContextRestored(e);t.scene.root.onEachChildComponent(function(t){(t instanceof RendererComponent||t instanceof TextComponent)&&t.onContextRestored(e)});for(n=0;n<t.scene.lights.length;++n)t.scene.lights[n].onContextRestored(e);t.WhiteTexture.glTexture=null,t.WhiteTexture.loaded=!1,t.WhiteTexture.clearImage(e,[255,255,255,255]),fallbackTexture&&fallbackTexture.onContextRestored(e),fallbackCubeTexture&&fallbackCubeTexture.onContextRestored(e),t.scene&&t.scene.cameraComponent&&t.scene.cameraComponent.onContextRestored(e);var r=t.assetsManager.shadersManager;for(var n in r.cache)r.cache[n].onContextRestored(e);return!0}}),ExplicitAttributeLocations={position:0,normal:1,texcoord2d0:2,uv0:2,tangent:3,bitangent:4},Subshader=FrakClass.extend({init:function(e,t,i){this.shader=e,this.context=e.context,this.code=t,this.type=i,this.VERTEX_SHADER=0,this.FRAGMENT_SHADER=1,this.compiledShader=!1,this.failedCompilation=!1},attach:function(){this.context.gl.attachShader(this.shader.program,this.compiledShader)},getFilename:function(){return"Unknown"},compile:function(){if(!this.failedCompilation){if(!this.compiledShader)throw"WebGL shader has not been created. FragmentShader or VertexShader class instances should be used, not Shader.";if(this.context.gl.shaderSource(this.compiledShader,this.code),this.context.gl.compileShader(this.compiledShader),!this.context.gl.getShaderParameter(this.compiledShader,this.context.gl.COMPILE_STATUS)&&!this.failedCompilation)throw this.failedCompilation=!0,"Shader '"+this.getFilename()+"' failed to compile: "+this.context.gl.getShaderInfoLog(this.compiledShader)}},onContextRestored:function(e){this.failedCompilation=!1,this.context=e,this.attach()}}),VertexShader=Subshader.extend({init:function(e,t){this._super(e,t,this.VERTEX_SHADER),this.compiledShader=this.context.gl.createShader(this.context.gl.VERTEX_SHADER)},getFilename:function(){return this.shader.descriptor.vertexSource},onContextRestored:function(e){this.compiledShader=this.context.gl.createShader(this.context.gl.VERTEX_SHADER),this._super(e)}}),FragmentShader=Subshader.extend({init:function(e,t){this._super(e,t,this.FRAGMENT_SHADER),this.compiledShader=this.context.gl.createShader(this.context.gl.FRAGMENT_SHADER)},getFilename:function(){return this.shader.descriptor.fragmentSource},onContextRestored:function(e){this.compiledShader=this.context.gl.createShader(this.context.gl.FRAGMENT_SHADER),this._super(e)}}),ShaderRequirements=FrakClass.extend({init:function(){this.barycentric=!1,this.bitangents=!1,this.tangents=!1,this.transparent=!1,this.texCoords2D=!0},apply:function(e){this.barycentric&&!e.buffers.barycentric&&e.generateBarycentric(),this.texCoords2D&&!e.buffers.texcoord2d0&&e.generateTexCoords()}}),Shader=Serializable.extend({init:function(e,t){if(!e)throw"Shader: RenderingContext required";this._super(),this.descriptor=t,this.context=e,this.program=e.gl.createProgram(),this.shaders=[],this.requirements=new ShaderRequirements,this.linked=!1,this.failed=!1,this.uniformLocations={}},excluded:function(){return!0},included:function(){return["descriptor"]},addVertexShader:function(e){var t=new VertexShader(this,e);this.addShader(t)},addFragmentShader:function(e){var t=new FragmentShader(this,e);this.addShader(t)},addShader:function(e){this.shaders.push(e),e.attach()},link:function(){if(!this.failed){for(var e=0;e<this.shaders.length;e++)this.shaders[e].compile(this.context);for(var t in ExplicitAttributeLocations)this.context.gl.bindAttribLocation(this.program,ExplicitAttributeLocations[t],t);this.uniformLocations={},this.linked=!0,this.context.gl.linkProgram(this.program),this.context.gl.getProgramParameter(this.program,this.context.gl.LINK_STATUS)||(console.error("Shader linking failed: ",this.context.gl.getProgramInfoLog(this.program)),this.linked=!1,this.failed=!0)}},use:function(e){this.failed||this.shaders.length<2||(this.linked||this.link(),this.linked&&(this.context.gl.useProgram(this.program),this.bindUniforms(e)))},getAttribLocation:function(e){return e in ExplicitAttributeLocations?ExplicitAttributeLocations[e]:this.context.gl.getAttribLocation(this.program,e)},getUniformLocation:function(e){return e in this.uniformLocations||(this.uniformLocations[e]=this.context.gl.getUniformLocation(this.program,e)),this.uniformLocations[e]},bindUniforms:function(e){if(e&&this.linked)for(var t in e){var i=this.getUniformLocation(t);if(i&&-1!=i){var n=e[t];if(!n)throw"Uniform '"+t+"' is undefined.";n.bind(this.context,i)}}},bindSamplers:function(e){if(e&&0!=e.length&&this.linked){for(var t=this.context.gl,i=0,n=0;n<e.length;++n){var r=e[n];if(!r)break;var s=this.getUniformLocation(r.name);-1!=s&&(r.bind(this.context,s,i),i++)}t.activeTexture(t.TEXTURE0)}},unbindSamplers:function(e){if(e&&0!=e.length&&this.linked){for(var t=this.context.gl,i=0,n=0;n<e.length;++n){var r=e[n];if(!r)break;var s=this.getUniformLocation(r.name);-1!=s&&(r.unbind(this.context,s,i),i++)}t.activeTexture(t.TEXTURE0)}},onContextRestored:function(e){this.context=e,this.program=e.gl.createProgram(),this.uniformLocations={},this.failed=!1,this.linked=!1;for(var t=0;t<this.shaders.length;++t)this.shaders[t].onContextRestored(e);this.link()}}),Uniform=Cloneable.extend({init:function(e){this.value=e},bind:function(e,t){},clone:function(){var e=this._super();return e.value=this.value,e}}),UniformInt=Uniform.extend({bind:function(e,t){e.gl.uniform1i(t,this.value)},type:function(){return"UniformInt"}}),UniformFloat=Uniform.extend({bind:function(e,t){e.gl.uniform1f(t,this.value)},type:function(){return"UniformFloat"}}),UniformVec2=Uniform.extend({init:function(e){e||(e=vec2.create()),e instanceof Float32Array?this._super(e):this._super(new Float32Array(e))},type:function(){return"UniformVec2"},bind:function(e,t){e.gl.uniform2fv(t,this.value)},clone:function(){var e=this._super();return e.value=vec2.clone(this.value),e}}),UniformVec3=Uniform.extend({init:function(e){e||(e=vec3.create()),e instanceof Float32Array?this._super(e):this._super(new Float32Array(e))},type:function(){return"UniformVec3"},bind:function(e,t){e.gl.uniform3fv(t,this.value)},clone:function(){var e=this._super();return e.value=vec3.clone(this.value),e}}),UniformVec4=Uniform.extend({init:function(e){e||(e=vec4.create()),e instanceof Float32Array?this._super(e):this._super(new Float32Array(e))},type:function(){return"UniformVec4"},bind:function(e,t){e.gl.uniform4fv(t,this.value)},clone:function(){var e=this._super();return e.value=vec4.clone(this.value),e}}),UniformColor=UniformVec4.extend({init:function(e){e?e instanceof Color?this._super(e.toVector()):"r"in e&&"g"in e&&"b"in e&&"a"in e?this._super(vec4.fromValues(e.r,e.g,e.b,e.a)):this._super(vec4.fromValues(1,1,1,1)):this._super(vec4.fromValues(1,1,1,1))},type:function(){return"UniformColor"}}),UniformMat2=Uniform.extend({type:function(){return"UniformMat2"},bind:function(e,t){e.gl.uniformMatrix2fv(t,0,this.value)},clone:function(){var e=this._super();return e.value=mat2.clone(this.value),e}}),UniformMat3=Uniform.extend({bind:function(e,t){e.gl.uniformMatrix3fv(t,!1,this.value)},type:function(){return"UniformMat3"},clone:function(){var e=this._super();return e.value=mat3.clone(this.value),e}}),UniformMat4=Uniform.extend({bind:function(e,t){e.gl.uniformMatrix4fv(t,!1,this.value)},type:function(){return"UniformMat4"},clone:function(){var e=this._super();return e.value=mat4.clone(this.value),e}}),fallbackTexture=!1,fallbackCubeTexture=!1,Sampler=Serializable.extend({init:function(e,t){this.name=e,this.texture=t},type:function(){return"Sampler"},createFallbackTexture:function(e){fallbackTexture=new Texture(e);var t=document.createElement("canvas");t.width=2,t.height=2;var i=t.getContext("2d");i.fillStyle="rgb(255,255,255)",i.fillRect(0,0,2,2),fallbackTexture.setImage(e,t)},createFallbackCubeTexture:function(e){fallbackCubeTexture=new CubeTexture(e);var t=document.createElement("canvas");t.width=2,t.height=2;var i=t.getContext("2d");i.fillStyle="rgb(255,255,255)",i.fillRect(0,0,2,2),fallbackCubeTexture.setFace(e,CubeTexture.FRONT,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.BACK,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.LEFT,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.RIGHT,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.TOP,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.BOTTOM,t,!0)},bind:function(e,t,i){if(e.gl.activeTexture(i+e.gl.TEXTURE0),e.gl.uniform1i(t,i),!this.texture||!this.texture.loaded)return fallbackTexture||this.createFallbackTexture(e),void fallbackTexture.bind(e);this.texture.bind(e)},unbind:function(e,t,i){e.gl.activeTexture(i+e.gl.TEXTURE0),this.texture&&this.texture.loaded?this.texture.unbind(e):fallbackTexture.unbind(e)},clone:function(){var e=this._super();return e.name=this.name,e.texture=this.texture,e}}),Camera=Serializable.extend({init:function(e,t,i){this.viewMatrix=e,this.projectionMatrix=t,this.viewInverseMatrix=mat4.create(),mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.renderStage=i,this.target=new TargetScreen,this.backgroundColor=new Color(0,0,0,0),this.clearMask=!1,this.order=0,this.layerMask=4294967295,this.frustum=!1;var n=!1;this.stereo=function(e){return e&&(n=!0),!1===e&&(n=!1),n};var r=2;this.stereoEyeDistance=function(e){return e&&(r=e),r},this._viewportSize=vec2.create(),this._viewportPosition=vec2.create(),this._originalViewMatrix=mat4.create(),this._eyeSeparation=mat4.create(),this._cacheQuat=quat.create(),this._strafe=vec3.create(),this._translation=vec3.create()},type:function(){return"Camera"},excluded:function(){return["renderStage","target"]},clearBuffers:function(e){e.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),e.gl.clearDepth(1),e.gl.depthMask(!0),!1===this.clearMask?e.gl.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT):e.gl.clear(this.clearMask)},startRender:function(e){e.projection.push(),e.projection.multiply(this.projectionMatrix),e.modelview.push(),e.modelview.multiply(this.viewMatrix)},renderScene:function(e,t,i,n){i&&i(e,this),this.renderStage.render(e,t,this),n&&n(e,this)},endRender:function(e){e.modelview.pop(),e.projection.pop()},render:function(e,t,i,n){if(this.target.resetViewport(),this.clearBuffers(e),e.camera=this,this.stereo()){mat4.invert(this.viewInverseMatrix,this.viewMatrix),vec2.copy(this._viewportPosition,this.target.viewport.position),vec2.copy(this._viewportSize,this.target.viewport.size);var r=this._viewportSize[0]/2;this.target.viewport.size[0]=r;var s=this.stereoEyeDistance()/2;this.getStrafeVector(this._strafe),mat4.copy(this._originalViewMatrix,this.viewMatrix),vec3.scale(this._translation,this._strafe,-s),mat4.fromRotationTranslation(this._eyeSeparation,quat.create(),this._translation),mat4.mul(this.viewMatrix,this.viewMatrix,this._eyeSeparation),mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.target.viewport.position[0]=0,this.startRender(e),this.renderScene(e,t,i,n),this.endRender(e),mat4.copy(this.viewMatrix,this._originalViewMatrix),vec3.scale(this._translation,this._strafe,s),mat4.fromRotationTranslation(this._eyeSeparation,quat.create(),this._translation),mat4.mul(this.viewMatrix,this.viewMatrix,this._eyeSeparation),mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.target.viewport.position[0]=r,this.startRender(e),this.renderScene(e,t,i,n),this.endRender(e),vec2.copy(this.target.viewport.position,this._viewportPosition),vec2.copy(this.target.viewport.size,this._viewportSize),mat4.copy(this.viewMatrix,this._originalViewMatrix)}else mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.startRender(e),this.renderScene(e,t,i,n),this.endRender(e);e.camera=!1},getFieldOfView:function(){return 2*Math.atan(1/this.projectionMatrix[5])},getDirection:function(e){return e||(e=vec3.create()),e[0]=-this.viewMatrix[8],e[1]=-this.viewMatrix[9],e[2]=-this.viewMatrix[10],e},getUpVector:function(e){return e||(e=vec3.create()),e[0]=this.viewMatrix[4],e[1]=this.viewMatrix[5],e[2]=this.viewMatrix[6],e},getStrafeVector:function(e){return e||(e=vec3.create()),e[0]=this.viewMatrix[0],e[1]=this.viewMatrix[1],e[2]=this.viewMatrix[2],e},getPosition:function(e){return e||(e=vec3.create()),mat4.translation(e,this.viewInverseMatrix),e},setPosition:function(e){var t=this.getPosition();vec3.sub(t,t,e);var i=mat4.fromTranslation(mat4.create(),t);mat4.mul(this.viewMatrix,this.viewMatrix,i)},center:function(e){var t=this.getDirection(),i=this.getPosition(),n=new Plane;n.setByNormalAndPoint(t,i);var r=n.projectToPlane(e);this.setPosition(r)},fitToView:function(e){if(e instanceof BoundingVolume&&e.center&&(this.center(e.center),!e.isPoint())){var t=0;e instanceof BoundingSphere?t=2*e.radius:e instanceof BoundingBox&&(t=2*e.getOuterSphereRadius());var i=t/Math.sin(this.getFieldOfView()/2)-t,n=this.getDirection(),r=vec3.create();vec3.scale(n,n,-i),vec3.add(r,e.center,n),this.setPosition(r)}}});TransparencySort.cmpValue=vec3.create();var RendererOrganizer=FrakClass.extend({init:function(){this.enableDynamicBatching=!0,this.solidRenderers=[],this.transparentRenderers=[],this.opaqueBatchList=[],this.transparentBatchList=[],this.batchIndex={},this.renderers=new CollectionReference([]),this.viewSolidRenderers=new CollectionView(this.renderers,function(e){return!e.transparent}),this.viewTransparentRenderers=new CollectionView(this.renderers,function(e){return e.transparent}),this.visibleRenderers=0,this.visibleSolidRenderers=0,this.visibleSolidBatches=0,this.visibleSolidFaces=0,this.visibleTransparentRenderers=0,this.visibleTransparentFaces=0,this.visibleTransparentBatches=0},updateStats:function(){this.visibleSolidRenderers=this.viewSolidRenderers.length,this.visibleTransparentRenderers=this.viewTransparentRenderers.length,this.visibleRenderers=this.visibleSolidRenderers+this.visibleTransparentRenderers},batch:function(e,t){for(var i,n=0;n<e.length;++n)e[n].clear();for(var r,n=0;n<t.length&&(r=t[n]);++n)r.material.id in this.batchIndex?i=e[this.batchIndex[r.material.id]]:(i=new Batch(t),e.push(i),this.batchIndex[r.material.id]=e.length-1),i?i.add(n):(i=new Batch(t),e.push(i),this.batchIndex[r.material.id]=e.length-1)},sort:function(e,t,i){this.renderers.list=t,this.viewSolidRenderers.filter(),this.viewTransparentRenderers.filter(),this.solidRenderers=this.viewSolidRenderers.view,this.transparentRenderers=this.viewTransparentRenderers.view,this.enableDynamicBatching&&("sorted"!=e.options.transparencyMode&&this.batch(this.transparentBatchList,this.transparentRenderers),this.batch(this.opaqueBatchList,this.solidRenderers)),"sorted"==e.options.transparencyMode&&i&&(vec3.copy(TransparencySort.cmpValue,i),this.transparentRenderers.sort(TransparencySort)),this.updateStats()}});ScreenQuad.prototype.update=function(e,t,i,n){this.vertices[0]=e,this.vertices[1]=t,this.vertices[3]=e,this.vertices[4]=t+n,this.vertices[6]=e+i,this.vertices[7]=t+n,this.vertices[9]=e+i,this.vertices[10]=t,this.quad.update("position",this.vertices)},ScreenQuad.prototype.render=function(e,t,i){var n;e.gl;i&&(n=i instanceof Sampler?[i]:i),t.bind({},n),this.quad.render(t.shader),t.unbind(n)};var RenderStage=FrakClass.extend({init:function(){this.parent=!1,this.substages=[],this.started=!1,this.enabled=!0},addStage:function(e){return e.parent=this,this.substages.push(e),e},removeStage:function(e){for(var t=0;t<this.substages.length;t++)if(this.substages[t]===e)return e.parent=!1,this.substages.splice(t,1),!0;return!1},removeStagesByType:function(e){for(var t=[],i=0;i<this.substages.length;i++)this.substages[i]instanceof e&&(t.push(this.substages[i]),this.substages.splice(i,1),i--);for(i=0;i<t.length;i++)t[i].parent=!1;return t},clearStages:function(){for(var e=0;e<this.substages.length;e++)this.substages[e].parent=!1;this.substages=[]},getStageByType:function(e){for(var t=0;t<this.substages.length;t++)if(this.substages[t]instanceof e)return this.substages[t];return!1},start:function(e,t,i){this.started=!0,this.onStart(e,t,i);for(var n=0;n<this.substages.length;n++)this.substages[n].start(e,t,i)},render:function(e,t,i){if(this.enabled){this.onPreRender(e,t,i);for(var n=0;n<this.substages.length;n++)this.substages[n].started||this.substages[n].start(e,t.engine,i),this.substages[n].render(e,t,i);this.onPostRender(e,t,i)}},enable:function(){return this.enabled=!0,this.onEnable(),this},disable:function(){return this.enabled=!1,this.onDisable(),this},onStart:function(e,t,i){},onPreRender:function(e,t,i){},onPostRender:function(e,t,i){},onEnable:function(){},onDisable:function(){}}),MaterialRenderStage=RenderStage.extend({init:function(){this._super(),this.organizer=new RendererOrganizer,this.solidRenderers=[],this.solidRendererBatches={},this.transparentRenderers=[],this.transparentRendererBatches={},this.shadowFallback=null,this.diffuseFallback=null,this.bindCameraTarget={started:!0,start:function(){},render:function(e,t,i){i.target.bind(e)}},this.unbindCameraTarget={started:!0,start:function(){},render:function(e,t,i){i.target.unbind(e)}},this.shadowMapStage=this.addStage(new ShadowMapRenderStage),this.depthStage=this.addStage(new DepthRenderStage).disable(),this.oitStage=this.addStage(new OITRenderStage).disable(),this.addStage(this.bindCameraTarget),this.skyboxStage=this.addStage(new SkyboxRenderStage),this.opaqueStage=this.addStage(new OpaqueGeometryRenderStage),this.transparentStage=this.addStage(new TransparentGeometryRenderStage),this.addStage(this.unbindCameraTarget),this.eyePosition=vec3.create(),this.invModelview=mat4.create(),this.sharedUniforms={view:new UniformMat4(mat4.create()),viewInverse:new UniformMat4(mat4.create()),projection:new UniformMat4(mat4.create())},this.rendererUniforms={model:new UniformMat4(null),modelview:new UniformMat4(null),receiveShadows:new UniformInt(1)},this.shadowUniforms={lightView:new UniformMat4(mat4.create()),lightProjection:new UniformMat4(mat4.create()),shadowBias:new UniformFloat(.001),hasFloat:new UniformInt(1),useVSM:new UniformInt(1)},this.cachedUniforms=null,this.samplerAccum=new SamplerAccumulator},onStart:function(e,t,i){this.diffuseFallback=new Sampler("diffuse0",t.WhiteTexture),this.shadowFallback=new Sampler("shadow0",t.WhiteTexture),!0===t.options.ssao&&this.depthStage.enable(),"sorted"!=t.options.transparencyMode&&this.oitStage.enable()},prepareShadowContext:function(e,t){this._shadowContext||(this._shadowContext={shadow0:this.shadowFallback,lightProjection:this.shadowUniforms.lightProjection,lightView:this.shadowUniforms.lightView}),e.shadow=this._shadowContext,e.shadow.shadow0=this.shadowFallback;var i=this.shadowMapStage.getFirstShadowCastingLight(t);i&&(mat4.copy(this.shadowUniforms.lightView.value,i.lightView),mat4.copy(this.shadowUniforms.lightProjection.value,i.lightProj),this.shadowUniforms.shadowBias.value=i.shadowBias,this.shadowUniforms.hasFloat.value=i.shadow instanceof TargetTextureFloat?1:0,1==this.shadowUniforms.hasFloat.value&&this.shadowMapStage.extStandardDerivatives?this.shadowUniforms.useVSM.value=1:this.shadowUniforms.useVSM.value=0,e.shadow.shadow0=i.shadowSampler)},prepareLightContext:function(e,t){for(var i=0;i<t.lights.length;i++){var n=t.lights[i];n instanceof DirectionalLight&&(n.enabled&&(n.uniforms?(vec3.copy(n.uniforms.lightDirection.value,n.direction),n.uniforms.lightIntensity.value=n.intensity,n.uniforms.lightColor.value[0]=n.color.r,n.uniforms.lightColor.value[1]=n.color.g,n.uniforms.lightColor.value[2]=n.color.b,n.uniforms.lightColor.value[3]=n.color.a,n.uniforms.useShadows.value=n.shadowCasting?1:0):n.uniforms={lightDirection:new UniformVec3(n.direction),lightColor:new UniformColor(n.color),lightIntensity:new UniformFloat(n.intensity),useShadows:new UniformInt(n.shadowCasting?1:0)}))}},prepareShared:function(e){mat4.invert(this.invModelview,e.modelview.top()),mat4.translation(this.eyePosition,this.invModelview),mat4.copy(this.sharedUniforms.projection.value,e.projection.top()),mat4.copy(this.sharedUniforms.view.value,e.camera.viewMatrix),mat4.copy(this.sharedUniforms.viewInverse.value,e.camera.viewInverseMatrix)},onPreRender:function(e,t,i){this.prepareShared(e);var n=t.dynamicSpace.frustumCast(i.frustum,i.layerMask);this.organizer.sort(t.engine,n,this.eyePosition),this.solidRenderers=this.organizer.solidRenderers,this.transparentRenderers=this.organizer.transparentRenderers,this.solidRendererBatches=this.organizer.solidRendererBatches,this.transparentRendererBatches=this.organizer.transparentRendererBatches,this.prepareLightContext(e,t),this.prepareShadowContext(e,t)},onPostRender:function(e,t,i){e.shadow=!1,e.light=!1},renderBatched:function(e,t){for(var i=!1,n=0,r=t.length;n<r;++n){var s=t[n];if(s.get(0)){var a=s.get(0).material,o=a.shader;o!=i&&(o.use(),i=o,e.shadow&&o.bindUniforms(this.shadowUniforms),o.bindUniforms(this.sharedUniforms),e.light&&e.light.uniforms&&o.bindUniforms(e.light.uniforms)),this.samplerAccum.add(e.shadow.shadow0);for(var h=0,u=a.samplers.length;h<u;++h)this.samplerAccum.add(a.samplers[h]);0==this.samplerAccum.length&&this.samplerAccum.add(this.diffuseFallback),o.bindSamplers(this.samplerAccum.samplers),o.bindUniforms(a.uniforms);for(var c,h=0,l=s.length;h<l;++h)c=s.get(h),e.modelview.push(),e.modelview.multiply(c.matrix),this.rendererUniforms.model.value=c.matrix,this.rendererUniforms.modelview.value=e.modelview.top(),this.rendererUniforms.receiveShadows.value=c.receiveShadows,o.bindUniforms(this.rendererUniforms),c.render(e),e.modelview.pop();o.unbindSamplers(this.samplerAccum.samplers),this.samplerAccum.clear()}}},renderBruteForce:function(e,t){for(var i=0;i<t.length;++i){var n=t[i];if(!n)break;e.modelview.push(),e.modelview.multiply(n.matrix),this.cachedUniforms=n.getDefaultUniforms(e,null),n.material.bind(this.cachedUniforms,e.shadow.shadow0),n.render(e),n.material.unbind(),e.modelview.pop()}}}),ShaderRenderStage=RenderStage.extend({init:function(e,t){this._super(t),this.shader=e,this.uniforms={}},onPostRender:function(e,t,i){this.shader.use(this.uniforms),this.shader.requirements.transparent&&(e.gl.blendFunc(e.gl.SRC_ALPHA,e.gl.ONE),e.gl.enable(e.gl.BLEND));for(var n=t.dynamicSpace.frustumCast(i.frustum,i.layerMask),r=0;r<n.length;r++)n[r].renderGeometry(e,this.shader);this.shader.requirements.transparent&&e.gl.disable(e.gl.BLEND)}}),DepthRenderStage=RenderStage.extend({init:function(e){this._super(),this.target=null,this.sampler=new Sampler("depth0",null),this.size=vec2.fromValues(1024,1024),e&&vec2.copy(this.size,e),this.clearColor=new Color(0,0,0,0)},onStart:function(e,t){try{this.target=new TargetTextureFloat(this.size,e,!1),this.sampler.texture=this.target.texture}catch(e){return console.warn("DepthRenderStage: ",e),void this.disable()}this.material=new Material(t.assetsManager.addShaderSource("shaders/default/depth"),{zNear:new UniformFloat(.1),zFar:new UniformFloat(1e3)},[])},onPreRender:function(e,t,i){if(this.target.resetViewport(),i.target.size[0]!=this.size[0]||i.target.size[1]!=this.size[1]){var n=i.target.size;vec2.copy(this.size,n),this.target.setSize(n[0],n[1])}},onPostRender:function(e,t,i){this.material.uniforms.zNear.value=i.near,this.material.uniforms.zFar.value=i.far,e.projection.push(),e.projection.load(i.projectionMatrix),e.modelview.push(),e.modelview.load(i.viewMatrix),this.target.bind(e,!1,this.clearColor);var n=e.gl;n.enable(n.DEPTH_TEST),n.depthFunc(n.LESS),n.depthMask(!0),this.material.bind();for(var r=this.parent.organizer.solidRenderers,s=0;s<r.length&&r[s];++s)e.modelview.push(),e.modelview.multiply(r[s].matrix),this.material.shader.bindUniforms(r[s].material.uniforms),r[s].renderGeometry(e,this.material.shader),e.modelview.pop();this.material.unbind(),this.renderAlphaMapped(e,t,i),n.disable(n.DEPTH_TEST),this.target.unbind(e),e.modelview.pop(),e.projection.pop()},renderAlphaMapped:function(e,t,i){var n=this.parent.organizer.transparentBatchList,r=this.material.shader;r.use(),r.bindUniforms(this.material.uniforms),r.bindUniforms(this.parent.sharedUniforms),e.light&&e.light.uniforms&&r.bindUniforms(e.light.uniforms);for(var s=0;s<n.length;s++){var a=n[s];if(0!=a.length){var o,h=a.get(0).material;o=this.material.samplers.length>0?this.material.samplers.concat(h.samplers):h.samplers,r.bindUniforms(h.uniforms),r.bindSamplers(o);for(var u,c=0;c<a.length;++c)u=a.get(c),e.modelview.push(),e.modelview.multiply(u.matrix),this.parent.rendererUniforms.model.value=u.matrix,this.parent.rendererUniforms.modelview.value=e.modelview.top(),r.bindUniforms(this.parent.rendererUniforms),u.renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(o)}}}}),ShadowMapRenderStage=RenderStage.extend({init:function(e){this._super(),this.material=null,this.clearColor=new Color(0,0,0,1),this.lightPosition=vec3.create(),this.lightLookTarget=vec3.create(),this.lightUpVector=vec3.fromValues(0,1,0),this.aabbVertices=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],this.sceneAABB=new BoundingBox,this.lightFrustum=new BoundingBox},onStart:function(e,t){var i="forward_shadow";this.extStandardDerivatives=e.gl.getExtension("OES_standard_derivatives"),this.extStandardDerivatives&&(i="forward_shadow_vsm"),this.material=new Material(t.assetsManager.addShader("shaders/default/forward_shadow.vert","shaders/default/{0}.frag".format(i)),{hasFloat:new UniformInt(1)},[]),t.assetsManager.load()},onPostRender:function(e,t,i){var n=this.getFirstShadowCastingLight(t);if(n){this.computeSceneBounds(),vec3.copy(this.lightPosition,this.sceneAABB.center),vec3.sub(this.lightLookTarget,this.lightPosition,n.direction),mat4.lookAt(n.lightView,this.lightPosition,this.lightLookTarget,this.lightUpVector),this.sceneAABB.getVertices(this.aabbVertices);for(a=0;a<8;a++)vec3.transformMat4(this.aabbVertices[a],this.aabbVertices[a],n.lightView);this.lightFrustum.set(this.aabbVertices[0],[0,0,0]);for(a=1;a<8;a++)this.lightFrustum.encapsulatePoint(this.aabbVertices[a]);mat4.ortho(n.lightProj,this.lightFrustum.min[0],this.lightFrustum.max[0],this.lightFrustum.min[1],this.lightFrustum.max[1],this.lightFrustum.min[2],this.lightFrustum.max[2]),n.shadow instanceof TargetTextureFloat?this.material.uniforms.hasFloat.value=1:this.material.uniforms.hasFloat.value=0,e.projection.push(),e.projection.load(n.lightProj),e.modelview.push(),e.modelview.load(n.lightView),n.shadow.bind(e,!1,this.clearColor);var r=e.gl;r.enable(r.DEPTH_TEST),r.depthFunc(r.LESS),r.depthMask(!0),r.colorMask(!0,!0,!0,!0),this.material.bind();for(var s=this.parent.organizer.solidRenderers,a=0;a<s.length&&s[a];++a)s[a].layer&n.shadowMask&&s[a].castShadows&&(e.modelview.push(),e.modelview.multiply(s[a].matrix),this.material.shader.bindUniforms(s[a].material.uniforms),s[a].renderGeometry(e,this.material.shader),e.modelview.pop());this.material.unbind(),this.renderAlphaMapped(e,n),r.disable(r.DEPTH_TEST),n.shadow.unbind(e),n.updateSamplers(),this.parent.prepareShadowContext(e,t),e.modelview.pop(),e.projection.pop()}},renderAlphaMapped:function(e,t){var i=this.parent.organizer.transparentBatchList,n=this.material.shader,r=[this.parent.diffuseFallback];n.use(),n.bindUniforms(this.material.uniforms),n.bindUniforms(this.parent.sharedUniforms);for(var s,a=0;a<i.length;a++){var o=i[a];if(0!=o.length){var h=o.get(0).material;s=h.samplers.length>0?h.samplers:r,n.bindUniforms(h.uniforms),n.bindSamplers(s);for(var u,c=0;c<o.length;++c)(u=o.get(c)).layer&t.shadowMask&&u.castShadows&&(e.modelview.push(),e.modelview.multiply(u.matrix),this.parent.rendererUniforms.model.value=u.matrix,this.parent.rendererUniforms.modelview.value=e.modelview.top(),n.bindUniforms(this.parent.rendererUniforms),u.renderGeometry(e,n),e.modelview.pop());n.unbindSamplers(s)}}},computeSceneBounds:function(){!1===this.sceneAABB.center&&(this.sceneAABB.center=vec3.create()),vec3.set(this.sceneAABB.center,0,0,0),vec3.set(this.sceneAABB.extents,0,0,0),this.sceneAABB.recalculate();for(var e=this.parent.organizer.solidRenderers,t=this.parent.organizer.transparentRenderers,i=0;i<e.length&&e[i];i++)e[i].castShadows&&this.sceneAABB.encapsulateBox(e[i].globalBoundingBox);for(i=0;i<t.length&&t[i];i++)t[i].castShadows&&this.sceneAABB.encapsulateBox(t[i].globalBoundingBox);return this.sceneAABB},getFirstShadowCastingLight:function(e){for(var t=0;t<e.lights.length;t++)if(e.lights[t]instanceof DirectionalLight&&e.lights[t].enabled&&!0===e.lights[t].shadowCasting)return e.lights[t];return!1}}),PositionBufferRenderStage=RenderStage.extend({init:function(e){this._super(),this.size=2048,e&&(this.size=e),this.target=!1},onStart:function(e,t){this.target=new TargetTextureFloat([this.size,this.size],e,!1),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/positionbuffer"),{ViewportSize:new UniformVec2(vec2.clone(t.scene.camera.target.size))},[]);var i=[0,0,0,0,1,0,1,1,0,1,0,0],n=[0,1,0,0,1,0,1,1],r=[0,1,2,0,2,3];this.quad=new TrianglesRenderBuffer(e,r),this.quad.add("position",i,3),this.quad.add("texcoord2d0",n,2),t.assetsManager.load(function(){})},onPreRender:function(e,t,i){vec2.set(this.material.uniforms.ViewportSize.value,i.target.size[0],i.target.size[1])},onPostRender:function(e,t,i){if(this.parent&&this.parent instanceof MaterialRenderStage&&this.target&&this.material){this.target.bind(e);var n=e.gl;n.depthMask(!0),n.clearDepth(1),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.DEPTH_TEST),n.depthFunc(n.LESS),this.material.bind();for(var r=0;r<this.parent.solidRenderers.length&&this.parent.solidRenderers[r];++r)this.parent.solidRenderers[r].layer&&this.parent.solidRenderers[r].visible&&(e.modelview.push(),e.modelview.multiply(this.parent.solidRenderers[r].matrix),this.parent.solidRenderers[r].renderGeometry(e,this.material.shader),e.modelview.pop());this.material.unbind(),n.depthMask(!0),n.disable(n.DEPTH_TEST),this.target.unbind(e)}}}),SSAOBufferRenderStage=RenderStage.extend({init:function(){this._super(),this.size=!1,this.quad=!1,this.target=!1},setSize:function(e,t){!1===this.size&&(this.size=vec2.create()),this.size[0]=e,this.size[1]=t},onStart:function(e,t){this.size||(this.size=vec2.clone(t.scene.camera.target.size)),this.target=new TargetTextureFloat([t.scene.camera.target.size[0],t.scene.camera.target.size[1]],e,!1),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/ssao"),{ViewportSize:new UniformVec2(vec2.clone(t.scene.camera.target.size)),ssaoGDisplace:new UniformFloat(t.options.ssaoGDisplace?t.options.ssaoGDisplace:6),ssaoRadius:new UniformFloat(t.options.ssaoRadius?t.options.ssaoRadius:8),ssaoDivider:new UniformFloat(t.options.ssaoDivider?t.options.ssaoDivider:.5)},[new Sampler("position0",this.parent.positionBufferStage.target.texture)]),this.material.name="SSAO";var i=[-1,-1,0,-1,1,0,1,1,0,1,-1,0],n=[0,1,0,0,1,0,1,1],r=[0,1,2,0,2,3];this.quad=new TrianglesRenderBuffer(e,r),this.quad.add("position",i,3),this.quad.add("texcoord2d0",n,2),t.assetsManager.load()},onPreRender:function(e,t,i){var n=i.target;n.size[0]==this.target.size[0]&&n.size[1]==this.target.size[1]||(vec2.set(this.material.uniforms.ViewportSize.value,i.target.size[0],i.target.size[1]),this.setSize(n.size[0],n.size[1]),this.target.setSize(n.size[0],n.size[1]))},onPostRender:function(e,t,i){if(this.parent&&this.parent instanceof MaterialRenderStage&&this.target&&this.material){this.target.bind(e);var n=e.gl;if(n.disable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),this.material.bind(),this.material.shader.linked){var r=[];for(var s in this.quad.buffers){n.bindBuffer(n.ARRAY_BUFFER,this.quad.buffers[s]);var a=n.getAttribLocation(this.material.shader.program,s);-1!=a&&(n.enableVertexAttribArray(a),r.push(a),n.vertexAttribPointer(a,this.quad.buffers[s].itemSize,n.FLOAT,!1,0,0))}this.quad.drawElements();for(var o in r)n.disableVertexAttribArray(r[o])}this.material.unbind(),this.target.unbind(e)}}}),SkyboxRenderStage=RenderStage.extend({init:function(){this._super(),this.uniforms={model:new UniformMat4(mat4.create()),modelview:new UniformMat4(mat4.create()),projection:new UniformMat4(mat4.create()),view:new UniformMat4(mat4.create()),viewInverse:new UniformMat4(mat4.create()),zNear:new UniformFloat(0),zFar:new UniformFloat(0),lightDirection:new UniformVec3(vec3.create()),lightColor:new UniformColor(new Color),lightIntensity:new UniformFloat(1)},this.shadowFallback=null},onStart:function(e,t,i){this.shadowFallback=new Sampler("shadow0",t.WhiteTexture)},onPostRender:function(e,t,i){var n=t.cameraNode.getComponent(SkyboxComponent);if(n)for(var r=[this.shadowFallback],s=n.meshNode.getComponent(MeshRendererComponent).meshRenderers,a=0;a<s.length;a++){var o=s[a],h=o.getDefaultUniforms(e,this.uniforms);mat4.identity(h.model.value),mat4.translate(h.model.value,h.model.value,i.getPosition()),o.material.bind(h,r),o.render(e),o.material.unbind(r)}}}),OpaqueGeometryRenderStage=RenderStage.extend({init:function(){this._super(),this.activeLights=[]},getDirectionalLights:function(e){this.activeLights.length<e.lights.length&&(this.activeLights.length=e.lights.length);for(var t,i=0,n=0;n<e.lights.length;++n)(t=e.lights[n])instanceof DirectionalLight&&t.enabled&&(this.activeLights[i++]=t);for(n=i;n<e.lights.length;++n)this.activeLights[n]=null;return this.activeLights},onPostRender:function(e,t,i){var n=this.getDirectionalLights(t),r=e.gl;if(r.enable(r.DEPTH_TEST),r.depthFunc(r.LESS),r.depthMask(!0),n.length>0&&n[0]&&(e.light=n[0]),this.parent.organizer.enableDynamicBatching?this.parent.renderBatched(e,this.parent.organizer.opaqueBatchList):this.parent.renderBruteForce(e,this.parent.organizer.solidRenderers),n.length>1&&n[1]){r.depthMask(!1),r.depthFunc(r.LEQUAL),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND);for(var s=1;s<n.length&&n[s];s++)e.light=n[s],this.parent.organizer.enableDynamicBatching?this.parent.renderBatched(e,this.parent.organizer.opaqueBatchList):this.parent.renderBruteForce(e,this.parent.organizer.solidRenderers);r.disable(r.BLEND),r.depthMask(!0),r.depthFunc(r.LESS)}r.disable(r.DEPTH_TEST),e.light=!1}}),TransparentGeometryRenderStage=RenderStage.extend({renderSorted:function(e,t,i){var n=e.gl;n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.enable(n.BLEND),n.depthMask(!1),n.depthFunc(n.LESS),n.enable(n.DEPTH_TEST),this.parent.renderBruteForce(e,this.parent.organizer.transparentRenderers),n.disable(n.BLEND),n.disable(n.DEPTH_TEST),n.depthMask(!0)},onPostRender:function(e,t,i){"sorted"==t.engine.options.transparencyMode?this.renderSorted(e,t,i):this.parent.oitStage.renderAlphaMapped(e,t,i)}}),OITRenderStage=RenderStage.extend({init:function(){this._super(),this.diffuseFallback=null,this.oitClearColor=new Color(0,0,0,0),this.transparencyTarget=!1,this.transparencySampler=!1,this.transparencyWeight=!1,this.transparencyWeightSampler=!1,this.transparencyAccum=!1},onStart:function(e,t,i){try{var n=i.target.size;this.transparencyTarget=new TargetTextureFloat(n,e,!1),this.transparencyWeight=new TargetTextureFloat(n,e,!1)}catch(e){return console.warn("OITRenderStage: ",e),void this.disable()}this.transparencySampler=new Sampler("oitAccum",this.transparencyTarget.texture),this.transparencyWeightSampler=new Sampler("oitWeight",this.transparencyWeight.texture),this.diffuseFallback=new Sampler("diffuse0",t.WhiteTexture);var r=e.gl;this.transparencyWeight.bind(e,!0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this.transparencyTarget.depth),this.transparencyWeight.unbind(e),this.transparencyWeight.depth=this.transparencyTarget.depth,this.transparencyAccum=new Material(t.assetsManager.addShaderSource("shaders/default/OITAccum"),{render_mode:new UniformInt(0)},[]),this.opaqueDepthMaterial=new Material(t.assetsManager.addShaderSource("diffuse"),{useShadows:new UniformInt(0),ambient:new UniformColor,diffuse:new UniformColor},[this.diffuseFallback,new Sampler("shadow0",t.WhiteTexture)]),t.assetsManager.load()},onPostRender:function(e,t,i){if(this.transparencyTarget.resetViewport(),this.transparencyWeight.resetViewport(),i.target.size[0]!=this.transparencyTarget.size[0]||i.target.size[1]!=this.transparencyTarget.size[1]){this.transparencyTarget.setSize(i.target.size[0],i.target.size[1]),this.transparencyWeight.setSize(i.target.size[0],i.target.size[1]);var n=e.gl;this.transparencyWeight.bind(e,!0),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,this.transparencyTarget.depth),this.transparencyWeight.unbind(e),this.transparencyWeight.depth=this.transparencyTarget.depth}e.projection.push(),e.projection.load(i.projectionMatrix),e.modelview.push(),e.modelview.load(i.viewMatrix),this.oitClearColor.set(0,0,0,0),this.transparencyTarget.bind(e,!1,this.oitClearColor),e.gl.depthMask(!0),e.gl.colorMask(!1,!1,!1,!1),this.renderOpaque(e,t,i),this.renderAlphaMapped(e,t,i),e.gl.colorMask(!0,!0,!0,!0),this.renderPass(e,t,i,!0),this.transparencyTarget.unbind(e),this.oitClearColor.set(1,1,1,1),this.transparencyWeight.bind(e,!1,this.oitClearColor,e.gl.COLOR_BUFFER_BIT),this.renderPass(e,t,i,!1),this.transparencyWeight.unbind(e),e.modelview.pop(),e.projection.pop()},renderTransparentBatches:function(e,t,i,n){var r=n.shader;r.use(),r.bindUniforms(n.uniforms),e.light&&e.light.uniforms&&r.bindUniforms(e.light.uniforms);for(var s=this.parent.organizer.transparentBatchList,a=0;a<s.length;a++){var o=s[a];if(0!=o.length){var h,u=o.get(0).material;h=n.samplers.length>0?n.samplers.concat(u.samplers):u.samplers,0==u.samplers.length&&h.push(this.diffuseFallback),r.bindUniforms(u.uniforms),r.bindSamplers(h);for(var c,l=0;l<o.length;++l)c=o.get(l),e.modelview.push(),e.modelview.multiply(c.matrix),c.renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(h)}}},renderAlphaMapped:function(e,t,i){var n=e.gl;n.depthMask(!0),n.depthFunc(n.LESS),n.enable(n.DEPTH_TEST),this.transparencyAccum.uniforms.render_mode.value=2,this.renderTransparentBatches(e,t,i,this.transparencyAccum),n.disable(n.DEPTH_TEST)},renderOpaque:function(e,t,i){var n=e.gl;n.enable(n.DEPTH_TEST),n.depthFunc(n.LESS);var r=this.opaqueDepthMaterial.shader;r.use(),r.bindUniforms(this.opaqueDepthMaterial.uniforms),r.bindSamplers(this.opaqueDepthMaterial.samplers);for(var s=this.parent.organizer.solidRenderers,a=0;a<s.length&&s[a];++a)e.modelview.push(),e.modelview.multiply(s[a].matrix),s[a].renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(this.opaqueDepthMaterial.samplers),n.disable(n.DEPTH_TEST)},renderPass:function(e,t,i,n){var r=e.gl;r.colorMask(!0,!0,!0,!0),r.depthFunc(r.LESS),r.enable(r.DEPTH_TEST),"blended"==t.engine.options.transparencyMode&&(n?(r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND),this.transparencyAccum.uniforms.render_mode.value=0):(r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ZERO,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),this.transparencyAccum.uniforms.render_mode.value=1)),"stochastic"==t.engine.options.transparencyMode&&(n?(r.depthMask(!0),this.transparencyAccum.uniforms.render_mode.value=3):(r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ZERO,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),this.transparencyAccum.uniforms.render_mode.value=1)),this.renderTransparentBatches(e,t,i,this.transparencyAccum),r.disable(r.BLEND),r.disable(r.DEPTH_TEST),r.depthMask(!0)}}),PostProcessRenderStage=RenderStage.extend({init:function(){this._super(),this.size=!1,this.src=!1,this.dst=!1,this.srcSampler=!1,this.dstSampler=!1,this.textureQuad=!1,this.screenQuad=!1,this.material=!1,this.generator=this.getGeneratorStage(),this.generator.parent=this},setSize:function(e,t){!1===this.size&&(this.size=vec2.create()),this.size[0]=e,this.size[1]=t},getGeneratorStage:function(){return new MaterialRenderStage},onStart:function(e,t,i){this.size||(this.size=vec2.clone(i.target.size)),this.src=new TargetTexture(this.size,e,!1,!0),this.srcSampler=new Sampler("src",this.src.texture),this.dst=new TargetTexture(this.size,e,!1,!0),this.dstSampler=new Sampler("src",this.dst.texture),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/ScreenQuad"),{},[]),this.material.name="To Screen",this.textureQuad=new ScreenQuad(e),this.screenQuad=new ScreenQuad(e),t.assetsManager.load(),this.generator.start(e,t,i)},onPreRender:function(e,t,i){var n=i.target;this.src.resetViewport(),this.dst.resetViewport(),n.size[0]==this.src.size[0]&&n.size[1]==this.src.size[1]||(this.setSize(n.size[0],n.size[1]),this.src.setSize(n.size[0],n.size[1]),this.dst.setSize(n.size[0],n.size[1])),this.substages.length>0&&(i.target=this.src),this.generator.render(e,t,i),i.target=n},onPostRender:function(e,t,i){0!=this.substages.length&&(i.target instanceof TargetTexture?(i.target.bind(e),this.renderEffect(e,this.material,this.srcSampler),i.target.unbind(e)):(i.target.bind(e),this.renderEffect(e,this.material,this.srcSampler,!0),i.target.unbind(e)),this.swapBuffers())},swapBuffers:function(){var e=this.src,t=this.srcSampler;this.src=this.dst,this.srcSampler=this.dstSampler,this.dst=e,this.dstSampler=t},renderEffect:function(e,t,i,n){var r=e.gl;r.disable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),!0===n?this.screenQuad.render(e,t,i):this.textureQuad.render(e,t,i)}}),ForwardRenderStage=PostProcessRenderStage.extend({init:function(){this._super(),this.debugActive=!1,this.debugger=null},onPostRender:function(e,t,i){if(this._super(e,t,i),this.debugActive){this.debugger||this.initDebugger(e,t);var n=e.gl;n.disable(n.DEPTH_TEST),n.disable(n.CULL_FACE),e.modelview.push();for(var r=0;r<this.debugger.quads.length;r++)this.debugger.sampler.texture=this.debugger.quads[r].texture,this.material.bind({},[this.debugger.sampler]),this.debugger.quads[r].quad.render(this.material.shader),this.material.unbind([this.debugger.sampler]);this.debugger.sampler.texture=this.debugger.vsyncTextures[0],this.material.bind({},[this.debugger.sampler]),this.debugger.vsyncQuad.render(this.material.shader),this.material.unbind([this.debugger.sampler]),this.debugger.vsyncTextures.reverse(),e.modelview.pop()}},debug:function(e){this.debugActive=!(!1===e)},initDebugger:function(e,t){function i(t,i,n,r){var s=[t,i,0,t,i+r,0,t+n,i+r,0,t+n,i,0],a=new TrianglesRenderBuffer(e,[0,1,2,0,2,3]);return a.add("position",s,3),a.add("uv0",[0,0,0,1,1,1,1,0],2),a}var n=new Texture(e);n.name="Red",n.mipmapped=!1,n.clearImage(e,[255,0,0,255]);var r=new Texture(e);r.name="Red",r.mipmapped=!1,r.clearImage(e,[0,255,255,255]),this.debugger={quads:[],sampler:new Sampler("tex0",null),vsyncQuad:i(.85,.85,.1,.1),vsyncTextures:[n,r]};for(var s=-1,a=1-(h=.5),o=0;o<t.lights.length;o++)t.lights[o].enabled&&t.lights[o].shadowCasting&&t.lights[o].shadow&&t.lights[o]instanceof DirectionalLight&&(this.debugger.quads.push({quad:i(s,a,h,h),texture:t.lights[o].shadow.texture}),s+=h);var h=.5,s=-1,a=-1;this.generator.oitStage.enabled&&(this.debugger.quads.push({quad:i(s,a,h,h),texture:this.generator.oitStage.transparencyTarget.texture}),this.debugger.quads.push({quad:i(s+=h,a,h,h),texture:this.generator.oitStage.transparencyWeight.texture})),this.generator.depthStage.enabled&&this.debugger.quads.push({quad:i(s+=h,a,h,h),texture:this.generator.depthStage.target.texture})}}),DeferredRenderStage=PostProcessRenderStage.extend({init:function(){this._super(),this.debugActive=!1,this.debugger=null},onStart:function(e,t,i){if(!e.gl.getExtension("WEBGL_draw_buffers"))throw"DeferredRenderStage: WEBGL_draw_buffers not available.";if(!e.gl.getExtension("OES_texture_float"))throw"DeferredRenderStage: OES_texture_float not available.";if(!e.gl.getExtension("OES_standard_derivatives"))throw"DeferredRenderStage: OES_standard_derivatives not available.";this._super(e,t,i)},getGeneratorStage:function(){return new DeferredShadingRenderStage},onPreRender:function(e,t,i){var n=i.target;if(this.src.resetViewport(),this.dst.resetViewport(),this.generator.gbufferStage.damaged){var r=vec2.scale(vec2.create(),this.generator.gbufferStage.size,this.generator.gbufferStage.quality);this.src.setSize(r[0],r[1]),this.dst.setSize(r[0],r[1])}this.setSize(n.size[0],n.size[1]),this.substages.length>0&&(i.target=this.src),this.generator.render(e,t,i),i.target=n},onPostRender:function(e,t,i){if(this._super(e,t,i),this.debugActive){this.debugger||this.initDebugger(e,t);var n=e.gl;n.disable(n.DEPTH_TEST),n.disable(n.CULL_FACE),e.modelview.push();for(var r=0;r<this.debugger.quads.length;r++)this.debugger.sampler.texture=this.debugger.quads[r].texture,this.material.bind({},[this.debugger.sampler]),this.debugger.quads[r].quad.render(this.material.shader),this.material.unbind([this.debugger.sampler]);e.modelview.pop()}},debug:function(e){this.debugActive=!(!1===e)},initDebugger:function(e,t){function i(t,i,n,r){var s=[t,i,0,t,i+r,0,t+n,i+r,0,t+n,i,0],a=new TrianglesRenderBuffer(e,[0,1,2,0,2,3]);return a.add("position",s,3),a.add("uv0",[0,0,0,1,1,1,1,0],2),a}this.debugger={quads:[],sampler:new Sampler("tex0",null)};var n=this.generator.gbufferStage.buffer,r=2/7,s=-1,a=-1;this.debugger.quads.push({quad:i(s,a,r,r),texture:n.targets[0]}),this.debugger.quads.push({quad:i(s+=r,a,r,r),texture:n.targets[1]}),this.debugger.quads.push({quad:i(s+=r,a,r,r),texture:n.targets[2]}),this.debugger.quads.push({quad:i(s+=r,a,r,r),texture:n.targets[3]}),this.debugger.quads.push({quad:i(s+=r,a,r,r),texture:this.generator.softShadowsStage.target.texture}),this.debugger.quads.push({quad:i(s+=r,a,r,r),texture:this.generator.oitStage.transparencyTarget.texture}),this.debugger.quads.push({quad:i(s+=r,a,r,r),texture:this.generator.oitStage.transparencyWeight.texture}),s=-1,a=1-(r=.5);for(var o=0;o<t.lights.length;o++)t.lights[o].enabled&&t.lights[o].shadowCasting&&t.lights[o].shadow&&t.lights[o]instanceof DirectionalLight&&(this.debugger.quads.push({quad:i(s,a,r,r),texture:t.lights[o].shadow.texture}),s+=r)}}),DeferredShadingRenderStage=RenderStage.extend({init:function(){this._super(),this.organizer=new RendererOrganizer,this.diffuseFallback=null,this.size=vec2.create(),this.bindCameraTarget={started:!0,start:function(){},render:function(e,t,i){i.target.bind(e,!0)}},this.unbindCameraTarget={started:!0,start:function(){},render:function(e,t,i){i.target.unbind(e)}},this.shadowStage=this.addStage(new DeferredShadowRenderStage),this.oitStage=this.addStage(new OITRenderStage),this.gbufferStage=this.addStage(new GBufferRenderStage),this.softShadowsStage=this.addStage(new SoftShadowsRenderStage).disable(),this.addStage(this.bindCameraTarget),this.lightsStage=this.addStage(new LightsRenderStage),this.addStage(this.unbindCameraTarget),this.sharedUniforms={view:new UniformMat4(mat4.create()),viewInverse:new UniformMat4(mat4.create()),projection:new UniformMat4(mat4.create())},this.rendererUniforms={model:new UniformMat4(null),modelview:new UniformMat4(null),receiveShadows:new UniformInt(1)}},onStart:function(e,t,i){this.diffuseFallback=new Sampler("diffuse0",t.WhiteTexture),vec2.copy(this.size,this.parent.size),t.options.softShadows&&this.softShadowsStage.enable()},prepareShared:function(e){mat4.copy(this.sharedUniforms.projection.value,e.projection.top()),mat4.copy(this.sharedUniforms.view.value,e.camera.viewMatrix),mat4.copy(this.sharedUniforms.viewInverse.value,e.camera.viewInverseMatrix),vec2.copy(this.size,this.parent.size)},onPreRender:function(e,t,i){this.prepareShared(e);var n=t.dynamicSpace.frustumCast(i.frustum,i.layerMask);this.organizer.sort(t.engine,n)},onPostRender:function(e,t,i){}}),DeferredShadowRenderStage=RenderStage.extend({init:function(){this._super(),this.material=null,this.directional=[],this.clearColor=new Color(0,0,0,0),this.lightPosition=vec3.create(),this.lightLookTarget=vec3.create(),this.lightUpVector=vec3.fromValues(0,1,0),this.aabbVertices=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],this.sceneAABB=new BoundingBox,this.lightFrustum=new BoundingBox},onStart:function(e,t,i){this.extStandardDerivatives=e.gl.getExtension("OES_standard_derivatives"),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/deferred_shadow_directional"),{},[]),t.assetsManager.load()},collectLights:function(e){this.directional.length=0;for(var t=0;t<e.lights.length;t++)e.lights[t].enabled&&e.lights[t].shadowCasting&&e.lights[t].shadow&&e.lights[t]instanceof DirectionalLight&&this.directional.push(e.lights[t])},computeSceneBounds:function(){!1===this.sceneAABB.center&&(this.sceneAABB.center=vec3.create()),vec3.set(this.sceneAABB.center,0,0,0),vec3.set(this.sceneAABB.extents,0,0,0),this.sceneAABB.recalculate();for(var e=this.parent.organizer.solidRenderers,t=this.parent.organizer.transparentRenderers,i=0;i<e.length&&e[i];i++)e[i].castShadows&&this.sceneAABB.encapsulateBox(e[i].globalBoundingBox);for(i=0;i<t.length&&t[i];i++)t[i].castShadows&&this.sceneAABB.encapsulateBox(t[i].globalBoundingBox);return this.sceneAABB},renderDirectionalLightDepth:function(e,t){vec3.copy(this.lightPosition,this.sceneAABB.center),vec3.sub(this.lightLookTarget,this.lightPosition,t.direction),mat4.lookAt(t.lightView,this.lightPosition,this.lightLookTarget,this.lightUpVector),this.sceneAABB.getVertices(this.aabbVertices);for(r=0;r<8;r++)vec3.transformMat4(this.aabbVertices[r],this.aabbVertices[r],t.lightView);this.lightFrustum.set(this.aabbVertices[0],[0,0,0]);for(r=1;r<8;r++)this.lightFrustum.encapsulatePoint(this.aabbVertices[r]);mat4.ortho(t.lightProj,this.lightFrustum.min[0],this.lightFrustum.max[0],this.lightFrustum.min[1],this.lightFrustum.max[1],this.lightFrustum.min[2],this.lightFrustum.max[2]),e.projection.push(),e.projection.load(t.lightProj),e.modelview.push(),e.modelview.load(t.lightView),t.shadow.bind(e,!1,this.clearColor);var i=e.gl;i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),this.material.bind();for(var n=this.parent.organizer.solidRenderers,r=0;r<n.length&&n[r];++r)if(n[r].layer&t.shadowMask&&n[r].castShadows){var s=this.material.shader;e.modelview.push(),e.modelview.multiply(n[r].matrix),s.bindUniforms(n[r].material.uniforms),n[r].renderGeometry(e,s),e.modelview.pop()}this.material.unbind(),this.renderAlphaMapped(e,t),i.disable(i.DEPTH_TEST),t.shadow.unbind(e),t.updateSamplers(e),e.modelview.pop(),e.projection.pop()},renderAlphaMapped:function(e,t){var i=this.parent.organizer.transparentBatchList,n=this.material.shader,r=[this.parent.diffuseFallback];n.use(),n.bindUniforms(this.material.uniforms);for(var s,a=0;a<i.length;a++){var o=i[a];if(0!=o.length){var h=o.get(0).material;s=h.samplers.length>0?h.samplers:r,n.bindUniforms(h.uniforms),n.bindSamplers(s);for(var u,c=0;c<o.length;++c)(u=o.get(c)).layer&t.shadowMask&&u.castShadows&&(e.modelview.push(),e.modelview.multiply(u.matrix),u.renderGeometry(e,n),e.modelview.pop());n.unbindSamplers(s)}}},onPreRender:function(e,t,i){this.collectLights(t),this.computeSceneBounds();for(var n=0;n<this.directional.length;n++)this.renderDirectionalLightDepth(e,this.directional[n])},onPostRender:function(e,t,i){}}),GBufferRenderStage=RenderStage.extend({init:function(){this._super(),this.buffer=null,this.clearColor=new Color(0,0,0,0),this.size=vec2.create(),this.quality=1,this.damaged=!0,this.perBatchUniforms={useNormalmap:new UniformInt(0),useReflection:new UniformInt(0)}},setQuality:function(e){(e=parseFloat(e))>0&&(this.quality=e,this.damaged=!0)},onStart:function(e,t,i){vec2.copy(this.size,this.parent.size);var n=vec2.scale(vec2.create(),this.size,this.quality);this.buffer=new TargetTextureMulti(e,n,{numTargets:4,stencil:!0}),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/deferred_gbuffer"),{zNear:new UniformFloat(.1),zFar:new UniformFloat(1e3)},[]),this.normalmapFallback=new Sampler("normal0"),this.maskFallback=new Sampler("mask"),this.envFallback=new Sampler("env0"),this.envFallback.createFallbackCubeTexture(e),this.envFallback.texture=fallbackCubeTexture,t.assetsManager.load()},onPreRender:function(e,t,i){if(this.material.uniforms.zNear.value=i.near,this.material.uniforms.zFar.value=i.far,this.damaged){var n=vec2.scale(vec2.create(),this.size,this.quality);this.buffer.setSize(n[0],n[1]),this.damaged=!1}},onPostRender:function(e,t,i){var n=e.gl;this.buffer.bind(e,!1,this.clearColor),n.depthMask(!0),n.colorMask(!0,!0,!0,!0),n.depthFunc(n.LESS),n.enable(n.DEPTH_TEST),n.enable(n.STENCIL_TEST),n.stencilMask(255),n.stencilFunc(n.ALWAYS,1,255),n.stencilOp(n.KEEP,n.KEEP,n.REPLACE),this.renderBatches(e,t,i,this.parent.organizer.opaqueBatchList,this.material),this.renderBatches(e,t,i,this.parent.organizer.transparentBatchList,this.material),n.stencilMask(255),n.disable(n.STENCIL_TEST),n.disable(n.DEPTH_TEST),this.buffer.unbind(e)},renderBatches:function(e,t,i,n,r){var s=r.shader;s.use(),s.bindUniforms(r.uniforms);for(var a=0;a<n.length;a++){var o=n[a];if(0!=o.length){var h=o.get(0).material;this.perBatchUniforms.useNormalmap.value=0,this.perBatchUniforms.useReflection.value=0;for(var u=!1,c=0;c<h.samplers.length;c++)"normal0"!=h.samplers[c].name?"env0"!=h.samplers[c].name?"mask"!=h.samplers[c].name||(u=!0):this.perBatchUniforms.useReflection.value=1:this.perBatchUniforms.useNormalmap.value=1;var l;l=r.samplers.length>0?r.samplers.concat(h.samplers):h.samplers.slice(),0==h.samplers.length&&l.push(this.parent.diffuseFallback),0==this.perBatchUniforms.useNormalmap.value&&l.push(this.normalmapFallback),0==this.perBatchUniforms.useReflection.value?(l.push(this.envFallback),l.push(this.maskFallback)):1!=this.perBatchUniforms.useReflection.value||u||l.push(this.maskFallback),s.bindUniforms(this.perBatchUniforms),s.bindUniforms(h.uniforms),s.bindSamplers(l);for(var d,f=0;f<o.length;++f)d=o.get(f),e.modelview.push(),e.modelview.multiply(d.matrix),d.renderGeometry(e,s),e.modelview.pop();s.unbindSamplers(l)}}}}),SoftShadowsRenderStage=RenderStage.extend({init:function(){this._super(),this.quality=1,this.damaged=!1,this.sharedUniforms={cameraPosition:new UniformVec3(vec3.create()),shadowOnly:new UniformInt(1),useSoftShadows:new UniformInt(0)},this.sharedSamplers=[],this.clearColor=new Color(0,0,0,0),this.target=null},setQuality:function(e){(e=parseFloat(e))>0&&(this.quality=e,this.damaged=!0)},getShadowCastingLights:function(e){for(var t=[],i=0;i<e.lights.length;i++){var n=e.lights[i];n.enabled&&(n.shadowCasting&&n.geometry&&n instanceof DirectionalLight&&t.push(n))}return t},onStart:function(e,t,i){var n=this.parent.gbufferStage.buffer;this.sharedSamplers.push(new Sampler("gb0",n.targets[0])),this.sharedSamplers.push(new Sampler("gb1",n.targets[1])),this.sharedSamplers.push(new Sampler("gb2",n.targets[2])),this.sharedSamplers.push(new Sampler("gb3",n.targets[3])),this.target=new TargetTexture(this.parent.size,e,!1),this.blurTarget=new TargetTexture(this.parent.size,e,!1),this.blurSampler=new Sampler("src",this.target.texture),this.blurHorizontal=new Material(t.assetsManager.addShader("shaders/default/shadow_blurh.vert","shaders/default/shadow_blur.frag"),{},[]),this.blurVertical=new Material(t.assetsManager.addShader("shaders/default/shadow_blurv.vert","shaders/default/shadow_blur.frag"),{},[]),t.assetsManager.load()},onPreRender:function(e,t,i){if(this.damaged){var n=vec2.scale(vec2.create(),this.parent.size,this.quality);this.target.setSize(n[0],n[1]),this.blurTarget.setSize(n[0],n[1]),this.damaged=!1}},onPostRender:function(e,t,i){var n=this.getShadowCastingLights(t);if(0!=n.length){i.getPosition(this.sharedUniforms.cameraPosition.value);var r=e.gl;r.disable(r.DEPTH_TEST),r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND),r.enable(r.CULL_FACE),r.cullFace(r.FRONT),this.target.bind(e,!1,this.clearColor);for(var s=0;s<n.length;s++)this.renderLight(e,n[s]);this.target.unbind(e),r.disable(r.BLEND),this.blurSampler.texture=this.target.texture,this.blurTarget.bind(e,!1,this.clearColor),this.parent.parent.renderEffect(e,this.blurHorizontal,this.blurSampler),this.blurTarget.unbind(e),this.blurSampler.texture=this.blurTarget.texture,this.target.bind(e,!1,this.clearColor),this.parent.parent.renderEffect(e,this.blurVertical,this.blurSampler),this.target.unbind(e)}},renderLight:function(e,t){var i=t.material,n=i.shader;n.use(),n.bindUniforms(this.sharedUniforms),n.bindUniforms(i.uniforms);var r;r=i.samplers.length>0?i.samplers.concat(this.sharedSamplers):this.sharedSamplers,n.bindSamplers(r);for(var s=t.getGeometryRenderers(),a=0;a<s.length;a++)e.modelview.push(),t.isPositional()&&e.modelview.multiply(s[a].matrix),s[a].renderGeometry(e,n),e.modelview.pop();n.unbindSamplers(r)}}),LightsRenderStage=RenderStage.extend({init:function(){this._super(),this.sharedUniforms={cameraPosition:new UniformVec3(vec3.create()),shadowOnly:new UniformInt(0),useSoftShadows:new UniformInt(1)},this.sharedSamplers=[],this.skyboxRenderStage=new SkyboxRenderStage},getLightsWithGeometry:function(e){for(var t=[],i=[],n=[],r=0;r<e.lights.length;r++){var s=e.lights[r];s.enabled&&(s.geometry&&(s instanceof AmbientLight?t.push(s):s instanceof DirectionalLight?i.push(s):n.push(s)))}return t.concat(i).concat(n)},onStart:function(e,t,i){var n=this.parent.gbufferStage.buffer;this.sharedSamplers.push(new Sampler("gb0",n.targets[0])),this.sharedSamplers.push(new Sampler("gb1",n.targets[1])),this.sharedSamplers.push(new Sampler("gb2",n.targets[2])),this.sharedSamplers.push(new Sampler("gb3",n.targets[3])),this.backgroundMaterial=new Material(t.assetsManager.addShaderSource("shaders/default/deferred_background"),{color:new UniformColor(new Color(1,1,1,1))},[]),t.assetsManager.load(),this.skyboxRenderStage.start(e,t,i)},onPreRender:function(e,t,i){this.sharedUniforms.useSoftShadows.value=this.parent.softShadowsStage.enabled?1:0,i.getPosition(this.sharedUniforms.cameraPosition.value)},onPostRender:function(e,t,i){var n=this.getLightsWithGeometry(t),r=e.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this.parent.gbufferStage.buffer.depth),r.disable(r.DEPTH_TEST),r.depthMask(!1),r.enable(r.STENCIL_TEST),r.stencilMask(0),r.stencilFunc(r.NOTEQUAL,1,255),i.backgroundColor.toVector(this.backgroundMaterial.uniforms.color.value),this.parent.parent.renderEffect(e,this.backgroundMaterial,this.sharedSamplers[1]),this.skyboxRenderStage.render(e,t,i),r.stencilFunc(r.EQUAL,1,255),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND),r.enable(r.CULL_FACE),r.cullFace(r.FRONT);for(var s=0;s<n.length;s++)this.renderLight(e,n[s]);r.disable(r.BLEND),r.stencilMask(255),r.disable(r.STENCIL_TEST)},renderLight:function(e,t){var i;t.shadowCasting&&t instanceof DirectionalLight&&1==this.sharedUniforms.useSoftShadows.value&&(i=t.shadowSampler.texture,t.shadowSampler.texture=this.parent.softShadowsStage.target.texture);var n=t.material.shader;n.use(),n.bindUniforms(this.sharedUniforms),n.bindUniforms(t.material.uniforms);var r;r=t.material.samplers.length>0?t.material.samplers.concat(this.sharedSamplers):this.sharedSamplers,n.bindSamplers(r);for(var s=t.getGeometryRenderers(),a=0;a<s.length;a++)e.modelview.push(),t.isPositional()&&e.modelview.multiply(s[a].matrix),s[a].renderGeometry(e,n),e.modelview.pop();n.unbindSamplers(r),t.shadowCasting&&t instanceof DirectionalLight&&1==this.sharedUniforms.useSoftShadows.value&&(t.shadowSampler.texture=i)}}),PostProcess=RenderStage.extend({init:function(){this._super(),this.material=!1},onPostRender:function(e,t,i){if(!(this.parent instanceof PostProcessRenderStage))throw"PostProcess can only be the sub-stage of a PostProcessRenderStage";if(!this.material)throw"PostProcess must have a material defined";this.parent.dst.bind(e),this.parent.renderEffect(e,this.material,this.parent.srcSampler),this.parent.dst.unbind(e),this.parent.swapBuffers()}}),AntiAliasPostProcess=PostProcess.extend({init:function(){this._super()},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource("shaders/default/postprocess_fxaa"),{ViewportSize:new UniformVec2(vec2.clone(this.parent.src.size)),reduce_min:new UniformFloat(1/16),reduce_mul:new UniformFloat(1/8),span_max:new UniformFloat(8)},[]),this.material.name="AntiAlias",t.assetsManager.load()},onPreRender:function(e,t,i){this._super(e,t,i),vec2.copy(this.material.uniforms.ViewportSize.value,this.parent.src.size)}}),BlurPostProcess=PostProcess.extend({init:function(e){this._super(),this.blurSize=vec2.fromValues(1,1),e&&vec2.copy(this.blurSize,e)},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource("shaders/default/postprocess_blur"),{ViewportSize:new UniformVec2(vec2.clone(this.parent.size)),BlurSize:new UniformVec2(this.blurSize)},[]),this.material.name="Blur",t.assetsManager.load()},onPreRender:function(e,t,i){this._super(e,t,i),vec2.set(this.material.uniforms.ViewportSize.value,this.parent.size[0],this.parent.size[1])}}),OITPostProcess=PostProcess.extend({init:function(){this._super()},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource("shaders/default/OITRender"),{ViewportSize:new UniformVec2(vec2.clone(this.parent.src.size)),render_mode:new UniformInt(0)},[this.parent.generator.oitStage.transparencySampler,this.parent.generator.oitStage.transparencyWeightSampler]),this.material.name="OIT",t.assetsManager.load()},onPreRender:function(e,t,i){switch(this._super(e,t,i),vec2.copy(this.material.uniforms.ViewportSize.value,this.parent.src.size),t.engine.options.transparencyMode){case"blended":this.material.uniforms.render_mode.value=0;break;case"stochastic":this.material.uniforms.render_mode.value=1}}}),SSAOPostProcess=PostProcess.extend({init:function(e){this._super(),this.ssaoOnly=!1},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource("shaders/default/postprocess_ssao"),{ViewportSize:new UniformVec2(vec2.clone(this.parent.src.size)),ssaoOnly:new UniformInt(!0===this.ssaoOnly?1:0),gdisplace:new UniformFloat(t.options.ssaoGDisplace?t.options.ssaoGDisplace:.3),radius:new UniformFloat(t.options.ssaoRadius?t.options.ssaoRadius:2),luminanceInfluence:new UniformFloat(t.options.ssaoLuminanceInfluence?t.options.ssaoLuminanceInfluence:.7),brightness:new UniformFloat(t.options.ssaoBrightness?t.options.ssaoBrightness:1)},[this.parent.generator.depthStage.sampler]),this.material.name="SSAO","sorted"==t.options.transparencyMode?this.material.samplers.push(new Sampler("oitWeight",t.WhiteTexture)):this.material.samplers.push(this.parent.generator.oitStage.transparencyWeightSampler),t.assetsManager.load()},onPreRender:function(e,t,i){this._super(e,t,i),vec2.set(this.material.uniforms.ViewportSize.value,this.parent.src.size[0],this.parent.src.size[1]),this.material.uniforms.ssaoOnly.value=!0===this.ssaoOnly?1:0}}),RenderTarget=FrakClass.extend({init:function(e){this.viewport={position:vec2.create(),size:vec2.create()},this.size=vec2.create(),e&&(vec2.copy(this.size,e),vec2.copy(this.viewport.size,e))},type:function(){return"RenderTarget"},bind:function(e){e.gl.viewport(this.viewport.position[0],this.viewport.position[1],this.viewport.size[0],this.viewport.size[1]),e.gl.scissor(this.viewport.position[0],this.viewport.position[1],this.viewport.size[0],this.viewport.size[1]),e.gl.enable(e.gl.SCISSOR_TEST)},unbind:function(e){e.gl.disable(e.gl.SCISSOR_TEST)},setSize:function(e,t){this.size[0]=e,this.size[1]=t},getSize:function(){return this.size},setViewport:function(e,t,i,n){vec2.set(this.viewport.position,e,t),vec2.set(this.viewport.size,i,n)},inheritViewport:function(e){vec2.copy(this.viewport.position,e.viewport.position),vec2.copy(this.viewport.size,e.viewport.size)},resetViewport:function(){this.setViewport(0,0,this.size[0],this.size[1])}}),TargetScreen=RenderTarget.extend({init:function(e){this._super(e),this.position=vec2.create()},type:function(){return"TargetScreen"},setPosition:function(e,t){this.position[0]=e,this.position[1]=t},getPosition:function(){return this.position},resetViewport:function(){this.setViewport(this.position[0],this.position[1],this.size[0],this.size[1])}}),TargetTexture=RenderTarget.extend({init:function(e,t,i,n){var r=e;if(e instanceof Texture&&(r=e.size,this.texture=e),this.useDepthTexture=!0===i,this.useStencilBuffer=!0===n,this.rebuild=!1,this._super(r),this.useDepthTexture&&!(t.gl.getExtension("WEBGL_depth_texture")||t.gl.getExtension("WEBKIT_WEBGL_depth_texture")))throw"TargetTexture: Depth texture reqeusted, but not available.";this.build(t)},type:function(){return"TargetTexture"},setSize:function(e,t){this._super(e,t),this.rebuild=!0},getDataType:function(e){return e.gl.UNSIGNED_BYTE},getTextureFilter:function(e){return e.gl.NEAREST},build:function(e){var t=e.gl;this.frameBuffer=t.createFramebuffer(),this.texture||(this.texture=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.texture.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.size[0],this.size[1],0,t.RGBA,this.getDataType(e),null),t.bindTexture(t.TEXTURE_2D,null)),this.useDepthTexture?(this.depth=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.depth.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT,this.size[0],this.size[1],0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null),t.bindTexture(t.TEXTURE_2D,null)):(this.depth=t.createRenderbuffer(),this.useStencilBuffer?(t.bindRenderbuffer(t.RENDERBUFFER,this.depth),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,this.size[0],this.size[1]),t.bindRenderbuffer(t.RENDERBUFFER,null)):(t.bindRenderbuffer(t.RENDERBUFFER,this.depth),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.size[0],this.size[1]),t.bindRenderbuffer(t.RENDERBUFFER,null))),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture.glTexture,0),this.useDepthTexture?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depth.glTexture,0):this.useStencilBuffer?t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,this.depth):t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depth),this.checkStatus(e),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture.loaded=!0},checkStatus:function(e){var t=e.gl,i=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(i){case t.FRAMEBUFFER_COMPLETE:return!0;case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+i}},bind:function(e,t,i,n){var r=e.gl;if(this.rebuild&&(r.bindTexture(r.TEXTURE_2D,this.texture.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.size[0],this.size[1],0,r.RGBA,this.getDataType(e),null),r.bindTexture(r.TEXTURE_2D,null),this.useDepthTexture?(r.bindTexture(r.TEXTURE_2D,this.depth.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texImage2D(r.TEXTURE_2D,0,r.DEPTH_COMPONENT,this.size[0],this.size[1],0,r.DEPTH_COMPONENT,r.UNSIGNED_SHORT,null),r.bindTexture(r.TEXTURE_2D,null)):(r.bindRenderbuffer(r.RENDERBUFFER,this.depth),this.useStencilBuffer?r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,this.size[0],this.size[1]):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.size[0],this.size[1]),r.bindRenderbuffer(r.RENDERBUFFER,null)),this.rebuild=!1),t=!0===t,(i=i instanceof Color&&i)||(e.camera?i=e.camera.backgroundColor:t=!0),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),this._super(e),!t){r.clearColor(i.r,i.g,i.b,i.a),r.clearDepth(1);var s=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;this.useStencilBuffer&&(r.clearStencil(0),s|=r.STENCIL_BUFFER_BIT),n&&(s=n),r.clear(s)}},unbind:function(e){this._super(e),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)}}),TargetTextureFloat=TargetTexture.extend({init:function(e,t,i,n){if(this.extHalfFloat=t.gl.getExtension("OES_texture_half_float"),this.extFloat=t.gl.getExtension("OES_texture_float"),!this.extFloat&&!this.extHalfFloat)throw"TargetTextureFloat: Floating point textures are not supported on this system.";this.linearFloat=null,this.linearHalf=null,n||(this.linearFloat=t.gl.getExtension("OES_texture_float_linear"),this.linearHalf=t.gl.getExtension("OES_texture_half_float_linear")),this._super(e,t,i)},type:function(){return"TargetTextureFloat"},getDataType:function(e){if(this.extHalfFloat){if(!this.extFloat)return this.extHalfFloat.HALF_FLOAT_OES;if(navigator)switch(navigator.platform){case"iPad":case"iPod":case"iPhone":return this.extHalfFloat.HALF_FLOAT_OES}}return e.gl.FLOAT},getTextureFilter:function(e){return this.linearFloat&&this.linearHalf?e.gl.LINEAR:e.gl.NEAREST},build:function(e){var t=e.gl;this.frameBuffer=t.createFramebuffer(),this.texture||(this.texture=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.texture.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.size[0],this.size[1],0,t.RGBA,this.getDataType(e),null),t.bindTexture(t.TEXTURE_2D,null)),this.useDepthTexture?(this.depth=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.depth.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT,this.size[0],this.size[1],0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null),t.bindTexture(t.TEXTURE_2D,null)):(this.depth=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.depth),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.size[0],this.size[1]),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture.glTexture,0),this.useDepthTexture?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depth.glTexture,0):t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depth),this.checkStatus(e),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture.loaded=!0}}),TargetTextureMulti=RenderTarget.extend({init:function(e,t,i){if(this.options=FRAK.extend({dataType:"float",filtering:"linear",depth:!1,stencil:!1,numTargets:2},i),this.extDrawBuffers=null,this.extTextureFloat=null,this.extTextureHalfFloat=null,this.extTextureFloatLinear=null,this.extTextureHalfFloatLinear=null,this.options.numTargets<1)throw"TargetTextureMulti: Must have at least one color target.";if(this.extDrawBuffers=e.gl.getExtension("WEBGL_draw_buffers"),!this.extDrawBuffers)throw"TargetTextureMulti: WEBGL_draw_buffers not available.";if(this.options.depth){var n=e.gl.getExtension("WEBGL_depth_texture");if(n||(n=e.gl.getExtension("WEBKIT_WEBGL_depth_texture")),!n)throw"TargetTextureMulti: Depth texture reqeusted, but not available."}if(this.maxColorAttachments=e.gl.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_WEBGL),this.maxDrawBuffers=e.gl.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_WEBGL),this.options.numTargets>this.maxDrawBuffers)throw"TargetTextureMulti: Too many targets requested. System only supports {0} draw buffers.".format(this.maxDrawBuffers);if("float"==this.options.dataType){if(this.extTextureFloat=e.gl.getExtension("OES_texture_float"),this.extTextureHalfFloat=e.gl.getExtension("OES_texture_half_float"),!this.extTextureFloat&&!this.extTextureHalfFloat)throw"TargetTextureMulti: Floating point textures are not supported on this system.";if("linear"==this.options.filtering&&(this.extTextureFloatLinear=e.gl.getExtension("OES_texture_float_linear"),this.extTextureHalfFloatLinear=e.gl.getExtension("OES_texture_half_float_linear"),!this.extTextureFloatLinear&&!this.extTextureHalfFloatLinear))throw"TargetTextureMulti: Linear filtering requested, but not available."}this._super(t),this.targets=[],this.depth=null,this.frameBuffer=null,this.build(e)},type:function(){return"TargetTextureMulti"},setSize:function(e,t){this._super(e,t),this.rebuild=!0},getDataType:function(e){if("unsigned"==this.options.dataType)return e.gl.UNSIGNED_BYTE;if(this.extTextureHalfFloat){if(!this.extTextureFloat)return this.extTextureHalfFloat.HALF_FLOAT_OES;if(navigator&&navigator.platform)switch(navigator.platform){case"iPad":case"iPod":case"iPhone":return this.extTextureHalfFloat.HALF_FLOAT_OES;default:return e.gl.FLOAT}}return e.gl.FLOAT},getTextureFilter:function(e){return"float"==this.options.dataType&&(this.extTextureFloatLinear||this.extTextureHalfFloatLinear)?e.gl.LINEAR:e.gl.NEAREST},createBuffer:function(e,t,i,n){var r=e.gl,s=new Texture(e);return t||(t=this.getTextureFilter(e)),i||(i=this.getDataType(e)),n||(n=r.RGBA),r.bindTexture(r.TEXTURE_2D,s.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,t),r.texImage2D(r.TEXTURE_2D,0,n,this.size[0],this.size[1],0,n,i,null),r.bindTexture(r.TEXTURE_2D,null),s.loaded=!0,s},build:function(e){var t=e.gl;this.frameBuffer=t.createFramebuffer(),this.options.depth?this.depth=this.createBuffer(e,t.NEAREST,t.UNSIGNED_SHORT,t.DEPTH_COMPONENT):(this.depth=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.depth),this.options.stencil?t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,this.size[0],this.size[1]):t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.size[0],this.size[1]),t.bindRenderbuffer(t.RENDERBUFFER,null));for(var i=[],n=0;n<this.options.numTargets;n++){var r=this.createBuffer(e);this.targets.push(r),i.push(this.extDrawBuffers.COLOR_ATTACHMENT0_WEBGL+n)}t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),this.options.depth?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depth.glTexture,0):this.options.stencil?t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,this.depth):t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depth);for(n=0;n<this.targets.length;n++)t.framebufferTexture2D(t.FRAMEBUFFER,this.extDrawBuffers.COLOR_ATTACHMENT0_WEBGL+n,t.TEXTURE_2D,this.targets[n].glTexture,0);this.checkStatus(e),this.extDrawBuffers.drawBuffersWEBGL(i),t.bindFramebuffer(t.FRAMEBUFFER,null)},checkStatus:function(e){var t=e.gl,i=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(i){case t.FRAMEBUFFER_COMPLETE:return!0;case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+i}},bind:function(e,t,i,n){var r=e.gl;if(this.rebuild){this.rebuild=!1;for(var s=0;s<this.targets.length;s++){var a=this.targets[s];r.bindTexture(r.TEXTURE_2D,a.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.size[0],this.size[1],0,r.RGBA,this.getDataType(e),null),r.bindTexture(r.TEXTURE_2D,null)}this.options.depth?(r.bindTexture(r.TEXTURE_2D,this.depth.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texImage2D(r.TEXTURE_2D,0,r.DEPTH_COMPONENT,this.size[0],this.size[1],0,r.DEPTH_COMPONENT,r.UNSIGNED_SHORT,null),r.bindTexture(r.TEXTURE_2D,null)):(r.bindRenderbuffer(r.RENDERBUFFER,this.depth),this.options.stencil?r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,this.size[0],this.size[1]):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.size[0],this.size[1]),r.bindRenderbuffer(r.RENDERBUFFER,null))}if(t=!0===t,(i=i instanceof Color&&i)||(e.camera?i=e.camera.backgroundColor:t=!0),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),this._super(e),!t){r.clearColor(i.r,i.g,i.b,i.a),r.clearDepth(1);var o=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;this.options.stencil&&(r.clearStencil(0),o|=r.STENCIL_BUFFER_BIT),n&&(o=n),r.clear(o)}},unbind:function(e){this._super(e),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)}}),RenderBuffer=FrakClass.extend({init:function(e,t,i){i||(i=e.gl.STATIC_DRAW),this.type=i,this.context=e,this.debug=!1,this.buffers={},this.maxFaceIndex=0;for(var n=0;n<t.length;n++)this.maxFaceIndex=t[n]>this.maxFaceIndex?t[n]:this.maxFaceIndex;this.createFacesBuffer(t)},has:function(e){return e in this.buffers},add:function(e,t,i){if(t.length/i<=this.maxFaceIndex)throw"RenderBuffer: Buffer '{0}' too small ({1} vertices, {2} max index).".format(e,t.length/i,this.maxFaceIndex);var n=this.context.gl;t instanceof Float32Array||(t=new Float32Array(t)),this.buffers[e]=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.buffers[e]),n.bufferData(n.ARRAY_BUFFER,t,this.type),this.buffers[e].itemSize=i,this.buffers[e].numItems=t.length/this.buffers[e].itemSize,n.bindBuffer(n.ARRAY_BUFFER,null)},update:function(e,t){if(!(e in this.buffers))throw"RenderBuffer: Unknown buffer: '{0}'".format(e);var i=this.buffers[e];if(t.length/i.itemSize<=this.maxFaceIndex)throw"RenderBuffer: Buffer '{0}' too small.".format(e);t instanceof Float32Array||(t=new Float32Array(t));var n=this.context.gl;n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,t,this.type),i.numItems=t.length/i.itemSize,n.bindBuffer(n.ARRAY_BUFFER,null)},updateFaces:function(e){var t=this.context.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.facesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.type),this.facesBuffer.itemSize=1,this.facesBuffer.numItems=e.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.maxFaceIndex=0;for(var i=0;i<e.length;i++)this.maxFaceIndex=e[i]>this.maxFaceIndex?e[i]:this.maxFaceIndex},render:function(e){if(e.linked){var t=this.context.gl,i=[];for(var n in this.buffers){t.bindBuffer(t.ARRAY_BUFFER,this.buffers[n]);var r=e.getAttribLocation(n);-1!=r&&(t.enableVertexAttribArray(r),i.push(r),t.vertexAttribPointer(r,this.buffers[n].itemSize,t.FLOAT,!1,0,0))}this.drawElements();for(var s=0,a=i.length;s<a;s++)t.disableVertexAttribArray(i[s])}},generateBarycentric:function(){for(var e=new Float32Array(3*this.buffers.position.numItems),t=0;t<e.length;t+=9)e[t+0]=1,e[t+1]=0,e[t+2]=0,e[t+3]=0,e[t+4]=1,e[t+5]=0,e[t+6]=0,e[t+7]=0,e[t+8]=1;this.add("barycentric",e,3)},generateTexCoords:function(){for(var e=new Float32Array(2*this.buffers.position.numItems),t=0;t<e.length;t++)e[t]=0;this.add("texcoord2d0",e,2)},drawElements:function(){},createFacesBuffer:function(e){var t=this.context.gl;this.facesBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.facesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.type),this.facesBuffer.itemSize=1,this.facesBuffer.numItems=e.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}}),LinesRenderBuffer=RenderBuffer.extend({init:function(e){this._super(e,[],e.gl.DYNAMIC_DRAW)},drawElements:function(){var e=this.context.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.facesBuffer),e.drawElements(e.LINES,this.facesBuffer.numItems,e.UNSIGNED_SHORT,0)}}),TrianglesRenderBuffer=RenderBuffer.extend({init:function(e,t,i){this._super(e,t,i)},drawElements:function(){var e=this.context.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.facesBuffer),e.drawElements(e.TRIANGLES,this.facesBuffer.numItems,e.UNSIGNED_SHORT,0)}}),RenderBufferVAO=RenderBuffer.extend({init:function(e,t,i){if(this.extVAO=e.gl.getExtension("OES_vertex_array_object"),!this.extVAO)throw"RenderBufferVAO: Vertex array objects not supported on this device.";if(this.vao=this.extVAO.createVertexArrayOES(),!this.vao)throw"RenderBufferVAO: Unable to create vertex array object.";this.damaged=!0,this._super(e,t,i)},add:function(e,t,i){if(t.length/i<=this.maxFaceIndex)throw"RenderBuffer: Buffer '{0}' too small.".format(e);this.extVAO.bindVertexArrayOES(this.vao),this._super(e,t,i),this.extVAO.bindVertexArrayOES(null),this.damaged=!0},createFacesBuffer:function(e){this.extVAO.bindVertexArrayOES(this.vao),this._super(e),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.facesBuffer),this.extVAO.bindVertexArrayOES(null),this.damaged=!0},bindLocations:function(e){var t=this.context.gl;this.extVAO.bindVertexArrayOES(this.vao);var i;for(var n in this.buffers)i=-1,n in ExplicitAttributeLocations?i=ExplicitAttributeLocations[n]:e&&(i=e.getAttribLocation(n)),-1!=i&&(t.bindBuffer(t.ARRAY_BUFFER,this.buffers[n]),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,this.buffers[n].itemSize,t.FLOAT,!1,0,0));t.bindBuffer(t.ARRAY_BUFFER,null),this.extVAO.bindVertexArrayOES(null),this.damaged=!1},render:function(e){e.linked&&(this.damaged&&this.bindLocations(),this.extVAO.bindVertexArrayOES(this.vao),this.drawElements(),this.extVAO.bindVertexArrayOES(null))}}),TrianglesRenderBufferVAO=RenderBufferVAO.extend({init:function(e,t,i){this._super(e,t,i)},drawElements:function(){var e=this.context.gl;e.drawElements(e.TRIANGLES,this.facesBuffer.numItems,e.UNSIGNED_SHORT,0)}}),QuadsRenderBuffer=TrianglesRenderBuffer.extend({init:function(e,t,i){for(var n=[],r=0;r<t.length-3;r++)n.push(t[r]),n.push(t[r+1]),n.push(t[r+2]),n.push(t[r]),n.push(t[r+2]),n.push(t[r+3]);this._super(e,n,i)}}),BaseTexture=Serializable.extend({init:function(e){this._super(),this.size=vec2.create(),this.loaded=!1},type:function(){return"BaseTexture"},excluded:function(){return this._super().concat(["loaded","size"])},bind:function(e){},unbind:function(e){},resizeToPowerOfTwo:function(e){function t(e){return 0==(e&e-1)}function i(e){return Math.max(Math.min(Math.pow(2,Math.floor(Math.log(e)/Math.log(2))),2048),1)}if(!t(e.width)||!t(e.height)){var n=document.createElement("canvas");n.width=i(e.width),n.height=i(e.height),n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),e=n}return e},anisotropy:function(e){if(e.engine&&(e.engine.options.anisotropicFiltering?this.anisotropyFilter=e.engine.options.anisotropicFiltering:this.anisotropic=!1),this.anisotropic)if(this.extTextureFilterAnisotropic=e.gl.getExtension("EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic){var t=e.gl.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.anisotropyFilter=Math.min(this.anisotropyFilter,t)}else this.anisotropic=!1}}),Texture=BaseTexture.extend({init:function(e){this._super(e),this.glTexture=null,this.name=!1,this.mipmapped=!0,this.clampToEdge=!1,this.anisotropic=!0,this.anisotropyFilter=4,this.image=null,e&&this.create(e)},type:function(){return"Texture"},excluded:function(){return this._super().concat(["glTexture"])},bind:function(e){this.loaded?e.gl.bindTexture(e.gl.TEXTURE_2D,this.glTexture):e.gl.bindTexture(e.gl.TEXTURE_2D,null)},unbind:function(e){e.gl.bindTexture(e.gl.TEXTURE_2D,null)},create:function(e){this.anisotropy(e),this.glTexture=e.gl.createTexture()},clearImage:function(e,t,i){null===this.glTexture&&this.create(e),i=i||1;var n=e.gl;n.bindTexture(e.gl.TEXTURE_2D,this.glTexture);for(var r=new Uint8Array(i*i*4),s=0;s<i*i*4;s+=4)r[s+0]=t[0],r[s+1]=t[1],r[s+2]=t[2],r[s+3]=t[3];n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,i,0,n.RGBA,n.UNSIGNED_BYTE,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.bindTexture(e.gl.TEXTURE_2D,null),vec2.set(this.size,i,i),this.loaded=!0},pasteImage:function(e,t,i){if(this.loaded){this.bind(e);var n=e.gl;n.texSubImage2D(n.TEXTURE_2D,0,t[0]*this.size[0],t[1]*this.size[1],n.RGBA,n.UNSIGNED_BYTE,i),this.mipmapped&&n.generateMipmap(n.TEXTURE_2D),this.unbind(e),this.loaded=!0}},setImage:function(e,t,i){if(this.glTexture||this.create(e),!this.glTexture)throw"Unable to update texture. glTexture not available.";var n=t;i||(n=this.resizeToPowerOfTwo(t)),vec2.set(this.size,n.width,n.height);var r=e.gl;r.bindTexture(r.TEXTURE_2D,this.glTexture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,n),this.clampToEdge&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE)),this.mipmapped?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_NEAREST),r.generateMipmap(r.TEXTURE_2D),this.anisotropic&&r.texParameteri(r.TEXTURE_2D,this.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropyFilter)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST)),r.bindTexture(r.TEXTURE_2D,null),this.image=n,this.loaded=!0,0==(this.size[0]&this.size[0]-1)&&0==(this.size[1]&this.size[1]-1)||console.warn("Created a not power of 2 texture: {0} ({1}x{2})".format(this.name,this.size[0],this.size[1]))},getImage:function(e){if(!this.glTexture)throw"Unable to get image. glTexture not available.";var t=e.gl,i=new TargetTexture(this,e,!1);i.bind(e);var n=new Uint8Array(this.size[0]*this.size[1]*4);return e.gl.readPixels(0,0,this.size[0],this.size[1],t.RGBA,t.UNSIGNED_BYTE,n),i.unbind(e),n},onContextRestored:function(e){this.glTexture=null,this.loaded=!1,this.image&&this.setImage(e,this.image)}}),CubeTexture=BaseTexture.extend({init:function(e){this._super(e),this.glTexture=null,this.name=!1,this.mipmapped=!1,this.clampToEdge=!0,this.anisotropic=!0,this.anisotropyFilter=4,this.images={},e&&this.create(e)},type:function(){return"CubeTexture"},excluded:function(){return this._super().concat(["glTexture"])},bind:function(e){this.loaded?e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,this.glTexture):e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,null)},unbind:function(e){e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,null)},getGLCubeFace:function(e,t){var i=e.gl;switch(t){case CubeTexture.FRONT:return i.TEXTURE_CUBE_MAP_NEGATIVE_X;case CubeTexture.BACK:return i.TEXTURE_CUBE_MAP_POSITIVE_X;case CubeTexture.LEFT:return i.TEXTURE_CUBE_MAP_NEGATIVE_Z;case CubeTexture.RIGHT:return i.TEXTURE_CUBE_MAP_POSITIVE_Z;case CubeTexture.TOP:return i.TEXTURE_CUBE_MAP_NEGATIVE_Y;case CubeTexture.BOTTOM:return i.TEXTURE_CUBE_MAP_POSITIVE_Y}return null},create:function(e){this.anisotropy(e),this.glTexture=e.gl.createTexture();var t=e.gl;t.bindTexture(t.TEXTURE_CUBE_MAP,this.glTexture),this.clampToEdge&&(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),this.mipmapped?(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_CUBE_MAP),this.anisotropic&&t.texParameteri(t.TEXTURE_CUBE_MAP,this.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropyFilter)):(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.NEAREST)),t.bindTexture(t.TEXTURE_CUBE_MAP,null)},setFace:function(e,t,i,n){if(!1===this.glTexture&&this.create(e),!this.glTexture)throw"Unable to update cube texture. glTexture not available.";var r=i;if(t in this.images&&delete this.images[t].image,this.images[t]={image:r,noResize:!!n},!(t=this.getGLCubeFace(e,t)))throw"Not a valid CubeTexture face.";n||(r=this.resizeToPowerOfTwo(i)),vec2.set(this.size,r.width,r.height);var s=e.gl;s.bindTexture(s.TEXTURE_CUBE_MAP,this.glTexture),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.texImage2D(t,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,r),s.bindTexture(s.TEXTURE_CUBE_MAP,null),this.loaded=!0,0==(this.size[0]&this.size[0]-1)&&0==(this.size[1]&this.size[1]-1)||console.warn("Created a not power of 2 texture: {0} ({1}x{2})".format(this.name,this.size[0],this.size[1]))},onContextRestored:function(e){this.glTexture=null,this.create(e),this.loaded=!1;for(var t in this.images){var i=this.images[t];this.setFace(e,parseInt(t),i.image,i.noResize)}}});CubeTexture.FRONT=0,CubeTexture.BACK=1,CubeTexture.LEFT=2,CubeTexture.RIGHT=3,CubeTexture.BOTTOM=4,CubeTexture.TOP=5;var Material=Serializable.extend({init:function(e,t,i,n){this._super(),this.name="Unnamed",this.shader=e,this.uniforms=t,this.samplers=i,this.descriptor=n,this.boundSamplers=new SamplerAccumulator},type:function(){return"Material"},bind:function(e){if(this.shader){this.shader.use(this.uniforms),e&&this.shader.bindUniforms(e);for(n=1;n<arguments.length;++n){var t=arguments[n];if(t instanceof Sampler)this.boundSamplers.add(t);else if(t instanceof Array)for(var i=0;i<t.length;++i)this.boundSamplers.add(t[i])}for(var n=0;n<this.samplers.length;++n)this.boundSamplers.add(this.samplers[n]);0==this.boundSamplers.length&&this.shader.context.engine&&this.boundSamplers.add(this.shader.context.engine.DiffuseFallbackSampler),this.shader.bindSamplers(this.boundSamplers.samplers)}},unbind:function(){this.shader&&(this.shader.unbindSamplers(this.boundSamplers.samplers),this.boundSamplers.clear())},instantiate:function(){var e={};for(var t in this.uniforms)e[t]=this.uniforms[t].clone();var i=[];for(var t in this.samplers)"object"==typeof this.samplers[t]&&i.push(this.samplers[t].clone());var n=new Material(this.shader,e,i,this.descriptor);return n.name=this.name+" (instance)",n}}),Space=FrakClass.extend({init:function(){},frustumCast:function(e,t){},rayCast:function(e){},lineCast:function(e){}}),DynamicSpace=Space.extend({init:function(){this.renderers=[],this.colliders=[],this.filteredRenderers=[]},addRenderer:function(e){this.renderers.push(e),this.filteredRenderers.push(null)},removeRenderer:function(e){for(var t=0;t<this.renderers.length;t++)if(this.renderers[t]===e)return this.renderers.splice(t,1),this.filteredRenderers.pop(),!0;return!1},addCollider:function(e){this.colliders.push(e)},removeCollider:function(e){for(var t=0;t<this.colliders.length;t++)if(this.colliders[t]===e)return this.colliders.splice(t,1),!0;return!1},frustumCast:function(e,t){for(var i,n=0,r=0;r<this.renderers.length;++r)(i=this.renderers[r]).visible&&i.layer&t&&(this.filteredRenderers[n++]=i);for(r=n;r<this.filteredRenderers.length;++r)this.filteredRenderers[r]=null;return this.filteredRenderers},rayCast:function(e,t,i){var n=new RayTestResult(e);if(!t)return n;for(var r=0;r<this.colliders.length;r++)this.colliders[r].enabled&&this.colliders[r].node.layer&t&&this.colliders[r].rayTest(e,n,i);return n}}),Renderer=FrakClass.extend({init:function(e){this.matrix=e,this.layer=1,this.visible=!0,this.castShadows=!0,this.receiveShadows=!0,this.lightContribution=1,this.transparent=!1,this.localBoundingBox=new BoundingBox,this.localBoundingSphere=new BoundingSphere,this.globalBoundingBox=new BoundingBox,this.globalBoundingSphere=new BoundingSphere,this.cacheMatrix=mat4.create()},render:function(e,t){this.onRender(e,t)},renderGeometry:function(e,t){this.onRenderGeometry(e,t)},getDefaultUniforms:function(e,t){return t||(t={}),"model"in t?mat4.copy(t.model.value,this.matrix):t.model=new UniformMat4(this.matrix),"modelview"in t?mat4.copy(t.modelview.value,e.modelview.top()):t.modelview=new UniformMat4(e.modelview.top()),"projection"in t?mat4.copy(t.projection.value,e.projection.top()):t.projection=new UniformMat4(e.projection.top()),"receiveShadows"in t?t.receiveShadows.value=this.receiveShadows?1:0:t.receiveShadows=new UniformInt(this.receiveShadows?1:0),"lightContribution"in t?t.lightContribution.value=this.lightContribution:t.lightContribution=new UniformFloat(this.lightContribution),e.camera&&("view"in t?mat4.copy(t.view.value,e.camera.viewMatrix):t.view=new UniformMat4(e.camera.viewMatrix),"viewInverse"in t?mat4.copy(t.viewInverse.value,e.camera.viewInverseMatrix):t.viewInverse=new UniformMat4(e.camera.viewInverseMatrix),e.camera.near&&("zNear"in t?t.zNear.value=e.camera.near:t.zNear=new UniformFloat(e.camera.near)),e.camera.far&&("zFar"in t?t.zFar.value=e.camera.far:t.zFar=new UniformFloat(e.camera.far))),e.light&&e.light.uniforms&&(t.lightDirection=e.light.uniforms.lightDirection,t.lightColor=e.light.uniforms.lightColor,t.lightIntensity=e.light.uniforms.lightIntensity,t.useShadows=e.light.uniforms.useShadows),e.shadow&&(t.lightView=e.shadow.lightView,t.lightProjection=e.shadow.lightProjection),t},getGlobalSamplers:function(e){var t=[];return e.shadow&&t.push(e.shadow.shadow0),t},setMatrix:function(e){this.matrix=e,this.updateGlobalBoundingVolumes()},updateGlobalBoundingVolumes:function(){this.localBoundingBox.transform(this.matrix,this.globalBoundingBox),this.localBoundingSphere.transform(this.matrix,this.globalBoundingSphere)},onRender:function(e,t){},onRenderGeometry:function(e,t){}}),PrimitiveRenderer=Renderer.extend({init:function(e,t){this._super(e),this.material=t}}),MeshRenderer=Renderer.extend({init:function(e,t,i){this._super(t),this.mesh=i,this.buffers=[],this._cache=null;for(var n in this.mesh.submeshes){var r=this.mesh.submeshes[n],s=new TrianglesRenderBuffer(e,r.faces);s.add("position",r.positions,3);for(var a in r.texCoords1D)s.add("texcoord1d"+a,r.texCoords1D[a],1);for(var o in r.texCoords2D)s.add("texcoord2d"+o,r.texCoords2D[o],2);for(var h in r.texCoords3D)s.add("texcoord3d"+h,r.texCoords3D[h],3);r.normals&&s.add("normal",r.normals,3),r.tangents&&s.add("tangent",r.tangents,3),r.bitangents&&s.add("bitangent",r.bitangents,3),this.buffers.push(s)}},onRender:function(e){this._cache=this.getDefaultUniforms(e,this._cache);for(var t in this.mesh.submeshes){var i=this.mesh.submeshes[t],n=this.mesh.getMaterial(i.materialIndex);n&&(n.bind(this._cache),this.buffers[t].render(n.shader),n.unbind())}},onRenderGeometry:function(e,t){this._cache=this.getDefaultUniforms(e,this._cache),t.bindUniforms(this._cache);for(var i in this.buffers)this.buffers[i].render(t)}}),LineRenderer=Renderer.extend({init:function(e,t,i){this._super(t),this.material=i,this.buffer=new LinesRenderBuffer(e)},onRender:function(e){this.buffer.render(this.material.shader)},onRenderGeometry:function(e,t){this._cache=this.getDefaultUniforms(e,this._cache),t.bindUniforms(this._cache),this.buffer.render(t)}}),SubmeshRenderer=Renderer.extend({init:function(e,t,i,n){this._super(t),this.submesh=i,this.material=n,this.buffer=[],this.failed=!1,this.transparent=!1,this.localBoundingBox=this.submesh.boundingBox,this.localBoundingSphere=this.submesh.boundingSphere,this.updateGlobalBoundingVolumes(),this.build(e),this._cache=null},allocBuffer:function(e){if(!this.submesh)throw Error("SubmeshRenderer.allocBuffer: No submesh set");if(e.engine&&!0===e.engine.options.useVAO)try{this.buffer=new TrianglesRenderBufferVAO(e,this.submesh.faces)}catch(t){this.buffer=new TrianglesRenderBuffer(e,this.submesh.faces)}else this.buffer=new TrianglesRenderBuffer(e,this.submesh.faces)},build:function(e){this.buffer&&delete this.buffer,this.allocBuffer(e);var t=this.submesh;this.buffer.add("position",t.positions,3);var i=t.positions.length/3;if(t.texCoords1D)for(n=0;n<t.texCoords1D.length;n++)t.texCoords1D[n].length==i?this.buffer.add("texcoord1d"+n,t.texCoords1D[n],1):console.warn("Wrong number of 1D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords1D[n].length,i));if(t.texCoords2D)for(n=0;n<t.texCoords2D.length;n++)t.texCoords2D[n].length/2==i?this.buffer.add("texcoord2d"+n,t.texCoords2D[n],2):console.warn("Wrong number of 2D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords2D[n].length/2,i));if(t.texCoords3D)for(n=0;n<t.texCoords3D.length;n++)t.texCoords3D[n].length/3==i?this.buffer.add("texcoord3d"+n,t.texCoords3D[n],3):console.warn("Wrong number of 3D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords3D[n].length/3,i));if(t.texCoords4D)for(var n=0;n<t.texCoords4D.length;n++)t.texCoords4D[n].length/4==i?this.buffer.add("texcoord3d"+n,t.texCoords4D[n],4):console.warn("Wrong number of 4D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords4D[n].length/4,i));t.normals&&(t.positions.length!=t.normals.length?console.warn("Wrong number of normals. Must be the same as positions."):this.buffer.add("normal",t.normals,3)),t.tangents&&(t.positions.length!=t.tangents.length?console.warn("Wrong number of tangents. Must be the same as positions."):this.buffer.add("tangent",t.tangents,3)),t.bitangents&&(t.positions.length!=t.bitangents.length?console.warn("Wrong number of bitangents. Must be the same as positions."):this.buffer.add("bitangent",t.bitangents,3)),t.barycentric&&(t.positions.length!=t.barycentric.length?console.warn("Wrong number of barycentric coordinates. Must be the same as positions."):this.buffer.add("barycentric",t.barycentric,3));var r=this.material;r.uniforms.diffuse||(r.uniforms.diffuse=new UniformColor(new Color(1,1,1,1))),r.uniforms.ambient||(r.uniforms.ambient=new UniformColor(new Color(.2,.2,.2,1))),r.uniforms.specularStrength||(r.uniforms.specularStrength=new UniformFloat(0)),r.uniforms.specularPower||(r.uniforms.specularPower=new UniformInt(8)),this.transparent=r.shader.requirements.transparent||r.uniforms.diffuse&&r.uniforms.diffuse.value[3]<1||r.uniforms.ambient&&r.uniforms.ambient.value[3]<1,this.failed=!1},onRender:function(e){this.buffer.render(this.material.shader)},onRenderGeometry:function(e,t){this._cache=this.getDefaultUniforms(e,this._cache),t.bindUniforms(this._cache),this.buffer.render(t)},onContextRestored:function(e){this.build(e)}}),CubeRenderer=PrimitiveRenderer.extend({init:function(e,t,i,n){this._super(t,n),this.size=i;var r=this.size/2,s=[-r,-r,r,r,-r,r,r,-r,-r,-r,-r,-r,-r,r,r,r,r,r,r,r,-r,-r,r,-r],a=[0,1,2,3,4,5,6,7,0,1,5,4,1,2,6,5,2,3,7,6,3,0,0,7];this.renderBuffer=new QuadsRenderBuffer(e,a),this.renderBuffer.add("position",s,3)},onRender:function(e){this.material.bind({modelview:new UniformMat4(e.modelview.top()),projection:new UniformMat4(e.projection.top())}),this.renderBuffer.render(this.material.shader),this.material.unbind()}}),DataParserTypes={NODE_ROOT:4096,NODE_STRING:4097,NODE_MATRIX3X3:4098,NODE_MATRIX4X4:4099,NODE_MATERIALS:8192,NODE_MATERIAL:8193,NODE_COLOR_AMBIENT:8194,NODE_COLOR_DIFFUSE:8195,NODE_COLOR_SPECULAR:8196,NODE_COLOR_EMISSIVE:8197,NODE_TWOSIDED:8198,NODE_SHININESS:8199,NODE_SHININESS_STRENGTH:8200,NODE_TEXTURES_AMBIENT:8272,NODE_TEXTURES_DIFFUSE:8273,NODE_TEXTURES_SPECULAR:8274,NODE_TEXTURES_EMISSIVE:8275,NODE_TEXTURES_NORMALS:8276,NODE_TEXTURES_HEIGHT:8277,NODE_TEXTURES_SHININESS:8278,NODE_TEXTURES_OPACITY:8279,NODE_TEXTURES_DISPLACEMENT:8280,NODE_TEXTURES_LIGHTMAP:8281,NODE_TEXTURES_REFLECTION:8282,NODE_TEXTURE:8448,NODE_TEXTURE_SCALE:8449,NODE_SHADER_NAME:8704,NODE_GEOMETRY:12288,NODE_MESH:12544,NODE_MATERIAL_REFERENCE:12545,NODE_VERTICES:12546,NODE_NORMALS:12547,NODE_TANGENTS:12548,NODE_BITANGENTS:12549,NODE_TEXTURE_COORDINATES:12550,NODE_FACES:12551,NODE_SCENE:16384,NODE_GROUP:16385,NODE_MESH_REFERENCE:16386,NODE_TRANSFORM_POSITION:16387,NODE_TRANSFORM_ROTATION:16388,NODE_TRANSFORM_SCALE:16389,NODE_GROUP_ID:16390,NODE_COLLISION:20480,NODE_COLLISION_NODE:20481,NODE_COLLISION_AABB_CENTER:20482,NODE_COLLISION_AABB_EXTENTS:20483,NODE_COLLISION_FACE_LIST:20484,NODE_FACE_LIST_NODE_ID:20496,NODE_FACE_LIST_MESH_REFERENCE:20497,NODE_FACE_LIST_INDICES:20498,getName:function(e){for(var t in DataParserTypes)if(DataParserTypes[t]===e)return t;return!1}},DataParserNode=function(e,t,i){this.id=e,this.length=t,this.position=i,this.HEADER_LENGTH=8,this.end=function(){return this.position+this.HEADER_LENGTH+this.length}},DataParserResult=FrakClass.extend({init:function(){this.data={meshes:[],materials:[],hierarchy:!1,collision:!1,hierarchyNodesByID:{}}},getData:function(){return this.data},linkReferences:function(){for(var e in this.data.meshes)-1!=this.data.meshes[e].material&&this.data.meshes[e].material in this.data.materials&&(this.data.meshes[e].material=this.data.materials[this.data.meshes[e].material]);if(!1!==this.data.hierarchy){var t=this,i=function(e){for(var n in e.meshes)e.meshes[n]>=0&&e.meshes[n]in t.data.meshes&&(e.meshes[n]=t.data.meshes[e.meshes[n]]);for(var r in e.children)i(e.children[r])};i(this.data.hierarchy)}},createGroup:function(){return{name:"",id:!1,parent:!1,children:[],meshes:[],position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:0},scale:{x:0,y:0,z:0},transform:!1}},mapGroupID:function(e){this.data.hierarchyNodesByID[e.id]=e},setRoot:function(e){this.data.hierarchy=e},createMaterialTexture:function(){return{path:!1,scale:{u:1,v:1,w:1}}},createMaterial:function(){return{name:"",color:{ambient:!1,diffuse:!1,specular:!1,emissive:!1},twosided:!1,shininess:0,shininess_strength:0,shader:!1,textures:{ambient:[],diffuse:[],specular:[],emissive:[],normal:[],height:[],shininess:[],opacity:[],displacement:[],lightmap:[],reflection:[]}}},addMaterial:function(e){this.data.materials.push(e)},getMaterial:function(e){return e>=0&&e<this.data.materials.length&&this.data.materials[e]},createMesh:function(e){for(var t={index:-1,material:-1,indices:[],vertices:[]},i=0;i<e;i++)t.vertices.push(this.createVertex());return t},createVertex:function(){return{position:{x:0,y:0,z:0},normal:{x:0,y:0,z:0},texCoord:[],tangent:{x:0,y:0,z:0},bitangent:{x:0,y:0,z:0}}},addMesh:function(e){this.data.meshes.push(e),e.index=this.data.meshes.length-1},createCollisionTreeNode:function(){return{parent:!1,children:[],center:{x:0,y:0,z:0},extents:{x:0,y:0,z:0},faces:!1}},addFaceList:function(e,t,i,n){return!(t<0||i<0||0==n.length)&&(!1===e.faces&&(e.faces={}),t in e.faces||(e.faces[t]={}),i in e.faces[t]||(e.faces[t][i]=[]),e.faces[t][i]=e.faces[t][i].concat(n),!0)},setCollisionTreeRoot:function(e){this.data.collision=e}}),DataParser=FrakClass.extend({init:function(e,t,i,n,r){this.VERSION=1,this.view=new jDataView(e),this.onComplete=t,this.onProgress=n,this.onError=i,this.userdata=r,this.result=new DataParserResult,this.errors=[],this.stack=[],this.linkReferences=!0,this.flipX=!1,this.warnOnUnknownChunks=!0,this.isFunction=function(e){return"function"==typeof e}},parse:function(){for(this.push(!1,this.parseHeader);!this.completed();)if(!this.step())return this.isFunction(this.onError)&&this.onError(this.errors,this.userdata),!1;return this.linkReferences&&this.result.linkReferences(),this.isFunction(this.onComplete)&&this.onComplete(this.result.getData(),this.userdata),!0},error:function(e){return this.errors.push(e),!1},errorExpect:function(e,t){return this.error("Expected at least "+e+" byte"+(e>1?"s":"")+' for "'+t+'"')},completed:function(){return this.view.tell()==this.view.byteLength},step:function(){var e=this.getCurrentCall();if(e){var t=e(this.getCurrentNode());return this.isFunction(this.onProgress)&&this.onProgress(this.view.tell()/this.view.byteLength*100,this.userdata),t}return!1},push:function(e,t){this.stack.push({node:e,call:FrakCallback(this,t)})},pop:function(){this.stack.pop()},getCurrentNode:function(){return this.stack.length>0&&this.stack[this.stack.length-1].node},getCurrentCall:function(){return this.stack.length>0&&this.stack[this.stack.length-1].call},hasDataFor:function(e){return!(this.view.byteLength<this.view.tell()+e)},hasDataForNode:function(e){return!(this.view.byteLength<e.position+e.length+8)},getUint32:function(){return this.view.getUint32(this.view.tell(),!0)},getFloat32:function(){return this.view.getFloat32(this.view.tell(),!0)},getMatrix4x4:function(){for(var e=[],t=0;t<4;t++)e.push([this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32()]);return e},getColor:function(){return{r:this.view.getFloat32(this.view.tell(),!0),g:this.view.getFloat32(this.view.tell(),!0),b:this.view.getFloat32(this.view.tell(),!0),a:this.view.getFloat32(this.view.tell(),!0)}},parseHeader:function(){if(!this.view)return this.error("No data to parse");if(!this.parseSignature())return!1;var e=this.parseNodeHeader();return!1!==e&&(e.id!==DataParserTypes.NODE_ROOT?this.error("Root node type is incorrect"):(this.push(e,this.parseRoot),!0))},parseSignature:function(){return this.hasDataFor(12)?"3DTECHDATA"!=this.view.getString(10)?this.error("The data is not in 3DTech DATA format"):this.view.getInt16(this.view.tell(),!0)!=this.VERSION?this.error("Incompatible version"):!!this.hasDataFor(8)||this.error("Could not find root node"):this.error("Not enough data for 3DTech DATA format header")},parseNodeHeader:function(){if(!this.hasDataFor(8))return this.error("Not enough data for parsing node header");var e=this.view.tell(),t=this.getUint32(),i=this.getUint32();return new DataParserNode(t,i,e)},skipNode:function(e){this.warnOnUnknownChunks&&console.warn("DataParser: skipping node ",DataParserTypes.getName(e.id)),this.view.seek(this.view.tell()+e.length)},parseMaterial:function(e){for(var t=this.result.createMaterial();this.view.tell()<e.end();){var i=this.parseNodeHeader();switch(i.id){case DataParserTypes.NODE_STRING:t.name=this.view.getString(i.length);break;case DataParserTypes.NODE_SHADER_NAME:t.shader=this.view.getString(i.length);break;case DataParserTypes.NODE_COLOR_AMBIENT:if(16!=i.length)return this.error("Ambient color corrupted");t.color.ambient=this.getColor();break;case DataParserTypes.NODE_COLOR_DIFFUSE:if(16!=i.length)return this.error("Diffuse color corrupted");t.color.diffuse=this.getColor();break;case DataParserTypes.NODE_COLOR_SPECULAR:if(16!=i.length)return this.error("Specular color corrupted");t.color.specular=this.getColor();break;case DataParserTypes.NODE_COLOR_EMISSIVE:if(16!=i.length)return this.error("Emissive color corrupted");t.color.emissive=this.getColor();break;case DataParserTypes.NODE_TWOSIDED:if(i.length<1)return this.errorExpect(1,"material.twosided");var n=this.view.getChar();t.twosided=255==n;break;case DataParserTypes.NODE_SHININESS:if(i.length<4)return this.errorExpect(4,"material.shininess");t.shininess=this.getFloat32();break;case DataParserTypes.NODE_SHININESS_STRENGTH:if(i.length<4)return this.errorExpect(4,"material.shininess_strength");t.shininess_strength=this.getFloat32();break;case DataParserTypes.NODE_TEXTURES_AMBIENT:this.parseMaterialTextures(i,t.textures.ambient);break;case DataParserTypes.NODE_TEXTURES_DIFFUSE:this.parseMaterialTextures(i,t.textures.diffuse);break;case DataParserTypes.NODE_TEXTURES_SPECULAR:this.parseMaterialTextures(i,t.textures.specular);break;case DataParserTypes.NODE_TEXTURES_EMISSIVE:this.parseMaterialTextures(i,t.textures.emissive);break;case DataParserTypes.NODE_TEXTURES_NORMALS:this.parseMaterialTextures(i,t.textures.normal);break;case DataParserTypes.NODE_TEXTURES_HEIGHT:this.parseMaterialTextures(i,t.textures.height);break;case DataParserTypes.NODE_TEXTURES_SHININESS:this.parseMaterialTextures(i,t.textures.shininess);break;case DataParserTypes.NODE_TEXTURES_OPACITY:this.parseMaterialTextures(i,t.textures.opacity);break;case DataParserTypes.NODE_TEXTURES_DISPLACEMENT:this.parseMaterialTextures(i,t.textures.displacement);break;case DataParserTypes.NODE_TEXTURES_LIGHTMAP:this.parseMaterialTextures(i,t.textures.lightmap);break;case DataParserTypes.NODE_TEXTURES_REFLECTION:this.parseMaterialTextures(i,t.textures.reflection);break;default:this.skipNode(i)}}return this.result.addMaterial(t),!0},parseMaterialTextures:function(e,t){for(;this.view.tell()<e.end();){var i=this.parseNodeHeader();if(i.id==DataParserTypes.NODE_TEXTURE){for(var n=this.result.createMaterialTexture();this.view.tell()<i.end();){var r=this.parseNodeHeader();switch(r.id){case DataParserTypes.NODE_STRING:n.path=this.view.getString(r.length);break;case DataParserTypes.NODE_TEXTURE_SCALE:if(12!=r.length)return this.error("Texture scale is corrupted");n.scale.u=this.getFloat32(),n.scale.v=this.getFloat32(),n.scale.w=this.getFloat32();break;default:this.skipNode(r)}}!1!==n.path&&t.push(n)}else this.skipNode(i)}return!0},parseMaterials:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(;this.view.tell()<e.end();){var t=this.parseNodeHeader();t.id==DataParserTypes.NODE_MATERIAL?this.parseMaterial(t):this.skipNode(t)}return this.pop(),!0},parseGeometry:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");if(this.view.tell()>=e.end())return this.pop(),!0;var t=this.parseNodeHeader();if(t.id==DataParserTypes.NODE_MESH){if(!this.hasDataForNode(t))return this.error("Not enough data for node '"+DataParserTypes.getName(t.id)+"'");this.push(t,this.parseMesh)}else this.skipNode(t);return!0},parseMesh:function(e){var t=this.getUint32(),i=this.result.createMesh(t),n=0,r=[1,1,1],s=[1,1,1];for(this.flipX&&(s[0]=-1);this.view.tell()<e.end();){var a=this.parseNodeHeader();if(!this.hasDataForNode(a))return this.error("Not enough data for node '"+DataParserTypes.getName(a.id)+"'");switch(a.id){case DataParserTypes.NODE_MATERIAL_REFERENCE:if(a.length<4)return this.errorExpect(4,"mesh.material_reference");i.material=this.getUint32();break;case DataParserTypes.NODE_VERTICES:if(!this.parseVertices(a,t,i.vertices,"position",s))return!1;break;case DataParserTypes.NODE_NORMALS:if(!this.parseVertices(a,t,i.vertices,"normal",r))return!1;break;case DataParserTypes.NODE_TANGENTS:if(!this.parseVertices(a,t,i.vertices,"tangent",r))return!1;break;case DataParserTypes.NODE_BITANGENTS:if(!this.parseVertices(a,t,i.vertices,"bitangent",r))return!1;break;case DataParserTypes.NODE_TEXTURE_COORDINATES:if(a.length<4)return this.errorExpect(4,"mesh texture coordinates component count");var o=this.getUint32();if(0==o||o>3)return this.error("Unsupported number of texture coordinate components: "+o);if(a.length-4!=o*t*4)return this.error("Texture coordinate set "+n+" is corrupted");for(var h=["x","y","z"],u=0;u<t;u++){for(var c={},l=0;l<o;l++)c[h[l]]=this.getFloat32();i.vertices[u].texCoord.push(c)}n++;break;case DataParserTypes.NODE_FACES:if(!this.parseFaces(a,i.indices))return!1;break;default:this.skipNode(a)}}return this.result.addMesh(i),this.pop(),!0},parseVertices:function(e,t,i,n,r){if(e.length!=12*t)return this.error("Node "+DataParserTypes.getName(e.id)+" is corrupted");for(var s=0;s<t;s++)i[s][n].x=r[0]*this.getFloat32(),i[s][n].y=r[1]*this.getFloat32(),i[s][n].z=r[2]*this.getFloat32();return!0},parseFaces:function(e,t){if(e.length<4)return this.errorExpect(4,"faces.num_triangles");var i=this.getUint32();if(e.length-4!=12*i)return this.error("Faces list is corrupted");for(var n=0;n<i;n++)t.push(this.getUint32()),t.push(this.getUint32()),t.push(this.getUint32());return!0},parseScene:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(;this.view.tell()<e.end();){var t=this.parseNodeHeader();if(t.id==DataParserTypes.NODE_GROUP){if(!this.parseGroup(t,!1))return!1}else this.skipNode(t)}return this.pop(),!0},parseGroup:function(e,t){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");var i=this.result.createGroup();for(!1===t?this.result.setRoot(i):(t.children.push(i),i.parent=t);this.view.tell()<e.end();){var n=this.parseNodeHeader();if(!this.hasDataForNode(n))return this.error("Not enough data for node '"+DataParserTypes.getName(n.id)+"'");switch(n.id){case DataParserTypes.NODE_GROUP_ID:if(n.length<4)return this.error("Group ID is corrupted");i.id=this.getUint32(),this.result.mapGroupID(i);break;case DataParserTypes.NODE_STRING:i.name=this.view.getString(n.length);break;case DataParserTypes.NODE_TRANSFORM_POSITION:if(12!=n.length)return this.error("Group position is corrupted");i.position.x=this.getFloat32(),i.position.y=this.getFloat32(),i.position.z=this.getFloat32();break;case DataParserTypes.NODE_TRANSFORM_ROTATION:if(16!=n.length)return this.error("Group rotation is corrupted");i.rotation.x=this.getFloat32(),i.rotation.y=this.getFloat32(),i.rotation.z=this.getFloat32(),i.rotation.w=this.getFloat32();break;case DataParserTypes.NODE_TRANSFORM_SCALE:if(12!=n.length)return this.error("Group scale is corrupted");i.scale.x=this.getFloat32(),i.scale.y=this.getFloat32(),i.scale.z=this.getFloat32();break;case DataParserTypes.NODE_MATRIX4X4:if(64!=n.length)return this.error("Group transformation matrix is corrupted");i.transform=this.getMatrix4x4();break;case DataParserTypes.NODE_MESH_REFERENCE:if(n.length<4)return this.error("Group mesh reference is corrupted");i.meshes.push(this.getUint32());break;case DataParserTypes.NODE_GROUP:this.parseGroup(n,i);break;default:this.skipNode(n)}}return!0},parseCollision:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(;this.view.tell()<e.end();){var t=this.parseNodeHeader();if(t.id==DataParserTypes.NODE_COLLISION_NODE){if(!this.parseCollisionNode(t,!1))return!1}else this.skipNode(t)}return this.pop(),!0},parseCollisionNode:function(e,t){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");var i=this.result.createCollisionTreeNode();for(!1===t?this.result.setCollisionTreeRoot(i):(t.children.push(i),i.parent=t);this.view.tell()<e.end();){var n=this.parseNodeHeader();if(!this.hasDataForNode(n))return this.error("Not enough data for node '"+DataParserTypes.getName(n.id)+"'");switch(n.id){case DataParserTypes.NODE_COLLISION_AABB_CENTER:if(12!=n.length)return this.error("Collision node center is corrupted");i.center.x=this.getFloat32(),i.center.y=this.getFloat32(),i.center.z=this.getFloat32();break;case DataParserTypes.NODE_COLLISION_AABB_EXTENTS:if(12!=n.length)return this.error("Collision node extents are corrupted");i.extents.x=this.getFloat32(),i.extents.y=this.getFloat32(),i.extents.z=this.getFloat32();break;case DataParserTypes.NODE_COLLISION_NODE:this.parseCollisionNode(n,i);break;case DataParserTypes.NODE_COLLISION_FACE_LIST:this.parseCollisionFaceList(n,i);break;default:this.skipNode(n)}}return!0},parseCollisionFaceList:function(e,t){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(var i=-1,n=-1,r=[];this.view.tell()<e.end();){var s=this.parseNodeHeader();if(!this.hasDataForNode(s))return this.error("Not enough data for node '"+DataParserTypes.getName(s.id)+"'");switch(s.id){case DataParserTypes.NODE_FACE_LIST_NODE_ID:if(4!=s.length)return this.error("Face list node ID is corrupted");i=this.getUint32();break;case DataParserTypes.NODE_FACE_LIST_MESH_REFERENCE:if(4!=s.length)return this.error("Face list mesh ID is corrupted");n=this.getUint32();break;case DataParserTypes.NODE_FACE_LIST_INDICES:for(;this.view.tell()<s.end();)r.push(this.getUint32());break;default:this.skipNode(s)}}return this.result.addFaceList(t,i,n,r)},parseRoot:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");if(this.view.tell()>=e.end())return!0;var t=this.parseNodeHeader();switch(t.id){case DataParserTypes.NODE_MATERIALS:this.push(t,this.parseMaterials);break;case DataParserTypes.NODE_GEOMETRY:this.push(t,this.parseGeometry);break;case DataParserTypes.NODE_SCENE:this.push(t,this.parseScene);break;case DataParserTypes.NODE_COLLISION:this.push(t,this.parseCollision);break;default:this.skipNode(t)}return!0}}),ThreadedDataParser=DataParser.extend({init:function(e,t,i,n,r){this._super(e,t,i,n,r),this.timer=!1,this.inverval=10},parse:function(){return this.push(!1,this.parseHeader),this.timer=setTimeout(FrakCallback(this,this.threadStep),this.inverval),!0},threadStep:function(){if(this.completed())return this.linkReferences&&this.result.linkReferences(),void(this.isFunction(this.onComplete)&&this.onComplete(this.result.getData(),this.userdata));this.step()?this.timer=setTimeout(FrakCallback(this,this.threadStep),this.inverval):this.onError&&"function"==typeof this.onError&&this.onError(this.errors,this.userdata)}}),ModelLoader=FrakClass.extend({init:function(e,t,i,n){this.descriptor=t,this.shadersManager=i,this.texturesManager=n,this.defaultTexture=!1,this.defaultSampler=!1,this.nodesByID={},this.submeshesByID={},this.submeshes=[]},createDefaultTextureSampler:function(e){this.defaultTexture||e.engine&&(this.defaultTexture=e.engine.WhiteTexture,this.defaultSampler=new Sampler("diffuse0",this.defaultTexture))},load:function(e,t){e.name=t.hierarchy.name,this.loadMaterials(t.materials),this.loadSubmeshes(t.meshes),this.loadNode(e,t.hierarchy),this.loadCollision(e,t)},loadMaterials:function(e){for(var t=0;t<e.length;t++){var i=e[t];i.instance=new Material,this.loadMaterial(i.instance,i)}},loadSubmeshes:function(e){for(var t=0;t<e.length;t++){var i=new Submesh;this.loadSubmesh(i,e[t]),this.submeshesByID[e[t].index]={submesh:i,material:e[t].material.instance}}},loadNode:function(e,t){e.localCollisionID=t.id,this.nodesByID[e.localCollisionID]=e,this.loadTransform(e.transform,t.transform),this.loadMesh(e,t.meshes);for(var i in t.children){var n=new Node(t.children[i].name);this.loadNode(n,t.children[i]),e.addNode(n)}},loadMesh:function(e,t){if(t&&0!=t.length){var i=new Mesh;for(var n in t)if(t[n].index in this.submeshesByID){var r=this.submeshesByID[t[n].index];i.addSubmesh(r.submesh,r.material)}e.addComponent(new MeshComponent(i)),e.addComponent(new MeshRendererComponent)}},loadSubmesh:function(e,t){if(e.faces=t.indices,0!=t.vertices.length){var i=t.vertices[0];if(e.positions=this.loadSubmeshBuffer("position",t.vertices,["x","y","z"]),i.normal&&(e.normals=this.loadSubmeshBuffer("normal",t.vertices,["x","y","z"])),i.tangent&&(e.tangents=this.loadSubmeshBuffer("tangent",t.vertices,["x","y","z"])),i.bitangent&&(e.bitangents=this.loadSubmeshBuffer("bitangent",t.vertices,["x","y","z"])),i.texCoord)for(var n in i.texCoord)e.texCoords2D.push(this.loadSubmeshIndexedBuffer("texCoord",t.vertices,["x","y"],n));e.recalculateBounds()}},loadSubmeshBuffer:function(e,t,i){buffer=[];for(var n in t){vertex=t[n];for(var n in i){var r=i[n];buffer.push(vertex[e][r])}}return buffer},loadSubmeshIndexedBuffer:function(e,t,i,n){buffer=[];for(var r in t){vertex=t[r];for(var r in i){var s=i[r];buffer.push(vertex[e][n][s])}}return buffer},loadMaterial:function(e,t){e.name=t.name,e.shader=this.shadersManager.addSource(t.shader),e.uniforms={},this.loadUniforms(e.uniforms,t);for(var i in t.textures)for(var n=t.textures[i],r=0;r<n.length;r++){var s=new TextureDescriptor(n[r].path);s.parentDescriptor=this.descriptor;var a=this.texturesManager.addDescriptor(s);e.samplers||(e.samplers=[]),e.samplers.push(new Sampler(i+r,a)),"normal"==i&&(e.shader=this.shadersManager.addSource("normalmapped"))}e.samplers||"diffuse"!=t.shader.toLowerCase()||(e.samplers=[],this.createDefaultTextureSampler(this.texturesManager.context),e.samplers.push(this.defaultSampler))},loadUniforms:function(e,t){t.color.ambient?e.ambient=new UniformColor(t.color.ambient):e.ambient=new UniformColor(new Color(.2,.2,.2,1)),t.color.diffuse?e.diffuse=new UniformColor(t.color.diffuse):e.diffuse=new UniformColor(new Color(1,1,1,1)),t.color.emissive&&(e.emissive=new UniformColor(t.color.emissive)),t.color.specular&&(e.specular=new UniformColor(t.color.specular)),e.twosided=new UniformInt(t.twosided+0)},loadTransform:function(e,t){e.relative[0]=t[0][0],e.relative[4]=t[0][1],e.relative[8]=t[0][2],e.relative[12]=t[0][3],e.relative[1]=t[1][0],e.relative[5]=t[1][1],e.relative[9]=t[1][2],e.relative[13]=t[1][3],e.relative[2]=t[2][0],e.relative[6]=t[2][1],e.relative[10]=t[2][2],e.relative[14]=t[2][3],e.relative[3]=t[3][0],e.relative[7]=t[3][1],e.relative[11]=t[3][2],e.relative[15]=t[3][3]},loadCollisionNodeParameters:function(e,t){var i=new CollisionOctreeNode([e.center.x,e.center.y,e.center.z],2*e.extents.x,t);return e.faces&&(i.faces=e.faces),i},loadCollisionNodeSubnodes:function(e,t,i){if(0!=t.children.length){e.subnodes=[];for(var n=0;n<8;n++){var r=this.loadCollisionNodeParameters(t.children[n],e);e.subnodes.push(r),this.loadCollisionNodeSubnodes(r,t.children[n],i)}}},loadCollision:function(e,t){if(!1!==t.collision){var i=e.addComponent(new LargeMeshCollider);i.tree=this.loadCollisionNodeParameters(t.collision,!1),i.tree.nodes=this.nodesByID,i.tree.submeshes={};for(var n in this.submeshesByID)i.tree.submeshes[n]=this.submeshesByID[n].submesh;this.loadCollisionNodeSubnodes(i.tree,t.collision,t)}}}),JSONModelLoader=FrakClass.extend({init:function(e,t,i,n){this.descriptor=t,this.shadersManager=i,this.texturesManager=n,this.defaultTexture=!1,this.defaultSampler=!1,this.nodesByID={},this.submeshesByID={},this.submeshes=[],this.textureUniformMap={texturesDiffuse:"diffuse",texturesNormals:"normal"}},createDefaultTextureSampler:function(e){this.defaultTexture||e.engine&&(this.defaultTexture=e.engine.WhiteTexture,this.defaultSampler=new Sampler("diffuse0",this.defaultTexture))},load:function(e,t){FRAK.isEmptyObject(t)||(e.name=t.scene.name,this.linkReferences(t),this.loadMaterials(t.materials),this.loadSubmeshes(t.meshes),this.loadNode(e,t.scene),this.loadCollision(e,t))},linkReferences:function(e){for(var t=0;t<e.meshes.length;t++)e.meshes[t].materialIndex>=0&&e.meshes[t].materialIndex<e.materials.length&&(e.meshes[t].material=e.materials[e.meshes[t].materialIndex])},loadMaterials:function(e){for(var t=0;t<e.length;t++){var i=e[t];i.instance=new Material,this.loadMaterial(i.instance,i)}},loadMaterial:function(e,t){var i=t.shader||"diffuse";e.name=t.name,e.shader=this.shadersManager.addSource(i),"transparent"==i.toLowerCase()&&(e.shader.requirements.transparent=!0),e.uniforms={},this.loadUniforms(e.uniforms,t);for(var n in t.textures)for(var r=t.textures[n],s=0;s<r.length;s++){var a=new TextureDescriptor(r[s]);a.parentDescriptor=this.descriptor;var o=this.texturesManager.addDescriptor(a),h="diffuse";n in this.textureUniformMap&&(h=this.textureUniformMap[n]),e.samplers||(e.samplers=[]),e.samplers.push(new Sampler(h+s,o)),"texturesNormals"==n&&(e.shader=this.shadersManager.addSource("normalmapped"))}e.samplers||"diffuse"!=i.toLowerCase()||(e.samplers=[],this.createDefaultTextureSampler(this.texturesManager.context),e.samplers.push(this.defaultSampler))},loadUniforms:function(e,t){t.color.ambient?e.ambient=new UniformColor(t.color.ambient):e.ambient=new UniformColor(new Color(.2,.2,.2,1)),t.color.diffuse?e.diffuse=new UniformColor(t.color.diffuse):e.diffuse=new UniformColor(new Color(1,1,1,1)),t.color.emissive&&(e.emissive=new UniformColor(t.color.emissive)),t.color.specular&&(e.specular=new UniformColor(t.color.specular)),e.twosided=new UniformInt(t.twosided+0)},loadSubmeshes:function(e){for(var t=0;t<e.length;t++){var i=new Submesh;this.loadSubmesh(i,e[t]),this.submeshesByID[t]={submesh:i,material:e[t].material.instance}}},loadSubmesh:function(e,t){if(t.faces&&0!=t.faces.length&&t.vertices&&0!=t.vertices.length){e.faces=t.faces,e.positions=t.vertices;var i=t.vertices.length/3;if(t.normals&&t.normals.length/3==i&&(e.normals=t.normals),t.tangents&&t.tangents.length/3==i&&(e.tangents=t.tangents),t.bitangents&&t.bitangents.length/3==i&&(e.bitangents=t.bitangents),t.texCoords1D)for(s=0;s<t.texCoords1D.length;s++)t.texCoords1D[s].length==i&&e.texCoords1D.push(t.texCoords1D[s]);if(t.texCoords2D)for(s=0;s<t.texCoords2D.length;s++)t.texCoords2D[s].length/2==i&&e.texCoords2D.push(t.texCoords2D[s]);else if(t.texCoords3D)for(s=0;s<t.texCoords3D.length;s++)if(t.texCoords3D[s].length/3==i){for(var n=[],r=0;r<t.texCoords3D[s].length;r+=3)n.push(t.texCoords3D[s][r]),n.push(t.texCoords3D[s][r+1]);e.texCoords2D.push(n),e.yesIGeneratedThese=!0}if(t.texCoords3D)for(s=0;s<t.texCoords3D.length;s++)t.texCoords3D[s].length/3==i&&e.texCoords3D.push(t.texCoords3D[s]);if(t.texCoords4D)for(var s=0;s<t.texCoords4D.length;s++)t.texCoords4D[s].length/4==i&&e.texCoords4D.push(t.texCoords4D[s]);e.recalculateBounds()}},loadNode:function(e,t){e.localCollisionID=t.id,this.nodesByID[e.localCollisionID]=e,e.transform.relative=t.relative,this.loadMesh(e,t.meshes);for(var i=0;i<t.subnodes.length;i++){var n=new Node(t.subnodes[i].name);this.loadNode(n,t.subnodes[i]),e.addNode(n)}},loadMesh:function(e,t){if(t&&0!=t.length){for(var i=new Mesh,n=0;n<t.length;n++){var r=t[n];if(r in this.submeshesByID){var s=this.submeshesByID[r];i.addSubmesh(s.submesh,s.material)}}e.addComponent(new MeshComponent(i)),e.addComponent(new MeshRendererComponent)}},loadCollisionNodeParameters:function(e,t){var i=new CollisionOctreeNode(new Float32Array(e.center),2*e.extents[0],t);return e.faces&&(i.faces=e.faces),i},loadCollisionNodeSubnodes:function(e,t,i){if(t.subnodes&&8==t.subnodes.length){e.subnodes=[];for(var n=0;n<8;n++){var r=this.loadCollisionNodeParameters(t.subnodes[n],e);e.subnodes.push(r),this.loadCollisionNodeSubnodes(r,t.subnodes[n],i)}}},loadCollision:function(e,t){if(t.collision){var i=e.addComponent(new LargeMeshCollider);i.tree=this.loadCollisionNodeParameters(t.collision,!1),i.tree.nodes=this.nodesByID,i.tree.submeshes={};for(var n in this.submeshesByID)i.tree.submeshes[n]=this.submeshesByID[n].submesh;this.loadCollisionNodeSubnodes(i.tree,t.collision,t)}}}),Manager=FrakClass.extend({init:function(e){var t=this;this.path="",e&&(this.path=e),this.path.length>0&&"/"!=this.path.slice(-1)&&(this.path+="/"),this.queue=[],this.loading=[],this.cache={},this.cacheSize=0,this.callbacks=[],this.progressCallbacks=[],this.sourceCallback=function(e){return t.path+e},this.descriptorCallback=function(e){return e},this.onAddToQueue=function(e){},this.onLoaded=function(e){}},getTotalItems:function(){return this.queue.length+this.loading.length+this.cacheSize},getWaitingItems:function(){return this.queue.length+this.loading.length},getProgress:function(){return 0==this.getTotalItems()?1:1-this.getWaitingItems()/this.getTotalItems()},addDescriptor:function(e){var t=this.cache[e.serialize(["id"])];return t||((t=this.getLoadingResource(e))?t:(this.onAddToQueue(e),t=this.createResource(e),this.queue.push([e,e.serialize(["id"]),t]),t))},getLoadingResource:function(e){var t=e.serialize(["id"]);for(var i in this.loading)if(this.loading[i][1]==t)return this.loading[i][2];for(var n in this.queue)if(this.queue[n][1]==t)return this.queue[n][2];return null},removeFromCache:function(e){delete this.cache[e],this.cacheSize--},cleanCache:function(){this.cache={},this.cacheSize=0},load:function(e,t){t&&this.progressCallbacks.push(t),e&&(this.callbacks.push(e),this.callbacks.length>1)?0==this.queue.length&&this.callDoneCallbacks():this.keepLoading()},keepLoading:function(){for(var e=0;e<this.progressCallbacks.length;e++)this.progressCallbacks[e](this.getProgress());if(0!=this.queue.length){var t=this,i=this.queue.shift();this.loading.push(i),this.loadResource(i[0],i[2],function(e,i){t.cache[e.serialize(["id"])]=i,t.cacheSize++,t.removeLoadedResource(e),t.onLoaded(e),t.keepLoading()},function(e){console.warn("Failed to load resource with descriptor: ",e.serialize(["id"])),t.removeLoadedResource(e),t.onLoaded(e),e.getFullPath&&console.warn("Full path: ",e.getFullPath()),t.keepLoading()})}else this.callDoneCallbacks()},removeLoadedResource:function(e){for(var t in this.loading)if(this.loading[t][0]===e){this.loading.splice(t,1);break}},callDoneCallbacks:function(){var e=this.callbacks;this.callbacks=[];for(var t=0;t<e.length;t++)e[t]()},createResource:function(){throw"createResource not implemented by this instance of Manager"},loadResource:function(e,t,i,n){throw"loadResource not implemented by this instance of Manager"}}),TextManager=Manager.extend({init:function(e){this._super(e)},add:function(e){return e=this.sourceCallback(e),this.addDescriptor(new TextDescriptor(e))},createResource:function(e){return{data:!1,descriptor:e}},loadResource:function(e,t,i,n){var r=this.descriptorCallback(e);Logistics.getText(r.getFullPath(),function(e){t.data=e,i(r,t)}).error(function(){n(r)})}}),ShadersManager=Manager.extend({init:function(e,t){this._super(t),this.context=e,this.aliases={diffuse:"shaders/default/diffuse",normalmapped:"shaders/default/normalmapped",transparent:"shaders/default/transparent",reflective:"shaders/default/reflective",reflective_masked:"shaders/default/reflective_masked",test:"shaders/default/test",fallback:"shaders/default/fallback",depthrgba:"shaders/default/DepthRGBA",gaussianblur:"shaders/default/GaussianBlur"},this.textManager=new TextManager},add:function(e,t){return e=this.sourceCallback(e),t=this.sourceCallback(t),this.addDescriptor(new ShaderDescriptor(e,t))},addSource:function(e){var t=e.toLowerCase();return t in this.aliases&&(e=this.aliases[t]),e=this.sourceCallback(e),this.addDescriptor(new ShaderDescriptor(e+".vert",e+".frag"))},createResource:function(e){return new Shader(this.context,e)},loadResource:function(e,t,i,n){var r=this.descriptorCallback(e),s=this.textManager.add(r.getVertexShaderPath()),a=this.textManager.add(r.getFragmentShaderPath());this.textManager.load(function(){s.data&&a.data?(t.addVertexShader(s.data),t.addFragmentShader(a.data),i(r,t)):n(r)})}}),TexturesManager=Manager.extend({init:function(e,t){this._super(t),this.context=e},add:function(e){e=this.sourceCallback(e);var t=new TextureDescriptor(e);return this.addDescriptor(t)},addCube:function(e){if(6!=e.length)throw"TexturesManager.addCube: Cube textures require 6 image URIs";for(var t=new CubeTextureDescriptor,i=0;i<e.length;i++)t.sources.push(this.sourceCallback(e[i]));return this.addDescriptor(t)},createResource:function(e){if(e instanceof CubeTextureDescriptor)return(t=new CubeTexture(this.context)).name="Cubemap",t;var t=new Texture(this.context);return t.name=e.source,t},loadResource:function(e,t,i,n){var r=this.descriptorCallback(e),s=this;if(e instanceof CubeTextureDescriptor){var a=[CubeTexture.FRONT,CubeTexture.BACK,CubeTexture.LEFT,CubeTexture.RIGHT,CubeTexture.BOTTOM,CubeTexture.TOP];!function e(){if(0!=a.length){var o=a.shift();Logistics.getImage(r.getFaceFullPath(o),function(i){t.setFace(s.context,o,i),delete i,e()}).error(function(){n(r)})}else i(r,t)}()}else Logistics.getImage(r.getFullPath(),function(e){t.setImage(s.context,e),delete e,i(r,t)}).error(function(){n(r)})}}),MaterialsManager=Manager.extend({init:function(e,t,i,n){if(this._super(t),i&&!(i instanceof ShadersManager))throw"shadersManager is not instance of ShadersManager";if(n&&!(n instanceof TexturesManager))throw"texturesManager is not instance of TexturesManager";i||(i=new ShadersManager(e)),this.shadersManager=i,n||(n=new TexturesManager(e)),this.texturesManager=n,this.context=e},add:function(e){return e=this.sourceCallback(e),this.addDescriptor(new MaterialDescriptor(e))},createResource:function(e){var t=new Material;return t.descriptor=e,t},loadResource:function(e,t,i,n){var r,s=this.descriptorCallback(e),a=this;s.shaderDescriptor&&(r=this.shadersManager.addDescriptor(s.shaderDescriptor)),this.shadersManager.load(function(){var e={};for(var n in s.textureDescriptors)e[n]=a.texturesManager.addDescriptor(s.textureDescriptors[n]);a.texturesManager.load(function(){t.samplers||(t.samplers=[]);for(var n in e)t.samplers.push(new Sampler(n,e[n]));t.shader=r,t.uniforms=s.uniforms,s.requirements&&t.shader&&(t.shader.requirements.transparent=s.requirements.transparent),i(s,t)})})}}),MaterialSourcesManager=Manager.extend({init:function(e,t,i,n){if(this._super(t),i&&!(i instanceof MaterialsManager))throw"materialsManager is not instance of MaterialsManager";if(n&&!(n instanceof TextManager))throw"textManager is not instance of TextManager";i||(i=new MaterialsManager(e)),this.materialsManager=i,n||(n=new TextManager),this.textManager=n,this.context=e},add:function(e){return e=this.sourceCallback(e),this.addDescriptor(new MaterialSourceDescriptor(e))},createResource:function(e){return new MaterialSource(e)},loadResource:function(e,t,i,n){var r=this.descriptorCallback(e),s=this.textManager.add(r.getFullPath()),a=this;this.textManager.load(function(){var e=FRAK.parseJSON(s.data),n=new MaterialDescriptor;if(n.parentDescriptor=r,e.uniforms)for(var o in e.uniforms){var h=e.uniforms[o];h instanceof Array?(1==h.length&&(n.uniforms[o]=new UniformFloat(h)),2==h.length&&(h[0]instanceof Array?n.uniforms[o]=new UniformMat2(h[0].concat(h[1])):n.uniforms[o]=new UniformVec2(h)),3==h.length&&(h[0]instanceof Array?n.uniforms[o]=new UniformMat3(h[0].concat(h[1]).concat(h[2])):n.uniforms[o]=new UniformVec3(h)),4==h.length&&(h[0]instanceof Array?n.uniforms[o]=new UniformMat4(h[0].concat(h[1]).concat(h[2]).concat(h[3])):n.uniforms[o]=new UniformVec4(h))):h instanceof Object?(!1 in h&&(h.a=0),n.uniforms[o]=new UniformColor(h)):"number"==typeof h&&parseFloat(h)==parseInt(h)?n.uniforms[o]=new UniformInt(h):n.uniforms[o]=new UniformFloat(h)}if(e.textures)for(var u in e.textures){var c=new TextureDescriptor(e.textures[u]);n.textureDescriptors[u]=c,c.parentDescriptor=n}e.shader&&(e.shader instanceof Array?n.shaderDescriptor=new ShaderDescriptor(e.shader[0],e.shader[1]):n.shaderDescriptor=new ShaderDescriptor(e.shader),n.shaderDescriptor.parentDescriptor=n),e.requirements&&(n.requirements=e.requirements),t.material=a.materialsManager.addDescriptor(n),a.materialsManager.load(function(){i(r,t)})})}}),ModelsManager=Manager.extend({init:function(e,t,i,n){this._super(t),i||(i=new ShadersManager(e)),this.shadersManager=i,n||(n=new TexturesManager(e)),this.texturesManager=n},getProgress:function(){var e=this._super();return 1==e?e:e+(this.texturesManager.getProgress()+this.shadersManager.getProgress())/2/this.getTotalItems()},add:function(e,t){return e=this.sourceCallback(e),this.addDescriptor(new ModelDescriptor(e,t))},createResource:function(){return new Node},loadResource:function(e,t,i,n){var r=this.descriptorCallback(e),s=this;"json"==e.getFormat()?Logistics.getJSON(r.getFullPath(),function(e){new JSONModelLoader(s.context,r,s.shadersManager,s.texturesManager).load(t,e),i(r,t),s.shadersManager.load(function(){}),s.texturesManager.load(function(){})}):Logistics.getBinary(r.getFullPath(),function(e){e&&0!=e.byteLength?s.createParser(e,function(e,n){new ModelLoader(s.context,r,s.shadersManager,s.texturesManager).load(t,e),i(r,t),s.shadersManager.load(function(){}),s.texturesManager.load(function(){})},function(e,t){n(r)},function(e,t){}).parse():n(r)})},createParser:function(e,t,i,n,r){return new ThreadedDataParser(e,t,i,n,r)}}),AssetsManager=FrakClass.extend({init:function(e,t){this.managers=[],this.assetsPath=t;var i=this;this.loadingCount=0,this.loadedCallbacks=[];var n=function(e){e.onAddToQueue=function(e){i.loadingCount++},e.onLoaded=function(e){if(--i.loadingCount<=0){var t=i.loadedCallbacks.slice(0);i.loadedCallbacks=[];for(var n=0;n<t.length;n++)(0,t[n])()}},i.managers.push(e)};n(this.shadersManager=new ShadersManager(e,this.assetsPath)),n(this.texturesManager=new TexturesManager(e,this.assetsPath)),n(this.modelsManager=new ModelsManager(e,this.assetsPath,this.shadersManager,this.texturesManager)),n(this.textManager=new TextManager(this.assetsPath)),n(this.materialsManager=new MaterialsManager(e,this.assetsPath,this.shadersManager,this.texturesManager)),n(this.materialSourcesManager=new MaterialSourcesManager(e,this.assetsPath,this.materialsManager,this.textManager))},addTexture:function(e){return this.texturesManager.add(e)},addModel:function(e,t){return this.modelsManager.add(e,t)},addShaderSource:function(e){return this.shadersManager.addSource(e)},addShader:function(e,t){return this.shadersManager.add(e,t)},addText:function(e){return this.textManager.add(e)},addMaterial:function(e){return this.materialSourcesManager.add(e)},hasItemsInQueue:function(){for(var e in this.managers)if(this.managers[e].getWaitingItems()>0)return!0;return!1},load:function(e,t){var i=this;if(e&&this.loadedCallbacks.push(e),this.hasItemsInQueue())for(var n=0;n<this.managers.length;n++)this.managers[n].load(function(){},function(){if(t){for(var e=0,n=0;n<i.managers.length;n++)i.managers[n]?e+=i.managers[n].getProgress():e+=1;t(e/i.managers.length)}});else{var r=this.loadedCallbacks.slice(0);this.loadedCallbacks=[];for(var s=0;s<r.length;s++)r[s]()}}}),BoundingVolume=Serializable.extend({init:function(e){this.center=!1,e&&(this.center=vec3.clone(e))},type:function(){return"BoundingVolume"},isPoint:function(){return!0},toString:function(){return"BoundingVolume[center=("+this.center[0]+","+this.center[1]+","+this.center[2]+")]"}}),BoundingVolumeVectorCache=[vec3.create(),vec3.create(),vec3.create()],BoundingBox=BoundingVolume.extend({init:function(e,t){this._super(e),this.size=vec3.create(),t&&vec3.copy(this.size,t),this.extents=vec3.scale(vec3.create(),this.size,.5),this.min=vec3.create(),this.max=vec3.create(),this.recalculate()},type:function(){return"BoundingBox"},recalculate:function(){vec3.scale(this.size,this.extents,2),this.center&&(vec3.subtract(this.min,this.center,this.extents),vec3.add(this.max,this.center,this.extents))},set:function(e,t){e&&(this.center||(this.center=vec3.create()),vec3.copy(this.center,e)),t&&vec3.copy(this.size,t),vec3.scale(this.extents,this.size,.5),this.recalculate()},transform:function(e,t){if(t||(t=new BoundingBox),!this.center)return t;var i=0,n=0;mat4.translation(t.min,e),mat4.translation(t.max,e);for(var r=0;r<3;r++)for(var s=0;s<3;s++)(i=e[4*s+r]*this.min[s])<(n=e[4*s+r]*this.max[s])?(t.min[r]+=i,t.max[r]+=n):(t.min[r]+=n,t.max[r]+=i);return vec3.subtract(t.size,t.max,t.min),vec3.scale(t.extents,t.size,.5),t.center||(t.center=vec3.create()),vec3.add(t.center,t.min,t.extents),t},isPoint:function(){return 0==this.size[0]&&0==this.size[1]&&0==this.size[2]},getOuterSphereRadius:function(){return vec3.len(this.extents)},containsPoint:function(e){return!!this.center&&(e[0]>=this.min[0]&&e[1]>=this.min[1]&&e[2]>=this.min[2]&&e[0]<=this.max[0]&&e[1]<=this.max[1]&&e[2]<=this.max[2])},containsBox:function(e){return!!this.center&&(this.containsPoint(e.min)&&this.containsPoint(e.max))},intersectsBox:function(e){return!!this.center&&(this.max[0]>e.min[0]&&this.min[0]<e.max[0]&&this.max[1]>e.min[1]&&this.min[1]<e.max[1]&&this.max[2]>e.min[2]&&this.min[2]<e.max[2])},intersectsPlane:function(e){if(!this.center)return!1;var t=BoundingVolumeVectorCache[0],i=BoundingVolumeVectorCache[1],n=BoundingVolumeVectorCache[2];vec3.copy(t,this.max),vec3.copy(i,this.min);var r=1/0,s=-1/0,a=e.getDistanceToPoint(this.min);return a<r&&(vec3.copy(t,this.min),r=a),a>s&&(vec3.copy(i,this.min),s=a),(a=e.getDistanceToPoint(this.max))<r&&(vec3.copy(t,this.max),r=a),a>s&&(vec3.copy(i,this.max),s=a),vec3.set(n,this.min[0],this.min[1],this.max[2]),(a=e.getDistanceToPoint(n))<r&&(vec3.copy(t,n),r=a),a>s&&(vec3.copy(i,n),s=a),vec3.set(n,this.min[0],this.max[1],this.min[2]),(a=e.getDistanceToPoint(n))<r&&(vec3.copy(t,n),r=a),a>s&&(vec3.copy(i,n),s=a),vec3.set(n,this.min[0],this.max[1],this.max[2]),(a=e.getDistanceToPoint(n))<r&&(vec3.copy(t,n),r=a),a>s&&(vec3.copy(i,n),s=a),vec3.set(n,this.max[0],this.min[1],this.min[2]),(a=e.getDistanceToPoint(n))<r&&(vec3.copy(t,n),r=a),a>s&&(vec3.copy(i,n),s=a),vec3.set(n,this.max[0],this.min[1],this.max[2]),(a=e.getDistanceToPoint(n))<r&&(vec3.copy(t,n),r=a),a>s&&(vec3.copy(i,n),s=a),vec3.set(n,this.max[0],this.max[1],this.min[2]),(a=e.getDistanceToPoint(n))<r&&(vec3.copy(t,n),r=a),a>s&&(vec3.copy(i,n),s=a),!e.sameSide(t,i)||!(!e.pointOnPlane(t)&&!e.pointOnPlane(i))},intersectsTriangle:function(e,t,i){if(!this.center)return!1;if(AABBPlaneCache.setByPoints(e,t,i),!this.intersectsPlane(AABBPlaneCache))return!1;if(this.containsPoint(e)||this.containsPoint(t)||this.containsPoint(i))return!0;var n=BoundingVolumeVectorCache[0],r=BoundingVolumeVectorCache[1];vec3.copy(n,e),vec3.copy(r,e);for(var s=0;s<3;s++)t[s]<n[s]&&(n[s]=t[s]),i[s]<n[s]&&(n[s]=i[s]),t[s]>r[s]&&(r[s]=t[s]),i[s]>r[s]&&(r[s]=i[s]);if(!(this.max[0]>=n[0]&&this.min[0]<=r[0]&&this.max[1]>=n[1]&&this.min[0]<=r[1]&&this.max[2]>=n[2]&&this.min[2]<=r[2]))return!1;var a=vec2.fromValues(e[0],e[1]),o=vec2.fromValues(t[0],t[1]),h=vec2.fromValues(i[0],i[1]),u=vec2.fromValues(this.min[0],this.min[1]),c=vec2.fromValues(this.max[0],this.max[1]);return!!(LineRectIntersection2D(a,o,u,c)||LineRectIntersection2D(o,h,u,c)||LineRectIntersection2D(h,a,u,c)||PointInTriangle2D(a,o,h,u))&&(vec2.set(a,e[2],e[1]),vec2.set(o,t[2],t[1]),vec2.set(h,i[2],i[1]),vec2.set(u,this.min[2],this.min[1]),vec2.set(c,this.max[2],this.max[1]),!!(LineRectIntersection2D(a,o,u,c)||LineRectIntersection2D(o,h,u,c)||LineRectIntersection2D(h,a,u,c)||PointInTriangle2D(a,o,h,u))&&(vec2.set(a,e[0],e[2]),vec2.set(o,t[0],t[2]),vec2.set(h,i[0],i[2]),vec2.set(u,this.min[0],this.min[2]),vec2.set(c,this.max[0],this.max[2]),!!(LineRectIntersection2D(a,o,u,c)||LineRectIntersection2D(o,h,u,c)||LineRectIntersection2D(h,a,u,c)||PointInTriangle2D(a,o,h,u))))},encapsulatePoint:function(e){if(!this.center)return this.center=vec3.clone(e),this.extents[0]=0,this.extents[1]=0,this.extents[2]=0,void this.recalculate();if(!this.containsPoint(e)){for(var t=vec3.subtract(BoundingVolumeVectorCache[0],e,this.center),i=0;i<3;i++)Math.abs(t[i])>this.extents[i]&&(this.extents[i]+=(Math.abs(t[i])-this.extents[i])/2,this.center[i]=e[i]+(e[i]>this.center[i]?-1:1)*this.extents[i]);this.recalculate()}},encapsulateBox:function(e){if(e.center)return this.center?void(this.containsBox(e)||(this.encapsulatePoint(e.min),this.encapsulatePoint(e.max))):(this.center=vec3.clone(e.center),this.extents=vec3.clone(e.extents),void this.recalculate())},getVertices:function(e){return e||(e=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()]),vec3.add(e[0],this.center,[this.extents[0],this.extents[1],this.extents[2]]),vec3.add(e[1],this.center,[-this.extents[0],this.extents[1],this.extents[2]]),vec3.add(e[2],this.center,[this.extents[0],-this.extents[1],this.extents[2]]),vec3.add(e[3],this.center,[-this.extents[0],-this.extents[1],this.extents[2]]),vec3.add(e[4],this.center,[this.extents[0],this.extents[1],-this.extents[2]]),vec3.add(e[5],this.center,[-this.extents[0],this.extents[1],-this.extents[2]]),vec3.add(e[6],this.center,[this.extents[0],-this.extents[1],-this.extents[2]]),vec3.add(e[7],this.center,[-this.extents[0],-this.extents[1],-this.extents[2]]),e},toString:function(){return"BoundingBox[\n\tcenter=("+this.center[0]+", "+this.center[1]+", "+this.center[2]+")\n\tmin=("+this.min[0]+", "+this.min[1]+", "+this.min[2]+")\n\tmax=("+this.max[0]+", "+this.max[1]+", "+this.max[2]+")\n\textents=("+this.extents[0]+", "+this.extents[1]+", "+this.extents[2]+")\n\tsize=("+this.size[0]+", "+this.size[1]+", "+this.size[2]+")\n]\n"}}),BoundingSphere=BoundingVolume.extend({init:function(e,t){this._super(e),this.radius=0,t&&(this.radius=t)},type:function(){return"BoundingSphere"},isPoint:function(){return 0==this.radius},containsPoint:function(e){return!!this.center&&vec3.distance(e,this.center)<=this.radius},containsSphere:function(e){return!!this.center&&vec3.distance(e.center,this.center)<=this.radius-e.radius},intersectsSphere:function(e){if(!this.center)return!1;var t=vec3.squaredLength(vec3.subtract(BoundingVolumeVectorCache[0],this.center,e.center)),i=this.radius+e.radius;return t<=i*i},encapsulatePoint:function(e){if(!this.center)return this.center=vec3.clone(e),void(this.radius=0);if(!this.containsPoint(e)){var t=vec3.subtract(BoundingVolumeVectorCache[0],this.center,e),i=vec3.length(t)+this.radius;vec3.normalize(t,t),this.radius=i/2;var n=vec3.scale(BoundingVolumeVectorCache[1],t,this.radius);vec3.add(this.center,e,n)}},encapsulateSphere:function(e){if(e.center){if(!this.center)return this.center=vec3.clone(e.center),void(this.radius=e.radius);if(!this.containsSphere(e)){var t=vec3.subtract(BoundingVolumeVectorCache[0],e.center,this.center),i=vec3.length(t)+e.radius;vec3.normalize(t,t),vec3.scale(t,t,i);var n=vec3.add(BoundingVolumeVectorCache[2],this.center,t);this.encapsulatePoint(n)}}},transform:function(e,t){if(t||(t=new BoundingSphere),!this.center)return t;var i=mat4.getScale(BoundingVolumeVectorCache[0],e),n=vec3.transformMat4(BoundingVolumeVectorCache[1],this.center,e);return t.center||(t.center=vec3.create()),vec3.copy(t.center,n),t.radius=this.radius*Math.max(i[0],i[1],i[2]),t},toString:function(){return"BoundingSphere[center=("+this.center[0]+", "+this.center[1]+", "+this.center[2]+") radius="+this.radius+"]"}}),Plane=FrakClass.extend({init:function(){this.normal=vec3.create(),this.distance=0},setByPoints:function(e,t,i){return this.normal=vec3.cross(vec3.create(),vec3.subtract(vec3.create(),t,e),vec3.subtract(vec3.create(),i,e)),vec3.normalize(this.normal,this.normal),this.distance=-vec3.dot(this.normal,t),this},setByNormalAndPoint:function(e,t){return this.normal=vec3.clone(e),vec3.normalize(this.normal,this.normal),this.distance=-vec3.dot(this.normal,t),this},getDistanceToPoint:function(e){return vec3.dot(this.normal,e)+this.distance},getDistanceOnLine:function(e,t){var i=vec3.scale(vec3.create(),this.normal,-this.distance),n=vec3.dot(t,this.normal);return Math.abs(n)<EPSILON?1/0:vec3.dot(vec3.sub(i,i,e),this.normal)/n},getLineIntersection:function(e,t,i){i||(i=vec3.create());var n=this.getDistanceOnLine(e,t);return vec3.scaleAndAdd(i,e,t,n),i},projectToPlane:function(e,t){return t||(t=vec3.create()),vec3.scale(t,this.normal,this.getDistanceToPoint(e)),vec3.sub(t,e,t),t},pointInFront:function(e){return vec3.dot(this.normal,e)+this.distance>0},pointInBack:function(e){return vec3.dot(this.normal,e)+this.distance<0},pointOnPlane:function(e){return Math.abs(vec3.dot(this.normal,e)+this.distance)<EPSILON},sameSide:function(e,t){return!((vec3.dot(this.normal,e)+this.distance)*(vec3.dot(this.normal,t)+this.distance)<0)},toString:function(){return"Plane["+this.normal[0]+", "+this.normal[1]+", "+this.normal[2]+", "+this.distance+"]"}}),AABBPlaneCache=new Plane,Ray=FrakClass.extend({init:function(e,t){this.infinite=!1,this.origin=vec3.create(),this.destination=vec3.create(),e&&vec3.copy(this.origin,e),t&&vec3.copy(this.destination,t)},clone:function(){var e=new Ray(this.origin,this.destination);return e.infinite=this.infinite,e},getLength:function(){return vec3.distance(this.origin,this.destination)},getDirection:function(e){return e||(e=vec3.create()),this.getVector(e),vec3.normalize(e,e),e},getVector:function(e){return e||(e=vec3.create()),vec3.subtract(e,this.destination,this.origin),e},transform:function(e){vec3.transformMat4(this.origin,this.origin,e),vec3.transformMat4(this.destination,this.destination,e)},transformWithLength:function(e,t){var i=mat4.clone(e);i[12]=0,i[13]=0,i[14]=0;var n=this.getDirection();vec3.transformMat4(this.origin,this.origin,e),vec3.transformMat4(n,n,i),vec3.scale(n,n,t),vec3.add(this.destination,this.origin,n)},getPointOnRay:function(e){var t=vec3.create(),i=this.getVector();return vec3.add(t,this.origin,vec3.scale(i,i,e)),t},getClosestPointOnRay:function(e){var t=this.getDirection(),i=vec3.dot(t,vec3.subtract(vec3.create(),e,this.origin));return vec3.add(vec3.create(),this.origin,vec3.scale(t,t,i))},distanceOfPoint:function(e){return vec3.dot(this.getDirection(),vec3.subtract(vec3.create(),e,this.origin))<=0?vec3.distance(e,this.origin):vec3.distance(vec3.cross(vec3.create(),this.getDirection(),vec3.subtract(vec3.create(),e,this.origin)))},intersectBoundingVolume:function(e,t){return!!(e instanceof BoundingVolume&&e.center)&&(e instanceof BoundingSphere?this.intersectSphere(e.center,e.radius,t):e instanceof BoundingBox&&this.intersectAABB(e.min,e.max,t))},intersectPlane:function(e,t){if(e.sameSide(this.origin,this.destination))return!1;var i=this.getDirection(),n=-e.getDistanceToPoint(this.origin)/vec3.dot(i,e.normal);return t&&t.add(vec3.add(vec3.create(),this.origin,vec3.scale(i,i,n))),!0},intersectTriangle:function(e,t,i,n){var r=vec3.subtract(RayTestLocalCache[0],i,e),s=vec3.subtract(RayTestLocalCache[1],t,e),a=vec3.cross(RayTestLocalCache[2],s,r);vec3.normalize(a,a);var o=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.origin,e),a),h=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.destination,e),a);if(o*h>=0)return!1;var u=this.getVector();u=vec3.add(u,this.origin,vec3.scale(u,u,-o/(h-o)));var c=vec3.subtract(RayTestLocalCache[2],u,e),l=vec3.dot(r,r),d=vec3.dot(r,s),f=vec3.dot(r,c),m=vec3.dot(s,s),p=vec3.dot(s,c),g=1/(l*m-d*d),v=(m*f-d*p)*g,b=(l*p-d*f)*g;return v>=0&&b>=0&&v+b<=1&&(n&&n.add(u),!0)},intersectTriangleDistanceOnly:function(e,t,i){var n=vec3.subtract(RayTestLocalCache[0],i,e),r=vec3.subtract(RayTestLocalCache[1],t,e),s=vec3.cross(RayTestLocalCache[2],r,n);vec3.normalize(s,s);var a=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.origin,e),s),o=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.destination,e),s);if(a*o>=0)return!1;var h=this.getVector(),u=-a/(o-a);h=vec3.add(h,this.origin,vec3.scale(h,h,u));var c=vec3.subtract(RayTestLocalCache[2],h,e),l=vec3.dot(n,n),d=vec3.dot(n,r),f=vec3.dot(n,c),m=vec3.dot(r,r),p=vec3.dot(r,c),g=1/(l*m-d*d),v=(m*f-d*p)*g,b=(l*p-d*f)*g;return v>=0&&b>=0&&v+b<=1&&u},intersectSphere:function(e,t,i){var n=vec3.sub(RayTestLocalCache[0],this.origin,e),r=this.getDirection(),s=vec3.dot(r,n),a=s*s-vec3.dot(n,n)+t*t;return Math.abs(a)<EPSILON?(i&&i.add(vec3.add(vec3.create(),this.origin,vec3.scale(r,r,-s))),!0):a>0&&(i&&(i.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[0],r,-s-Math.sqrt(a)))),i.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[0],r,-s+Math.sqrt(a))))),!0)},intersectAABB:function(e,t,i){var n=this.getDirection(RayTestLocalCache[0]),r=RayTestLocalCache[1],s=RayTestLocalCache[2];n[0]=1/n[0],n[1]=1/n[1],n[2]=1/n[2],r[0]=(e[0]-this.origin[0])*n[0],s[0]=(t[0]-this.origin[0])*n[0],r[1]=(e[1]-this.origin[1])*n[1],s[1]=(t[1]-this.origin[1])*n[1],r[2]=(e[2]-this.origin[2])*n[2],s[2]=(t[2]-this.origin[2])*n[2];var a=Math.max(Math.min(r[0],s[0]),Math.min(r[1],s[1]),Math.min(r[2],s[2])),o=Math.min(Math.max(r[0],s[0]),Math.max(r[1],s[1]),Math.max(r[2],s[2]));return!(o<0||a>o)&&(this.infinite?(i&&(this.getDirection(n),i.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],n,a))),i.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],n,o)))),!0):!(a*a>vec3.sqrDist(this.origin,this.destination)&&(this.origin[0]<e[0]||this.origin[1]<e[1]||this.origin[2]<e[2]||this.origin[0]>t[0]||this.origin[1]>t[1]||this.origin[2]>t[2])&&(this.destination[0]<e[0]||this.destination[1]<e[1]||this.destination[2]<e[2]||this.destination[0]>t[0]||this.destination[1]>t[1]||this.destination[2]>t[2]))&&(i&&(this.getDirection(n),i.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],n,a))),i.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],n,o)))),!0))},toString:function(){return"Ray("+vec3.str(this.origin)+", "+vec3.str(this.destination)+", infinite = "+this.infinite+")"}}),RayTestResult=FrakClass.extend({init:function(e){this.ray=e.clone(),this.hits=[],this.addCallback=!1},add:function(e){var t={point:e,collider:!1,submesh:!1,node:!1};FRAK.isFunction(this.addCallback)&&this.addCallback(t),this.hits.push(t)},empty:function(){return 0==this.hits.length},sort:function(){var e=this;this.hits.sort(function(t,i){return vec3.sqrDist(e.ray.origin,t.point)-vec3.sqrDist(e.ray.origin,i.point)})},nearest:function(){if(this.empty())return!1;for(var e=1/0,t=0,i=0;i<this.hits.length;i++){var n=vec3.sqrDist(this.ray.origin,this.hits[i].point);n<e&&(e=n,t=i)}return this.hits[t]}}),RayTestLocalCache=[vec3.create(),vec3.create(),vec3.create(),vec3.create()],Submesh=FrakClass.extend({init:function(){this.materialIndex=-1,this.faces=[],this.positions=[],this.texCoords1D=[],this.texCoords2D=[],this.texCoords3D=[],this.texCoords4D=[],this.tangents=!1,this.normals=!1,this.bitangents=!1,this.barycentric=!1,this.boundingBox=new BoundingBox,this.boundingSphere=new BoundingSphere},calculateTangents:function(){for(var e=new Float32Array(this.positions.length),t=new Float32Array(this.positions.length),i=this.texCoords2D[0],n=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec2.create(),o=vec2.create(),h=vec2.create(),u=vec3.create(),c=vec3.create(),l=0;l<this.faces.length;l+=3){var d=this.faces[l],f=this.faces[l+1],m=this.faces[l+2];vec3.set(n,this.positions[3*d],this.positions[3*d+1],this.positions[3*d+2]),vec3.set(r,this.positions[3*f],this.positions[3*f+1],this.positions[3*f+2]),vec3.set(s,this.positions[3*m],this.positions[3*m+1],this.positions[3*m+2]),vec2.set(a,i[2*d],i[2*d+1]),vec2.set(o,i[2*f],i[2*f+1]),vec2.set(h,i[2*m],i[2*m+1]);var p=r[0]-n[0],g=s[0]-n[0],v=r[1]-n[1],b=s[1]-n[1],x=r[2]-n[2],T=s[2]-n[2],E=o[0]-a[0],w=h[0]-a[0],S=o[1]-a[1],R=h[1]-a[1],y=1/(E*R-w*S);vec3.set(u,(R*p-S*g)*y,(R*v-S*b)*y,(R*x-S*T)*y),vec3.set(c,(E*g-w*p)*y,(E*b-w*v)*y,(E*T-w*x)*y),e[3*d+0]+=u[0],e[3*d+1]+=u[1],e[3*d+2]+=u[2],e[3*f+0]+=u[0],e[3*f+1]+=u[1],e[3*f+2]+=u[2],e[3*m+0]+=u[0],e[3*m+1]+=u[1],e[3*m+2]+=u[2],t[3*d+0]+=c[0],t[3*d+1]+=c[1],t[3*d+2]+=c[2],t[3*f+0]+=c[0],t[3*f+1]+=c[1],t[3*f+2]+=c[2],t[3*m+0]+=c[0],t[3*m+1]+=c[1],t[3*m+2]+=c[2]}this.tangents=new Float32Array(this.positions.length),this.bitangents=new Float32Array(this.positions.length);for(var _=vec3.create(),C=vec3.create(),M=vec3.create(),D=vec3.create(),l=0;l<this.normals.length;l+=3){vec3.set(_,this.normals[l],this.normals[l+1],this.normals[l+2]),vec3.set(C,e[l],e[l+1],e[l+2]),vec3.scale(M,_,vec3.dot(_,C)),vec3.sub(M,C,M),vec3.normalize(M,M),this.tangents[l]=M[0],this.tangents[l+1]=M[1],this.tangents[l+2]=M[2],vec3.set(M,t[l],t[l+1],t[l+2]),vec3.cross(D,_,C);var F=vec3.dot(D,M)<0?-1:1;vec3.set(C,this.tangents[l],this.tangents[l+1],this.tangents[l+2]),vec3.cross(M,_,C),vec3.scale(M,M,F),vec3.normalize(M,M),this.bitangents[l]=M[0],this.bitangents[l+1]=M[1],this.bitangents[l+2]=M[2]}delete e,delete t},calculateBarycentric:function(){this.barycentric=new Float32Array(this.positions.length);for(var e=0;e<this.faces.length;e+=3){var t=this.faces[e],i=this.faces[e+1],n=this.faces[e+2];this.barycentric[3*t+0]=1,this.barycentric[3*t+1]=0,this.barycentric[3*t+2]=0,this.barycentric[3*i+0]=0,this.barycentric[3*i+1]=1,this.barycentric[3*i+2]=0,this.barycentric[3*n+0]=0,this.barycentric[3*n+1]=0,this.barycentric[3*n+2]=1}},recalculateBounds:function(){this.boundingBox=new BoundingBox,this.boundingSphere=new BoundingSphere;for(var e=0,t=this.positions.length;e<t;e+=3)this.boundingBox.encapsulatePoint(vec3.fromValues(this.positions[e+0],this.positions[e+1],this.positions[e+2])),this.boundingSphere.encapsulatePoint(vec3.fromValues(this.positions[e+0],this.positions[e+1],this.positions[e+2]))},generateEdges:function(){function e(e,i){t.edges[t.faces[e]]||(t.edges[e]={}),t.edges[t.faces[e]][t.faces[i]]=!0}var t=this;this.edges={};for(var i=0,n=this.faces.length;i<n;i+=3)e(i,i+1),e(i+1,i),e(i+1,i+2),e(i+2,i+1),e(i+2,i),e(i,i+2)}}),Mesh=FrakClass.extend({init:function(){this.submeshes=[],this.materials=[],this.boundingBox=new BoundingBox,this.boundingSphere=new BoundingSphere},addSubmesh:function(e,t){this.boundingBox.encapsulateBox(e.boundingBox),this.boundingSphere.encapsulateSphere(e.boundingSphere),this.submeshes.push(e),t&&(this.materials.push(t),e.materialIndex=this.materials.length-1)},getMaterial:function(e){return e>=0&&e<this.materials.length&&this.materials[e]},setMaterial:function(e,t){if(e<0||e>=this.materials.length)throw"Material.setMaterial: index out of bounds.";this.materials[e]=t},addMaterial:function(e){return this.materials.push(e),this.materials.length-1},getPolycount:function(){var e=0;for(var t in this.submeshes)e+=this.submeshes[t].faces.length/3;return e},empty:function(){return 0===this.submeshes.length}}),Primitives={plane:function(e,t,i){var n=new Mesh,r=new Submesh;r.positions=[-.5*e,-.5*t,0,-.5*e,.5*t,0,.5*e,.5*t,0,.5*e,-.5*t,0],r.normals=[0,0,1,0,0,1,0,0,1,0,0,1],r.texCoords2D=[[0,0,0,1,1,1,1,0]],r.faces=[0,1,2,0,2,3],r.recalculateBounds(),n.addSubmesh(r,i);var s=new Node("Plane");return s.addComponent(new MeshComponent(n)),s.addComponent(new MeshRendererComponent),s},box:function(e,t,i){function n(e,t,i,n){vec3.sub(o,t,e),vec3.sub(h,n,e),vec3.cross(a,o,h),vec3.negate(a,a),vec3.normalize(a,a);var r=s.positions.length/3;s.positions.push(e[0],e[1],e[2]),s.normals.push(a[0],a[1],a[2]),s.texCoords2D[0].push(0,1),s.positions.push(t[0],t[1],t[2]),s.normals.push(a[0],a[1],a[2]),s.texCoords2D[0].push(1,1),s.positions.push(i[0],i[1],i[2]),s.normals.push(a[0],a[1],a[2]),s.texCoords2D[0].push(1,0),s.positions.push(n[0],n[1],n[2]),s.normals.push(a[0],a[1],a[2]),s.texCoords2D[0].push(0,0),s.faces.push(r+0,r+3,r+2),s.faces.push(r+2,r+1,r+0)}var r=new Mesh,s=new Submesh;s.positions=[],s.normals=[],s.texCoords2D=[[]];var a=vec3.create(),o=vec3.create(),h=vec3.create(),u=[vec3.fromValues(e[0]-t[0],e[1]-t[1],e[2]-t[2]),vec3.fromValues(e[0]+t[0],e[1]-t[1],e[2]-t[2]),vec3.fromValues(e[0]+t[0],e[1]+t[1],e[2]-t[2]),vec3.fromValues(e[0]-t[0],e[1]+t[1],e[2]-t[2]),vec3.fromValues(e[0]-t[0],e[1]-t[1],e[2]+t[2]),vec3.fromValues(e[0]+t[0],e[1]-t[1],e[2]+t[2]),vec3.fromValues(e[0]+t[0],e[1]+t[1],e[2]+t[2]),vec3.fromValues(e[0]-t[0],e[1]+t[1],e[2]+t[2])];n(u[0],u[1],u[2],u[3]),n(u[5],u[4],u[7],u[6]),n(u[4],u[0],u[3],u[7]),n(u[1],u[5],u[6],u[2]),n(u[4],u[5],u[1],u[0]),n(u[3],u[2],u[6],u[7]),s.calculateTangents(),s.recalculateBounds(),r.addSubmesh(s,i);var c=new Node("Box");return c.addComponent(new MeshComponent(r)),c.addComponent(new MeshRendererComponent),c},sphere:function(e,t,i,n){if(e<=0)throw"Primitives.sphere: invalid sphere radius";if(t<2||i<2)throw"Primitives.sphere: invalid sphere slices/stacks parameters (slices<2 or stacks<2)";var r=360/t,s=180/i,a=360/r*(180/s)*4,o=new Mesh,h=new Submesh;h.positions=new Float32Array(3*a),h.normals=new Float32Array(3*a),h.texCoords2D=[new Float32Array(2*a)];for(var u=Math.PI/180,c=0,l=vec3.create(),d=vec3.create(),f=vec3.create(),m=vec3.create(),p=0;p<180;p+=s)for(var g=0;g<360;g+=r)h.faces.push(c+0,c+1,c+2),h.faces.push(c+2,c+3,c+0),l[0]=e*Math.sin((p+s)*u)*Math.cos(u*(g+r)),l[1]=e*Math.cos((p+s)*u),l[2]=e*Math.sin((p+s)*u)*Math.sin(u*(g+r)),d[0]=e*Math.sin((p+s)*u)*Math.cos(g*u),d[1]=e*Math.cos((p+s)*u),d[2]=e*Math.sin((p+s)*u)*Math.sin(g*u),f[0]=e*Math.sin(p*u)*Math.cos(u*g),f[1]=e*Math.cos(p*u),f[2]=e*Math.sin(p*u)*Math.sin(u*g),m[0]=e*Math.sin(p*u)*Math.cos(u*(g+r)),m[1]=e*Math.cos(p*u),m[2]=e*Math.sin(p*u)*Math.sin(u*(g+r)),h.positions[3*(c+0)+0]=l[0],h.positions[3*(c+0)+1]=l[1],h.positions[3*(c+0)+2]=l[2],h.positions[3*(c+1)+0]=d[0],h.positions[3*(c+1)+1]=d[1],h.positions[3*(c+1)+2]=d[2],h.positions[3*(c+2)+0]=f[0],h.positions[3*(c+2)+1]=f[1],h.positions[3*(c+2)+2]=f[2],h.positions[3*(c+3)+0]=m[0],h.positions[3*(c+3)+1]=m[1],h.positions[3*(c+3)+2]=m[2],vec3.normalize(l,l),vec3.normalize(d,d),vec3.normalize(f,f),vec3.normalize(m,m),h.normals[3*(c+0)+0]=l[0],h.normals[3*(c+0)+1]=l[1],h.normals[3*(c+0)+2]=l[2],h.normals[3*(c+1)+0]=d[0],h.normals[3*(c+1)+1]=d[1],h.normals[3*(c+1)+2]=d[2],h.normals[3*(c+2)+0]=f[0],h.normals[3*(c+2)+1]=f[1],h.normals[3*(c+2)+2]=f[2],h.normals[3*(c+3)+0]=m[0],h.normals[3*(c+3)+1]=m[1],h.normals[3*(c+3)+2]=m[2],h.texCoords2D[0][2*(c+0)+0]=u*(g+r)/(2*Math.PI),h.texCoords2D[0][2*(c+0)+1]=(p+s)*u/Math.PI,h.texCoords2D[0][2*(c+1)+0]=g*u/(2*Math.PI),h.texCoords2D[0][2*(c+1)+1]=(p+s)*u/Math.PI,h.texCoords2D[0][2*(c+2)+0]=u*g/(2*Math.PI),h.texCoords2D[0][2*(c+2)+1]=p*u/Math.PI,h.texCoords2D[0][2*(c+3)+0]=u*(g+r)/(2*Math.PI),h.texCoords2D[0][2*(c+3)+1]=p*u/Math.PI,c+=4;h.calculateTangents(),h.recalculateBounds(),o.addSubmesh(h,n);var v=new Node("Sphere");return v.addComponent(new MeshComponent(o)),v.addComponent(new MeshRendererComponent),v},cone:function(e,t,i,n){if(e<=0)throw"Primitives.cone: invalid cone radius";if(0==t)throw"Primitives.cone: cannot create a cone with zero height";if(i<2)throw"Primitives.cone: invalid slices (slices<2)";var r=360/i,s=vec3.fromValues(0,t/2,0),a=vec3.fromValues(0,-t/2,0),o=360/r*6,h=new Mesh,u=new Submesh;u.positions=new Float32Array(3*o),u.normals=new Float32Array(3*o),u.texCoords2D=[new Float32Array(2*o)];for(var c=Math.PI/180,l=vec3.fromValues(a[0],.5*t-(e*e+t*t)/t,a[2]),d=0,f=vec3.create(),m=0;m<360;m+=r){u.faces.push(d+0,d+1,d+2),vec3.set(f,0,-1,0),u.positions[3*d+0]=e*Math.sin(m*c),u.positions[3*d+1]=a[1],u.positions[3*d+2]=e*Math.cos(m*c),u.normals[3*d+0]=f[0],u.normals[3*d+1]=f[1],u.normals[3*d+2]=f[2],u.texCoords2D[0][2*d+0]=m/360,u.texCoords2D[0][2*d+1]=1,d++,u.positions[3*d+0]=e*Math.sin((m+r)*c),u.positions[3*d+1]=a[1],u.positions[3*d+2]=e*Math.cos((m+r)*c),u.normals[3*d+0]=f[0],u.normals[3*d+1]=f[1],u.normals[3*d+2]=f[2],u.texCoords2D[0][2*d+0]=(m+r)/360,u.texCoords2D[0][2*d+1]=1,d++,u.positions[3*d+0]=a[0],u.positions[3*d+1]=a[1],u.positions[3*d+2]=a[2],u.normals[3*d+0]=f[0],u.normals[3*d+1]=f[1],u.normals[3*d+2]=f[2],u.texCoords2D[0][2*d+0]=m/360,u.texCoords2D[0][2*d+1]=0,d++,u.faces.push(d+0,d+1,d+2);var p=vec3.fromValues(e*Math.sin(m*c),a[1],e*Math.cos(m*c)),g=vec3.fromValues(e*Math.sin((m+r)*c),a[1],e*Math.cos((m+r)*c)),v=vec3.fromValues(s[0],s[1],s[2]);vec3.sub(f,p,l),vec3.normalize(f,f),u.positions[3*(d+0)+0]=p[0],u.positions[3*(d+0)+1]=p[1],u.positions[3*(d+0)+2]=p[2],u.normals[3*(d+0)+0]=f[0],u.normals[3*(d+0)+1]=f[1],u.normals[3*(d+0)+2]=f[2],u.texCoords2D[0][2*(d+0)+0]=m/360,u.texCoords2D[0][2*(d+0)+1]=1,vec3.sub(f,g,l),vec3.normalize(f,f),u.positions[3*(d+1)+0]=g[0],u.positions[3*(d+1)+1]=g[1],u.positions[3*(d+1)+2]=g[2],u.normals[3*(d+1)+0]=f[0],u.normals[3*(d+1)+1]=f[1],u.normals[3*(d+1)+2]=f[2],u.texCoords2D[0][2*(d+1)+0]=(m+r)/360,u.texCoords2D[0][2*(d+1)+1]=1,vec3.set(f,0,1,0),u.positions[3*(d+2)+0]=v[0],u.positions[3*(d+2)+1]=v[1],u.positions[3*(d+2)+2]=v[2],u.normals[3*(d+2)+0]=f[0],u.normals[3*(d+2)+1]=f[1],u.normals[3*(d+2)+2]=f[2],u.texCoords2D[0][2*(d+2)+0]=m/360,u.texCoords2D[0][2*(d+2)+1]=0,d+=3}u.calculateTangents(),u.recalculateBounds(),h.addSubmesh(u,n);var b=new Node("Cone");return b.addComponent(new MeshComponent(h)),b.addComponent(new MeshRendererComponent),b},text:function(e,t){var i=new Node("Text");return i.addComponent(new TextComponent(e,t)),i.addComponent(new TextRendererComponent),i},canvasBoard:function(e,t){var i=new Node("Text");return i.addComponent(new CanvasBoardComponent(e,t)),i.addComponent(new CanvasBoardRendererComponent),i}},CollisionOctreeNode=FrakClass.extend({init:function(e,t,i){this.parent=!1,this.depth=0,this.subnodes=!1,this.bounds=!1,i?(this.parent=i,this.root=i.root,this.depth=i.depth+1):(this.maxDepth=3,this.root=this,this.nodes={},this.submeshes={},this.cache=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()]),this.faces=!1,this.setSize(e,t)},clone:function(e){var t=new CollisionOctreeNode(this.bounds.center,this.bounds.size[0],e||!1);if(t.depth=this.depth,this.nodes){t.nodes={};for(var i in this.nodes)t.nodes[i]=this.nodes[i]}if(this.submeshes){t.submeshes={};for(var n in this.submeshes)t.submeshes[n]=this.submeshes[n]}if(t.faces=this.faces,this.subnodes){t.subnodes=[];for(var r=0;r<this.subnodes.length;r++)t.subnodes.push(this.subnodes[r].clone(t))}return t},getNodeID:function(){var e="/",t="root";if(this.parent){e=this.parent.getNodeID();for(var i in this.parent.subnodes)if(this.parent.subnodes[i]===this){t=i;break}}return"{0}{1}/".format(e,t)},setSize:function(e,t){this.bounds=new BoundingBox(e,[t,t,t])},isLeaf:function(){return!1===this.subnodes},hasGeometry:function(){return!1!==this.faces},subdivide:function(){this.subnodes=[];var e=.5*this.bounds.size[0],t=.5*e,i=vec3.create();this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[t,t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[-t,t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[t,-t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[-t,-t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[t,t,-t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[-t,t,-t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[t,-t,-t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(i,this.bounds.center,[-t,-t,-t]),e,this))},optimize:function(){if(!this.isLeaf()){for(var e in this.subnodes)this.subnodes[e].optimize();for(var t=0,e=0;e<this.subnodes.length;e++)!this.subnodes[e].hasGeometry()&&this.subnodes[e].isLeaf()&&t++;8==t&&(delete this.subnodes,this.subnodes=!1)}},rayIntersectBounds:function(e){var t=e.getDirection(this.root.cache[0]),i=this.root.cache[1],n=this.root.cache[2];t[0]=1/t[0],t[1]=1/t[1],t[2]=1/t[2],i[0]=(this.bounds.min[0]-e.origin[0])*t[0],n[0]=(this.bounds.max[0]-e.origin[0])*t[0],i[1]=(this.bounds.min[1]-e.origin[1])*t[1],n[1]=(this.bounds.max[1]-e.origin[1])*t[1],i[2]=(this.bounds.min[2]-e.origin[2])*t[2],n[2]=(this.bounds.max[2]-e.origin[2])*t[2];var r=Math.max(Math.min(i[0],n[0]),Math.min(i[1],n[1]),Math.min(i[2],n[2])),s=Math.min(Math.max(i[0],n[0]),Math.max(i[1],n[1]),Math.max(i[2],n[2]));return!(s<0||r>s)&&(e.infinite?r:!(r*r>vec3.sqrDist(e.origin,e.destination)&&(e.origin[0]<this.bounds.min[0]||e.origin[1]<this.bounds.min[1]||e.origin[2]<this.bounds.min[2]||e.origin[0]>this.bounds.max[0]||e.origin[1]>this.bounds.max[1]||e.origin[2]>this.bounds.max[2])&&(e.destination[0]<this.bounds.min[0]||e.destination[1]<this.bounds.min[1]||e.destination[2]<this.bounds.min[2]||e.destination[0]>this.bounds.max[0]||e.destination[1]>this.bounds.max[1]||e.destination[2]>this.bounds.max[2]))&&r)},rayIntersectGeometry:function(e){if(!this.hasGeometry())return!1;var t={submesh:!1,node:!1,t:1/0,normal:vec3.create()},i=this.root.cache[0],n=this.root.cache[1],r=this.root.cache[2],s=mat4.create();for(var a in this.faces){var o=e.clone();mat4.isIdentity(this.root.nodes[a].transform.absolute)||(mat4.invert(s,this.root.nodes[a].transform.absolute),o.transform(s));for(var h in this.faces[a])for(var u=this.faces[a][h],c=this.root.submeshes[h].positions,l=0;l<u.length;l+=3){i[0]=c[3*u[l]],i[1]=c[3*u[l]+1],i[2]=c[3*u[l]+2],n[0]=c[3*u[l+1]],n[1]=c[3*u[l+1]+1],n[2]=c[3*u[l+1]+2],r[0]=c[3*u[l+2]],r[1]=c[3*u[l+2]+1],r[2]=c[3*u[l+2]+2];var d=o.intersectTriangleDistanceOnly(i,n,r);!1!==d&&d<t.t&&(t.t=d,t.submesh=this.root.submeshes[h],t.node=this.root.nodes[a],vec3.cross(t.normal,vec3.subtract(this.root.cache[3],n,i),vec3.subtract(this.root.cache[4],r,i)),vec3.normalize(t.normal,t.normal))}}return t},getNodesWithGeometry:function(e,t){var i=this.rayIntersectBounds(e);if(!1!==i){if(this.hasGeometry()){for(n=0;n<t.length&&!(t[n].t>i);n++);t.splice(n,0,{t:i,octreeNode:this})}if(!this.isLeaf())for(var n=0;n<this.subnodes.length;n++)this.subnodes[n].getNodesWithGeometry(e,t)}},getNearestRayCollision:function(e,t){var i=[];this.getNodesWithGeometry(e,i);for(var n={t:1/0,octreeNode:!1,submesh:!1,node:!1,normal:!1},r=0;r<i.length;r++)if(!(!1!==n.octreeNode&&i[r].depth==n.octreeNode.depth&&i[r].t>n.t)){var s=i[r].octreeNode.rayIntersectGeometry(t);s.t<n.t&&(n.t=s.t,n.submesh=s.submesh,n.octreeNode=i[r].octreeNode,n.node=s.node,n.normal=s.normal)}return n}}),Component=Serializable.extend({init:function(){this._super(),this.updatePasses=1,this.started=!1,this.node=!1,this.enable()},excluded:function(){return["started","node"]},getScene:function(){return this.node.scene},enable:function(){this.enabled||this.onEnable(),this.enabled=!0},disable:function(){this.enabled&&this.onDisable(),this.enabled=!1},instantiate:function(){return this.clone()},onAdd:function(e){},onRemove:function(e){},onAddScene:function(e){},onRemoveScene:function(e){},onEnable:function(){},onDisable:function(){},onStart:function(e,t){},start:function(e,t){this.onStart(e,t)},onLoad:function(e,t){},onEnd:function(e,t){},onPreRender:function(e,t){},onPostRender:function(e,t){},onUpdateTransform:function(e){},onUpdate:function(e,t){}}),Transform=Component.extend({init:function(e){this._super(),this.relative=e||mat4.identity(mat4.create()),this.absolute=mat4.copy(mat4.create(),this.relative)},onAdd:function(e){e.transform=this},type:function(){return"Transform"},excluded:function(){return this._super().concat(["absolute"])},calculateRelativeFromAbsolute:function(e){if(e){var t=mat4.invert(mat4.create(),e);mat4.multiply(this.relative,this.absolute,t)}else mat4.copy(this.relative,this.absolute)},getPosition:function(e){return e||(e=vec3.create()),mat4.translation(e,this.absolute)},getRelativePosition:function(e){return e||(e=vec3.create()),mat4.translation(e,this.relative)},setPosition:function(e){mat4.fromRotationTranslation(this.relative,quat.fromMat4(quat.create(),this.relative),e)},getRotation:function(e){return e||(e=quat.create()),quat.fromMat4(e,this.absolute)},translate:function(e){this.relative=mat4.translate(this.relative,this.relative,e)},rotate:function(e,t){this.relative=mat4.rotate(this.relative,this.relative,e,t)},scale:function(e){this.relative=mat4.scale(this.relative,this.relative,e)},clone:function(){var e=new Transform;return e.relative=mat4.clone(this.relative),e.absolute=mat4.clone(this.absolute),e}}),CameraComponent=Component.extend({init:function(e,t){if(!e||!t)throw"CameraComponent can be initialized only with given viewMatrix and projectionMatrix. Normally one should create OrthoCamera or PerspectiveCamera instead";this._super(),this.camera=new Camera(e,t,new ForwardRenderStage)},excluded:function(){return this._super().concat(["camera"])},type:function(){return"CameraComponent"},onAddScene:function(e){e.scene.cameras.push(this.camera),e.scene.cameras.sort(function(e,t){return e.order-t.order}),this.useCameraViewMatrix()},onRemoveScene:function(e){for(var t=e.scene.cameras,i=0;i<t.length;i++)t[i]==this.camera&&(t.splice(i,1),i--)},onStart:function(e,t){this.initRenderStage(e,t)},onUpdateTransform:function(e){this.node.transform&&mat4.invert(this.camera.viewMatrix,this.node.transform.absolute)},lookAt:function(e,t){t||(t=[0,1,0]),mat4.lookAt(this.camera.viewMatrix,this.camera.getPosition(),e,t),this.useCameraViewMatrix()},setPosition:function(e){this.camera.setPosition(e),this.useCameraViewMatrix()},center:function(e){this.camera.center(e),this.useCameraViewMatrix()},fitToView:function(e){this.camera.fitToView(e),this.useCameraViewMatrix()},fitNodeToView:function(e){var t=new BoundingBox;e.onEachChild(function(e){if(e.getComponent(MeshComponent)){var i=e.getComponent(MeshComponent);t.encapsulateBox(i.mesh.boundingBox.transform(e.transform.absolute))}}),this.fitToView(t)},screenPointToViewportPoint:function(e){var t=vec2.create(),i=vec2.create();this.camera.target instanceof TargetScreen&&(i=this.camera.target.getPosition());var n=this.camera.target.getSize();return Math.abs(n[0])<EPSILON||Math.abs(n[1])<EPSILON?t:(t[0]=(e[0]-i[0])/n[0],t[1]=(e[1]-i[1])/n[1],t)},unprojectScreenPoint:function(e){var t=this.node.scene.camera.target.getSize(),i=vec2.create(),n=vec2.fromValues(e[0]-i[0],t[1]-e[1]+i[1]);if(Math.abs(t[0])<EPSILON||Math.abs(t[1])<EPSILON)return!1;var r=vec4.fromValues(n[0]/t[0]*2-1,n[1]/t[1]*2-1,2*e[2]-1,1),s=mat4.mul(mat4.create(),this.camera.projectionMatrix,this.camera.viewMatrix);return!!mat4.invert(s,s)&&(vec4.transformMat4(r,r,s),!(Math.abs(r[3])<EPSILON)&&(r[3]=1/r[3],vec3.fromValues(r[0]*r[3],r[1]*r[3],r[2]*r[3])))},screenPointToRay:function(e){var t=this.unprojectScreenPoint([e[0],e[1],0]),i=this.unprojectScreenPoint([e[0],e[1],1]);return!(!t||!i)&&new Ray(t,i)},worldToScreenPoint:function(e,t){t||(t=vec2.create());var i=this.camera.target.getSize(),n=mat4.mul(mat4.create(),this.camera.projectionMatrix,this.camera.viewMatrix),r=vec4.fromValues(e[0],e[1],e[2],1);return vec4.transformMat4(r,r,n),r[0]/=r[3],r[1]/=r[3],r[2]/=r[3],t[0]=Math.round((r[0]+1)/2*i[0]),t[1]=Math.round((1-r[1])/2*i[1]),t},useCameraViewMatrix:function(){this.node.transform&&(this.node.transform.absolute=mat4.invert(mat4.create(),this.camera.viewMatrix),this.node.calculateRelativeFromAbsolute())},initRenderStage:function(e,t){if(this.camera.target instanceof TargetScreen){var i=e.canvas;this.camera.target.setSize(i.width,i.height)}"forward"==t.options.renderer?("blended"!=t.options.transparencyMode&&"stochastic"!=t.options.transparencyMode||this.camera.renderStage.addStage(new OITPostProcess),!0===t.options.ssao&&this.camera.renderStage.addStage(new SSAOPostProcess)):"deferred"==t.options.renderer&&(delete this.camera.renderStage,this.camera.renderStage=new DeferredRenderStage,this.camera.renderStage.addStage(new OITPostProcess)),!0===t.options.antialias&&this.camera.renderStage.addStage(new AntiAliasPostProcess),this.camera.renderStage.start(e,t,this.camera)},onContextRestored:function(e){this.camera.renderStage=new ForwardRenderStage,this.initRenderStage(e,e.engine)}}),PerspectiveCamera=CameraComponent.extend({init:function(e,t,i,n){e||(e=45),i||(i=.3),n||(n=1e3),t||(t=4/3),this.fov=e,this.aspect=t,this.near=i,this.far=n;var r=mat4.create();mat4.lookAt(r,[0,0,-100],[0,0,0],[0,1,0]),this._super(r,this.calculatePerspective()),this.camera.near=this.near,this.camera.far=this.far},type:function(){return"PerspectiveCamera"},onStart:function(e,t){this.aspect||this.setAspectRatio(e.canvas.width/e.canvas.height),this._super(e,t)},setClipPlanes:function(e,t){this.near=e,this.far=t,this.camera.near=this.near,this.camera.far=this.far,this.camera.projectionMatrix=this.calculatePerspective()},setAspectRatio:function(e){this.aspect=e,this.camera.projectionMatrix=this.calculatePerspective()},setVerticalFieldOfView:function(e){this.fov=e,this.camera.projectionMatrix=this.calculatePerspective()},setHorizontalFieldOfView:function(e){e=e*(2*Math.PI)/360;var t=Math.tan(e/2)/this.aspect;this.fov=2*Math.atan(t)*180/Math.PI,this.camera.projectionMatrix=this.calculatePerspective()},getVerticalFieldOfView:function(){return 180*this.camera.getFieldOfView()/Math.PI},getHorizontalFieldOfView:function(){var e=Math.tan(.5*this.camera.getFieldOfView()),t=this.aspect*e;return 180*(2*Math.atan(t))/Math.PI},calculatePerspective:function(){var e=mat4.create(),t=this.aspect;return t||(t=1),mat4.perspective(e,this.fov*(2*Math.PI)/360,t,this.near,this.far),e}}),OrthoCamera=CameraComponent.extend({init:function(e,t,i,n,r,s){e||(e=0),t||(t=512),i||(i=512),n||(n=0),r||(r=-100),s||(s=100);var a=mat4.ortho(mat4.create(),e,t,i,n,r,s);this._super(mat4.identity(mat4.create()),a)},type:function(){return"OrthoCamera"}}),MeshComponent=Component.extend({init:function(e){this.mesh=e,this._super()},type:function(){return"MeshComponent"},instantiate:function(){var e=this._super();return e.mesh=this.mesh,e}}),RendererComponent=Component.extend({init:function(){this._super(),this.castShadows=!0,this.receiveShadows=!0,this.lightContribution=1},type:function(){return"RendererComponent"},instantiate:function(){var e=this._super();return e.castShadows=this.castShadows,e.receiveShadows=this.receiveShadows,e.lightContribution=this.lightContribution,e},onContextRestored:function(e){}}),MeshRendererComponent=RendererComponent.extend({init:function(){this.meshRenderers=[],this._super()},type:function(){return"MeshRendererComponent"},excluded:function(){return this._super().concat(["meshRenderers"])},createRenderer:function(e,t,i,n){return new SubmeshRenderer(e,t,i,n)},onStart:function(e,t){this.updateRenderers(e,t)},addRenderers:function(e,t){var i=this;this.node.onEachComponent(function(t){if(t instanceof MeshComponent)for(var n=0;n<t.mesh.submeshes.length;n++){var r=t.mesh.submeshes[n],s=t.mesh.getMaterial(r.materialIndex);if(s){if(0!=r.positions.length&&0!=r.faces.length){var a=i.createRenderer(e,i.node.transform.absolute,r,s);i.getScene().dynamicSpace.addRenderer(a),i.meshRenderers.push(a),i.enabled||(a.visible=!1)}}else console.warn("Failed to find submesh material: ",t.node.name,t.node)}})},removeRenderers:function(){for(var e=0;e<this.meshRenderers.length;e++)this.getScene().dynamicSpace.removeRenderer(this.meshRenderers[e])},updateRenderers:function(e,t){this.removeRenderers(),this.addRenderers(e,t)},onEnd:function(e){this.removeRenderers()},onUpdateTransform:function(e){for(var t=0,i=this.meshRenderers.length;t<i;t++)this.meshRenderers[t].layer=this.node.layer,this.meshRenderers[t].castShadows=this.castShadows,this.meshRenderers[t].receiveShadows=this.receiveShadows,this.meshRenderers[t].lightContribution=this.lightContribution,this.meshRenderers[t].setMatrix(e)},onEnable:function(){for(var e=0;e<this.meshRenderers.length;e++)this.meshRenderers[e].visible=!0},onDisable:function(){for(var e=0;e<this.meshRenderers.length;e++)this.meshRenderers[e].visible=!1},getBoundingBox:function(e){for(var t=new BoundingBox,i=0;i<this.meshRenderers.length;i++)e&&!this.meshRenderers[i].visible||t.encapsulateBox(this.meshRenderers[i].globalBoundingBox);return t},getBoundingSphere:function(e){for(var t=new BoundingSphere,i=0;i<this.meshRenderers.length;i++)e&&!this.meshRenderers[i].visible||t.encapsulateSphere(this.meshRenderers[i].globalBoundingSphere);return t},setTransparency:function(e){e=!!e;for(var t=0;t<this.meshRenderers.length;t++)this.meshRenderers[t].transparent=e},getSubmeshRenderer:function(e){for(var t=0;t<this.meshRenderers.length;t++)if(this.meshRenderers[t].submesh===e)return this.meshRenderers[t];return!1},onContextRestored:function(e){this._super(e);for(var t=0;t<this.meshRenderers.length;++t)this.meshRenderers[t].onContextRestored(e)}}),SkyboxComponent=Component.extend({init:function(){this._super()},type:function(){return"SkyboxComponent"},setup:function(e,t,i){function n(e,t,i,n,r){var s=new Submesh;s.positions=[],s.normals=[],s.texCoords2D=[[]],vec3.sub(u,t,e),vec3.sub(c,n,e),vec3.cross(h,u,c),vec3.negate(h,h),vec3.normalize(h,h);var a=s.positions.length/3;s.positions.push(e[0],e[1],e[2]),s.normals.push(h[0],h[1],h[2]),s.texCoords2D[0].push(0,1),s.positions.push(t[0],t[1],t[2]),s.normals.push(h[0],h[1],h[2]),s.texCoords2D[0].push(1,1),s.positions.push(i[0],i[1],i[2]),s.normals.push(h[0],h[1],h[2]),s.texCoords2D[0].push(1,0),s.positions.push(n[0],n[1],n[2]),s.normals.push(h[0],h[1],h[2]),s.texCoords2D[0].push(0,0),s.faces.push(a+0,a+3,a+2),s.faces.push(a+2,a+1,a+0),s.recalculateBounds(),o.addSubmesh(s,r)}this.meshNode=new Node("Skybox");var r=[0,0,0],s=1;t.scene&&t.scene.camera&&t.scene.camera.far&&(s=Math.sqrt(t.scene.camera.far*t.scene.camera.far/3));for(var a=[s,s,s],o=new Mesh,h=vec3.create(),u=vec3.create(),c=vec3.create(),l=[vec3.fromValues(r[0]-a[0],r[1]-a[1],r[2]-a[2]),vec3.fromValues(r[0]+a[0],r[1]-a[1],r[2]-a[2]),vec3.fromValues(r[0]+a[0],r[1]+a[1],r[2]-a[2]),vec3.fromValues(r[0]-a[0],r[1]+a[1],r[2]-a[2]),vec3.fromValues(r[0]-a[0],r[1]-a[1],r[2]+a[2]),vec3.fromValues(r[0]+a[0],r[1]-a[1],r[2]+a[2]),vec3.fromValues(r[0]+a[0],r[1]+a[1],r[2]+a[2]),vec3.fromValues(r[0]-a[0],r[1]+a[1],r[2]+a[2])],d={ambient:new UniformColor(new Color),diffuse:new UniformColor(new Color)},f=[e.texturesManager.addDescriptor(i[0]),e.texturesManager.addDescriptor(i[1]),e.texturesManager.addDescriptor(i[2]),e.texturesManager.addDescriptor(i[3]),e.texturesManager.addDescriptor(i[4]),e.texturesManager.addDescriptor(i[5])],m=0;m<f.length;m++)f[m].clampToEdge=!0;n(l[3],l[2],l[1],l[0],new Material(e.addShaderSource("diffuse"),d,[new Sampler("diffuse0",f[0])])),n(l[6],l[7],l[4],l[5],new Material(e.addShaderSource("diffuse"),d,[new Sampler("diffuse0",f[1])])),n(l[7],l[3],l[0],l[4],new Material(e.addShaderSource("diffuse"),d,[new Sampler("diffuse0",f[2])])),n(l[2],l[6],l[5],l[1],new Material(e.addShaderSource("diffuse"),d,[new Sampler("diffuse0",f[3])])),n(l[0],l[1],l[5],l[4],new Material(e.addShaderSource("diffuse"),d,[new Sampler("diffuse0",f[4])])),n(l[7],l[6],l[2],l[3],new Material(e.addShaderSource("diffuse"),d,[new Sampler("diffuse0",f[5])])),this.meshNode.addComponent(new MeshComponent(o));var p=this.meshNode.addComponent(new MeshRendererComponent);this.node.addNode(this.meshNode),p.castShadows=!1,p.disable(),p.addRenderers(t.context,t)}}),TextRendererComponent=MeshRendererComponent.extend({type:function(){return"TextRendererComponent"},onContextRestored:function(e){this._super(e);var t=this.node.getComponent(TextComponent);t&&t.updateText()}}),CanvasBoardRendererComponent=MeshRendererComponent.extend({type:function(){return"CanvasBoardRendererComponent"}}),TextComponent=MeshComponent.extend({init:function(e,t){this._super(new Mesh),this.context=!1,this.material=!1,this.texture=!1,this.wrap=t?0:t,this.sampler=new Sampler("diffuse0",null),this.lines=[],this.color=new Color(0,0,0,1),this.fontSize=56,this.style="normal",this.variant="normal",this.weight="normal",this.family="monospace",this.backgroundColor=new Color(0,0,0,0),this.outline=!0,this.outlineColor=new Color(1,1,1,1),this.outlineWidth=5,this.textLength=0,this.setText(e)},excluded:function(){return this._super().concat(["material","texture","sampler","context"])},type:function(){return"TextComponent"},applyTextStyles:function(e){this.outline&&(e.strokeStyle=this.outlineColor.toString(),e.lineWidth=this.outlineWidth),e.fillStyle=this.color.toString(),e.textBaseline="middle",e.textAlign="center",e.font=this.font},updateFont:function(){this.font="","normal"!=this.style&&(this.font+=this.style+" "),"normal"!=this.variant&&(this.font+=this.variant+" "),"normal"!=this.weight&&(this.font+=this.weight+" "),this.font+=this.fontSize+"px "+this.family},updateText:function(){if(this.context&&0!=this.text.length){var e=this.node.getComponent(TextRendererComponent);if(e){this.updateFont();var t=document.createElement("canvas"),i=t.getContext("2d");this.applyTextStyles(i),this.wrap?this.lines=this.getLines(this.text):this.textLength=i.measureText(this.text).width,t.width=nextHighestPowerOfTwo(i.measureText(this.text).width),t.height=nextHighestPowerOfTwo(2*this.fontSize),i.fillStyle=this.backgroundColor.toString(),i.fillRect(0,0,t.width,t.height),this.applyTextStyles(i),this.outline&&i.strokeText(this.text,t.width/2,t.height/2),i.fillText(this.text,t.width/2,t.height/2),this.texture.setImage(this.context,t);var n=t.width/t.height,r=this.mesh.submeshes[0];r.positions[0]=-.5*n,r.positions[1]=-.5,r.positions[3]=-.5*n,r.positions[4]=.5,r.positions[6]=.5*n,r.positions[7]=.5,r.positions[9]=.5*n,r.positions[10]=-.5,r.recalculateBounds(),e.meshRenderers.length>0&&e.meshRenderers[0].buffer.update("position",r.positions)}}},onStart:function(e,t){this.context=e,this.material=new Material(t.assetsManager.addShaderSource("transparent"),{diffuse:new UniformColor({r:1,g:1,b:1,a:1})},[this.sampler]),this.material.shader.requirements.transparent=!0,this.material.name="TextComponentMaterial",this.texture=new Texture(e),this.texture.mipmapped=!0,this.texture.clampToEdge=!0,this.sampler.texture=this.texture;var i=new Submesh;i.positions=new Float32Array(12),i.normals=[0,0,1,0,0,1,0,0,1,0,0,1],i.texCoords2D=[[0,0,0,1,1,1,1,0]],i.faces=[0,1,2,0,2,3],i.recalculateBounds(),this.mesh.addSubmesh(i,this.material),this.updateText()},setText:function(e){this.text=String(e),this.updateText()},getLines:function(e,t){var i=e.split(" "),n=[],r=i[0];if(t<=0)return i;if(i.length<=t)return i;for(var s=1;s<i.length;s++)r.length>e.length/t?(n.push(r),r=""):r+=" "+i[s];return n.push(r),n},onContextRestored:function(e){this.texture&&delete this.texture,this.texture=new Texture(e),this.texture.mipmapped=!0,this.texture.clampToEdge=!0,this.sampler.texture=this.texture}}),LineRendererComponent=RendererComponent.extend({init:function(e){this._super(),this.lightContribution=0,this.receiveShadows=!1,this.castShadows=!1,this.color=new UniformColor(e instanceof Color?e:new Color(.5,.5,.5,1)),this.renderer=null,this.damaged=!0,this.material=new Material(null,{diffuse:this.color},[]),this.overlay=!1,this.faces=[],this.vertices=[]},type:function(){return"LineRendererComponent"},excluded:function(){return this._super().concat(["damaged","renderer","material"])},onStart:function(e,t){this.material.shader=t.assetsManager.addShaderSource("transparent"),this.material.samplers=[new Sampler("diffuse0",t.WhiteTexture)],this.renderer||(this.renderer=new LineRenderer(e,this.node.transform.absolute,this.material)),this.getScene().dynamicSpace.addRenderer(this.renderer)},onEnd:function(e){this.renderer&&this.getScene().dynamicSpace.removeRenderer(this.renderer),delete this.renderer,this.renderer=null},onUpdate:function(e,t){this.damaged&&this.rebuild(e)},onUpdateTransform:function(e){this.renderer&&(this.renderer.layer=this.node.layer,this.renderer.castShadows=this.castShadows,this.renderer.receiveShadows=this.receiveShadows,this.renderer.lightContribution=this.lightContribution,this.renderer.setMatrix(e))},onEnable:function(){this.renderer&&(this.renderer.visible=!0)},onDisable:function(){this.renderer&&(this.renderer.visible=!1)},onPostRender:function(e,t){this.overlay&&this.renderer&&this.enabled&&(e.projection.push(),e.modelview.push(),e.projection.load(t.projectionMatrix),e.modelview.load(t.viewMatrix),e.modelview.multiply(this.node.transform.absolute),this.material.bind(),this.renderer.renderGeometry(e,this.material.shader),this.material.unbind(),e.projection.pop(),e.modelview.pop())},rebuild:function(e){0!=this.vertices.length&&0!=this.faces.length&&(this.renderer||(this.renderer=new LineRenderer(e,this.node.transform.absolute,this.material)),this.renderer.buffer.updateFaces(this.faces),this.renderer.buffer.has("position")?this.renderer.buffer.update("position",this.vertices):this.renderer.buffer.add("position",this.vertices,3),this.damaged=!1)},clear:function(e){this.faces=[],this.vertices=[],this.damaged=!0},addLine:function(e,t){var i=this.vertices.length/3,n={vertexOffset:i};return this.vertices.push(e[0],e[1],e[2],t[0],t[1],t[2]),this.faces.push(i,i+1),this.damaged=!0,n},updateLine:function(e,t,i){var n=function(e,t,i){e[3*t+0]=i[0],e[3*t+1]=i[1],e[3*t+2]=i[2]};n(this.vertices,e.vertexOffset+0,t),n(this.vertices,e.vertexOffset+1,i),this.damaged=!0},addTriangle:function(e,t,i){this.addLine(e,t),this.addLine(t,i),this.addLine(i,e),this.damaged=!0},addBox:function(e){if(!(e instanceof BoundingBox))throw"LineRendererComponent.addBox expects box to be of type BoundingBox";this.addLine(e.min,[e.min[0],e.min[1],e.max[2]]),this.addLine(e.min,[e.min[0],e.max[1],e.min[2]]),this.addLine(e.min,[e.max[0],e.min[1],e.min[2]]),this.addLine(e.max,[e.max[0],e.min[1],e.max[2]]),this.addLine(e.max,[e.max[0],e.max[1],e.min[2]]),this.addLine(e.max,[e.min[0],e.max[1],e.max[2]]),this.addLine([e.min[0],e.max[1],e.min[2]],[e.min[0],e.max[1],e.max[2]]),this.addLine([e.min[0],e.max[1],e.max[2]],[e.min[0],e.min[1],e.max[2]]),this.addLine([e.min[0],e.min[1],e.max[2]],[e.max[0],e.min[1],e.max[2]]),this.addLine([e.max[0],e.min[1],e.max[2]],[e.max[0],e.min[1],e.min[2]]),this.addLine([e.max[0],e.min[1],e.min[2]],[e.max[0],e.max[1],e.min[2]]),this.addLine([e.max[0],e.max[1],e.min[2]],[e.min[0],e.max[1],e.min[2]]),this.damaged=!0},addGrid:function(e,t,i){var n=[t[0]/2,t[1]/2];i||(i=[1,1]);for(var r=-n[0];r<=n[0];r++)this.addLine([r*i[0]+e[0],e[1],-n[1]*i[1]+e[2]],[r*i[0]+e[0],e[1],n[1]*i[1]+e[2]]);for(r=-n[1];r<=n[1];r++)this.addLine([-n[0]*i[0]+e[0],e[1],r*i[1]+e[2]],[n[0]*i[0]+e[0],e[1],r*i[1]+e[2]]);this.damaged=!0},onContextRestored:function(e){this._super(e),this.renderer&&(this.damaged=!0,delete this.renderer.buffer,this.renderer.buffer=new LinesRenderBuffer(e),this.rebuild(e))}}),CanvasBoardComponent=MeshComponent.extend({init:function(e,t){this._super(new Mesh),this.width=e,this.height=t||e,this.context=!1,this.material=!1,this.texture=!1,this.canvasContext=!1,this.canvas=!1,this.sampler=new Sampler("diffuse0",null)},excluded:function(){return this._super().concat(["material","texture","sampler","context"])},type:function(){return"CanvasBoardComponent"},createContext:function(){if(this.context){var e=this.node.getComponent(CanvasBoardRendererComponent);if(e){this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvasContext.fillStyle="white",this.canvasContext.fillRect(0,0,this.canvas.width,this.canvas.height);var t=this.mesh.submeshes[0];t.positions[0]=-.5,t.positions[1]=-.5,t.positions[3]=-.5,t.positions[4]=.5,t.positions[6]=.5,t.positions[7]=.5,t.positions[9]=.5,t.positions[10]=-.5,t.recalculateBounds(),this.texture.setImage(this.context,this.canvas),e.meshRenderers.length>0&&e.meshRenderers[0].buffer.update("position",t.positions)}}},updateImage:function(){this.texture.setImage(this.context,this.canvas)},onStart:function(e,t){this.context=e,this.material=new Material(t.assetsManager.addShaderSource("transparent"),{diffuse:new UniformColor({r:1,g:1,b:1,a:1})},[this.sampler]),this.material.shader.requirements.transparent=!0,this.material.name="CanvasBoardMaterial",this.texture=new Texture(e),this.texture.mipmapped=!0,this.texture.clampToEdge=!0,this.sampler.texture=this.texture;var i=new Submesh;i.positions=new Float32Array(12),i.normals=[0,0,1,0,0,1,0,0,1,0,0,1],i.texCoords2D=[[0,0,0,1,1,1,1,0]],i.faces=[0,1,2,0,2,3],i.recalculateBounds(),this.mesh.addSubmesh(i,this.material),this.createContext()},getCanvasContext:function(){return this.canvasContext}}),Controller=Component.extend({init:function(){this._super(),this.delta=vec2.create(),this.dragDelta=vec2.create(),this.position=!1,this.oldPosition=!1,this.startDragPosition=!1,this.buttons=[!1,!1,!1]},excluded:function(){return this._super().concat(["delta","dragDelta","position","oldPosition","startDragPosition","buttons","keyStates"])},type:function(){return"Controller"},onAddScene:function(e){e.scene.engine.input.registerController(this)},onRemoveScene:function(e){e.scene.engine.input.unregisterController(this)},bind:function(e,t,i){this.node&&e&&t&&i&&this.node.scene.engine.input.bind(e,t,i)},getPriority:function(e){return 0},onStart:function(e,t){for(var i=0;i<this.buttons.length;i++)this.buttons[i]=!1},onUpdate:function(e){},onKeyStateChange:function(e,t){},onKeyDown:function(e){},onKeyUp:function(e){},onButtonDown:function(e,t,i){},onButtonUp:function(e,t,i){},onClick:function(e,t,i){},onMouseMove:function(e,t,i){},onMouseDown:function(e,t,i){this.buttons[t]=!0},onMouseUp:function(e,t,i){this.buttons[t]=!1}}),FlightController=Controller.extend({init:function(){this._super(),this.rotation=vec3.create(),this.velocity=vec3.fromValues(0,0,0),this.angularVelocity=vec3.fromValues(0,0,0),this.acceleration=.2,this.deceleration=.2,this.friction=.01,this.rotationAcceleration=.001,this.rotationFriction=.1,this.tmpRotation=quat.create(),this.tmpImpulse=vec3.create()},type:function(){return"FlightController"},onAdd:function(){this._super(),this.bind("W","accelerate",this),this.bind("S","decelerate",this),this.bind("A","strafeLeft",this),this.bind("D","strafeRight",this),this.bind("C","moveDown",this),this.bind("space","moveUp",this),this.bind("up_arrow","accelerate",this),this.bind("down_arrow","decelerate",this),this.bind("left_arrow","strafeLeft",this),this.bind("right_arrow","strafeRight",this)},accelerate:function(e){this.addLocalImpulse([0,0,-this.acceleration*e])},decelerate:function(e){this.addLocalImpulse([0,0,this.deceleration*e])},strafeLeft:function(e){this.addLocalImpulse([-this.deceleration*e,0,0])},strafeRight:function(e){this.addLocalImpulse([this.deceleration*e,0,0])},moveUp:function(e){this.addWorldImpulse([0,this.acceleration*e,0])},moveDown:function(e){this.addWorldImpulse([0,-this.acceleration*e,0])},addWorldImpulse:function(e){vec3.add(this.velocity,this.velocity,e)},addLocalImpulse:function(e){quat.fromMat4(this.tmpRotation,this.node.transform.absolute),vec3.transformQuat(this.tmpImpulse,e,this.tmpRotation),vec3.add(this.velocity,this.velocity,this.tmpImpulse)},onStep:function(e,t,i){return!0},onUpdate:function(e,t){this._super(e,t);var i=e.fps.getDelta(),n=1+this.friction*i;vec3.scale(this.velocity,this.velocity,1/n);var r=1+this.rotationFriction*i;vec3.scale(this.angularVelocity,this.angularVelocity,1/r);var s=vec3.scale(vec3.create(),this.velocity,i),a=vec3.scale(vec3.create(),this.angularVelocity,i);vec3.add(this.rotation,this.rotation,a);var o=quat.create();quat.rotateY(o,o,this.rotation[1]),quat.rotateX(o,o,this.rotation[0]);var h=mat4.translation(vec3.create(),this.node.transform.relative),u=vec3.add(vec3.create(),s,h);this.onStep(h,u,o)&&mat4.fromRotationTranslation(this.node.transform.relative,o,u)},onMouseMove:function(e,t,i){if(0===t){var n=vec3.create(),r=this.rotationAcceleration;vec3.scale(n,[-i[1],-i[0],0],r),vec3.add(this.angularVelocity,this.angularVelocity,n)}}}),OrbitController=FlightController.extend({init:function(){this._super(),this.target=new TypeReference("Transform"),this.panButton=2,this.rotateButton=0,this.position=vec3.create(),this.velocity=vec3.create(),this.pan=vec3.create(),this.minimumPan=[-100,-100,-100],this.maximumPan=[100,100,100],this.panXAxis=[1,0,0],this.panYAxis=[0,0,1],this.panSpeed=.05,this.rotation=vec3.create(),this.angularVelocity=vec3.create(),this.minimumPitch=-Math.PI/2.2,this.maximumPitch=0,this.rotationAcceleration=.012,this.rotationFriction=.1,this.lastPinch=0,this.zoomSpeed=1,this.doZoomIn=!1,this.doZoomOut=!1,this.distance=5,this.minimumDistance=2.5,this.maximumDistance=7.5,this.distanceSteps=4,this.direction=vec3.create(),this.cameraPosition=vec3.create(),this.targetPosition=vec3.create(),this.lookat=mat4.create(),this.tmpRotation=quat.create(),this.cbOnChange},excluded:function(){return this._super().concat(["velocity","angularVelocity","doZoomIn","doZoomOut","direction","cameraPosition","targetPosition","lookat"])},type:function(){return"OrbitController"},onAdd:function(){this._super(),this.bind("W","zoomIn",this),this.bind("S","zoomOut",this),this.bind("A","rotateLeft",this),this.bind("D","rotateRight",this),this.bind("E","rotateUp",this),this.bind("Q","rotateDown",this)},onChange:function(e,t){this.cbOnChange&&"function"==typeof this.cbOnChange&&this.cbOnChange(e,t)},getZoom:function(){return(this.distance-this.minimumDistance)/(this.maximumDistance-this.minimumDistance)},setZoom:function(e){e=Math.max(0,e);var t=this.maximumDistance-this.minimumDistance;this.distance=Math.min(this.minimumDistance+t*e,this.maximumDistance),this.onChange("distance",this.distance)},setDistance:function(e){this.distance=Math.min(Math.max(e,this.minimumDistance),this.maximumDistance),this.onChange("distance",this.distance)},zoomIn:function(e){this.enabled&&(e||(e=1),this.distance-=e*this.zoomSpeed*(this.maximumDistance-this.minimumDistance)/this.distanceSteps,this.distance<this.minimumDistance&&(this.distance=this.minimumDistance),this.onChange("distance",this.distance))},zoomOut:function(e){this.enabled&&(e||(e=1),this.distance+=e*this.zoomSpeed*(this.maximumDistance-this.minimumDistance)/this.distanceSteps,this.distance>this.maximumDistance&&(this.distance=this.maximumDistance),this.onChange("distance",this.distance,e*this.zoomSpeed*(this.maximumDistance-this.minimumDistance)/this.distanceSteps))},rotateLeft:function(e){this.accelerate([0,-this.rotationAcceleration,0],e)},rotateRight:function(e){this.accelerate([0,this.rotationAcceleration,0],e)},rotateUp:function(e){this.accelerate([this.rotationAcceleration,0,0],e)},rotateDown:function(e){this.accelerate([-this.rotationAcceleration,0,0],e)},accelerate:function(e,t){this.enabled&&(vec3.scale(e,e,t),vec3.add(this.angularVelocity,this.angularVelocity,e),this.onChange("accelerate",e))},onUpdate:function(e,t){this._super(e,t),this.target.isNull()||(vec3.add(this.rotation,this.rotation,this.angularVelocity),quat.identity(this.tmpRotation),quat.rotateY(this.tmpRotation,this.tmpRotation,this.rotation[1]),quat.rotateX(this.tmpRotation,this.tmpRotation,this.rotation[0]),vec3.set(this.direction,0,0,1),vec3.transformQuat(this.direction,this.direction,this.tmpRotation),vec3.scale(this.direction,this.direction,this.distance),mat4.translation(this.targetPosition,this.target.value.absolute),vec3.add(this.cameraPosition,this.targetPosition,this.direction),vec3.add(this.targetPosition,this.targetPosition,this.pan),vec3.add(this.cameraPosition,this.cameraPosition,this.pan),mat4.lookAt(this.lookat,this.cameraPosition,this.targetPosition,[0,1,0]),mat4.invert(this.node.transform.absolute,this.lookat),this.node.calculateRelativeFromAbsolute(),this.doZoomIn&&this.zoomIn(),this.doZoomOut&&this.zoomOut())},onMouseMove:function(e,t,i,n){!1!==this.rotateButton&&t==this.rotateButton&&this.rotate(i[1],i[0]),!1!==this.panButton&&t==this.panButton&&this.move(i[0],i[1])},onPan:function(e,t){this.move(t[0],t[1])},rotate:function(e,t){var i=vec3.create();vec3.scale(i,[-e,-t,0],this.rotationAcceleration),vec3.add(this.rotation,this.rotation,i),this.rotation[0]=Math.max(this.minimumPitch,this.rotation[0]),this.rotation[0]=Math.min(this.maximumPitch,this.rotation[0]),this.onChange("rotate",e,t)},move:function(e,t){var i=vec3.create();vec3.scale(i,this.panXAxis,-e),vec3.add(i,i,vec3.scale(vec3.create(),this.panYAxis,-t)),i=vec3.scale(i,i,this.distance/900);var n=quat.fromMat4(quat.create(),this.node.transform.absolute),r=vec3.fromValues(0,0,1);vec3.transformQuat(r,r,n);var s=Math.atan2(r[2],r[0]);s-=Math.PI/2,quat.identity(n),quat.rotateY(n,n,s),quat.conjugate(n,n),quat.normalize(n,n),vec3.transformQuat(i,i,n),vec3.add(this.pan,this.pan,i),this.pan[0]=Math.max(this.pan[0],this.minimumPan[0]),this.pan[1]=Math.max(this.pan[1],this.minimumPan[1]),this.pan[2]=Math.max(this.pan[2],this.minimumPan[2]),this.pan[0]=Math.min(this.pan[0],this.maximumPan[0]),this.pan[1]=Math.min(this.pan[1],this.maximumPan[1]),this.pan[2]=Math.min(this.pan[2],this.maximumPan[2]),this.onChange("move",e,t)},onPinch:function(e,t){t=this.getZoom()+(1-t),this.setZoom(t)},onRotate:function(e,t,i,n){var r=t*(Math.PI/180);this.rotation[1]=this.rotation[1]+r,this.onChange("rotate",t)},onMouseWheel:function(e,t,i,n,r){i<0?this.zoomIn():this.zoomOut()}}),SmoothOrbitController=OrbitController.extend({init:function(){this._super(),this.speed=5,this.currentRotation=vec2.create(),this.currentDistance=this.distance},excluded:function(){return this._super().concat(["currentRotation","currentDistance","tmpRotation"])},type:function(){return"SmoothOrbitController"},onUpdate:function(e,t){if(!this.target.isNull()){var i=e.fps.getDelta()/1e3*this.speed;i=Math.min(i,1),this.currentRotation[0]=lerp(this.currentRotation[0],this.rotation[0],i),this.currentRotation[1]=lerp(this.currentRotation[1],this.rotation[1],i),this.currentDistance=lerp(this.currentDistance,this.distance,i),quat.identity(this.tmpRotation),quat.rotateY(this.tmpRotation,this.tmpRotation,this.currentRotation[1]),quat.rotateX(this.tmpRotation,this.tmpRotation,this.currentRotation[0]),vec3.set(this.direction,0,0,1),vec3.transformQuat(this.direction,this.direction,this.tmpRotation),vec3.scale(this.direction,this.direction,this.currentDistance),mat4.translation(this.targetPosition,this.target.value.absolute),vec3.add(this.cameraPosition,this.targetPosition,this.direction),vec3.add(this.targetPosition,this.targetPosition,this.pan),vec3.add(this.cameraPosition,this.cameraPosition,this.pan),mat4.lookAt(this.lookat,this.cameraPosition,this.targetPosition,[0,1,0]),mat4.invert(this.node.transform.absolute,this.lookat),this.node.calculateRelativeFromAbsolute(),this.doZoomIn&&this.zoomIn(),this.doZoomOut&&this.zoomOut()}}}),Billboard=Component.extend({init:function(e,t,i){this._super(),this.cameraToLookAt=e,this.smoothRotation=!0===t,this.rotationSpeed=4,i&&(this.rotationSpeed=i),this.cacheMat4=[mat4.create()],this.cacheQuat=[quat.create(),quat.create()],this.cacheVec3=[vec3.create(),vec3.create()]},type:function(){return"Billboard"},onUpdate:function(e){if(this.enabled){if(!(this.cameraToLookAt instanceof Camera))throw"Billboard.cameraToLookAt is not an instance of Camera";var t=e.fps.getDelta()/1e3,i=mat4.invert(this.cacheMat4[0],this.cameraToLookAt.viewMatrix),n=quat.fromMat4(this.cacheQuat[0],i);if(this.smoothRotation){var r=quat.fromMat4(this.cacheQuat[1],this.node.transform.relative);quat.slerp(n,r,n,this.rotationSpeed*t)}quat.normalize(n,n);var s=mat4.translation(this.cacheVec3[0],this.node.transform.relative),a=mat4.getScale(this.cacheVec3[1],this.node.transform.relative);mat4.fromRotationTranslationScale(this.node.transform.relative,n,s,a)}}}),VerticalBillboard=Billboard.extend({init:function(e,t,i){this._super(e,t,i)},type:function(){return"VerticalBillboard"},onUpdate:function(e){if(!(this.cameraToLookAt instanceof Camera))throw"VerticalBillboard.cameraToLookAt is not an instance of Camera";var t=e.fps.getDelta()/1e3,i=mat4.invert(this.cacheMat4[0],this.cameraToLookAt.viewMatrix),n=quat.fromMat4(this.cacheQuat[0],i);if(quat.multiply(n,n,quat.euler(this.cacheQuat[1],0,180,0)),this.smoothRotation){n[0]=0,n[2]=0,quat.normalize(n,n);var r=quat.fromMat4(this.cacheQuat[1],this.node.transform.relative);quat.slerp(n,r,n,this.rotationSpeed*t)}quat.normalize(n,n);var s=mat4.translation(this.cacheVec3[0],this.node.transform.relative),a=mat4.getScale(this.cacheVec3[1],this.node.transform.relative);mat4.fromRotationTranslationScale(this.node.transform.relative,n,s,a)}}),Collider=Component.extend({init:function(){this._super()},type:function(){return"Collider"},onStart:function(e,t){this.getScene().dynamicSpace.addCollider(this)},onEnd:function(e,t){this.getScene().dynamicSpace.removeCollider(this)},rayTest:function(e,t,i){return!1}}),MeshCollider=Collider.extend({init:function(){this._super()},type:function(){return"MeshCollider"},rayTest:function(e,t,i){if(!this.enabled)return!1;var n=this.node.getComponent(MeshRendererComponent);if(!n)return!1;for(var r=n.meshRenderers,s=vec3.create(),a=vec3.create(),o=vec3.create(),h=!1,u=0;u<r.length;u++)if((i||r[u].visible)&&e.intersectBoundingVolume(r[u].globalBoundingBox)){var c=e.clone(),l=mat4.invert(mat4.create(),r[u].matrix);c.transform(l);var d=r[u].submesh.faces,f=r[u].submesh.positions;if(t){var m=this;t.addCallback=function(e){vec3.transformMat4(e.point,e.point,r[u].matrix),e.submesh=r[u].submesh,e.collider=m,e.node=m.node}}for(var p=0;p<d.length;p+=3)if(s[0]=f[3*d[p]],s[1]=f[3*d[p]+1],s[2]=f[3*d[p]+2],a[0]=f[3*d[p+1]],a[1]=f[3*d[p+1]+1],a[2]=f[3*d[p+1]+2],o[0]=f[3*d[p+2]],o[1]=f[3*d[p+2]+1],o[2]=f[3*d[p+2]+2],c.intersectTriangle(s,a,o,t)){if(!t)return!0;h=!0;break}if(t)t.addCallback=!1;else if(h)return!0}return h}}),LargeMeshCollider=Collider.extend({init:function(e){this._super(),this.tree=!1,this.meshes=[],this.damaged=!1,this.invMat=mat4.create()},type:function(){return"LargeMeshCollider"},excluded:function(){return this._super().concat(["tree","meshes"])},isComplete:function(){return!1!==this.tree&&0==this.meshes.length},onAdd:function(e){if(this._super(),this.damaged){var t=this.node;for(var i in this.tree.nodes){var n=this.tree.nodes[i].localCollisionID;n<0||(this.tree.nodes[i]=function(e){var i=null;return t.onEachChild(function(t){if(t.localCollisionID===e)return i=t,!0}),i}(n))}this.damaged=!1}},clone:function(){var e=new LargeMeshCollider;return this.tree&&(e.tree=this.tree.clone(),e.damaged=!0),e},rayTest:function(e,t,i){if(!this.enabled||!this.isComplete())return!1;var n=e.clone();mat4.invert(this.invMat,this.node.transform.absolute),n.transform(this.invMat);var r=this.tree.getNearestRayCollision(n,e);if(r.t==1/0||r.t==-1/0)return!1;if(t&&r){var s=n.getPointOnRay(r.t);vec3.transformMat4(s,s,this.node.transform.absolute),t.hits.push({point:s,collider:this,submesh:r.submesh,node:r.node,normal:r.normal})}return!1!==r}}),Resource=Component.extend({init:function(){this._super(),this.descriptor=!1},excluded:function(){return this._super().concat(["resource"])},type:function(){return"ResourceComponent"}}),TextureResource=Resource.extend({init:function(){this._super(),this.descriptor=new TextureDescriptor,this.texture=!1,this.engine=!1},excluded:function(){return this._super().concat(["texture","engine"])},type:function(){return"TextureResource"},load:function(e){var t=this;this.texture=this.engine.assetsManager.texturesManager.addDescriptor(this.descriptor),this.engine.assetsManager.load(function(){t.onLoaded(),e&&e(t.engine.context,t.engine)})},onStart:function(e,t){this.engine=t,this.load()},onLoaded:function(){}}),ModelResource=Resource.extend({init:function(){this._super(),this.descriptor=new ModelDescriptor,this.model=!1},type:function(){return"ModelResource"},excluded:function(){return this._super().concat(["model","engine"])},load:function(e){if(this.descriptor.source){var t=this;this.model=this.engine.assetsManager.modelsManager.addDescriptor(this.descriptor),this.engine.assetsManager.load(function(){t.node.addNode(t.model),t.onLoaded(),e&&e(t.engine.context,t.engine)})}},onStart:function(e,t){this.engine=t,this.load()},onLoaded:function(){}}),MaterialResource=Resource.extend({init:function(){this._super(),this.descriptor=new MaterialSourceDescriptor,this.material=!1,this.engine=!1},excluded:function(){return this._super().concat(["material","engine"])},type:function(){return"MaterialResource"},load:function(e){var t=this;this.texture=this.engine.assetsManager.materialSourcesManager.addDescriptor(this.descriptor),this.engine.assetsManager.load(function(){t.onLoaded(),e&&e(t.engine.context,t.engine)})},onStart:function(e,t){this.engine=t,this.load()},onLoaded:function(){}}),Light=Component.extend({init:function(){this._super(),this.color=new Color(1,1,1,1),this.intensity=1,this.shadowCasting=!1,this.shadowMask=4294967295},type:function(){return"Light"},onAddScene:function(e){e.scene.lights.push(this)},onRemoveScene:function(e){for(var t=e.scene.lights,i=0;i<t.length;i++)t[i]==this&&(t.splice(i,1),i--)},getGeometryRenderers:function(){return[]},isPositional:function(){return!1},onContextRestored:function(e){}}),OmniLight=Light.extend({init:function(e,t){this._super(),this.size=e||1,this.color=t||new Color(1,1,1,1),this.intensity=1,this.geometry=null,this.material=null},type:function(){return"OmniLight"},onStart:function(e,t){this._super(),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/deferred_light_omni"),{lightColor:new UniformColor(this.color),lightPosition:new UniformVec3(vec3.create()),lightIntensity:new UniformFloat(this.intensity),lightRadius:new UniformFloat(this.size)},[]),this.geometry=Primitives.sphere(this.size,16,16,this.material),this.geometry.getComponent(MeshRendererComponent).disable(),this.node.addNode(this.geometry),t.assetsManager.load()},onPreRender:function(){vec4.set(this.material.uniforms.lightColor.value,this.color.r,this.color.g,this.color.b,this.color.a),this.node.transform.getPosition(this.material.uniforms.lightPosition.value),this.material.uniforms.lightIntensity.value=this.intensity,this.material.uniforms.lightRadius.value=this.size},getGeometryRenderers:function(){return this.geometry.getComponent(MeshRendererComponent).meshRenderers},isPositional:function(){return!0}}),AmbientLight=Light.extend({init:function(e){this._super(),this.color=e||new Color(.2,.2,.2,1),this.geometry=null,this.material=null},type:function(){return"AmbientLight"},onStart:function(e,t){this._super(),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/deferred_light_ambient"),{lightColor:new UniformColor(this.color)},[]);var i=new Mesh,n=new Submesh;n.positions=[-1,-1,0,-1,1,0,1,1,0,1,-1,0],n.normals=[0,0,1,0,0,1,0,0,1,0,0,1],n.texCoords2D=[[0,0,0,1,1,1,1,0]],n.faces=[0,1,2,0,2,3],n.recalculateBounds(),i.addSubmesh(n,this.material),this.geometry=new Node("AmbientLightGeometry"),this.geometry.addComponent(new MeshComponent(i)),this.geometry.addComponent(new MeshRendererComponent).disable(),this.node.addNode(this.geometry),t.assetsManager.load()},onUpdate:function(){vec4.set(this.material.uniforms.lightColor.value,this.color.r,this.color.g,this.color.b,this.color.a)},getGeometryRenderers:function(){return this.geometry.getComponent(MeshRendererComponent).meshRenderers}}),DirectionalLight=Light.extend({init:function(e,t){this._super(),this.intensity=1,this.color=t||new Color(1,1,1,1),this.direction=vec3.fromValues(1,1,1),e&&this.setLightDirection(e),this.shadowResolution=vec2.fromValues(2048,2048),this.shadowBias=.001,this.geometry=null,this.material=null,this.shadow=null,this.shadowSampler=null,this.lightView=mat4.create(),this.lightProj=mat4.create()},type:function(){return"DirectionalLight"},setLightDirection:function(e){vec3.copy(this.direction,e),vec3.normalize(this.direction,this.direction)},onStart:function(e,t){if(this._super(),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/deferred_light_directional"),{lightColor:new UniformColor(this.color),lightIntensity:new UniformFloat(this.intensity),lightDirection:new UniformVec3(vec3.create()),lightView:new UniformMat4(mat4.create()),lightProjection:new UniformMat4(mat4.create()),useShadows:new UniformInt(0),shadowBias:new UniformFloat(.001)},[]),this.shadowCasting&&!this.shadow){var i=e.gl.getExtension("OES_texture_half_float"),n=e.gl.getExtension("OES_texture_float");this.shadow=n||i?new TargetTextureFloat(this.shadowResolution,e,!1):new TargetTexture(this.shadowResolution,e,!1),this.shadowSampler=new Sampler("shadow0",this.shadow.texture),this.material.samplers.push(this.shadowSampler)}var r=new Mesh,s=new Submesh;s.positions=[-1,-1,0,-1,1,0,1,1,0,1,-1,0],s.normals=[0,0,1,0,0,1,0,0,1,0,0,1],s.texCoords2D=[[0,0,0,1,1,1,1,0]],s.faces=[0,1,2,0,2,3],s.recalculateBounds(),r.addSubmesh(s,this.material),this.geometry=new Node("DirectionalLightGeometry"),this.geometry.addComponent(new MeshComponent(r)),this.geometry.addComponent(new MeshRendererComponent).disable(),this.node.addNode(this.geometry),t.assetsManager.load()},onUpdate:function(e){vec4.set(this.material.uniforms.lightColor.value,this.color.r,this.color.g,this.color.b,this.color.a),vec3.copy(this.material.uniforms.lightDirection.value,this.direction),this.material.uniforms.lightIntensity.value=this.intensity,this.material.uniforms.useShadows.value=this.shadowCasting?1:0,this.material.uniforms.shadowBias.value=this.shadowBias,this.updateSamplers(e.context)},updateSamplers:function(e){this.shadowCasting&&(this.shadow||(this.shadow=new TargetTextureFloat(this.shadowResolution,e,!1),this.shadowSampler?this.shadowSampler.texture=this.shadow.texture:(this.shadowSampler=new Sampler("shadow0",this.shadow.texture),this.material.samplers.push(this.shadowSampler))),mat4.copy(this.material.uniforms.lightView.value,this.lightView),mat4.copy(this.material.uniforms.lightProjection.value,this.lightProj))},getGeometryRenderers:function(){return this.geometry.getComponent(MeshRendererComponent).meshRenderers},onContextRestored:function(e){delete this.shadow,this.shadow=null}}),GPUTerrain=MeshRendererComponent.extend({init:function(e,t,i){this._super(),this.options=FRAK.extend({size:1024,verticalScale:64,numCones:8,initialConeSize:32},i),this.uvSize=Math.pow(2,this.options.numCones-1)*this.options.initialConeSize,this.heightSource=new TextureDescriptor(e),this.colorSource=new TextureDescriptor(t),this.cameraPosition=vec3.create()},type:function(){return"TerrainComponent"},onStart:function(e,t){this.height=t.assetsManager.texturesManager.addDescriptor(this.heightSource),this.color=t.assetsManager.texturesManager.addDescriptor(this.colorSource),this.material=new Material(t.assetsManager.addShaderSource("shaders/default/terrain"),{diffuse:new UniformColor({r:1,g:1,b:1,a:1}),ambient:new UniformColor({r:.2,g:.2,b:.2}),uvOffset:new UniformVec2(vec2.fromValues(0,0)),uvScale:new UniformVec2(vec2.fromValues(1,1)),verticalScale:new UniformFloat(this.options.verticalScale)},[new Sampler("diffuse0",this.color),new Sampler("height",this.height)]);var i=new TerrainMesh;i.generate(this.options.initialConeSize,1,this.options.numCones);var n=new Mesh,r=new Submesh;r.positions=i.positions,r.barycentric=i.barycentric,r.normals=i.normals,r.texCoords2D=[i.uv],r.faces=i.faces,r.calculateTangents(),r.recalculateBounds(),n.addSubmesh(r,this.material),this.node.addComponent(new MeshComponent(n)),this._super(e,t),t.assetsManager.load()},onPreRender:function(e,t){t.getPosition(this.cameraPosition),this.cameraPosition[1]=0;var i=(this.cameraPosition[0]+this.options.size/2)/this.options.size,n=(this.cameraPosition[2]+this.options.size/2)/this.options.size;vec2.set(this.material.uniforms.uvScale.value,this.uvSize/this.options.size,this.uvSize/this.options.size),vec2.set(this.material.uniforms.uvOffset.value,i,n),this.material.uniforms.verticalScale.value=this.options.verticalScale,this.node.transform.setPosition(this.cameraPosition)}}),Descriptor=Serializable.extend({init:function(){this._super(),this.source="",this.parentDescriptor=!1},included:function(){return!0},excluded:function(){return this._super().concat(["parentDescriptor"])},type:function(){return"Descriptor"},equals:function(e){if(this.type()!=e.type())return!1;if(this.getFullPath()!=e.getFullPath())return!1;if(this.parentDescriptor&&e.parentDescriptor){if(!this.parentDescriptor.equals(e.parentDescriptor))return!1}else if(this.parentDescriptor!=e.parentDescriptor)return!1;return!0},getCurrentRelativeDirectory:function(){return 0==this.source.length?"":this.source.substring(0,this.source.lastIndexOf("/")+1)},getCurrentDirectory:function(){var e="";return this.parentDescriptor&&(e=this.parentDescriptor.getCurrentDirectory()),e+this.getCurrentRelativeDirectory()},getParentDirectory:function(){return this.parentDescriptor?this.parentDescriptor.getCurrentDirectory():""},getFullPath:function(){return this.getParentDirectory()+this.source}}),TextDescriptor=Descriptor.extend({init:function(e){this._super(),this.source=e},type:function(){return"TextDescriptor"},equals:function(e){return!!this._super(e)&&this.source==e.source}}),ModelDescriptor=Descriptor.extend({init:function(e,t){this._super(),this.source=e,this.format=t||"auto"},type:function(){return"ModelDescriptor"},getFormat:function(){return"auto"==this.format?this.source.endsWith(".data")?"binary":this.source.endsWith(".json")?"json":"binary":this.format}}),ShaderDescriptor=Descriptor.extend({init:function(e,t){this._super(),t?(this.vertexSource=e,this.fragmentSource=t):(this.vertexSource=e+".vert",this.fragmentSource=e+".frag")},type:function(){return"ShaderDescriptor"},equals:function(e){return!!this._super(e)&&(this.vertexSource==e.vertexSource&&this.fragmentSource==e.fragmentSource)},getVertexShaderPath:function(){return this.getParentDirectory()+this.vertexSource},getFragmentShaderPath:function(){return this.getParentDirectory()+this.fragmentSource}}),MaterialDescriptor=Descriptor.extend({init:function(e,t,i){this._super(),i||(i=[]),t||(t={}),this.shaderDescriptor=e,this.uniforms=t,this.textureDescriptors=i,this.materialResourceDescriptor=!1,this.requirements={}},type:function(){return"MaterialDescriptor"},equals:function(e){return!1}}),MaterialSource=Descriptor.extend({init:function(e){this._super(),this.material=!1,this.sourceDescriptor=e},type:function(){return"MaterialSource"},equals:function(e){return!1}}),MaterialSourceDescriptor=Descriptor.extend({init:function(e){this._super(),this.source=e},type:function(){return"MaterialSourceDescriptor"},equals:function(e){return this.source==e.source}}),TextureDescriptor=Descriptor.extend({init:function(e,t,i){this._super(),this.source=e,this.width=t,this.height=i},type:function(){return"TextureDescriptor"},equals:function(e){return!!this._super(e)&&(this.source==e.source&&this.width==e.width&&height==e.height)}}),CubeTextureDescriptor=Descriptor.extend({init:function(e){this._super(),this.sources=e||[]},type:function(){return"CubeTextureDescriptor"},equals:function(e){if(!this._super(e))return!1;if(this.sources.length!=e.sources.length)return!1;for(var t=0;t<this.sources.length;t++)if(this.sources[t]!=e.sources[t])return!1;return!0},getFaceFullPath:function(e){if(e<0||e>this.sources.length)throw"CubeTextureDescriptor.getFaceFullPath: index out of bounds";this.source=this.sources[e];var t=this.getFullPath();return this.source="",t}}),EmptyNode=Serializable.extend({init:function(e){this._super(),this.name=e||"Empty Node",this.subnodes=[],this.components=[],this.scene=!1,this.parent=!1,this.layer=1,this.tags=[],this._super()},excluded:function(){return["parent","scene"]},type:function(){return"EmptyNode"},addNode:function(e){if(!(e instanceof EmptyNode))throw"addNode: The given node is not a subclass of EmptyNode";this.subnodes.push(e);var t=this;return e.parent=this,e.onEachChild(function(e){e.scene=t.scene}),e.scene&&e.onEachChildComponent(function(e){e.onAddScene(t),e.node.onAddComponent(e)}),e.onAdd(this),t.scene.engine&&e.onEachChildComponent(function(e){e.started||(t.scene.starting||!1===t.scene.started?t.scene.startingQueue.push(e):(e.onLoad(t.scene.engine.assetsManager,t.scene.engine),e.start(t.scene.engine.context,t.scene.engine),e.started=!0))}),e},removeNode:function(e){var t=this;this.scene.engine&&e.onEachChildComponent(function(e){e.started&&e.onEnd(t.scene.engine.context,t.scene.engine),e.started=!1}),e.onRemove(this),e.scene&&e.onEachChildComponent(function(e){e.onRemoveScene(t),e.node.onRemoveComponent(e)}),e.onEachChild(function(e){e.scene=!1}),e.parent=!1;for(var i=0;i<this.subnodes.length;i++)if(this.subnodes[i]==e){this.subnodes.splice(i,1);break}return e},removeSubnodes:function(){for(var e=this.subnodes.slice(0),t=0;t<e.length;t++)this.removeNode(e[t])},addComponent:function(e){if(!e.type())throw"Unable to add a component that doesn't define it's type by returning it from type() method";return this.components.push(e),e.node=this,e.onAdd(this),this.scene&&(e.onAddScene(this),this.onAddComponent(e)),!e.started&&this.scene&&this.scene.engine&&(this.scene.started||this.scene.starting)&&(e.start(this.scene.engine.context,this.scene.engine),e.started=!0),e},removeComponent:function(e){for(var t=0;t<this.components.length;t++)if(this.components[t]===e){this.components.splice(t,1);break}return this.scene.engine&&e.started&&(e.onEnd(this.scene.engine.context,this.scene.engine),e.started=!1),this.scene&&(e.onRemoveScene(this),this.onRemoveComponent(e)),e.onRemove(this),e.node=!1,e},removeComponentsByType:function(e){for(var t=[],i=0;i<this.components.length;i++)this.components[i]instanceof e&&(t.push(this.components[i]),this.components.splice(i,1),i--);for(i=0;i<t.length;i++)this.scene.engine&&t[i].started&&(t[i].onEnd(this.scene.engine.context,this.scene.engine),t[i].started=!1),this.scene&&(t[i].onRemoveScene(this),this.onRemoveComponent(t[i])),t[i].onRemove(this),t[i].node=!1;return t},getComponent:function(e){for(var t=0;t<this.components.length;t++)if(this.components[t]instanceof e)return this.components[t];return!1},getComponents:function(e){for(var t=[],i=0;i<this.components.length;i++)this.components[i]instanceof e&&t.push(this.components[i]);return 0!=t.length&&t},calculateRelativeFromAbsolute:function(){this.parent.transform&&this.transform.calculateRelativeFromAbsolute(this.parent.transform.absolute)},instantiate:function(){var e=new EmptyNode(this.name);e.isInstanced=!0,e.layer=this.layer,e.tags=this.tags.slice(0);for(var t=0;t<this.subnodes.length;t++)e.addNode(this.subnodes[t].instantiate());for(var i=0;i<this.components.length;i++)e.addComponent(this.components[i].instantiate());return e},enable:function(e){e?this.onEachComponent(function(e){e.enable()}):this.onEachChildComponent(function(e){e.enable()})},disable:function(e){e?this.onEachComponent(function(e){e.disable()}):this.onEachChildComponent(function(e){e.disable()})},onAdd:function(e){},onRemove:function(e){},onAddComponent:function(e){this.scene.components.push(e),e.onUpdate!=Component.prototype.onUpdate&&this.scene.updatedComponents.push(e),e.onPreRender!=Component.prototype.onPreRender&&this.scene.preRenderedComponents.push(e),e.onPostRender!=Component.prototype.onPostRender&&this.scene.postRenderedComponents.push(e)},onRemoveComponent:function(e){function t(e,t){var i=e.indexOf(t);-1==i||e.splice(i,1)}t(this.scene.components,e),e.onUpdate!=Component.prototype.onUpdate&&t(this.scene.updatedComponents,e),e.onPreRender!=Component.prototype.onPreRender&&t(this.scene.preRenderedComponents,e),e.onPostRender!=Component.prototype.onPostRender&&t(this.scene.postRenderedComponents,e)},onEachChild:function(e){if(!0===e(this))return!0;for(var t=0;t<this.subnodes.length;t++)if(!0===this.subnodes[t].onEachChild(e))return!0},onEachChildExclusive:function(e){for(var t=0;t<this.subnodes.length;t++)if(!0===this.subnodes[t].onEachChild(e))return!0},onEachDirectChild:function(e){for(var t=0;t<this.subnodes.length;t++)if(!0===e(this.subnodes[t]))return!0},onEachComponent:function(e){for(var t=0;t<this.components.length;t++)if(!0===e(this.components[t]))return!0},onEachChildComponent:function(e){this.onEachChild(function(t){if(!0===t.onEachComponent(e))return!0})},onEachChildComponentExclusive:function(e){this.onEachChildExclusive(function(t){if(!0===t.onEachComponent(e))return!0})},getChildComponentsOfType:function(e){var t=[];return this.onEachChildComponent(function(i){i instanceof e&&t.push(i)}),t},find:function(e){var t=e.split("/");if(0==t.length)return!1;var i=this;if(""===t[0]){if(!this.scene)return!1;i=this.scene.root,t.shift()}for(var n=0;n<t.length;n++)if(!1===(i=i.findChildWithName(t[n])))return!1;return i},findChildWithName:function(e){for(var t=0;t<this.subnodes.length;t++)if(this.subnodes[t].name===e)return this.subnodes[t];return!1},path:function(){for(var e=[],t=this;t;)e.push(t.name),t=t.parent;return"/"+e.reverse().join("/")}}),Node=EmptyNode.extend({init:function(e){this._super(e),this.name=e||"Node",this.transform=this.addComponent(new Transform),this.localCollisionID=-1},excluded:function(){return this._super().concat(["transform"])},type:function(){return"Node"},getBoundingBox:function(e){var t=new BoundingBox;return this.onEachChildComponent(function(i){i instanceof MeshRendererComponent&&t.encapsulateBox(i.getBoundingBox(e))}),t},getBoundingSphere:function(e){var t=new BoundingSphere;return this.onEachChildComponent(function(i){i instanceof MeshRendererComponent&&t.encapsulateSphere(i.getBoundingSphere(e))}),t},instantiate:function(){var e=new Node(this.name);e.isInstanced=!0,e.localCollisionID=this.localCollisionID,e.removeComponentsByType(Transform),e.layer=this.layer,e.tags=this.tags.slice(0);for(var t=0;t<this.subnodes.length;t++)e.addNode(this.subnodes[t].instantiate());for(var i=0;i<this.components.length;i++)e.addComponent(this.components[i].instantiate());return e.transform=e.getComponent(Transform),e},updateChildTransforms:function(){var e,t,i=this.transform.absolute,n=this.subnodes;for(e=0;e<n.length;e++){var r=n[e];r.transform&&(mat4.multiply(r.transform.absolute,i,r.transform.relative),r.updateChildTransforms())}for(t=0;t<this.components.length;t++)this.components[t].onUpdateTransform(i)},setAbsolutePosition:function(e){this.parent&&this.parent.transform?(mat4.fromRotationTranslationScale(this.transform.absolute,quat.fromMat4(quat.create(),this.transform.absolute),e,mat4.getScale(vec3.create(),this.transform.absolute)),this.transform.calculateRelativeFromAbsolute(this.parent.transform.absolute)):this.transform.calculateRelativeFromAbsolute()}}),Scene=Serializable.extend({init:function(){this.root=new Node,this.root.scene=this,this.dynamicSpace=new DynamicSpace,this.cameras=[],this.lights=[],this.engine=!1,this.starting=!1,this.started=!1,this.startingQueue=[],this.components=[],this.preRenderedComponents=[],this.postRenderedComponents=[],this.updatedComponents=[];var e=this;this.processPreRenderList=function(t,i){for(var n=0;n<e.preRenderedComponents.length;n++){var r=e.preRenderedComponents[n];r.node.layer&i.layerMask&&(t.modelview.push(),t.modelview.multiply(r.node.transform.absolute),r.onPreRender(t,i),t.modelview.pop())}},this.processPostRenderList=function(t,n){for(i=0;i<e.postRenderedComponents.length;i++){var r=e.postRenderedComponents[i];r.node.layer&n.layerMask&&(t.modelview.push(),t.modelview.multiply(r.node.transform.absolute),r.onPostRender(t,n),t.modelview.pop())}}},fields:function(){return["root"]},start:function(e){if(!this.started&&!this.starting){this.starting=!0;var t=this;this.root.onEachChildComponent(function(e){e.enabled&&(e.started||e.onLoad(t.engine.assetsManager,t.engine))});!function(){t.root.updateChildTransforms(),t.root.onEachChildComponent(function(e){e.enabled&&(e.started||t.startingQueue.push(e))});var i=null;(i=function(){for(var n=(new Date).getTime()+50;(new Date).getTime()<n;){if(0===t.startingQueue.length)return t.started=!0,t.starting=!1,void("function"==typeof t.engine.sceneStarted&&t.engine.sceneStarted());var r=t.startingQueue.shift();r.started||(r.start(e,t.engine),r.started=!0)}setTimeout(i,10)})()}()}},end:function(e,t){this.started&&(this.root.updateChildTransforms(),this.root.onEachChildComponent(function(i){i.enabled&&i.started&&(i.onEnd(e,t),i.started=!1)}),this.started=!1)},render:function(e){if(this.started)for(var t=0;t<this.cameras.length;t++)this.cameras[t].render(e,this,this.processPreRenderList,this.processPostRenderLists)},update:function(e){if(this.started){for(var t=1,i=0;i<t;i++)for(var n=0;n<this.updatedComponents.length;++n){var r=this.updatedComponents[n];r.enabled&&(i<r.updatePasses&&r.started&&r.onUpdate(e,i),t<r.updatePasses&&(t=r.updatePasses))}this.root.updateChildTransforms()}},getMaterials:function(){var e=[];return this.root.onEachChildComponent(function(t){if(t instanceof MeshComponent)for(var i in t.mesh.materials)e.push(t.mesh.materials[i])}),e}}),DefaultScene=Scene.extend({init:function(){this._super(),this.root.name="Root",this.cameraNode=new Node("Camera"),this.cameraComponent=this.cameraNode.addComponent(new PerspectiveCamera),this.cameraComponent.aspect=!1,this.camera=this.cameraComponent.camera,this.root.addNode(this.cameraNode),this.lightNode=new Node("Light"),this.light=new DirectionalLight,this.light.color=new Color(1,1,1,1),this.light.intensity=1,this.light.setLightDirection(vec3.fromValues(.9,1,.9)),this.lightNode.addComponent(this.light),this.root.addNode(this.lightNode)}}),FPS=FrakClass.extend({init:function(){this.frametime=0,this.lastMeasurement=(new Date).getTime(),this.averageMultiplier=.95,this.delta=0},measure:function(){var e=FRAK.timestamp();e-this.lastMeasurement>0&&(this.frametime=this.frametime*this.averageMultiplier+this.delta*(1-this.averageMultiplier),this.delta=e-this.lastMeasurement),this.lastMeasurement=e},getAverage:function(){return this.frametime<=0?0:1e3/this.frametime},getDelta:function(){return this.delta}}),Engine=FrakClass.extend({init:function(e,t,i){if(console.log("Engine"),t||(t={}),this.options=FRAK.extend({assetsPath:"",defaultRequestedFPS:30,requestedFPS:30,anisotropicFiltering:4,useVAO:!0,debug:!1,antialias:!1,ssao:!1,transparencyMode:"default",renderer:"default",softShadows:!1,runInBackground:!1,context:!1,contextErrorCallback:null},t),this.validateOptions(e),this.context=this.options.context,this.context.engine=this,i||(i=new DefaultScene),this.scene=i,this.scene.engine=this,this.fps=new FPS,this.running=!1,this.input=!1,this.assetsManager=new AssetsManager(this.context,this.options.assetsPath),this.WhiteTexture=new Texture(this.context),this.WhiteTexture.name="WhiteTexture",this.WhiteTexture.mipmapped=!1,this.WhiteTexture.clearImage(this.context,[255,255,255,255]),this.WhiteTextureSampler=new Sampler("tex0",this.WhiteTexture),this.DiffuseFallbackSampler=new Sampler("diffuse0",this.WhiteTexture),document.addEventListener("visibilitychange",FrakCallback(this,this.onVisibilityChange)),this.context.canvas.addEventListener("webglcontextlost",FrakCallback(this,this.onContextLost),!1),this.context.canvas.addEventListener("webglcontextrestored",FrakCallback(this,this.onContextRestored),!1),FRAK.fullscreenEnabled){this.useUpscaling=!1;var n=FrakCallback(this,this.onFullscreenChange);document.addEventListener("fullscreenchange",n),document.addEventListener("webkitfullscreenchange",n),document.addEventListener("mozfullscreenchange",n),document.addEventListener("MSFullscreenChange",n)}this.setupInput()},onContextLost:function(e){console.log("FRAK: Rendering context lost"),e.preventDefault(),this.pause()},onContextRestored:function(e){console.log("FRAK: Rendering context restored"),this.context.engine=this,this.context.restore(),this.run()},onVisibilityChange:function(){if(!this.options.runInBackground)if(document.hidden){if(!1===this.running)return void(this._externallyPaused=!0);this.pause()}else{if(this._externallyPaused)return void delete this._externallyPaused;this.run()}},onFullscreenChange:function(){if(this.context instanceof RenderingContext)if(FRAK.isFullscreen()){var e=this.context.canvas;this._savedCanvasStyles={position:e.style.position,left:e.style.left,right:e.style.right,top:e.style.top,bottom:e.style.bottom,width:e.style.width,height:e.style.height,canvasWidth:e.getAttribute("width"),canvasHeight:e.getAttribute("height"),aspectRatio:this.scene.cameraComponent.aspect},e.style.position="absolute",e.style.left=0,e.style.right=0,e.style.top=0,e.style.bottom=0,e.style.width="100%",e.style.height="100%";var t=this;setTimeout(function(){var i=e.getBoundingClientRect();if(t.scene.cameraComponent.setAspectRatio(i.width/i.height),!t.useUpscaling){var n=t.context.gl,r=n.canvas.clientWidth,s=Math.max(1,n.canvas.clientHeight);e.setAttribute("width",r),e.setAttribute("height",s),t.scene.camera.target.setSize(n.drawingBufferWidth,n.drawingBufferHeight)}},2e3/this.options.requestedFPS)}else if(this._savedCanvasStyles){if((e=this.context.canvas).style.position=this._savedCanvasStyles.position,e.style.left=this._savedCanvasStyles.left,e.style.right=this._savedCanvasStyles.right,e.style.top=this._savedCanvasStyles.top,e.style.bottom=this._savedCanvasStyles.bottom,e.style.width=this._savedCanvasStyles.width,e.style.height=this._savedCanvasStyles.height,this._savedCanvasStyles.aspectRatio&&this.scene.cameraComponent.setAspectRatio(this._savedCanvasStyles.aspectRatio),!this.useUpscaling){e.setAttribute("width",this._savedCanvasStyles.canvasWidth),e.setAttribute("height",this._savedCanvasStyles.canvasHeight);var i=this.context.gl;this.scene.camera.target.setSize(i.drawingBufferWidth,i.drawingBufferHeight)}delete this._savedCanvasStyles}},setupInput:function(){this.input=new Input(this,this.context.canvas)},run:function(){function e(){t=FRAK.timestamp(),(i=t-n)>r&&(n=t-i%r,s.frame()),s.running&&(s._currentAnimationFrame=FRAK.requestAnimationFrame(e))}if(!1===this.running){this.running=!0;var t,i,n=FRAK.timestamp(),r=1e3/this.options.requestedFPS,s=this;this.scene.started||this.scene.start(this.context,this),this._currentAnimationFrame=FRAK.requestAnimationFrame(e)}},sceneStarted:function(){},stop:function(){this.pause(),this.scene.started&&this.scene.end(this.context)},pause:function(){this.running=!1,this._currentAnimationFrame&&FRAK.cancelAnimationFrame(this._currentAnimationFrame)},togglePause:function(){!1===this.running?this.run():this.pause()},requestFullscreen:function(e){FRAK.fullscreenEnabled?(this.useUpscaling=e,FRAK.requestFullscreen(this.context.canvas)):console.warn("FRAK: Fullscreen API is disabled in this browser.")},exitFullscreen:function(){FRAK.fullscreenEnabled?FRAK.exitFullscreen():console.warn("FRAK: Fullscreen API is disabled in this browser.")},startIdle:function(e){e||(e=1),this.options.requestedFPS=e,this.pause(),this.run()},stopIdle:function(){this.options.requestedFPS=this.options.defaultRequestedFPS,this.pause(),this.run()},frame:function(){this.context.engine=this,this.input.update(this),this.scene.update(this),this.scene.render(this.context),this.fps.measure()},validateOptions:function(e){this.options.context||(this.options.context=new RenderingContext(e,null,this.options.contextErrorCallback));var t=this.options.context.gl;switch(this.options.transparencyMode){case"sorted":case"blended":case"stochastic":break;default:this.options.transparencyMode="blended"}if("sorted"!=this.options.transparencyMode){var i=t.getExtension("OES_texture_float"),n=t.getExtension("OES_texture_half_float");i||n||(this.options.transparencyMode="sorted")}switch(this.options.renderer){case"auto":t.getExtension("WEBGL_draw_buffers")&&t.getExtension("OES_texture_float")&&t.getExtension("OES_standard_derivatives")?this.options.renderer="deferred":this.options.renderer="forward";break;case"deferred":case"forward":break;default:this.options.renderer="forward"}},resize:function(){if(this.context instanceof RenderingContext){var e=this.context.gl;e.canvas.clientWidth,Math.max(1,e.canvas.clientHeight);this.scene.cameraComponent.setAspectRatio(e.drawingBufferWidth/e.drawingBufferHeight),this.scene.camera.target.setSize(e.drawingBufferWidth,e.drawingBufferHeight)}},stats:function(){if(this.scene){var e=this.scene.camera.renderStage.generator.organizer;console.log("=============== Statistics ====================="),console.log("  Visible faces (opaque/transparent): {0}/{1}".format(e.visibleSolidFaces,e.visibleTransparentFaces)),console.log("  Visible renderers (opaque/transparent): {0}/{1}".format(e.visibleSolidRenderers,e.visibleTransparentRenderers)),console.log("  Visible batches (opaque/transparent): {0}/{1}".format(e.visibleSolidBatches,e.visibleTransparentBatches)),console.log("================================================")}}}),Input=FrakClass.extend({init:function(e,t){this.controllers=[],this.engine=e,this.canvas=t,this.lastPinch=0,this.lastRotation=0,this.buttons=[!1,!1,!1],this.button=-1,this.position=vec2.create(),this.delta=vec2.create(),this.lastDelta=vec2.create(),this.deltaChange=vec2.create(),this.scrollDelta=0,this.hammertime=HammerWF(this.canvas),this.hammertime.get("pinch").set({enable:!0}),this.hammertime.get("rotate").set({enable:!0}),this.hammertime.get("pan").set({threshold:0,pointers:0}),this.singlepan=new HammerWF.Pan({event:"pan",direction:HammerWF.DIRECTION_ALL,threshold:5,pointers:1}),this.hammertime.add(this.singlepan),this.bindings={},this.keyStates={},this.wfPanEnabled=!1,this.keymap={enter:13,escape:27,backspace:8,tab:9,shift:16,ctrl:17,alt:18,pause:19,caps_lock:20,space:32,page_up:33,page_down:34,end:35,home:36,left_arrow:37,up_arrow:38,right_arrow:39,down_arrow:40,insert:45,delete:46,left_window_key:91,right_window_key:92,select_key:93,numpad_0:96,numpad_1:97,numpad_2:98,numpad_3:99,numpad_4:100,numpad_5:101,numpad_6:102,numpad_7:103,numpad_8:104,numpad_9:105,multiply:106,add:107,subtract:109,decimal_point:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,num_lock:144,scroll_lock:145,semi_colon:186,equal_sign:187,comma:188,dash:189,period:190,forward_slash:191,grave_accent:192,open_bracket:219,back_slash:220,close_braket:221,single_quote:222,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},this.setup()},setup:function(){this.registerKeyboardEvents(),this.registerPointerEvents()},registerController:function(e){return this.controllers.push(e),!0},registerPointerEvents:function(){this.hammertime&&(this.hammertime.on("pinch",FrakCallback(this,this.onPinch)),this.hammertime.on("pinchend",FrakCallback(this,this.onPinchEnd)),this.hammertime.on("tap",FrakCallback(this,this.onTap)),this.hammertime.on("transformstart",FrakCallback(this,this.onTransformStart)),this.hammertime.on("panstart",FrakCallback(this,this.onPanStart)),this.hammertime.on("panend",FrakCallback(this,this.onPanEnd)),this.hammertime.on("rotate",FrakCallback(this,this.onRotate)),this.hammertime.on("rotateend",FrakCallback(this,this.onRotateEnd)),this.hammertime.on("touch",FrakCallback(this,this.onTouch)),this.hammertime.on("panleft panright panup pandown",FrakCallback(this,this.onPan))),this.canvas.addEventListener("mousewheel",FrakCallback(this,this.onMouseWheel)),this.canvas.addEventListener("DOMMouseScroll",FrakCallback(this,this.onMouseWheelMOZ)),this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},!1)},registerKeyboardEvents:function(){this.canvas&&(this.canvas.addEventListener("keydown",FrakCallback(this,this.onKeyDown)),this.canvas.addEventListener("keyup",FrakCallback(this,this.onKeyUp)),this.canvas.focus&&this.canvas.focus())},unregisterController:function(e){var t=this.controllers.indexOf(e);return t>-1&&(this.controllers.splice(t,1),!0)},bind:function(e,t,i){e&&t&&i&&(e in this.keymap?this.bindings[this.keymap[e]]=[i,t]:this.bindings[e.charCodeAt(0)]=[i,t])},sendEvent:function(e){if(this.engine.running){var t=Array.prototype.slice.call(arguments,0);t=t.slice(1,t.length);for(var i=[],n=0;n<this.controllers.length;n++)this.controllers[n][e]&&i.push(this.controllers[n]);i.sort(function(t,i){return i.getPriority(e)-t.getPriority(e)});for(n=0;n<i.length&&!0!==i[n][e].apply(i[n],t);n++);}},translateCoordinates:function(e,t,i){var n=this.canvas.getBoundingClientRect(),r=t-n.left,s=i-n.top;return vec2.set(e,r,s)},onTap:function(e){if(e){this.translateCoordinates(this.position,e.center.x,e.center.y);this.setMouseButtons(e.frakButtons);var t;for(t=0;t<this.buttons.length&&!this.buttons[t];t++);t==this.buttons.length&&(t=0),this.sendEvent("onClick",this.position,t,e.pointerType,e),this.resetMouseButtons()}},onPan:function(e){e&&(e.preventDefault(),vec2.set(this.deltaChange,e.deltaX,e.deltaY),vec2.sub(this.deltaChange,this.deltaChange,this.lastDelta),vec2.set(this.lastDelta,e.deltaX,e.deltaY),this.setMouseButtons(e.frakButtons),this.translateCoordinates(this.position,e.center.x,e.center.y),Math.max(vec2.len(this.deltaChange))<100&&("touch"==e.pointerType?this.sendEvent("onPan",this.position,this.deltaChange,e.pointerType,e):this.sendEvent("onMouseMove",this.position,this.button,this.deltaChange,e.pointerType,e)))},onPanStart:function(e){e&&(this.setMouseButtons(e.frakButtons),this.translateCoordinates(this.position,e.center.x,e.center.y),this.sendEvent("onButtonDown",this.position,this.button,0,e.pointerType,e))},onPanEnd:function(e){vec2.set(this.lastDelta,0,0),e&&(this.setMouseButtons(e.frakButtons),this.translateCoordinates(this.position,e.center.x,e.center.y),this.sendEvent("onButtonUp",this.position,this.button,0,e.pointerType,e),this.resetMouseButtons())},onTouch:function(){console.info("onTouch in frak")},onTransformStart:function(e){e.gesture.preventDefault(),e.gesture&&(this.lastRotation=e.gesture.rotation)},onPinch:function(e){if(e.preventDefault(),e){this.translateCoordinates(this.position,e.clientX,e.clientY);var t=e.scale-this.lastPinch;this.lastPinch=e.scale-1,this.sendEvent("onPinch",this.position,t,"touch",e)}},onPinchEnd:function(){this.lastPinch=0},onRotate:function(e){if(e){this.translateCoordinates(this.position,e.clientX,e.clientY);var t=e.rotation-this.lastRotation;this.lastRotation=e.rotation,Math.max(t)<10&&this.sendEvent("onRotate",this.position,t,"touch",e)}},onRotateEnd:function(e){this.lastRotation=0},onMultiDrag:function(e){console.log("Multi drag in frak")},onMouseWheel:function(e){if(e){e.preventDefault();var t=0;t="wheelDelta"in e?e.wheelDelta<0?1:e.wheelDelta>0?-1:0:e.deltaY>0?1:e.deltaY<0?-1:0,this.scrollDelta+=e.deltaY,this.translateCoordinates(this.position,e.clientX,e.clientY),this.sendEvent("onMouseWheel",this.position,this.scrollDelta,t,"mouse",e)}},onMouseWheelMOZ:function(e){if(e){e.preventDefault();var t=e.detail>0?1:e.detail<0?-1:0;this.scrollDelta+=e.detail,this.translateCoordinates(this.position,e.clientX,e.clientY),this.sendEvent("onMouseWheel",this.position,this.scrollDelta,t,"mouse",e)}},onKeyDown:function(e){e&&(this.sendEvent("onKeyDown",e.which,"keyboard",e),this.sendEvent("onKeyStateChange",e.which,!0,"keyboard",e),this.keyStates[e.which]=!0)},onKeyUp:function(e){e&&(this.sendEvent("onKeyUp",e.which,"keyboard",e),this.sendEvent("onKeyStateChange",e.which,!1,"keyboard",e),delete this.keyStates[e.which])},update:function(){this.processKeyEvents()},processKeyEvents:function(){for(var e in this.keyStates)if(this.bindings[e]){var t=this.bindings[e];t&&"object"==typeof t[0]&&"string"==typeof t[1]&&t[0][t[1]](this.engine.fps.getDelta()/1e3,e)}},setMouseButtons:function(e){if(e&&!(e.length<3)){this.button=-1;for(var t=0;t<3;t++)this.buttons[t]=e[t],!0===e[t]&&(this.button=t)}},resetMouseButtons:function(){this.button=-1,this.buttons[0]=!1,this.buttons[1]=!1,this.buttons[2]=!1}});HammerWF.MouseInput.prototype.handler=function(e){if("mousedown"==e.type&&(this.pressed=!0),this.pressed&&this.allow){"mouseup"==e.type&&(this.pressed=!1);var t=[!1,!1,!1];"buttons"in e?(t[0]=!!(1&e.buttons),t[1]=!!(4&e.buttons),t[2]=!!(2&e.buttons)):"button"in e&&(t[e.button]=!0);var i={mousedown:1,mousemove:2,mouseup:4};this.callback(this.manager,i[e.type],{pointers:[e],changedPointers:[e],pointerType:"mouse",srcEvent:e,frakButtons:t})}},HammerWF.PointerEventInput.prototype.handler=function(e){var t=this.store,i=!1,n={2:"touch",3:"pen",4:"mouse",5:"kinect"},r={pointerdown:1,pointermove:2,pointerup:4,pointercancel:8,pointerout:8}[e.type.toLowerCase().replace("ms","")],s=n[e.pointerType]||e.pointerType,a=function(e,t,i){if(e.indexOf&&!i)return e.indexOf(t);for(var n=0;n<e.length;){if(i&&e[n][i]==t||!i&&e[n]===t)return n;n++}return-1}(t,e.pointerId,"pointerId");if(1&r?a<0&&(t.push(e),a=t.length-1):12&r&&(i=!0),!(a<0)){t[a]=e;var o=[!!(1&e.buttons),!!(4&e.buttons),!!(2&e.buttons)];this.callback(this.manager,r,{pointers:t,changedPointers:[e],pointerType:s,srcEvent:e,frakButtons:o}),i&&t.splice(a,1)}};