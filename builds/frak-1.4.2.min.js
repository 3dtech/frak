var vec2={};if(!GLMAT_EPSILON)var GLMAT_EPSILON=1e-6;if(vec2.create=function(){return new Float32Array(2)},vec2.clone=function(e){var t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t},vec2.fromValues=function(e,t){var n=new Float32Array(2);return n[0]=e,n[1]=t,n},vec2.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},vec2.set=function(e,t,n){return e[0]=t,e[1]=n,e},vec2.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},vec2.sub=vec2.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e},vec2.mul=vec2.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},vec2.div=vec2.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},vec2.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},vec2.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},vec2.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},vec2.dist=vec2.distance=function(e,t){var n=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(n*n+i*i)},vec2.sqrDist=vec2.squaredDistance=function(e,t){var n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i},vec2.len=vec2.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},vec2.sqrLen=vec2.squaredLength=function(e){var t=e[0],n=e[1];return t*t+n*n},vec2.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},vec2.normalize=function(e,t){var n=t[0],i=t[1],r=n*n+i*i;return 0<r&&(r=1/Math.sqrt(r),e[0]=t[0]*r,e[1]=t[1]*r),e},vec2.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},vec2.cross=function(e,t,n){var i=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=i,e},vec2.lerp=function(e,t,n,i){var r=t[0],o=t[1];return e[0]=r+i*(n[0]-r),e[1]=o+i*(n[1]-o),e},vec2.transformMat2=function(e,t,n){var i=t[0],r=t[1];return e[0]=i*n[0]+r*n[1],e[1]=i*n[2]+r*n[3],e},vec2.forEach=function(){var l=new Float32Array(2);return function(e,t,n,i,r,o){var a,s;for(t||(t=2),n||(n=0),s=i?Math.min(i*t+n,e.length):e.length,a=n;a<s;a+=t)l[0]=e[a],l[1]=e[a+1],r(l,l,o),e[a]=l[0],e[a+1]=l[1];return e}}(),vec2.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},"undefined"!=typeof exports&&(exports.vec2=vec2),void 0===vec3)var vec3={};if(!GLMAT_EPSILON)GLMAT_EPSILON=1e-6;vec3.create=function(){return new Float32Array(3)},vec3.clone=function(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},vec3.fromValues=function(e,t,n){var i=new Float32Array(3);return i[0]=e,i[1]=t,i[2]=n,i},vec3.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},vec3.set=function(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e},vec3.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e},vec3.sub=vec3.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e},vec3.mul=vec3.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e},vec3.div=vec3.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e},vec3.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},vec3.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},vec3.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},vec3.dist=vec3.distance=function(e,t){var n=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(n*n+i*i+r*r)},vec3.sqrDist=vec3.squaredDistance=function(e,t){var n=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return n*n+i*i+r*r},vec3.len=vec3.length=function(e){var t=e[0],n=e[1],i=e[2];return Math.sqrt(t*t+n*n+i*i)},vec3.sqrLen=vec3.squaredLength=function(e){var t=e[0],n=e[1],i=e[2];return t*t+n*n+i*i},vec3.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},vec3.normalize=function(e,t){var n=t[0],i=t[1],r=t[2],o=n*n+i*i+r*r;return 0<o&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e},vec3.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},vec3.cross=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=n[0],s=n[1],l=n[2];return e[0]=r*l-o*s,e[1]=o*a-i*l,e[2]=i*s-r*a,e},vec3.lerp=function(e,t,n,i){var r=t[0],o=t[1],a=t[2];return e[0]=r+i*(n[0]-r),e[1]=o+i*(n[1]-o),e[2]=a+i*(n[2]-a),e},vec3.transformMat4=function(e,t,n){var i=t[0],r=t[1],o=t[2];return e[0]=n[0]*i+n[4]*r+n[8]*o+n[12],e[1]=n[1]*i+n[5]*r+n[9]*o+n[13],e[2]=n[2]*i+n[6]*r+n[10]*o+n[14],e},vec3.transformQuat=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=n[0],s=n[1],l=n[2],c=n[3],h=c*i+s*o-l*r,u=c*r+l*i-a*o,d=c*o+a*r-s*i,f=-a*i-s*r-l*o;return e[0]=h*c+f*-a+u*-l-d*-s,e[1]=u*c+f*-s+d*-a-h*-l,e[2]=d*c+f*-l+h*-s-u*-a,e},vec3.forEach=function(){var l=new Float32Array(3);return function(e,t,n,i,r,o){var a,s;for(t||(t=3),n||(n=0),s=i?Math.min(i*t+n,e.length):e.length,a=n;a<s;a+=t)l[0]=e[a],l[1]=e[a+1],l[2]=e[a+2],r(l,l,o),e[a]=l[0],e[a+1]=l[1],e[a+2]=l[2];return e}}(),vec3.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},"undefined"!=typeof exports&&(exports.vec3=vec3);var vec4={};if(!GLMAT_EPSILON)GLMAT_EPSILON=1e-6;vec4.create=function(){return new Float32Array(4)},vec4.clone=function(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},vec4.fromValues=function(e,t,n,i){var r=new Float32Array(4);return r[0]=e,r[1]=t,r[2]=n,r[3]=i,r},vec4.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},vec4.set=function(e,t,n,i,r){return e[0]=t,e[1]=n,e[2]=i,e[3]=r,e},vec4.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},vec4.sub=vec4.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e},vec4.mul=vec4.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e},vec4.div=vec4.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e},vec4.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},vec4.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},vec4.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},vec4.dist=vec4.distance=function(e,t){var n=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],o=t[3]-e[3];return Math.sqrt(n*n+i*i+r*r+o*o)},vec4.sqrDist=vec4.squaredDistance=function(e,t){var n=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],o=t[3]-e[3];return n*n+i*i+r*r+o*o},vec4.len=vec4.length=function(e){var t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)},vec4.sqrLen=vec4.squaredLength=function(e){var t=e[0],n=e[1],i=e[2],r=e[3];return t*t+n*n+i*i+r*r},vec4.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},vec4.normalize=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=n*n+i*i+r*r+o*o;return 0<a&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e[3]=t[3]*a),e},vec4.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},vec4.lerp=function(e,t,n,i){var r=t[0],o=t[1],a=t[2],s=t[3];return e[0]=r+i*(n[0]-r),e[1]=o+i*(n[1]-o),e[2]=a+i*(n[2]-a),e[3]=s+i*(n[3]-s),e},vec4.transformMat4=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3];return e[0]=n[0]*i+n[4]*r+n[8]*o+n[12]*a,e[1]=n[1]*i+n[5]*r+n[9]*o+n[13]*a,e[2]=n[2]*i+n[6]*r+n[10]*o+n[14]*a,e[3]=n[3]*i+n[7]*r+n[11]*o+n[15]*a,e},vec4.transformQuat=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=n[0],s=n[1],l=n[2],c=n[3],h=c*i+s*o-l*r,u=c*r+l*i-a*o,d=c*o+a*r-s*i,f=-a*i-s*r-l*o;return e[0]=h*c+f*-a+u*-l-d*-s,e[1]=u*c+f*-s+d*-a-h*-l,e[2]=d*c+f*-l+h*-s-u*-a,e},vec4.forEach=function(){var l=new Float32Array(4);return function(e,t,n,i,r,o){var a,s;for(t||(t=4),n||(n=0),s=i?Math.min(i*t+n,e.length):e.length,a=n;a<s;a+=t)l[0]=e[a],l[1]=e[a+1],l[2]=e[a+2],l[3]=e[a+3],r(l,l,o),e[a]=l[0],e[a+1]=l[1],e[a+2]=l[2],e[a+3]=l[3];return e}}(),vec4.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},"undefined"!=typeof exports&&(exports.vec4=vec4);var mat2={},mat2Identity=new Float32Array([1,0,0,1]);if(!GLMAT_EPSILON)GLMAT_EPSILON=1e-6;if(mat2.create=function(){return new Float32Array(mat2Identity)},mat2.clone=function(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},mat2.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},mat2.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},mat2.transpose=function(e,t){if(e===t){var n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},mat2.invert=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=n*o-r*i;return a?(a=1/a,e[0]=o*a,e[1]=-i*a,e[2]=-r*a,e[3]=n*a,e):null},mat2.adjoint=function(e,t){var n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e},mat2.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},mat2.mul=mat2.multiply=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=n[0],l=n[1],c=n[2],h=n[3];return e[0]=i*s+r*c,e[1]=i*l+r*h,e[2]=o*s+a*c,e[3]=o*l+a*h,e},mat2.rotate=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=i*l+r*s,e[1]=i*-s+r*l,e[2]=o*l+a*s,e[3]=o*-s+a*l,e},mat2.scale=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=n[0],l=n[1];return e[0]=i*s,e[1]=r*l,e[2]=o*s,e[3]=a*l,e},mat2.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},"undefined"!=typeof exports&&(exports.mat2=mat2),void 0===mat3)var mat3={};var mat3Identity=new Float32Array([1,0,0,0,1,0,0,0,1]);if(!GLMAT_EPSILON)GLMAT_EPSILON=1e-6;if(mat3.create=function(){return new Float32Array(mat3Identity)},mat3.clone=function(e){var t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},mat3.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},mat3.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},mat3.transpose=function(e,t){if(e===t){var n=t[1],i=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=i,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},mat3.invert=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],u=h*a-s*c,d=-h*o+s*l,f=c*o-a*l,m=n*u+i*d+r*f;return m?(m=1/m,e[0]=u*m,e[1]=(-h*i+r*c)*m,e[2]=(s*i-r*a)*m,e[3]=d*m,e[4]=(h*n-r*l)*m,e[5]=(-s*n+r*o)*m,e[6]=f*m,e[7]=(-c*n+i*l)*m,e[8]=(a*n-i*o)*m,e):null},mat3.adjoint=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8];return e[0]=a*h-s*c,e[1]=r*c-i*h,e[2]=i*s-r*a,e[3]=s*l-o*h,e[4]=n*h-r*l,e[5]=r*o-n*s,e[6]=o*c-a*l,e[7]=i*l-n*c,e[8]=n*a-i*o,e},mat3.determinant=function(e){var t=e[0],n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=e[6],l=e[7],c=e[8];return t*(c*o-a*l)+n*(-c*r+a*s)+i*(l*r-o*s)},mat3.mul=mat3.multiply=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=n[0],f=n[1],m=n[2],v=n[3],p=n[4],g=n[5],x=n[6],w=n[7],b=n[8];return e[0]=d*i+f*a+m*c,e[1]=d*r+f*s+m*h,e[2]=d*o+f*l+m*u,e[3]=v*i+p*a+g*c,e[4]=v*r+p*s+g*h,e[5]=v*o+p*l+g*u,e[6]=x*i+w*a+b*c,e[7]=x*r+w*s+b*h,e[8]=x*o+w*l+b*u,e},mat3.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},"undefined"!=typeof exports&&(exports.mat3=mat3),void 0===mat4)var mat4={};var mat4Identity=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);if(!GLMAT_EPSILON)GLMAT_EPSILON=1e-6;if(mat4.create=function(){return new Float32Array(mat4Identity)},mat4.clone=function(e){var t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},mat4.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},mat4.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.transpose=function(e,t){if(e===t){var n=t[1],i=t[2],r=t[3],o=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=o,e[11]=t[14],e[12]=r,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},mat4.invert=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],u=t[9],d=t[10],f=t[11],m=t[12],v=t[13],p=t[14],g=t[15],x=n*s-i*a,w=n*l-r*a,b=n*c-o*a,T=i*l-r*s,y=i*c-o*s,S=r*c-o*l,C=h*v-u*m,E=h*p-d*m,_=h*g-f*m,R=u*p-d*v,D=u*g-f*v,P=d*g-f*p,M=x*P-w*D+b*R+T*_-y*E+S*C;return M?(M=1/M,e[0]=(s*P-l*D+c*R)*M,e[1]=(r*D-i*P-o*R)*M,e[2]=(v*S-p*y+g*T)*M,e[3]=(d*y-u*S-f*T)*M,e[4]=(l*_-a*P-c*E)*M,e[5]=(n*P-r*_+o*E)*M,e[6]=(p*b-m*S-g*w)*M,e[7]=(h*S-d*b+f*w)*M,e[8]=(a*D-s*_+c*C)*M,e[9]=(i*_-n*D-o*C)*M,e[10]=(m*y-v*b+g*x)*M,e[11]=(u*b-h*y-f*x)*M,e[12]=(s*E-a*R-l*C)*M,e[13]=(n*R-i*E+r*C)*M,e[14]=(v*w-m*T-p*x)*M,e[15]=(h*T-u*w+d*x)*M,e):null},mat4.adjoint=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],u=t[9],d=t[10],f=t[11],m=t[12],v=t[13],p=t[14],g=t[15];return e[0]=s*(d*g-f*p)-u*(l*g-c*p)+v*(l*f-c*d),e[1]=-(i*(d*g-f*p)-u*(r*g-o*p)+v*(r*f-o*d)),e[2]=i*(l*g-c*p)-s*(r*g-o*p)+v*(r*c-o*l),e[3]=-(i*(l*f-c*d)-s*(r*f-o*d)+u*(r*c-o*l)),e[4]=-(a*(d*g-f*p)-h*(l*g-c*p)+m*(l*f-c*d)),e[5]=n*(d*g-f*p)-h*(r*g-o*p)+m*(r*f-o*d),e[6]=-(n*(l*g-c*p)-a*(r*g-o*p)+m*(r*c-o*l)),e[7]=n*(l*f-c*d)-a*(r*f-o*d)+h*(r*c-o*l),e[8]=a*(u*g-f*v)-h*(s*g-c*v)+m*(s*f-c*u),e[9]=-(n*(u*g-f*v)-h*(i*g-o*v)+m*(i*f-o*u)),e[10]=n*(s*g-c*v)-a*(i*g-o*v)+m*(i*c-o*s),e[11]=-(n*(s*f-c*u)-a*(i*f-o*u)+h*(i*c-o*s)),e[12]=-(a*(u*p-d*v)-h*(s*p-l*v)+m*(s*d-l*u)),e[13]=n*(u*p-d*v)-h*(i*p-r*v)+m*(i*d-r*u),e[14]=-(n*(s*p-l*v)-a*(i*p-r*v)+m*(i*l-r*s)),e[15]=n*(s*d-l*u)-a*(i*d-r*u)+h*(i*l-r*s),e},mat4.determinant=function(e){var t=e[0],n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11],f=e[12],m=e[13],v=e[14],p=e[15];return(t*a-n*o)*(u*p-d*v)-(t*s-i*o)*(h*p-d*m)+(t*l-r*o)*(h*v-u*m)+(n*s-i*a)*(c*p-d*f)-(n*l-r*a)*(c*v-u*f)+(i*l-r*s)*(c*m-h*f)},mat4.mul=mat4.multiply=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],f=t[10],m=t[11],v=t[12],p=t[13],g=t[14],x=t[15],w=n[0],b=n[1],T=n[2],y=n[3];return e[0]=w*i+b*s+T*u+y*v,e[1]=w*r+b*l+T*d+y*p,e[2]=w*o+b*c+T*f+y*g,e[3]=w*a+b*h+T*m+y*x,w=n[4],b=n[5],T=n[6],y=n[7],e[4]=w*i+b*s+T*u+y*v,e[5]=w*r+b*l+T*d+y*p,e[6]=w*o+b*c+T*f+y*g,e[7]=w*a+b*h+T*m+y*x,w=n[8],b=n[9],T=n[10],y=n[11],e[8]=w*i+b*s+T*u+y*v,e[9]=w*r+b*l+T*d+y*p,e[10]=w*o+b*c+T*f+y*g,e[11]=w*a+b*h+T*m+y*x,w=n[12],b=n[13],T=n[14],y=n[15],e[12]=w*i+b*s+T*u+y*v,e[13]=w*r+b*l+T*d+y*p,e[14]=w*o+b*c+T*f+y*g,e[15]=w*a+b*h+T*m+y*x,e},mat4.translate=function(e,t,n){var i,r,o,a,s,l,c,h,u,d,f,m,v=n[0],p=n[1],g=n[2];return e[15]=t===e?(e[12]=t[0]*v+t[4]*p+t[8]*g+t[12],e[13]=t[1]*v+t[5]*p+t[9]*g+t[13],e[14]=t[2]*v+t[6]*p+t[10]*g+t[14],t[3]*v+t[7]*p+t[11]*g+t[15]):(i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],f=t[10],m=t[11],e[0]=i,e[1]=r,e[2]=o,e[3]=a,e[4]=s,e[5]=l,e[6]=c,e[7]=h,e[8]=u,e[9]=d,e[10]=f,e[11]=m,e[12]=i*v+s*p+u*g+t[12],e[13]=r*v+l*p+d*g+t[13],e[14]=o*v+c*p+f*g+t[14],a*v+h*p+m*g+t[15]),e},mat4.scale=function(e,t,n){var i=n[0],r=n[1],o=n[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},mat4.rotate=function(e,t,n,i){var r,o,a,s,l,c,h,u,d,f,m,v,p,g,x,w,b,T,y,S,C,E,_,R,D=i[0],P=i[1],M=i[2],F=Math.sqrt(D*D+P*P+M*M);return Math.abs(F)<GLMAT_EPSILON?null:(D*=F=1/F,P*=F,M*=F,r=Math.sin(n),a=1-(o=Math.cos(n)),s=t[0],l=t[1],c=t[2],h=t[3],u=t[4],d=t[5],f=t[6],m=t[7],v=t[8],p=t[9],g=t[10],x=t[11],w=D*D*a+o,b=P*D*a+M*r,T=M*D*a-P*r,y=D*P*a-M*r,S=P*P*a+o,C=M*P*a+D*r,E=D*M*a+P*r,_=P*M*a-D*r,R=M*M*a+o,e[0]=s*w+u*b+v*T,e[1]=l*w+d*b+p*T,e[2]=c*w+f*b+g*T,e[3]=h*w+m*b+x*T,e[4]=s*y+u*S+v*C,e[5]=l*y+d*S+p*C,e[6]=c*y+f*S+g*C,e[7]=h*y+m*S+x*C,e[8]=s*E+u*_+v*R,e[9]=l*E+d*_+p*R,e[10]=c*E+f*_+g*R,e[11]=h*E+m*_+x*R,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},mat4.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[4],a=t[5],s=t[6],l=t[7],c=t[8],h=t[9],u=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*r+c*i,e[5]=a*r+h*i,e[6]=s*r+u*i,e[7]=l*r+d*i,e[8]=c*r-o*i,e[9]=h*r-a*i,e[10]=u*r-s*i,e[11]=d*r-l*i,e},mat4.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[0],a=t[1],s=t[2],l=t[3],c=t[8],h=t[9],u=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r-c*i,e[1]=a*r-h*i,e[2]=s*r-u*i,e[3]=l*r-d*i,e[8]=o*i+c*r,e[9]=a*i+h*r,e[10]=s*i+u*r,e[11]=l*i+d*r,e},mat4.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[0],a=t[1],s=t[2],l=t[3],c=t[4],h=t[5],u=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r+c*i,e[1]=a*r+h*i,e[2]=s*r+u*i,e[3]=l*r+d*i,e[4]=c*r-o*i,e[5]=h*r-a*i,e[6]=u*r-s*i,e[7]=d*r-l*i,e},mat4.fromRotationTranslation=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=i+i,l=r+r,c=o+o,h=i*s,u=i*l,d=i*c,f=r*l,m=r*c,v=o*c,p=a*s,g=a*l,x=a*c;return e[0]=1-(f+v),e[1]=u+x,e[2]=d-g,e[3]=0,e[4]=u-x,e[5]=1-(h+v),e[6]=m+p,e[7]=0,e[8]=d+g,e[9]=m-p,e[10]=1-(h+f),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e},mat4.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),l=1/(r-i),c=1/(o-a);return e[0]=2*o*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*l,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(r+i)*l,e[10]=(a+o)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*o*2*c,e[15]=0,e},mat4.perspective=function(e,t,n,i,r){var o=1/Math.tan(t/2),a=1/(i-r);return e[0]=o/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(r+i)*a,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*r*i*a,e[15]=0,e},mat4.ortho=function(e,t,n,i,r,o,a){var s=1/(t-n),l=1/(i-r),c=1/(o-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+n)*s,e[13]=(r+i)*l,e[14]=(a+o)*c,e[15]=1,e},mat4.lookAt=function(e,t,n,i){var r,o,a,s,l,c,h,u,d,f,m=t[0],v=t[1],p=t[2],g=i[0],x=i[1],w=i[2],b=n[0],T=n[1],y=n[2];return Math.abs(m-b)<GLMAT_EPSILON&&Math.abs(v-T)<GLMAT_EPSILON&&Math.abs(p-y)<GLMAT_EPSILON?mat4.identity(e):(h=m-b,u=v-T,d=p-y,r=x*(d*=f=1/Math.sqrt(h*h+u*u+d*d))-w*(u*=f),o=w*(h*=f)-g*d,a=g*u-x*h,(f=Math.sqrt(r*r+o*o+a*a))?(r*=f=1/f,o*=f,a*=f):a=o=r=0,s=u*a-d*o,l=d*r-h*a,c=h*o-u*r,(f=Math.sqrt(s*s+l*l+c*c))?(s*=f=1/f,l*=f,c*=f):c=l=s=0,e[0]=r,e[1]=s,e[2]=h,e[3]=0,e[4]=o,e[5]=l,e[6]=u,e[7]=0,e[8]=a,e[9]=c,e[10]=d,e[11]=0,e[12]=-(r*m+o*v+a*p),e[13]=-(s*m+l*v+c*p),e[14]=-(h*m+u*v+d*p),e[15]=1,e)},mat4.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},"undefined"!=typeof exports&&(exports.mat4=mat4),void 0===quat)var quat={};var quatIdentity=new Float32Array([0,0,0,1]);if(!GLMAT_EPSILON)GLMAT_EPSILON=1e-6;quat.create=function(){return new Float32Array(quatIdentity)},quat.clone=vec4.clone,quat.fromValues=vec4.fromValues,quat.copy=vec4.copy,quat.set=vec4.set,quat.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},quat.setAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(n),e},quat.add=vec4.add,quat.mul=quat.multiply=function(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=n[0],l=n[1],c=n[2],h=n[3];return e[0]=i*h+a*s+r*c-o*l,e[1]=r*h+a*l+o*s-i*c,e[2]=o*h+a*c+i*l-r*s,e[3]=a*h-i*s-r*l-o*c,e},quat.scale=vec4.scale,quat.rotateX=function(e,t,n){n*=.5;var i=t[0],r=t[1],o=t[2],a=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=i*l+a*s,e[1]=r*l+o*s,e[2]=o*l-r*s,e[3]=a*l-i*s,e},quat.rotateY=function(e,t,n){n*=.5;var i=t[0],r=t[1],o=t[2],a=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=i*l-o*s,e[1]=r*l+a*s,e[2]=o*l+i*s,e[3]=a*l-r*s,e},quat.rotateZ=function(e,t,n){n*=.5;var i=t[0],r=t[1],o=t[2],a=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=i*l+r*s,e[1]=r*l-i*s,e[2]=o*l+a*s,e[3]=a*l-o*s,e},quat.calculateW=function(e,t){var n=t[0],i=t[1],r=t[2];return e[0]=n,e[1]=i,e[2]=r,e[3]=-Math.sqrt(Math.abs(1-n*n-i*i-r*r)),e},quat.dot=vec4.dot,quat.lerp=vec4.lerp,quat.slerp=function(e,t,n,i){var r,o,a,s,l=t[0],c=t[1],h=t[2],u=t[3],d=n[0],f=n[1],m=n[2],v=t[3],p=l*d+c*f+h*m+u*v;return 1<=Math.abs(p)?(e!==t&&(e[0]=l,e[1]=c,e[2]=h,e[3]=u),e):(r=Math.acos(p),o=Math.sqrt(1-p*p),Math.abs(o)<.001?(e[0]=.5*l+.5*d,e[1]=.5*c+.5*f,e[2]=.5*h+.5*m,e[3]=.5*u+.5*v):(a=Math.sin((1-i)*r)/o,s=Math.sin(i*r)/o,e[0]=l*a+d*s,e[1]=c*a+f*s,e[2]=h*a+m*s,e[3]=u*a+v*s),e)},quat.invert=function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=n*n+i*i+r*r+o*o,s=a?1/a:0;return e[0]=-n*s,e[1]=-i*s,e[2]=-r*s,e[3]=o*s,e},quat.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},quat.len=quat.length=vec4.length,quat.sqrLen=quat.squaredLength=vec4.squaredLength,quat.normalize=vec4.normalize,quat.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"};var EPSILON=1e-6;if(void 0===mat3)mat3={};if(mat3.normalize=function(e,t){var n;return n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),e[0]=t[0]/n,e[1]=t[1]/n,e[2]=t[2]/n,n=Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]),e[3]=t[3]/n,e[4]=t[4]/n,e[5]=t[5]/n,n=Math.sqrt(t[6]*t[6]+t[7]*t[7]+t[8]*t[8]),e[6]=t[6]/n,e[7]=t[7]/n,e[8]=t[8]/n,e},void 0===mat4)mat4={};if(mat4.submat3=function(e,t,n){return e[0]=t[0+n[0]+4*n[1]],e[1]=t[1+n[0]+4*n[1]],e[2]=t[2+n[0]+4*n[1]],e[3]=t[4+n[0]+4*n[1]],e[4]=t[5+n[0]+4*n[1]],e[5]=t[6+n[0]+4*n[1]],e[6]=t[8+n[0]+4*n[1]],e[7]=t[9+n[0]+4*n[1]],e[8]=t[10+n[0]+4*n[1]],e},mat4.setsubmat3=function(e,t,n){return e[0+n[0]+4*n[1]]=t[0],e[1+n[0]+4*n[1]]=t[1],e[2+n[0]+4*n[1]]=t[2],e[4+n[0]+4*n[1]]=t[3],e[5+n[0]+4*n[1]]=t[4],e[6+n[0]+4*n[1]]=t[5],e[8+n[0]+4*n[1]]=t[6],e[9+n[0]+4*n[1]]=t[7],e[10+n[0]+4*n[1]]=t[8],e},mat4.rotation=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.translation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},mat4.getScale=function(e,t){return e[0]=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]),e[1]=Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]+t[7]*t[7]),e[2]=Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]+t[11]*t[11]),e},mat4.normalize=function(e,t){var n;return n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]),e[0]=t[0]/n,e[1]=t[1]/n,e[2]=t[2]/n,e[3]=t[3]/n,n=Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]+t[7]*t[7]),e[4]=t[4]/n,e[5]=t[5]/n,e[6]=t[6]/n,e[7]=t[7]/n,n=Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]+t[11]*t[11]),e[8]=t[8]/n,e[9]=t[9]/n,e[10]=t[10]/n,e[11]=t[11]/n,n=Math.sqrt(t[12]*t[12]+t[13]*t[13]+t[14]*t[14]+t[15]*t[15]),e[12]=t[12]/n,e[13]=t[13]/n,e[14]=t[14]/n,e[15]=t[15]/n,e},mat4.fromRotationTranslationScale=function(e,t,n,i){return mat4.fromRotationTranslation(e,t,n),mat4.scale(e,e,i),e},mat4.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},mat4.decompose=function(e,t,n,i){mat4.translation(e,i),quat.fromMat4(t,i),mat4.getScale(n,i)},mat4.isIdentity=function(e){return!(Math.abs(e[0]-1)>EPSILON)&&(!(Math.abs(e[5]-1)>EPSILON)&&(!(Math.abs(e[10]-1)>EPSILON)&&(!(Math.abs(e[15]-1)>EPSILON)&&(!(Math.abs(e[1])>EPSILON)&&(!(Math.abs(e[2])>EPSILON)&&(!(Math.abs(e[3])>EPSILON)&&(!(Math.abs(e[4])>EPSILON)&&(!(Math.abs(e[6])>EPSILON)&&(!(Math.abs(e[7])>EPSILON)&&(!(Math.abs(e[8])>EPSILON)&&(!(Math.abs(e[9])>EPSILON)&&(!(Math.abs(e[11])>EPSILON)&&(!(Math.abs(e[12])>EPSILON)&&(!(Math.abs(e[13])>EPSILON)&&!(Math.abs(e[14])>EPSILON)))))))))))))))},void 0===quat)quat={};if(quat.euler=function(e,t,n,i){var r=2*Math.PI/360,o=quat.create(),a=vec3.fromValues(0,0,1);return quat.setAxisAngle(e,a,r*i),vec3.set(a,0,1,0),quat.setAxisAngle(o,a,r*n),quat.mul(e,e,o),vec3.set(a,1,0,0),quat.setAxisAngle(o,a,r*t),quat.mul(e,e,o),e},quat.getEuler=function(n,e){var i=360/(2*Math.PI),r=mat4.fromRotationTranslation(mat4.create(),e,[0,0,0]),t=function(e,t){return Math.abs(e-t)<=EPSILON};if(t(Math.abs(r[2]),1))t(r[2],-1)?(n[0]=0,n[1]=90,n[2]=-i*Math.atan2(r[4],r[8])):(n[0]=0,n[1]=-90,n[2]=i*Math.atan2(-r[4],-r[8]));else{var o=function(e){var t=Math.cos(e);n[0]=Math.atan2(r[6]/t,r[10]/t)*i,n[1]=e*i,n[2]=Math.atan2(r[1]/t,r[0]/t)*i},a=-Math.asin(r[2]);o(a),function(e,t){var n=quat.euler(quat.create(),t[0],t[1],t[2]);quat.normalize(n,n);var i=quat.rotationDifference(quat.create(),e,n);return Math.abs(1-i[3])<EPSILON}(e,n)||o(a=Math.PI-a)}return n},quat.fromMat3=function(e,t){var n=t[0]+t[4]+t[8];if(EPSILON<n){var i=2*Math.sqrt(1+n);e[3]=.25*i,e[0]=(t[5]-t[7])/i,e[1]=(t[6]-t[2])/i,e[2]=(t[1]-t[3])/i}else if(t[0]>t[4]&&t[0]>t[8]){i=2*Math.sqrt(1+t[0]-t[4]-t[8]);e[3]=(t[5]-t[7])/i,e[0]=.25*i,e[1]=(t[1]+t[3])/i,e[2]=(t[6]+t[2])/i}else if(t[4]>t[8]){i=2*Math.sqrt(1+t[4]-t[0]-t[8]);e[3]=(t[6]-t[2])/i,e[0]=(t[1]+t[3])/i,e[1]=.25*i,e[2]=(t[5]+t[7])/i}else{i=2*Math.sqrt(1+t[8]-t[0]-t[4]);e[3]=(t[1]-t[3])/i,e[0]=(t[6]+t[2])/i,e[1]=(t[5]+t[7])/i,e[2]=.25*i}return e},quat.fromMat4=function(e,t){var n=mat4.submat3(mat3.create(),t,[0,0]);return mat3.normalize(n,n),quat.fromMat3(e,n),quat.normalize(e,e),e},quat.rotationDifference=function(e,t,n){return quat.multiply(e,n,quat.conjugate(quat.create(),t)),e},quat.angle=function(e,t){var n=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(1-n)<EPSILON&&(n=1),Math.abs(1+n)<EPSILON&&(n=-1),2*Math.acos(n)},quat.slerp=function(e,t,n,i){var r,o,a=t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3];if(Math.abs(1-a)<EPSILON&&(a=1),Math.abs(1+a)<EPSILON&&(a=-1),1-Math.abs(a)>EPSILON){var s=Math.acos(Math.abs(a)),l=Math.sin(s);r=Math.sin((1-i)*s/l),o=Math.sin(i*s/l)}else r=1-i,o=i;a<0&&(o=-o);var c=quat.scale(quat.create(),t,r),h=quat.scale(quat.create(),n,o);return quat.add(e,c,h),e},quat.getTwist=function(e,t){var n=vec3.create(),i=vec3.transformQuat(vec3.create(),t,quat.euler(quat.create(),90,0,0)),r=vec3.dot(t,i);.6<Math.abs(r)&&(i=vec3.transformQuat(t,quat.euler(quat.create(),0,90,0))),vec3.normalize(i,i),vec3.cross(n,t,i),vec3.normalize(n,n);var o=vec3.transformQuat(vec3.create(),n,e),a=vec3.sub(vec3.create(),o,vec3.scale(vec3.create(),t,vec3.dot(o,t)));return vec3.normalize(a,a),Math.acos(vec3.dot(n,a))},void 0===vec3)vec3={};function lerp(e,t,n){return e+(t-e)*n}function clampAngle(e,t,n){return e<-2*Math.PI&&(e+=2*Math.PI),e>2*Math.PI&&(e-=2*Math.PI),e=Math.max(t,e),e=Math.min(n,e)}function nextLowestPowerOfTwo(e){return Math.max(Math.min(Math.pow(2,Math.floor(Math.log(e)/Math.log(2))),2048),1)}function nextHighestPowerOfTwo(e){return Math.max(Math.min(Math.pow(2,Math.ceil(Math.log(e)/Math.log(2))),2048),1)}vec3.transformVertexArrayMat4=function(e,t,n){for(var i=0,r=0,o=0,a=n;a<e.length;a+=3)i=e[a],r=e[a+1],o=e[a+2],e[a]=t[0]*i+t[4]*r+t[8]*o+t[12],e[a+1]=t[1]*i+t[5]*r+t[9]*o+t[13],e[a+2]=t[2]*i+t[6]*r+t[10]*o+t[14];return e},vec3.transformVertexArrayQuat=function(e,t,n){for(var i=0,r=0,o=0,a=t[0],s=t[1],l=t[2],c=t[3],h=0,u=0,d=0,f=0,m=n;m<e.length;m+=3)i=e[m],r=e[m+1],h=c*i+s*(o=e[m+2])-l*r,u=c*r+l*i-a*o,d=c*o+a*r-s*i,f=-a*i-s*r-l*o,e[m]=h*c+f*-a+u*-l-d*-s,e[m+1]=u*c+f*-s+d*-a-h*-l,e[m+2]=d*c+f*-l+h*-s-u*-a;return e},vec3.scaleAndAdd=function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e},function(a){var s={ArrayBuffer:"undefined"!=typeof ArrayBuffer,DataView:"undefined"!=typeof DataView&&("getFloat64"in DataView.prototype||"getFloat64"in new DataView(new ArrayBuffer(1))),NodeBuffer:"undefined"!=typeof Buffer&&"readInt16LE"in Buffer.prototype},l={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8},c={Int8:"Int8",Int16:"Int16",Int32:"Int32",Uint8:"UInt8",Uint16:"UInt16",Uint32:"UInt32",Float32:"Float",Float64:"Double"},h=function(e,t,n,i){if(!(this instanceof h))throw new Error("jDataView constructor may not be called as a function");if(this.buffer=e,!(s.NodeBuffer&&e instanceof Buffer||s.ArrayBuffer&&e instanceof ArrayBuffer||"string"==typeof e))throw new TypeError("jDataView buffer has an incompatible type");this._isArrayBuffer=s.ArrayBuffer&&e instanceof ArrayBuffer,this._isDataView=s.DataView&&this._isArrayBuffer,this._isNodeBuffer=s.NodeBuffer&&e instanceof Buffer,this._littleEndian=void 0!==i&&i;var r=this._isArrayBuffer?e.byteLength:e.length;if(void 0===t&&(t=0),this.byteOffset=t,void 0===n&&(n=r-t),this.byteLength=n,!this._isDataView){if("number"!=typeof t)throw new TypeError("jDataView byteOffset is not a number");if("number"!=typeof n)throw new TypeError("jDataView byteLength is not a number");if(t<0)throw new Error("jDataView byteOffset is negative");if(n<0)throw new Error("jDataView byteLength is negative")}if(this._isDataView&&(this._view=new DataView(e,t,n),this._start=0),r<(this._start=t)+n)throw new Error("jDataView (byteOffset + byteLength) value is out of bounds");if(this._offset=0,this._isDataView)for(var o in l)l.hasOwnProperty(o)&&function(n,i){var r=l[n];i["get"+n]=function(e,t){return void 0===t&&(t=i._littleEndian),void 0===e&&(e=i._offset),i._offset=e+r,i._view["get"+n](e,t)}}(o,this);else if(this._isNodeBuffer&&s.NodeBuffer)for(var o in l){if(l.hasOwnProperty(o))(function(e,n,i){var r=l[e];n["get"+e]=function(e,t){return void 0===t&&(t=n._littleEndian),void 0===e&&(e=n._offset),n._offset=e+r,n.buffer[i](n._start+e)}})(o,this,"Int8"===o||"Uint8"===o?"read"+c[o]:i?"read"+c[o]+"LE":"read"+c[o]+"BE")}else for(var o in l)l.hasOwnProperty(o)&&function(n,i){var r=l[n];i["get"+n]=function(e,t){if(void 0===t&&(t=i._littleEndian),void 0===e&&(e=i._offset),i._offset=e+r,i._isArrayBuffer&&(i._start+e)%r==0&&(1===r||t))return new a[n+"Array"](i.buffer,i._start+e,1)[0];if("number"!=typeof e)throw new TypeError("jDataView byteOffset is not a number");if(e+r>i.byteLength)throw new Error("jDataView (byteOffset + size) value is out of bounds");return i["_get"+n](i._start+e,t)}}(o,this)};if(h.createBuffer=s.NodeBuffer?function(){for(var e=new Buffer(arguments.length),t=0;t<arguments.length;++t)e[t]=arguments[t];return e}:s.ArrayBuffer?function(){for(var e=new ArrayBuffer(arguments.length),t=new Int8Array(e),n=0;n<arguments.length;++n)t[n]=arguments[n];return e}:function(){return String.fromCharCode.apply(null,arguments)},h.prototype={compatibility:s,getString:function(e,t){var n;if(void 0===t&&(t=this._offset),"number"!=typeof t)throw new TypeError("jDataView byteOffset is not a number");if(e<0||t+e>this.byteLength)throw new Error("jDataView length or (byteOffset+length) value is out of bounds");if(this._isNodeBuffer)n=this.buffer.toString("ascii",this._start+t,this._start+t+e);else{n="";for(var i=0;i<e;++i){var r=this.getUint8(t+i);n+=String.fromCharCode(127<r?65533:r)}}return this._offset=t+e,n},getChar:function(e){return this.getString(1,e)},tell:function(){return this._offset},seek:function(e){if("number"!=typeof e)throw new TypeError("jDataView byteOffset is not a number");if(e<0||e>this.byteLength)throw new Error("jDataView byteOffset value is out of bounds");return this._offset=e},_endianness:function(e,t,n,i){return e+(i?n-t-1:t)},_getFloat64:function(e,t){var n=this._getUint8(this._endianness(e,0,8,t)),i=this._getUint8(this._endianness(e,1,8,t)),r=this._getUint8(this._endianness(e,2,8,t)),o=this._getUint8(this._endianness(e,3,8,t)),a=this._getUint8(this._endianness(e,4,8,t)),s=this._getUint8(this._endianness(e,5,8,t)),l=this._getUint8(this._endianness(e,6,8,t)),c=this._getUint8(this._endianness(e,7,8,t)),h=1-2*(n>>7),u=((n<<1&255)<<3|i>>4)-(Math.pow(2,10)-1),d=(15&i)*Math.pow(2,48)+r*Math.pow(2,40)+o*Math.pow(2,32)+a*Math.pow(2,24)+s*Math.pow(2,16)+l*Math.pow(2,8)+c;return 1024===u?0!==d?NaN:h*(1/0):-1023===u?h*d*Math.pow(2,-1074):h*(1+d*Math.pow(2,-52))*Math.pow(2,u)},_getFloat32:function(e,t){var n=this._getUint8(this._endianness(e,0,4,t)),i=this._getUint8(this._endianness(e,1,4,t)),r=1-2*(n>>7),o=(n<<1&255|i>>7)-127,a=(127&i)<<16|this._getUint8(this._endianness(e,2,4,t))<<8|this._getUint8(this._endianness(e,3,4,t));return 128===o?0!==a?NaN:r*(1/0):-127===o?r*a*Math.pow(2,-149):r*(1+a*Math.pow(2,-23))*Math.pow(2,o)},_getInt32:function(e,t){var n=this._getUint32(e,t);return n>Math.pow(2,31)-1?n-Math.pow(2,32):n},_getUint32:function(e,t){var n=this._getUint8(this._endianness(e,0,4,t)),i=this._getUint8(this._endianness(e,1,4,t)),r=this._getUint8(this._endianness(e,2,4,t)),o=this._getUint8(this._endianness(e,3,4,t));return n*Math.pow(2,24)+(i<<16)+(r<<8)+o},_getInt16:function(e,t){var n=this._getUint16(e,t);return n>Math.pow(2,15)-1?n-Math.pow(2,16):n},_getUint16:function(e,t){return(this._getUint8(this._endianness(e,0,2,t))<<8)+this._getUint8(this._endianness(e,1,2,t))},_getInt8:function(e){var t=this._getUint8(e);return t>Math.pow(2,7)-1?t-Math.pow(2,8):t},_getUint8:function(e){return this._isArrayBuffer?new Uint8Array(this.buffer,e,1)[0]:this._isNodeBuffer?this.buffer[e]:255&this.buffer.charCodeAt(e)}},"undefined"!=typeof jQuery&&"1.6.2"<=jQuery.fn.jquery){jQuery.ajaxSetup({converters:{"* dataview":function(e){return new h(e)}},accepts:{dataview:"text/plain; charset=x-user-defined"},responseHandler:{dataview:function(e,t,n){"mozResponseArrayBuffer"in n?e.text=n.mozResponseArrayBuffer:"responseType"in n&&"arraybuffer"===n.responseType&&n.response?e.text=n.response:e.text="responseBody"in n?function(t){var n;try{n=IEBinaryToArray_ByteStr(t)}catch(e){window.execScript("Function IEBinaryToArray_ByteStr(Binary)\r\n\tIEBinaryToArray_ByteStr = CStr(Binary)\r\nEnd Function\r\nFunction IEBinaryToArray_ByteStr_Last(Binary)\r\n\tDim lastIndex\r\n\tlastIndex = LenB(Binary)\r\n\tif lastIndex mod 2 Then\r\n\t\tIEBinaryToArray_ByteStr_Last = AscB( MidB( Binary, lastIndex, 1 ) )\r\n\tElse\r\n\t\tIEBinaryToArray_ByteStr_Last = -1\r\n\tEnd If\r\nEnd Function\r\n","vbscript"),n=IEBinaryToArray_ByteStr(t)}for(var e,i=IEBinaryToArray_ByteStr_Last(t),r="",o=0,a=n.length%8;o<a;)e=n.charCodeAt(o++),r+=String.fromCharCode(255&e,e>>8);for(a=n.length;o<a;)r+=String.fromCharCode(255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8,255&(e=n.charCodeAt(o++)),e>>8);return-1<i&&(r+=String.fromCharCode(i)),r}(n.responseBody):n.responseText}}}),jQuery.ajaxPrefilter("dataview",function(e,t,n){jQuery.support.ajaxResponseType&&(e.hasOwnProperty("xhrFields")||(e.xhrFields={}),e.xhrFields.responseType="arraybuffer"),e.mimeType="text/plain; charset=x-user-defined"})}a.jDataView=(a.module||{}).exports=h,"undefined"!=typeof module&&(module.exports=h)}(this);var FrakClass=function(){};function FrakCallback(e,t){return function(){return t.apply(e,arguments)}}!function(){var n=!1,i=/\b_super\b/;this.FrakClass=function(){},FrakClass.extend=function(s){var r=this.prototype;n=!0;var l=new this;for(var e in n=!1,s)l[e]="function"==typeof s[e]&&"function"==typeof r[e]&&i.test(s[e])?function(n,i){return function(){var e=this._super;this._super=r[n];var t=i.apply(this,arguments);return this._super=e,t}}(e,s[e]):s[e];function t(){!n&&this.init&&this.init.apply(this,arguments)}return l._getset=function(t,e){var n,i,r,o=function(){return t},a=function(e){t=e};l[n="get"+e]=n in s?(i=s[n],function(){var e=this._super;this._super=o;var t=i.apply(this,arguments);return this._super=e,t}):o,l[n="set"+e]=n in s?(r=s[n],function(){var e=this._super;this._super=a;var t=r.apply(this,arguments);return this._super=e,t}):a},((t.prototype=l).constructor=t).extend=arguments.callee,t}}(),"undefined"!=typeof window&&(window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,16)}),"undefined"!=typeof window&&(window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})),"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var n=arguments;return this.replace(/{(\d+)}/g,function(e,t){return void 0!==n[t]?n[t]:e})}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)});var Logistics=function(){var t=!1;"undefined"!=typeof window&&(t="localStorage"in window&&null!==window.localStorage);var a=[],r=[],o=0,n=null,i=null,e=null,s={loadFromLocalStorage:!1,storeToLocalStorage:!1,loadFromFile:!1,enableCORS:!0,useCookies:!1,fallbackFromStorage:!1},l={text:{load:function(e){x(e)},parse:function(e,t){e.data=t.responseText},store:function(e){return e.data},restore:function(e,t){return t}},json:{load:function(e){x(e)},parse:function(t,e){try{t.data=JSON.parse(e.responseText)}catch(e){"undefined"!=typeof console&&console.error&&console.error("JSON parsing failed for "+t.url,e)}},store:function(e){return JSON.stringify(e.data)},restore:function(e,t){return t?JSON.parse(t):{}}},xml:{load:function(e){x(e)},parse:function(e,t){t.responseXML?e.data=t.responseXML:e.data=w(t.responseText)},store:function(e){return XMLSerializer?(new XMLSerializer).serializeToString(e.data):""},restore:function(e,t){return w(t)}},image:{load:function(e){e&&(e.data=new Image,e.useCORS&&(e.data.crossOrigin="Anonymous"),e.data.onload=function(){e.ready()},e.data.onerror=function(){e.failed()},e.data.src=e.url)},parse:function(e){},store:function(e){var t=document.createElement("canvas");t.width=e.data.width,t.height=e.data.height,t.getContext("2d").drawImage(e.data,0,0);var n=t.toDataURL("image/png");return t=null,n},restore:function(e,t){var n=new Image;return n.src=t,n}},binary:{load:function(e){x(e)},parse:function(e,t){e.data=t.response},store:function(e){for(var t="",n=new Uint8Array(e.data),i=n.byteLength,r=0;r<i;r++)t+=String.fromCharCode(n[r]);return window.btoa(t)},restore:function(e,t){for(var n=new ArrayBuffer(2*t.length),i=new Uint16Array(n),r=0,o=t.length;r<o;r++)i[r]=t.charCodeAt(r);return n}}},c=function(e,t,n,i,r){this.url=e,this.params=t,this.success=n,this.dataType=i,this.loaded=!1,this.data=!1,this.requestType=r,this.useCORS=!1,this.options={},this.successCallback=n,this.errorCallback=!1,this.alwaysCallback=!1,this.progressCallback=!1,this.setOption=function(e,t){this.options[e]=t},this.getOption=function(e){return this.options[e]},this.ready=function(){this.loaded=!0,o++,S(this),E()},this.failed=function(){o++,E(),C(this)},this.done=function(e){this.successCallback=e},this.fail=function(e){this.errorCallback=e},this.error=function(e){this.errorCallback=e},this.always=function(e){this.alwaysCallback=e},this.progress=function(e){this.progressCallback=e},this.toString=function(){return this.data}},h=function(e,t){this.urls=e,this.results={},this.loadedCount=0,this.count=0,this.successCallback=t,this.load=function(){var e=null,t=null;for(var n in this.urls)this.urls.hasOwnProperty(n)&&this.count++;for(var i in this.urls)(t=this.urls[i])&&t.url&&t.type&&((e=u(t.url,void 0,D(this,this.ready,i),t.type)).setOption("logistics.multi.key",i),e.fail(D(this,this.fail)))},this.ready=function(e,t,n){var i=n.getOption("logistics.multi.key");this.results[i]=e,this.loadedCount++,this.checkIfAllReady()},this.fail=function(e){this.loadedCount++,this.checkIfAllReady()},this.getKeyForURL=function(e){},this.checkIfAllReady=function(){this.loadedCount>=this.count&&"function"==typeof this.successCallback&&this.successCallback(this.results)}},u=function(e,t,n,i){var r="GET";"function"==typeof t?(n=t,t=void 0):t&&"object"==typeof t&&(r="POST");var o=new c(e,t,n,i,r);return s.enableCORS&&(o.useCORS=d(e)),o&&(a.push(o),f(o)),o},d=function(e){if("undefined"==typeof document)return!1;var t=e.match(/(https?:)?\/\/([^\/]+)\/(.*)/);return!!t&&t[1]!==document.location.origin},f=function(e){return m(e),!0},m=function(e){s.loadFromLocalStorage&&v(e)?p(e):g(e.dataType,"load")(e)},v=function(e){return!(!t||null===localStorage.getItem(e.url))},p=function(e){e.data=g(e.dataType,"restore")(e,y(e)),e.ready()},g=function(e,t){return l&&l[e]&&l[e][t]?l[e][t]:l&&l[e]?l[e]:function(){"undefined"!=typeof console&&console.warn&&console.warn("Method "+t+" for "+e+" not found")}},x=function(e){var t=b(e);if(!t||!e)throw"http failed";var n=e.url;t.open(e.requestType,n,!0),t.overrideMimeType&&t.overrideMimeType("text/plain"),"binary"==e.dataType&&(t.responseType="arraybuffer",e.useCORS&&t.setRequestHeader("Content-Type","application/x-3dtechdata")),e.useCORS&&s.useCookies&&(t.withCredentials=!0),t.onreadystatechange=function(){4==t.readyState?200==t.status?(e.loaded=!0,o++,g(e.dataType,"parse")(e,t),S(e)):(o++,C(e)):"function"==typeof e.progressCallback&&e.progressCallback(t)},t.ontimeout=function(){o++,C(e)},E(),t.send(null)},w=function(e){var t=null;if(!e||"string"!=typeof e)return t;window.DOMParser?t=(new DOMParser).parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async=!1,t.loadXML(e));if(!t||t.getElementsByTagName("parsererror").length)throw"XML parsing failed";return t},b=function(e){var t=!1;if(e.useCORS&&window.XDomainRequest)try{t=new XDomainRequest}catch(e){t=!1}else if(XMLHttpRequest)try{t=new XMLHttpRequest}catch(e){t=!1}else if("undefined"!=typeof ActiveXObject)try{t=new ActiveXObject("Msxml2.XMLHTTP"),alert(2)}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP"),alert(3)}catch(e){t=!1}}return t},T=function(e){if(t)try{localStorage[e.url]=g(e.dataType,"store")(e)}catch(e){console.warn("localStorage limit exceeded")}else console.warn("localStorage isn't supported")},y=function(e){return localStorage[e.url]},S=function(e){e&&"function"==typeof e.successCallback&&(e.successCallback(e.data,"success",e),_()),e&&s.storeToLocalStorage&&T(e)},C=function(e){e&&s.fallbackFromStorage&&v(e)?p(e):(e&&"function"==typeof e.errorCallback&&e.errorCallback(e,"error",""),_())},E=function(){i&&"function"==typeof i&&a.length&&o&&i(o/a.length)},_=function(){null===e&&(e=setTimeout(R,5))},R=function(){e=null,a.length==o&&n&&"function"==typeof n&&n()},D=function(e,t){return function(){return t.apply(e,arguments)}};return{count:function(){return a.length},loadedCount:function(){return o},clear:function(){a=[],o=0,!(r=[])},get:function(e,t,n,i,r){return u(e,t,n,toLowerCase(i))},getJSON:function(e,t,n,i){return u(e,t,n,"json",i)},getImage:function(e,t,n,i){return u(e,t,n,"image",i)},getBinary:function(e,t,n,i){return u(e,t,n,"binary",i)},getXML:function(e,t,n,i){return u(e,t,n,"xml",i)},getText:function(e,t,n,i){return u(e,t,n,"text",i)},getMultiple:function(e,t,n){var i;i=new h(e,t),r.push(i),i.load()},store:function(){!function(){if(t)for(var e in a)T(a[e]);else console.warn("localStorage isn't supported")}()},clearStorage:function(){localStorage.clear()},types:function(){return l},onFinishedLoading:function(e){n=e},onProgress:function(e){i=e},getQueue:function(){return a},getTypeFunction:function(e,t){return g(e,t)},setTypeFunction:function(e,t){return i=t,void((n=e)&&i&&(l[n]=i));var n,i},getOption:function(e){return s[e]},setOption:function(e,t){var n;n=t,s[e]=n}}}();!function(n,s,e,b){"use strict";function l(e,t,n){return setTimeout(c(e,n),t)}function i(e,t,n){return!!Array.isArray(e)&&(r(e,n[t],n),!0)}function r(e,t,n){var i;if(e)if(e.forEach)e.forEach(t,n);else if(e.length!==b)for(i=0;i<e.length;)t.call(n,e[i],i,e),i++;else for(i in e)e.hasOwnProperty(i)&&t.call(n,e[i],i,e)}function o(e,t,n){for(var i=Object.keys(t),r=0;r<i.length;)(!n||n&&e[i[r]]===b)&&(e[i[r]]=t[i[r]]),r++;return e}function a(e,t){return o(e,t,!0)}function t(e,t,n){var i,r=t.prototype;(i=e.prototype=Object.create(r)).constructor=e,i._super=r,n&&o(i,n)}function c(e,t){return function(){return e.apply(t,arguments)}}function h(e,t){return typeof e==Z?e.apply(t&&t[0]||b,t):e}function u(e,t){return e===b?t:e}function d(t,e,n){r(v(e),function(e){t.addEventListener(e,n,!1)})}function f(t,e,n){r(v(e),function(e){t.removeEventListener(e,n,!1)})}function T(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function m(e,t){return-1<e.indexOf(t)}function v(e){return e.trim().split(/\s+/g)}function p(e,t,n){if(e.indexOf&&!n)return e.indexOf(t);for(var i=0;i<e.length;){if(n&&e[i][n]==t||!n&&e[i]===t)return i;i++}return-1}function g(e){return Array.prototype.slice.call(e,0)}function x(e,n,t){for(var i=[],r=[],o=0;o<e.length;){var a=n?e[o][n]:e[o];p(r,a)<0&&i.push(e[o]),r[o]=a,o++}return t&&(i=n?i.sort(function(e,t){return e[n]>t[n]}):i.sort()),i}function w(e,t){for(var n,i,r=t[0].toUpperCase()+t.slice(1),o=0;o<K.length;){if((i=(n=K[o])?n+r:t)in e)return i;o++}return b}function y(e){var t=e.ownerDocument||e;return t.defaultView||t.parentWindow||n}function S(t,e){var n=this;this.manager=t,this.callback=e,this.element=t.element,this.target=t.options.inputTarget,this.domHandler=function(e){h(t.options.enable,[t])&&n.handler(e)},this.init()}function C(e,t,n){var i=n.pointers.length,r=n.changedPointers.length,o=t&le&&i-r==0,a=t&(ce|he)&&i-r==0;n.isFirst=!!o,n.isFinal=!!a,o&&(e.session={}),n.eventType=t,function(e,t){var n=e.session,i=t.pointers,r=i.length;n.firstInput||(n.firstInput=E(t)),1<r&&!n.firstMultiple?n.firstMultiple=E(t):1===r&&(n.firstMultiple=!1);var o=n.firstInput,a=n.firstMultiple,s=a?a.center:o.center,l=t.center=_(i);t.timeStamp=ee(),t.deltaTime=t.timeStamp-o.timeStamp,t.angle=P(s,l),t.distance=D(s,l),f=n,m=t,v=m.center,p=f.offsetDelta||{},g=f.prevDelta||{},x=f.prevInput||{},(m.eventType===le||x.eventType===ce)&&(g=f.prevDelta={x:x.deltaX||0,y:x.deltaY||0},p=f.offsetDelta={x:v.x,y:v.y}),m.deltaX=g.x+(v.x-p.x),m.deltaY=g.y+(v.y-p.y),t.offsetDirection=R(t.deltaX,t.deltaY),t.scale=a?(u=a.pointers,d=i,D(d[0],d[1],be)/D(u[0],u[1],be)):1,t.rotation=a?(c=a.pointers,h=i,P(h[1],h[0],be)-P(c[1],c[0],be)):0,function(e,t){var n,i,r,o,a=e.lastInterval||t,s=t.timeStamp-a.timeStamp;if(t.eventType!=he&&(se<s||a.velocity===b)){var l=a.deltaX-t.deltaX,c=a.deltaY-t.deltaY,h={x:l/(u=s)||0,y:c/u||0};i=h.x,r=h.y,n=$(h.x)>$(h.y)?h.x:h.y,o=R(l,c),e.lastInterval=t}else n=a.velocity,i=a.velocityX,r=a.velocityY,o=a.direction;var u;t.velocity=n,t.velocityX=i,t.velocityY=r,t.direction=o}(n,t);var c,h;var u,d;var f,m,v,p,g,x;var w=e.element;T(t.srcEvent.target,w)&&(w=t.srcEvent.target),t.target=w}(e,n),e.emit("hammer.input",n),e.recognize(n),e.session.prevInput=n}function E(e){for(var t=[],n=0;n<e.pointers.length;)t[n]={clientX:J(e.pointers[n].clientX),clientY:J(e.pointers[n].clientY)},n++;return{timeStamp:ee(),pointers:t,center:_(t),deltaX:e.deltaX,deltaY:e.deltaY}}function _(e){var t=e.length;if(1===t)return{x:J(e[0].clientX),y:J(e[0].clientY)};for(var n=0,i=0,r=0;r<t;)n+=e[r].clientX,i+=e[r].clientY,r++;return{x:J(n/t),y:J(i/t)}}function R(e,t){return e===t?ue:$(e)>=$(t)?0<e?de:fe:0<t?me:ve}function D(e,t,n){n||(n=we);var i=t[n[0]]-e[n[0]],r=t[n[1]]-e[n[1]];return Math.sqrt(i*i+r*r)}function P(e,t,n){n||(n=we);var i=t[n[0]]-e[n[0]],r=t[n[1]]-e[n[1]];return 180*Math.atan2(r,i)/Math.PI}function M(){this.evEl=ye,this.evWin=Se,this.allow=!0,this.pressed=!1,S.apply(this,arguments)}function F(){this.evEl=_e,this.evWin=Re,S.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function N(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,S.apply(this,arguments)}function A(){this.evTarget=Me,this.targetIds={},S.apply(this,arguments)}function z(){S.apply(this,arguments);var e=c(this.handler,this);this.touch=new A(this.manager,e),this.mouse=new M(this.manager,e)}function B(e,t){this.manager=e,this.set(t)}function I(e){this.id=te++,this.manager=null,this.options=a(e||{},this.defaults),this.options.enable=u(this.options.enable,!0),this.state=Ue,this.simultaneous={},this.requireFail=[]}function L(e){return e==ve?"down":e==me?"up":e==de?"left":e==fe?"right":""}function U(e,t){var n=t.manager;return n?n.get(e):e}function O(){I.apply(this,arguments)}function k(){O.apply(this,arguments),this.pX=null,this.pY=null}function V(){O.apply(this,arguments)}function q(){I.apply(this,arguments),this._timer=null,this._input=null}function G(){O.apply(this,arguments)}function X(){O.apply(this,arguments)}function H(){I.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function j(e,t){return(t=t||{}).recognizers=u(t.recognizers,j.defaults.preset),new W(e,t)}function W(e,t){var n;t=t||{},this.options=a(t,j.defaults),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.element=e,this.input=new((n=this).options.inputClass||(ie?F:re?A:ne?z:M))(n,C),this.touchAction=new B(this,this.options.touchAction),Y(this,!0),r(t.recognizers,function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])},this)}function Y(e,n){var i=e.element;i.style&&r(e.options.cssProps,function(e,t){i.style[w(i.style,t)]=n?e:""})}var K=["","webkit","moz","MS","ms","o"],Q=s.createElement("div"),Z="function",J=Math.round,$=Math.abs,ee=Date.now,te=1,ne="ontouchstart"in n,ie=w(n,"PointerEvent")!==b,re=ne&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),oe="touch",ae="mouse",se=25,le=1,ce=4,he=8,ue=1,de=2,fe=4,me=8,ve=16,pe=de|fe,ge=me|ve,xe=pe|ge,we=["x","y"],be=["clientX","clientY"];S.prototype={handler:function(){},init:function(){this.evEl&&d(this.element,this.evEl,this.domHandler),this.evTarget&&d(this.target,this.evTarget,this.domHandler),this.evWin&&d(y(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&f(this.element,this.evEl,this.domHandler),this.evTarget&&f(this.target,this.evTarget,this.domHandler),this.evWin&&f(y(this.element),this.evWin,this.domHandler)}};var Te={mousedown:le,mousemove:2,mouseup:ce},ye="mousedown",Se="mousemove mouseup";t(M,S,{handler:function(e){var t=Te[e.type];t&le&&0===e.button&&(this.pressed=!0),2&t&&1!==e.which&&(t=ce),this.pressed&&this.allow&&(t&ce&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:ae,srcEvent:e}))}});var Ce={pointerdown:le,pointermove:2,pointerup:ce,pointercancel:he,pointerout:he},Ee={2:oe,3:"pen",4:ae,5:"kinect"},_e="pointerdown",Re="pointermove pointerup pointercancel";n.MSPointerEvent&&(_e="MSPointerDown",Re="MSPointerMove MSPointerUp MSPointerCancel"),t(F,S,{handler:function(e){var t=this.store,n=!1,i=e.type.toLowerCase().replace("ms",""),r=Ce[i],o=Ee[e.pointerType]||e.pointerType,a=o==oe,s=p(t,e.pointerId,"pointerId");r&le&&(0===e.button||a)?s<0&&(t.push(e),s=t.length-1):r&(ce|he)&&(n=!0),s<0||(t[s]=e,this.callback(this.manager,r,{pointers:t,changedPointers:[e],pointerType:o,srcEvent:e}),n&&t.splice(s,1))}});var De={touchstart:le,touchmove:2,touchend:ce,touchcancel:he};t(N,S,{handler:function(e){var t=De[e.type];if(t===le&&(this.started=!0),this.started){var n=function(e,t){var n=g(e.touches),i=g(e.changedTouches);return t&(ce|he)&&(n=x(n.concat(i),"identifier",!0)),[n,i]}.call(this,e,t);t&(ce|he)&&n[0].length-n[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:n[0],changedPointers:n[1],pointerType:oe,srcEvent:e})}}});var Pe={touchstart:le,touchmove:2,touchend:ce,touchcancel:he},Me="touchstart touchmove touchend touchcancel";t(A,S,{handler:function(e){var t=Pe[e.type],n=function(e,t){var n=g(e.touches),i=this.targetIds;if(t&(2|le)&&1===n.length)return i[n[0].identifier]=!0,[n,n];var r,o,a=g(e.changedTouches),s=[],l=this.target;if(o=n.filter(function(e){return T(e.target,l)}),t===le)for(r=0;r<o.length;)i[o[r].identifier]=!0,r++;for(r=0;r<a.length;)i[a[r].identifier]&&s.push(a[r]),t&(ce|he)&&delete i[a[r].identifier],r++;return s.length?[x(o.concat(s),"identifier",!0),s]:void 0}.call(this,e,t);n&&this.callback(this.manager,t,{pointers:n[0],changedPointers:n[1],pointerType:oe,srcEvent:e})}}),t(z,S,{handler:function(e,t,n){var i=n.pointerType==oe,r=n.pointerType==ae;if(i)this.mouse.allow=!1;else if(r&&!this.mouse.allow)return;t&(ce|he)&&(this.mouse.allow=!0),this.callback(e,t,n)},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var Fe=w(Q.style,"touchAction"),Ne=Fe!==b,Ae="compute",ze="manipulation",Be="none",Ie="pan-x",Le="pan-y";B.prototype={set:function(e){e==Ae&&(e=this.compute()),Ne&&this.manager.element.style&&(this.manager.element.style[Fe]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var t=[];return r(this.manager.recognizers,function(e){h(e.options.enable,[e])&&(t=t.concat(e.getTouchAction()))}),function(e){if(m(e,Be))return Be;var t=m(e,Ie),n=m(e,Le);return t&&n?Ie+" "+Le:t||n?t?Ie:Le:m(e,ze)?ze:"auto"}(t.join(" "))},preventDefaults:function(e){if(!Ne){var t=e.srcEvent,n=e.offsetDirection;if(this.manager.session.prevented)return void t.preventDefault();var i=this.actions,r=m(i,Be),o=m(i,Le),a=m(i,Ie);return r||o&&n&pe||a&&n&ge?this.preventSrc(t):void 0}},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var Ue=1,Oe=2,ke=4,Ve=8,qe=Ve,Ge=16;I.prototype={defaults:{},set:function(e){return o(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(i(e,"recognizeWith",this))return this;var t=this.simultaneous;return t[(e=U(e,this)).id]||(t[e.id]=e).recognizeWith(this),this},dropRecognizeWith:function(e){return i(e,"dropRecognizeWith",this)||(e=U(e,this),delete this.simultaneous[e.id]),this},requireFailure:function(e){if(i(e,"requireFailure",this))return this;var t=this.requireFail;return-1===p(t,e=U(e,this))&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(i(e,"dropRequireFailure",this))return this;e=U(e,this);var t=p(this.requireFail,e);return-1<t&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return 0<this.requireFail.length},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(n){function e(e){var t;i.manager.emit(i.options.event+(e?(t=r)&Ge?"cancel":t&Ve?"end":t&ke?"move":t&Oe?"start":"":""),n)}var i=this,r=this.state;r<Ve&&e(!0),e(),Ve<=r&&e(!0)},tryEmit:function(e){return this.canEmit()?this.emit(e):void(this.state=32)},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(this.requireFail[e].state&(32|Ue)))return!1;e++}return!0},recognize:function(e){var t=o({},e);return h(this.options.enable,[this,t])?(this.state&(qe|Ge|32)&&(this.state=Ue),this.state=this.process(t),void(this.state&(Oe|ke|Ve|Ge)&&this.tryEmit(t))):(this.reset(),void(this.state=32))},process:function(){},getTouchAction:function(){},reset:function(){}},t(O,I,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,n=e.eventType,i=t&(Oe|ke),r=this.attrTest(e);return i&&(n&he||!r)?t|Ge:i||r?n&ce?t|Ve:t&Oe?t|ke:Oe:32}}),t(k,O,{defaults:{event:"pan",threshold:10,pointers:1,direction:xe},getTouchAction:function(){var e=this.options.direction,t=[];return e&pe&&t.push(Le),e&ge&&t.push(Ie),t},directionTest:function(e){var t=this.options,n=!0,i=e.distance,r=e.direction,o=e.deltaX,a=e.deltaY;return r&t.direction||(i=t.direction&pe?(r=0===o?ue:o<0?de:fe,n=o!=this.pX,Math.abs(e.deltaX)):(r=0===a?ue:a<0?me:ve,n=a!=this.pY,Math.abs(e.deltaY))),e.direction=r,n&&i>t.threshold&&r&t.direction},attrTest:function(e){return O.prototype.attrTest.call(this,e)&&(this.state&Oe||!(this.state&Oe)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=L(e.direction);t&&this.manager.emit(this.options.event+t,e),this._super.emit.call(this,e)}}),t(V,O,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Be]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||this.state&Oe)},emit:function(e){if(this._super.emit.call(this,e),1!==e.scale){var t=e.scale<1?"in":"out";this.manager.emit(this.options.event+t,e)}}}),t(q,I,{defaults:{event:"press",pointers:1,time:500,threshold:5},getTouchAction:function(){return["auto"]},process:function(e){var t=this.options,n=e.pointers.length===t.pointers,i=e.distance<t.threshold,r=e.deltaTime>t.time;if(this._input=e,!i||!n||e.eventType&(ce|he)&&!r)this.reset();else if(e.eventType&le)this.reset(),this._timer=l(function(){this.state=qe,this.tryEmit()},t.time,this);else if(e.eventType&ce)return qe;return 32},reset:function(){clearTimeout(this._timer)},emit:function(e){this.state===qe&&(e&&e.eventType&ce?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=ee(),this.manager.emit(this.options.event,this._input)))}}),t(G,O,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Be]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||this.state&Oe)}}),t(X,O,{defaults:{event:"swipe",threshold:10,velocity:.65,direction:pe|ge,pointers:1},getTouchAction:function(){return k.prototype.getTouchAction.call(this)},attrTest:function(e){var t,n=this.options.direction;return n&(pe|ge)?t=e.velocity:n&pe?t=e.velocityX:n&ge&&(t=e.velocityY),this._super.attrTest.call(this,e)&&n&e.direction&&e.distance>this.options.threshold&&$(t)>this.options.velocity&&e.eventType&ce},emit:function(e){var t=L(e.direction);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),t(H,I,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:2,posThreshold:10},getTouchAction:function(){return[ze]},process:function(e){var t=this.options,n=e.pointers.length===t.pointers,i=e.distance<t.threshold,r=e.deltaTime<t.time;if(this.reset(),e.eventType&le&&0===this.count)return this.failTimeout();if(i&&r&&n){if(e.eventType!=ce)return this.failTimeout();var o=!this.pTime||e.timeStamp-this.pTime<t.interval,a=!this.pCenter||D(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,a&&o?this.count+=1:this.count=1,this._input=e,0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=l(function(){this.state=qe,this.tryEmit()},t.interval,this),Oe):qe}return 32},failTimeout:function(){return this._timer=l(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==qe&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),j.VERSION="2.0.4",j.defaults={domEvents:!1,touchAction:Ae,enable:!0,inputTarget:null,inputClass:null,preset:[[G,{enable:!1}],[V,{enable:!1},["rotate"]],[X,{direction:pe}],[k,{direction:pe},["swipe"]],[H],[H,{event:"doubletap",taps:2},["tap"]],[q]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};W.prototype={set:function(e){return o(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){this.touchAction.preventDefaults(e);var n,i=this.recognizers,r=t.curRecognizer;(!r||r&&r.state&qe)&&(r=t.curRecognizer=null);for(var o=0;o<i.length;)n=i[o],2===t.stopped||r&&n!=r&&!n.canRecognizeWith(r)?n.reset():n.recognize(e),!r&&n.state&(Oe|ke|Ve)&&(r=t.curRecognizer=n),o++}},get:function(e){if(e instanceof I)return e;for(var t=this.recognizers,n=0;n<t.length;n++)if(t[n].options.event==e)return t[n];return null},add:function(e){if(i(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),(e.manager=this).touchAction.update(),e},remove:function(e){if(i(e,"remove",this))return this;var t=this.recognizers;return e=this.get(e),t.splice(p(t,e),1),this.touchAction.update(),this},on:function(e,t){var n=this.handlers;return r(v(e),function(e){n[e]=n[e]||[],n[e].push(t)}),this},off:function(e,t){var n=this.handlers;return r(v(e),function(e){t?n[e].splice(p(n[e],t),1):delete n[e]}),this},emit:function(e,t){var n,i,r;this.options.domEvents&&(n=e,i=t,(r=s.createEvent("Event")).initEvent(n,!0,!0),(r.gesture=i).target.dispatchEvent(r));var o=this.handlers[e]&&this.handlers[e].slice();if(o&&o.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var a=0;a<o.length;)o[a](t),a++}},destroy:function(){this.element&&Y(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},o(j,{INPUT_START:le,INPUT_MOVE:2,INPUT_END:ce,INPUT_CANCEL:he,STATE_POSSIBLE:Ue,STATE_BEGAN:Oe,STATE_CHANGED:ke,STATE_ENDED:Ve,STATE_RECOGNIZED:qe,STATE_CANCELLED:Ge,STATE_FAILED:32,DIRECTION_NONE:ue,DIRECTION_LEFT:de,DIRECTION_RIGHT:fe,DIRECTION_UP:me,DIRECTION_DOWN:ve,DIRECTION_HORIZONTAL:pe,DIRECTION_VERTICAL:ge,DIRECTION_ALL:xe,Manager:W,Input:S,TouchAction:B,TouchInput:A,MouseInput:M,PointerEventInput:F,TouchMouseInput:z,SingleTouchInput:N,Recognizer:I,AttrRecognizer:O,Tap:H,Pan:k,Swipe:X,Pinch:V,Rotate:G,Press:q,on:d,off:f,each:r,merge:a,extend:o,inherit:t,bindFn:c,prefixed:w}),typeof define==Z&&define.amd?define(function(){return j}):"undefined"!=typeof module&&module.exports?module.exports=j:n.HammerWF=j}(window,document);var frakVersion="1.4.2";function FRAK(e){"function"==typeof e&&e()}"undefined"!=typeof exports&&(exports.version=frakVersion),FRAK.raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame,FRAK.caf=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame,FRAK.performance="undefined"!=typeof window&&(!!window.performance&&window.performance.now),FRAK.performanceNOW=function(){return window.performance.now.apply(window.performance)},FRAK.extend=function(){for(var e=1;e<arguments.length;++e)for(var t in arguments[e])t in arguments[e]&&(arguments[0][t]=arguments[e][t]);return arguments[0]},FRAK.isFunction=function(e){return"function"==typeof e},FRAK.isEmptyObject=function(e){for(var t in e)if(t in e)return!1;return!0},FRAK.parseJSON=function(e){if("undefined"!=typeof window&&window.JSON&&window.JSON.parse)return window.JSON.parse(e);if("undefined"!=typeof JSON)return JSON.parse(e);throw"FRAK.parseJSON: No JSON parser available."},FRAK.timestamp=FRAK.performance?FRAK.performanceNOW:Date.now,FRAK.requestAnimationFrame="undefined"!=typeof window?FRAK.raf?function(){return FRAK.raf.apply(window,arguments)}:function(e){return window.setTimeout(e,1e3/60)}:"undefined"!=typeof setTimeout?function(e){return setTimeout(e,1e3/60)}:void 0,FRAK.cancelAnimationFrame=function(){if("undefined"!=typeof window){if(FRAK.caf)return function(){return FRAK.caf.apply(window,arguments)}}else if("undefined"!=typeof clearTimeout)return clearTimeout}(),FRAK.fullscreenEnabled="undefined"!=typeof document&&(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled),FRAK.requestFullscreen=function(e){(e.requestFullscreen||e.requestFullScreen||e.webkitRequestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen||e.msRequestFullScreen||function(){}).call(e)},FRAK.exitFullscreen=function(){(document.exitFullscreen||document.exitFullScreen||document.webkitExitFullscreen||document.webkitExitFullScreen||document.mozExitFullscreen||document.mozExitFullScreen||document.msExitFullscreen||document.msExitFullScreen||function(){}).call(document)},FRAK.isFullscreen=function(){return document.isFullScreen||document.isFullscreen||document.webkitIsFullscreen||document.webkitIsFullScreen||document.mozIsFullscreen||document.mozIsFullScreen||document.msIsFullscreen||document.msIsFullScreen},FRAK.isWebGLSupported=function(){var e=document.createElement("canvas"),t=null;try{t=e.getContext("webgl")}catch(e){t=null}if(null==t)try{t=e.getContext("experimental-webgl")}catch(e){t=null}return e.remove(),!!t};var Cloneable=FrakClass.extend({type:function(){return!1},clone:function(){return"function"==typeof window[this.type()]?new(window[this.type()]):{}}}),nextSerializableID=1,Serializable=Cloneable.extend({init:function(){this.serializable=!0,this.id=nextSerializableID++},included:function(){return!0},excluded:function(){return[]},getSerializableFields:function(e){var t=this.included(),n=this.excluded();if(!0===t&&!0===n)throw"Quantum classes not allowed. A subclass of Serializable tries to both include and exclude all fields.";if(!1===t&&!1===n)throw"Quantum classes not allowed. A subclass of Serializable tries both not to include and not to exclude all fields.";if(!1===t||!0===n)return{};var i={};if(!0===t){for(var r in this){var o={};this[r]&&"[object Function]"==o.toString.call(this[r])||"serializable"==r||"_super"==r||(i[r]=this[r])}if(n instanceof Array){n=n.concat(e);for(var a=0;a<n.length;a++)i[n[a]]&&delete i[n[a]]}}if(!0===n){i=[];for(var s=0;s<t.length;s++){o={};this[r=t[s]]&&"[object Function]"==o.toString.call(this[r])||"serializable"==r||"_super"==r||(i[r]=this[r])}}return i},serialize:function(e){try{return(new Serializer).serialize(this,e,32)}catch(e){throw console.warn("Caught serialization exception: ",e),e}},unserialize:function(e){FRAK.parseJSON(e);return!1},serializeCyclic:function(e){try{return(new CyclicSerializer).serialize(this,e,32)}catch(e){throw console.warn("Caught serialization exception: ",e),e}},unserializeCyclic:function(e){try{return(new CyclicSerializer).unserialize(e)}catch(e){throw console.warn("Caught serialization exception: ",e),e}},onBeforeSerialize:function(){},onAfterSerialize:function(){},onBeforeUnserialize:function(){},onAfterUnserialize:function(){}}),Serializer=FrakClass.extend({init:function(){this.serializables={}},serializableCopy:function(e,t,n,i,r){var o={},a=t.getSerializableFields(n);if(r<=i){var s=[];for(var l in e)s.push(e[l].type());throw"Reached maximum depth for serialization: "+i+" at "+t.type()}for(var c in(e=e.slice(0)).splice(0,0,t),a){var h=a[c];if(h instanceof Serializable)o[c]=this.serializableCopy(e,h,n,i+1,r);else if(h instanceof Array||h instanceof Float32Array){var u=[];for(var d in h)h[d]instanceof Serializable?u.push(this.serializableCopy(e,h[d],n,i+1,r)):u.push(h[d]);o[c]=u}else o[c]=a[c]}return{_type_:t.type(),_properties_:o}},serialize:function(e,t,n){this.serializables={};var i=this.serializableCopy([],e,t,0,n);return JSON.stringify({_root_:i,_serializables_:this.serializables},void 0,2)},unserializeSerializables:function(e){for(var t in e)this.serializables[t]=this.unserializeCopy(e[t])},unserializeCopy:function(e){if(e instanceof Array){for(var t in e)e[t]=this.unserializeCopy(e[t]);return e}if(e instanceof Object){if(e._reference_)return e;if(e._type_){var n=new window[e._type_];for(var t in n.onBeforeUnserialize(),e._properties_)n[t]=this.unserializeCopy(e._properties_[t]);return n.onAfterUnserialize(),n}return e}return n},resolveReferences:function(e,t){if(e[t]instanceof Array)for(var n in e[t])e[t][n]=this.resolveReferences(e[t],n);else if(e[t]instanceof Object)if(e[t]._reference_)e[t]=this.serializables[e[t]._id_];else for(var n in e[t])e[t][n]=this.resolveReferences(e[t],n)},unserialize:function(e){var t=FRAK.parseJSON(e);this.serializables={},this.unserializeSerializables(t._serializables_);var n=this.unserializeCopy(t._root_);for(var i in this.serializables)this.resolveReferences(this.serializables,i);return this.resolveReferences(t,"_serializables_"),n}}),CyclicSerializer=FrakClass.extend({init:function(){this.serializables={},this.visited=[]},serializableCopy:function(t,n,e,i,r){if(r<=i)return{};(t=t.slice(0)).push(n);try{if("object"!=typeof n)return n;if(!n)return null;if(n instanceof Serializable){if(!this.serializables[n.id]){this.serializables[n.id]=!0,n.onBeforeSerialize();var o=n.getSerializableFields(n,e);for(var a in o)o[a]=this.serializableCopy(t,o[a],e,i+1,r);n.onAfterSerialize(),this.serializables[n.id]={_type_:n.type(),_properties_:o}}return{_reference_:!0,_id_:n.id}}if(n instanceof Array||n instanceof Float32Array){var s=[];for(var a in n)s.push(this.serializableCopy(t,n[a],e,i+1,r));return s}if(n._visited_)return void console.warn("Already visited object: ",n);n._visited_=!0;o={};for(var a in n)o[a]=this.serializableCopy(t,n[a],e,i+1,r);return o}catch(e){throw console.warn("Caught: ",n,e),console.warn("Stack: "),console.warn(t),e}},serialize:function(e,t,n){this.serializables={};var i=this.serializableCopy([],e,t,0,n);return JSON.stringify({_root_:i,_serializables_:this.serializables},void 0,2)},unserializeSerializables:function(e){for(var t in e)this.serializables[t]=this.unserializeCopy(e[t])},unserializeCopy:function(e){if(e instanceof Array){for(var t in e)e[t]=this.unserializeCopy(e[t]);return e}if(e instanceof Object){if(e._reference_)return e;if(e._type_){var n=new window[e._type_];for(var t in n.onBeforeUnserialize(),e._properties_)n[t]=this.unserializeCopy(e._properties_[t]);return n}return e}return e},resolveReferences:function(e,t,n){if(!(32<n))if(e[t]instanceof Array)for(var i in e[t])this.resolveReferences(e[t],i,n+1);else if(e[t]instanceof Object&&!("_visited_"in e[t]))if(e[t]._reference_)e[t]=this.serializables[e[t]._id_];else if(e[t]instanceof Serializable)for(var r in e[t]._visited_=!0,this.visited.push(e[t]),e[t])this.resolveReferences(e[t],r,n+1)},unserialize:function(e){var t=FRAK.parseJSON(e);this.serializables={},this.unserializeSerializables(t._serializables_);var n={_root_:this.unserializeCopy(t._root_)};for(var i in this.resolveReferences(n,"_root_",0),this.serializables)this.resolveReferences(this.serializables,i,0);for(var i in this.visited)this.visited[i]instanceof Serializable&&this.visited[i].onAfterUnserialize();for(var i in this.visited)delete this.visited[i]._visited_;return n._root_}}),TypeReference=Serializable.extend({init:function(e,t){this._super(),this.valueType=e,this.value=t},type:function(){return"TypeReference"},isNull:function(){return!this.value}});function CollectionReference(e){this.list=e}function CollectionView(e,t,n){this.listReference=e,this.view=[],this.keepExact=!!n,this.fnFilter=t,this.length=0;var i=this;this.update=function(){(i.keepExact||i.view.length<i.listReference.list.length)&&(i.view.length=i.listReference.list.length)},this.filter=function(){i.update();for(var e,t=0,n=0;n<i.listReference.list.length&&(e=i.listReference.list[n]);++n)i.fnFilter(e)&&(i.view[t++]=e);for(n=i.length=t;n<i.listReference.list.length;++n)i.view[t++]=null},this.forEach=function(e){for(var t=0;t<i.length;++t)e(i.view[t],t)},this.get=function(e){if(0<=e&&e<i.length)return i.view[e];throw Error("Accessing element out of bounds")}}var Color=function(e,t,n,i){this.r=1,this.g=1,this.b=1,this.a=1,this.clone=function(){return new Color(this.r,this.g,this.b,this.a)},this.fromHex=function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i.exec(e);return t&&(this.r=parseInt(t[1],16)/255,this.g=parseInt(t[2],16)/255,this.b=parseInt(t[3],16)/255,t[4]&&(this.a=parseInt(t[4],16)/255)),this},this.toHex=function(){return"#"+("0"+Math.round(255*this.r).toString(16)).slice(-2)+("0"+Math.round(255*this.g).toString(16)).slice(-2)+("0"+Math.round(255*this.b).toString(16)).slice(-2)+("0"+Math.round(255*this.a).toString(16)).slice(-2)},this.toString=function(){return"rgba("+Math.floor(255*this.r)+", "+Math.floor(255*this.g)+", "+Math.floor(255*this.b)+", "+this.a+")"},this.toVector=function(e){return e||(e=vec4.create()),vec4.set(e,this.r,this.g,this.b,this.a),e},this.set=function(e,t,n,i){return"number"==typeof e&&(this.r=e),"number"==typeof t&&(this.g=t),"number"==typeof n&&(this.b=n),"number"==typeof i&&(this.a=i),this},this.set(e,t,n,i)},MatrixStack=FrakClass.extend({init:function(){this.stack=[mat4.identity(mat4.create())],this.allocated=[];for(var e=0;e<64;e++)this.allocated.push(mat4.create())},top:function(){return this.stack[this.stack.length-1]},push:function(){0==this.allocated.length&&this.allocated.push(mat4.create()),this.stack.push(mat4.copy(this.allocated.pop(),this.stack[this.stack.length-1]))},pop:function(){this.allocated.push(this.stack.pop())},multiply:function(e){mat4.multiply(this.stack[this.stack.length-1],this.stack[this.stack.length-1],e)},load:function(e){mat4.copy(this.stack[this.stack.length-1],e)},size:function(){return this.stack.length}}),RenderingContext=FrakClass.extend({init:function(e,t,n,i){if("string"==typeof e&&"undefined"!=typeof document&&(e=document.getElementById(e)),"undefined"!=typeof window&&window.jQuery&&e instanceof jQuery&&(e=e[0]),this.version=i,"auto"===this.version)if("WebGL2RenderingContext"in window)this.version="webgl2";else if(this.version="webgl",!("WebGLRenderingContext"in window))throw"Unable to create rendering context, because browser doesn't support WebGL";if(!e)throw"RenderingContext requires a canvas element";if(this.canvas=e,"undefined"!=typeof WebGLDebugUtils&&(this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(e),this.canvas.setRestoreTimeout(2e3)),t=t||{alpha:!1},"webgl2"===this.version&&(this.gl=this.canvas.getContext("webgl2",t),this.gl||"auto"!==i||(this.version="webgl")),"webgl"===this.version&&(this.gl=this.canvas.getContext("webgl",t),this.gl||(this.gl=this.canvas.getContext("experimental-webgl",t)),this.gl||(this.gl=this.canvas.getContext("moz-webgl",t)),this.gl||(this.gl=this.canvas.getContext("webkit-3d",t))),!this.gl){var r=!1;if(FRAK.isFunction(n)&&(r=n()),!r&&"undefined"!=typeof document){var o=document.createElement("div");o.style.position="relative",o.style.zIndex=100,o.style.backgroundColor="red",o.style.padding="8px",o.textContent="WebGL seems to be unavailable in this browser.";var a=e.parentNode;a.insertBefore(o,a.firstChild)}throw"Failed to acquire GL context from canvas"}"undefined"!=typeof WebGLDebugUtils&&(this.gl=WebGLDebugUtils.makeDebugContext(this.gl,function(e,t,n){throw WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t+JSON.stringify(n)}),console.warn("Using WebGLDebugUtils")),this.modelview=new MatrixStack,this.projection=new MatrixStack,this.light=!1,this.shadow=!1,this.camera=!1,this.engine=!1},error:function(){if(this.isContextLost())throw Error("Context lost");var e=this.gl.getError();if(0<e&&"undefined"!=typeof WebGLDebugUtils)throw Error("GL_ERROR: "+WebGLDebugUtils.glEnumToString(e));return e},isContextLost:function(){return!this.gl||this.gl.isContextLost()},isWebGL2:function(){return"webgl2"==this.version},restore:function(){if(!this.engine)return!1;this.gl.getError();var t=this,e=this.engine,n=e.assetsManager.texturesManager;for(var i in n.cache){n.cache[i].onContextRestored(t)}e.scene.root.onEachChildComponent(function(e){(e instanceof RendererComponent||e instanceof TextComponent)&&e.onContextRestored(t)});for(i=0;i<e.scene.lights.length;++i)e.scene.lights[i].onContextRestored(t);e.WhiteTexture.glTexture=null,e.WhiteTexture.loaded=!1,e.WhiteTexture.clearImage(t,[255,255,255,255]),fallbackTexture&&fallbackTexture.onContextRestored(t),fallbackCubeTexture&&fallbackCubeTexture.onContextRestored(t),e.scene&&e.scene.cameraComponent&&e.scene.cameraComponent.onContextRestored(t);var r=e.assetsManager.shadersManager;for(var i in r.cache){r.cache[i].onContextRestored(t)}return!0}});function SamplerAccumulator(){this.samplers=[],this.length=0;var n=this;this.add=function(e){n.samplers[n.length++]=e},this.clear=function(){for(var e=0,t=n.samplers.length;e<t;++e)n.samplers[e]=null;n.length=0}}var ExplicitAttributeLocations={position:0,normal:1,texcoord2d0:2,uv0:2,tangent:3,bitangent:4},Subshader=FrakClass.extend({init:function(e,t,n){this.shader=e,this.context=e.context,this.code=t,this.type=n,this.VERTEX_SHADER=0,this.FRAGMENT_SHADER=1,this.compiledShader=!1,this.failedCompilation=!1},attach:function(){this.context.gl.attachShader(this.shader.program,this.compiledShader)},getFilename:function(){return"Unknown"},compile:function(){if(!this.failedCompilation){if(!this.compiledShader)throw"WebGL shader has not been created. FragmentShader or VertexShader class instances should be used, not Shader.";if(this.context.gl.shaderSource(this.compiledShader,this.code),this.context.gl.compileShader(this.compiledShader),!this.context.gl.getShaderParameter(this.compiledShader,this.context.gl.COMPILE_STATUS)&&!this.failedCompilation)throw this.failedCompilation=!0,"Shader '"+this.getFilename()+"' failed to compile: "+this.context.gl.getShaderInfoLog(this.compiledShader)}},onContextRestored:function(e){this.failedCompilation=!1,this.context=e,this.attach()}}),VertexShader=Subshader.extend({init:function(e,t){this._super(e,t,this.VERTEX_SHADER),this.compiledShader=this.context.gl.createShader(this.context.gl.VERTEX_SHADER)},getFilename:function(){return this.shader.descriptor.vertexSource},onContextRestored:function(e){this.compiledShader=this.context.gl.createShader(this.context.gl.VERTEX_SHADER),this._super(e)}}),FragmentShader=Subshader.extend({init:function(e,t){this._super(e,t,this.FRAGMENT_SHADER),this.compiledShader=this.context.gl.createShader(this.context.gl.FRAGMENT_SHADER)},getFilename:function(){return this.shader.descriptor.fragmentSource},onContextRestored:function(e){this.compiledShader=this.context.gl.createShader(this.context.gl.FRAGMENT_SHADER),this._super(e)}}),ShaderRequirements=FrakClass.extend({init:function(){this.barycentric=!1,this.bitangents=!1,this.tangents=!1,this.transparent=!1,this.texCoords2D=!0},apply:function(e){this.barycentric&&!e.buffers.barycentric&&e.generateBarycentric(),this.texCoords2D&&!e.buffers.texcoord2d0&&e.generateTexCoords()}}),Shader=Serializable.extend({init:function(e,t){if(!e)throw"Shader: RenderingContext required";this._super(),this.descriptor=t,this.context=e,this.program=e.gl.createProgram(),this.shaders=[],this.requirements=new ShaderRequirements,this.linked=!1,this.failed=!1,this.uniformLocations={},this.bindings={}},excluded:function(){return!0},included:function(){return["descriptor"]},addVertexShader:function(e){var t=new VertexShader(this,e);this.addShader(t)},addFragmentShader:function(e){var t=new FragmentShader(this,e);this.addShader(t)},addShader:function(e){this.shaders.push(e),e.attach()},link:function(){if(!this.failed){for(var e=0;e<this.shaders.length;e++)this.shaders[e].compile(this.context);for(var t in ExplicitAttributeLocations)this.context.gl.bindAttribLocation(this.program,ExplicitAttributeLocations[t],t);if(this.uniformLocations={},this.linked=!0,this.context.gl.linkProgram(this.program),!this.context.gl.getProgramParameter(this.program,this.context.gl.LINK_STATUS))return console.error("Shader linking failed: ",this.context.gl.getProgramInfoLog(this.program)),this.linked=!1,void(this.failed=!0);this.context.isWebGL2()&&this.updateBlockBindings(this.context)}},use:function(e){this.failed||this.shaders.length<2||(this.linked||this.link(),this.linked&&(this.context.gl.useProgram(this.program),this.bindUniforms(e)))},getAttribLocation:function(e){return e in ExplicitAttributeLocations?ExplicitAttributeLocations[e]:this.context.gl.getAttribLocation(this.program,e)},getUniformLocation:function(e){return e in this.uniformLocations||(this.uniformLocations[e]=this.context.gl.getUniformLocation(this.program,e)),this.uniformLocations[e]},bindUniforms:function(e){if(e&&this.linked)for(var t in e){var n=this.getUniformLocation(t);if(n&&-1!=n){var i=e[t];if(!i)throw"Uniform '"+t+"' is undefined.";i.bind(this.context,n)}}},bindSamplers:function(e){if(e&&0!=e.length&&this.linked){for(var t=this.context.gl,n=0,i=0;i<e.length;++i){var r=e[i];if(!r)break;var o=this.getUniformLocation(r.name);-1!=o&&(r.bind(this.context,o,n),n++)}t.activeTexture(t.TEXTURE0)}},unbindSamplers:function(e){if(e&&0!=e.length&&this.linked){for(var t=this.context.gl,n=0,i=0;i<e.length;++i){var r=e[i];if(!r)break;var o=this.getUniformLocation(r.name);-1!=o&&(r.unbind(this.context,o,n),n++)}t.activeTexture(t.TEXTURE0)}},onContextRestored:function(e){this.context=e,this.program=e.gl.createProgram(),this.uniformLocations={},this.failed=!1,this.linked=!1;for(var t=0;t<this.shaders.length;++t)this.shaders[t].onContextRestored(e);this.link()},updateBlockBindings:function(e){var t=["Transform","Material"];this.bindings={};for(var n=0;n<t.length;++n){var i=n+1,r=t[n],o=e.gl.getUniformBlockIndex(this.program,r);o!=e.gl.INVALID_INDEX&&(this.bindings[r]={index:o,name:r,bindingPoint:i})}}}),Uniform=Cloneable.extend({init:function(e){this.value=e},bind:function(e,t){},clone:function(){var e=this._super();return e.value=this.value,e}}),UniformInt=Uniform.extend({bind:function(e,t){e.gl.uniform1i(t,this.value)},type:function(){return"UniformInt"}}),UniformFloat=Uniform.extend({bind:function(e,t){e.gl.uniform1f(t,this.value)},type:function(){return"UniformFloat"}}),UniformVec2=Uniform.extend({init:function(e){e||(e=vec2.create()),e instanceof Float32Array?this._super(e):this._super(new Float32Array(e))},type:function(){return"UniformVec2"},bind:function(e,t){e.gl.uniform2fv(t,this.value)},clone:function(){var e=this._super();return e.value=vec2.clone(this.value),e}}),UniformVec3=Uniform.extend({init:function(e){e||(e=vec3.create()),e instanceof Float32Array?this._super(e):this._super(new Float32Array(e))},type:function(){return"UniformVec3"},bind:function(e,t){e.gl.uniform3fv(t,this.value)},clone:function(){var e=this._super();return e.value=vec3.clone(this.value),e}}),UniformVec4=Uniform.extend({init:function(e){e||(e=vec4.create()),e instanceof Float32Array?this._super(e):this._super(new Float32Array(e))},type:function(){return"UniformVec4"},bind:function(e,t){e.gl.uniform4fv(t,this.value)},clone:function(){var e=this._super();return e.value=vec4.clone(this.value),e}}),UniformColor=UniformVec4.extend({init:function(e){e?e instanceof Color?this._super(e.toVector()):"r"in e&&"g"in e&&"b"in e&&"a"in e?this._super(vec4.fromValues(e.r,e.g,e.b,e.a)):this._super(vec4.fromValues(1,1,1,1)):this._super(vec4.fromValues(1,1,1,1))},type:function(){return"UniformColor"}}),UniformMat2=Uniform.extend({type:function(){return"UniformMat2"},bind:function(e,t){e.gl.uniformMatrix2fv(t,0,this.value)},clone:function(){var e=this._super();return e.value=mat2.clone(this.value),e}}),UniformMat3=Uniform.extend({bind:function(e,t){e.gl.uniformMatrix3fv(t,!1,this.value)},type:function(){return"UniformMat3"},clone:function(){var e=this._super();return e.value=mat3.clone(this.value),e}}),UniformMat4=Uniform.extend({bind:function(e,t){e.gl.uniformMatrix4fv(t,!1,this.value)},type:function(){return"UniformMat4"},clone:function(){var e=this._super();return e.value=mat4.clone(this.value),e}}),fallbackTexture=!1,fallbackCubeTexture=!1,Sampler=Serializable.extend({init:function(e,t){this.name=e,this.texture=t},type:function(){return"Sampler"},createFallbackTexture:function(e){fallbackTexture=new Texture(e);var t=document.createElement("canvas");t.width=2,t.height=2;var n=t.getContext("2d");n.fillStyle="rgb(255,255,255)",n.fillRect(0,0,2,2),fallbackTexture.setImage(e,t)},createFallbackCubeTexture:function(e){fallbackCubeTexture=new CubeTexture(e);var t=document.createElement("canvas");t.width=2,t.height=2;var n=t.getContext("2d");n.fillStyle="rgb(255,255,255)",n.fillRect(0,0,2,2),fallbackCubeTexture.setFace(e,CubeTexture.FRONT,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.BACK,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.LEFT,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.RIGHT,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.TOP,t,!0),fallbackCubeTexture.setFace(e,CubeTexture.BOTTOM,t,!0)},bind:function(e,t,n){if(e.gl.activeTexture(n+e.gl.TEXTURE0),e.gl.uniform1i(t,n),!this.texture||!this.texture.loaded)return fallbackTexture||this.createFallbackTexture(e),void fallbackTexture.bind(e);this.texture.bind(e)},unbind:function(e,t,n){e.gl.activeTexture(n+e.gl.TEXTURE0),this.texture&&this.texture.loaded?this.texture.unbind(e):fallbackTexture.unbind(e)},clone:function(){var e=this._super();return e.name=this.name,e.texture=this.texture,e}}),Camera=Serializable.extend({init:function(e,t,n){this.viewMatrix=e,this.projectionMatrix=t,this.viewInverseMatrix=mat4.create(),mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.renderStage=n,this.target=new TargetScreen,this.backgroundColor=new Color(0,0,0,0),this.clearMask=!1,this.order=0,this.layerMask=4294967295;var i=this.frustum=!1;this.stereo=function(e){return e&&(i=!0),!1===e&&(i=!1),i};var r=2;this.stereoEyeDistance=function(e){return e&&(r=e),r},this._viewportSize=vec2.create(),this._viewportPosition=vec2.create(),this._originalViewMatrix=mat4.create(),this._eyeSeparation=mat4.create(),this._cacheQuat=quat.create(),this._strafe=vec3.create(),this._translation=vec3.create()},type:function(){return"Camera"},excluded:function(){return["renderStage","target"]},clearBuffers:function(e){e.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),e.gl.clearDepth(1),e.gl.depthMask(!0),!1===this.clearMask?e.gl.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT):e.gl.clear(this.clearMask)},startRender:function(e){e.projection.push(),e.projection.multiply(this.projectionMatrix),e.modelview.push(),e.modelview.multiply(this.viewMatrix)},renderScene:function(e,t,n,i){n&&n(e,this),this.renderStage.render(e,t,this),i&&i(e,this)},endRender:function(e){e.modelview.pop(),e.projection.pop()},render:function(e,t,n,i){if(this.target.resetViewport(),this.clearBuffers(e),(e.camera=this).stereo()){mat4.invert(this.viewInverseMatrix,this.viewMatrix),vec2.copy(this._viewportPosition,this.target.viewport.position),vec2.copy(this._viewportSize,this.target.viewport.size);var r=this._viewportSize[0]/2;this.target.viewport.size[0]=r;var o=this.stereoEyeDistance()/2;this.getStrafeVector(this._strafe),mat4.copy(this._originalViewMatrix,this.viewMatrix),vec3.scale(this._translation,this._strafe,-o),mat4.fromRotationTranslation(this._eyeSeparation,quat.create(),this._translation),mat4.mul(this.viewMatrix,this.viewMatrix,this._eyeSeparation),mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.target.viewport.position[0]=0,this.startRender(e),this.renderScene(e,t,n,i),this.endRender(e),mat4.copy(this.viewMatrix,this._originalViewMatrix),vec3.scale(this._translation,this._strafe,o),mat4.fromRotationTranslation(this._eyeSeparation,quat.create(),this._translation),mat4.mul(this.viewMatrix,this.viewMatrix,this._eyeSeparation),mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.target.viewport.position[0]=r,this.startRender(e),this.renderScene(e,t,n,i),this.endRender(e),vec2.copy(this.target.viewport.position,this._viewportPosition),vec2.copy(this.target.viewport.size,this._viewportSize),mat4.copy(this.viewMatrix,this._originalViewMatrix)}else mat4.invert(this.viewInverseMatrix,this.viewMatrix),this.startRender(e),this.renderScene(e,t,n,i),this.endRender(e);e.camera=!1},getFieldOfView:function(){return 2*Math.atan(1/this.projectionMatrix[5])},getDirection:function(e){return e||(e=vec3.create()),e[0]=-this.viewMatrix[8],e[1]=-this.viewMatrix[9],e[2]=-this.viewMatrix[10],e},getUpVector:function(e){return e||(e=vec3.create()),e[0]=this.viewMatrix[4],e[1]=this.viewMatrix[5],e[2]=this.viewMatrix[6],e},getStrafeVector:function(e){return e||(e=vec3.create()),e[0]=this.viewMatrix[0],e[1]=this.viewMatrix[1],e[2]=this.viewMatrix[2],e},getPosition:function(e){return e||(e=vec3.create()),mat4.translation(e,this.viewInverseMatrix),e},setPosition:function(e){var t=this.getPosition();vec3.sub(t,t,e);var n=mat4.fromTranslation(mat4.create(),t);mat4.mul(this.viewMatrix,this.viewMatrix,n)},center:function(e){var t=this.getDirection(),n=this.getPosition(),i=new Plane;i.setByNormalAndPoint(t,n);var r=i.projectToPlane(e);this.setPosition(r)},fitToView:function(e){if(e instanceof BoundingVolume&&e.center&&(this.center(e.center),!e.isPoint())){var t=0;e instanceof BoundingSphere?t=2*e.radius:e instanceof BoundingBox&&(t=2*e.getOuterSphereRadius());var n=t/Math.sin(this.getFieldOfView()/2)-t,i=this.getDirection(),r=vec3.create();vec3.scale(i,i,-n),vec3.add(r,e.center,i),this.setPosition(r)}}});function TransparencySort(e,t){if(!e&&!t)return 0;if(e&&!t)return-1;if(!e&&t)return 1;var n=vec3.squaredDistance(TransparencySort.cmpValue,e.globalBoundingSphere.center),i=vec3.squaredDistance(TransparencySort.cmpValue,t.globalBoundingSphere.center);return i<n?-1:n<i?1:0}function Batch(n){this.indices=new Array,this.length=0;var i=this;this.clear=function(){for(var e=0,t=i.indices.length;e<t;++e)i.indices[e]=-1;i.length=0},this.add=function(e){(function(e,t){for(var n=0,i=e.length;n<i;n++)if(e[n]===t)return!0;return!1})(i.indices,e)||(i.indices[i.length++]=e)},this.get=function(e){if(0<=e&&e<i.indices.length){var t=i.indices[e];if(0<=t&&t<n.length)return n[t]}}}TransparencySort.cmpValue=vec3.create();var RendererOrganizer=FrakClass.extend({init:function(){this.enableDynamicBatching=!0,this.solidRenderers=[],this.transparentRenderers=[],this.opaqueBatchList=[],this.transparentBatchList=[],this.batchIndex={},this.renderers=new CollectionReference([]),this.viewSolidRenderers=new CollectionView(this.renderers,function(e){return!e.transparent}),this.viewTransparentRenderers=new CollectionView(this.renderers,function(e){return e.transparent}),this.visibleRenderers=0,this.visibleSolidRenderers=0,this.visibleSolidBatches=0,this.visibleSolidFaces=0,this.visibleTransparentRenderers=0,this.visibleTransparentFaces=0,this.visibleTransparentBatches=0},updateStats:function(){this.visibleSolidRenderers=this.viewSolidRenderers.length,this.visibleTransparentRenderers=this.viewTransparentRenderers.length,this.visibleRenderers=this.visibleSolidRenderers+this.visibleTransparentRenderers},batch:function(e,t){var n,i,r;for(n=0;n<e.length;++n)e[n].clear();for(n=0;n<t.length&&(r=t[n]);++n)r.material.id in this.batchIndex?i=e[this.batchIndex[r.material.id]]:(i=new Batch(t),e.push(i),this.batchIndex[r.material.id]=e.length-1),i?i.add(n):(i=new Batch(t),e.push(i),this.batchIndex[r.material.id]=e.length-1)},sort:function(e,t,n){this.renderers.list=t,this.viewSolidRenderers.filter(),this.viewTransparentRenderers.filter(),this.solidRenderers=this.viewSolidRenderers.view,this.transparentRenderers=this.viewTransparentRenderers.view,this.enableDynamicBatching&&("sorted"!=e.options.transparencyMode&&this.batch(this.transparentBatchList,this.transparentRenderers),this.batch(this.opaqueBatchList,this.solidRenderers)),"sorted"==e.options.transparencyMode&&n&&(vec3.copy(TransparencySort.cmpValue,n),this.transparentRenderers.sort(TransparencySort)),this.updateStats()}});function ScreenQuad(t,e,n,i,r){e=e||-1,n=n||-1,i=i||2,r=r||2;var o=[0,1,2,0,2,3];if(t.engine&&!0===t.engine.options.useVAO)try{this.quad=new TrianglesRenderBufferVAO(t,o)}catch(e){this.quad=new TrianglesRenderBuffer(t,o)}else this.quad=new TrianglesRenderBuffer(t,o);this.vertices=new Float32Array(12),this.vertices[0]=e,this.vertices[1]=n,this.vertices[3]=e,this.vertices[4]=n+r,this.vertices[6]=e+i,this.vertices[7]=n+r,this.vertices[9]=e+i,this.vertices[10]=n,this.quad.add("position",this.vertices,3),this.quad.add("uv0",[0,0,0,1,1,1,1,0],2)}ScreenQuad.prototype.update=function(e,t,n,i){this.vertices[0]=e,this.vertices[1]=t,this.vertices[3]=e,this.vertices[4]=t+i,this.vertices[6]=e+n,this.vertices[7]=t+i,this.vertices[9]=e+n,this.vertices[10]=t,this.quad.update("position",this.vertices)},ScreenQuad.prototype.render=function(e,t,n){var i;e.gl;n&&(i=n instanceof Sampler?[n]:n),t.bind({},i),this.quad.render(t.shader),t.unbind(i)};var RenderStage=FrakClass.extend({init:function(){this.parent=!1,this.substages=[],this.started=!1,this.enabled=!0},addStage:function(e){return(e.parent=this).substages.push(e),e},removeStage:function(e){for(var t=0;t<this.substages.length;t++)if(this.substages[t]===e)return e.parent=!1,this.substages.splice(t,1),!0;return!1},removeStagesByType:function(e){for(var t=[],n=0;n<this.substages.length;n++)this.substages[n]instanceof e&&(t.push(this.substages[n]),this.substages.splice(n,1),n--);for(n=0;n<t.length;n++)t[n].parent=!1;return t},clearStages:function(){for(var e=0;e<this.substages.length;e++)this.substages[e].parent=!1;this.substages=[]},getStageByType:function(e){for(var t=0;t<this.substages.length;t++)if(this.substages[t]instanceof e)return this.substages[t];return!1},start:function(e,t,n){this.started=!0,this.onStart(e,t,n);for(var i=0;i<this.substages.length;i++)this.substages[i].start(e,t,n)},render:function(e,t,n){if(this.enabled){this.onPreRender(e,t,n);for(var i=0;i<this.substages.length;i++)this.substages[i].started||this.substages[i].start(e,t.engine,n),this.substages[i].render(e,t,n);this.onPostRender(e,t,n)}},enable:function(){return this.enabled=!0,this.onEnable(),this},disable:function(){return this.enabled=!1,this.onDisable(),this},onStart:function(e,t,n){},onPreRender:function(e,t,n){},onPostRender:function(e,t,n){},onEnable:function(){},onDisable:function(){}}),MaterialRenderStage=RenderStage.extend({init:function(){this._super(),this.organizer=new RendererOrganizer,this.solidRenderers=[],this.solidRendererBatches={},this.transparentRenderers=[],this.transparentRendererBatches={},this.shadowFallback=null,this.diffuseFallback=null,this.bindCameraTarget={started:!0,start:function(){},render:function(e,t,n){n.target.bind(e)}},this.unbindCameraTarget={started:!0,start:function(){},render:function(e,t,n){n.target.unbind(e)}},this.shadowMapStage=this.addStage(new ShadowMapRenderStage),this.depthStage=this.addStage(new DepthRenderStage).disable(),this.oitStage=this.addStage(new OITRenderStage).disable(),this.addStage(this.bindCameraTarget),this.skyboxStage=this.addStage(new SkyboxRenderStage),this.opaqueStage=this.addStage(new OpaqueGeometryRenderStage),this.transparentStage=this.addStage(new TransparentGeometryRenderStage),this.addStage(this.unbindCameraTarget),this.eyePosition=vec3.create(),this.invModelview=mat4.create(),this.sharedUniforms={view:new UniformMat4(mat4.create()),viewInverse:new UniformMat4(mat4.create()),projection:new UniformMat4(mat4.create())},this.rendererUniforms={model:new UniformMat4(null),modelview:new UniformMat4(null),receiveShadows:new UniformInt(1)},this.shadowUniforms={lightView:new UniformMat4(mat4.create()),lightProjection:new UniformMat4(mat4.create()),shadowBias:new UniformFloat(.001),hasFloat:new UniformInt(1),useVSM:new UniformInt(1)},this.cachedUniforms=null,this.samplerAccum=new SamplerAccumulator},onStart:function(e,t,n){this.diffuseFallback=new Sampler("diffuse0",t.WhiteTexture),this.shadowFallback=new Sampler("shadow0",t.WhiteTexture),!0===t.options.ssao&&this.depthStage.enable(),"sorted"!=t.options.transparencyMode&&this.oitStage.enable()},prepareShadowContext:function(e,t){this._shadowContext||(this._shadowContext={shadow0:this.shadowFallback,lightProjection:this.shadowUniforms.lightProjection,lightView:this.shadowUniforms.lightView}),e.shadow=this._shadowContext,e.shadow.shadow0=this.shadowFallback;var n=this.shadowMapStage.getFirstShadowCastingLight(t,!0);n&&(mat4.copy(this.shadowUniforms.lightView.value,n.lightView),mat4.copy(this.shadowUniforms.lightProjection.value,n.lightProj),this.shadowUniforms.shadowBias.value=n.shadowBias,this.shadowUniforms.hasFloat.value=n.shadow instanceof TargetTextureFloat?1:0,1==this.shadowUniforms.hasFloat.value&&this.shadowMapStage.extStandardDerivatives?this.shadowUniforms.useVSM.value=1:this.shadowUniforms.useVSM.value=0,e.shadow.shadow0=n.shadowSampler)},prepareLightContext:function(e,t){for(var n=0;n<t.lights.length;n++){var i=t.lights[n];i instanceof DirectionalLight&&(i.enabled&&(i.uniforms?(vec3.copy(i.uniforms.lightDirection.value,i.direction),i.uniforms.lightIntensity.value=i.intensity,i.uniforms.lightColor.value[0]=i.color.r,i.uniforms.lightColor.value[1]=i.color.g,i.uniforms.lightColor.value[2]=i.color.b,i.uniforms.lightColor.value[3]=i.color.a,i.uniforms.useShadows.value=i.shadowCasting?1:0):i.uniforms={lightDirection:new UniformVec3(i.direction),lightColor:new UniformColor(i.color),lightIntensity:new UniformFloat(i.intensity),useShadows:new UniformInt(i.shadowCasting?1:0)}))}},prepareShared:function(e){mat4.invert(this.invModelview,e.modelview.top()),mat4.translation(this.eyePosition,this.invModelview),mat4.copy(this.sharedUniforms.projection.value,e.projection.top()),mat4.copy(this.sharedUniforms.view.value,e.camera.viewMatrix),mat4.copy(this.sharedUniforms.viewInverse.value,e.camera.viewInverseMatrix)},onPreRender:function(e,t,n){this.prepareShared(e);var i=t.dynamicSpace.frustumCast(n.frustum,n.layerMask);this.organizer.sort(t.engine,i,this.eyePosition),this.solidRenderers=this.organizer.solidRenderers,this.transparentRenderers=this.organizer.transparentRenderers,this.solidRendererBatches=this.organizer.solidRendererBatches,this.transparentRendererBatches=this.organizer.transparentRendererBatches,this.prepareLightContext(e,t),this.prepareShadowContext(e,t)},onPostRender:function(e,t,n){e.shadow=!1,e.light=!1},renderBatched:function(e,t){for(var n,i,r,o,a=!1,s=0,l=t.length;s<l;++s)if((i=t[s]).get(0)){(r=(n=i.get(0).material).shader)!=a&&(r.use(),a=r,e.shadow&&r.bindUniforms(this.shadowUniforms),r.bindUniforms(this.sharedUniforms),e.light&&e.light.uniforms&&r.bindUniforms(e.light.uniforms)),this.samplerAccum.add(e.shadow.shadow0);for(var c=0,h=n.samplers.length;c<h;++c)this.samplerAccum.add(n.samplers[c]);0===this.samplerAccum.length&&this.samplerAccum.add(this.diffuseFallback),r.bindSamplers(this.samplerAccum.samplers),r.bindUniforms(n.uniforms);c=0;for(var u=i.length;c<u;++c)o=i.get(c),e.modelview.push(),e.modelview.multiply(o.matrix),this.rendererUniforms.model.value=o.matrix,this.rendererUniforms.modelview.value=e.modelview.top(),this.rendererUniforms.receiveShadows.value=o.receiveShadows,r.bindUniforms(this.rendererUniforms),o.render(e),e.modelview.pop();r.unbindSamplers(this.samplerAccum.samplers),this.samplerAccum.clear()}},renderBruteForce:function(e,t){for(var n=0;n<t.length;++n){var i=t[n];if(!i)break;e.modelview.push(),e.modelview.multiply(i.matrix),this.cachedUniforms=i.getDefaultUniforms(e,null),i.material.bind(this.cachedUniforms,e.shadow.shadow0),i.render(e),i.material.unbind(),e.modelview.pop()}}}),ShaderRenderStage=RenderStage.extend({init:function(e,t){this._super(t),this.shader=e,this.uniforms={}},onPostRender:function(e,t,n){this.shader.use(this.uniforms),this.shader.requirements.transparent&&(e.gl.blendFunc(e.gl.SRC_ALPHA,e.gl.ONE),e.gl.enable(e.gl.BLEND));for(var i=t.dynamicSpace.frustumCast(n.frustum,n.layerMask),r=0;r<i.length;r++)i[r].renderGeometry(e,this.shader);this.shader.requirements.transparent&&e.gl.disable(e.gl.BLEND)}}),DepthRenderStage=RenderStage.extend({init:function(e){this._super(),this.target=null,this.sampler=new Sampler("depth0",null),this.size=vec2.fromValues(1024,1024),e&&vec2.copy(this.size,e),this.clearColor=new Color(0,0,0,0)},onStart:function(e,t){try{this.target=new TargetTextureFloat(this.size,e,!1),this.sampler.texture=this.target.texture}catch(e){return console.warn("DepthRenderStage: ",e),void this.disable()}this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("depth")),{zNear:new UniformFloat(.1),zFar:new UniformFloat(1e3)},[])},onPreRender:function(e,t,n){if(this.target.resetViewport(),n.target.size[0]!=this.size[0]||n.target.size[1]!=this.size[1]){var i=n.target.size;vec2.copy(this.size,i),this.target.setSize(i[0],i[1])}},onPostRender:function(e,t,n){this.material.uniforms.zNear.value=n.near,this.material.uniforms.zFar.value=n.far,e.projection.push(),e.projection.load(n.projectionMatrix),e.modelview.push(),e.modelview.load(n.viewMatrix),this.target.bind(e,!1,this.clearColor);var i=e.gl;i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),this.material.bind();for(var r=this.parent.organizer.solidRenderers,o=0;o<r.length&&r[o];++o)e.modelview.push(),e.modelview.multiply(r[o].matrix),this.material.shader.bindUniforms(r[o].material.uniforms),r[o].renderGeometry(e,this.material.shader),e.modelview.pop();this.material.unbind(),this.renderAlphaMapped(e,t,n),i.disable(i.DEPTH_TEST),this.target.unbind(e),e.modelview.pop(),e.projection.pop()},renderAlphaMapped:function(e,t,n){var i=this.parent.organizer.transparentBatchList,r=this.material.shader;r.use(),r.bindUniforms(this.material.uniforms),r.bindUniforms(this.parent.sharedUniforms),e.light&&e.light.uniforms&&r.bindUniforms(e.light.uniforms);for(var o=0;o<i.length;o++){var a=i[o];if(0!=a.length){var s,l,c=a.get(0).material;s=0<this.material.samplers.length?this.material.samplers.concat(c.samplers):c.samplers,r.bindUniforms(c.uniforms),r.bindSamplers(s);for(var h=0;h<a.length;++h)l=a.get(h),e.modelview.push(),e.modelview.multiply(l.matrix),this.parent.rendererUniforms.model.value=l.matrix,this.parent.rendererUniforms.modelview.value=e.modelview.top(),r.bindUniforms(this.parent.rendererUniforms),l.renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(s)}}}}),ShadowMapRenderStage=RenderStage.extend({init:function(e){this._super(),this.material=null,this.clearColor=new Color(0,0,0,1),this.lightPosition=vec3.create(),this.lightLookTarget=vec3.create(),this.lightUpVector=vec3.fromValues(0,1,0),this.aabbVertices=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],this.sceneAABB=new BoundingBox,this.lightFrustum=new BoundingBox},onStart:function(e,t){var n="forward_shadow";e.isWebGL2()?n="forward_shadow_vsm":(this.extStandardDerivatives=e.gl.getExtension("OES_standard_derivatives"),this.extStandardDerivatives&&(n="forward_shadow_vsm")),this.material=new Material(t.assetsManager.addShader(t.assetsManager.shadersManager.bundle("forward_shadow.vert"),t.assetsManager.shadersManager.bundle("{0}.frag".format(n))),{hasFloat:new UniformInt(1)},[]),t.assetsManager.load()},onPostRender:function(e,t,n){var i=this.getFirstShadowCastingLight(t,!1);if(i){this.computeSceneBounds(),vec3.copy(this.lightPosition,this.sceneAABB.center),vec3.sub(this.lightLookTarget,this.lightPosition,i.direction),mat4.lookAt(i.lightView,this.lightPosition,this.lightLookTarget,this.lightUpVector),this.sceneAABB.getVertices(this.aabbVertices);for(var r=0;r<8;++r)vec3.transformMat4(this.aabbVertices[r],this.aabbVertices[r],i.lightView);this.lightFrustum.set(this.aabbVertices[0],[0,0,0]);for(r=1;r<8;++r)this.lightFrustum.encapsulatePoint(this.aabbVertices[r]);mat4.ortho(i.lightProj,this.lightFrustum.min[0],this.lightFrustum.max[0],this.lightFrustum.min[1],this.lightFrustum.max[1],this.lightFrustum.min[2],this.lightFrustum.max[2]),i.shadow instanceof TargetTextureFloat?this.material.uniforms.hasFloat.value=1:this.material.uniforms.hasFloat.value=0,e.projection.push(),e.projection.load(i.lightProj),e.modelview.push(),e.modelview.load(i.lightView),i.shadow.bind(e,!1,this.clearColor);var o=e.gl;o.enable(o.DEPTH_TEST),o.depthFunc(o.LESS),o.depthMask(!0),o.colorMask(!0,!0,!0,!0),this.material.bind();var a=this.parent.organizer.solidRenderers;for(r=0;r<a.length&&a[r];++r)a[r].layer&i.shadowMask&&a[r].castShadows&&(e.modelview.push(),e.modelview.multiply(a[r].matrix),this.material.shader.bindUniforms(a[r].material.uniforms),a[r].renderGeometry(e,this.material.shader),e.modelview.pop());this.material.unbind(),this.renderAlphaMapped(e,i),o.disable(o.DEPTH_TEST),i.shadow.unbind(e),i.updateSamplers(),i.undamage(),this.parent.prepareShadowContext(e,t),e.modelview.pop(),e.projection.pop()}},renderAlphaMapped:function(e,t){var n,i=this.parent.organizer.transparentBatchList,r=this.material.shader,o=[this.parent.diffuseFallback];r.use(),r.bindUniforms(this.material.uniforms),r.bindUniforms(this.parent.sharedUniforms);for(var a=0;a<i.length;++a){var s=i[a];if(0!=s.length){var l,c=s.get(0).material;n=0<c.samplers.length?c.samplers:o,r.bindUniforms(c.uniforms),r.bindSamplers(n);for(var h=0;h<s.length;++h)(l=s.get(h)).layer&t.shadowMask&&l.castShadows&&(e.modelview.push(),e.modelview.multiply(l.matrix),this.parent.rendererUniforms.model.value=l.matrix,this.parent.rendererUniforms.modelview.value=e.modelview.top(),r.bindUniforms(this.parent.rendererUniforms),l.renderGeometry(e,r),e.modelview.pop());r.unbindSamplers(n)}}},computeSceneBounds:function(){!1===this.sceneAABB.center&&(this.sceneAABB.center=vec3.create()),vec3.set(this.sceneAABB.center,0,0,0),vec3.set(this.sceneAABB.extents,0,0,0),this.sceneAABB.recalculate();for(var e=this.parent.organizer.solidRenderers,t=this.parent.organizer.transparentRenderers,n=0;n<e.length&&e[n];++n)e[n].castShadows&&this.sceneAABB.encapsulateBox(e[n].globalBoundingBox);for(n=0;n<t.length&&t[n];++n)t[n].castShadows&&this.sceneAABB.encapsulateBox(t[n].globalBoundingBox);return this.sceneAABB},getFirstShadowCastingLight:function(e,t){for(var n=0;n<e.lights.length;++n)if(e.lights[n]instanceof DirectionalLight&&e.lights[n].enabled&&(t||!e.engine.options.shadowManualUpdate||e.lights[n].damaged)&&!0===e.lights[n].shadowCasting)return e.lights[n];return!1}}),PositionBufferRenderStage=RenderStage.extend({init:function(e){this._super(),this.size=2048,e&&(this.size=e),this.target=!1},onStart:function(e,t){this.target=new TargetTextureFloat([this.size,this.size],e,!1),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("positionbuffer")),{ViewportSize:new UniformVec2(vec2.clone(t.scene.camera.target.size))},[]);this.quad=new TrianglesRenderBuffer(e,[0,1,2,0,2,3]),this.quad.add("position",[0,0,0,0,1,0,1,1,0,1,0,0],3),this.quad.add("texcoord2d0",[0,1,0,0,1,0,1,1],2),t.assetsManager.load(function(){})},onPreRender:function(e,t,n){vec2.set(this.material.uniforms.ViewportSize.value,n.target.size[0],n.target.size[1])},onPostRender:function(e,t,n){if(this.parent&&this.parent instanceof MaterialRenderStage&&this.target&&this.material){this.target.bind(e);var i=e.gl;i.depthMask(!0),i.clearDepth(1),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),this.material.bind();for(var r=0;r<this.parent.solidRenderers.length&&this.parent.solidRenderers[r];++r)this.parent.solidRenderers[r].layer&&this.parent.solidRenderers[r].visible&&(e.modelview.push(),e.modelview.multiply(this.parent.solidRenderers[r].matrix),this.parent.solidRenderers[r].renderGeometry(e,this.material.shader),e.modelview.pop());this.material.unbind(),i.depthMask(!0),i.disable(i.DEPTH_TEST),this.target.unbind(e)}}}),SSAOBufferRenderStage=RenderStage.extend({init:function(){this._super(),this.size=!1,this.quad=!1,this.target=!1},setSize:function(e,t){!1===this.size&&(this.size=vec2.create()),this.size[0]=e,this.size[1]=t},onStart:function(e,t){this.size||(this.size=vec2.clone(t.scene.camera.target.size)),this.target=new TargetTextureFloat([t.scene.camera.target.size[0],t.scene.camera.target.size[1]],e,!1),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("ssao")),{ViewportSize:new UniformVec2(vec2.clone(t.scene.camera.target.size)),ssaoGDisplace:new UniformFloat(t.options.ssaoGDisplace?t.options.ssaoGDisplace:6),ssaoRadius:new UniformFloat(t.options.ssaoRadius?t.options.ssaoRadius:8),ssaoDivider:new UniformFloat(t.options.ssaoDivider?t.options.ssaoDivider:.5)},[new Sampler("position0",this.parent.positionBufferStage.target.texture)]),this.material.name="SSAO";this.quad=new TrianglesRenderBuffer(e,[0,1,2,0,2,3]),this.quad.add("position",[-1,-1,0,-1,1,0,1,1,0,1,-1,0],3),this.quad.add("texcoord2d0",[0,1,0,0,1,0,1,1],2),t.assetsManager.load()},onPreRender:function(e,t,n){var i=n.target;i.size[0]==this.target.size[0]&&i.size[1]==this.target.size[1]||(vec2.set(this.material.uniforms.ViewportSize.value,n.target.size[0],n.target.size[1]),this.setSize(i.size[0],i.size[1]),this.target.setSize(i.size[0],i.size[1]))},onPostRender:function(e,t,n){if(this.parent&&this.parent instanceof MaterialRenderStage&&this.target&&this.material){this.target.bind(e);var i=e.gl;if(i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),this.material.bind(),this.material.shader.linked){var r=[];for(var o in this.quad.buffers){i.bindBuffer(i.ARRAY_BUFFER,this.quad.buffers[o]);var a=i.getAttribLocation(this.material.shader.program,o);-1!=a&&(i.enableVertexAttribArray(a),r.push(a),i.vertexAttribPointer(a,this.quad.buffers[o].itemSize,i.FLOAT,!1,0,0))}for(var s in this.quad.drawElements(),r)i.disableVertexAttribArray(r[s])}this.material.unbind(),this.target.unbind(e)}}}),SkyboxRenderStage=RenderStage.extend({init:function(){this._super(),this.uniforms={model:new UniformMat4(mat4.create()),modelview:new UniformMat4(mat4.create()),projection:new UniformMat4(mat4.create()),view:new UniformMat4(mat4.create()),viewInverse:new UniformMat4(mat4.create()),zNear:new UniformFloat(0),zFar:new UniformFloat(0),lightDirection:new UniformVec3(vec3.create()),lightColor:new UniformColor(new Color),lightIntensity:new UniformFloat(1)},this.shadowFallback=null},onStart:function(e,t,n){this.shadowFallback=new Sampler("shadow0",t.WhiteTexture)},onPostRender:function(e,t,n){var i=t.cameraNode.getComponent(SkyboxComponent);if(i)for(var r=[this.shadowFallback],o=i.meshNode.getComponent(MeshRendererComponent).meshRenderers,a=0;a<o.length;a++){var s=o[a],l=s.getDefaultUniforms(e,this.uniforms);mat4.identity(l.model.value),mat4.translate(l.model.value,l.model.value,n.getPosition()),s.material.bind(l,r),s.render(e),s.material.unbind(r)}}}),OpaqueGeometryRenderStage=RenderStage.extend({init:function(){this._super(),this.activeLights=[]},getDirectionalLights:function(e){this.activeLights.length<e.lights.length&&(this.activeLights.length=e.lights.length);for(var t,n=0,i=0;i<e.lights.length;++i)(t=e.lights[i])instanceof DirectionalLight&&t.enabled&&(this.activeLights[n++]=t);for(i=n;i<e.lights.length;++i)this.activeLights[i]=null;return this.activeLights},onPostRender:function(e,t,n){var i=this.getDirectionalLights(t),r=e.gl;if(r.enable(r.DEPTH_TEST),r.depthFunc(r.LESS),r.depthMask(!0),0<i.length&&i[0]&&(e.light=i[0]),this.parent.organizer.enableDynamicBatching?this.parent.renderBatched(e,this.parent.organizer.opaqueBatchList):this.parent.renderBruteForce(e,this.parent.organizer.solidRenderers),1<i.length&&i[1]){r.depthMask(!1),r.depthFunc(r.LEQUAL),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND);for(var o=1;o<i.length&&i[o];o++)e.light=i[o],this.parent.organizer.enableDynamicBatching?this.parent.renderBatched(e,this.parent.organizer.opaqueBatchList):this.parent.renderBruteForce(e,this.parent.organizer.solidRenderers);r.disable(r.BLEND),r.depthMask(!0),r.depthFunc(r.LESS)}r.disable(r.DEPTH_TEST),e.light=!1}}),TransparentGeometryRenderStage=RenderStage.extend({renderSorted:function(e,t,n){var i=e.gl;i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.enable(i.BLEND),i.depthMask(!1),i.depthFunc(i.LESS),i.enable(i.DEPTH_TEST),this.parent.renderBruteForce(e,this.parent.organizer.transparentRenderers),i.disable(i.BLEND),i.disable(i.DEPTH_TEST),i.depthMask(!0)},onPostRender:function(e,t,n){"sorted"==t.engine.options.transparencyMode?this.renderSorted(e,t,n):this.parent.oitStage.renderAlphaMapped(e,t,n)}}),OITRenderStage=RenderStage.extend({init:function(){this._super(),this.diffuseFallback=null,this.oitClearColor=new Color(0,0,0,0),this.transparencyTarget=!1,this.transparencySampler=!1,this.transparencyWeight=!1,this.transparencyWeightSampler=!1,this.transparencyAccum=!1},onStart:function(e,t,n){try{var i=n.target.size;this.transparencyTarget=new TargetTextureFloat(i,e,!1),this.transparencyWeight=new TargetTextureFloat(i,e,!1)}catch(e){return console.warn("OITRenderStage: ",e),void this.disable()}this.transparencySampler=new Sampler("oitAccum",this.transparencyTarget.texture),this.transparencyWeightSampler=new Sampler("oitWeight",this.transparencyWeight.texture),this.diffuseFallback=new Sampler("diffuse0",t.WhiteTexture),this.envFallback=new Sampler("env0",t.WhiteTexture);var r=e.gl;this.transparencyWeight.bind(e,!0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this.transparencyTarget.depth),this.transparencyWeight.unbind(e),this.transparencyWeight.depth=this.transparencyTarget.depth,this.transparencyAccum=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("OITAccum")),{render_mode:new UniformInt(0),useNormalmap:new UniformInt(0),useReflection:new UniformInt(0)},[]),this.opaqueDepthMaterial=new Material(t.assetsManager.addShaderSource("diffuse"),{useShadows:new UniformInt(0),ambient:new UniformColor,diffuse:new UniformColor},[this.diffuseFallback,new Sampler("shadow0",t.WhiteTexture)]),t.assetsManager.load()},onPostRender:function(e,t,n){if(this.transparencyTarget.resetViewport(),this.transparencyWeight.resetViewport(),n.target.size[0]!=this.transparencyTarget.size[0]||n.target.size[1]!=this.transparencyTarget.size[1]){this.transparencyTarget.setSize(n.target.size[0],n.target.size[1]),this.transparencyWeight.setSize(n.target.size[0],n.target.size[1]);var i=e.gl;this.transparencyWeight.bind(e,!0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this.transparencyTarget.depth),this.transparencyWeight.unbind(e),this.transparencyWeight.depth=this.transparencyTarget.depth}e.projection.push(),e.projection.load(n.projectionMatrix),e.modelview.push(),e.modelview.load(n.viewMatrix),this.oitClearColor.set(0,0,0,0),this.transparencyTarget.bind(e,!1,this.oitClearColor),e.gl.depthMask(!0),e.gl.colorMask(!1,!1,!1,!1),this.renderOpaque(e,t,n),this.renderAlphaMapped(e,t,n),e.gl.colorMask(!0,!0,!0,!0),this.renderPass(e,t,n,!0),this.transparencyTarget.unbind(e),this.oitClearColor.set(1,1,1,1),this.transparencyWeight.bind(e,!1,this.oitClearColor,e.gl.COLOR_BUFFER_BIT),this.renderPass(e,t,n,!1),this.transparencyWeight.unbind(e),e.modelview.pop(),e.projection.pop()},renderTransparentBatches:function(e,t,n,i){var r=i.shader;r.use(),e.light&&e.light.uniforms&&r.bindUniforms(e.light.uniforms);for(var o=this.parent.organizer.transparentBatchList,a=0,s=o.length;a<s;a++){var l=o[a];if(0!=l.length){var c,h,u,d,f=l.get(0).material;c=0<i.samplers.length?i.samplers.concat(f.samplers):f.samplers;for(var m=0;m<c.length;++m)"normal0"!=c[m].name?"env0"!=c[m].name?"diffuse0"==c[m].name&&(h=!0):(i.uniforms.useReflection.value=1,u=!0):i.uniforms.useNormalmap.value=1;h||c.push(this.diffuseFallback),u||c.push(this.envFallback),r.bindUniforms(i.uniforms),r.bindUniforms(f.uniforms),r.bindSamplers(c);for(var v=0,p=l.length;v<p;++v)d=l.get(v),e.modelview.push(),e.modelview.multiply(d.matrix),d.renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(c)}}},renderAlphaMapped:function(e,t,n){var i=e.gl;i.depthMask(!0),i.depthFunc(i.LESS),i.enable(i.DEPTH_TEST),this.transparencyAccum.uniforms.render_mode.value=2,this.renderTransparentBatches(e,t,n,this.transparencyAccum),i.disable(i.DEPTH_TEST)},renderOpaque:function(e,t,n){var i=e.gl;i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS);var r=this.opaqueDepthMaterial.shader;r.use(),r.bindUniforms(this.opaqueDepthMaterial.uniforms),r.bindSamplers(this.opaqueDepthMaterial.samplers);for(var o=this.parent.organizer.solidRenderers,a=0;a<o.length&&o[a];++a)e.modelview.push(),e.modelview.multiply(o[a].matrix),o[a].renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(this.opaqueDepthMaterial.samplers),i.disable(i.DEPTH_TEST)},renderPass:function(e,t,n,i){var r=e.gl;r.colorMask(!0,!0,!0,!0),r.depthFunc(r.LESS),r.enable(r.DEPTH_TEST),"blended"==t.engine.options.transparencyMode&&(this.transparencyAccum.uniforms.render_mode.value=i?(r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND),0):(r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ZERO,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),1)),"stochastic"==t.engine.options.transparencyMode&&(this.transparencyAccum.uniforms.render_mode.value=i?(r.depthMask(!0),3):(r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ZERO,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND),1)),this.renderTransparentBatches(e,t,n,this.transparencyAccum),r.disable(r.BLEND),r.disable(r.DEPTH_TEST),r.depthMask(!0)}}),PostProcessRenderStage=RenderStage.extend({init:function(){this._super(),this.size=!1,this.src=!1,this.dst=!1,this.srcSampler=!1,this.dstSampler=!1,this.textureQuad=!1,this.screenQuad=!1,this.material=!1,this.generator=this.getGeneratorStage(),this.generator.parent=this},setSize:function(e,t){!1===this.size&&(this.size=vec2.create()),this.size[0]=e,this.size[1]=t},getGeneratorStage:function(){return new MaterialRenderStage},onStart:function(e,t,n){this.size||(this.size=vec2.clone(n.target.size)),this.src=new TargetTexture(this.size,e,!1,!0),this.srcSampler=new Sampler("src",this.src.texture),this.dst=new TargetTexture(this.size,e,!1,!0),this.dstSampler=new Sampler("src",this.dst.texture),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("ScreenQuad")),{},[]),this.material.name="To Screen",this.textureQuad=new ScreenQuad(e),this.screenQuad=new ScreenQuad(e),t.assetsManager.load(),this.generator.start(e,t,n)},onPreRender:function(e,t,n){var i=n.target;this.src.resetViewport(),this.dst.resetViewport(),i.size[0]==this.src.size[0]&&i.size[1]==this.src.size[1]||(this.setSize(i.size[0],i.size[1]),this.src.setSize(i.size[0],i.size[1]),this.dst.setSize(i.size[0],i.size[1])),0<this.substages.length&&(n.target=this.src),this.generator.render(e,t,n),n.target=i},onPostRender:function(e,t,n){0!=this.substages.length&&(n.target instanceof TargetTexture?(n.target.bind(e),this.renderEffect(e,this.material,this.srcSampler)):(n.target.bind(e),this.renderEffect(e,this.material,this.srcSampler,!0)),n.target.unbind(e),this.swapBuffers())},swapBuffers:function(){var e=this.src,t=this.srcSampler;this.src=this.dst,this.srcSampler=this.dstSampler,this.dst=e,this.dstSampler=t},renderEffect:function(e,t,n,i){var r=e.gl;r.disable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),!0===i?this.screenQuad.render(e,t,n):this.textureQuad.render(e,t,n)}}),ForwardRenderStage=PostProcessRenderStage.extend({init:function(){this._super(),this.debugActive=!1,this.debugger=null},onPostRender:function(e,t,n){if(this._super(e,t,n),this.debugActive){this.debugger||this.initDebugger(e,t);var i=e.gl;i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE),e.modelview.push();for(var r=0;r<this.debugger.quads.length;r++)this.debugger.sampler.texture=this.debugger.quads[r].texture,this.material.bind({},[this.debugger.sampler]),this.debugger.quads[r].quad.render(this.material.shader),this.material.unbind([this.debugger.sampler]);this.debugger.sampler.texture=this.debugger.vsyncTextures[0],this.material.bind({},[this.debugger.sampler]),this.debugger.vsyncQuad.render(this.material.shader),this.material.unbind([this.debugger.sampler]),this.debugger.vsyncTextures.reverse(),e.modelview.pop()}},debug:function(e){this.debugActive=!(!1===e)},initDebugger:function(a,e){var t=new Texture(a);t.name="Red",t.mipmapped=!1,t.clearImage(a,[255,0,0,255]);var n=new Texture(a);function i(e,t,n,i){var r=[e,t,0,e,t+i,0,e+n,t+i,0,e+n,t,0],o=new TrianglesRenderBuffer(a,[0,1,2,0,2,3]);return o.add("position",r,3),o.add("uv0",[0,0,0,1,1,1,1,0],2),o}n.name="Red",n.mipmapped=!1,n.clearImage(a,[0,255,255,255]),this.debugger={quads:[],sampler:new Sampler("tex0",null),vsyncQuad:i(.85,.85,.1,.1),vsyncTextures:[t,n]};for(var r=.5,o=-1,s=1-r,l=0;l<e.lights.length;l++)e.lights[l].enabled&&e.lights[l].shadowCasting&&e.lights[l].shadow&&e.lights[l]instanceof DirectionalLight&&(this.debugger.quads.push({quad:i(o,s,r,r),texture:e.lights[l].shadow.texture}),o+=r);r=.5,s=o=-1,this.generator.oitStage.enabled&&(this.debugger.quads.push({quad:i(o,s,r,r),texture:this.generator.oitStage.transparencyTarget.texture}),this.debugger.quads.push({quad:i(o+=r,s,r,r),texture:this.generator.oitStage.transparencyWeight.texture})),this.generator.depthStage.enabled&&this.debugger.quads.push({quad:i(o+=r,s,r,r),texture:this.generator.depthStage.target.texture})}}),DeferredRenderStage=PostProcessRenderStage.extend({init:function(){this._super(),this.debugActive=!1,this.debugger=null},onStart:function(e,t,n){if(!e.isWebGL2()&&!e.gl.getExtension("WEBGL_draw_buffers"))throw"DeferredRenderStage: WEBGL_draw_buffers not available.";if(!e.isWebGL2()&&!e.gl.getExtension("OES_texture_float"))throw"DeferredRenderStage: OES_texture_float not available.";if(!e.isWebGL2()&&!e.gl.getExtension("OES_standard_derivatives"))throw"DeferredRenderStage: OES_standard_derivatives not available.";this._super(e,t,n)},getGeneratorStage:function(){return new DeferredShadingRenderStage},onPreRender:function(e,t,n){var i=n.target;if(this.src.resetViewport(),this.dst.resetViewport(),this.generator.gbufferStage.damaged){var r=vec2.scale(vec2.create(),this.generator.gbufferStage.size,this.generator.gbufferStage.quality);this.src.setSize(r[0],r[1]),this.dst.setSize(r[0],r[1])}this.setSize(i.size[0],i.size[1]),0<this.substages.length&&(n.target=this.src),this.generator.render(e,t,n),n.target=i},onPostRender:function(e,t,n){if(this._super(e,t,n),this.debugActive){this.debugger||this.initDebugger(e,t);var i=e.gl;i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE),e.modelview.push();for(var r=0;r<this.debugger.quads.length;r++)this.debugger.sampler.texture=this.debugger.quads[r].texture,this.material.bind({},[this.debugger.sampler]),this.debugger.quads[r].quad.render(this.material.shader),this.material.unbind([this.debugger.sampler]);e.modelview.pop()}},debug:function(e){this.debugActive=!(!1===e)},initDebugger:function(a,e){function t(e,t,n,i){var r=[e,t,0,e,t+i,0,e+n,t+i,0,e+n,t,0],o=new TrianglesRenderBuffer(a,[0,1,2,0,2,3]);return o.add("position",r,3),o.add("uv0",[0,0,0,1,1,1,1,0],2),o}this.debugger={quads:[],sampler:new Sampler("tex0",null)};var n=this.generator.gbufferStage.buffer,i=2/7,r=-1,o=-1;this.debugger.quads.push({quad:t(r,o,i,i),texture:n.targets[0]}),this.debugger.quads.push({quad:t(r+=i,o,i,i),texture:n.targets[1]}),this.debugger.quads.push({quad:t(r+=i,o,i,i),texture:n.targets[2]}),this.debugger.quads.push({quad:t(r+=i,o,i,i),texture:n.targets[3]}),this.debugger.quads.push({quad:t(r+=i,o,i,i),texture:this.generator.softShadowsStage.target.texture}),this.debugger.quads.push({quad:t(r+=i,o,i,i),texture:this.generator.oitStage.transparencyTarget.texture}),this.debugger.quads.push({quad:t(r+=i,o,i,i),texture:this.generator.oitStage.transparencyWeight.texture}),r=-1,o=1-(i=.5);for(var s=0;s<e.lights.length;s++)e.lights[s].enabled&&e.lights[s].shadowCasting&&e.lights[s].shadow&&e.lights[s]instanceof DirectionalLight&&(this.debugger.quads.push({quad:t(r,o,i,i),texture:e.lights[s].shadow.texture}),r+=i)}}),DeferredShadingRenderStage=RenderStage.extend({init:function(){this._super(),this.organizer=new RendererOrganizer,this.diffuseFallback=null,this.size=vec2.create(),this.bindCameraTarget={started:!0,start:function(){},render:function(e,t,n){n.target.bind(e,!0)}},this.unbindCameraTarget={started:!0,start:function(){},render:function(e,t,n){n.target.unbind(e)}},this.shadowStage=this.addStage(new DeferredShadowRenderStage),this.oitStage=this.addStage(new OITRenderStage),this.gbufferStage=this.addStage(new GBufferRenderStage),this.softShadowsStage=this.addStage(new SoftShadowsRenderStage).disable(),this.addStage(this.bindCameraTarget),this.lightsStage=this.addStage(new LightsRenderStage),this.addStage(this.unbindCameraTarget),this.sharedUniforms={view:new UniformMat4(mat4.create()),viewInverse:new UniformMat4(mat4.create()),projection:new UniformMat4(mat4.create())},this.rendererUniforms={model:new UniformMat4(null),modelview:new UniformMat4(null),receiveShadows:new UniformInt(1)}},onStart:function(e,t,n){this.diffuseFallback=new Sampler("diffuse0",t.WhiteTexture),vec2.copy(this.size,this.parent.size),t.options.softShadows&&this.softShadowsStage.enable()},prepareShared:function(e){mat4.copy(this.sharedUniforms.projection.value,e.projection.top()),mat4.copy(this.sharedUniforms.view.value,e.camera.viewMatrix),mat4.copy(this.sharedUniforms.viewInverse.value,e.camera.viewInverseMatrix),vec2.copy(this.size,this.parent.size)},onPreRender:function(e,t,n){this.prepareShared(e);var i=t.dynamicSpace.frustumCast(n.frustum,n.layerMask);this.organizer.sort(t.engine,i)},onPostRender:function(e,t,n){}}),DeferredShadowRenderStage=RenderStage.extend({init:function(){this._super(),this.material=null,this.directional=[],this.clearColor=new Color(0,0,0,0),this.lightPosition=vec3.create(),this.lightLookTarget=vec3.create(),this.lightUpVector=vec3.fromValues(0,1,0),this.aabbVertices=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],this.sceneAABB=new BoundingBox,this.lightFrustum=new BoundingBox},onStart:function(e,t,n){e.isWebGL2()||(this.extStandardDerivatives=e.gl.getExtension("OES_standard_derivatives")),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("deferred_shadow_directional")),{},[]),t.assetsManager.load()},collectLights:function(e){for(var t=this.directional.length=0;t<e.lights.length;++t)e.lights[t].enabled&&e.lights[t].shadowCasting&&e.lights[t].shadow&&(e.engine.options.shadowManualUpdate&&!e.lights[t].damaged||e.lights[t]instanceof DirectionalLight&&this.directional.push(e.lights[t]))},computeSceneBounds:function(){!1===this.sceneAABB.center&&(this.sceneAABB.center=vec3.create()),vec3.set(this.sceneAABB.center,0,0,0),vec3.set(this.sceneAABB.extents,0,0,0),this.sceneAABB.recalculate();for(var e=this.parent.organizer.solidRenderers,t=this.parent.organizer.transparentRenderers,n=0;n<e.length&&e[n];++n)e[n].castShadows&&this.sceneAABB.encapsulateBox(e[n].globalBoundingBox);for(n=0;n<t.length&&t[n];++n)t[n].castShadows&&this.sceneAABB.encapsulateBox(t[n].globalBoundingBox);return this.sceneAABB},renderDirectionalLightDepth:function(e,t){vec3.copy(this.lightPosition,this.sceneAABB.center),vec3.sub(this.lightLookTarget,this.lightPosition,t.direction),mat4.lookAt(t.lightView,this.lightPosition,this.lightLookTarget,this.lightUpVector),this.sceneAABB.getVertices(this.aabbVertices);for(var n=0;n<8;++n)vec3.transformMat4(this.aabbVertices[n],this.aabbVertices[n],t.lightView);this.lightFrustum.set(this.aabbVertices[0],[0,0,0]);for(n=1;n<8;++n)this.lightFrustum.encapsulatePoint(this.aabbVertices[n]);mat4.ortho(t.lightProj,this.lightFrustum.min[0],this.lightFrustum.max[0],this.lightFrustum.min[1],this.lightFrustum.max[1],this.lightFrustum.min[2],this.lightFrustum.max[2]),e.projection.push(),e.projection.load(t.lightProj),e.modelview.push(),e.modelview.load(t.lightView),t.shadow.bind(e,!1,this.clearColor);var i=e.gl;i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),this.material.bind();var r=this.parent.organizer.solidRenderers;for(n=0;n<r.length&&r[n];++n)if(r[n].layer&t.shadowMask&&r[n].castShadows){var o=this.material.shader;e.modelview.push(),e.modelview.multiply(r[n].matrix),o.bindUniforms(r[n].material.uniforms),r[n].renderGeometry(e,o),e.modelview.pop()}this.material.unbind(),this.renderAlphaMapped(e,t),i.disable(i.DEPTH_TEST),t.shadow.unbind(e),t.updateSamplers(e),e.modelview.pop(),e.projection.pop(),t.undamage()},renderAlphaMapped:function(e,t){var n,i=this.parent.organizer.transparentBatchList,r=this.material.shader,o=[this.parent.diffuseFallback];r.use(),r.bindUniforms(this.material.uniforms);for(var a=0;a<i.length;++a){var s=i[a];if(0!=s.length){var l=s.get(0).material;n=0<l.samplers.length?l.samplers:o,r.bindUniforms(l.uniforms),r.bindSamplers(n);for(var c=0;c<s.length;++c){var h;(h=s.get(c)).layer&t.shadowMask&&(h.castShadows&&(e.modelview.push(),e.modelview.multiply(h.matrix),h.renderGeometry(e,r),e.modelview.pop()))}r.unbindSamplers(n)}}},onPreRender:function(e,t,n){this.collectLights(t),this.computeSceneBounds();for(var i=0;i<this.directional.length;++i)this.renderDirectionalLightDepth(e,this.directional[i])},onPostRender:function(e,t,n){}}),GBufferRenderStage=RenderStage.extend({init:function(){this._super(),this.buffer=null,this.clearColor=new Color(0,0,0,0),this.size=vec2.create(),this.quality=1,this.damaged=!0,this.perBatchUniforms={useNormalmap:new UniformInt(0),useReflection:new UniformInt(0)}},setQuality:function(e){0<(e=parseFloat(e))&&(this.quality=e,this.damaged=!0)},onStart:function(e,t,n){vec2.copy(this.size,this.parent.size);var i=vec2.scale(vec2.create(),this.size,this.quality);this.buffer=new TargetTextureMulti(e,i,{numTargets:4,stencil:!0}),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("deferred_gbuffer")),{zNear:new UniformFloat(.1),zFar:new UniformFloat(1e3)},[]),this.normalmapFallback=new Sampler("normal0"),this.maskFallback=new Sampler("mask"),this.envFallback=new Sampler("env0"),this.envFallback.createFallbackCubeTexture(e),this.envFallback.texture=fallbackCubeTexture,t.assetsManager.load()},onPreRender:function(e,t,n){if(this.material.uniforms.zNear.value=n.near,this.material.uniforms.zFar.value=n.far,this.damaged){var i=vec2.scale(vec2.create(),this.size,this.quality);this.buffer.setSize(i[0],i[1]),this.damaged=!1}},onPostRender:function(e,t,n){var i=e.gl;this.buffer.bind(e,!1,this.clearColor),i.depthMask(!0),i.colorMask(!0,!0,!0,!0),i.depthFunc(i.LESS),i.enable(i.DEPTH_TEST),i.enable(i.STENCIL_TEST),i.stencilMask(255),i.stencilFunc(i.ALWAYS,1,255),i.stencilOp(i.KEEP,i.KEEP,i.REPLACE),this.renderBatches(e,t,n,this.parent.organizer.opaqueBatchList,this.material),this.renderBatches(e,t,n,this.parent.organizer.transparentBatchList,this.material),i.stencilMask(255),i.disable(i.STENCIL_TEST),i.disable(i.DEPTH_TEST),this.buffer.unbind(e)},renderBatches:function(e,t,n,i,r){var o=r.shader;o.use(),o.bindUniforms(r.uniforms);for(var a=0;a<i.length;a++){var s=i[a];if(0!=s.length){var l=s.get(0).material;this.perBatchUniforms.useNormalmap.value=0;for(var c,h,u=!1,d=this.perBatchUniforms.useReflection.value=0;d<l.samplers.length;d++)"normal0"!=l.samplers[d].name?"env0"!=l.samplers[d].name?"mask"!=l.samplers[d].name||(u=!0):this.perBatchUniforms.useReflection.value=1:this.perBatchUniforms.useNormalmap.value=1;c=0<r.samplers.length?r.samplers.concat(l.samplers):l.samplers.slice(),0==l.samplers.length&&c.push(this.parent.diffuseFallback),0==this.perBatchUniforms.useNormalmap.value&&c.push(this.normalmapFallback),0==this.perBatchUniforms.useReflection.value?(c.push(this.envFallback),c.push(this.maskFallback)):1!=this.perBatchUniforms.useReflection.value||u||c.push(this.maskFallback),o.bindUniforms(this.perBatchUniforms),o.bindUniforms(l.uniforms),o.bindSamplers(c);for(var f=0;f<s.length;++f)h=s.get(f),e.modelview.push(),e.modelview.multiply(h.matrix),h.renderGeometry(e,o),e.modelview.pop();o.unbindSamplers(c)}}}}),SoftShadowsRenderStage=RenderStage.extend({init:function(){this._super(),this.quality=1,this.damaged=!1,this.sharedUniforms={cameraPosition:new UniformVec3(vec3.create()),shadowOnly:new UniformInt(1),useSoftShadows:new UniformInt(0)},this.sharedSamplers=[],this.clearColor=new Color(0,0,0,0),this.target=null},setQuality:function(e){0<(e=parseFloat(e))&&(this.quality=e,this.damaged=!0)},getShadowCastingLights:function(e){for(var t=[],n=0;n<e.lights.length;n++){var i=e.lights[n];i.enabled&&(i.shadowCasting&&i.geometry&&i instanceof DirectionalLight&&t.push(i))}return t},onStart:function(e,t,n){var i=this.parent.gbufferStage.buffer;this.sharedSamplers.push(new Sampler("gb0",i.targets[0])),this.sharedSamplers.push(new Sampler("gb1",i.targets[1])),this.sharedSamplers.push(new Sampler("gb2",i.targets[2])),this.sharedSamplers.push(new Sampler("gb3",i.targets[3])),this.target=new TargetTexture(this.parent.size,e,!1),this.blurTarget=new TargetTexture(this.parent.size,e,!1),this.blurSampler=new Sampler("src",this.target.texture),this.blurHorizontal=new Material(t.assetsManager.addShader(t.assetsManager.shadersManager.bundle("shadow_blurh.vert"),t.assetsManager.shadersManager.bundle("shadow_blur.frag")),{},[]),this.blurVertical=new Material(t.assetsManager.addShader(t.assetsManager.shadersManager.bundle("shadow_blurv.vert"),t.assetsManager.shadersManager.bundle("shadow_blur.frag")),{},[]),t.assetsManager.load()},onPreRender:function(e,t,n){if(this.damaged){var i=vec2.scale(vec2.create(),this.parent.size,this.quality);this.target.setSize(i[0],i[1]),this.blurTarget.setSize(i[0],i[1]),this.damaged=!1}},onPostRender:function(e,t,n){var i=this.getShadowCastingLights(t);if(0!=i.length){n.getPosition(this.sharedUniforms.cameraPosition.value);var r=e.gl;r.disable(r.DEPTH_TEST),r.depthMask(!1),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND),r.enable(r.CULL_FACE),r.cullFace(r.FRONT),this.target.bind(e,!1,this.clearColor);for(var o=0;o<i.length;o++)this.renderLight(e,i[o]);this.target.unbind(e),r.disable(r.BLEND),this.blurSampler.texture=this.target.texture,this.blurTarget.bind(e,!1,this.clearColor),this.parent.parent.renderEffect(e,this.blurHorizontal,this.blurSampler),this.blurTarget.unbind(e),this.blurSampler.texture=this.blurTarget.texture,this.target.bind(e,!1,this.clearColor),this.parent.parent.renderEffect(e,this.blurVertical,this.blurSampler),this.target.unbind(e)}},renderLight:function(e,t){var n,i=t.material,r=i.shader;r.use(),r.bindUniforms(this.sharedUniforms),r.bindUniforms(i.uniforms),n=0<i.samplers.length?i.samplers.concat(this.sharedSamplers):this.sharedSamplers,r.bindSamplers(n);for(var o=t.getGeometryRenderers(),a=0;a<o.length;a++)e.modelview.push(),t.isPositional()&&e.modelview.multiply(o[a].matrix),o[a].renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(n)}}),LightsRenderStage=RenderStage.extend({init:function(){this._super(),this.sharedUniforms={cameraPosition:new UniformVec3(vec3.create()),shadowOnly:new UniformInt(0),useSoftShadows:new UniformInt(1)},this.sharedSamplers=[],this.skyboxRenderStage=new SkyboxRenderStage},getLightsWithGeometry:function(e){for(var t=[],n=[],i=[],r=0;r<e.lights.length;r++){var o=e.lights[r];o.enabled&&(o.geometry&&(o instanceof AmbientLight?t.push(o):o instanceof DirectionalLight?n.push(o):i.push(o)))}return t.concat(n).concat(i)},onStart:function(e,t,n){var i=this.parent.gbufferStage.buffer;this.sharedSamplers.push(new Sampler("gb0",i.targets[0])),this.sharedSamplers.push(new Sampler("gb1",i.targets[1])),this.sharedSamplers.push(new Sampler("gb2",i.targets[2])),this.sharedSamplers.push(new Sampler("gb3",i.targets[3])),this.backgroundMaterial=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("deferred_background")),{color:new UniformColor(new Color(1,1,1,1))},[]),t.assetsManager.load(),this.skyboxRenderStage.start(e,t,n)},onPreRender:function(e,t,n){this.sharedUniforms.useSoftShadows.value=this.parent.softShadowsStage.enabled?1:0,n.getPosition(this.sharedUniforms.cameraPosition.value)},onPostRender:function(e,t,n){var i=this.getLightsWithGeometry(t),r=e.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this.parent.gbufferStage.buffer.depth),r.disable(r.DEPTH_TEST),r.depthMask(!1),r.enable(r.STENCIL_TEST),r.stencilMask(0),r.stencilFunc(r.NOTEQUAL,1,255),n.backgroundColor.toVector(this.backgroundMaterial.uniforms.color.value),this.parent.parent.renderEffect(e,this.backgroundMaterial,this.sharedSamplers[1]),this.skyboxRenderStage.render(e,t,n),r.stencilFunc(r.EQUAL,1,255),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.ONE,r.ONE),r.enable(r.BLEND),r.enable(r.CULL_FACE),r.cullFace(r.FRONT);for(var o=0;o<i.length;o++)this.renderLight(e,i[o]);r.disable(r.BLEND),r.stencilMask(255),r.disable(r.STENCIL_TEST)},renderLight:function(e,t){var n;t.shadowCasting&&t instanceof DirectionalLight&&1==this.sharedUniforms.useSoftShadows.value&&(n=t.shadowSampler.texture,t.shadowSampler.texture=this.parent.softShadowsStage.target.texture);var i,r=t.material.shader;r.use(),r.bindUniforms(this.sharedUniforms),r.bindUniforms(t.material.uniforms),i=0<t.material.samplers.length?t.material.samplers.concat(this.sharedSamplers):this.sharedSamplers,r.bindSamplers(i);for(var o=t.getGeometryRenderers(),a=0;a<o.length;a++)e.modelview.push(),t.isPositional()&&e.modelview.multiply(o[a].matrix),o[a].renderGeometry(e,r),e.modelview.pop();r.unbindSamplers(i),t.shadowCasting&&t instanceof DirectionalLight&&1==this.sharedUniforms.useSoftShadows.value&&(t.shadowSampler.texture=n)}}),PostProcess=RenderStage.extend({init:function(){this._super(),this.material=!1},onPostRender:function(e,t,n){if(!(this.parent instanceof PostProcessRenderStage))throw"PostProcess can only be the sub-stage of a PostProcessRenderStage";if(!this.material)throw"PostProcess must have a material defined";this.parent.dst.bind(e),this.parent.renderEffect(e,this.material,this.parent.srcSampler),this.parent.dst.unbind(e),this.parent.swapBuffers()}}),AntiAliasPostProcess=PostProcess.extend({init:function(){this._super()},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("postprocess_fxaa")),{ViewportSize:new UniformVec2(vec2.clone(this.parent.src.size)),reduce_min:new UniformFloat(1/16),reduce_mul:new UniformFloat(1/8),span_max:new UniformFloat(8)},[]),this.material.name="AntiAlias",t.assetsManager.load()},onPreRender:function(e,t,n){this._super(e,t,n),vec2.copy(this.material.uniforms.ViewportSize.value,this.parent.src.size)}}),BlurPostProcess=PostProcess.extend({init:function(e){this._super(),this.blurSize=vec2.fromValues(1,1),e&&vec2.copy(this.blurSize,e)},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("postprocess_blur")),{ViewportSize:new UniformVec2(vec2.clone(this.parent.size)),BlurSize:new UniformVec2(this.blurSize)},[]),this.material.name="Blur",t.assetsManager.load()},onPreRender:function(e,t,n){this._super(e,t,n),vec2.set(this.material.uniforms.ViewportSize.value,this.parent.size[0],this.parent.size[1])}}),OITPostProcess=PostProcess.extend({init:function(){this._super()},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("OITRender")),{ViewportSize:new UniformVec2(vec2.clone(this.parent.src.size)),render_mode:new UniformInt(0)},[this.parent.generator.oitStage.transparencySampler,this.parent.generator.oitStage.transparencyWeightSampler]),this.material.name="OIT",t.assetsManager.load()},onPreRender:function(e,t,n){switch(this._super(e,t,n),vec2.copy(this.material.uniforms.ViewportSize.value,this.parent.src.size),t.engine.options.transparencyMode){case"blended":this.material.uniforms.render_mode.value=0;break;case"stochastic":this.material.uniforms.render_mode.value=1}}}),SSAOPostProcess=PostProcess.extend({init:function(e){this._super(),this.ssaoOnly=!1},onStart:function(e,t){this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("postprocess_ssao")),{ViewportSize:new UniformVec2(vec2.clone(this.parent.src.size)),ssaoOnly:new UniformInt(!0===this.ssaoOnly?1:0),gdisplace:new UniformFloat(t.options.ssaoGDisplace?t.options.ssaoGDisplace:.3),radius:new UniformFloat(t.options.ssaoRadius?t.options.ssaoRadius:2),luminanceInfluence:new UniformFloat(t.options.ssaoLuminanceInfluence?t.options.ssaoLuminanceInfluence:.7),brightness:new UniformFloat(t.options.ssaoBrightness?t.options.ssaoBrightness:1)},[this.parent.generator.depthStage.sampler]),this.material.name="SSAO","blended"==t.options.transparencyMode?this.material.samplers.push(this.parent.generator.oitStage.transparencyWeightSampler):this.material.samplers.push(new Sampler("oitWeight",t.WhiteTexture)),t.assetsManager.load()},onPreRender:function(e,t,n){this._super(e,t,n),vec2.set(this.material.uniforms.ViewportSize.value,this.parent.src.size[0],this.parent.src.size[1]),this.material.uniforms.ssaoOnly.value=!0===this.ssaoOnly?1:0}}),RenderTarget=FrakClass.extend({init:function(e){this.viewport={position:vec2.create(),size:vec2.create()},this.size=vec2.create(),e&&(vec2.copy(this.size,e),vec2.copy(this.viewport.size,e))},type:function(){return"RenderTarget"},bind:function(e){e.gl.viewport(this.viewport.position[0],this.viewport.position[1],this.viewport.size[0],this.viewport.size[1]),e.gl.scissor(this.viewport.position[0],this.viewport.position[1],this.viewport.size[0],this.viewport.size[1]),e.gl.enable(e.gl.SCISSOR_TEST)},unbind:function(e){e.gl.disable(e.gl.SCISSOR_TEST)},setSize:function(e,t){this.size[0]=e,this.size[1]=t},getSize:function(){return this.size},setViewport:function(e,t,n,i){vec2.set(this.viewport.position,e,t),vec2.set(this.viewport.size,n,i)},inheritViewport:function(e){vec2.copy(this.viewport.position,e.viewport.position),vec2.copy(this.viewport.size,e.viewport.size)},resetViewport:function(){this.setViewport(0,0,this.size[0],this.size[1])}}),TargetScreen=RenderTarget.extend({init:function(e){this._super(e),this.position=vec2.create()},type:function(){return"TargetScreen"},setPosition:function(e,t){this.position[0]=e,this.position[1]=t},getPosition:function(){return this.position},resetViewport:function(){this.setViewport(this.position[0],this.position[1],this.size[0],this.size[1])}}),TargetTexture=RenderTarget.extend({init:function(e,t,n,i){var r=e;if((e instanceof Texture&&(r=e.size,this.texture=e),this.useDepthTexture=!0===n,this.useStencilBuffer=!0===i,this.rebuild=!1,this._super(r),this.useDepthTexture&&!t.isWebGL2())&&!(t.gl.getExtension("WEBGL_depth_texture")||t.gl.getExtension("WEBKIT_WEBGL_depth_texture")||t.gl.UNSIGNED_INT_24_8))throw"TargetTexture: Depth texture reqeusted, but not available.";this.build(t)},type:function(){return"TargetTexture"},setSize:function(e,t){this._super(e,t),this.rebuild=!0},getDataType:function(e){return e.gl.UNSIGNED_BYTE},getInternalFormat:function(e){return e.gl.RGBA},getTextureFilter:function(e){return e.gl.NEAREST},build:function(e){var t=e.gl;this.frameBuffer=t.createFramebuffer(),this.texture||(this.texture=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.texture.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),t.texImage2D(t.TEXTURE_2D,0,this.getInternalFormat(e),this.size[0],this.size[1],0,t.RGBA,this.getDataType(e),null),t.bindTexture(t.TEXTURE_2D,null)),this.useDepthTexture?(this.depth=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.depth.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT,this.size[0],this.size[1],0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null),t.bindTexture(t.TEXTURE_2D,null)):(this.depth=t.createRenderbuffer(),this.useStencilBuffer?(t.bindRenderbuffer(t.RENDERBUFFER,this.depth),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,this.size[0],this.size[1])):(t.bindRenderbuffer(t.RENDERBUFFER,this.depth),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.size[0],this.size[1])),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture.glTexture,0),this.useDepthTexture?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depth.glTexture,0):this.useStencilBuffer?t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,this.depth):t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depth),this.checkStatus(e),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture.loaded=!0},checkStatus:function(e){var t=e.gl,n=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(n){case t.FRAMEBUFFER_COMPLETE:return!0;case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"TargetTexture: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"TargetTexture: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"TargetTexture: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:throw"TargetTexture: Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"TargetTexture: Incomplete framebuffer: "+n}},bind:function(e,t,n,i){var r=e.gl;if(this.rebuild&&(r.bindTexture(r.TEXTURE_2D,this.texture.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),r.texImage2D(r.TEXTURE_2D,0,this.getInternalFormat(e),this.size[0],this.size[1],0,r.RGBA,this.getDataType(e),null),r.bindTexture(r.TEXTURE_2D,null),this.useDepthTexture?(r.bindTexture(r.TEXTURE_2D,this.depth.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texImage2D(r.TEXTURE_2D,0,r.DEPTH_COMPONENT,this.size[0],this.size[1],0,r.DEPTH_COMPONENT,r.UNSIGNED_SHORT,null),r.bindTexture(r.TEXTURE_2D,null)):(r.bindRenderbuffer(r.RENDERBUFFER,this.depth),this.useStencilBuffer?r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,this.size[0],this.size[1]):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.size[0],this.size[1]),r.bindRenderbuffer(r.RENDERBUFFER,null)),this.rebuild=!1),t=!0===t,(n=n instanceof Color&&n)||(e.camera?n=e.camera.backgroundColor:t=!0),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),this._super(e),!t){r.clearColor(n.r,n.g,n.b,n.a),r.clearDepth(1);var o=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;this.useStencilBuffer&&(r.clearStencil(0),o|=r.STENCIL_BUFFER_BIT),i&&(o=i),r.clear(o)}},unbind:function(e){this._super(e),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)}}),TargetTextureFloat=TargetTexture.extend({init:function(e,t,n,i){if(t.isWebGL2()){if(this.extColorFloat=t.gl.getExtension("EXT_color_buffer_float"),!this.extColorFloat)throw"TargetTextureFloat: Floating point COLOR textures are not supported on this system."}else{if(this.extHalfFloat=t.gl.getExtension("OES_texture_half_float"),this.extFloat=t.gl.getExtension("OES_texture_float"),!this.extFloat&&!this.extHalfFloat)throw"TargetTextureFloat: Floating point textures are not supported on this system.";this.linearFloat=null,this.linearHalf=null,i||(this.linearFloat=t.gl.getExtension("OES_texture_float_linear"),this.linearHalf=t.gl.getExtension("OES_texture_half_float_linear"))}this._super(e,t,n)},type:function(){return"TargetTextureFloat"},getDataType:function(e){if(e.isWebGL2())return e.gl.FLOAT;if(this.extHalfFloat){if(!this.extFloat)return this.extHalfFloat.HALF_FLOAT_OES;if(navigator)switch(navigator.platform){case"iPad":case"iPod":case"iPhone":return this.extHalfFloat.HALF_FLOAT_OES}}return e.gl.FLOAT},getInternalFormat:function(e){return e.isWebGL2()?e.gl.RGBA16F:e.gl.RGBA},getTextureFilter:function(e){return this.linearFloat&&this.linearHalf?e.gl.LINEAR:e.gl.NEAREST},build:function(e){var t=e.gl;this.frameBuffer=t.createFramebuffer(),this.texture||(this.texture=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.texture.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),t.texImage2D(t.TEXTURE_2D,0,this.getInternalFormat(e),this.size[0],this.size[1],0,t.RGBA,this.getDataType(e),null),t.bindTexture(t.TEXTURE_2D,null)),this.useDepthTexture?(this.depth=new Texture(e),t.bindTexture(t.TEXTURE_2D,this.depth.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT,this.size[0],this.size[1],0,t.DEPTH_COMPONENT,t.UNSIGNED_SHORT,null),t.bindTexture(t.TEXTURE_2D,null)):(this.depth=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.depth),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.size[0],this.size[1]),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture.glTexture,0),this.useDepthTexture?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depth.glTexture,0):t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depth),this.checkStatus(e),t.bindFramebuffer(t.FRAMEBUFFER,null),this.texture.loaded=!0}}),TargetTextureMulti=RenderTarget.extend({init:function(e,t,n){if(this.options=FRAK.extend({dataType:"float",filtering:"linear",depth:!1,stencil:!1,numTargets:2},n),this.extDrawBuffers=null,this.extTextureFloat=null,this.extTextureHalfFloat=null,this.extTextureFloatLinear=null,this.extTextureHalfFloatLinear=null,this.options.numTargets<1)throw"TargetTextureMulti: Must have at least one color target.";if(!e.isWebGL2()&&(this.extDrawBuffers=e.gl.getExtension("WEBGL_draw_buffers"),!this.extDrawBuffers))throw"TargetTextureMulti: WEBGL_draw_buffers not available.";if(this.options.depth&&!e.isWebGL2()){var i=e.gl.getExtension("WEBGL_depth_texture")||e.gl.depthTextureExt;if(i||(i=e.gl.getExtension("WEBKIT_WEBGL_depth_texture")),!i)throw"TargetTextureMulti: Depth texture reqeusted, but not available."}if(e.isWebGL2()?(this.maxColorAttachments=e.gl.getParameter(e.gl.MAX_COLOR_ATTACHMENTS),this.maxDrawBuffers=e.gl.getParameter(e.gl.MAX_DRAW_BUFFERS)):(this.maxColorAttachments=e.gl.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_WEBGL),this.maxDrawBuffers=e.gl.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_WEBGL)),this.options.numTargets>this.maxDrawBuffers)throw"TargetTextureMulti: Too many targets requested. System only supports {0} draw buffers.".format(this.maxDrawBuffers);if("float"==this.options.dataType&&!e.isWebGL2()){if(this.extTextureFloat=e.gl.getExtension("OES_texture_float"),this.extTextureHalfFloat=e.gl.getExtension("OES_texture_half_float"),!this.extTextureFloat&&!this.extTextureHalfFloat)throw"TargetTextureMulti: Floating point textures are not supported on this system.";if("linear"==this.options.filtering&&(this.extTextureFloatLinear=e.gl.getExtension("OES_texture_float_linear"),this.extTextureHalfFloatLinear=e.gl.getExtension("OES_texture_half_float_linear"),!this.extTextureFloatLinear&&!this.extTextureHalfFloatLinear))throw"TargetTextureMulti: Linear filtering requested, but not available."}this._super(t),this.targets=[],this.depth=null,this.frameBuffer=null,this.build(e)},type:function(){return"TargetTextureMulti"},setSize:function(e,t){this._super(e,t),this.rebuild=!0},getDataType:function(e){if("unsigned"==this.options.dataType)return e.gl.UNSIGNED_BYTE;if(e.isWebGL2())return e.gl.FLOAT;if(this.extTextureHalfFloat){if(!this.extTextureFloat)return this.extTextureHalfFloat.HALF_FLOAT_OES;if(navigator&&navigator.platform)switch(navigator.platform){case"iPad":case"iPod":case"iPhone":return this.extTextureHalfFloat.HALF_FLOAT_OES;default:return e.gl.FLOAT}}return e.gl.FLOAT},getInternalFormat:function(e){return e.isWebGL2()&&"float"==this.options.dataType?e.gl.RGBA16F:e.gl.RGBA},getTextureFilter:function(e){return"float"==this.options.dataType&&(e.isWebGL2()||this.extTextureFloatLinear||this.extTextureHalfFloatLinear)?e.gl.LINEAR:e.gl.NEAREST},createBuffer:function(e,t,n,i){var r=e.gl,o=new Texture(e);return t||(t=this.getTextureFilter(e)),n||(n=this.getDataType(e)),i||(i=r.RGBA),r.bindTexture(r.TEXTURE_2D,o.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,t),r.texImage2D(r.TEXTURE_2D,0,this.getInternalFormat(e),this.size[0],this.size[1],0,i,n,null),r.bindTexture(r.TEXTURE_2D,null),o.loaded=!0,o},build:function(e){var t,n=e.gl;this.frameBuffer=n.createFramebuffer(),this.options.depth?this.depth=this.createBuffer(e,n.NEAREST,n.UNSIGNED_SHORT,n.DEPTH_COMPONENT):(this.depth=n.createRenderbuffer(),n.bindRenderbuffer(n.RENDERBUFFER,this.depth),this.options.stencil?n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,this.size[0],this.size[1]):n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,this.size[0],this.size[1]),n.bindRenderbuffer(n.RENDERBUFFER,null));var i=[],r=e.isWebGL2()?e.gl.COLOR_ATTACHMENT0:this.extDrawBuffers.COLOR_ATTACHMENT0_WEBGL;for(t=0;t<this.options.numTargets;++t){var o=this.createBuffer(e);this.targets.push(o),i.push(r+t)}for(n.bindFramebuffer(n.FRAMEBUFFER,this.frameBuffer),this.options.depth?n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_2D,this.depth.glTexture,0):this.options.stencil?n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,this.depth):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,this.depth),t=0;t<this.targets.length;++t)n.framebufferTexture2D(n.FRAMEBUFFER,r+t,n.TEXTURE_2D,this.targets[t].glTexture,0);this.checkStatus(e),e.isWebGL2()?n.drawBuffers(i):this.extDrawBuffers.drawBuffersWEBGL(i),n.bindFramebuffer(n.FRAMEBUFFER,null)},checkStatus:function(e){var t=e.gl,n=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(n){case t.FRAMEBUFFER_COMPLETE:return!0;case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"TargetTextureMulti: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"TargetTextureMulti: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"TargetTextureMulti: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case t.FRAMEBUFFER_UNSUPPORTED:throw"TargetTextureMulti: Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"TargetTextureMulti: Incomplete framebuffer: "+n}},bind:function(e,t,n,i){var r=e.gl;if(this.rebuild){this.rebuild=!1;for(var o=0;o<this.targets.length;o++){var a=this.targets[o];r.bindTexture(r.TEXTURE_2D,a.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.getTextureFilter(e)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.getTextureFilter(e)),r.texImage2D(r.TEXTURE_2D,0,this.getInternalFormat(e),this.size[0],this.size[1],0,r.RGBA,this.getDataType(e),null),r.bindTexture(r.TEXTURE_2D,null)}this.options.depth?(r.bindTexture(r.TEXTURE_2D,this.depth.glTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texImage2D(r.TEXTURE_2D,0,r.DEPTH_COMPONENT,this.size[0],this.size[1],0,r.DEPTH_COMPONENT,r.UNSIGNED_SHORT,null),r.bindTexture(r.TEXTURE_2D,null)):(r.bindRenderbuffer(r.RENDERBUFFER,this.depth),this.options.stencil?r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,this.size[0],this.size[1]):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.size[0],this.size[1]),r.bindRenderbuffer(r.RENDERBUFFER,null))}if(t=!0===t,(n=n instanceof Color&&n)||(e.camera?n=e.camera.backgroundColor:t=!0),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),this._super(e),!t){r.clearColor(n.r,n.g,n.b,n.a),r.clearDepth(1);var s=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;this.options.stencil&&(r.clearStencil(0),s|=r.STENCIL_BUFFER_BIT),i&&(s=i),r.clear(s)}},unbind:function(e){this._super(e),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null)}}),RenderBuffer=FrakClass.extend({init:function(e,t,n){n||(n=e.gl.STATIC_DRAW),this.type=n,this.context=e,this.debug=!1,this.buffers={};for(var i=this.maxFaceIndex=0;i<t.length;i++)this.maxFaceIndex=t[i]>this.maxFaceIndex?t[i]:this.maxFaceIndex;this.createFacesBuffer(t)},has:function(e){return e in this.buffers},add:function(e,t,n){if(t.length/n<=this.maxFaceIndex)throw"RenderBuffer: Buffer '{0}' too small ({1} vertices, {2} max index).".format(e,t.length/n,this.maxFaceIndex);var i=this.context.gl;t instanceof Float32Array||(t=new Float32Array(t)),this.buffers[e]=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.buffers[e]),i.bufferData(i.ARRAY_BUFFER,t,this.type),this.buffers[e].itemSize=n,this.buffers[e].numItems=t.length/this.buffers[e].itemSize,i.bindBuffer(i.ARRAY_BUFFER,null)},update:function(e,t){if(!(e in this.buffers))throw"RenderBuffer: Unknown buffer: '{0}'".format(e);var n=this.buffers[e];if(t.length/n.itemSize<=this.maxFaceIndex)throw"RenderBuffer: Buffer '{0}' too small.".format(e);t instanceof Float32Array||(t=new Float32Array(t));var i=this.context.gl;i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,t,this.type),n.numItems=t.length/n.itemSize,i.bindBuffer(i.ARRAY_BUFFER,null)},updateFaces:function(e){var t=this.context.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.facesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.type),this.facesBuffer.itemSize=1,this.facesBuffer.numItems=e.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null);for(var n=this.maxFaceIndex=0;n<e.length;n++)this.maxFaceIndex=e[n]>this.maxFaceIndex?e[n]:this.maxFaceIndex},render:function(e){if(e.linked){var t=this.context.gl,n=[];for(var i in this.buffers){t.bindBuffer(t.ARRAY_BUFFER,this.buffers[i]);var r=e.getAttribLocation(i);-1!=r&&(t.enableVertexAttribArray(r),n.push(r),t.vertexAttribPointer(r,this.buffers[i].itemSize,t.FLOAT,!1,0,0))}this.drawElements();for(var o=0,a=n.length;o<a;o++)t.disableVertexAttribArray(n[o])}},generateBarycentric:function(){for(var e=new Float32Array(3*this.buffers.position.numItems),t=0;t<e.length;t+=9)e[t+0]=1,e[t+1]=0,e[t+2]=0,e[t+3]=0,e[t+4]=1,e[t+5]=0,e[t+6]=0,e[t+7]=0,e[t+8]=1;this.add("barycentric",e,3)},generateTexCoords:function(){for(var e=new Float32Array(2*this.buffers.position.numItems),t=0;t<e.length;t++)e[t]=0;this.add("texcoord2d0",e,2)},drawElements:function(){},createFacesBuffer:function(e){var t=this.context.gl;this.facesBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.facesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.type),this.facesBuffer.itemSize=1,this.facesBuffer.numItems=e.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}}),LinesRenderBuffer=RenderBuffer.extend({init:function(e){this._super(e,[],e.gl.DYNAMIC_DRAW)},drawElements:function(){var e=this.context.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.facesBuffer),e.drawElements(e.LINES,this.facesBuffer.numItems,e.UNSIGNED_SHORT,0)}}),TrianglesRenderBuffer=RenderBuffer.extend({init:function(e,t,n){this._super(e,t,n)},drawElements:function(){var e=this.context.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.facesBuffer),e.drawElements(e.TRIANGLES,this.facesBuffer.numItems,e.UNSIGNED_SHORT,0)}}),RenderBufferVAO=RenderBuffer.extend({init:function(e,t,n){if(e.isWebGL2())this.createVAO=e.gl.createVertexArray.bind(e.gl),this.bindVAO=e.gl.bindVertexArray.bind(e.gl);else{var i=e.gl.getExtension("OES_vertex_array_object");if(!i)throw"RenderBufferVAO: Vertex array objects not supported on this device.";this.createVAO=i.createVertexArrayOES.bind(i),this.bindVAO=i.bindVertexArrayOES.bind(i)}if(this.vao=this.createVAO(),!this.vao)throw"RenderBufferVAO: Unable to create vertex array object.";this.damaged=!0,this._super(e,t,n)},add:function(e,t,n){if(t.length/n<=this.maxFaceIndex)throw"RenderBuffer: Buffer '{0}' too small.".format(e);this.bindVAO(this.vao),this._super(e,t,n),this.bindVAO(null),this.damaged=!0},createFacesBuffer:function(e){var t=this.context.gl;this.bindVAO(this.vao),this._super(e),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.facesBuffer),this.bindVAO(null),this.damaged=!0},bindLocations:function(e){var t,n=this.context.gl;for(var i in this.bindVAO(this.vao),this.buffers)t=-1,i in ExplicitAttributeLocations?t=ExplicitAttributeLocations[i]:e&&(t=e.getAttribLocation(i)),-1!=t&&(n.bindBuffer(n.ARRAY_BUFFER,this.buffers[i]),n.enableVertexAttribArray(t),n.vertexAttribPointer(t,this.buffers[i].itemSize,n.FLOAT,!1,0,0));n.bindBuffer(n.ARRAY_BUFFER,null),this.bindVAO(null),this.damaged=!1},render:function(e){e.linked&&(this.damaged&&this.bindLocations(),this.bindVAO(this.vao),this.drawElements(),this.bindVAO(null))}}),TrianglesRenderBufferVAO=RenderBufferVAO.extend({init:function(e,t,n){this._super(e,t,n)},drawElements:function(){var e=this.context.gl;e.drawElements(e.TRIANGLES,this.facesBuffer.numItems,e.UNSIGNED_SHORT,0)}}),QuadsRenderBuffer=TrianglesRenderBuffer.extend({init:function(e,t,n){for(var i=[],r=0;r<t.length-3;r++)i.push(t[r]),i.push(t[r+1]),i.push(t[r+2]),i.push(t[r]),i.push(t[r+2]),i.push(t[r+3]);this._super(e,i,n)}}),BaseTexture=Serializable.extend({init:function(e){this._super(),this.size=vec2.create(),this.loaded=!1},type:function(){return"BaseTexture"},excluded:function(){return this._super().concat(["loaded","size"])},bind:function(e){},unbind:function(e){},resizeToPowerOfTwo:function(e){function t(e){return 0==(e&e-1)}function n(e){return Math.max(Math.min(Math.pow(2,Math.floor(Math.log(e)/Math.log(2))),2048),1)}if(!t(e.width)||!t(e.height)){var i=document.createElement("canvas");i.width=n(e.width),i.height=n(e.height),i.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height),e=i}return e},anisotropy:function(e){if(e.engine&&(e.engine.options.anisotropicFiltering?this.anisotropyFilter=e.engine.options.anisotropicFiltering:this.anisotropic=!1),this.anisotropic)if(this.extTextureFilterAnisotropic=e.gl.getExtension("EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic){var t=e.gl.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.anisotropyFilter=Math.min(this.anisotropyFilter,t)}else this.anisotropic=!1}}),Texture=BaseTexture.extend({init:function(e){this._super(e),this.glTexture=null,this.name=!1,this.mipmapped=!0,this.clampToEdge=!1,this.anisotropic=!0,this.anisotropyFilter=4,this.image=null,e&&this.create(e)},type:function(){return"Texture"},excluded:function(){return this._super().concat(["glTexture"])},bind:function(e){this.loaded?e.gl.bindTexture(e.gl.TEXTURE_2D,this.glTexture):e.gl.bindTexture(e.gl.TEXTURE_2D,null)},unbind:function(e){e.gl.bindTexture(e.gl.TEXTURE_2D,null)},create:function(e){this.anisotropy(e),this.glTexture=e.gl.createTexture()},clearImage:function(e,t,n){null===this.glTexture&&this.create(e),n=n||1;var i=e.gl;i.bindTexture(e.gl.TEXTURE_2D,this.glTexture);for(var r=new Uint8Array(n*n*4),o=0;o<n*n*4;o+=4)r[o+0]=t[0],r[o+1]=t[1],r[o+2]=t[2],r[o+3]=t[3];i.texImage2D(i.TEXTURE_2D,0,i.RGBA,n,n,0,i.RGBA,i.UNSIGNED_BYTE,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.bindTexture(e.gl.TEXTURE_2D,null),vec2.set(this.size,n,n),this.loaded=!0},pasteImage:function(e,t,n){if(this.loaded){this.bind(e);var i=e.gl;i.texSubImage2D(i.TEXTURE_2D,0,t[0]*this.size[0],t[1]*this.size[1],i.RGBA,i.UNSIGNED_BYTE,n),this.mipmapped&&i.generateMipmap(i.TEXTURE_2D),this.unbind(e),this.loaded=!0}},setImage:function(e,t,n){if(this.glTexture||this.create(e),!this.glTexture)throw"Unable to update texture. glTexture not available.";var i=t;n||(i=this.resizeToPowerOfTwo(t)),vec2.set(this.size,i.width,i.height);var r=e.gl;r.bindTexture(r.TEXTURE_2D,this.glTexture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,i),this.clampToEdge&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE)),this.mipmapped?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_NEAREST),r.generateMipmap(r.TEXTURE_2D),this.anisotropic&&r.texParameteri(r.TEXTURE_2D,this.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropyFilter)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST)),r.bindTexture(r.TEXTURE_2D,null),this.image=i,this.loaded=!0,0==(this.size[0]&this.size[0]-1)&&0==(this.size[1]&this.size[1]-1)||console.warn("Created a not power of 2 texture: {0} ({1}x{2})".format(this.name,this.size[0],this.size[1]))},getImage:function(e){if(!this.glTexture)throw"Unable to get image. glTexture not available.";var t=e.gl,n=new TargetTexture(this,e,!1);n.bind(e);var i=new Uint8Array(this.size[0]*this.size[1]*4);return e.gl.readPixels(0,0,this.size[0],this.size[1],t.RGBA,t.UNSIGNED_BYTE,i),n.unbind(e),i},onContextRestored:function(e){this.glTexture=null,this.loaded=!1,this.image&&this.setImage(e,this.image)}}),CubeTexture=BaseTexture.extend({init:function(e){this._super(e),this.glTexture=null,this.name=!1,this.mipmapped=!1,this.clampToEdge=!0,this.anisotropic=!0,this.anisotropyFilter=4,this.images={},e&&this.create(e)},type:function(){return"CubeTexture"},excluded:function(){return this._super().concat(["glTexture"])},bind:function(e){this.loaded?e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,this.glTexture):e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,null)},unbind:function(e){e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,null)},getGLCubeFace:function(e,t){var n=e.gl;switch(t){case CubeTexture.FRONT:return n.TEXTURE_CUBE_MAP_NEGATIVE_X;case CubeTexture.BACK:return n.TEXTURE_CUBE_MAP_POSITIVE_X;case CubeTexture.LEFT:return n.TEXTURE_CUBE_MAP_NEGATIVE_Z;case CubeTexture.RIGHT:return n.TEXTURE_CUBE_MAP_POSITIVE_Z;case CubeTexture.TOP:return n.TEXTURE_CUBE_MAP_NEGATIVE_Y;case CubeTexture.BOTTOM:return n.TEXTURE_CUBE_MAP_POSITIVE_Y}return null},create:function(e){this.anisotropy(e),this.glTexture=e.gl.createTexture();var t=e.gl;t.bindTexture(t.TEXTURE_CUBE_MAP,this.glTexture),this.clampToEdge&&(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),this.mipmapped?(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_CUBE_MAP),this.anisotropic&&t.texParameteri(t.TEXTURE_CUBE_MAP,this.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropyFilter)):(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.NEAREST)),t.bindTexture(t.TEXTURE_CUBE_MAP,null)},setFace:function(e,t,n,i){if(!1===this.glTexture&&this.create(e),!this.glTexture)throw"Unable to update cube texture. glTexture not available.";var r=n;if(t in this.images&&delete this.images[t].image,this.images[t]={image:r,noResize:!!i},!(t=this.getGLCubeFace(e,t)))throw"Not a valid CubeTexture face.";i||(r=this.resizeToPowerOfTwo(n)),vec2.set(this.size,r.width,r.height);var o=e.gl;o.bindTexture(o.TEXTURE_CUBE_MAP,this.glTexture),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),o.texImage2D(t,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,r),o.bindTexture(o.TEXTURE_CUBE_MAP,null),this.loaded=!0,0==(this.size[0]&this.size[0]-1)&&0==(this.size[1]&this.size[1]-1)||console.warn("Created a not power of 2 texture: {0} ({1}x{2})".format(this.name,this.size[0],this.size[1]))},onContextRestored:function(e){for(var t in this.glTexture=null,this.create(e),this.loaded=!1,this.images){var n=this.images[t];this.setFace(e,parseInt(t),n.image,n.noResize)}}});CubeTexture.FRONT=0,CubeTexture.BACK=1,CubeTexture.LEFT=2,CubeTexture.RIGHT=3,CubeTexture.BOTTOM=4,CubeTexture.TOP=5;var Material=Serializable.extend({init:function(e,t,n,i,r){this._super(),this.name=i,this.name||(this.name="unnamed_"+Math.round(Math.random()*Math.pow(36,12)).toString(36)),this.shader=e,this.uniforms=t,this.samplers=n,this.descriptor=r,this.boundSamplers=new SamplerAccumulator},type:function(){return"Material"},bind:function(e){if(this.shader){var t;this.shader.use(this.uniforms),e&&this.shader.bindUniforms(e);for(var n=1,i=arguments.length;n<i;++n)if((t=arguments[n])instanceof Sampler)this.boundSamplers.add(t);else if(t instanceof Array)for(var r=0,o=t.length;r<o;++r)this.boundSamplers.add(t[r]);n=0;for(var a=this.samplers.length;n<a;++n)this.boundSamplers.add(this.samplers[n]);0==this.boundSamplers.length&&this.shader.context.engine&&this.boundSamplers.add(this.shader.context.engine.DiffuseFallbackSampler),this.shader.bindSamplers(this.boundSamplers.samplers)}},unbind:function(){this.shader&&(this.shader.unbindSamplers(this.boundSamplers.samplers),this.boundSamplers.clear())},instantiate:function(){var e={};for(var t in this.uniforms)e[t]=this.uniforms[t].clone();var n=[];for(var t in this.samplers)"object"==typeof this.samplers[t]&&n.push(this.samplers[t].clone());var i=new Material(this.shader,e,n,this.descriptor);return i.name=this.name+" (instance)",i}}),Space=FrakClass.extend({init:function(){},frustumCast:function(e,t){},rayCast:function(e){},lineCast:function(e){}}),DynamicSpace=Space.extend({init:function(){this.renderers=[],this.colliders=[],this.filteredRenderers=[]},addRenderer:function(e){this.renderers.push(e),this.filteredRenderers.push(null)},removeRenderer:function(e){for(var t=0;t<this.renderers.length;t++)if(this.renderers[t]===e)return this.renderers.splice(t,1),this.filteredRenderers.pop(),!0;return!1},addCollider:function(e){this.colliders.push(e)},removeCollider:function(e){for(var t=0;t<this.colliders.length;t++)if(this.colliders[t]===e)return this.colliders.splice(t,1),!0;return!1},frustumCast:function(e,t){for(var n,i=0,r=0;r<this.renderers.length;++r)(n=this.renderers[r]).visible&&n.layer&t&&(this.filteredRenderers[i++]=n);for(r=i;r<this.filteredRenderers.length;++r)this.filteredRenderers[r]=null;return this.filteredRenderers},rayCast:function(e,t,n){var i=new RayTestResult(e);if(!t)return i;for(var r=0;r<this.colliders.length;r++)this.colliders[r].enabled&&this.colliders[r].node.layer&t&&this.colliders[r].rayTest(e,i,n);return i}}),Renderer=FrakClass.extend({init:function(e){this.matrix=e,this.layer=1,this.visible=!0,this.castShadows=!0,this.receiveShadows=!0,this.lightContribution=1,this.reflectivity=0,this.transparent=!1,this.localBoundingBox=new BoundingBox,this.localBoundingSphere=new BoundingSphere,this.globalBoundingBox=new BoundingBox,this.globalBoundingSphere=new BoundingSphere},render:function(e,t){this.onRender(e,t)},renderGeometry:function(e,t){this.onRenderGeometry(e,t)},getDefaultUniforms:function(e,t){return"object"==typeof t&&null!==t||(t={}),t.hasOwnProperty("model")?mat4.copy(t.model.value,this.matrix):t.model=new UniformMat4(this.matrix),t.hasOwnProperty("modelview")?mat4.copy(t.modelview.value,e.modelview.top()):t.modelview=new UniformMat4(e.modelview.top()),t.hasOwnProperty("projection")?mat4.copy(t.projection.value,e.projection.top()):t.projection=new UniformMat4(e.projection.top()),t.hasOwnProperty("receiveShadows")?t.receiveShadows.value=this.receiveShadows?1:0:t.receiveShadows=new UniformInt(this.receiveShadows?1:0),t.hasOwnProperty("lightContribution")?t.lightContribution.value=this.lightContribution:t.lightContribution=new UniformFloat(this.lightContribution),t.hasOwnProperty("reflectivity")?t.reflectivity.value=this.reflectivity:t.reflectivity=new UniformFloat(this.reflectivity),e.camera&&(t.hasOwnProperty("view")?mat4.copy(t.view.value,e.camera.viewMatrix):t.view=new UniformMat4(e.camera.viewMatrix),t.hasOwnProperty("viewInverse")?mat4.copy(t.viewInverse.value,e.camera.viewInverseMatrix):t.viewInverse=new UniformMat4(e.camera.viewInverseMatrix),e.camera.near&&(t.hasOwnProperty("zNear")?t.zNear.value=e.camera.near:t.zNear=new UniformFloat(e.camera.near)),e.camera.far&&(t.hasOwnProperty("zFar")?t.zFar.value=e.camera.far:t.zFar=new UniformFloat(e.camera.far))),e.light&&e.light.uniforms&&(t.lightDirection=e.light.uniforms.lightDirection,t.lightColor=e.light.uniforms.lightColor,t.lightIntensity=e.light.uniforms.lightIntensity,t.useShadows=e.light.uniforms.useShadows),e.shadow&&(t.lightView=e.shadow.lightView,t.lightProjection=e.shadow.lightProjection),t},getGlobalSamplers:function(e){var t=[];return e.shadow&&t.push(e.shadow.shadow0),t},setMatrix:function(e){this.matrix=e,this.updateGlobalBoundingVolumes()},updateGlobalBoundingVolumes:function(){this.localBoundingBox.transform(this.matrix,this.globalBoundingBox),this.localBoundingSphere.transform(this.matrix,this.globalBoundingSphere)},onRender:function(e,t){},onRenderGeometry:function(e,t){}}),PrimitiveRenderer=Renderer.extend({init:function(e,t){this._super(e),this.material=t}}),MeshRenderer=Renderer.extend({init:function(e,t,n){for(var i in this._super(t),this.mesh=n,this.buffers=[],this._cache=null,this.mesh.submeshes){var r=this.mesh.submeshes[i],o=new TrianglesRenderBuffer(e,r.faces);for(var a in o.add("position",r.positions,3),r.texCoords1D)o.add("texcoord1d"+a,r.texCoords1D[a],1);for(var s in r.texCoords2D)o.add("texcoord2d"+s,r.texCoords2D[s],2);for(var l in r.texCoords3D)o.add("texcoord3d"+l,r.texCoords3D[l],3);r.normals&&o.add("normal",r.normals,3),r.tangents&&o.add("tangent",r.tangents,3),r.bitangents&&o.add("bitangent",r.bitangents,3),this.buffers.push(o)}},onRender:function(e){for(var t in this._cache=this.getDefaultUniforms(e,this._cache),this.mesh.submeshes){var n=this.mesh.submeshes[t],i=this.mesh.getMaterial(n.materialIndex);i&&(i.bind(this._cache),this.buffers[t].render(i.shader),i.unbind())}},onRenderGeometry:function(e,t){for(var n in this._cache=this.getDefaultUniforms(e,this._cache),t.bindUniforms(this._cache),this.buffers)this.buffers[n].render(t)}}),LineRenderer=Renderer.extend({init:function(e,t,n){this._super(t),this.material=n,this.buffer=new LinesRenderBuffer(e)},onRender:function(e){this.buffer.render(this.material.shader)},onRenderGeometry:function(e,t){this._cache=this.getDefaultUniforms(e,this._cache),t.bindUniforms(this._cache),this.buffer.render(t)}}),SubmeshRenderer=Renderer.extend({init:function(e,t,n,i){this._super(t),this.submesh=n,this.material=i,this.buffer=[],this.failed=!1,this.transparent=!1,this.localBoundingBox=this.submesh.boundingBox,this.localBoundingSphere=this.submesh.boundingSphere,this.updateGlobalBoundingVolumes(),this.build(e),this._cache=null},allocBuffer:function(t){if(!this.submesh)throw Error("SubmeshRenderer.allocBuffer: No submesh set");if(t.engine&&(!0===t.engine.options.useVAO||t.isWebGL2()))try{this.buffer=new TrianglesRenderBufferVAO(t,this.submesh.faces)}catch(e){this.buffer=new TrianglesRenderBuffer(t,this.submesh.faces)}else this.buffer=new TrianglesRenderBuffer(t,this.submesh.faces)},build:function(e){this.buffer&&delete this.buffer,this.allocBuffer(e);var t=this.submesh;this.buffer.add("position",t.positions,3);var n=t.positions.length/3;if(t.texCoords1D)for(var i=0;i<t.texCoords1D.length;++i)t.texCoords1D[i].length==n?this.buffer.add("texcoord1d"+i,t.texCoords1D[i],1):console.warn("Wrong number of 1D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords1D[i].length,n));if(t.texCoords2D)for(i=0;i<t.texCoords2D.length;++i)t.texCoords2D[i].length/2==n?this.buffer.add("texcoord2d"+i,t.texCoords2D[i],2):console.warn("Wrong number of 2D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords2D[i].length/2,n));if(t.texCoords3D)for(i=0;i<t.texCoords3D.length;++i)t.texCoords3D[i].length/3==n?this.buffer.add("texcoord3d"+i,t.texCoords3D[i],3):console.warn("Wrong number of 3D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords3D[i].length/3,n));if(t.texCoords4D)for(i=0;i<t.texCoords4D.length;++i)t.texCoords4D[i].length/4==n?this.buffer.add("texcoord4d"+i,t.texCoords4D[i],4):console.warn("Wrong number of 4D texture coordinates ({0}). Must be the same as positions ({1}).".format(t.texCoords4D[i].length/4,n));t.normals&&(t.positions.length!=t.normals.length?console.warn("Wrong number of normals. Must be the same as positions."):this.buffer.add("normal",t.normals,3)),t.tangents&&(t.positions.length!=t.tangents.length?console.warn("Wrong number of tangents. Must be the same as positions."):this.buffer.add("tangent",t.tangents,3)),t.bitangents&&(t.positions.length!=t.bitangents.length?console.warn("Wrong number of bitangents. Must be the same as positions."):this.buffer.add("bitangent",t.bitangents,3)),t.barycentric&&(t.positions.length!=t.barycentric.length?console.warn("Wrong number of barycentric coordinates. Must be the same as positions."):this.buffer.add("barycentric",t.barycentric,3));var r=this.material;r.uniforms.diffuse||(r.uniforms.diffuse=new UniformColor(new Color(1,1,1,1))),r.uniforms.ambient||(r.uniforms.ambient=new UniformColor(new Color(.2,.2,.2,1))),r.uniforms.specularStrength||(r.uniforms.specularStrength=new UniformFloat(0)),r.uniforms.specularPower||(r.uniforms.specularPower=new UniformInt(8)),this.transparent=r.shader.requirements.transparent||r.uniforms.diffuse&&r.uniforms.diffuse.value[3]<1||r.uniforms.ambient&&r.uniforms.ambient.value[3]<1,this.failed=!1},onRender:function(e){this.buffer.render(this.material.shader)},onRenderGeometry:function(e,t){this._cache=this.getDefaultUniforms(e,this._cache),t.bindUniforms(this._cache),this.buffer.render(t)},onContextRestored:function(e){this.build(e)}}),CubeRenderer=PrimitiveRenderer.extend({init:function(e,t,n,i){this._super(t,i),this.size=n;var r=this.size/2,o=[-r,-r,r,r,-r,r,r,-r,-r,-r,-r,-r,-r,r,r,r,r,r,r,r,-r,-r,r,-r];this.renderBuffer=new QuadsRenderBuffer(e,[0,1,2,3,4,5,6,7,0,1,5,4,1,2,6,5,2,3,7,6,3,0,0,7]),this.renderBuffer.add("position",o,3)},onRender:function(e){this.material.bind({modelview:new UniformMat4(e.modelview.top()),projection:new UniformMat4(e.projection.top())}),this.renderBuffer.render(this.material.shader),this.material.unbind()}});function DownloadBinary(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){200==this.status?t(this.response):t(!1)},n.send()}var DataParserTypes={NODE_ROOT:4096,NODE_STRING:4097,NODE_MATRIX3X3:4098,NODE_MATRIX4X4:4099,NODE_MATERIALS:8192,NODE_MATERIAL:8193,NODE_COLOR_AMBIENT:8194,NODE_COLOR_DIFFUSE:8195,NODE_COLOR_SPECULAR:8196,NODE_COLOR_EMISSIVE:8197,NODE_TWOSIDED:8198,NODE_SHININESS:8199,NODE_SHININESS_STRENGTH:8200,NODE_TEXTURES_AMBIENT:8272,NODE_TEXTURES_DIFFUSE:8273,NODE_TEXTURES_SPECULAR:8274,NODE_TEXTURES_EMISSIVE:8275,NODE_TEXTURES_NORMALS:8276,NODE_TEXTURES_HEIGHT:8277,NODE_TEXTURES_SHININESS:8278,NODE_TEXTURES_OPACITY:8279,NODE_TEXTURES_DISPLACEMENT:8280,NODE_TEXTURES_LIGHTMAP:8281,NODE_TEXTURES_REFLECTION:8282,NODE_TEXTURE:8448,NODE_TEXTURE_SCALE:8449,NODE_SHADER_NAME:8704,NODE_GEOMETRY:12288,NODE_MESH:12544,NODE_MATERIAL_REFERENCE:12545,NODE_VERTICES:12546,NODE_NORMALS:12547,NODE_TANGENTS:12548,NODE_BITANGENTS:12549,NODE_TEXTURE_COORDINATES:12550,NODE_FACES:12551,NODE_SCENE:16384,NODE_GROUP:16385,NODE_MESH_REFERENCE:16386,NODE_TRANSFORM_POSITION:16387,NODE_TRANSFORM_ROTATION:16388,NODE_TRANSFORM_SCALE:16389,NODE_GROUP_ID:16390,NODE_COLLISION:20480,NODE_COLLISION_NODE:20481,NODE_COLLISION_AABB_CENTER:20482,NODE_COLLISION_AABB_EXTENTS:20483,NODE_COLLISION_FACE_LIST:20484,NODE_FACE_LIST_NODE_ID:20496,NODE_FACE_LIST_MESH_REFERENCE:20497,NODE_FACE_LIST_INDICES:20498,getName:function(e){for(var t in DataParserTypes)if(DataParserTypes[t]===e)return t;return!1}},DataParserNode=function(e,t,n){this.id=e,this.length=t,this.position=n,this.HEADER_LENGTH=8,this.end=function(){return this.position+this.HEADER_LENGTH+this.length}},DataParserResult=FrakClass.extend({init:function(){this.data={meshes:[],materials:[],hierarchy:!1,collision:!1,hierarchyNodesByID:{}}},getData:function(){return this.data},linkReferences:function(){for(var e in this.data.meshes)-1!=this.data.meshes[e].material&&this.data.meshes[e].material in this.data.materials&&(this.data.meshes[e].material=this.data.materials[this.data.meshes[e].material]);if(!1!==this.data.hierarchy){var i=this,r=function(e){for(var t in e.meshes)0<=e.meshes[t]&&e.meshes[t]in i.data.meshes&&(e.meshes[t]=i.data.meshes[e.meshes[t]]);for(var n in e.children)r(e.children[n])};r(this.data.hierarchy)}},createGroup:function(){return{name:"",id:!1,parent:!1,children:[],meshes:[],position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:0},scale:{x:0,y:0,z:0},transform:!1}},mapGroupID:function(e){this.data.hierarchyNodesByID[e.id]=e},setRoot:function(e){this.data.hierarchy=e},createMaterialTexture:function(){return{path:!1,scale:{u:1,v:1,w:1}}},createMaterial:function(){return{name:"",color:{ambient:!1,diffuse:!1,specular:!1,emissive:!1},twosided:!1,shininess:0,shininess_strength:0,shader:!1,textures:{ambient:[],diffuse:[],specular:[],emissive:[],normal:[],height:[],shininess:[],opacity:[],displacement:[],lightmap:[],reflection:[]}}},addMaterial:function(e){this.data.materials.push(e)},getMaterial:function(e){return 0<=e&&e<this.data.materials.length&&this.data.materials[e]},createMesh:function(e){for(var t={index:-1,material:-1,indices:[],vertices:[]},n=0;n<e;n++)t.vertices.push(this.createVertex());return t},createVertex:function(){return{position:{x:0,y:0,z:0},normal:{x:0,y:0,z:0},texCoord:[],tangent:{x:0,y:0,z:0},bitangent:{x:0,y:0,z:0}}},addMesh:function(e){this.data.meshes.push(e),e.index=this.data.meshes.length-1},createCollisionTreeNode:function(){return{parent:!1,children:[],center:{x:0,y:0,z:0},extents:{x:0,y:0,z:0},faces:!1}},addFaceList:function(e,t,n,i){return!(t<0||n<0||0==i.length)&&(!1===e.faces&&(e.faces={}),t in e.faces||(e.faces[t]={}),n in e.faces[t]||(e.faces[t][n]=[]),e.faces[t][n]=e.faces[t][n].concat(i),!0)},setCollisionTreeRoot:function(e){this.data.collision=e}}),DataParser=FrakClass.extend({init:function(e,t,n,i,r){this.VERSION=1,this.view=new jDataView(e),this.onComplete=t,this.onProgress=i,this.onError=n,this.userdata=r,this.result=new DataParserResult,this.errors=[],this.stack=[],this.linkReferences=!0,this.flipX=!1,this.warnOnUnknownChunks=!0,this.isFunction=function(e){return"function"==typeof e}},parse:function(){for(this.push(!1,this.parseHeader);!this.completed();)if(!this.step())return this.isFunction(this.onError)&&this.onError(this.errors,this.userdata),!1;return this.linkReferences&&this.result.linkReferences(),this.isFunction(this.onComplete)&&this.onComplete(this.result.getData(),this.userdata),!0},error:function(e){return this.errors.push(e),!1},errorExpect:function(e,t){return this.error("Expected at least "+e+" byte"+(1<e?"s":"")+' for "'+t+'"')},completed:function(){return this.view.tell()==this.view.byteLength},step:function(){var e=this.getCurrentCall();if(e){var t=e(this.getCurrentNode());return this.isFunction(this.onProgress)&&this.onProgress(this.view.tell()/this.view.byteLength*100,this.userdata),t}return!1},push:function(e,t){this.stack.push({node:e,call:FrakCallback(this,t)})},pop:function(){this.stack.pop()},getCurrentNode:function(){return 0<this.stack.length&&this.stack[this.stack.length-1].node},getCurrentCall:function(){return 0<this.stack.length&&this.stack[this.stack.length-1].call},hasDataFor:function(e){return!(this.view.byteLength<this.view.tell()+e)},hasDataForNode:function(e){return!(this.view.byteLength<e.position+e.length+8)},getUint32:function(){return this.view.getUint32(this.view.tell(),!0)},getFloat32:function(){return this.view.getFloat32(this.view.tell(),!0)},getMatrix4x4:function(){for(var e=[],t=0;t<4;t++)e.push([this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32()]);return e},getColor:function(){return{r:this.view.getFloat32(this.view.tell(),!0),g:this.view.getFloat32(this.view.tell(),!0),b:this.view.getFloat32(this.view.tell(),!0),a:this.view.getFloat32(this.view.tell(),!0)}},parseHeader:function(){if(!this.view)return this.error("No data to parse");if(!this.parseSignature())return!1;var e=this.parseNodeHeader();return!1!==e&&(e.id!==DataParserTypes.NODE_ROOT?this.error("Root node type is incorrect"):(this.push(e,this.parseRoot),!0))},parseSignature:function(){return this.hasDataFor(12)?"3DTECHDATA"!=this.view.getString(10)?this.error("The data is not in 3DTech DATA format"):this.view.getInt16(this.view.tell(),!0)!=this.VERSION?this.error("Incompatible version"):!!this.hasDataFor(8)||this.error("Could not find root node"):this.error("Not enough data for 3DTech DATA format header")},parseNodeHeader:function(){if(!this.hasDataFor(8))return this.error("Not enough data for parsing node header");var e=this.view.tell(),t=this.getUint32(),n=this.getUint32();return new DataParserNode(t,n,e)},skipNode:function(e){this.warnOnUnknownChunks&&console.warn("DataParser: skipping node ",DataParserTypes.getName(e.id)),this.view.seek(this.view.tell()+e.length)},parseMaterial:function(e){for(var t=this.result.createMaterial();this.view.tell()<e.end();){var n=this.parseNodeHeader();switch(n.id){case DataParserTypes.NODE_STRING:t.name=this.view.getString(n.length);break;case DataParserTypes.NODE_SHADER_NAME:t.shader=this.view.getString(n.length);break;case DataParserTypes.NODE_COLOR_AMBIENT:if(16!=n.length)return this.error("Ambient color corrupted");t.color.ambient=this.getColor();break;case DataParserTypes.NODE_COLOR_DIFFUSE:if(16!=n.length)return this.error("Diffuse color corrupted");t.color.diffuse=this.getColor();break;case DataParserTypes.NODE_COLOR_SPECULAR:if(16!=n.length)return this.error("Specular color corrupted");t.color.specular=this.getColor();break;case DataParserTypes.NODE_COLOR_EMISSIVE:if(16!=n.length)return this.error("Emissive color corrupted");t.color.emissive=this.getColor();break;case DataParserTypes.NODE_TWOSIDED:if(n.length<1)return this.errorExpect(1,"material.twosided");var i=this.view.getChar();t.twosided=255==i;break;case DataParserTypes.NODE_SHININESS:if(n.length<4)return this.errorExpect(4,"material.shininess");t.shininess=this.getFloat32();break;case DataParserTypes.NODE_SHININESS_STRENGTH:if(n.length<4)return this.errorExpect(4,"material.shininess_strength");t.shininess_strength=this.getFloat32();break;case DataParserTypes.NODE_TEXTURES_AMBIENT:this.parseMaterialTextures(n,t.textures.ambient);break;case DataParserTypes.NODE_TEXTURES_DIFFUSE:this.parseMaterialTextures(n,t.textures.diffuse);break;case DataParserTypes.NODE_TEXTURES_SPECULAR:this.parseMaterialTextures(n,t.textures.specular);break;case DataParserTypes.NODE_TEXTURES_EMISSIVE:this.parseMaterialTextures(n,t.textures.emissive);break;case DataParserTypes.NODE_TEXTURES_NORMALS:this.parseMaterialTextures(n,t.textures.normal);break;case DataParserTypes.NODE_TEXTURES_HEIGHT:this.parseMaterialTextures(n,t.textures.height);break;case DataParserTypes.NODE_TEXTURES_SHININESS:this.parseMaterialTextures(n,t.textures.shininess);break;case DataParserTypes.NODE_TEXTURES_OPACITY:this.parseMaterialTextures(n,t.textures.opacity);break;case DataParserTypes.NODE_TEXTURES_DISPLACEMENT:this.parseMaterialTextures(n,t.textures.displacement);break;case DataParserTypes.NODE_TEXTURES_LIGHTMAP:this.parseMaterialTextures(n,t.textures.lightmap);break;case DataParserTypes.NODE_TEXTURES_REFLECTION:this.parseMaterialTextures(n,t.textures.reflection);break;default:this.skipNode(n)}}return this.result.addMaterial(t),!0},parseMaterialTextures:function(e,t){for(;this.view.tell()<e.end();){var n=this.parseNodeHeader();if(n.id==DataParserTypes.NODE_TEXTURE){for(var i=this.result.createMaterialTexture();this.view.tell()<n.end();){var r=this.parseNodeHeader();switch(r.id){case DataParserTypes.NODE_STRING:i.path=this.view.getString(r.length);break;case DataParserTypes.NODE_TEXTURE_SCALE:if(12!=r.length)return this.error("Texture scale is corrupted");i.scale.u=this.getFloat32(),i.scale.v=this.getFloat32(),i.scale.w=this.getFloat32();break;default:this.skipNode(r)}}!1!==i.path&&t.push(i)}else this.skipNode(n)}return!0},parseMaterials:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(;this.view.tell()<e.end();){var t=this.parseNodeHeader();t.id==DataParserTypes.NODE_MATERIAL?this.parseMaterial(t):this.skipNode(t)}return this.pop(),!0},parseGeometry:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");if(this.view.tell()>=e.end())return this.pop(),!0;var t=this.parseNodeHeader();if(t.id==DataParserTypes.NODE_MESH){if(!this.hasDataForNode(t))return this.error("Not enough data for node '"+DataParserTypes.getName(t.id)+"'");this.push(t,this.parseMesh)}else this.skipNode(t);return!0},parseMesh:function(e){var t=this.getUint32(),n=this.result.createMesh(t),i=0,r=[1,1,1],o=[1,1,1];for(this.flipX&&(o[0]=-1);this.view.tell()<e.end();){var a=this.parseNodeHeader();if(!this.hasDataForNode(a))return this.error("Not enough data for node '"+DataParserTypes.getName(a.id)+"'");switch(a.id){case DataParserTypes.NODE_MATERIAL_REFERENCE:if(a.length<4)return this.errorExpect(4,"mesh.material_reference");n.material=this.getUint32();break;case DataParserTypes.NODE_VERTICES:if(!this.parseVertices(a,t,n.vertices,"position",o))return!1;break;case DataParserTypes.NODE_NORMALS:if(!this.parseVertices(a,t,n.vertices,"normal",r))return!1;break;case DataParserTypes.NODE_TANGENTS:if(!this.parseVertices(a,t,n.vertices,"tangent",r))return!1;break;case DataParserTypes.NODE_BITANGENTS:if(!this.parseVertices(a,t,n.vertices,"bitangent",r))return!1;break;case DataParserTypes.NODE_TEXTURE_COORDINATES:if(a.length<4)return this.errorExpect(4,"mesh texture coordinates component count");var s=this.getUint32();if(0==s||3<s)return this.error("Unsupported number of texture coordinate components: "+s);if(a.length-4!=s*t*4)return this.error("Texture coordinate set "+i+" is corrupted");for(var l=["x","y","z"],c=0;c<t;c++){for(var h={},u=0;u<s;u++)h[l[u]]=this.getFloat32();n.vertices[c].texCoord.push(h)}i++;break;case DataParserTypes.NODE_FACES:if(!this.parseFaces(a,n.indices))return!1;break;default:this.skipNode(a)}}return this.result.addMesh(n),this.pop(),!0},parseVertices:function(e,t,n,i,r){if(e.length!=12*t)return this.error("Node "+DataParserTypes.getName(e.id)+" is corrupted");for(var o=0;o<t;o++)n[o][i].x=r[0]*this.getFloat32(),n[o][i].y=r[1]*this.getFloat32(),n[o][i].z=r[2]*this.getFloat32();return!0},parseFaces:function(e,t){if(e.length<4)return this.errorExpect(4,"faces.num_triangles");var n=this.getUint32();if(e.length-4!=12*n)return this.error("Faces list is corrupted");for(var i=0;i<n;i++)t.push(this.getUint32()),t.push(this.getUint32()),t.push(this.getUint32());return!0},parseScene:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(;this.view.tell()<e.end();){var t=this.parseNodeHeader();if(t.id==DataParserTypes.NODE_GROUP){if(!this.parseGroup(t,!1))return!1}else this.skipNode(t)}return this.pop(),!0},parseGroup:function(e,t){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");var n=this.result.createGroup();for(!1===t?this.result.setRoot(n):(t.children.push(n),n.parent=t);this.view.tell()<e.end();){var i=this.parseNodeHeader();if(!this.hasDataForNode(i))return this.error("Not enough data for node '"+DataParserTypes.getName(i.id)+"'");switch(i.id){case DataParserTypes.NODE_GROUP_ID:if(i.length<4)return this.error("Group ID is corrupted");n.id=this.getUint32(),this.result.mapGroupID(n);break;case DataParserTypes.NODE_STRING:n.name=this.view.getString(i.length);break;case DataParserTypes.NODE_TRANSFORM_POSITION:if(12!=i.length)return this.error("Group position is corrupted");n.position.x=this.getFloat32(),n.position.y=this.getFloat32(),n.position.z=this.getFloat32();break;case DataParserTypes.NODE_TRANSFORM_ROTATION:if(16!=i.length)return this.error("Group rotation is corrupted");n.rotation.x=this.getFloat32(),n.rotation.y=this.getFloat32(),n.rotation.z=this.getFloat32(),n.rotation.w=this.getFloat32();break;case DataParserTypes.NODE_TRANSFORM_SCALE:if(12!=i.length)return this.error("Group scale is corrupted");n.scale.x=this.getFloat32(),n.scale.y=this.getFloat32(),n.scale.z=this.getFloat32();break;case DataParserTypes.NODE_MATRIX4X4:if(64!=i.length)return this.error("Group transformation matrix is corrupted");n.transform=this.getMatrix4x4();break;case DataParserTypes.NODE_MESH_REFERENCE:if(i.length<4)return this.error("Group mesh reference is corrupted");n.meshes.push(this.getUint32());break;case DataParserTypes.NODE_GROUP:this.parseGroup(i,n);break;default:this.skipNode(i)}}return!0},parseCollision:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(;this.view.tell()<e.end();){var t=this.parseNodeHeader();if(t.id==DataParserTypes.NODE_COLLISION_NODE){if(!this.parseCollisionNode(t,!1))return!1}else this.skipNode(t)}return this.pop(),!0},parseCollisionNode:function(e,t){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");var n=this.result.createCollisionTreeNode();for(!1===t?this.result.setCollisionTreeRoot(n):(t.children.push(n),n.parent=t);this.view.tell()<e.end();){var i=this.parseNodeHeader();if(!this.hasDataForNode(i))return this.error("Not enough data for node '"+DataParserTypes.getName(i.id)+"'");switch(i.id){case DataParserTypes.NODE_COLLISION_AABB_CENTER:if(12!=i.length)return this.error("Collision node center is corrupted");n.center.x=this.getFloat32(),n.center.y=this.getFloat32(),n.center.z=this.getFloat32();break;case DataParserTypes.NODE_COLLISION_AABB_EXTENTS:if(12!=i.length)return this.error("Collision node extents are corrupted");n.extents.x=this.getFloat32(),n.extents.y=this.getFloat32(),n.extents.z=this.getFloat32();break;case DataParserTypes.NODE_COLLISION_NODE:this.parseCollisionNode(i,n);break;case DataParserTypes.NODE_COLLISION_FACE_LIST:this.parseCollisionFaceList(i,n);break;default:this.skipNode(i)}}return!0},parseCollisionFaceList:function(e,t){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");for(var n=-1,i=-1,r=[];this.view.tell()<e.end();){var o=this.parseNodeHeader();if(!this.hasDataForNode(o))return this.error("Not enough data for node '"+DataParserTypes.getName(o.id)+"'");switch(o.id){case DataParserTypes.NODE_FACE_LIST_NODE_ID:if(4!=o.length)return this.error("Face list node ID is corrupted");n=this.getUint32();break;case DataParserTypes.NODE_FACE_LIST_MESH_REFERENCE:if(4!=o.length)return this.error("Face list mesh ID is corrupted");i=this.getUint32();break;case DataParserTypes.NODE_FACE_LIST_INDICES:for(;this.view.tell()<o.end();)r.push(this.getUint32());break;default:this.skipNode(o)}}return this.result.addFaceList(t,n,i,r)},parseRoot:function(e){if(!this.hasDataForNode(e))return this.error("Not enough data for node '"+DataParserTypes.getName(e.id)+"'");if(this.view.tell()>=e.end())return!0;var t=this.parseNodeHeader();switch(t.id){case DataParserTypes.NODE_MATERIALS:this.push(t,this.parseMaterials);break;case DataParserTypes.NODE_GEOMETRY:this.push(t,this.parseGeometry);break;case DataParserTypes.NODE_SCENE:this.push(t,this.parseScene);break;case DataParserTypes.NODE_COLLISION:this.push(t,this.parseCollision);break;default:this.skipNode(t)}return!0}}),ThreadedDataParser=DataParser.extend({init:function(e,t,n,i,r){this._super(e,t,n,i,r),this.timer=!1,this.inverval=10},parse:function(){return this.push(!1,this.parseHeader),this.timer=setTimeout(FrakCallback(this,this.threadStep),this.inverval),!0},threadStep:function(){if(this.completed())return this.linkReferences&&this.result.linkReferences(),void(this.isFunction(this.onComplete)&&this.onComplete(this.result.getData(),this.userdata));this.step()?this.timer=setTimeout(FrakCallback(this,this.threadStep),this.inverval):this.onError&&"function"==typeof this.onError&&this.onError(this.errors,this.userdata)}}),ModelLoader=FrakClass.extend({init:function(e,t,n,i){this.descriptor=t,this.shadersManager=n,this.texturesManager=i,this.defaultTexture=!1,this.defaultSampler=!1,this.nodesByID={},this.submeshesByID={},this.submeshes=[]},createDefaultTextureSampler:function(e){this.defaultTexture||e.engine&&(this.defaultTexture=e.engine.WhiteTexture,this.defaultSampler=new Sampler("diffuse0",this.defaultTexture))},load:function(e,t){e.name=t.hierarchy.name,this.loadMaterials(t.materials),this.loadSubmeshes(t.meshes),this.loadNode(e,t.hierarchy),this.loadCollision(e,t)},loadMaterials:function(e){for(var t=0;t<e.length;t++){var n=e[t];n.instance=new Material,this.loadMaterial(n.instance,n)}},loadSubmeshes:function(e){for(var t=0;t<e.length;t++){var n=new Submesh;this.loadSubmesh(n,e[t]),this.submeshesByID[e[t].index]={submesh:n,material:e[t].material.instance}}},loadNode:function(e,t){for(var n in e.localCollisionID=t.id,this.nodesByID[e.localCollisionID]=e,this.loadTransform(e.transform,t.transform),this.loadMesh(e,t.meshes),t.children){var i=new Node(t.children[n].name);this.loadNode(i,t.children[n]),e.addNode(i)}},loadMesh:function(e,t){if(t&&0!=t.length){var n=new Mesh;for(var i in t)if(t[i].index in this.submeshesByID){var r=this.submeshesByID[t[i].index];n.addSubmesh(r.submesh,r.material)}e.addComponent(new MeshComponent(n)),e.addComponent(new MeshRendererComponent)}},loadSubmesh:function(e,t){if(e.faces=t.indices,0!=t.vertices.length){var n=t.vertices[0];if(e.positions=this.loadSubmeshBuffer("position",t.vertices,["x","y","z"]),n.normal&&(e.normals=this.loadSubmeshBuffer("normal",t.vertices,["x","y","z"])),n.tangent&&(e.tangents=this.loadSubmeshBuffer("tangent",t.vertices,["x","y","z"])),n.bitangent&&(e.bitangents=this.loadSubmeshBuffer("bitangent",t.vertices,["x","y","z"])),n.texCoord)for(var i in n.texCoord)e.texCoords2D.push(this.loadSubmeshIndexedBuffer("texCoord",t.vertices,["x","y"],i));e.recalculateBounds()}},loadSubmeshBuffer:function(e,t,n){for(var i in buffer=[],t)for(var i in vertex=t[i],n){var r=n[i];buffer.push(vertex[e][r])}return buffer},loadSubmeshIndexedBuffer:function(e,t,n,i){for(var r in buffer=[],t)for(var r in vertex=t[r],n){var o=n[r];buffer.push(vertex[e][i][o])}return buffer},loadMaterial:function(e,t){for(var n in e.name=t.name,e.shader=this.shadersManager.addSource(t.shader),e.uniforms={},this.loadUniforms(e.uniforms,t),t.textures)for(var i=t.textures[n],r=0;r<i.length;r++){var o=new TextureDescriptor(i[r].path);o.parentDescriptor=this.descriptor;var a=this.texturesManager.addDescriptor(o);e.samplers||(e.samplers=[]),e.samplers.push(new Sampler(n+r,a)),"normal"==n&&(e.shader=this.shadersManager.addSource("normalmapped"))}e.samplers||"diffuse"!=t.shader.toLowerCase()||(e.samplers=[],this.createDefaultTextureSampler(this.texturesManager.context),e.samplers.push(this.defaultSampler))},loadUniforms:function(e,t){t.color.ambient?e.ambient=new UniformColor(t.color.ambient):e.ambient=new UniformColor(new Color(.2,.2,.2,1)),t.color.diffuse?e.diffuse=new UniformColor(t.color.diffuse):e.diffuse=new UniformColor(new Color(1,1,1,1)),t.color.emissive&&(e.emissive=new UniformColor(t.color.emissive)),t.color.specular&&(e.specular=new UniformColor(t.color.specular)),e.twosided=new UniformInt(t.twosided+0)},loadTransform:function(e,t){e.relative[0]=t[0][0],e.relative[4]=t[0][1],e.relative[8]=t[0][2],e.relative[12]=t[0][3],e.relative[1]=t[1][0],e.relative[5]=t[1][1],e.relative[9]=t[1][2],e.relative[13]=t[1][3],e.relative[2]=t[2][0],e.relative[6]=t[2][1],e.relative[10]=t[2][2],e.relative[14]=t[2][3],e.relative[3]=t[3][0],e.relative[7]=t[3][1],e.relative[11]=t[3][2],e.relative[15]=t[3][3]},loadCollisionNodeParameters:function(e,t){var n=new CollisionOctreeNode([e.center.x,e.center.y,e.center.z],2*e.extents.x,t);return e.faces&&(n.faces=e.faces),n},loadCollisionNodeSubnodes:function(e,t,n){if(0!=t.children.length){e.subnodes=[];for(var i=0;i<8;i++){var r=this.loadCollisionNodeParameters(t.children[i],e);e.subnodes.push(r),this.loadCollisionNodeSubnodes(r,t.children[i],n)}}},loadCollision:function(e,t){if(!1!==t.collision){var n=e.addComponent(new LargeMeshCollider);for(var i in n.tree=this.loadCollisionNodeParameters(t.collision,!1),n.tree.nodes=this.nodesByID,n.tree.submeshes={},this.submeshesByID)n.tree.submeshes[i]=this.submeshesByID[i].submesh;this.loadCollisionNodeSubnodes(n.tree,t.collision,t)}}}),JSONModelLoader=FrakClass.extend({init:function(e,t,n,i){this.descriptor=t,this.shadersManager=n,this.texturesManager=i,this.defaultTexture=!1,this.defaultSampler=!1,this.nodesByID={},this.submeshesByID={},this.submeshes=[],this.textureUniformMap={texturesDiffuse:"diffuse",texturesNormals:"normal"}},createDefaultTextureSampler:function(e){this.defaultTexture||e.engine&&(this.defaultTexture=e.engine.WhiteTexture,this.defaultSampler=new Sampler("diffuse0",this.defaultTexture))},load:function(e,t){FRAK.isEmptyObject(t)||(e.name=t.scene.name,this.linkReferences(t),this.loadMaterials(t.materials),this.loadSubmeshes(t.meshes),this.loadNode(e,t.scene),this.loadCollision(e,t))},linkReferences:function(e){for(var t,n=e.materials.length,i=0,r=e.meshes.length;i<r;i++)0<=(t=e.meshes[i]).materialIndex&&t.materialIndex<n&&(t.material=e.materials[t.materialIndex])},loadMaterials:function(e){for(var t,n=0,i=e.length;n<i;n++)(t=e[n]).instance=new Material,this.loadMaterial(t.instance,t)},loadMaterial:function(e,t){var n=t.shader||"diffuse";for(var i in e.name=t.name,e.shader=this.shadersManager.addSource(n),"transparent"==n.toLowerCase()&&(e.shader.requirements.transparent=!0),e.uniforms={},this.loadUniforms(e.uniforms,t),t.textures)for(var r=t.textures[i],o=0;o<r.length;o++){var a=new TextureDescriptor(r[o]);a.parentDescriptor=this.descriptor;var s=this.texturesManager.addDescriptor(a),l="diffuse";i in this.textureUniformMap&&(l=this.textureUniformMap[i]),e.samplers||(e.samplers=[]),e.samplers.push(new Sampler(l+o,s)),"texturesNormals"==i&&(e.shader=this.shadersManager.addSource("normalmapped"))}e.samplers||"diffuse"!=n.toLowerCase()||(e.samplers=[],this.createDefaultTextureSampler(this.texturesManager.context),e.samplers.push(this.defaultSampler))},loadUniforms:function(e,t){t.color.ambient?e.ambient=new UniformColor(t.color.ambient):e.ambient=new UniformColor(new Color(.2,.2,.2,1)),t.color.diffuse?e.diffuse=new UniformColor(t.color.diffuse):e.diffuse=new UniformColor(new Color(1,1,1,1)),t.color.emissive&&(e.emissive=new UniformColor(t.color.emissive)),t.color.specular&&(e.specular=new UniformColor(t.color.specular)),e.twosided=new UniformInt(t.twosided+0)},loadSubmeshes:function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t],r=new Submesh;this.loadSubmesh(r,i),this.submeshesByID[t]={submesh:r,material:i.material.instance}}},loadSubmesh:function(e,t){if(t.faces&&0!=t.faces.length&&t.vertices&&0!=t.vertices.length){var n;e.faces=t.faces,e.positions=t.vertices;var i=t.vertices.length/3;if(t.normals&&t.normals.length/3==i&&(e.normals=t.normals),t.tangents&&t.tangents.length/3==i&&(e.tangents=t.tangents),t.bitangents&&t.bitangents.length/3==i&&(e.bitangents=t.bitangents),t.texCoords1D)for(var r=0,o=t.texCoords1D.length;r<o;r++)(n=t.texCoords1D[r]).length==i&&e.texCoords1D.push(n);if(t.texCoords2D){r=0;for(var a=t.texCoords2D.length;r<a;r++)(n=t.texCoords2D[r]).length/2==i&&e.texCoords2D.push(n)}else if(t.texCoords3D){r=0;for(var s=t.texCoords3D.length;r<s;r++)if((n=t.texCoords3D[r]).length/3===i){for(var l=[],c=0;c<n.length;c+=3)l.push(n[c]),l.push(n[c+1]);e.texCoords2D.push(n),e.yesIGeneratedThese=!0}}if(t.texCoords3D){r=0;for(var h=t.texCoords3D.length;r<h;r++)(n=t.texCoords3D[r]).length/3==i&&e.texCoords3D.push(n)}if(t.texCoords4D){r=0;for(var u=t.texCoords4D.length;r<u;r++)(n=t.texCoords4D[r]).length/4==i&&e.texCoords4D.push(n)}e.recalculateBounds()}},loadNode:function(e,t){var n;e.localCollisionID=t.id,(this.nodesByID[e.localCollisionID]=e).transform.relative=t.relative,this.loadMesh(e,t.meshes);for(var i=0,r=t.subnodes.length;i<r;i++){n=t.subnodes[i];var o=new Node(n.name);this.loadNode(o,n),e.addNode(o)}},loadMesh:function(e,t){if(t&&0!=t.length){for(var n=new Mesh,i=0;i<t.length;i++){var r=t[i];if(r in this.submeshesByID){var o=this.submeshesByID[r];n.addSubmesh(o.submesh,o.material)}}e.addComponent(new MeshComponent(n)),e.addComponent(new MeshRendererComponent)}},loadCollisionNodeParameters:function(e,t){var n=new CollisionOctreeNode(new Float32Array(e.center),2*e.extents[0],t);return e.faces&&(n.faces=e.faces),n},loadCollisionNodeSubnodes:function(e,t,n){if(t.subnodes&&8==t.subnodes.length){e.subnodes=[];for(var i=0;i<8;i++){var r=this.loadCollisionNodeParameters(t.subnodes[i],e);e.subnodes.push(r),this.loadCollisionNodeSubnodes(r,t.subnodes[i],n)}}},loadCollision:function(e,t){if(t.collision){var n=e.addComponent(new LargeMeshCollider);for(var i in n.tree=this.loadCollisionNodeParameters(t.collision,!1),n.tree.nodes=this.nodesByID,n.tree.submeshes={},this.submeshesByID)n.tree.submeshes[i]=this.submeshesByID[i].submesh;this.loadCollisionNodeSubnodes(n.tree,t.collision,t)}}}),Manager=FrakClass.extend({init:function(e){var t=this;this.path="",e&&(this.path=e),0<this.path.length&&"/"!=this.path.slice(-1)&&(this.path+="/"),this.queue=[],this.loading=[],this.cache={},this.cacheSize=0,this.callbacks=[],this.progressCallbacks=[],this.sourceCallback=function(e){return t.path+e},this.descriptorCallback=function(e){return e},this.onAddToQueue=function(e){},this.onLoaded=function(e){}},getTotalItems:function(){return this.queue.length+this.loading.length+this.cacheSize},getWaitingItems:function(){return this.queue.length+this.loading.length},getProgress:function(){return 0==this.getTotalItems()?1:1-this.getWaitingItems()/this.getTotalItems()},addDescriptor:function(e){var t=this.cache[e.serialize(["id"])];return t||((t=this.getLoadingResource(e))||(this.onAddToQueue(e),t=this.createResource(e),this.queue.push([e,e.serialize(["id"]),t])),t)},getLoadingResource:function(e){var t=e.serialize(["id"]);for(var n in this.loading)if(this.loading[n][1]==t)return this.loading[n][2];for(var i in this.queue)if(this.queue[i][1]==t)return this.queue[i][2];return null},removeFromCache:function(e){delete this.cache[e],this.cacheSize--},cleanCache:function(){this.cache={},this.cacheSize=0},load:function(e,t){t&&this.progressCallbacks.push(t),e&&(this.callbacks.push(e),1<this.callbacks.length)?0==this.queue.length&&this.callDoneCallbacks():this.keepLoading()},keepLoading:function(){for(var e=0;e<this.progressCallbacks.length;e++)this.progressCallbacks[e](this.getProgress());if(0!=this.queue.length){var n=this,t=this.queue.shift();this.loading.push(t),this.loadResource(t[0],t[2],function(e,t){n.cache[e.serialize(["id"])]=t,n.cacheSize++,n.removeLoadedResource(e),n.onLoaded(e),n.keepLoading()},function(e){console.warn("Failed to load resource with descriptor: ",e.serialize(["id"])),n.removeLoadedResource(e),n.onLoaded(e),e.getFullPath&&console.warn("Full path: ",e.getFullPath()),n.keepLoading()})}else this.callDoneCallbacks()},removeLoadedResource:function(e){for(var t in this.loading)if(this.loading[t][0]===e){this.loading.splice(t,1);break}},callDoneCallbacks:function(){var e=this.callbacks;this.callbacks=[];for(var t=0;t<e.length;t++)e[t]()},createResource:function(){throw"createResource not implemented by this instance of Manager"},loadResource:function(e,t,n,i){throw"loadResource not implemented by this instance of Manager"}}),TextManager=Manager.extend({init:function(e){this._super(e)},add:function(e){return e=this.sourceCallback(e),this.addDescriptor(new TextDescriptor(e))},createResource:function(e){return{data:!1,descriptor:e}},loadResource:function(e,t,n,i){var r=this.descriptorCallback(e);Logistics.getText(r.getFullPath(),function(e){t.data=e,n(r,t)}).error(function(){i(r)})}}),ShadersManager=Manager.extend({init:function(e,t){this._super(t),this.sourceCallback=function(e){return e},this.context=e,this.builtin={},this.shaderBundle=e.isWebGL2()?"webgl2":"default",BuiltInShaders&&this.shaderBundle in BuiltInShaders&&(this.builtin=BuiltInShaders[this.shaderBundle]),this.setAliases(),this.textManager=new TextManager},setAliases:function(){this.aliases={diffuse:this.bundle("diffuse"),normalmapped:this.bundle("normalmapped"),transparent:this.bundle("transparent"),reflective:this.bundle("reflective"),reflective_masked:this.bundle("reflective_masked"),test:this.bundle("test"),fallback:this.bundle("fallback"),depthrgba:this.bundle("depthrgba"),gaussianblur:this.bundle("gaussianblur")}},bundle:function(e){return"shaders/{0}/{1}".format(this.shaderBundle,e)},add:function(e,t){return e=this.sourceCallback(e),t=this.sourceCallback(t),this.addDescriptor(new ShaderDescriptor(e,t))},addSource:function(e){var t=e.toLowerCase();return t in this.aliases&&(e=this.aliases[t]),e=this.sourceCallback(e),this.addDescriptor(new ShaderDescriptor(e+".vert",e+".frag"))},createResource:function(e){return new Shader(this.context,e)},loadResource:function(e,t,n,i){var r=this.descriptorCallback(e);if(this.builtin[r.vertexSource]&&this.builtin[r.fragmentSource])console.log("Built in shader loaded:",r.vertexSource,r.fragmentSource),t.addVertexShader(this.builtin[r.vertexSource]),t.addFragmentShader(this.builtin[r.fragmentSource]),n(r,t);else{var o=this.textManager.add(this.path+r.getVertexShaderPath()),a=this.textManager.add(this.path+r.getFragmentShaderPath());this.textManager.load(function(){o.data&&a.data?(t.addVertexShader(o.data),t.addFragmentShader(a.data),n(r,t)):i(r)})}}}),TexturesManager=Manager.extend({init:function(e,t){this._super(t),this.context=e},add:function(e){e=this.sourceCallback(e);var t=new TextureDescriptor(e);return this.addDescriptor(t)},addCube:function(e){if(6!=e.length)throw"TexturesManager.addCube: Cube textures require 6 image URIs";for(var t=new CubeTextureDescriptor,n=0;n<e.length;n++)t.sources.push(this.sourceCallback(e[n]));return this.addDescriptor(t)},createResource:function(e){var t;return e instanceof CubeTextureDescriptor?(t=new CubeTexture(this.context)).name="Cubemap":(t=new Texture(this.context)).name=e.source,t},loadResource:function(e,i,r,o){var a=this.descriptorCallback(e),s=this;if(e instanceof CubeTextureDescriptor){var l=[CubeTexture.FRONT,CubeTexture.BACK,CubeTexture.LEFT,CubeTexture.RIGHT,CubeTexture.BOTTOM,CubeTexture.TOP];!function t(){if(0!=l.length){var n=l.shift();Logistics.getImage(a.getFaceFullPath(n),function(e){i.setFace(s.context,n,e),delete e,t()}).error(function(){o(a)})}else r(a,i)}()}else Logistics.getImage(a.getFullPath(),function(e){i.setImage(s.context,e),delete e,r(a,i)}).error(function(){o(a)})}}),MaterialsManager=Manager.extend({init:function(e,t,n,i){if(this._super(t),n&&!(n instanceof ShadersManager))throw"shadersManager is not instance of ShadersManager";if(i&&!(i instanceof TexturesManager))throw"texturesManager is not instance of TexturesManager";n||(n=new ShadersManager(e)),this.shadersManager=n,i||(i=new TexturesManager(e)),this.texturesManager=i,this.context=e},add:function(e){return e=this.sourceCallback(e),this.addDescriptor(new MaterialDescriptor(e))},createResource:function(e){var t=new Material;return t.descriptor=e,t},loadResource:function(e,n,i,t){var r,o=this.descriptorCallback(e),a=this;o.shaderDescriptor&&(r=this.shadersManager.addDescriptor(o.shaderDescriptor)),this.shadersManager.load(function(){var t={};for(var e in o.textureDescriptors)t[e]=a.texturesManager.addDescriptor(o.textureDescriptors[e]);a.texturesManager.load(function(){for(var e in n.samplers||(n.samplers=[]),t)n.samplers.push(new Sampler(e,t[e]));n.shader=r,n.uniforms=o.uniforms,o.requirements&&n.shader&&(n.shader.requirements.transparent=o.requirements.transparent),i(o,n)})})}}),MaterialSourcesManager=Manager.extend({init:function(e,t,n,i){if(this._super(t),n&&!(n instanceof MaterialsManager))throw"materialsManager is not instance of MaterialsManager";if(i&&!(i instanceof TextManager))throw"textManager is not instance of TextManager";n||(n=new MaterialsManager(e)),this.materialsManager=n,i||(i=new TextManager),this.textManager=i,this.context=e},add:function(e){return e=this.sourceCallback(e),this.addDescriptor(new MaterialSourceDescriptor(e))},createResource:function(e){return new MaterialSource(e)},loadResource:function(e,a,s,t){var l=this.descriptorCallback(e),c=this.textManager.add(l.getFullPath()),h=this;this.textManager.load(function(){var e=FRAK.parseJSON(c.data),t=new MaterialDescriptor;if(t.parentDescriptor=l,e.uniforms)for(var n in e.uniforms){var i=e.uniforms[n];i instanceof Array?(1==i.length&&(t.uniforms[n]=new UniformFloat(i)),2==i.length&&(i[0]instanceof Array?t.uniforms[n]=new UniformMat2(i[0].concat(i[1])):t.uniforms[n]=new UniformVec2(i)),3==i.length&&(i[0]instanceof Array?t.uniforms[n]=new UniformMat3(i[0].concat(i[1]).concat(i[2])):t.uniforms[n]=new UniformVec3(i)),4==i.length&&(i[0]instanceof Array?t.uniforms[n]=new UniformMat4(i[0].concat(i[1]).concat(i[2]).concat(i[3])):t.uniforms[n]=new UniformVec4(i))):i instanceof Object?(!1 in i&&(i.a=0),t.uniforms[n]=new UniformColor(i)):"number"==typeof i&&parseFloat(i)==parseInt(i)?t.uniforms[n]=new UniformInt(i):t.uniforms[n]=new UniformFloat(i)}if(e.textures)for(var r in e.textures){var o=new TextureDescriptor(e.textures[r]);(t.textureDescriptors[r]=o).parentDescriptor=t}e.shader&&(e.shader instanceof Array?t.shaderDescriptor=new ShaderDescriptor(e.shader[0],e.shader[1]):t.shaderDescriptor=new ShaderDescriptor(e.shader),t.shaderDescriptor.parentDescriptor=t),e.requirements&&(t.requirements=e.requirements),a.material=h.materialsManager.addDescriptor(t),h.materialsManager.load(function(){s(l,a)})})}}),ModelsManager=Manager.extend({init:function(e,t,n,i){this._super(t),n||(n=new ShadersManager(e)),this.shadersManager=n,i||(i=new TexturesManager(e)),this.texturesManager=i},getProgress:function(){var e=this._super();return 1==e?e:e+(this.texturesManager.getProgress()+this.shadersManager.getProgress())/2/this.getTotalItems()},add:function(e,t){return e=this.sourceCallback(e),this.addDescriptor(new ModelDescriptor(e,t))},createResource:function(){return new Node},loadResource:function(e,n,i,r){var o=this.descriptorCallback(e),a=this;"json"==e.getFormat()?Logistics.getJSON(o.getFullPath(),function(e){new JSONModelLoader(a.context,o,a.shadersManager,a.texturesManager).load(n,e),i(o,n),a.shadersManager.load(function(){}),a.texturesManager.load(function(){})}):Logistics.getBinary(o.getFullPath(),function(e){e&&0!=e.byteLength?a.createParser(e,function(e,t){new ModelLoader(a.context,o,a.shadersManager,a.texturesManager).load(n,e),i(o,n),a.shadersManager.load(function(){}),a.texturesManager.load(function(){})},function(e,t){r(o)},function(e,t){}).parse():r(o)})},createParser:function(e,t,n,i,r){return new ThreadedDataParser(e,t,n,i,r)}}),AssetsManager=FrakClass.extend({init:function(e,t){this.managers=[],this.assetsPath=t;var i=this;this.loadingCount=0,this.loadedCallbacks=[];var n=function(e){e.onAddToQueue=function(e){i.loadingCount++},e.onLoaded=function(e){if(i.loadingCount--,i.loadingCount<=0){var t=i.loadedCallbacks.slice(0);i.loadedCallbacks=[];for(var n=0;n<t.length;n++){(0,t[n])()}}},i.managers.push(e)};n(this.shadersManager=new ShadersManager(e,this.assetsPath)),n(this.texturesManager=new TexturesManager(e,this.assetsPath)),n(this.modelsManager=new ModelsManager(e,this.assetsPath,this.shadersManager,this.texturesManager)),n(this.textManager=new TextManager(this.assetsPath)),n(this.materialsManager=new MaterialsManager(e,this.assetsPath,this.shadersManager,this.texturesManager)),n(this.materialSourcesManager=new MaterialSourcesManager(e,this.assetsPath,this.materialsManager,this.textManager))},addTexture:function(e){return this.texturesManager.add(e)},addModel:function(e,t){return this.modelsManager.add(e,t)},addShaderSource:function(e){return this.shadersManager.addSource(e)},addShader:function(e,t){return this.shadersManager.add(e,t)},addText:function(e){return this.textManager.add(e)},addMaterial:function(e){return this.materialSourcesManager.add(e)},hasItemsInQueue:function(){for(var e in this.managers)if(0<this.managers[e].getWaitingItems())return!0;return!1},load:function(e,n){var i=this;if(e&&this.loadedCallbacks.push(e),this.hasItemsInQueue())for(var t=0;t<this.managers.length;t++)this.managers[t].load(function(){},a);else{var r=this.loadedCallbacks.slice(0);this.loadedCallbacks=[];for(var o=0;o<r.length;o++)r[o]()}function a(){if(n){for(var e=0,t=0;t<i.managers.length;t++)i.managers[t]?e+=i.managers[t].getProgress():e+=1;n(e/i.managers.length)}}}}),BoundingVolume=Serializable.extend({init:function(e){this.center=!1,e&&(this.center=vec3.clone(e))},type:function(){return"BoundingVolume"},isPoint:function(){return!0},toString:function(){return"BoundingVolume[center=("+this.center[0]+","+this.center[1]+","+this.center[2]+")]"}}),BoundingVolumeVectorCache=[vec3.create(),vec3.create(),vec3.create()],BoundingBox=BoundingVolume.extend({init:function(e,t){this._super(e),this.size=vec3.create(),t&&vec3.copy(this.size,t),this.extents=vec3.scale(vec3.create(),this.size,.5),this.min=vec3.create(),this.max=vec3.create(),this.recalculate()},type:function(){return"BoundingBox"},recalculate:function(){vec3.scale(this.size,this.extents,2),this.center&&(vec3.subtract(this.min,this.center,this.extents),vec3.add(this.max,this.center,this.extents))},set:function(e,t){e&&(this.center||(this.center=vec3.create()),vec3.copy(this.center,e)),t&&vec3.copy(this.size,t),vec3.scale(this.extents,this.size,.5),this.recalculate()},transform:function(e,t){if(t||(t=new BoundingBox),!this.center)return t;var n=0,i=0;mat4.translation(t.min,e),mat4.translation(t.max,e);for(var r=0;r<3;r++)for(var o=0;o<3;o++)(n=e[4*o+r]*this.min[o])<(i=e[4*o+r]*this.max[o])?(t.min[r]+=n,t.max[r]+=i):(t.min[r]+=i,t.max[r]+=n);return vec3.subtract(t.size,t.max,t.min),vec3.scale(t.extents,t.size,.5),t.center||(t.center=vec3.create()),vec3.add(t.center,t.min,t.extents),t},isPoint:function(){return 0==this.size[0]&&0==this.size[1]&&0==this.size[2]},getOuterSphereRadius:function(){return vec3.len(this.extents)},containsPoint:function(e){return!!this.center&&(e[0]>=this.min[0]&&e[1]>=this.min[1]&&e[2]>=this.min[2]&&e[0]<=this.max[0]&&e[1]<=this.max[1]&&e[2]<=this.max[2])},containsBox:function(e){return!!this.center&&(this.containsPoint(e.min)&&this.containsPoint(e.max))},intersectsBox:function(e){return!!this.center&&(this.max[0]>e.min[0]&&this.min[0]<e.max[0]&&this.max[1]>e.min[1]&&this.min[1]<e.max[1]&&this.max[2]>e.min[2]&&this.min[2]<e.max[2])},intersectsPlane:function(e){if(!this.center)return!1;var t=BoundingVolumeVectorCache[0],n=BoundingVolumeVectorCache[1],i=BoundingVolumeVectorCache[2];vec3.copy(t,this.max),vec3.copy(n,this.min);var r=1/0,o=-1/0,a=e.getDistanceToPoint(this.min);return a<r&&(vec3.copy(t,this.min),r=a),o<a&&(vec3.copy(n,this.min),o=a),(a=e.getDistanceToPoint(this.max))<r&&(vec3.copy(t,this.max),r=a),o<a&&(vec3.copy(n,this.max),o=a),vec3.set(i,this.min[0],this.min[1],this.max[2]),(a=e.getDistanceToPoint(i))<r&&(vec3.copy(t,i),r=a),o<a&&(vec3.copy(n,i),o=a),vec3.set(i,this.min[0],this.max[1],this.min[2]),(a=e.getDistanceToPoint(i))<r&&(vec3.copy(t,i),r=a),o<a&&(vec3.copy(n,i),o=a),vec3.set(i,this.min[0],this.max[1],this.max[2]),(a=e.getDistanceToPoint(i))<r&&(vec3.copy(t,i),r=a),o<a&&(vec3.copy(n,i),o=a),vec3.set(i,this.max[0],this.min[1],this.min[2]),(a=e.getDistanceToPoint(i))<r&&(vec3.copy(t,i),r=a),o<a&&(vec3.copy(n,i),o=a),vec3.set(i,this.max[0],this.min[1],this.max[2]),(a=e.getDistanceToPoint(i))<r&&(vec3.copy(t,i),r=a),o<a&&(vec3.copy(n,i),o=a),vec3.set(i,this.max[0],this.max[1],this.min[2]),(a=e.getDistanceToPoint(i))<r&&(vec3.copy(t,i),r=a),o<a&&(vec3.copy(n,i),o=a),!e.sameSide(t,n)||!(!e.pointOnPlane(t)&&!e.pointOnPlane(n))},intersectsTriangle:function(e,t,n){if(!this.center)return!1;if(AABBPlaneCache.setByPoints(e,t,n),!this.intersectsPlane(AABBPlaneCache))return!1;if(this.containsPoint(e)||this.containsPoint(t)||this.containsPoint(n))return!0;var i=BoundingVolumeVectorCache[0],r=BoundingVolumeVectorCache[1];vec3.copy(i,e),vec3.copy(r,e);for(var o=0;o<3;o++)t[o]<i[o]&&(i[o]=t[o]),n[o]<i[o]&&(i[o]=n[o]),t[o]>r[o]&&(r[o]=t[o]),n[o]>r[o]&&(r[o]=n[o]);if(!(this.max[0]>=i[0]&&this.min[0]<=r[0]&&this.max[1]>=i[1]&&this.min[0]<=r[1]&&this.max[2]>=i[2]&&this.min[2]<=r[2]))return!1;var a=vec2.fromValues(e[0],e[1]),s=vec2.fromValues(t[0],t[1]),l=vec2.fromValues(n[0],n[1]),c=vec2.fromValues(this.min[0],this.min[1]),h=vec2.fromValues(this.max[0],this.max[1]);return!!(LineRectIntersection2D(a,s,c,h)||LineRectIntersection2D(s,l,c,h)||LineRectIntersection2D(l,a,c,h)||PointInTriangle2D(a,s,l,c))&&(vec2.set(a,e[2],e[1]),vec2.set(s,t[2],t[1]),vec2.set(l,n[2],n[1]),vec2.set(c,this.min[2],this.min[1]),vec2.set(h,this.max[2],this.max[1]),!!(LineRectIntersection2D(a,s,c,h)||LineRectIntersection2D(s,l,c,h)||LineRectIntersection2D(l,a,c,h)||PointInTriangle2D(a,s,l,c))&&(vec2.set(a,e[0],e[2]),vec2.set(s,t[0],t[2]),vec2.set(l,n[0],n[2]),vec2.set(c,this.min[0],this.min[2]),vec2.set(h,this.max[0],this.max[2]),!!(LineRectIntersection2D(a,s,c,h)||LineRectIntersection2D(s,l,c,h)||LineRectIntersection2D(l,a,c,h)||PointInTriangle2D(a,s,l,c))))},encapsulatePoint:function(e){if(!this.center)return this.center=vec3.clone(e),this.extents[0]=0,this.extents[1]=0,this.extents[2]=0,void this.recalculate();if(!this.containsPoint(e)){for(var t=vec3.subtract(BoundingVolumeVectorCache[0],e,this.center),n=0;n<3;n++)Math.abs(t[n])>this.extents[n]&&(this.extents[n]+=(Math.abs(t[n])-this.extents[n])/2,this.center[n]=e[n]+(e[n]>this.center[n]?-1:1)*this.extents[n]);this.recalculate()}},encapsulateBox:function(e){if(e.center)return this.center?void(this.containsBox(e)||(this.encapsulatePoint(e.min),this.encapsulatePoint(e.max))):(this.center=vec3.clone(e.center),this.extents=vec3.clone(e.extents),void this.recalculate())},getVertices:function(e){return e||(e=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()]),vec3.add(e[0],this.center,[this.extents[0],this.extents[1],this.extents[2]]),vec3.add(e[1],this.center,[-this.extents[0],this.extents[1],this.extents[2]]),vec3.add(e[2],this.center,[this.extents[0],-this.extents[1],this.extents[2]]),vec3.add(e[3],this.center,[-this.extents[0],-this.extents[1],this.extents[2]]),vec3.add(e[4],this.center,[this.extents[0],this.extents[1],-this.extents[2]]),vec3.add(e[5],this.center,[-this.extents[0],this.extents[1],-this.extents[2]]),vec3.add(e[6],this.center,[this.extents[0],-this.extents[1],-this.extents[2]]),vec3.add(e[7],this.center,[-this.extents[0],-this.extents[1],-this.extents[2]]),e},toString:function(){return"BoundingBox[\n\tcenter=("+this.center[0]+", "+this.center[1]+", "+this.center[2]+")\n\tmin=("+this.min[0]+", "+this.min[1]+", "+this.min[2]+")\n\tmax=("+this.max[0]+", "+this.max[1]+", "+this.max[2]+")\n\textents=("+this.extents[0]+", "+this.extents[1]+", "+this.extents[2]+")\n\tsize=("+this.size[0]+", "+this.size[1]+", "+this.size[2]+")\n]\n"}});function LineLineIntersection2D(e,t,n,i,r){var o=(t[0]-e[0])*(i[1]-n[1])-(t[1]-e[1])*(i[0]-n[0]);if(0==o)return!1;var a=((e[1]-n[1])*(i[0]-n[0])-(e[0]-n[0])*(i[1]-n[1]))/o,s=((e[1]-n[1])*(t[0]-e[0])-(e[0]-n[0])*(t[1]-e[1]))/o;return!(a<0||1<a||s<0||1<s)&&(r&&(r[0]=e[0]+a*(t[0]-e[0]),r[1]=e[1]+a*(t[1]-e[1])),!0)}function LineRectIntersection2D(e,t,n,i){return!!(LineLineIntersection2D(e,t,n,[n[0],i[1]])||LineLineIntersection2D(e,t,[n[0],i[1]],i)||LineLineIntersection2D(e,t,i,[i[0],n[1]])||LineLineIntersection2D(e,t,n,[i[0],n[1]]))}function PointInTriangle2D(e,t,n,i){var r=(t[1]-n[1])*(e[0]-n[0])+(n[0]-t[0])*(e[1]-n[1]);if(0==r)return!1;var o=((t[1]-n[1])*(i[0]-n[0])+(n[0]-t[0])*(i[1]-n[1]))/r,a=((n[1]-e[1])*(i[0]-n[0])+(e[0]-n[0])*(i[1]-n[1]))/r;return 0<=o&&0<=a&&o+a<=1}var BoundingSphere=BoundingVolume.extend({init:function(e,t){this._super(e),this.radius=0,t&&(this.radius=t)},type:function(){return"BoundingSphere"},isPoint:function(){return 0==this.radius},containsPoint:function(e){return!!this.center&&vec3.distance(e,this.center)<=this.radius},containsSphere:function(e){return!!this.center&&vec3.distance(e.center,this.center)<=this.radius-e.radius},intersectsSphere:function(e){if(!this.center)return!1;var t=vec3.squaredLength(vec3.subtract(BoundingVolumeVectorCache[0],this.center,e.center)),n=this.radius+e.radius;return t<=n*n},encapsulatePoint:function(e){if(!this.center)return this.center=vec3.clone(e),void(this.radius=0);if(!this.containsPoint(e)){var t=vec3.subtract(BoundingVolumeVectorCache[0],this.center,e),n=vec3.length(t)+this.radius;vec3.normalize(t,t),this.radius=n/2;var i=vec3.scale(BoundingVolumeVectorCache[1],t,this.radius);vec3.add(this.center,e,i)}},encapsulateSphere:function(e){if(e.center){if(!this.center)return this.center=vec3.clone(e.center),void(this.radius=e.radius);if(!this.containsSphere(e)){var t=vec3.subtract(BoundingVolumeVectorCache[0],e.center,this.center),n=vec3.length(t)+e.radius;vec3.normalize(t,t),vec3.scale(t,t,n);var i=vec3.add(BoundingVolumeVectorCache[2],this.center,t);this.encapsulatePoint(i)}}},transform:function(e,t){if(t||(t=new BoundingSphere),!this.center)return t;var n=mat4.getScale(BoundingVolumeVectorCache[0],e),i=vec3.transformMat4(BoundingVolumeVectorCache[1],this.center,e);return t.center||(t.center=vec3.create()),vec3.copy(t.center,i),t.radius=this.radius*Math.max(n[0],n[1],n[2]),t},toString:function(){return"BoundingSphere[center=("+this.center[0]+", "+this.center[1]+", "+this.center[2]+") radius="+this.radius+"]"}}),Plane=FrakClass.extend({init:function(){this.normal=vec3.create(),this.distance=0},setByPoints:function(e,t,n){return this.normal=vec3.cross(vec3.create(),vec3.subtract(vec3.create(),t,e),vec3.subtract(vec3.create(),n,e)),vec3.normalize(this.normal,this.normal),this.distance=-vec3.dot(this.normal,t),this},setByNormalAndPoint:function(e,t){return this.normal=vec3.clone(e),vec3.normalize(this.normal,this.normal),this.distance=-vec3.dot(this.normal,t),this},getDistanceToPoint:function(e){return vec3.dot(this.normal,e)+this.distance},getDistanceOnLine:function(e,t){var n=vec3.scale(vec3.create(),this.normal,-this.distance),i=vec3.dot(t,this.normal);return Math.abs(i)<EPSILON?1/0:vec3.dot(vec3.sub(n,n,e),this.normal)/i},getLineIntersection:function(e,t,n){n||(n=vec3.create());var i=this.getDistanceOnLine(e,t);return vec3.scaleAndAdd(n,e,t,i),n},projectToPlane:function(e,t){return t||(t=vec3.create()),vec3.scale(t,this.normal,this.getDistanceToPoint(e)),vec3.sub(t,e,t),t},pointInFront:function(e){return 0<vec3.dot(this.normal,e)+this.distance},pointInBack:function(e){return vec3.dot(this.normal,e)+this.distance<0},pointOnPlane:function(e){return Math.abs(vec3.dot(this.normal,e)+this.distance)<EPSILON},sameSide:function(e,t){return!((vec3.dot(this.normal,e)+this.distance)*(vec3.dot(this.normal,t)+this.distance)<0)},toString:function(){return"Plane["+this.normal[0]+", "+this.normal[1]+", "+this.normal[2]+", "+this.distance+"]"}}),AABBPlaneCache=new Plane,Ray=FrakClass.extend({init:function(e,t){this.infinite=!1,this.origin=vec3.create(),this.destination=vec3.create(),e&&vec3.copy(this.origin,e),t&&vec3.copy(this.destination,t)},clone:function(){var e=new Ray(this.origin,this.destination);return e.infinite=this.infinite,e},getLength:function(){return vec3.distance(this.origin,this.destination)},getDirection:function(e){return e||(e=vec3.create()),this.getVector(e),vec3.normalize(e,e),e},getVector:function(e){return e||(e=vec3.create()),vec3.subtract(e,this.destination,this.origin),e},transform:function(e){vec3.transformMat4(this.origin,this.origin,e),vec3.transformMat4(this.destination,this.destination,e)},transformWithLength:function(e,t){var n=mat4.clone(e);n[12]=0,n[13]=0,n[14]=0;var i=this.getDirection();vec3.transformMat4(this.origin,this.origin,e),vec3.transformMat4(i,i,n),vec3.scale(i,i,t),vec3.add(this.destination,this.origin,i)},getPointOnRay:function(e){var t=vec3.create(),n=this.getVector();return vec3.add(t,this.origin,vec3.scale(n,n,e)),t},getClosestPointOnRay:function(e){var t=this.getDirection(),n=vec3.dot(t,vec3.subtract(vec3.create(),e,this.origin));return vec3.add(vec3.create(),this.origin,vec3.scale(t,t,n))},distanceOfPoint:function(e){return vec3.dot(this.getDirection(),vec3.subtract(vec3.create(),e,this.origin))<=0?vec3.distance(e,this.origin):vec3.distance(vec3.cross(vec3.create(),this.getDirection(),vec3.subtract(vec3.create(),e,this.origin)))},intersectBoundingVolume:function(e,t){return!!(e instanceof BoundingVolume&&e.center)&&(e instanceof BoundingSphere?this.intersectSphere(e.center,e.radius,t):e instanceof BoundingBox&&this.intersectAABB(e.min,e.max,t))},intersectPlane:function(e,t){if(e.sameSide(this.origin,this.destination))return!1;var n=this.getDirection(),i=-e.getDistanceToPoint(this.origin)/vec3.dot(n,e.normal);return t&&t.add(vec3.add(vec3.create(),this.origin,vec3.scale(n,n,i))),!0},intersectTriangle:function(e,t,n,i){var r=vec3.subtract(RayTestLocalCache[0],n,e),o=vec3.subtract(RayTestLocalCache[1],t,e),a=vec3.cross(RayTestLocalCache[2],o,r);vec3.normalize(a,a);var s=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.origin,e),a),l=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.destination,e),a);if(0<=s*l)return!1;var c=this.getVector();c=vec3.add(c,this.origin,vec3.scale(c,c,-s/(l-s)));var h=vec3.subtract(RayTestLocalCache[2],c,e),u=vec3.dot(r,r),d=vec3.dot(r,o),f=vec3.dot(r,h),m=vec3.dot(o,o),v=vec3.dot(o,h),p=1/(u*m-d*d),g=(m*f-d*v)*p,x=(u*v-d*f)*p;return 0<=g&&0<=x&&g+x<=1&&(i&&i.add(c),!0)},intersectTriangleDistanceOnly:function(e,t,n){var i=vec3.subtract(RayTestLocalCache[0],n,e),r=vec3.subtract(RayTestLocalCache[1],t,e),o=vec3.cross(RayTestLocalCache[2],r,i);vec3.normalize(o,o);var a=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.origin,e),o),s=vec3.dot(vec3.subtract(RayTestLocalCache[3],this.destination,e),o);if(0<=a*s)return!1;var l=this.getVector(),c=-a/(s-a);l=vec3.add(l,this.origin,vec3.scale(l,l,c));var h=vec3.subtract(RayTestLocalCache[2],l,e),u=vec3.dot(i,i),d=vec3.dot(i,r),f=vec3.dot(i,h),m=vec3.dot(r,r),v=vec3.dot(r,h),p=1/(u*m-d*d),g=(m*f-d*v)*p,x=(u*v-d*f)*p;return 0<=g&&0<=x&&g+x<=1&&c},intersectSphere:function(e,t,n){var i=vec3.sub(RayTestLocalCache[0],this.origin,e),r=this.getDirection(),o=vec3.dot(r,i),a=o*o-vec3.dot(i,i)+t*t;return Math.abs(a)<EPSILON?(n&&n.add(vec3.add(vec3.create(),this.origin,vec3.scale(r,r,-o))),!0):0<a&&(n&&(n.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[0],r,-o-Math.sqrt(a)))),n.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[0],r,-o+Math.sqrt(a))))),!0)},intersectAABB:function(e,t,n){var i=this.getDirection(RayTestLocalCache[0]),r=RayTestLocalCache[1],o=RayTestLocalCache[2];i[0]=1/i[0],i[1]=1/i[1],i[2]=1/i[2],r[0]=(e[0]-this.origin[0])*i[0],o[0]=(t[0]-this.origin[0])*i[0],r[1]=(e[1]-this.origin[1])*i[1],o[1]=(t[1]-this.origin[1])*i[1],r[2]=(e[2]-this.origin[2])*i[2],o[2]=(t[2]-this.origin[2])*i[2];var a=Math.max(Math.min(r[0],o[0]),Math.min(r[1],o[1]),Math.min(r[2],o[2])),s=Math.min(Math.max(r[0],o[0]),Math.max(r[1],o[1]),Math.max(r[2],o[2]));return!(s<0||s<a)&&(this.infinite?(n&&(this.getDirection(i),n.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],i,a))),n.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],i,s)))),!0):!(a*a>vec3.sqrDist(this.origin,this.destination)&&(this.origin[0]<e[0]||this.origin[1]<e[1]||this.origin[2]<e[2]||this.origin[0]>t[0]||this.origin[1]>t[1]||this.origin[2]>t[2])&&(this.destination[0]<e[0]||this.destination[1]<e[1]||this.destination[2]<e[2]||this.destination[0]>t[0]||this.destination[1]>t[1]||this.destination[2]>t[2]))&&(n&&(this.getDirection(i),n.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],i,a))),n.add(vec3.add(vec3.create(),this.origin,vec3.scale(RayTestLocalCache[1],i,s)))),!0))},toString:function(){return"Ray("+vec3.str(this.origin)+", "+vec3.str(this.destination)+", infinite = "+this.infinite+")"}}),RayTestResult=FrakClass.extend({init:function(e){this.ray=e.clone(),this.hits=[],this.addCallback=!1},add:function(e){var t={point:e,collider:!1,submesh:!1,node:!1};FRAK.isFunction(this.addCallback)&&this.addCallback(t),this.hits.push(t)},empty:function(){return 0==this.hits.length},sort:function(){var n=this;this.hits.sort(function(e,t){return vec3.sqrDist(n.ray.origin,e.point)-vec3.sqrDist(n.ray.origin,t.point)})},nearest:function(){if(this.empty())return!1;for(var e=1/0,t=0,n=0;n<this.hits.length;n++){var i=vec3.sqrDist(this.ray.origin,this.hits[n].point);i<e&&(e=i,t=n)}return this.hits[t]}}),RayTestLocalCache=[vec3.create(),vec3.create(),vec3.create(),vec3.create()],Submesh=FrakClass.extend({init:function(){this.materialIndex=-1,this.faces=[],this.positions=[],this.texCoords1D=[],this.texCoords2D=[],this.texCoords3D=[],this.texCoords4D=[],this.tangents=!1,this.normals=!1,this.bitangents=!1,this.barycentric=!1,this.boundingBox=new BoundingBox,this.boundingSphere=new BoundingSphere},calculateTangents:function(){for(var e=new Float32Array(this.positions.length),t=new Float32Array(this.positions.length),n=this.texCoords2D[0],i=vec3.create(),r=vec3.create(),o=vec3.create(),a=vec2.create(),s=vec2.create(),l=vec2.create(),c=vec3.create(),h=vec3.create(),u=0;u<this.faces.length;u+=3){var d=this.faces[u],f=this.faces[u+1],m=this.faces[u+2];vec3.set(i,this.positions[3*d],this.positions[3*d+1],this.positions[3*d+2]),vec3.set(r,this.positions[3*f],this.positions[3*f+1],this.positions[3*f+2]),vec3.set(o,this.positions[3*m],this.positions[3*m+1],this.positions[3*m+2]),vec2.set(a,n[2*d],n[2*d+1]),vec2.set(s,n[2*f],n[2*f+1]),vec2.set(l,n[2*m],n[2*m+1]);var v=r[0]-i[0],p=o[0]-i[0],g=r[1]-i[1],x=o[1]-i[1],w=r[2]-i[2],b=o[2]-i[2],T=s[0]-a[0],y=l[0]-a[0],S=s[1]-a[1],C=l[1]-a[1],E=1/(T*C-y*S);vec3.set(c,(C*v-S*p)*E,(C*g-S*x)*E,(C*w-S*b)*E),vec3.set(h,(T*p-y*v)*E,(T*x-y*g)*E,(T*b-y*w)*E),e[3*d+0]+=c[0],e[3*d+1]+=c[1],e[3*d+2]+=c[2],e[3*f+0]+=c[0],e[3*f+1]+=c[1],e[3*f+2]+=c[2],e[3*m+0]+=c[0],e[3*m+1]+=c[1],e[3*m+2]+=c[2],t[3*d+0]+=h[0],t[3*d+1]+=h[1],t[3*d+2]+=h[2],t[3*f+0]+=h[0],t[3*f+1]+=h[1],t[3*f+2]+=h[2],t[3*m+0]+=h[0],t[3*m+1]+=h[1],t[3*m+2]+=h[2]}this.tangents=new Float32Array(this.positions.length),this.bitangents=new Float32Array(this.positions.length);var _=vec3.create(),R=vec3.create(),D=vec3.create(),P=vec3.create();for(u=0;u<this.normals.length;u+=3){vec3.set(_,this.normals[u],this.normals[u+1],this.normals[u+2]),vec3.set(R,e[u],e[u+1],e[u+2]),vec3.scale(D,_,vec3.dot(_,R)),vec3.sub(D,R,D),vec3.normalize(D,D),this.tangents[u]=D[0],this.tangents[u+1]=D[1],this.tangents[u+2]=D[2],vec3.set(D,t[u],t[u+1],t[u+2]),vec3.cross(P,_,R);var M=vec3.dot(P,D)<0?-1:1;vec3.set(R,this.tangents[u],this.tangents[u+1],this.tangents[u+2]),vec3.cross(D,_,R),vec3.scale(D,D,M),vec3.normalize(D,D),this.bitangents[u]=D[0],this.bitangents[u+1]=D[1],this.bitangents[u+2]=D[2]}delete e,delete t},calculateBarycentric:function(){this.barycentric=new Float32Array(this.positions.length);for(var e=0;e<this.faces.length;e+=3){var t=this.faces[e],n=this.faces[e+1],i=this.faces[e+2];this.barycentric[3*t+0]=1,this.barycentric[3*t+1]=0,this.barycentric[3*t+2]=0,this.barycentric[3*n+0]=0,this.barycentric[3*n+1]=1,this.barycentric[3*n+2]=0,this.barycentric[3*i+0]=0,this.barycentric[3*i+1]=0,this.barycentric[3*i+2]=1}},recalculateBounds:function(){this.boundingBox=new BoundingBox,this.boundingSphere=new BoundingSphere;for(var e=0,t=this.positions.length;e<t;e+=3)this.boundingBox.encapsulatePoint(vec3.fromValues(this.positions[e+0],this.positions[e+1],this.positions[e+2])),this.boundingSphere.encapsulatePoint(vec3.fromValues(this.positions[e+0],this.positions[e+1],this.positions[e+2]))},generateEdges:function(){var n=this;function e(e,t){n.edges[n.faces[e]]||(n.edges[e]={}),n.edges[n.faces[e]][n.faces[t]]=!0}this.edges={};for(var t=0,i=this.faces.length;t<i;t+=3)e(t,t+1),e(t+1,t),e(t+1,t+2),e(t+2,t+1),e(t+2,t),e(t,t+2)}}),Mesh=FrakClass.extend({init:function(){this.submeshes=[],this.materials=[],this.boundingBox=new BoundingBox,this.boundingSphere=new BoundingSphere},addSubmesh:function(e,t){this.boundingBox.encapsulateBox(e.boundingBox),this.boundingSphere.encapsulateSphere(e.boundingSphere),this.submeshes.push(e),t&&(this.materials.push(t),e.materialIndex=this.materials.length-1)},getMaterial:function(e){return 0<=e&&e<this.materials.length&&this.materials[e]},setMaterial:function(e,t){if(e<0||e>=this.materials.length)throw"Material.setMaterial: index out of bounds.";this.materials[e]=t},addMaterial:function(e){return this.materials.push(e),this.materials.length-1},getPolycount:function(){var e=0;for(var t in this.submeshes)e+=this.submeshes[t].faces.length/3;return e},empty:function(){return 0===this.submeshes.length}}),Primitives={plane:function(e,t,n){var i=new Mesh,r=new Submesh;r.positions=[-.5*e,-.5*t,0,-.5*e,.5*t,0,.5*e,.5*t,0,.5*e,-.5*t,0],r.normals=[0,0,1,0,0,1,0,0,1,0,0,1],r.texCoords2D=[[0,0,0,1,1,1,1,0]],r.faces=[0,1,2,0,2,3],r.recalculateBounds(),i.addSubmesh(r,n);var o=new Node("Plane");return o.addComponent(new MeshComponent(i)),o.addComponent(new MeshRendererComponent),o},box:function(e,t,n){var i=new Mesh,o=new Submesh;o.positions=[],o.normals=[],o.texCoords2D=[[]];var a=vec3.create(),s=vec3.create(),l=vec3.create();function r(e,t,n,i){vec3.sub(s,t,e),vec3.sub(l,i,e),vec3.cross(a,s,l),vec3.negate(a,a),vec3.normalize(a,a);var r=o.positions.length/3;o.positions.push(e[0],e[1],e[2]),o.normals.push(a[0],a[1],a[2]),o.texCoords2D[0].push(0,1),o.positions.push(t[0],t[1],t[2]),o.normals.push(a[0],a[1],a[2]),o.texCoords2D[0].push(1,1),o.positions.push(n[0],n[1],n[2]),o.normals.push(a[0],a[1],a[2]),o.texCoords2D[0].push(1,0),o.positions.push(i[0],i[1],i[2]),o.normals.push(a[0],a[1],a[2]),o.texCoords2D[0].push(0,0),o.faces.push(r+0,r+3,r+2),o.faces.push(r+2,r+1,r+0)}var c=[vec3.fromValues(e[0]-t[0],e[1]-t[1],e[2]-t[2]),vec3.fromValues(e[0]+t[0],e[1]-t[1],e[2]-t[2]),vec3.fromValues(e[0]+t[0],e[1]+t[1],e[2]-t[2]),vec3.fromValues(e[0]-t[0],e[1]+t[1],e[2]-t[2]),vec3.fromValues(e[0]-t[0],e[1]-t[1],e[2]+t[2]),vec3.fromValues(e[0]+t[0],e[1]-t[1],e[2]+t[2]),vec3.fromValues(e[0]+t[0],e[1]+t[1],e[2]+t[2]),vec3.fromValues(e[0]-t[0],e[1]+t[1],e[2]+t[2])];r(c[0],c[1],c[2],c[3]),r(c[5],c[4],c[7],c[6]),r(c[4],c[0],c[3],c[7]),r(c[1],c[5],c[6],c[2]),r(c[4],c[5],c[1],c[0]),r(c[3],c[2],c[6],c[7]),o.calculateTangents(),o.recalculateBounds(),i.addSubmesh(o,n);var h=new Node("Box");return h.addComponent(new MeshComponent(i)),h.addComponent(new MeshRendererComponent),h},sphere:function(e,t,n,i){if(e<=0)throw"Primitives.sphere: invalid sphere radius";if(t<2||n<2)throw"Primitives.sphere: invalid sphere slices/stacks parameters (slices<2 or stacks<2)";var r=360/t,o=180/n,a=360/r*(180/o)*4,s=new Mesh,l=new Submesh;l.positions=new Float32Array(3*a),l.normals=new Float32Array(3*a),l.texCoords2D=[new Float32Array(2*a)];for(var c=Math.PI/180,h=0,u=vec3.create(),d=vec3.create(),f=vec3.create(),m=vec3.create(),v=0;v<180;v+=o)for(var p=0;p<360;p+=r)l.faces.push(h+0,h+1,h+2),l.faces.push(h+2,h+3,h+0),u[0]=e*Math.sin((v+o)*c)*Math.cos(c*(p+r)),u[1]=e*Math.cos((v+o)*c),u[2]=e*Math.sin((v+o)*c)*Math.sin(c*(p+r)),d[0]=e*Math.sin((v+o)*c)*Math.cos(p*c),d[1]=e*Math.cos((v+o)*c),d[2]=e*Math.sin((v+o)*c)*Math.sin(p*c),f[0]=e*Math.sin(v*c)*Math.cos(c*p),f[1]=e*Math.cos(v*c),f[2]=e*Math.sin(v*c)*Math.sin(c*p),m[0]=e*Math.sin(v*c)*Math.cos(c*(p+r)),m[1]=e*Math.cos(v*c),m[2]=e*Math.sin(v*c)*Math.sin(c*(p+r)),l.positions[3*(h+0)+0]=u[0],l.positions[3*(h+0)+1]=u[1],l.positions[3*(h+0)+2]=u[2],l.positions[3*(h+1)+0]=d[0],l.positions[3*(h+1)+1]=d[1],l.positions[3*(h+1)+2]=d[2],l.positions[3*(h+2)+0]=f[0],l.positions[3*(h+2)+1]=f[1],l.positions[3*(h+2)+2]=f[2],l.positions[3*(h+3)+0]=m[0],l.positions[3*(h+3)+1]=m[1],l.positions[3*(h+3)+2]=m[2],vec3.normalize(u,u),vec3.normalize(d,d),vec3.normalize(f,f),vec3.normalize(m,m),l.normals[3*(h+0)+0]=u[0],l.normals[3*(h+0)+1]=u[1],l.normals[3*(h+0)+2]=u[2],l.normals[3*(h+1)+0]=d[0],l.normals[3*(h+1)+1]=d[1],l.normals[3*(h+1)+2]=d[2],l.normals[3*(h+2)+0]=f[0],l.normals[3*(h+2)+1]=f[1],l.normals[3*(h+2)+2]=f[2],l.normals[3*(h+3)+0]=m[0],l.normals[3*(h+3)+1]=m[1],l.normals[3*(h+3)+2]=m[2],l.texCoords2D[0][2*(h+0)+0]=c*(p+r)/(2*Math.PI),l.texCoords2D[0][2*(h+0)+1]=(v+o)*c/Math.PI,l.texCoords2D[0][2*(h+1)+0]=p*c/(2*Math.PI),l.texCoords2D[0][2*(h+1)+1]=(v+o)*c/Math.PI,l.texCoords2D[0][2*(h+2)+0]=c*p/(2*Math.PI),l.texCoords2D[0][2*(h+2)+1]=v*c/Math.PI,l.texCoords2D[0][2*(h+3)+0]=c*(p+r)/(2*Math.PI),l.texCoords2D[0][2*(h+3)+1]=v*c/Math.PI,h+=4;l.calculateTangents(),l.recalculateBounds(),s.addSubmesh(l,i);var g=new Node("Sphere");return g.addComponent(new MeshComponent(s)),g.addComponent(new MeshRendererComponent),g},cone:function(e,t,n,i){if(e<=0)throw"Primitives.cone: invalid cone radius";if(0==t)throw"Primitives.cone: cannot create a cone with zero height";if(n<2)throw"Primitives.cone: invalid slices (slices<2)";var r=360/n,o=vec3.fromValues(0,t/2,0),a=vec3.fromValues(0,-t/2,0),s=360/r*6,l=new Mesh,c=new Submesh;c.positions=new Float32Array(3*s),c.normals=new Float32Array(3*s),c.texCoords2D=[new Float32Array(2*s)];for(var h=Math.PI/180,u=vec3.fromValues(a[0],.5*t-(e*e+t*t)/t,a[2]),d=0,f=vec3.create(),m=0;m<360;m+=r){c.faces.push(d+0,d+1,d+2),vec3.set(f,0,-1,0),c.positions[3*d+0]=e*Math.sin(m*h),c.positions[3*d+1]=a[1],c.positions[3*d+2]=e*Math.cos(m*h),c.normals[3*d+0]=f[0],c.normals[3*d+1]=f[1],c.normals[3*d+2]=f[2],c.texCoords2D[0][2*d+0]=m/360,c.texCoords2D[0][2*d+1]=1,d++,c.positions[3*d+0]=e*Math.sin((m+r)*h),c.positions[3*d+1]=a[1],c.positions[3*d+2]=e*Math.cos((m+r)*h),c.normals[3*d+0]=f[0],c.normals[3*d+1]=f[1],c.normals[3*d+2]=f[2],c.texCoords2D[0][2*d+0]=(m+r)/360,c.texCoords2D[0][2*d+1]=1,d++,c.positions[3*d+0]=a[0],c.positions[3*d+1]=a[1],c.positions[3*d+2]=a[2],c.normals[3*d+0]=f[0],c.normals[3*d+1]=f[1],c.normals[3*d+2]=f[2],c.texCoords2D[0][2*d+0]=m/360,c.texCoords2D[0][2*d+1]=0,d++,c.faces.push(d+0,d+1,d+2);var v=vec3.fromValues(e*Math.sin(m*h),a[1],e*Math.cos(m*h)),p=vec3.fromValues(e*Math.sin((m+r)*h),a[1],e*Math.cos((m+r)*h)),g=vec3.fromValues(o[0],o[1],o[2]);vec3.sub(f,v,u),vec3.normalize(f,f),c.positions[3*(d+0)+0]=v[0],c.positions[3*(d+0)+1]=v[1],c.positions[3*(d+0)+2]=v[2],c.normals[3*(d+0)+0]=f[0],c.normals[3*(d+0)+1]=f[1],c.normals[3*(d+0)+2]=f[2],c.texCoords2D[0][2*(d+0)+0]=m/360,c.texCoords2D[0][2*(d+0)+1]=1,vec3.sub(f,p,u),vec3.normalize(f,f),c.positions[3*(d+1)+0]=p[0],c.positions[3*(d+1)+1]=p[1],c.positions[3*(d+1)+2]=p[2],c.normals[3*(d+1)+0]=f[0],c.normals[3*(d+1)+1]=f[1],c.normals[3*(d+1)+2]=f[2],c.texCoords2D[0][2*(d+1)+0]=(m+r)/360,c.texCoords2D[0][2*(d+1)+1]=1,vec3.set(f,0,1,0),c.positions[3*(d+2)+0]=g[0],c.positions[3*(d+2)+1]=g[1],c.positions[3*(d+2)+2]=g[2],c.normals[3*(d+2)+0]=f[0],c.normals[3*(d+2)+1]=f[1],c.normals[3*(d+2)+2]=f[2],c.texCoords2D[0][2*(d+2)+0]=m/360,c.texCoords2D[0][2*(d+2)+1]=0,d+=3}c.calculateTangents(),c.recalculateBounds(),l.addSubmesh(c,i);var x=new Node("Cone");return x.addComponent(new MeshComponent(l)),x.addComponent(new MeshRendererComponent),x},text:function(e,t){var n=new Node("Text");return n.addComponent(new TextComponent(e,t)),n.addComponent(new TextRendererComponent),n},canvasBoard:function(e,t){var n=new Node("Text");return n.addComponent(new CanvasBoardComponent(e,t)),n.addComponent(new CanvasBoardRendererComponent),n}},CollisionOctreeNode=FrakClass.extend({init:function(e,t,n){this.parent=!1,this.depth=0,this.subnodes=!1,this.bounds=!1,n?(this.parent=n,this.root=n.root,this.depth=n.depth+1):(this.maxDepth=3,(this.root=this).nodes={},this.submeshes={},this.cache=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()]),this.faces=!1,this.setSize(e,t)},clone:function(e){var t=new CollisionOctreeNode(this.bounds.center,this.bounds.size[0],e||!1);if(t.depth=this.depth,this.nodes)for(var n in t.nodes={},this.nodes)t.nodes[n]=this.nodes[n];if(this.submeshes)for(var i in t.submeshes={},this.submeshes)t.submeshes[i]=this.submeshes[i];if(t.faces=this.faces,this.subnodes){t.subnodes=[];for(var r=0;r<this.subnodes.length;r++)t.subnodes.push(this.subnodes[r].clone(t))}return t},getNodeID:function(){var e="/",t="root";if(this.parent)for(var n in e=this.parent.getNodeID(),this.parent.subnodes)if(this.parent.subnodes[n]===this){t=n;break}return"{0}{1}/".format(e,t)},setSize:function(e,t){this.bounds=new BoundingBox(e,[t,t,t])},isLeaf:function(){return!1===this.subnodes},hasGeometry:function(){return!1!==this.faces},subdivide:function(){this.subnodes=[];var e=.5*this.bounds.size[0],t=.5*e,n=vec3.create();this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[t,t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[-t,t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[t,-t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[-t,-t,t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[t,t,-t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[-t,t,-t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[t,-t,-t]),e,this)),this.subnodes.push(new CollisionOctreeNode(vec3.add(n,this.bounds.center,[-t,-t,-t]),e,this))},optimize:function(){if(!this.isLeaf()){for(var e in this.subnodes)this.subnodes[e].optimize();var t=0;for(e=0;e<this.subnodes.length;e++)!this.subnodes[e].hasGeometry()&&this.subnodes[e].isLeaf()&&t++;8==t&&(delete this.subnodes,this.subnodes=!1)}},rayIntersectBounds:function(e){var t=e.getDirection(this.root.cache[0]),n=this.root.cache[1],i=this.root.cache[2];t[0]=1/t[0],t[1]=1/t[1],t[2]=1/t[2],n[0]=(this.bounds.min[0]-e.origin[0])*t[0],i[0]=(this.bounds.max[0]-e.origin[0])*t[0],n[1]=(this.bounds.min[1]-e.origin[1])*t[1],i[1]=(this.bounds.max[1]-e.origin[1])*t[1],n[2]=(this.bounds.min[2]-e.origin[2])*t[2],i[2]=(this.bounds.max[2]-e.origin[2])*t[2];var r=Math.max(Math.min(n[0],i[0]),Math.min(n[1],i[1]),Math.min(n[2],i[2])),o=Math.min(Math.max(n[0],i[0]),Math.max(n[1],i[1]),Math.max(n[2],i[2]));return!(o<0||o<r)&&(e.infinite?r:!(r*r>vec3.sqrDist(e.origin,e.destination)&&(e.origin[0]<this.bounds.min[0]||e.origin[1]<this.bounds.min[1]||e.origin[2]<this.bounds.min[2]||e.origin[0]>this.bounds.max[0]||e.origin[1]>this.bounds.max[1]||e.origin[2]>this.bounds.max[2])&&(e.destination[0]<this.bounds.min[0]||e.destination[1]<this.bounds.min[1]||e.destination[2]<this.bounds.min[2]||e.destination[0]>this.bounds.max[0]||e.destination[1]>this.bounds.max[1]||e.destination[2]>this.bounds.max[2]))&&r)},rayIntersectGeometry:function(e,t){if(!this.hasGeometry())return!1;var n={submesh:!1,node:!1,t:1/0,normal:vec3.create()},i=this.root.cache[0],r=this.root.cache[1],o=this.root.cache[2],a=mat4.create();for(var s in this.faces){var l=e.clone();mat4.isIdentity(this.root.nodes[s].transform.absolute)||(mat4.invert(a,this.root.nodes[s].transform.absolute),l.transform(a));var c=this.root.nodes[s].getComponent(MeshRendererComponent);for(var h in this.faces[s]){var u;if(c)for(var d in c.meshRenderers)if(c.meshRenderers[d].submesh==this.root.submeshes[h]){u=c.meshRenderers[d].visible;break}var f=this.faces[s][h],m=this.root.submeshes[h].positions;for(d=0;d<f.length;d+=3){i[0]=m[3*f[d]],i[1]=m[3*f[d]+1],i[2]=m[3*f[d]+2],r[0]=m[3*f[d+1]],r[1]=m[3*f[d+1]+1],r[2]=m[3*f[d+1]+2],o[0]=m[3*f[d+2]],o[1]=m[3*f[d+2]+1],o[2]=m[3*f[d+2]+2];var v=l.intersectTriangleDistanceOnly(i,r,o);!1!==v&&v<n.t&&(u||t)&&(n.t=v,n.submesh=this.root.submeshes[h],n.node=this.root.nodes[s],vec3.cross(n.normal,vec3.subtract(this.root.cache[3],r,i),vec3.subtract(this.root.cache[4],o,i)),vec3.normalize(n.normal,n.normal))}}}return n},getNodesWithGeometry:function(e,t){var n=this.rayIntersectBounds(e);if(!1!==n){if(this.hasGeometry()){for(var i=0;i<t.length&&!(t[i].t>n);i++);t.splice(i,0,{t:n,octreeNode:this})}if(!this.isLeaf())for(i=0;i<this.subnodes.length;i++)this.subnodes[i].getNodesWithGeometry(e,t)}},getNearestRayCollision:function(e,t,n){var i=[];this.getNodesWithGeometry(e,i);for(var r={t:1/0,octreeNode:!1,submesh:!1,node:!1,normal:!1},o=0;o<i.length;o++)if(!(!1!==r.octreeNode&&i[o].depth==r.octreeNode.depth&&i[o].t>r.t)){var a=i[o].octreeNode.rayIntersectGeometry(t,n);a.t<r.t&&(r.t=a.t,r.submesh=a.submesh,r.octreeNode=i[o].octreeNode,r.node=a.node,r.normal=a.normal)}return r}}),Component=Serializable.extend({init:function(){this._super(),this.updatePasses=1,this.started=!1,this.node=!1,this.enable()},excluded:function(){return["started","node"]},getScene:function(){return this.node.scene},enable:function(){this.enabled||this.onEnable(),this.enabled=!0},disable:function(){this.enabled&&this.onDisable(),this.enabled=!1},instantiate:function(){return this.clone()},onAdd:function(e){},onRemove:function(e){},onAddScene:function(e){},onRemoveScene:function(e){},onEnable:function(){},onDisable:function(){},onStart:function(e,t){},start:function(e,t){this.onStart(e,t)},onLoad:function(e,t){},onEnd:function(e,t){},onPreRender:function(e,t){},onPostRender:function(e,t){},onUpdateTransform:function(e){},onUpdate:function(e,t){}}),Transform=Component.extend({init:function(e){this._super(),this.relative=e||mat4.identity(mat4.create()),this.absolute=mat4.copy(mat4.create(),this.relative)},onAdd:function(e){e.transform=this},type:function(){return"Transform"},excluded:function(){return this._super().concat(["absolute"])},calculateRelativeFromAbsolute:function(e){if(e){var t=mat4.invert(mat4.create(),e);mat4.multiply(this.relative,this.absolute,t)}else mat4.copy(this.relative,this.absolute)},getPosition:function(e){return e||(e=vec3.create()),mat4.translation(e,this.absolute)},getRelativePosition:function(e){return e||(e=vec3.create()),mat4.translation(e,this.relative)},setPosition:function(e){mat4.fromRotationTranslation(this.relative,quat.fromMat4(quat.create(),this.relative),e)},getRotation:function(e){return e||(e=quat.create()),quat.fromMat4(e,this.absolute)},translate:function(e){this.relative=mat4.translate(this.relative,this.relative,e)},rotate:function(e,t){this.relative=mat4.rotate(this.relative,this.relative,e,t)},scale:function(e){this.relative=mat4.scale(this.relative,this.relative,e)},clone:function(){var e=new Transform;return e.relative=mat4.clone(this.relative),e.absolute=mat4.clone(this.absolute),e}}),CameraComponent=Component.extend({init:function(e,t){if(!e||!t)throw"CameraComponent can be initialized only with given viewMatrix and projectionMatrix. Normally one should create OrthoCamera or PerspectiveCamera instead";this._super(),this.camera=new Camera(e,t,new ForwardRenderStage)},excluded:function(){return this._super().concat(["camera"])},type:function(){return"CameraComponent"},onAddScene:function(e){e.scene.cameras.push(this.camera),e.scene.cameras.sort(function(e,t){return e.order-t.order}),this.useCameraViewMatrix()},onRemoveScene:function(e){for(var t=e.scene.cameras,n=0;n<t.length;n++)t[n]==this.camera&&(t.splice(n,1),n--)},onStart:function(e,t){this.initRenderStage(e,t)},onUpdateTransform:function(e){this.node.transform&&mat4.invert(this.camera.viewMatrix,this.node.transform.absolute)},lookAt:function(e,t){t||(t=[0,1,0]),mat4.lookAt(this.camera.viewMatrix,this.camera.getPosition(),e,t),this.useCameraViewMatrix()},setPosition:function(e){this.camera.setPosition(e),this.useCameraViewMatrix()},center:function(e){this.camera.center(e),this.useCameraViewMatrix()},fitToView:function(e){this.camera.fitToView(e),this.useCameraViewMatrix()},fitNodeToView:function(e){var n=new BoundingBox;e.onEachChild(function(e){if(e.getComponent(MeshComponent)){var t=e.getComponent(MeshComponent);n.encapsulateBox(t.mesh.boundingBox.transform(e.transform.absolute))}}),this.fitToView(n)},screenPointToViewportPoint:function(e){var t=vec2.create(),n=vec2.create();this.camera.target instanceof TargetScreen&&(n=this.camera.target.getPosition());var i=this.camera.target.getSize();return Math.abs(i[0])<EPSILON||Math.abs(i[1])<EPSILON||(t[0]=(e[0]-n[0])/i[0],t[1]=(e[1]-n[1])/i[1]),t},unprojectScreenPoint:function(e){var t=this.node.scene.camera.target.getSize(),n=vec2.create(),i=vec2.fromValues(e[0]-n[0],t[1]-e[1]+n[1]);if(Math.abs(t[0])<EPSILON||Math.abs(t[1])<EPSILON)return!1;var r=vec4.fromValues(i[0]/t[0]*2-1,i[1]/t[1]*2-1,2*e[2]-1,1),o=mat4.mul(mat4.create(),this.camera.projectionMatrix,this.camera.viewMatrix);return!!mat4.invert(o,o)&&(vec4.transformMat4(r,r,o),!(Math.abs(r[3])<EPSILON)&&(r[3]=1/r[3],vec3.fromValues(r[0]*r[3],r[1]*r[3],r[2]*r[3])))},screenPointToRay:function(e){var t=this.unprojectScreenPoint([e[0],e[1],0]),n=this.unprojectScreenPoint([e[0],e[1],1]);return!(!t||!n)&&new Ray(t,n)},worldToScreenPoint:function(e,t){t||(t=vec2.create());var n=this.camera.target.getSize(),i=mat4.mul(mat4.create(),this.camera.projectionMatrix,this.camera.viewMatrix),r=vec4.fromValues(e[0],e[1],e[2],1);return vec4.transformMat4(r,r,i),r[0]/=r[3],r[1]/=r[3],r[2]/=r[3],t[0]=Math.round((r[0]+1)/2*n[0]),t[1]=Math.round((1-r[1])/2*n[1]),t},useCameraViewMatrix:function(){this.node.transform&&(this.node.transform.absolute=mat4.invert(mat4.create(),this.camera.viewMatrix),this.node.calculateRelativeFromAbsolute())},initRenderStage:function(e,t){if(this.camera.target instanceof TargetScreen){var n=e.canvas;this.camera.target.setSize(n.width,n.height)}"forward"==t.options.renderer?("blended"!=t.options.transparencyMode&&"stochastic"!=t.options.transparencyMode||this.camera.renderStage.addStage(new OITPostProcess),!0===t.options.ssao&&this.camera.renderStage.addStage(new SSAOPostProcess)):"deferred"==t.options.renderer&&(delete this.camera.renderStage,this.camera.renderStage=new DeferredRenderStage,this.camera.renderStage.addStage(new OITPostProcess)),!0===t.options.antialias&&this.camera.renderStage.addStage(new AntiAliasPostProcess),this.camera.renderStage.start(e,t,this.camera)},onContextRestored:function(e){this.camera.renderStage=new ForwardRenderStage,this.initRenderStage(e,e.engine)}}),PerspectiveCamera=CameraComponent.extend({init:function(e,t,n,i){e||(e=45),n||(n=.3),i||(i=1e3),t||(t=4/3),this.fov=e,this.aspect=t,this.near=n,this.far=i;var r=mat4.create();mat4.lookAt(r,[0,0,-100],[0,0,0],[0,1,0]),this._super(r,this.calculatePerspective()),this.camera.near=this.near,this.camera.far=this.far},type:function(){return"PerspectiveCamera"},onStart:function(e,t){this.aspect||this.setAspectRatio(e.canvas.width/e.canvas.height),this._super(e,t)},setClipPlanes:function(e,t){this.near=e,this.far=t,this.camera.near=this.near,this.camera.far=this.far,this.camera.projectionMatrix=this.calculatePerspective()},setAspectRatio:function(e){this.aspect=e,this.camera.projectionMatrix=this.calculatePerspective()},setVerticalFieldOfView:function(e){this.fov=e,this.camera.projectionMatrix=this.calculatePerspective()},setHorizontalFieldOfView:function(e){e=e*(2*Math.PI)/360;var t=Math.tan(e/2)/this.aspect;this.fov=2*Math.atan(t)*180/Math.PI,this.camera.projectionMatrix=this.calculatePerspective()},getVerticalFieldOfView:function(){return 180*this.camera.getFieldOfView()/Math.PI},getHorizontalFieldOfView:function(){var e=Math.tan(.5*this.camera.getFieldOfView()),t=this.aspect*e;return 180*(2*Math.atan(t))/Math.PI},calculatePerspective:function(){var e=mat4.create(),t=this.aspect;return t||(t=1),mat4.perspective(e,this.fov*(2*Math.PI)/360,t,this.near,this.far),e}}),OrthoCamera=CameraComponent.extend({init:function(e,t,n,i,r,o){e||(e=0),t||(t=512),n||(n=512),i||(i=0),r||(r=-100),o||(o=100);var a=mat4.ortho(mat4.create(),e,t,n,i,r,o);this._super(mat4.identity(mat4.create()),a)},type:function(){return"OrthoCamera"}}),MeshComponent=Component.extend({init:function(e){this.mesh=e,this._super()},type:function(){return"MeshComponent"},instantiate:function(){var e=this._super();return e.mesh=this.mesh,e}}),RendererComponent=Component.extend({init:function(){this._super(),this.castShadows=!0,this.receiveShadows=!0,this.lightContribution=1,this.reflectivity=0},type:function(){return"RendererComponent"},instantiate:function(){var e=this._super();return e.castShadows=this.castShadows,e.receiveShadows=this.receiveShadows,e.lightContribution=this.lightContribution,e.reflectivity=this.reflectivity,e},onContextRestored:function(e){}}),MeshRendererComponent=RendererComponent.extend({init:function(){this.meshRenderers=[],this._super()},type:function(){return"MeshRendererComponent"},excluded:function(){return this._super().concat(["meshRenderers"])},createRenderer:function(e,t,n,i){return new SubmeshRenderer(e,t,n,i)},onStart:function(e,t){this.updateRenderers(e,t)},addRenderers:function(o,e){var a=this;this.node.onEachComponent(function(e){if(e instanceof MeshComponent)for(var t=0;t<e.mesh.submeshes.length;t++){var n=e.mesh.submeshes[t],i=e.mesh.getMaterial(n.materialIndex);if(i){if(0!=n.positions.length&&0!=n.faces.length){var r=a.createRenderer(o,a.node.transform.absolute,n,i);a.getScene().dynamicSpace.addRenderer(r),a.meshRenderers.push(r),a.enabled||(r.visible=!1)}}else console.warn("Failed to find submesh material: ",e.node.name,e.node)}})},removeRenderers:function(){for(var e=0;e<this.meshRenderers.length;e++)this.getScene().dynamicSpace.removeRenderer(this.meshRenderers[e])},updateRenderers:function(e,t){this.removeRenderers(),this.addRenderers(e,t)},onEnd:function(e){this.removeRenderers()},onUpdateTransform:function(e){for(var t,n=this.castShadows,i=this.node.layer,r=this.receiveShadows,o=this.lightContribution,a=this.reflectivity,s=0,l=this.meshRenderers.length;s<l;++s)(t=this.meshRenderers[s]).layer=i,t.castShadows=n,t.receiveShadows=r,t.lightContribution=o,t.reflectivity=a,t.setMatrix(e)},onEnable:function(){for(var e=0;e<this.meshRenderers.length;++e)this.meshRenderers[e].visible=!0},onDisable:function(){for(var e=0;e<this.meshRenderers.length;++e)this.meshRenderers[e].visible=!1},getBoundingBox:function(e){for(var t=new BoundingBox,n=0;n<this.meshRenderers.length;++n)e&&!this.meshRenderers[n].visible||t.encapsulateBox(this.meshRenderers[n].globalBoundingBox);return t},getBoundingSphere:function(e){for(var t=new BoundingSphere,n=0;n<this.meshRenderers.length;++n)e&&!this.meshRenderers[n].visible||t.encapsulateSphere(this.meshRenderers[n].globalBoundingSphere);return t},setTransparency:function(e){e=!!e;for(var t=0;t<this.meshRenderers.length;++t)this.meshRenderers[t].transparent=e},getSubmeshRenderer:function(e){for(var t=0;t<this.meshRenderers.length;++t)if(this.meshRenderers[t].submesh===e)return this.meshRenderers[t];return!1},onContextRestored:function(e){this._super(e);for(var t=0;t<this.meshRenderers.length;++t)this.meshRenderers[t].onContextRestored(e)}}),SkyboxComponent=Component.extend({init:function(){this._super()},type:function(){return"SkyboxComponent"},setup:function(e,t,n){this.cubeTexture=e.texturesManager.addCube([n[2].source,n[3].source,n[1].source,n[0].source,n[4].source,n[5].source]);var i=1;t.scene&&t.scene.camera&&t.scene.camera.far&&(i=Math.sqrt(t.scene.camera.far*t.scene.camera.far/3)),this.meshNode=Primitives.box([0,0,0],[i,i,i],new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("skybox")),{},[new Sampler("skybox0",this.cubeTexture)])),this.node.addNode(this.meshNode);var r=this.meshNode.getComponent(MeshRendererComponent);r.castShadows=!1,r.disable(),r.addRenderers(t.context,t)}}),TextRendererComponent=MeshRendererComponent.extend({type:function(){return"TextRendererComponent"},onContextRestored:function(e){this._super(e);var t=this.node.getComponent(TextComponent);t&&t.updateText()}}),CanvasBoardRendererComponent=MeshRendererComponent.extend({type:function(){return"CanvasBoardRendererComponent"}}),TextComponent=MeshComponent.extend({init:function(e,t){this._super(new Mesh),this.context=!1,this.material=!1,this.texture=!1,this.wrap=t?0:t,this.sampler=new Sampler("diffuse0",null),this.lines=[],this.color=new Color(0,0,0,1),this.fontSize=56,this.style="normal",this.variant="normal",this.weight="normal",this.family="monospace",this.backgroundColor=new Color(0,0,0,0),this.outline=!0,this.outlineColor=new Color(1,1,1,1),this.outlineWidth=5,this.textLength=0,this.setText(e)},excluded:function(){return this._super().concat(["material","texture","sampler","context"])},type:function(){return"TextComponent"},applyTextStyles:function(e){this.outline&&(e.strokeStyle=this.outlineColor.toString(),e.lineWidth=this.outlineWidth),e.fillStyle=this.color.toString(),e.textBaseline="middle",e.textAlign="center",e.font=this.font},updateFont:function(){this.font="","normal"!=this.style&&(this.font+=this.style+" "),"normal"!=this.variant&&(this.font+=this.variant+" "),"normal"!=this.weight&&(this.font+=this.weight+" "),this.font+=this.fontSize+"px "+this.family},updateText:function(){if(this.context&&0!=this.text.length){var e=this.node.getComponent(TextRendererComponent);if(e){this.updateFont();var t=document.createElement("canvas"),n=t.getContext("2d");this.applyTextStyles(n),this.wrap?this.lines=this.getLines(this.text):this.textLength=n.measureText(this.text).width,t.width=nextHighestPowerOfTwo(n.measureText(this.text).width),t.height=nextHighestPowerOfTwo(2*this.fontSize),n.fillStyle=this.backgroundColor.toString(),n.fillRect(0,0,t.width,t.height),this.applyTextStyles(n),this.outline&&n.strokeText(this.text,t.width/2,t.height/2),n.fillText(this.text,t.width/2,t.height/2),this.texture.setImage(this.context,t);var i=t.width/t.height,r=this.mesh.submeshes[0];if(r.positions[0]=-.5*i,r.positions[1]=-.5,r.positions[3]=-.5*i,r.positions[4]=.5,r.positions[6]=.5*i,r.positions[7]=.5,r.positions[9]=.5*i,r.positions[10]=-.5,r.recalculateBounds(),0<e.meshRenderers.length)e.meshRenderers[0].buffer.update("position",r.positions)}}},onStart:function(e,t){this.context=e,this.material=new Material(t.assetsManager.addShaderSource("transparent"),{diffuse:new UniformColor({r:1,g:1,b:1,a:1})},[this.sampler]),this.material.shader.requirements.transparent=!0,this.material.name="TextComponentMaterial",this.texture=new Texture(e),this.texture.mipmapped=!0,this.texture.clampToEdge=!0,this.sampler.texture=this.texture;var n=new Submesh;n.positions=new Float32Array(12),n.normals=[0,0,1,0,0,1,0,0,1,0,0,1],n.texCoords2D=[[0,0,0,1,1,1,1,0]],n.faces=[0,1,2,0,2,3],n.recalculateBounds(),this.mesh.addSubmesh(n,this.material),this.updateText()},setText:function(e){this.text=String(e),this.updateText()},getLines:function(e,t){var n=e.split(" "),i=[],r=n[0];if(t<=0)return n;if(n.length<=t)return n;for(var o=1;o<n.length;o++)r.length>e.length/t?(i.push(r),r=""):r+=" "+n[o];return i.push(r),i},onContextRestored:function(e){this.texture&&delete this.texture,this.texture=new Texture(e),this.texture.mipmapped=!0,this.texture.clampToEdge=!0,this.sampler.texture=this.texture}}),LineRendererComponent=RendererComponent.extend({init:function(e){this._super(),this.lightContribution=0,this.receiveShadows=!1,this.castShadows=!1,this.color=new UniformColor(e instanceof Color?e:new Color(.5,.5,.5,1)),this.renderer=null,this.damaged=!0,this.material=new Material(null,{diffuse:this.color},[]),this.overlay=!1,this.faces=[],this.vertices=[]},type:function(){return"LineRendererComponent"},excluded:function(){return this._super().concat(["damaged","renderer","material"])},onStart:function(e,t){this.material.shader=t.assetsManager.addShaderSource("transparent"),this.material.samplers=[new Sampler("diffuse0",t.WhiteTexture)],this.renderer||(this.renderer=new LineRenderer(e,this.node.transform.absolute,this.material)),this.getScene().dynamicSpace.addRenderer(this.renderer)},onEnd:function(e){this.renderer&&this.getScene().dynamicSpace.removeRenderer(this.renderer),delete this.renderer,this.renderer=null},onUpdate:function(e,t){this.damaged&&this.rebuild(e)},onUpdateTransform:function(e){this.renderer&&(this.renderer.layer=this.node.layer,this.renderer.castShadows=this.castShadows,this.renderer.receiveShadows=this.receiveShadows,this.renderer.lightContribution=this.lightContribution,this.renderer.setMatrix(e))},onEnable:function(){this.renderer&&(this.renderer.visible=!0)},onDisable:function(){this.renderer&&(this.renderer.visible=!1)},onPostRender:function(e,t){this.overlay&&this.renderer&&this.enabled&&(e.projection.push(),e.modelview.push(),e.projection.load(t.projectionMatrix),e.modelview.load(t.viewMatrix),e.modelview.multiply(this.node.transform.absolute),this.material.bind(),this.renderer.renderGeometry(e,this.material.shader),this.material.unbind(),e.projection.pop(),e.modelview.pop())},rebuild:function(e){0!=this.vertices.length&&0!=this.faces.length&&(this.renderer||(this.renderer=new LineRenderer(e,this.node.transform.absolute,this.material)),this.renderer.buffer.updateFaces(this.faces),this.renderer.buffer.has("position")?this.renderer.buffer.update("position",this.vertices):this.renderer.buffer.add("position",this.vertices,3),this.damaged=!1)},clear:function(e){this.faces=[],this.vertices=[],this.damaged=!0},addLine:function(e,t){var n=this.vertices.length/3,i={vertexOffset:n};return this.vertices.push(e[0],e[1],e[2],t[0],t[1],t[2]),this.faces.push(n,n+1),this.damaged=!0,i},updateLine:function(e,t,n){var i=function(e,t,n){e[3*t+0]=n[0],e[3*t+1]=n[1],e[3*t+2]=n[2]};i(this.vertices,e.vertexOffset+0,t),i(this.vertices,e.vertexOffset+1,n),this.damaged=!0},addTriangle:function(e,t,n){this.addLine(e,t),this.addLine(t,n),this.addLine(n,e),this.damaged=!0},addBox:function(e){if(!(e instanceof BoundingBox))throw"LineRendererComponent.addBox expects box to be of type BoundingBox";this.addLine(e.min,[e.min[0],e.min[1],e.max[2]]),this.addLine(e.min,[e.min[0],e.max[1],e.min[2]]),this.addLine(e.min,[e.max[0],e.min[1],e.min[2]]),this.addLine(e.max,[e.max[0],e.min[1],e.max[2]]),this.addLine(e.max,[e.max[0],e.max[1],e.min[2]]),this.addLine(e.max,[e.min[0],e.max[1],e.max[2]]),this.addLine([e.min[0],e.max[1],e.min[2]],[e.min[0],e.max[1],e.max[2]]),this.addLine([e.min[0],e.max[1],e.max[2]],[e.min[0],e.min[1],e.max[2]]),this.addLine([e.min[0],e.min[1],e.max[2]],[e.max[0],e.min[1],e.max[2]]),this.addLine([e.max[0],e.min[1],e.max[2]],[e.max[0],e.min[1],e.min[2]]),this.addLine([e.max[0],e.min[1],e.min[2]],[e.max[0],e.max[1],e.min[2]]),this.addLine([e.max[0],e.max[1],e.min[2]],[e.min[0],e.max[1],e.min[2]]),this.damaged=!0},addGrid:function(e,t,n){var i=[t[0]/2,t[1]/2];n||(n=[1,1]);for(var r=-i[0];r<=i[0];r++)this.addLine([r*n[0]+e[0],e[1],-i[1]*n[1]+e[2]],[r*n[0]+e[0],e[1],i[1]*n[1]+e[2]]);for(r=-i[1];r<=i[1];r++)this.addLine([-i[0]*n[0]+e[0],e[1],r*n[1]+e[2]],[i[0]*n[0]+e[0],e[1],r*n[1]+e[2]]);this.damaged=!0},onContextRestored:function(e){this._super(e),this.renderer&&(this.damaged=!0,delete this.renderer.buffer,this.renderer.buffer=new LinesRenderBuffer(e),this.rebuild(e))}}),CanvasBoardComponent=MeshComponent.extend({init:function(e,t){this._super(new Mesh),this.width=e,this.height=t||e,this.context=!1,this.material=!1,this.texture=!1,this.canvasContext=!1,this.canvas=!1,this.sampler=new Sampler("diffuse0",null)},excluded:function(){return this._super().concat(["material","texture","sampler","context"])},type:function(){return"CanvasBoardComponent"},createContext:function(){if(this.context){var e=this.node.getComponent(CanvasBoardRendererComponent);if(e){this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvasContext.fillStyle="white",this.canvasContext.fillRect(0,0,this.canvas.width,this.canvas.height);var t=this.mesh.submeshes[0];if(t.positions[0]=-.5,t.positions[1]=-.5,t.positions[3]=-.5,t.positions[4]=.5,t.positions[6]=.5,t.positions[7]=.5,t.positions[9]=.5,t.positions[10]=-.5,t.recalculateBounds(),this.texture.setImage(this.context,this.canvas),0<e.meshRenderers.length)e.meshRenderers[0].buffer.update("position",t.positions)}}},updateImage:function(){this.texture.setImage(this.context,this.canvas)},onStart:function(e,t){this.context=e,this.material=new Material(t.assetsManager.addShaderSource("transparent"),{diffuse:new UniformColor({r:1,g:1,b:1,a:1})},[this.sampler]),this.material.shader.requirements.transparent=!0,this.material.name="CanvasBoardMaterial",this.texture=new Texture(e),this.texture.mipmapped=!0,this.texture.clampToEdge=!0,this.sampler.texture=this.texture;var n=new Submesh;n.positions=new Float32Array(12),n.normals=[0,0,1,0,0,1,0,0,1,0,0,1],n.texCoords2D=[[0,0,0,1,1,1,1,0]],n.faces=[0,1,2,0,2,3],n.recalculateBounds(),this.mesh.addSubmesh(n,this.material),this.createContext()},getCanvasContext:function(){return this.canvasContext}}),Controller=Component.extend({init:function(){this._super(),this.delta=vec2.create(),this.dragDelta=vec2.create(),this.position=!1,this.oldPosition=!1,this.startDragPosition=!1,this.buttons=[!1,!1,!1]},excluded:function(){return this._super().concat(["delta","dragDelta","position","oldPosition","startDragPosition","buttons","keyStates"])},type:function(){return"Controller"},onAddScene:function(e){e.scene.engine.input.registerController(this)},onRemoveScene:function(e){e.scene.engine.input.unregisterController(this)},bind:function(e,t,n){this.node&&e&&t&&n&&this.node.scene.engine.input.bind(e,t,n)},getPriority:function(e){return 0},onStart:function(e,t){for(var n=0;n<this.buttons.length;n++)this.buttons[n]=!1},onUpdate:function(e){},onKeyStateChange:function(e,t){},onKeyDown:function(e){},onKeyUp:function(e){},onButtonDown:function(e,t,n){},onButtonUp:function(e,t,n){},onClick:function(e,t,n){},onMouseMove:function(e,t,n){},onMouseDown:function(e,t,n){this.buttons[t]=!0},onMouseUp:function(e,t,n){this.buttons[t]=!1}}),FlightController=Controller.extend({init:function(){this._super(),this.rotation=vec3.create(),this.velocity=vec3.fromValues(0,0,0),this.angularVelocity=vec3.fromValues(0,0,0),this.acceleration=.2,this.deceleration=.2,this.friction=.01,this.rotationAcceleration=.001,this.rotationFriction=.1,this.tmpRotation=quat.create(),this.tmpImpulse=vec3.create()},type:function(){return"FlightController"},onAdd:function(){this._super(),this.bind("W","accelerate",this),this.bind("S","decelerate",this),this.bind("A","strafeLeft",this),this.bind("D","strafeRight",this),this.bind("C","moveDown",this),this.bind("space","moveUp",this),this.bind("up_arrow","accelerate",this),this.bind("down_arrow","decelerate",this),this.bind("left_arrow","strafeLeft",this),this.bind("right_arrow","strafeRight",this)},accelerate:function(e){this.addLocalImpulse([0,0,-this.acceleration*e])},decelerate:function(e){this.addLocalImpulse([0,0,this.deceleration*e])},strafeLeft:function(e){this.addLocalImpulse([-this.deceleration*e,0,0])},strafeRight:function(e){this.addLocalImpulse([this.deceleration*e,0,0])},moveUp:function(e){this.addWorldImpulse([0,this.acceleration*e,0])},moveDown:function(e){this.addWorldImpulse([0,-this.acceleration*e,0])},addWorldImpulse:function(e){vec3.add(this.velocity,this.velocity,e)},addLocalImpulse:function(e){quat.fromMat4(this.tmpRotation,this.node.transform.absolute),vec3.transformQuat(this.tmpImpulse,e,this.tmpRotation),vec3.add(this.velocity,this.velocity,this.tmpImpulse)},onStep:function(e,t,n){return!0},onUpdate:function(e,t){this._super(e,t);var n=e.fps.getDelta(),i=1+this.friction*n;vec3.scale(this.velocity,this.velocity,1/i);var r=1+this.rotationFriction*n;vec3.scale(this.angularVelocity,this.angularVelocity,1/r);var o=vec3.scale(vec3.create(),this.velocity,n),a=vec3.scale(vec3.create(),this.angularVelocity,n);vec3.add(this.rotation,this.rotation,a);var s=quat.create();quat.rotateY(s,s,this.rotation[1]),quat.rotateX(s,s,this.rotation[0]);var l=mat4.translation(vec3.create(),this.node.transform.relative),c=vec3.add(vec3.create(),o,l);this.onStep(l,c,s)&&mat4.fromRotationTranslation(this.node.transform.relative,s,c)},onMouseMove:function(e,t,n){if(0===t){var i=vec3.create(),r=this.rotationAcceleration;vec3.scale(i,[-n[1],-n[0],0],r),vec3.add(this.angularVelocity,this.angularVelocity,i)}}}),OrbitController=FlightController.extend({init:function(){this._super(),this.target=new TypeReference("Transform"),this.panButton=2,this.rotateButton=0,this.position=vec3.create(),this.velocity=vec3.create(),this.pan=vec3.create(),this.minimumPan=[-100,-100,-100],this.maximumPan=[100,100,100],this.panXAxis=[1,0,0],this.panYAxis=[0,0,1],this.panSpeed=.05,this.rotation=vec3.create(),this.angularVelocity=vec3.create(),this.minimumPitch=-Math.PI/2.2,this.maximumPitch=0,this.rotationAcceleration=.012,this.rotationFriction=.1,this.lastPinch=0,this.zoomSpeed=1,this.doZoomIn=!1,this.doZoomOut=!1,this.distance=5,this.minimumDistance=2.5,this.maximumDistance=7.5,this.distanceSteps=4,this.direction=vec3.create(),this.cameraPosition=vec3.create(),this.targetPosition=vec3.create(),this.lookat=mat4.create(),this.tmpRotation=quat.create(),this.cbOnChange},excluded:function(){return this._super().concat(["velocity","angularVelocity","doZoomIn","doZoomOut","direction","cameraPosition","targetPosition","lookat"])},type:function(){return"OrbitController"},onAdd:function(){this._super(),this.bind("W","zoomIn",this),this.bind("S","zoomOut",this),this.bind("A","rotateLeft",this),this.bind("D","rotateRight",this),this.bind("E","rotateUp",this),this.bind("Q","rotateDown",this)},onChange:function(e,t){this.cbOnChange&&"function"==typeof this.cbOnChange&&this.cbOnChange(e,t)},getZoom:function(){return(this.distance-this.minimumDistance)/(this.maximumDistance-this.minimumDistance)},setZoom:function(e){e=Math.max(0,e);var t=this.maximumDistance-this.minimumDistance;this.distance=Math.min(this.minimumDistance+t*e,this.maximumDistance),this.onChange("distance",this.distance)},setDistance:function(e){this.distance=Math.min(Math.max(e,this.minimumDistance),this.maximumDistance),this.onChange("distance",this.distance)},zoomIn:function(e){this.enabled&&(e||(e=1),this.distance-=e*this.zoomSpeed*(this.maximumDistance-this.minimumDistance)/this.distanceSteps,this.distance<this.minimumDistance&&(this.distance=this.minimumDistance),this.onChange("distance",this.distance))},zoomOut:function(e){this.enabled&&(e||(e=1),this.distance+=e*this.zoomSpeed*(this.maximumDistance-this.minimumDistance)/this.distanceSteps,this.distance>this.maximumDistance&&(this.distance=this.maximumDistance),this.onChange("distance",this.distance,e*this.zoomSpeed*(this.maximumDistance-this.minimumDistance)/this.distanceSteps))},rotateLeft:function(e){this.accelerate([0,-this.rotationAcceleration,0],e)},rotateRight:function(e){this.accelerate([0,this.rotationAcceleration,0],e)},rotateUp:function(e){this.accelerate([this.rotationAcceleration,0,0],e)},rotateDown:function(e){this.accelerate([-this.rotationAcceleration,0,0],e)},accelerate:function(e,t){this.enabled&&(vec3.scale(e,e,t),vec3.add(this.angularVelocity,this.angularVelocity,e),this.onChange("accelerate",e))},onUpdate:function(e,t){this._super(e,t),this.target.isNull()||(vec3.add(this.rotation,this.rotation,this.angularVelocity),quat.identity(this.tmpRotation),quat.rotateY(this.tmpRotation,this.tmpRotation,this.rotation[1]),quat.rotateX(this.tmpRotation,this.tmpRotation,this.rotation[0]),vec3.set(this.direction,0,0,1),vec3.transformQuat(this.direction,this.direction,this.tmpRotation),vec3.scale(this.direction,this.direction,this.distance),mat4.translation(this.targetPosition,this.target.value.absolute),vec3.add(this.cameraPosition,this.targetPosition,this.direction),vec3.add(this.targetPosition,this.targetPosition,this.pan),vec3.add(this.cameraPosition,this.cameraPosition,this.pan),mat4.lookAt(this.lookat,this.cameraPosition,this.targetPosition,[0,1,0]),mat4.invert(this.node.transform.absolute,this.lookat),this.node.calculateRelativeFromAbsolute(),this.doZoomIn&&this.zoomIn(),this.doZoomOut&&this.zoomOut())},onMouseMove:function(e,t,n,i){!1!==this.rotateButton&&t==this.rotateButton&&this.rotate(n[1],n[0]),!1!==this.panButton&&t==this.panButton&&this.move(n[0],n[1])},onPan:function(e,t){this.move(t[0],t[1])},rotate:function(e,t){var n=vec3.create();vec3.scale(n,[-e,-t,0],this.rotationAcceleration),vec3.add(this.rotation,this.rotation,n),this.rotation[0]=Math.max(this.minimumPitch,this.rotation[0]),this.rotation[0]=Math.min(this.maximumPitch,this.rotation[0]),this.onChange("rotate",e,t)},move:function(e,t){var n=vec3.create();vec3.scale(n,this.panXAxis,-e),vec3.add(n,n,vec3.scale(vec3.create(),this.panYAxis,-t)),n=vec3.scale(n,n,this.distance/900);var i=quat.fromMat4(quat.create(),this.node.transform.absolute),r=vec3.fromValues(0,0,1);vec3.transformQuat(r,r,i);var o=Math.atan2(r[2],r[0]);o-=Math.PI/2,quat.identity(i),quat.rotateY(i,i,o),quat.conjugate(i,i),quat.normalize(i,i),vec3.transformQuat(n,n,i),vec3.add(this.pan,this.pan,n),this.pan[0]=Math.max(this.pan[0],this.minimumPan[0]),this.pan[1]=Math.max(this.pan[1],this.minimumPan[1]),this.pan[2]=Math.max(this.pan[2],this.minimumPan[2]),this.pan[0]=Math.min(this.pan[0],this.maximumPan[0]),this.pan[1]=Math.min(this.pan[1],this.maximumPan[1]),this.pan[2]=Math.min(this.pan[2],this.maximumPan[2]),this.onChange("move",e,t)},onPinch:function(e,t){t=this.getZoom()+(1-t),this.setZoom(t)},onRotate:function(e,t,n,i){var r=t*(Math.PI/180);this.rotation[1]=this.rotation[1]+r,this.onChange("rotate",t)},onMouseWheel:function(e,t,n,i,r){n<0?this.zoomIn():this.zoomOut()}}),SmoothOrbitController=OrbitController.extend({init:function(){this._super(),this.speed=5,this.currentRotation=vec2.create(),this.currentDistance=this.distance,this.enableRotatingX=!0,this.enableRotatingY=!0},excluded:function(){return this._super().concat(["currentRotation","currentDistance","tmpRotation"])},type:function(){return"SmoothOrbitController"},onUpdate:function(e,t){if(!this.target.isNull()){var n=e.fps.getDelta()/1e3*this.speed;n=Math.min(n,1),this.enableRotatingX&&(this.currentRotation[0]=lerp(this.currentRotation[0],this.rotation[0],n)),this.enableRotatingY&&(this.currentRotation[1]=lerp(this.currentRotation[1],this.rotation[1],n)),this.currentDistance=lerp(this.currentDistance,this.distance,n),quat.identity(this.tmpRotation),quat.rotateY(this.tmpRotation,this.tmpRotation,this.currentRotation[1]),quat.rotateX(this.tmpRotation,this.tmpRotation,this.currentRotation[0]),vec3.set(this.direction,0,0,1),vec3.transformQuat(this.direction,this.direction,this.tmpRotation),vec3.scale(this.direction,this.direction,this.currentDistance),mat4.translation(this.targetPosition,this.target.value.absolute),vec3.add(this.cameraPosition,this.targetPosition,this.direction),vec3.add(this.targetPosition,this.targetPosition,this.pan),vec3.add(this.cameraPosition,this.cameraPosition,this.pan),mat4.lookAt(this.lookat,this.cameraPosition,this.targetPosition,[0,1,0]),mat4.invert(this.node.transform.absolute,this.lookat),this.node.calculateRelativeFromAbsolute(),this.doZoomIn&&this.zoomIn(),this.doZoomOut&&this.zoomOut()}}}),Billboard=Component.extend({init:function(e,t,n){this._super(),this.cameraToLookAt=e,this.smoothRotation=!0===t,this.rotationSpeed=4,n&&(this.rotationSpeed=n),this.cacheMat4=[mat4.create()],this.cacheQuat=[quat.create(),quat.create()],this.cacheVec3=[vec3.create(),vec3.create()]},type:function(){return"Billboard"},onUpdate:function(e){if(this.enabled){if(!(this.cameraToLookAt instanceof Camera))throw"Billboard.cameraToLookAt is not an instance of Camera";var t=e.fps.getDelta()/1e3,n=mat4.invert(this.cacheMat4[0],this.cameraToLookAt.viewMatrix),i=quat.fromMat4(this.cacheQuat[0],n);if(this.smoothRotation){var r=quat.fromMat4(this.cacheQuat[1],this.node.transform.relative);quat.slerp(i,r,i,this.rotationSpeed*t)}quat.normalize(i,i);var o=mat4.translation(this.cacheVec3[0],this.node.transform.relative),a=mat4.getScale(this.cacheVec3[1],this.node.transform.relative);mat4.fromRotationTranslationScale(this.node.transform.relative,i,o,a)}}}),VerticalBillboard=Billboard.extend({init:function(e,t,n){this._super(e,t,n)},type:function(){return"VerticalBillboard"},onUpdate:function(e){if(!(this.cameraToLookAt instanceof Camera))throw"VerticalBillboard.cameraToLookAt is not an instance of Camera";var t=e.fps.getDelta()/1e3,n=mat4.invert(this.cacheMat4[0],this.cameraToLookAt.viewMatrix),i=quat.fromMat4(this.cacheQuat[0],n);if(quat.multiply(i,i,quat.euler(this.cacheQuat[1],0,180,0)),this.smoothRotation){i[0]=0,i[2]=0,quat.normalize(i,i);var r=quat.fromMat4(this.cacheQuat[1],this.node.transform.relative);quat.slerp(i,r,i,this.rotationSpeed*t)}quat.normalize(i,i);var o=mat4.translation(this.cacheVec3[0],this.node.transform.relative),a=mat4.getScale(this.cacheVec3[1],this.node.transform.relative);mat4.fromRotationTranslationScale(this.node.transform.relative,i,o,a)}}),Collider=Component.extend({init:function(){this._super()},type:function(){return"Collider"},onStart:function(e,t){this.getScene().dynamicSpace.addCollider(this)},onEnd:function(e,t){this.getScene().dynamicSpace.removeCollider(this)},rayTest:function(e,t,n){return!1}}),MeshCollider=Collider.extend({init:function(){this._super()},type:function(){return"MeshCollider"},rayTest:function(e,t,n){if(!this.enabled)return!1;var i=this.node.getComponent(MeshRendererComponent);if(!i)return!1;for(var r=i.meshRenderers,o=vec3.create(),a=vec3.create(),s=vec3.create(),l=!1,c=0;c<r.length;c++)if((n||r[c].visible)&&e.intersectBoundingVolume(r[c].globalBoundingBox)){var h=e.clone(),u=mat4.invert(mat4.create(),r[c].matrix);h.transform(u);var d=r[c].submesh.faces,f=r[c].submesh.positions;if(t){var m=this;t.addCallback=function(e){vec3.transformMat4(e.point,e.point,r[c].matrix),e.submesh=r[c].submesh,e.collider=m,e.node=m.node}}for(var v=0;v<d.length;v+=3)if(o[0]=f[3*d[v]],o[1]=f[3*d[v]+1],o[2]=f[3*d[v]+2],a[0]=f[3*d[v+1]],a[1]=f[3*d[v+1]+1],a[2]=f[3*d[v+1]+2],s[0]=f[3*d[v+2]],s[1]=f[3*d[v+2]+1],s[2]=f[3*d[v+2]+2],h.intersectTriangle(o,a,s,t)){if(!t)return!0;l=!0;break}if(t)t.addCallback=!1;else if(l)return!0}return l}}),LargeMeshCollider=Collider.extend({init:function(e){this._super(),this.tree=!1,this.meshes=[],this.damaged=!1,this.invMat=mat4.create()},type:function(){return"LargeMeshCollider"},excluded:function(){return this._super().concat(["tree","meshes"])},isComplete:function(){return!1!==this.tree&&0==this.meshes.length},onAdd:function(e){if(this._super(),this.damaged){var i=this.node;function t(t){var n=null;return i.onEachChild(function(e){if(e.localCollisionID===t)return n=e,!0}),n}for(var n in this.tree.nodes){var r=this.tree.nodes[n].localCollisionID;r<0||(this.tree.nodes[n]=t(r))}this.damaged=!1}},clone:function(){var e=new LargeMeshCollider;return this.tree&&(e.tree=this.tree.clone(),e.damaged=!0),e},rayTest:function(e,t,n){if(!this.enabled||!this.isComplete())return!1;var i=e.clone();mat4.invert(this.invMat,this.node.transform.absolute),i.transform(this.invMat);var r=this.tree.getNearestRayCollision(i,e,n);if(r.t==1/0||r.t==-1/0)return!1;if(t&&r){var o=i.getPointOnRay(r.t);vec3.transformMat4(o,o,this.node.transform.absolute),t.hits.push({point:o,collider:this,submesh:r.submesh,node:r.node,normal:r.normal})}return!1!==r}}),Resource=Component.extend({init:function(){this._super(),this.descriptor=!1},excluded:function(){return this._super().concat(["resource"])},type:function(){return"ResourceComponent"}}),TextureResource=Resource.extend({init:function(){this._super(),this.descriptor=new TextureDescriptor,this.texture=!1,this.engine=!1},excluded:function(){return this._super().concat(["texture","engine"])},type:function(){return"TextureResource"},load:function(e){var t=this;this.texture=this.engine.assetsManager.texturesManager.addDescriptor(this.descriptor),this.engine.assetsManager.load(function(){t.onLoaded(),e&&e(t.engine.context,t.engine)})},onStart:function(e,t){this.engine=t,this.load()},onLoaded:function(){}}),ModelResource=Resource.extend({init:function(){this._super(),this.descriptor=new ModelDescriptor,this.model=!1},type:function(){return"ModelResource"},excluded:function(){return this._super().concat(["model","engine"])},load:function(e){if(this.descriptor.source){var t=this;this.model=this.engine.assetsManager.modelsManager.addDescriptor(this.descriptor),this.engine.assetsManager.load(function(){t.node.addNode(t.model),t.onLoaded(),e&&e(t.engine.context,t.engine)})}},onStart:function(e,t){this.engine=t,this.load()},onLoaded:function(){}}),MaterialResource=Resource.extend({init:function(){this._super(),this.descriptor=new MaterialSourceDescriptor,this.material=!1,this.engine=!1},excluded:function(){return this._super().concat(["material","engine"])},type:function(){return"MaterialResource"},load:function(e){var t=this;this.texture=this.engine.assetsManager.materialSourcesManager.addDescriptor(this.descriptor),this.engine.assetsManager.load(function(){t.onLoaded(),e&&e(t.engine.context,t.engine)})},onStart:function(e,t){this.engine=t,this.load()},onLoaded:function(){}}),Light=Component.extend({init:function(){this._super(),this.color=new Color(1,1,1,1),this.intensity=1,this.shadowCasting=!1,this.shadowMask=4294967295,this.damaged=!0},type:function(){return"Light"},onAddScene:function(e){e.scene.lights.push(this)},onRemoveScene:function(e){for(var t=e.scene.lights,n=0;n<t.length;n++)t[n]==this&&(t.splice(n,1),n--)},getGeometryRenderers:function(){return[]},isPositional:function(){return!1},onContextRestored:function(e){},damage:function(){this.damaged=!0},undamage:function(){this.damaged=!1}}),OmniLight=Light.extend({init:function(e,t){this._super(),this.size=e||1,this.color=t||new Color(1,1,1,1),this.intensity=1,this.geometry=null,this.material=null},type:function(){return"OmniLight"},onStart:function(e,t){this._super(),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("deferred_light_omni")),{lightColor:new UniformColor(this.color),lightPosition:new UniformVec3(vec3.create()),lightIntensity:new UniformFloat(this.intensity),lightRadius:new UniformFloat(this.size)},[]),this.geometry=Primitives.sphere(this.size,16,16,this.material),this.geometry.getComponent(MeshRendererComponent).disable(),this.node.addNode(this.geometry),t.assetsManager.load()},onPreRender:function(){vec4.set(this.material.uniforms.lightColor.value,this.color.r,this.color.g,this.color.b,this.color.a),this.node.transform.getPosition(this.material.uniforms.lightPosition.value),this.material.uniforms.lightIntensity.value=this.intensity,this.material.uniforms.lightRadius.value=this.size},getGeometryRenderers:function(){return this.geometry.getComponent(MeshRendererComponent).meshRenderers},isPositional:function(){return!0}}),AmbientLight=Light.extend({init:function(e){this._super(),this.color=e||new Color(.2,.2,.2,1),this.geometry=null,this.material=null},type:function(){return"AmbientLight"},onStart:function(e,t){this._super(),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("deferred_light_ambient")),{lightColor:new UniformColor(this.color)},[]);var n=new Mesh,i=new Submesh;i.positions=[-1,-1,0,-1,1,0,1,1,0,1,-1,0],i.normals=[0,0,1,0,0,1,0,0,1,0,0,1],i.texCoords2D=[[0,0,0,1,1,1,1,0]],i.faces=[0,1,2,0,2,3],i.recalculateBounds(),n.addSubmesh(i,this.material),this.geometry=new Node("AmbientLightGeometry"),this.geometry.addComponent(new MeshComponent(n)),this.geometry.addComponent(new MeshRendererComponent).disable(),this.node.addNode(this.geometry),t.assetsManager.load()},onUpdate:function(){vec4.set(this.material.uniforms.lightColor.value,this.color.r,this.color.g,this.color.b,this.color.a)},getGeometryRenderers:function(){return this.geometry.getComponent(MeshRendererComponent).meshRenderers}}),DirectionalLight=Light.extend({init:function(e,t){this._super(),this.intensity=1,this.color=t||new Color(1,1,1,1),this.direction=vec3.fromValues(1,1,1),e&&this.setLightDirection(e),this.shadowResolution=vec2.fromValues(2048,2048),this.shadowBias=.01,this.geometry=null,this.material=null,this.shadow=null,this.shadowSampler=null,this.lightView=mat4.create(),this.lightProj=mat4.create()},type:function(){return"DirectionalLight"},setLightDirection:function(e){vec3.copy(this.direction,e),vec3.normalize(this.direction,this.direction)},onStart:function(e,t){if(this._super(),vec2.set(this.shadowResolution,t.options.directionalShadowResolution,t.options.directionalShadowResolution),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("deferred_light_directional")),{lightColor:new UniformColor(this.color),lightIntensity:new UniformFloat(this.intensity),lightDirection:new UniformVec3(vec3.create()),lightView:new UniformMat4(mat4.create()),lightProjection:new UniformMat4(mat4.create()),useShadows:new UniformInt(0),shadowBias:new UniformFloat(.01)},[]),this.shadowCasting&&!this.shadow){if(e.isWebGL2())this.shadow=new TargetTextureFloat(this.shadowResolution,e,!1);else{var n=e.gl.getExtension("OES_texture_half_float"),i=e.gl.getExtension("OES_texture_float");this.shadow=i||n?new TargetTextureFloat(this.shadowResolution,e,!1):new TargetTexture(this.shadowResolution,e,!1)}this.shadowSampler=new Sampler("shadow0",this.shadow.texture),this.material.samplers.push(this.shadowSampler)}var r=new Mesh,o=new Submesh;o.positions=[-1,-1,0,-1,1,0,1,1,0,1,-1,0],o.normals=[0,0,1,0,0,1,0,0,1,0,0,1],o.texCoords2D=[[0,0,0,1,1,1,1,0]],o.faces=[0,1,2,0,2,3],o.recalculateBounds(),r.addSubmesh(o,this.material),this.geometry=new Node("DirectionalLightGeometry"),this.geometry.addComponent(new MeshComponent(r)),this.geometry.addComponent(new MeshRendererComponent).disable(),this.node.addNode(this.geometry),t.assetsManager.load()},onUpdate:function(e){vec4.set(this.material.uniforms.lightColor.value,this.color.r,this.color.g,this.color.b,this.color.a),vec3.copy(this.material.uniforms.lightDirection.value,this.direction),this.material.uniforms.lightIntensity.value=this.intensity,this.material.uniforms.useShadows.value=this.shadowCasting?1:0,this.material.uniforms.shadowBias.value=this.shadowBias,this.updateSamplers(e.context)},updateSamplers:function(e){this.shadowCasting&&(this.shadow||(this.shadow=new TargetTextureFloat(this.shadowResolution,e,!1),this.shadowSampler?this.shadowSampler.texture=this.shadow.texture:(this.shadowSampler=new Sampler("shadow0",this.shadow.texture),this.material.samplers.push(this.shadowSampler))),mat4.copy(this.material.uniforms.lightView.value,this.lightView),mat4.copy(this.material.uniforms.lightProjection.value,this.lightProj))},getGeometryRenderers:function(){return this.geometry.getComponent(MeshRendererComponent).meshRenderers},onContextRestored:function(e){delete this.shadow,this.shadow=null}});function TerrainMesh(){var T=this;this.generate=function(e,t,n){if(n<1)throw"TerrainMesh: numCones must be at least 1";var r=[],o=[],a=[],s=[],l=[],c=0,i=e*Math.pow(2,n-1),h=i/2,d=1,f=2,m=3,v=4;function u(e){return(e+h)/i}function p(e,t,n,i){r.push(e[0],e[1],e[2]),o.push(u(e[0]),u(e[2])),a.push(0,1,0),l.push(0,0,1),r.push(e[0]-.5*t,e[1],e[2]-.5*t),o.push(u(e[0]-.5*t),u(e[2]-.5*t)),a.push(0,1,0),l.push(0,1,0),n!==d&&i!==d&&(r.push(e[0]-.5*t,e[1],e[2]),o.push(u(e[0]-.5*t),u(e[2])),a.push(0,1,0),l.push(0,0,0)),r.push(e[0]-.5*t,e[1],e[2]+.5*t),o.push(u(e[0]-.5*t),u(e[2]+.5*t)),a.push(0,1,0),l.push(1,0,0),n!==m&&i!==m&&(r.push(e[0],e[1],e[2]+.5*t),o.push(u(e[0]),u(e[2]+.5*t)),a.push(0,1,0),l.push(0,0,0)),r.push(e[0]+.5*t,e[1],e[2]+.5*t),o.push(u(e[0]+.5*t),u(e[2]+.5*t)),a.push(0,1,0),l.push(1,1,0),n!==f&&i!==f&&(r.push(e[0]+.5*t,e[1],e[2]),o.push(u(e[0]+.5*t),u(e[2])),a.push(0,1,0),l.push(0,0,0)),r.push(e[0]+.5*t,e[1],e[2]-.5*t),o.push(u(e[0]+.5*t),u(e[2]-.5*t)),a.push(0,1,0),l.push(0,1,1),n!==v&&i!==v&&(r.push(e[0],e[1],e[2]-.5*t),o.push(u(e[0]),u(e[2]-.5*t)),a.push(0,1,0),l.push(0,0,0)),n&&i?(s.push(c+0,c+1,c+2,c+0,c+2,c+3,c+0,c+3,c+4,c+0,c+4,c+5,c+0,c+5,c+6,c+0,c+6,c+1),c+=7):n||i?(s.push(c+0,c+1,c+2,c+0,c+2,c+3,c+0,c+3,c+4,c+0,c+4,c+5,c+0,c+5,c+6,c+0,c+6,c+7,c+0,c+7,c+1),c+=8):(s.push(c+0,c+1,c+2,c+0,c+2,c+3,c+0,c+3,c+4,c+0,c+4,c+5,c+0,c+5,c+6,c+0,c+6,c+7,c+0,c+7,c+8,c+0,c+8,c+1),c+=9)}function g(e,t,n,i){for(var r=vec3.create(),o=e/t,a=-(e-t)/2,s=0;s<o;s++){for(var l=-(e-t)/2,c=0;c<o;c++)if(i&&a>i[0]&&a<i[1]&&l>i[0]&&l<i[1])l+=t;else{if(r[0]=a,r[2]=l,r[1]=n,0==s||s==o-1||0==c||c==o-1){var h=null,u=null;0==s?h=d:s==o-1&&(h=f),0==c?u=v:c==o-1&&(u=m),p(r,t,h,u)}else p(r,t);l+=t}a+=t}}var x=.5;g(e,t,x);for(var w=vec2.create(),b=1;b<n;b++)vec2.set(w,-(e-t)/2,(e-t)/2),g(e*=2,t*=2,x*=2,w);T.positions=r,T.barycentric=l,T.normals=a,T.uv=o,T.faces=s}}var GPUTerrain=MeshRendererComponent.extend({init:function(e,t,n){this._super(),this.options=FRAK.extend({size:1024,verticalScale:64,numCones:8,initialConeSize:32},n),this.uvSize=Math.pow(2,this.options.numCones-1)*this.options.initialConeSize,this.heightSource=new TextureDescriptor(e),this.colorSource=new TextureDescriptor(t),this.cameraPosition=vec3.create()},type:function(){return"TerrainComponent"},onStart:function(e,t){this.height=t.assetsManager.texturesManager.addDescriptor(this.heightSource),this.color=t.assetsManager.texturesManager.addDescriptor(this.colorSource),this.material=new Material(t.assetsManager.addShaderSource(t.assetsManager.shadersManager.bundle("terrain")),{diffuse:new UniformColor({r:1,g:1,b:1,a:1}),ambient:new UniformColor({r:.2,g:.2,b:.2}),uvOffset:new UniformVec2(vec2.fromValues(0,0)),uvScale:new UniformVec2(vec2.fromValues(1,1)),verticalScale:new UniformFloat(this.options.verticalScale)},[new Sampler("diffuse0",this.color),new Sampler("height",this.height)]);var n=new TerrainMesh;n.generate(this.options.initialConeSize,1,this.options.numCones);var i=new Mesh,r=new Submesh;r.positions=n.positions,r.barycentric=n.barycentric,r.normals=n.normals,r.texCoords2D=[n.uv],r.faces=n.faces,r.calculateTangents(),r.recalculateBounds(),i.addSubmesh(r,this.material),this.node.addComponent(new MeshComponent(i)),this._super(e,t),t.assetsManager.load()},onPreRender:function(e,t){t.getPosition(this.cameraPosition),this.cameraPosition[1]=0;var n=(this.cameraPosition[0]+this.options.size/2)/this.options.size,i=(this.cameraPosition[2]+this.options.size/2)/this.options.size;vec2.set(this.material.uniforms.uvScale.value,this.uvSize/this.options.size,this.uvSize/this.options.size),vec2.set(this.material.uniforms.uvOffset.value,n,i),this.material.uniforms.verticalScale.value=this.options.verticalScale,this.node.transform.setPosition(this.cameraPosition)}}),Descriptor=Serializable.extend({init:function(){this._super(),this.source="",this.parentDescriptor=!1},included:function(){return!0},excluded:function(){return this._super().concat(["parentDescriptor"])},type:function(){return"Descriptor"},equals:function(e){if(this.type()!=e.type())return!1;if(this.getFullPath()!=e.getFullPath())return!1;if(this.parentDescriptor&&e.parentDescriptor){if(!this.parentDescriptor.equals(e.parentDescriptor))return!1}else if(this.parentDescriptor!=e.parentDescriptor)return!1;return!0},getCurrentRelativeDirectory:function(){return 0==this.source.length?"":this.source.substring(0,this.source.lastIndexOf("/")+1)},getCurrentDirectory:function(){var e="";return this.parentDescriptor&&(e=this.parentDescriptor.getCurrentDirectory()),e+this.getCurrentRelativeDirectory()},getParentDirectory:function(){return this.parentDescriptor?this.parentDescriptor.getCurrentDirectory():""},getFullPath:function(){return this.getParentDirectory()+this.source}}),TextDescriptor=Descriptor.extend({init:function(e){this._super(),this.source=e},type:function(){return"TextDescriptor"},equals:function(e){return!!this._super(e)&&this.source==e.source}}),ModelDescriptor=Descriptor.extend({init:function(e,t){this._super(),this.source=e,this.format=t||"auto"},type:function(){return"ModelDescriptor"},getFormat:function(){return"auto"==this.format?this.source.endsWith(".data")?"binary":this.source.endsWith(".json")?"json":"binary":this.format}}),ShaderDescriptor=Descriptor.extend({init:function(e,t){this._super(),this.fragmentSource=t?(this.vertexSource=e,t):(this.vertexSource=e+".vert",e+".frag")},type:function(){return"ShaderDescriptor"},equals:function(e){return!!this._super(e)&&(this.vertexSource==e.vertexSource&&this.fragmentSource==e.fragmentSource)},getVertexShaderPath:function(){return this.getParentDirectory()+this.vertexSource},getFragmentShaderPath:function(){return this.getParentDirectory()+this.fragmentSource}}),MaterialDescriptor=Descriptor.extend({init:function(e,t,n){this._super(),n||(n=[]),t||(t={}),this.shaderDescriptor=e,this.uniforms=t,this.textureDescriptors=n,this.materialResourceDescriptor=!1,this.requirements={}},type:function(){return"MaterialDescriptor"},equals:function(e){return!1}}),MaterialSource=Descriptor.extend({init:function(e){this._super(),this.material=!1,this.sourceDescriptor=e},type:function(){return"MaterialSource"},equals:function(e){return!1}}),MaterialSourceDescriptor=Descriptor.extend({init:function(e){this._super(),this.source=e},type:function(){return"MaterialSourceDescriptor"},equals:function(e){return this.source==e.source}}),TextureDescriptor=Descriptor.extend({init:function(e,t,n){this._super(),this.source=e,this.width=t,this.height=n},type:function(){return"TextureDescriptor"},equals:function(e){return!!this._super(e)&&(this.source==e.source&&this.width==e.width&&height==e.height)}}),CubeTextureDescriptor=Descriptor.extend({init:function(e){this._super(),this.sources=e||[]},type:function(){return"CubeTextureDescriptor"},equals:function(e){if(!this._super(e))return!1;if(this.sources.length!=e.sources.length)return!1;for(var t=0;t<this.sources.length;t++)if(this.sources[t]!=e.sources[t])return!1;return!0},getFaceFullPath:function(e){if(e<0||e>this.sources.length)throw"CubeTextureDescriptor.getFaceFullPath: index out of bounds";this.source=this.sources[e];var t=this.getFullPath();return this.source="",t}}),EmptyNode=Serializable.extend({init:function(e){this._super(),this.name=e||"Empty Node",this.subnodes=[],this.components=[],this.scene=!1,this.parent=!1,this.layer=1,this.tags=[],this._super()},excluded:function(){return["parent","scene"]},type:function(){return"EmptyNode"},addNode:function(e){if(!(e instanceof EmptyNode))throw"addNode: The given node is not a subclass of EmptyNode";this.subnodes.push(e);var t=this;return e.parent=this,e.onEachChild(function(e){e.scene=t.scene}),e.scene&&e.onEachChildComponent(function(e){e.onAddScene(t),e.node.onAddComponent(e)}),e.onAdd(this),t.scene.engine&&e.onEachChildComponent(function(e){e.started||(t.scene.starting||!1===t.scene.started?t.scene.startingQueue.push(e):(e.onLoad(t.scene.engine.assetsManager,t.scene.engine),e.start(t.scene.engine.context,t.scene.engine),e.started=!0))}),e},removeNode:function(e){var t=this;this.scene.engine&&e.onEachChildComponent(function(e){e.started&&e.onEnd(t.scene.engine.context,t.scene.engine),e.started=!1}),e.onRemove(this),e.scene&&e.onEachChildComponent(function(e){e.onRemoveScene(t),e.node.onRemoveComponent(e)}),e.onEachChild(function(e){e.scene=!1}),e.parent=!1;for(var n=0;n<this.subnodes.length;n++)if(this.subnodes[n]==e){this.subnodes.splice(n,1);break}return e},removeSubnodes:function(){for(var e=this.subnodes.slice(0),t=0;t<e.length;t++)this.removeNode(e[t])},addComponent:function(e){if(!e.type())throw"Unable to add a component that doesn't define it's type by returning it from type() method";return this.components.push(e),e.node=this,e.onAdd(this),this.scene&&(e.onAddScene(this),this.onAddComponent(e)),!e.started&&this.scene&&this.scene.engine&&(this.scene.started||this.scene.starting)&&(e.start(this.scene.engine.context,this.scene.engine),e.started=!0),e},removeComponent:function(e){for(var t=0;t<this.components.length;t++)if(this.components[t]===e){this.components.splice(t,1);break}return this.scene.engine&&e.started&&(e.onEnd(this.scene.engine.context,this.scene.engine),e.started=!1),this.scene&&(e.onRemoveScene(this),this.onRemoveComponent(e)),e.onRemove(this),e.node=!1,e},removeComponentsByType:function(e){for(var t=[],n=0;n<this.components.length;n++)this.components[n]instanceof e&&(t.push(this.components[n]),this.components.splice(n,1),n--);for(n=0;n<t.length;n++)this.scene.engine&&t[n].started&&(t[n].onEnd(this.scene.engine.context,this.scene.engine),t[n].started=!1),this.scene&&(t[n].onRemoveScene(this),this.onRemoveComponent(t[n])),t[n].onRemove(this),t[n].node=!1;return t},getComponent:function(e){for(var t=0;t<this.components.length;t++)if(this.components[t]instanceof e)return this.components[t];return!1},getComponents:function(e){for(var t=[],n=0;n<this.components.length;n++)this.components[n]instanceof e&&t.push(this.components[n]);return 0!=t.length&&t},calculateRelativeFromAbsolute:function(){this.parent.transform&&this.transform.calculateRelativeFromAbsolute(this.parent.transform.absolute)},instantiate:function(){var e=new EmptyNode(this.name);e.isInstanced=!0,e.layer=this.layer,e.tags=this.tags.slice(0);for(var t=0;t<this.subnodes.length;t++)e.addNode(this.subnodes[t].instantiate());for(var n=0;n<this.components.length;n++)e.addComponent(this.components[n].instantiate());return e},enable:function(e){e?this.onEachComponent(function(e){e.enable()}):this.onEachChildComponent(function(e){e.enable()})},disable:function(e){e?this.onEachComponent(function(e){e.disable()}):this.onEachChildComponent(function(e){e.disable()})},onAdd:function(e){},onRemove:function(e){},onAddComponent:function(e){this.scene.components.push(e),e.onUpdate!=Component.prototype.onUpdate&&this.scene.updatedComponents.push(e),e.onPreRender!=Component.prototype.onPreRender&&this.scene.preRenderedComponents.push(e),e.onPostRender!=Component.prototype.onPostRender&&this.scene.postRenderedComponents.push(e)},onRemoveComponent:function(e){function t(e,t){var n=e.indexOf(t);-1==n||e.splice(n,1)}t(this.scene.components,e),e.onUpdate!=Component.prototype.onUpdate&&t(this.scene.updatedComponents,e),e.onPreRender!=Component.prototype.onPreRender&&t(this.scene.preRenderedComponents,e),e.onPostRender!=Component.prototype.onPostRender&&t(this.scene.postRenderedComponents,e)},onEachChild:function(e){if(!0===e(this))return!0;for(var t=0;t<this.subnodes.length;t++)if(!0===this.subnodes[t].onEachChild(e))return!0},onEachChildExclusive:function(e){for(var t=0;t<this.subnodes.length;t++)if(!0===this.subnodes[t].onEachChild(e))return!0},onEachDirectChild:function(e){for(var t=0;t<this.subnodes.length;t++)if(!0===e(this.subnodes[t]))return!0},onEachComponent:function(e){for(var t=0;t<this.components.length;t++)if(!0===e(this.components[t]))return!0},onEachChildComponent:function(t){this.onEachChild(function(e){if(!0===e.onEachComponent(t))return!0})},onEachChildComponentExclusive:function(t){this.onEachChildExclusive(function(e){if(!0===e.onEachComponent(t))return!0})},getChildComponentsOfType:function(t){var n=[];return this.onEachChildComponent(function(e){e instanceof t&&n.push(e)}),n},find:function(e){var t=e.split("/");if(0==t.length)return!1;var n=this;if(""===t[0]){if(!this.scene)return!1;n=this.scene.root,t.shift()}if(2<t.length){var i=t.slice(0,1),r=t.slice(1,t.length).join("/");(t=i).push(r)}for(var o=0;o<t.length;o++)if(!1===(n=n.findChildWithName(t[o],e)))return!1;return n},findChildWithName:function(e,t){for(var n=0;n<this.subnodes.length;n++)if(this.subnodes[n].name===e)return this.subnodes[n];return!1},path:function(){for(var e=[],t=this;t;)e.push(t.name),t=t.parent;return"/"+e.reverse().join("/")}}),Node=EmptyNode.extend({init:function(e){this._super(e),this.name=e||"Node",this.transform=this.addComponent(new Transform),this.localCollisionID=-1},excluded:function(){return this._super().concat(["transform"])},type:function(){return"Node"},getBoundingBox:function(t){var n=new BoundingBox;return this.onEachChildComponent(function(e){e instanceof MeshRendererComponent&&n.encapsulateBox(e.getBoundingBox(t))}),n},getBoundingSphere:function(t){var n=new BoundingSphere;return this.onEachChildComponent(function(e){e instanceof MeshRendererComponent&&n.encapsulateSphere(e.getBoundingSphere(t))}),n},instantiate:function(){var e=new Node(this.name);e.isInstanced=!0,e.localCollisionID=this.localCollisionID,e.removeComponentsByType(Transform),e.layer=this.layer,e.tags=this.tags.slice(0);for(var t=0;t<this.subnodes.length;t++)e.addNode(this.subnodes[t].instantiate());for(var n=0;n<this.components.length;n++)e.addComponent(this.components[n].instantiate());return e.transform=e.getComponent(Transform),e},updateChildTransforms:function(){var e,t,n,i,r,o=this.transform.absolute,a=this.subnodes;for(e=0,n=a.length;e<n;e++)(r=a[e]).transform&&(mat4.multiply(r.transform.absolute,o,r.transform.relative),r.updateChildTransforms());for(t=0,i=this.components.length;t<i;t++)this.components[t].onUpdateTransform(o)},setAbsolutePosition:function(e){this.parent&&this.parent.transform?(mat4.fromRotationTranslationScale(this.transform.absolute,quat.fromMat4(quat.create(),this.transform.absolute),e,mat4.getScale(vec3.create(),this.transform.absolute)),this.transform.calculateRelativeFromAbsolute(this.parent.transform.absolute)):this.transform.calculateRelativeFromAbsolute()}}),Scene=Serializable.extend({init:function(){this.root=new Node,(this.root.scene=this).dynamicSpace=new DynamicSpace,this.cameras=[],this.lights=[],this.engine=!1,this.starting=!1,this.started=!1,this.startingQueue=[],this.components=[],this.preRenderedComponents=[],this.postRenderedComponents=[],this.updatedComponents=[];var r=this;this.processPreRenderList=function(e,t){for(var n=0;n<r.preRenderedComponents.length;++n){var i=r.preRenderedComponents[n];i.node.layer&t.layerMask&&(e.modelview.push(),e.modelview.multiply(i.node.transform.absolute),i.onPreRender(e,t),e.modelview.pop())}},this.processPostRenderList=function(e,t){for(var n=0;n<r.postRenderedComponents.length;++n){var i=r.postRenderedComponents[n];i.node.layer&t.layerMask&&(e.modelview.push(),e.modelview.multiply(i.node.transform.absolute),i.onPostRender(e,t),e.modelview.pop())}}},fields:function(){return["root"]},start:function(i){if(!this.started&&!this.starting){this.starting=!0;var r=this;this.root.onEachChildComponent(function(e){e.enabled&&(e.started||e.onLoad(r.engine.assetsManager,r.engine))});!function(){r.root.updateChildTransforms(),r.root.onEachChildComponent(function(e){e.enabled&&(e.started||r.startingQueue.push(e))});var n=null;(n=function(){for(var e=(new Date).getTime()+50;(new Date).getTime()<e;){if(0===r.startingQueue.length)return r.started=!0,r.starting=!1,void("function"==typeof r.engine.sceneStarted&&r.engine.sceneStarted());var t=r.startingQueue.shift();t.started||(t.start(i,r.engine),t.started=!0)}setTimeout(n,10)})()}()}},end:function(t,n){this.started&&(this.root.updateChildTransforms(),this.root.onEachChildComponent(function(e){e.enabled&&e.started&&(e.onEnd(t,n),e.started=!1)}),this.started=!1)},render:function(e){if(this.started)for(var t=0;t<this.cameras.length;++t)this.cameras[t].render(e,this,this.processPreRenderList,this.processPostRenderLists)},update:function(e){if(this.started){for(var t=1,n=0;n<t;++n)for(var i=0;i<this.updatedComponents.length;++i){var r=this.updatedComponents[i];r.enabled&&(n<r.updatePasses&&r.started&&r.onUpdate(e,n),t<r.updatePasses&&(t=r.updatePasses))}this.root.updateChildTransforms()}},getMaterials:function(){var n=[];return this.root.onEachChildComponent(function(e){if(e instanceof MeshComponent)for(var t in e.mesh.materials)n.push(e.mesh.materials[t])}),n},broadcast:function(t,n,i){if(i=i||null,t.prototype instanceof Light)for(var e,r=0;r<this.lights.length;r++)(e=this.lights[r])instanceof t&&n in e&&"function"==typeof e[n]&&e[n](i);else this.root.onEachChildComponent(function(e){e instanceof t&&n in e&&"function"==typeof e[n]&&e[n](i)})}}),DefaultScene=Scene.extend({init:function(){this._super(),this.root.name="Root",this.cameraNode=new Node("Camera"),this.cameraComponent=this.cameraNode.addComponent(new PerspectiveCamera),this.cameraComponent.aspect=!1,this.camera=this.cameraComponent.camera,this.root.addNode(this.cameraNode),this.lightNode=new Node("Light"),this.light=new DirectionalLight,this.light.color=new Color(1,1,1,1),this.light.intensity=1,this.light.setLightDirection(vec3.fromValues(.9,1,.9)),this.lightNode.addComponent(this.light),this.root.addNode(this.lightNode)}}),FPS=FrakClass.extend({init:function(){this.frametime=0,this.lastMeasurement=(new Date).getTime(),this.averageMultiplier=.95,this.delta=0},measure:function(){var e=FRAK.timestamp();0<e-this.lastMeasurement&&(this.frametime=this.frametime*this.averageMultiplier+this.delta*(1-this.averageMultiplier),this.delta=e-this.lastMeasurement),this.lastMeasurement=e},getAverage:function(){return this.frametime<=0?0:1e3/this.frametime},getDelta:function(){return this.delta}}),Engine=FrakClass.extend({init:function(e,t,n){if(t||(t={}),this.options=FRAK.extend({assetsPath:"",defaultRequestedFPS:60,requestedFPS:60,anisotropicFiltering:4,useVAO:!0,debug:!1,antialias:!1,ssao:!1,transparencyMode:"default",renderer:"default",softShadows:!1,runInBackground:!1,context:!1,contextErrorCallback:null,captureScreenshot:!1,webGLVersion:"auto",builtinShaders:!0,directionalShadowResolution:2048,shadowManualUpdate:!1},t),this.validateOptions(e),this.context=this.options.context,this.context.engine=this,n||(n=new DefaultScene),this.scene=n,(this.scene.engine=this).fps=new FPS,this.running=!1,this.input=!1,this.screenshot=!1,this.onScreenshotCaptured=!1,this.debugCTX=!1,this.debugWidth=256,this.debugFPS=[],this.debugCount=24,this.assetsManager=new AssetsManager(this.context,this.options.assetsPath),this.options.builtinShaders||(this.assetsManager.shadersManager.builtin={}),this.WhiteTexture=new Texture(this.context),this.WhiteTexture.name="WhiteTexture",this.WhiteTexture.mipmapped=!1,this.WhiteTexture.clearImage(this.context,[255,255,255,255]),this.WhiteTextureSampler=new Sampler("tex0",this.WhiteTexture),this.DiffuseFallbackSampler=new Sampler("diffuse0",this.WhiteTexture),document.addEventListener("visibilitychange",FrakCallback(this,this.onVisibilityChange)),this.context.canvas.addEventListener("webglcontextlost",FrakCallback(this,this.onContextLost),!1),this.context.canvas.addEventListener("webglcontextrestored",FrakCallback(this,this.onContextRestored),!1),FRAK.fullscreenEnabled){this.useUpscaling=!1;var i=FrakCallback(this,this.onFullscreenChange);document.addEventListener("fullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),document.addEventListener("mozfullscreenchange",i),document.addEventListener("MSFullscreenChange",i)}this.setupInput()},onContextLost:function(e){console.log("FRAK: Rendering context lost"),e.preventDefault(),this.pause()},onContextRestored:function(e){console.log("FRAK: Rendering context restored"),(this.context.engine=this).context.restore(),this.run()},onVisibilityChange:function(){if(!this.options.runInBackground)if(document.hidden){if(!1===this.running)return void(this._externallyPaused=!0);this.pause()}else{if(this._externallyPaused)return void delete this._externallyPaused;this.run()}},onFullscreenChange:function(){var r;if(this.context instanceof RenderingContext)if(FRAK.isFullscreen()){r=this.context.canvas,this._savedCanvasStyles={position:r.style.position,left:r.style.left,right:r.style.right,top:r.style.top,bottom:r.style.bottom,width:r.style.width,height:r.style.height,canvasWidth:r.getAttribute("width"),canvasHeight:r.getAttribute("height"),aspectRatio:this.scene.cameraComponent.aspect},r.style.position="absolute",r.style.left=0,r.style.right=0,r.style.top=0,r.style.bottom=0,r.style.width="100%",r.style.height="100%";var o=this;setTimeout(function(){var e=r.getBoundingClientRect();if(o.scene.cameraComponent.setAspectRatio(e.width/e.height),!o.useUpscaling){var t=o.context.gl,n=t.canvas.clientWidth,i=Math.max(1,t.canvas.clientHeight);r.setAttribute("width",n),r.setAttribute("height",i),o.scene.camera.target.setSize(t.drawingBufferWidth,t.drawingBufferHeight)}},2e3/this.options.requestedFPS)}else if(this._savedCanvasStyles){if((r=this.context.canvas).style.position=this._savedCanvasStyles.position,r.style.left=this._savedCanvasStyles.left,r.style.right=this._savedCanvasStyles.right,r.style.top=this._savedCanvasStyles.top,r.style.bottom=this._savedCanvasStyles.bottom,r.style.width=this._savedCanvasStyles.width,r.style.height=this._savedCanvasStyles.height,this._savedCanvasStyles.aspectRatio&&this.scene.cameraComponent.setAspectRatio(this._savedCanvasStyles.aspectRatio),!this.useUpscaling){r.setAttribute("width",this._savedCanvasStyles.canvasWidth),r.setAttribute("height",this._savedCanvasStyles.canvasHeight);var e=this.context.gl;this.scene.camera.target.setSize(e.drawingBufferWidth,e.drawingBufferHeight)}delete this._savedCanvasStyles}},setupInput:function(){this.input=new Input(this,this.context.canvas)},run:function(){if(!1===this.running){var t;this.running=!0;var n,i=FRAK.timestamp(),r=1e3/this.options.requestedFPS,o=this;this.scene.started||this.scene.start(this.context,this),this._currentAnimationFrame=FRAK.requestAnimationFrame(function e(){t=FRAK.timestamp(),r<(n=t-i)&&(i=t-n%r,o.frame()),o.running&&(o._currentAnimationFrame=FRAK.requestAnimationFrame(e))})}},sceneStarted:function(){},stop:function(){this.pause(),this.scene.started&&this.scene.end(this.context)},pause:function(){this.running=!1,this._currentAnimationFrame&&FRAK.cancelAnimationFrame(this._currentAnimationFrame)},togglePause:function(){!1===this.running?this.run():this.pause()},requestFullscreen:function(e){FRAK.fullscreenEnabled?(this.useUpscaling=e,FRAK.requestFullscreen(this.context.canvas)):console.warn("FRAK: Fullscreen API is disabled in this browser.")},exitFullscreen:function(){FRAK.fullscreenEnabled?FRAK.exitFullscreen():console.warn("FRAK: Fullscreen API is disabled in this browser.")},startIdle:function(e){e||(e=1),this.options.requestedFPS=e,this.pause(),this.run()},stopIdle:function(){this.options.requestedFPS=this.options.defaultRequestedFPS,this.pause(),this.run()},frame:function(){(this.context.engine=this).input.update(this),this.scene.update(this),this.scene.render(this.context),this.fps.measure(),this.options.captureScreenshot&&this._captureScreenshot(),this.options.showDebug&&this.renderDebugInfo()},validateOptions:function(e){this.options.context||(this.options.context=new RenderingContext(e,null,this.options.contextErrorCallback,this.options.webGLVersion));var t=this.options.context.gl;switch(this.options.transparencyMode){case"sorted":case"blended":case"stochastic":break;default:this.options.transparencyMode="blended"}if("sorted"!=this.options.transparencyMode&&!this.options.context.isWebGL2()){var n=t.getExtension("OES_texture_float"),i=t.getExtension("OES_texture_half_float");n||i||(this.options.transparencyMode="sorted")}switch(this.options.renderer){case"auto":this.options.context.isWebGL2()||t.getExtension("WEBGL_draw_buffers")&&t.getExtension("OES_texture_float")&&t.getExtension("OES_standard_derivatives")?this.options.renderer="deferred":this.options.renderer="forward";break;case"deferred":case"forward":break;default:this.options.renderer="forward"}},resize:function(){if(this.context instanceof RenderingContext){var e=this.context.gl;this.scene.cameraComponent.setAspectRatio(e.drawingBufferWidth/e.drawingBufferHeight),this.scene.camera.target.setSize(e.drawingBufferWidth,e.drawingBufferHeight)}},stats:function(){if(this.scene){var e=this.scene.camera.renderStage.generator.organizer;console.log("=============== Statistics ====================="),console.log("  Visible faces (opaque/transparent): {0}/{1}".format(e.visibleSolidFaces,e.visibleTransparentFaces)),console.log("  Visible renderers (opaque/transparent): {0}/{1}".format(e.visibleSolidRenderers,e.visibleTransparentRenderers)),console.log("  Visible batches (opaque/transparent): {0}/{1}".format(e.visibleSolidBatches,e.visibleTransparentBatches)),console.log("================================================")}},renderDebugInfo:function(){var e=this.scene.camera.renderStage.generator.organizer;if(!this.debugCTX){var t=document.createElement("canvas");t.width=this.debugWidth,t.height=this.debugWidth/2,t.style.position="absolute",t.style.top=0,t.style.zIndex=100,t.style.backgroundColor="rgba(0, 0, 0, 0.5)";var n=this.context.canvas.parentNode;n.insertBefore(t,n.firstChild),this.debugCTX=t.getContext("2d")}if(this.debugCTX&&this.debugCount<1){var i=this.debugCTX;i.clearRect(0,0,this.debugWidth,this.debugWidth/2),i.font="Normal 20px Arial",i.fillStyle="rgba(240,240,240,0.75)",i.fillText("FPS: "+this.fps.getAverage().toFixed(2),10,20),i.font="Normal 12px Arial",i.fillText("Faces: "+e.visibleSolidFaces+" / "+e.visibleTransparentFaces,10,45),i.fillText("Renderers: "+e.visibleSolidRenderers+" / "+e.visibleTransparentRenderers,10,60),i.fillText("Batches: "+e.visibleSolidBatches+" / "+e.visibleTransparentBatches,10,75),i.fillText("RequestedFPS: "+this.options.requestedFPS,this.debugWidth/2,45),i.fillText("WebGL: "+this.context.version,this.debugWidth/2,60);var r=this.context.gl,o=r.getExtension("WEBGL_debug_renderer_info");if(o){var a=r.getParameter(o.UNMASKED_VENDOR_WEBGL),s=r.getParameter(o.UNMASKED_RENDERER_WEBGL);i.fillText(a,10,90),i.fillText(s,10,105)}this.debugFPS.push(this.fps.getAverage().toFixed(2)),60<this.debugFPS.length&&this.debugFPS.shift();for(var l=this.debugWidth/2,c=0;c<this.debugFPS.length;c++)this.debugFPS[c]<20?i.fillStyle="#FF0000":this.debugFPS[c]<30?i.fillStyle="#f6921e":i.fillStyle="#00FF00",i.fillRect(l+2*c,25-this.debugFPS[c]/60*20,2,2);this.debugCount=Math.max(3,Math.floor(this.fps.getAverage()/2))}this.debugCount--},_captureScreenshot:function(){var e=this.context.gl.canvas.toDataURL();e&&this.onScreenshotCaptured&&(this.options.captureScreenshot=!1,this.onScreenshotCaptured(e))},captureScreenshot:function(e){"function"==typeof e&&(this.options.captureScreenshot=!0,this.onScreenshotCaptured=e)}}),Input=FrakClass.extend({init:function(e,t){this.controllers=[],this.engine=e,this.canvas=t,this.lastPinch=0,this.lastRotation=0,this.buttons=[!1,!1,!1],this.button=-1,this.position=vec2.create(),this.delta=vec2.create(),this.lastDelta=vec2.create(),this.deltaChange=vec2.create(),this.scrollDelta=0,this.hammertime=HammerWF(this.canvas),this.hammertime.get("pinch").set({enable:!0}),this.hammertime.get("rotate").set({enable:!0}),this.hammertime.get("pan").set({threshold:0,pointers:0}),this.singlepan=new HammerWF.Pan({event:"pan",direction:HammerWF.DIRECTION_ALL,threshold:5,pointers:1}),this.hammertime.add(this.singlepan),this.bindings={},this.keyStates={},this.wfPanEnabled=!1,this.keymap={enter:13,escape:27,backspace:8,tab:9,shift:16,ctrl:17,alt:18,pause:19,caps_lock:20,space:32,page_up:33,page_down:34,end:35,home:36,left_arrow:37,up_arrow:38,right_arrow:39,down_arrow:40,insert:45,delete:46,left_window_key:91,right_window_key:92,select_key:93,numpad_0:96,numpad_1:97,numpad_2:98,numpad_3:99,numpad_4:100,numpad_5:101,numpad_6:102,numpad_7:103,numpad_8:104,numpad_9:105,multiply:106,add:107,subtract:109,decimal_point:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,num_lock:144,scroll_lock:145,semi_colon:186,equal_sign:187,comma:188,dash:189,period:190,forward_slash:191,grave_accent:192,open_bracket:219,back_slash:220,close_braket:221,single_quote:222,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},this.setup()},setup:function(){this.registerKeyboardEvents(),this.registerPointerEvents()},registerController:function(e){return this.controllers.push(e),!0},registerPointerEvents:function(){this.hammertime&&(this.hammertime.on("pinch",FrakCallback(this,this.onPinch)),this.hammertime.on("pinchend",FrakCallback(this,this.onPinchEnd)),this.hammertime.on("tap",FrakCallback(this,this.onTap)),this.hammertime.on("transformstart",FrakCallback(this,this.onTransformStart)),this.hammertime.on("panstart",FrakCallback(this,this.onPanStart)),this.hammertime.on("panend",FrakCallback(this,this.onPanEnd)),this.hammertime.on("rotate",FrakCallback(this,this.onRotate)),this.hammertime.on("rotateend",FrakCallback(this,this.onRotateEnd)),this.hammertime.on("touch",FrakCallback(this,this.onTouch)),this.hammertime.on("panleft panright panup pandown",FrakCallback(this,this.onPan))),this.canvas.addEventListener("mousewheel",FrakCallback(this,this.onMouseWheel)),this.canvas.addEventListener("DOMMouseScroll",FrakCallback(this,this.onMouseWheelMOZ)),this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},!1)},registerKeyboardEvents:function(){this.canvas&&(this.canvas.addEventListener("keydown",FrakCallback(this,this.onKeyDown)),this.canvas.addEventListener("keyup",FrakCallback(this,this.onKeyUp)),this.canvas.focus&&this.canvas.focus())},unregisterController:function(e){var t=this.controllers.indexOf(e);return-1<t&&(this.controllers.splice(t,1),!0)},bind:function(e,t,n){e&&t&&n&&(e in this.keymap?this.bindings[this.keymap[e]]=[n,t]:this.bindings[e.charCodeAt(0)]=[n,t])},sendEvent:function(n){if(this.engine.running){var e=Array.prototype.slice.call(arguments,0);e=e.slice(1,e.length);for(var t=[],i=0;i<this.controllers.length;i++)this.controllers[i][n]&&t.push(this.controllers[i]);t.sort(function(e,t){return t.getPriority(n)-e.getPriority(n)});for(i=0;i<t.length&&!0!==t[i][n].apply(t[i],e);i++);}},translateCoordinates:function(e,t,n){var i=this.canvas.getBoundingClientRect(),r=t-i.left,o=n-i.top;return vec2.set(e,r,o)},onTap:function(e){if(e){var t;this.translateCoordinates(this.position,e.center.x,e.center.y);for(this.setMouseButtons(e.frakButtons),t=0;t<this.buttons.length&&!this.buttons[t];t++);t==this.buttons.length&&(t=0),this.sendEvent("onClick",this.position,t,e.pointerType,e),this.resetMouseButtons()}},onPan:function(e){e&&(e.preventDefault(),vec2.set(this.deltaChange,e.deltaX,e.deltaY),vec2.sub(this.deltaChange,this.deltaChange,this.lastDelta),vec2.set(this.lastDelta,e.deltaX,e.deltaY),this.setMouseButtons(e.frakButtons),this.translateCoordinates(this.position,e.center.x,e.center.y),Math.max(vec2.len(this.deltaChange))<100&&("touch"==e.pointerType?this.sendEvent("onPan",this.position,this.deltaChange,e.pointerType,e):this.sendEvent("onMouseMove",this.position,this.button,this.deltaChange,e.pointerType,e)))},onPanStart:function(e){e&&(this.setMouseButtons(e.frakButtons),this.translateCoordinates(this.position,e.center.x,e.center.y),this.sendEvent("onButtonDown",this.position,this.button,0,e.pointerType,e))},onPanEnd:function(e){vec2.set(this.lastDelta,0,0),e&&(this.setMouseButtons(e.frakButtons),this.translateCoordinates(this.position,e.center.x,e.center.y),this.sendEvent("onButtonUp",this.position,this.button,0,e.pointerType,e),this.resetMouseButtons())},onTouch:function(){console.info("onTouch in frak")},onTransformStart:function(e){e.gesture.preventDefault(),e.gesture&&(this.lastRotation=e.gesture.rotation)},onPinch:function(e){if(e.preventDefault(),e){this.translateCoordinates(this.position,e.clientX,e.clientY);var t=e.scale-this.lastPinch;this.lastPinch=e.scale-1,this.sendEvent("onPinch",this.position,t,"touch",e)}},onPinchEnd:function(){this.lastPinch=0},onRotate:function(e){if(e){this.translateCoordinates(this.position,e.clientX,e.clientY);var t=e.rotation-this.lastRotation;this.lastRotation=e.rotation,Math.max(t)<10&&this.sendEvent("onRotate",this.position,t,"touch",e)}},onRotateEnd:function(e){this.lastRotation=0},onMultiDrag:function(e){console.log("Multi drag in frak")},onMouseWheel:function(e){if(e){e.preventDefault();var t=0;t="wheelDelta"in e?e.wheelDelta<0?1:0<e.wheelDelta?-1:0:0<e.deltaY?1:e.deltaY<0?-1:0,this.scrollDelta+=e.deltaY,this.translateCoordinates(this.position,e.clientX,e.clientY),this.sendEvent("onMouseWheel",this.position,this.scrollDelta,t,"mouse",e)}},onMouseWheelMOZ:function(e){if(e){e.preventDefault();var t=0<e.detail?1:e.detail<0?-1:0;this.scrollDelta+=e.detail,this.translateCoordinates(this.position,e.clientX,e.clientY),this.sendEvent("onMouseWheel",this.position,this.scrollDelta,t,"mouse",e)}},onKeyDown:function(e){e&&(this.sendEvent("onKeyDown",e.which,"keyboard",e),this.sendEvent("onKeyStateChange",e.which,!0,"keyboard",e),this.keyStates[e.which]=!0)},onKeyUp:function(e){e&&(this.sendEvent("onKeyUp",e.which,"keyboard",e),this.sendEvent("onKeyStateChange",e.which,!1,"keyboard",e),delete this.keyStates[e.which])},update:function(){this.processKeyEvents()},processKeyEvents:function(){for(var e in this.keyStates)if(this.bindings[e]){var t=this.bindings[e];t&&"object"==typeof t[0]&&"string"==typeof t[1]&&t[0][t[1]](this.engine.fps.getDelta()/1e3,e)}},setMouseButtons:function(e){if(e&&!(e.length<3)){this.button=-1;for(var t=0;t<3;t++)this.buttons[t]=e[t],!0===e[t]&&(this.button=t)}},resetMouseButtons:function(){this.button=-1,this.buttons[0]=!1,this.buttons[1]=!1,this.buttons[2]=!1}});"undefined"!=typeof HammerWF&&(HammerWF.MouseInput.prototype.handler=function(e){if("mousedown"==e.type&&(this.pressed=!0),this.pressed&&this.allow){"mouseup"==e.type&&(this.pressed=!1);var t=[!1,!1,!1];"buttons"in e?(t[0]=!!(1&e.buttons),t[1]=!!(4&e.buttons),t[2]=!!(2&e.buttons)):"button"in e&&(t[e.button]=!0);this.callback(this.manager,{mousedown:1,mousemove:2,mouseup:4}[e.type],{pointers:[e],changedPointers:[e],pointerType:"mouse",srcEvent:e,frakButtons:t})}},HammerWF.PointerEventInput.prototype.handler=function(e){var t=this.store,n=!1,i={2:"touch",3:"pen",4:"mouse",5:"kinect"};var r={pointerdown:1,pointermove:2,pointerup:4,pointercancel:8,pointerout:8}[e.type.toLowerCase().replace("ms","")],o=i[e.pointerType]||e.pointerType,a=function(e,t,n){if(e.indexOf&&!n)return e.indexOf(t);for(var i=0;i<e.length;){if(n&&e[i][n]==t||!n&&e[i]===t)return i;i++}return-1}(t,e.pointerId,"pointerId");if(1&r?a<0&&(t.push(e),a=t.length-1):12&r&&(n=!0),!(a<0)){var s=[!!(1&(t[a]=e).buttons),!!(4&e.buttons),!!(2&e.buttons)];this.callback(this.manager,r,{pointers:t,changedPointers:[e],pointerType:o,srcEvent:e,frakButtons:s}),n&&t.splice(a,1)}});var BuiltInShaders={default:{"shaders/default/DebugPackedDepthTexture.frag":"// DebugPackedDepthTexture\nprecision highp float;\n\n#define USE_VSM\n\nuniform mat4 modelview;\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec2 uv0;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\nfloat unpackHalf(vec2 c) {\n\treturn c.x + (c.y / 255.0);\n}\n\nvoid main(void) {\n\tvec4 texel = texture2D(diffuse0, uv0);\n\n#ifdef USE_VSM\n\tgl_FragColor = vec4(0.0, unpackHalf(texel.xy), unpackHalf(texel.zw), 1.0);\n#else\n\tfloat depth = unpack(texel);\n\tgl_FragColor = vec4(depth, depth, depth, 1.0);\n#endif\n}\n","shaders/default/DebugPackedDepthTexture.vert":"// DebugPackedDepthTexture\nattribute vec3 position; \nattribute vec3 normal; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec2 uv0;\n\nvoid main() {\n\tuv0=texcoord2d0;\n\tviewPosition = modelview * vec4(position, 1.0);\n\tviewNormal = normalize(mat3(modelview)*normal);\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/DepthRGBA.frag":"// Shader for rendering linear depth values into RGBA texture\nprecision highp float;\n\nuniform mat4 modelview;\n// uniform float linearDepthConstant;\n\n/** Packing Type:\n\t1 - packs depth value into RGBA\n\t2 - packs depth into RG and depth*depth into BA\n**/\nuniform int packingType;\n\nvarying vec4 viewPosition;\n\nvec4 pack(float depth) {\n\tconst vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n\tconst vec4 bitMask = vec4(0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tvec4 comp = fract(depth * bitShift);\n\tcomp -= comp.xxyz * bitMask;\n\treturn comp;\n}\n\nvec2 packHalf(float depth) {\n\tconst vec2 bias = vec2(1.0 / 255.0, 0.0);\n\tvec2 c = vec2(depth, fract(depth * 255.0));\n\treturn c - (c.yy * bias);\n}\n\nvoid main () {\n\tif (packingType==2) {\n\t\tgl_FragColor = vec4(packHalf(gl_FragCoord.z), packHalf(gl_FragCoord.z*gl_FragCoord.z));\n\t}\n\telse {\n\t\tgl_FragColor = pack(gl_FragCoord.z); // less precision, but works on most systems\n\t\t// float linearDepth = length(viewPosition) * linearDepthConstant;\n\t\t// gl_FragColor = pack(linearDepth);\n\t}\n}\n","shaders/default/DepthRGBA.vert":"// Shader for rendering linear depth values into RGBA texture\nattribute vec3 position;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 viewPosition;\n\nvoid main() {\n\tviewPosition=modelview*vec4(position, 1.0);\n\tgl_Position=projection*viewPosition;\n}\n","shaders/default/GaussianBlur.frag":"// Shader for rendering gaussian blurred image (horizontal)\nprecision highp float;\n\n#define MAX_BLUR_KERNEL_SIZE 10\n\nuniform float screenWidth;\nuniform float screenHeight;\nuniform int orientation; // 0 - horizontal, 1 - vertical\nuniform int kernelSize; // Recommended values: 3, 5, 7, 10 (10 is currently the maximum)\nuniform sampler2D tex0;\n\nvarying vec2 uv0;\n\nvoid main () {\n\tfloat halfSize = float(kernelSize)*0.5;\n\tvec2 texelSize = vec2(1.0/screenWidth, 1.0/screenHeight);\n\tvec4 color = vec4(0.0);\n\n\tif (orientation==1) {\n\t\t// vertical pass\n\t\tfor (int i=0; i<MAX_BLUR_KERNEL_SIZE; ++i) {\n\t\t\tif (i>=kernelSize)\n\t\t\t\tbreak;\n\t\t\tfloat offset = float(i)-halfSize;\n\t\t\tcolor += texture2D(tex0, uv0 + vec2(0.0, offset * texelSize.y));\n\t\t}\n\t}\n\telse {\n\t\t// horizontal pass\n\t\tfor (int i=0; i<MAX_BLUR_KERNEL_SIZE; ++i) {\n\t\t\tif (i>=kernelSize)\n\t\t\t\tbreak;\n\t\t\tfloat offset = float(i)-halfSize;\n\t\t\tcolor += texture2D(tex0, uv0 + vec2(offset * texelSize.x, 0.0));\n\t\t}\n\t}\n\tgl_FragColor = color / float(kernelSize);\n\t// gl_FragColor = texture2D(tex0, uv0);\n}\n","shaders/default/GaussianBlur.vert":"// Shader for rendering gaussian blurred image (horizontal)\nattribute vec3 position;\nattribute vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform float screenWidth;\nuniform float screenHeight;\n\nvarying vec2 uv0;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\t\n\t// Resizes the rendered unit-quad to screen size\n\tvec4 viewPosition=modelview*vec4(position.x*screenWidth, position.y*screenHeight, position.z, 1.0);\n\tgl_Position=projection*viewPosition;\n}\n","shaders/default/OITAccum.frag":"/**\n * Based on the following ideas:\n *\n *   - Weighted Blended Order-Independent Transparency\n *     http://jcgt.org/published/0002/02/09/\n *\n *   - Stochastic Transparency\n *     http://www.nvidia.com/object/nvidia_research_pub_016.html\n *\n *   - Simplex noise (C) Ashima Arts\n *     https://github.com/ashima/webgl-noise\n */\n\nprecision highp float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nuniform int render_mode;\n\nuniform float zNear;\nuniform float zFar;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvec4 mod289(vec4 x) {\n\treturn x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nfloat mod289(float x) {\n\treturn x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec4 permute(vec4 x) {\n\treturn mod289(((x*34.0)+1.0)*x);\n}\n\nfloat permute(float x) {\n\treturn mod289(((x*34.0)+1.0)*x);\n}\n\nvec4 taylorInvSqrt(vec4 r) {\n\treturn 1.79284291400159 - 0.85373472095314 * r;\n}\n\nfloat taylorInvSqrt(float r) {\n\treturn 1.79284291400159 - 0.85373472095314 * r;\n}\n\nvec4 grad4(float j, vec4 ip) {\n\tconst vec4 ones = vec4(1.0, 1.0, 1.0, -1.0);\n\tvec4 p,s;\n\tp.xyz = floor( fract (vec3(j) * ip.xyz) * 7.0) * ip.z - 1.0;\n\tp.w = 1.5 - dot(abs(p.xyz), ones.xyz);\n\ts = vec4(lessThan(p, vec4(0.0)));\n\tp.xyz = p.xyz + (s.xyz*2.0 - 1.0) * s.www;\n\treturn p;\n}\n\n// (sqrt(5) - 1)/4 = F4, used once below\n#define F4 0.309016994374947451\n\nfloat snoise(vec4 v) {\n\tconst vec4 C = vec4(\n\t\t0.138196601125011, // (5 - sqrt(5))/20 G4\n\t\t0.276393202250021, // 2 * G4\n\t\t0.414589803375032, // 3 * G4\n\t\t-0.447213595499958); // -1 + 4 * G4\n\n\t// First corner\n\tvec4 i = floor(v + dot(v, vec4(F4)) );\n\tvec4 x0 = v - i + dot(i, C.xxxx);\n\n\t// Other corners\n\t// Rank sorting originally contributed by Bill Licea-Kane, AMD (formerly ATI)\n\tvec4 i0;\n\tvec3 isX = step( x0.yzw, x0.xxx );\n\tvec3 isYZ = step( x0.zww, x0.yyz );\n\t// i0.x = dot( isX, vec3( 1.0 ) );\n\ti0.x = isX.x + isX.y + isX.z;\n\ti0.yzw = 1.0 - isX;\n\t// i0.y += dot( isYZ.xy, vec2( 1.0 ) );\n\ti0.y += isYZ.x + isYZ.y;\n\ti0.zw += 1.0 - isYZ.xy;\n\ti0.z += isYZ.z;\n\ti0.w += 1.0 - isYZ.z;\n\n\t// i0 now contains the unique values 0,1,2,3 in each channel\n\tvec4 i3 = clamp( i0, 0.0, 1.0 );\n\tvec4 i2 = clamp( i0-1.0, 0.0, 1.0 );\n\tvec4 i1 = clamp( i0-2.0, 0.0, 1.0 );\n\t// x0 = x0 - 0.0 + 0.0 * C.xxxx\n\t// x1 = x0 - i1 + 1.0 * C.xxxx\n\t// x2 = x0 - i2 + 2.0 * C.xxxx\n\t// x3 = x0 - i3 + 3.0 * C.xxxx\n\t// x4 = x0 - 1.0 + 4.0 * C.xxxx\n\tvec4 x1 = x0 - i1 + C.xxxx;\n\tvec4 x2 = x0 - i2 + C.yyyy;\n\tvec4 x3 = x0 - i3 + C.zzzz;\n\tvec4 x4 = x0 + C.wwww;\n\n\t// Permutations\n\ti = mod289(i);\n\tfloat j0 = permute( permute( permute( permute(i.w) + i.z) + i.y) + i.x);\n\tvec4 j1 = permute( permute( permute( permute (\n\ti.w + vec4(i1.w, i2.w, i3.w, 1.0 ))\n\t+ i.z + vec4(i1.z, i2.z, i3.z, 1.0 ))\n\t+ i.y + vec4(i1.y, i2.y, i3.y, 1.0 ))\n\t+ i.x + vec4(i1.x, i2.x, i3.x, 1.0 ));\n\n\t// Gradients: 7x7x6 points over a cube, mapped onto a 4-cross polytope\n\t// 7*7*6 = 294, which is close to the ring size 17*17 = 289.\n\tvec4 ip = vec4(1.0/294.0, 1.0/49.0, 1.0/7.0, 0.0) ;\n\tvec4 p0 = grad4(j0, ip);\n\tvec4 p1 = grad4(j1.x, ip);\n\tvec4 p2 = grad4(j1.y, ip);\n\tvec4 p3 = grad4(j1.z, ip);\n\tvec4 p4 = grad4(j1.w, ip);\n\n\t// Normalise gradients\n\tvec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n\tp0 *= norm.x;\n\tp1 *= norm.y;\n\tp2 *= norm.z;\n\tp3 *= norm.w;\n\tp4 *= taylorInvSqrt(dot(p4,p4));\n\n\t// Mix contributions from the five corners\n\tvec3 m0 = max(0.6 - vec3(dot(x0,x0), dot(x1,x1), dot(x2,x2)), 0.0);\n\tvec2 m1 = max(0.6 - vec2(dot(x3,x3), dot(x4,x4) ), 0.0);\n\tm0 = m0 * m0;\n\tm1 = m1 * m1;\n\treturn 49.0 *\n\t\t( dot(m0*m0, vec3( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 )))\n\t\t+ dot(m1*m1, vec2( dot( p3, x3 ), dot( p4, x4 ) ) ) ) ;\n}\n\nfloat oit_weight(float z, vec4 color) {\n\treturn max(min(1.0, max(max(color.r, color.g), color.b) * color.a), color.a) * clamp(0.03 / (1e-5 + pow(z / 200.0, 4.0)), 1e-2, 3e3);\n}\n\nvec4 lighting() {\n\t/* TODO: proper lighting for transparent surfaces */\n\tvec4 textureColor = texture2D(diffuse0, fragTexcoord2d0);\n\tvec4 color = diffuse * textureColor;\n\treturn color;\n}\n\nvoid main(void) {\n\tvec4 color = lighting();\n\n\t// Weighted Blended Order-Independent Transparency color pass\n\tif (render_mode == 0) {\n\t\tfloat linDepth = 2.0 * zNear * zFar / (zFar + zNear - (2.0 * -fragPosition.z - 1.0) * (zFar - zNear));\n\t\tfloat weight = oit_weight(linDepth, color);\n\t\tgl_FragColor = vec4(color.rgb * color.a, color.a) * weight;\n\t}\n\n\t// Alpha reveal amount pass\n\telse if (render_mode == 1) {\n\t\tgl_FragColor = vec4(color.a); // total amount revealed (blending: 0; 1-src.a)\n\t}\n\n\t// Alpha mapping pass\n\telse if (render_mode == 2) {\n\t\tif (color.a < 0.99)\n\t\t\tdiscard;\n\t\tgl_FragColor = color;\n\t}\n\n\t// Stochastic transparency pass\n\telse if (render_mode == 3) {\n\t\tfloat random = snoise(fragPosition*150.0);\n\t\tif (random > color.a)\n\t\t\tdiscard;\n\t\tgl_FragColor = vec4(color.rgb * color.a, 1.0);\n\t}\n}\n","shaders/default/OITAccum.vert":"/** Order independent transparency - vertex program */\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n\tfragNormal = mat3(modelview) * normal;\n\tfragPosition = modelview * vec4(position, 1.0);\n\tfragTexcoord2d0 = texcoord2d0;\n\tgl_Position = projection * fragPosition;\n}\n","shaders/default/OITRender.frag":"/**\n * Weighted Blended Order-Independent Transparency - Compositing program\n * Based on http://jcgt.org/published/0002/02/09/\n */\n\nprecision highp float;\n\nvarying vec2 uv;\n\nuniform vec2 ViewportSize;\nuniform int render_mode;\n\nuniform sampler2D src;\nuniform sampler2D oitAccum;\nuniform sampler2D oitWeight;\n\nvoid addRelevantSample(vec2 coords, float weight, inout vec4 accum) {\n\tvec4 sample = texture2D(oitAccum, coords);\n\tif (sample.a < 1.0)\n\t\treturn;\n\tfloat a = texture2D(oitWeight, coords).a;\n\tif (a>0.99)\n\t\treturn;\n\taccum += sample * weight * a;\n}\n\nvec4 avgColor(sampler2D s, vec2 coords) {\n\tvec2 step = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n\n\tvec2 kernel[8];\n\tkernel[0] = vec2(-step.x, step.y);\n\tkernel[1] = vec2(0.0, step.y);\n\tkernel[2] = vec2(step.x, step.y);\n\tkernel[3] = vec2(step.x, 0.0);\n\tkernel[4] = vec2(-step.x, 0.0);\n\tkernel[5] = vec2(-step.x, -step.y);\n\tkernel[6] = vec2(0.0, -step.y);\n\tkernel[7] = vec2(step.x, -step.y);\n\n\tvec4 sum = vec4(0.0);\n\tfloat weight = 1.0 / (2.0 + 1.0);\n\tfloat kernelSize = 1.0;\n\n\taddRelevantSample(coords, weight, sum);\n\n\tfor (int i=0; i<8; i++) {\n\t\taddRelevantSample(coords + kernel[i] * kernelSize, weight, sum);\n\t}\n\n\tkernelSize = 2.0;\n\tfor (int i=0; i<8; i++) {\n\t\taddRelevantSample(coords + kernel[i] * kernelSize, weight, sum);\n\t}\n\n\treturn sum;\n}\n\nvoid main(void) {\n\t// Blending: ONE_MINUS_SRC_ALPHA, SRC_ALPHA\n\n\tvec4 solidColor = texture2D(src, uv);\n\tfloat reveal = texture2D(oitWeight, uv).a;\n\tvec4 transparentColor;\n\n\t// Blended order transparency\n\tif (render_mode == 0) {\n\t\ttransparentColor = texture2D(oitAccum, uv);\n\n\t\tvec4 composite = vec4(transparentColor.rgb / max(transparentColor.a, 1e-5), reveal);\n\t\tgl_FragColor = (1.0-composite.a) * composite +  composite.a * solidColor;\n\t}\n\n\t// Stochastic transparency\n\telse if (render_mode == 1) {\n\t\ttransparentColor = avgColor(oitAccum, uv);\n\t\tgl_FragColor = (1.0 - reveal) * transparentColor + reveal * solidColor;\n\t}\n}\n","shaders/default/OITRender.vert":"/** Order independent transparency - vertex program */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/ScreenQuad.frag":"// Shader for rendering a screen aligned quad for image space effects\n\nprecision highp float;\n\nvarying vec2 uv;\nuniform sampler2D tex0;\n\nvoid main () {\n\tgl_FragColor = texture2D(tex0, uv);\n}\n","shaders/default/ScreenQuad.vert":"// Shader for rendering a screen aligned quad for image space effects\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/attributes.frag":"// Attributes shader\nprecision mediump float; \n\nuniform float texCoord2d0Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float texCoord2d1Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float texCoord2d2Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float texCoord2d3Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float positionMultiplier;\t\t\t\t// Position output multiplier between 0 and 1\nuniform float tangentMultiplier;\t\t\t\t// Tangent output multiplier between 0 and 1\nuniform float bitangentMultiplier;\t\t\t// BiTangent output multiplier between 0 and 1\nuniform float normalMultiplier;\t\t\t\t\t// Normal output multiplier between 0 and 1\nuniform float barycentricMultiplier;\t\t// Barycentric output multiplier between 0 and 1\n\nvarying vec2 fragTexcoord2d0;\nvarying vec2 fragTexcoord2d1;\nvarying vec2 fragTexcoord2d2;\nvarying vec2 fragTexcoord2d3;\nvarying vec4 fragPosition;\nvarying vec4 fragTangent;\nvarying vec4 fragBitangent;\nvarying vec4 fragNormal;\nvarying vec3 fragBarycentric;\n\nvoid main(void) {\n\tgl_FragColor = \n\t\tvec4(fragTexcoord2d0, 0.0, 1.0)*texCoord2d0Multiplier+\n\t\tvec4(fragTexcoord2d1, 0.0, 1.0)*texCoord2d1Multiplier+\n\t\tvec4(fragTexcoord2d2, 0.0, 1.0)*texCoord2d2Multiplier+\n\t\tvec4(fragTexcoord2d3, 0.0, 1.0)*texCoord2d3Multiplier+\n\t\tvec4(fragPosition.rgb, 1.0)*positionMultiplier+\n\t\tvec4(fragTangent.rgb, 1.0)*tangentMultiplier+\n\t\tvec4(fragBitangent.rgb, 1.0)*bitangentMultiplier+\n\t\tvec4(fragNormal.rgb, 1.0)*normalMultiplier+\n\t\tvec4(fragBarycentric, 1.0)*barycentricMultiplier;\n}","shaders/default/attributes.vert":"// Attributes shader\nattribute vec3 position; \nattribute vec3 tangent; \nattribute vec3 bitangent; \nattribute vec3 normal; \nattribute vec3 barycentric; \nattribute vec2 texcoord2d0; \nattribute vec2 texcoord2d1;\nattribute vec2 texcoord2d2; \nattribute vec2 texcoord2d3; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec2 fragTexcoord2d0;\nvarying vec2 fragTexcoord2d1;\nvarying vec2 fragTexcoord2d2;\nvarying vec2 fragTexcoord2d3;\nvarying vec4 fragPosition;\nvarying vec4 fragTangent;\nvarying vec4 fragBitangent;\nvarying vec4 fragNormal;\nvarying vec3 fragBarycentric;\n\nvoid main() {\n\tfragNormal=projection*modelview*vec4(normal, 1.0); \n\tfragPosition=projection*modelview*vec4(position, 1.0); \n\tfragTangent=projection*modelview*vec4(tangent, 1.0); \n\tfragBitangent=projection*modelview*vec4(bitangent, 1.0); \n  fragTexcoord2d0=texcoord2d0;\n  fragTexcoord2d1=texcoord2d1;\n  fragTexcoord2d2=texcoord2d2;\n  fragTexcoord2d3=texcoord2d3;\n  fragBarycentric=barycentric;\n\tgl_Position=fragPosition;\n}\n","shaders/default/debug.frag":"// Fallback shader\nprecision mediump float; \n\nuniform vec4 color;\n\nvoid main(void) { \n\tgl_FragColor = color;\n}","shaders/default/debug.vert":"// Debug shader\nattribute vec3 position; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 fragPosition;\n\nvoid main() {\n\tfragPosition=projection*modelview*vec4(position, 1.0); \n\tgl_Position=fragPosition;\n}\n","shaders/default/deferred_background.frag":"precision highp float;\n\nuniform vec4 color;\n\nvarying vec2 uv;\n\nvoid main () {\n\tgl_FragColor = color;\n}\n","shaders/default/deferred_background.vert":"attribute vec3 position;\nattribute vec2 uv0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/deferred_gbuffer.frag":"#extension GL_EXT_draw_buffers : require\n\nprecision highp float;\n\nuniform mat4 view;\nuniform mat4 viewInverse;\n\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\nuniform float lightContribution;\nuniform int useNormalmap;\nuniform int useReflection;\nuniform int receiveShadows;\n\nuniform float materialBlend;\n\nuniform sampler2D diffuse0;\nuniform sampler2D normal0;\nuniform samplerCube env0;\nuniform sampler2D mask;\n\nvarying float depth;\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\n\nvarying mat3 tbn;\n\nvec3 reflection() {\n\tvec3 eyeDirection = normalize(-viewPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = textureCube(env0, lookup);\n\treturn color.rgb;\n}\n\nvoid main() {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tvec3 N = viewNormal;\n\tif (useNormalmap == 1) {\n\t\tvec4 encodedNormal = texture2D(normal0, uv0);\n\t\tvec3 localCoords = vec3(2.0 * encodedNormal.rg - vec2(1.0), encodedNormal.b);\n\t\tN = normalize(tbn * localCoords);\n\t\tN = normalize(mat3(view) * N);\n\t}\n\n\tif (useReflection == 1) {\n\t\tvec3 refl = reflection();\n\t\tfloat maskValue = texture2D(mask, uv0).r;\n\t\tcolor.rgb = mix(refl, color.rgb, maskValue * materialBlend);\n\t}\n\n\tgl_FragData[0] = vec4(color.rgb, specularStrength);\n\tgl_FragData[1] = vec4(N, depth);\n\tgl_FragData[2] = vec4(worldPosition.xyz, float(specularPower)/255.0);\n\tgl_FragData[3] = vec4(lightContribution, receiveShadows, depth, 1.0);\n}\n","shaders/default/deferred_gbuffer.vert":"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\nattribute vec3 tangent;\nattribute vec3 bitangent;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform float zNear;\nuniform float zFar;\n\nvarying float depth;\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\n\nvarying mat3 tbn;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\tdepth = (-viewPosition.z - zNear) / (zFar - zNear);\n\n\ttbn[0] = normalize(vec3(model * vec4(tangent, 0.0)));\n\ttbn[1] = normalize(vec3(model * vec4(bitangent, 0.0)));\n\ttbn[2] = worldNormal;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/deferred_light_ambient.frag":"precision highp float;\n\nuniform sampler2D gb0;\nuniform sampler2D gb1;\nuniform sampler2D gb2;\nuniform sampler2D gb3;\nuniform sampler2D shadow0;\n\nuniform vec4 lightColor;\n\nvarying vec2 uv;\n\nvoid main () {\n\tvec4 data0 = texture2D(gb0, uv);\n\tvec3 color = data0.rgb * lightColor.rgb;\n\tgl_FragColor = vec4(color, 1.0);\n}\n\n","shaders/default/deferred_light_ambient.vert":"attribute vec3 position;\nattribute vec2 texcoord2d0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = texcoord2d0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/deferred_light_directional.frag":"precision highp float;\n\nuniform sampler2D gb0;\nuniform sampler2D gb1;\nuniform sampler2D gb2;\nuniform sampler2D gb3;\nuniform sampler2D shadow0;\n\nuniform vec3 cameraPosition;\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\n\nuniform mat4 view;\nuniform mat4 lightView;\nuniform mat4 lightProjection;\nuniform float shadowBias;\n\nuniform int useShadows;\nuniform int useSoftShadows;\nuniform int shadowOnly;\n\nvarying vec2 uv;\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap(vec4 worldPosition) {\n\tvec4 shadowPosition = lightProjection * lightView * worldPosition;\n\tvec2 shadowUV = shadowPosition.xy / shadowPosition.w;\n\tshadowUV = shadowUV * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, shadowUV);\n\n\treturn VSM(shadowTexel.xy, shadowPosition.z);\n\t// return step(shadowPosition.z - shadowBias, shadowTexel.r);\n}\n\nvoid main () {\n\tvec4 data2 = texture2D(gb2, uv); // position, specularPower/255\n\tvec4 data3 = texture2D(gb3, uv); // material parameters: (lightContribution, receiveShadows, unused, unused)\n\tvec4 P = vec4(data2.xyz, 1.0);\n\n\tfloat shadow = 1.0;\n\n\tif (useShadows == 1 && data3.g > 0.0) {\n\t\tif (useSoftShadows == 1)\n\t\t\tshadow = texture2D(shadow0, uv).r;\n\t\telse\n\t\t\tshadow = shadowmap(P);\n\t}\n\n\tif (shadowOnly == 1) {\n\t\tgl_FragColor = vec4(shadow, shadow, shadow, 1.0);\n\t\treturn;\n\t}\n\n\tvec4 data0 = texture2D(gb0, uv); // color, specularIntensity\n\n\tvec4 data1 = texture2D(gb1, uv); // normal, depth\n\n\tvec3 C = data0.xyz;\n\tvec3 N = data1.xyz;\n\tfloat specularIntensity = data0.w;\n\tfloat specularPower = 255.0*data2.w;\n\n\tvec4 viewPosition = view * P;\n\tvec3 L = normalize(mat3(view) * lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0);\n\tfloat specularLight = pow(clamp(dot(N, H), 0.0, 1.0), float(specularPower));\n\tvec3 diffuseColor = C * lightColor.rgb * diffuseLight * lightIntensity;\n\tvec3 specularColor = lightColor.rgb * specularLight * specularIntensity;\n\n\tvec3 lighting = diffuseColor + specularColor;\n\n\tvec3 final = shadow * mix(C, lighting, data3.r);\n\tgl_FragColor = vec4(final, 1.0);\n}\n","shaders/default/deferred_light_directional.vert":"attribute vec3 position;\nattribute vec2 texcoord2d0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = texcoord2d0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/deferred_light_omni.frag":"precision highp float;\n\nuniform sampler2D gb0;\nuniform sampler2D gb1;\nuniform sampler2D gb2;\nuniform sampler2D gb3;\n\nuniform vec4 lightColor;\nuniform vec3 lightPosition;\nuniform float lightIntensity;\nuniform float lightRadius;\n\nuniform mat4 view;\nuniform vec3 cameraPosition;\n\nvarying vec4 screenPosition;\n\nvoid main() {\n\tvec2 uv = screenPosition.xy;\n\tuv /= screenPosition.w;\n\tuv = 0.5 * (vec2(uv.x, uv.y) + 1.0);\n\n\tvec4 data0 = texture2D(gb0, uv); // color.rgb, specularIntensity\n\tvec4 data1 = texture2D(gb1, uv); // normal.xyz, depth\n\tvec4 data2 = texture2D(gb2, uv); // position.xyz, specularPower/255\n\t// vec4 data3 = texture2D(gb3, uv); // unused\n\n\tvec3 C = data0.xyz;\n\tvec3 N = data1.xyz;\n\tvec3 P = data2.xyz;\n\tfloat specularIntensity = data0.w;\n\tfloat specularPower = 255.0*data2.w;\n\n\tvec3 lightVector = lightPosition - P;\n\tfloat attenuation = clamp(1.0 - length(lightVector)/lightRadius, 0.0, 1.0);\n\tlightVector = normalize(lightVector);\n\n\tvec4 viewPosition = view * vec4(P, 1.0);\n\tvec3 L = normalize(mat3(view) * lightVector);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0);\n\tfloat specularLight = pow(clamp(dot(N, H), 0.0, 1.0), float(specularPower));\n\tvec3 diffuseColor = C * lightColor.rgb * diffuseLight * lightIntensity;\n\tvec3 specularColor = lightColor.rgb * specularLight * specularIntensity;\n\n\tvec3 final = attenuation * (diffuseColor + specularColor);\n\n\tgl_FragColor = vec4(final, 1.0);\n}\n","shaders/default/deferred_light_omni.vert":"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 screenPosition;\n\nvoid main() {\n\tscreenPosition = projection * view * model * vec4(position, 1.0);\n\tgl_Position = screenPosition;\n}\n","shaders/default/deferred_shadow_directional.frag":"/** Directional light shadow-map */\n#extension GL_OES_standard_derivatives : require\n\nprecision highp float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nvarying float depth;\nvarying vec2 uv;\n\nvoid main() {\n\tvec4 textureColor = texture2D(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfloat dx = dFdx(depth);\n\tfloat dy = dFdy(depth);\n\tgl_FragColor = vec4(depth, pow(depth, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n","shaders/default/deferred_shadow_directional.vert":"/** Directional light shadow-map */\nattribute vec3 position;\nattribute vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying float depth;\nvarying vec2 uv;\n\nvoid main() {\n\tvec4 viewPosition = modelview * vec4(position, 1.0);\n\tvec4 clipPosition = projection * viewPosition;\n\tdepth = clipPosition.z;\n\tuv = texcoord2d0;\n\tgl_Position = clipPosition;\n}\n","shaders/default/depth.frag":"// Shader for rendering linear depth values into a floating point texture\nprecision mediump float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nvarying float depth;\nvarying vec2 uv;\n\nvoid main() {\n\tvec4 textureColor = texture2D(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tgl_FragColor = vec4(depth, depth, depth, depth);\n}\n","shaders/default/depth.vert":"// Shader for rendering linear depth values into a floating point texture\nattribute vec3 position;\nattribute vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform float zNear;\nuniform float zFar;\n\nvarying float depth;\nvarying vec2 uv;\n\nvoid main() {\n\tvec4 viewPosition = modelview * vec4(position, 1.0);\n\tdepth = (-viewPosition.z - zNear) / (zFar - zNear);\n\tuv = texcoord2d0;\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/diffuse.frag":"// Diffuse shader\nprecision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\n\treturn ambientColor + (diffuseColor + specularColor) * shadow;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tvec4 color = lighting(shadow);\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/default/diffuse.vert":"// Diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvoid main() {\n\n\tuv0 = texcoord2d0; // TODO: In the future this will probably need to use texture offset and scale uniforms\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/fallback.frag":"// Fallback shader\nprecision mediump float; \n\nvoid main(void) { \n\tgl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n}","shaders/default/fallback.vert":"// Fallback shader\nattribute vec3 position; \nattribute vec3 normal; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n  fragNormal=modelview*vec4(normal, 1.0);\n\tfragPosition=projection*modelview*vec4(position, 1.0); \n  fragTexcoord2d0=texcoord2d0;\n\tgl_Position=fragPosition;\n}\n","shaders/default/font.frag":"// Diffuse shader\nprecision mediump float; \n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform int page;\t\t\t\t\t\t// The font page texture\n\nuniform sampler2D page0;\t\t\nuniform sampler2D page1;\nuniform sampler2D page2;\nuniform sampler2D page3;\nuniform sampler2D page4;\nuniform sampler2D page5;\nuniform sampler2D page6;\nuniform sampler2D page7;\n\nvarying vec2 fragTexcoord2d0;\n\nvoid main(void) {\n\tvec4 c;\n\tif(page==0) c = texture2D(page0, fragTexcoord2d0);\n\tif(page==1) c = texture2D(page1, fragTexcoord2d0);\n\tif(page==2) c = texture2D(page2, fragTexcoord2d0);\n\tif(page==3) c = texture2D(page3, fragTexcoord2d0);\n\tif(page==4) c = texture2D(page4, fragTexcoord2d0);\n\tif(page==5) c = texture2D(page5, fragTexcoord2d0);\n\tif(page==6) c = texture2D(page6, fragTexcoord2d0);\n\tif(page==7) c = texture2D(page7, fragTexcoord2d0);\n\tgl_FragColor=vec4(diffuse.r*c.r, diffuse.g*c.g, diffuse.b*c.b, c.a);\n}","shaders/default/font.vert":"// Font shader\nattribute vec3 position; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n\tfragPosition=projection*modelview*vec4(position, 1.0); \n\tfragTexcoord2d0=texcoord2d0;\n\tgl_Position=fragPosition;\n}\n","shaders/default/forward_shadow.frag":"/** Directional light shadow-map */\nprecision highp float;\n\nuniform int hasFloat;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nvarying float depth;\nvarying vec2 uv;\n\nvec4 pack(float depth) {\n\tconst vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n\tconst vec4 bitMask = vec4(0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tvec4 comp = fract(depth * bitShift);\n\tcomp -= comp.xxyz * bitMask;\n\treturn comp;\n}\n\nvoid main() {\n\tvec4 textureColor = texture2D(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfloat d = (depth + 1.0) * 0.5;\n\n\tif (hasFloat == 1) {\n\t\tgl_FragColor = vec4(d, d, d, 1.0);\n\t}\n\telse {\n\t\tgl_FragColor = pack(d);\n\t}\n\n}\n","shaders/default/forward_shadow.vert":"/** Directional light shadow-map */\nattribute vec3 position;\nattribute vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying float depth;\nvarying vec2 uv;\n\nvoid main() {\n\tvec4 viewPosition = modelview * vec4(position, 1.0);\n\tvec4 clipPosition = projection * viewPosition;\n\tdepth = clipPosition.z;\n\tuv = texcoord2d0;\n\tgl_Position = clipPosition;\n}\n","shaders/default/forward_shadow_vsm.frag":"/** Directional light shadow-map */\n#extension GL_OES_standard_derivatives : require\n\nprecision highp float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nvarying float depth;\nvarying vec2 uv;\n\nvoid main() {\n\tvec4 textureColor = texture2D(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfloat d = (depth + 1.0) * 0.5;\n\tfloat dx = dFdx(d);\n\tfloat dy = dFdy(d);\n\n\tgl_FragColor = vec4(d, pow(d, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n","shaders/default/normalmapped.frag":"// Normal mapped diffuse shader\nprecision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D normal0;\nuniform sampler2D shadow0;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying mat3 tbn;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 encodedNormal = texture2D(normal0, uv0);\n\t// vec3 localCoords = 2.0 * encodedNormal.rgb - vec3(1.0);\n\tvec3 localCoords = vec3(2.0 * encodedNormal.rg - vec2(1.0), encodedNormal.b);\n\tvec3 normalDirection = normalize(tbn * localCoords);\n\tvec3 N = normalize(mat3(view) * normalDirection);\n\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\n\treturn ambientColor + (diffuseColor + specularColor) * shadow;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tvec4 color = lighting(shadow);\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/default/normalmapped.vert":"// Normal mapped diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\nattribute vec3 tangent;\nattribute vec3 bitangent;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\nuniform vec3 lightDirection;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying mat3 tbn;\n\nhighp mat3 transpose(in highp mat3 m) {\n\thighp vec3 i0 = m[0];\n\thighp vec3 i1 = m[1];\n\thighp vec3 i2 = m[2];\n\thighp mat3 outMatrix = mat3(\n\t\tvec3(i0.x, i1.x, i2.x),\n\t\tvec3(i0.y, i1.y, i2.y),\n\t\tvec3(i0.z, i1.z, i2.z)\n\t);\n\treturn outMatrix;\n}\n\nvoid main() {\n\tuv0 = texcoord2d0; // TODO: In the future this will probably need to use texture offset and scale uniforms\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = normalize(mat3(modelview) * normal);\n\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\ttbn[0] = normalize(vec3(model * vec4(tangent, 0.0)));\n\ttbn[1] = normalize(vec3(model * vec4(bitangent, 0.0)));\n\ttbn[2] = worldNormal;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/positionbuffer.frag":"//Normal buffer\nprecision highp float;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform mat4 modelview;\n\nvarying vec4 worldPosition;\nvarying vec4 viewPosition;\nvarying vec3 worldNormal;\nvarying vec3 viewNormal;\n\nvec4 pack(float depth) {\n\tconst vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n\tconst vec4 bitMask = vec4(0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tvec4 comp = fract(depth * bitShift);\n\tcomp -= comp.xxyz * bitMask;\n\treturn comp;\n}\n\nvoid main() {\n    float linDepth = (-viewPosition.z - zNear) / (zFar - zNear);\n    gl_FragColor = pack(linDepth);\n}","shaders/default/positionbuffer.vert":"//Normal buffer\nattribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 worldPosition;\nvarying vec4 viewPosition;\nvarying vec3 worldNormal;\nvarying vec3 viewNormal;\n\nvoid main() {\n    worldPosition = model * vec4(position, 1.0);\n    viewPosition = view * worldPosition;\n    worldNormal = normalize(mat3(model)*normal);\n    viewNormal = mat3(modelview) * normal;\n    \n    gl_Position = projection * viewPosition;\n}","shaders/default/postprocess_blur.frag":"/**\n * Blur post-process\n * http://www.sunsetlakesoftware.com/2013/10/21/optimizing-gaussian-blurs-mobile-gpu\n */\n\nprecision highp float;\n\nuniform sampler2D src;\n\nvarying highp vec2 blurCoords[5];\n\nvoid main () {\n\tlowp vec4 sum = vec4(0.0);\n\tsum += texture2D(src, blurCoords[0]) * 0.204164;\n\tsum += texture2D(src, blurCoords[1]) * 0.304005;\n\tsum += texture2D(src, blurCoords[2]) * 0.304005;\n\tsum += texture2D(src, blurCoords[3]) * 0.093913;\n\tsum += texture2D(src, blurCoords[4]) * 0.093913;\n\tgl_FragColor = sum;\n}\n","shaders/default/postprocess_blur.vert":"/**\n * Blur post-process\n * http://www.sunsetlakesoftware.com/2013/10/21/optimizing-gaussian-blurs-mobile-gpu\n */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nuniform vec2 ViewportSize;\nuniform vec2 BlurSize;\n\nvarying vec2 blurCoords[5];\n\nvoid main() {\n\tvec2 offset = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y) * BlurSize;\n\n\tblurCoords[0] = uv0;\n\tblurCoords[1] = uv0 + offset * 1.407333;\n\tblurCoords[2] = uv0 - offset * 1.407333;\n\tblurCoords[3] = uv0 + offset * 3.294215;\n\tblurCoords[4] = uv0 - offset * 3.294215;\n\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/postprocess_fxaa.frag":'/**\n * FXAA post-process\n *\n * Based on webgl-meincraft FXAA implementation.\n * https://github.com/mitsuhiko/webgl-meincraft/blob/master/assets/shaders/fxaa.glsl\n */\n\n/*\nCopyright (c) 2011 by Armin Ronacher.\n\nSome rights reserved.\n\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are\nmet:\n\n    * Redistributions of source code must retain the above copyright\n      notice, this list of conditions and the following disclaimer.\n\n    * Redistributions in binary form must reproduce the above\n      copyright notice, this list of conditions and the following\n      disclaimer in the documentation and/or other materials provided\n      with the distribution.\n\n    * The names of the contributors may not be used to endorse or\n      promote products derived from this software without specific\n      prior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\nOWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\nSPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\nLIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n*/\n\n/**\n * Basic FXAA implementation based on the code on geeks3d.com with the\n * modification that the texture2DLod stuff was removed since it\'s\n * unsupported by WebGL.\n */\n\nprecision highp float;\n\nuniform sampler2D src;\n\nuniform vec2 ViewportSize;\nuniform float reduce_min;\nuniform float reduce_mul;\nuniform float span_max;\n\nvarying vec2 uv;\n\nvec4 fxaa(sampler2D tex, vec2 texCoord) {\n\tvec4 color;\n\tvec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n\tvec3 rgbNW = texture2D(tex, texCoord + vec2(-1.0, -1.0) * inverseVP).xyz;\n\tvec3 rgbNE = texture2D(tex, texCoord + vec2(1.0, -1.0) * inverseVP).xyz;\n\tvec3 rgbSW = texture2D(tex, texCoord + vec2(-1.0, 1.0) * inverseVP).xyz;\n\tvec3 rgbSE = texture2D(tex, texCoord + vec2(1.0, 1.0) * inverseVP).xyz;\n\tvec3 rgbM = texture2D(tex, texCoord).xyz;\n\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\n\tfloat lumaNW = dot(rgbNW, luma);\n\tfloat lumaNE = dot(rgbNE, luma);\n\tfloat lumaSW = dot(rgbSW, luma);\n\tfloat lumaSE = dot(rgbSE, luma);\n\tfloat lumaM = dot(rgbM, luma);\n\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n\tvec2 dir;\n\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\tdir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * reduce_mul), reduce_min);\n\n\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\tdir = min(vec2(span_max, span_max), max(vec2(-span_max, -span_max), dir * rcpDirMin)) * inverseVP;\n\n\tvec3 rgbA = 0.5 * (\n\t\ttexture2D(tex, texCoord + dir * (1.0 / 3.0 - 0.5)).xyz +\n\t\ttexture2D(tex, texCoord + dir * (2.0 / 3.0 - 0.5)).xyz);\n\tvec3 rgbB = rgbA * 0.5 + 0.25 * (\n\t\ttexture2D(tex, texCoord + dir * -0.5).xyz +\n\t\ttexture2D(tex, texCoord + dir * 0.5).xyz);\n\n\tfloat lumaB = dot(rgbB, luma);\n\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\tcolor = vec4(rgbA, 1.0);\n\telse\n\t\tcolor = vec4(rgbB, 1.0);\n\treturn color;\n}\n\nvoid main () {\n\tgl_FragColor = fxaa(src, uv);\n}\n',"shaders/default/postprocess_fxaa.vert":"/** FXAA post-process effect vertex shader */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/postprocess_ssao.frag":"/*\n * Screen space ambient occlusion post process\n *\n * SSAO GLSL shader v1.2\n * assembled by Martins Upitis (martinsh) (devlog-martinsh.blogspot.com)\n * original technique is made by Arkano22 (www.gamedev.net/topic/550699-ssao-no-halo-artifacts/)\n *\n * Changelog:\n * 1.2 - added fog calculation to mask AO. Minor fixes.\n * 1.1 - added spiral sampling method from here:\n * (http://www.cgafaq.info/wiki/Evenly_distributed_points_on_sphere)\n */\n\nprecision highp float;\n\n#define PI 3.14159265\n\nuniform sampler2D depth0;\nuniform sampler2D oitWeight;\nuniform sampler2D src;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform int ssaoOnly;\nuniform float gdisplace; // Gauss bell center, default: 0.3\nuniform float radius; // AO radius, default: 2.0\nuniform float brightness; // AO brightness, default: 1.0\nuniform float luminanceInfluence; // how much luminance affects occlusion, default: 0.7\n\nconst int samples = 16;\n// const int samples = 8;\n\nfloat aoclamp = 0.25; // depth clamp - reduces haloing at screen edges\nbool noise = true; // use noise instead of pattern for sample dithering\nfloat noiseamount = 0.0002; // dithering amount\nfloat diffarea = 0.4; // self-shadowing reduction\n\nvec2 rand(vec2 coord) {\n\tfloat noiseX = ((fract(1.0-coord.s*(ViewportSize.x/2.0))*0.25)+(fract(coord.t*(ViewportSize.y/2.0))*0.75))*2.0-1.0;\n\tfloat noiseY = ((fract(1.0-coord.s*(ViewportSize.x/2.0))*0.75)+(fract(coord.t*(ViewportSize.y/2.0))*0.25))*2.0-1.0;\n\tif (noise) {\n\t\tnoiseX = clamp(fract(sin(dot(coord, vec2(12.9898,78.233))) * 43758.5453),0.0,1.0)*2.0-1.0;\n\t\tnoiseY = clamp(fract(sin(dot(coord, vec2(12.9898,78.233)*2.0)) * 43758.5453),0.0,1.0)*2.0-1.0;\n\t}\n\treturn vec2(noiseX, noiseY) * noiseamount;\n}\n\nfloat readDepth(in vec2 coord) {\n\treturn texture2D(depth0, coord).r;\n}\n\nfloat compareDepths(in float depth1, in float depth2, inout int far) {\n\tfloat garea = 2.0; // gauss bell width\n\tfloat diff = (depth1 - depth2)*100.0; // depth difference (0-100)\n\t// reduce left bell width to avoid self-shadowing\n\tif (diff<gdisplace) {\n\t\tgarea = diffarea;\n\t}\n\telse {\n\t\tfar = 1;\n\t}\n\n\tfloat gauss = pow(2.7182,-2.0*(diff-gdisplace)*(diff-gdisplace)/(garea*garea));\n\treturn gauss;\n}\n\nfloat calAO(vec2 uv, float depth, float dw, float dh) {\n\tfloat dd = (1.0-depth) * radius;\n\n\tfloat temp = 0.0;\n\tfloat temp2 = 0.0;\n\tfloat coordw = uv.x + dw*dd;\n\tfloat coordh = uv.y + dh*dd;\n\tfloat coordw2 = uv.x - dw*dd;\n\tfloat coordh2 = uv.y - dh*dd;\n\n\tvec2 coord = vec2(coordw , coordh);\n\tvec2 coord2 = vec2(coordw2, coordh2);\n\n\tint far = 0;\n\ttemp = compareDepths(depth, readDepth(coord), far);\n\t//DEPTH EXTRAPOLATION:\n\tif (far > 0) {\n\t\ttemp2 = compareDepths(readDepth(coord2), depth, far);\n\t\ttemp += (1.0-temp)*temp2;\n\t}\n\n\treturn temp;\n}\n\nvoid main() {\n\tvec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n\tvec2 texCoord = gl_FragCoord.xy * inverseVP;\n\n\tvec2 noise = rand(texCoord);\n\tfloat depth = readDepth(texCoord);\n\tfloat reveal = texture2D(oitWeight, texCoord).a;\n\n\tfloat w = inverseVP.x/clamp(depth, aoclamp,1.0)+(noise.x*(1.0-noise.x));\n\tfloat h = inverseVP.y/clamp(depth, aoclamp,1.0)+(noise.y*(1.0-noise.y));\n\n\tfloat pw;\n\tfloat ph;\n\n\tfloat ao;\n\n\tfloat dl = PI*(3.0-sqrt(5.0));\n\tfloat dz = 1.0/float(samples);\n\tfloat l = 0.0;\n\tfloat z = 1.0 - dz/2.0;\n\n\tfor (int i = 0; i <= samples; i++) {\n\t\tfloat r = sqrt(1.0-z);\n\t\tpw = cos(l)*r;\n\t\tph = sin(l)*r;\n\t\tao += calAO(texCoord, depth, pw*w, ph*h);\n\t\tz = z - dz;\n\t\tl = l + dl;\n\t}\n\n\tao /= float(samples) * brightness;\n\tao = 1.0 - ao * reveal;\n\n\tvec3 color = texture2D(src, texCoord).rgb;\n\tvec3 lumcoeff = vec3(0.299, 0.587, 0.114);\n\tfloat lum = dot(color.rgb, lumcoeff);\n\tvec3 luminance = vec3(lum, lum, lum);\n\tvec3 final = vec3(color*mix(vec3(ao),vec3(1.0), luminance * luminanceInfluence));\n\n\tif (ssaoOnly == 1) {\n\t\tfinal = vec3(mix(vec3(ao),vec3(1.0),luminance * luminanceInfluence));\n\t}\n\n\tgl_FragColor = vec4(final, 1.0);\n}\n","shaders/default/postprocess_ssao.vert":"/*\n * Screen space ambient occlusion post process\n */\nattribute vec3 position;\n\nvoid main() {\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}","shaders/default/reflective.frag":"precision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\nuniform mat4 viewInverse;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\nuniform samplerCube env0;\n\nuniform float materialBlend;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\nuniform int useLighting;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\nvec4 reflection() {\n\tvec3 eyeDirection = normalize(-viewPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = textureCube(env0, lookup);\n\treturn color;\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\tvec4 color = ambientColor + (diffuseColor + specularColor) * shadow;\n\treturn color;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tvec4 color = reflection();\n\n\tif (useLighting == 1) {\n\t\tcolor = mix(color, lighting(shadow), materialBlend);\n\t}\n\telse {\n\t\tvec4 textureColor = texture2D(diffuse0, uv0);\n\t\tcolor = mix(color, diffuse * textureColor, materialBlend);\n\t}\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/default/reflective.vert":"// Diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/reflective_masked.frag":"precision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\nuniform mat4 viewInverse;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\nuniform samplerCube env0;\nuniform sampler2D mask;\n\nuniform float materialBlend;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\nuniform int useLighting;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\nvec4 reflection() {\n\tvec3 eyeDirection = normalize(-viewPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = textureCube(env0, lookup);\n\treturn color;\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\tvec4 color = ambientColor + (diffuseColor + specularColor) * shadow;\n\treturn color;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tfloat maskValue = texture2D(mask, uv0).r;\n\tvec4 color = reflection();\n\n\tif (useLighting == 1) {\n\t\tcolor = mix(color, lighting(shadow), maskValue * materialBlend);\n\t}\n\telse {\n\t\tvec4 textureColor = texture2D(diffuse0, uv0);\n\t\tcolor = mix(color, diffuse * textureColor, maskValue * materialBlend);\n\t}\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/default/reflective_masked.vert":"// Diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/shadow_blur.frag":"/**\n * Shadow blur\n */\n\nprecision highp float;\n\nuniform sampler2D src;\n\nvarying vec2 uv;\nvarying highp vec2 blurCoords[14];\n\nvoid main () {\n\tlowp vec4 sum = vec4(0.0);\n\tsum += texture2D(src, blurCoords[ 0])*0.0044299121055113265;\n\tsum += texture2D(src, blurCoords[ 1])*0.00895781211794;\n\tsum += texture2D(src, blurCoords[ 2])*0.0215963866053;\n\tsum += texture2D(src, blurCoords[ 3])*0.0443683338718;\n\tsum += texture2D(src, blurCoords[ 4])*0.0776744219933;\n\tsum += texture2D(src, blurCoords[ 5])*0.115876621105;\n\tsum += texture2D(src, blurCoords[ 6])*0.147308056121;\n\tsum += texture2D(src, uv            )*0.159576912161;\n\tsum += texture2D(src, blurCoords[ 7])*0.147308056121;\n\tsum += texture2D(src, blurCoords[ 8])*0.115876621105;\n\tsum += texture2D(src, blurCoords[ 9])*0.0776744219933;\n\tsum += texture2D(src, blurCoords[10])*0.0443683338718;\n\tsum += texture2D(src, blurCoords[11])*0.0215963866053;\n\tsum += texture2D(src, blurCoords[12])*0.00895781211794;\n\tsum += texture2D(src, blurCoords[13])*0.0044299121055113265;\n\tgl_FragColor = sum;\n}\n","shaders/default/shadow_blurh.vert":"/**\n * Shadow blur - horizontal\n */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nuniform sampler2D src;\n\nvarying vec2 uv;\nvarying vec2 blurCoords[14];\n\nvoid main() {\n\tfloat blurSize = 0.2;\n\tblurCoords[ 0] = uv0 + vec2(-0.028, 0.0) * blurSize;\n\tblurCoords[ 1] = uv0 + vec2(-0.024, 0.0) * blurSize;\n\tblurCoords[ 2] = uv0 + vec2(-0.020, 0.0) * blurSize;\n\tblurCoords[ 3] = uv0 + vec2(-0.016, 0.0) * blurSize;\n\tblurCoords[ 4] = uv0 + vec2(-0.012, 0.0) * blurSize;\n\tblurCoords[ 5] = uv0 + vec2(-0.008, 0.0) * blurSize;\n\tblurCoords[ 6] = uv0 + vec2(-0.004, 0.0) * blurSize;\n\tblurCoords[ 7] = uv0 + vec2( 0.004, 0.0) * blurSize;\n\tblurCoords[ 8] = uv0 + vec2( 0.008, 0.0) * blurSize;\n\tblurCoords[ 9] = uv0 + vec2( 0.012, 0.0) * blurSize;\n\tblurCoords[10] = uv0 + vec2( 0.016, 0.0) * blurSize;\n\tblurCoords[11] = uv0 + vec2( 0.020, 0.0) * blurSize;\n\tblurCoords[12] = uv0 + vec2( 0.024, 0.0) * blurSize;\n\tblurCoords[13] = uv0 + vec2( 0.028, 0.0) * blurSize;\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/shadow_blurv.vert":"/**\n * Shadow blur - vertical\n */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nuniform sampler2D src;\n\nvarying vec2 uv;\nvarying vec2 blurCoords[14];\n\nvoid main() {\n\tfloat blurSize = 0.2;\n\tblurCoords[ 0] = uv0 + vec2(0.0, -0.028) * blurSize;\n\tblurCoords[ 1] = uv0 + vec2(0.0, -0.024) * blurSize;\n\tblurCoords[ 2] = uv0 + vec2(0.0, -0.020) * blurSize;\n\tblurCoords[ 3] = uv0 + vec2(0.0, -0.016) * blurSize;\n\tblurCoords[ 4] = uv0 + vec2(0.0, -0.012) * blurSize;\n\tblurCoords[ 5] = uv0 + vec2(0.0, -0.008) * blurSize;\n\tblurCoords[ 6] = uv0 + vec2(0.0, -0.004) * blurSize;\n\tblurCoords[ 7] = uv0 + vec2(0.0,  0.004) * blurSize;\n\tblurCoords[ 8] = uv0 + vec2(0.0,  0.008) * blurSize;\n\tblurCoords[ 9] = uv0 + vec2(0.0,  0.012) * blurSize;\n\tblurCoords[10] = uv0 + vec2(0.0,  0.016) * blurSize;\n\tblurCoords[11] = uv0 + vec2(0.0,  0.020) * blurSize;\n\tblurCoords[12] = uv0 + vec2(0.0,  0.024) * blurSize;\n\tblurCoords[13] = uv0 + vec2(0.0,  0.028) * blurSize;\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/default/skybox.frag":"precision mediump float;\n\nuniform samplerCube skybox0;\n\nvarying vec3 uv0;\n\nvoid main(void) {\n\tgl_FragColor = textureCube(skybox0, uv0);\n}\n","shaders/default/skybox.vert":"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nvarying vec3 uv0;\n\nvoid main(void) {\n\tuv0 = vec3(position.x, -position.yz);\n\tgl_Position = projection * view * model * vec4(position, 1.0);\n}\n","shaders/default/ssao.frag":"precision highp float;\n\nuniform sampler2D position0;\n\nuniform mat4 projection;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform float ssaoGDisplace;\nuniform float ssaoRadius;\nuniform float ssaoDivider;\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nfloat unpack(vec4 c) {\n    const vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n    return dot(c, bitShifts);\n}\n\nfloat getDepth(vec2 coord) {\n    float d = unpack(texture2D(position0, coord.xy));\n    if (d == 0.0)\n        d = 1.0;\n    return d;\n}\n\nfloat doAmbientOcclusion(vec2 coord, vec2 coord2, float d) {\n    float diff = getDepth(coord + coord2) - d;\n    float gDisplace = -0.0002 - (0.00002 * max(min(ssaoGDisplace, 10.0), 0.0));\n    //float gDisplace = -0.00032;\n    return (diff < gDisplace) ? pow(EULER, -2.0 * (diff - gDisplace) * (diff - gDisplace) * 10000.0 / 0.16) : 0.0;\n}\n\nvoid main() {\n    vec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n    \n    vec2 c = gl_FragCoord.xy * inverseVP;\n    \n    float ao = 0.0;\n\n    float dz = 1.0 / 8.0;\n    float z = 1.0 - dz / 2.0;\n    float l = 0.0;\n\n    float depth = getDepth(c);\n\n    for (int i = 0; i <= 8; i++) {\n        float r = sqrt(1.0 - z);\n\n        vec2 p = vec2(cos(l) * r, sin(l) * r);\n        ao += doAmbientOcclusion(c, p * ssaoRadius * inverseVP.x * (1.0 - depth), depth);\n        z = z - dz;\n        l = l + DL;\n    }\n\n    ao /= 8.0 + max(min(ssaoDivider, 1.0), -1.0);\n    //ao /= 8.5;\n    \n    ao = max(0.0, ao * 2.0 - 1.0);\n    ao = 1.0 - ao;\n    gl_FragColor = vec4(ao, ao, ao, 1.0);\n    //gl_FragColor = vec4(depth, depth, depth, 1.0);\n    //gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n}","shaders/default/ssao.vert":"attribute vec3 position;\n\nvoid main() {\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}","shaders/default/ssaoblur.frag":"precision highp float;\n\nuniform sampler2D ao0;\nuniform sampler2D src;\n\nuniform mat4 projection;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform int ssaoBlurSize;\nuniform int ssaoOnly;\n\nfloat random(vec2 co) {\n    //co = mod(co, 128.0);\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvoid main() {\n    vec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n    \n    const int MAXIMUM_BLUR = 32;\n    float result = 0.0;\n    vec2 hlim = vec2(float(-ssaoBlurSize) * 0.5 + 0.5);\n    for (int i = 0; i < MAXIMUM_BLUR; i++) {\n        if (i >= ssaoBlurSize)\n            break;\n        for (int j = 0; j < MAXIMUM_BLUR; j++) {\n            if (j >= ssaoBlurSize)\n                break;\n            vec2 offset = (hlim + vec2(float(i), float(j))) * inverseVP;\n            result += texture2D(ao0, gl_FragCoord.xy * inverseVP + offset).r;\n        }\n    }\n    result = result / float(ssaoBlurSize * ssaoBlurSize);\n\n    if (ssaoOnly == 1) {\n        gl_FragColor = vec4(vec3(result), 1.0);\n    }\n    else {\n        gl_FragColor = vec4(texture2D(src, gl_FragCoord.xy * inverseVP).xyz * result, 1.0);\n    }\n    //gl_FragColor = vec4(texture2D(src, gl_FragCoord.xy * inverseVP).xyz * texture2D(ao0, gl_FragCoord.xy * inverseVP/* / 2.0 + 0.5*/).xyz, 1.0);\n}","shaders/default/ssaoblur.vert":"attribute vec3 position;\n\nvoid main() {\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}","shaders/default/terrain.frag":"// Terrain shader for the forward renderer\n\nprecision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying vec3 bc;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\n\treturn ambientColor + (diffuseColor + specularColor) * shadow;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\tvec4 color = lighting(shadow);\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n\n\t// gl_FragColor = vec4(bc, 1.0); // for debug\n}\n","shaders/default/terrain.vert":"// Terrain shader for the forward renderer\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\nattribute vec3 barycentric;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nuniform sampler2D height;\n\nuniform float verticalScale;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying vec3 bc;\n\nfloat snap(float f, float step) {\n\treturn step * floor(f / step);\n}\n\nvoid main() {\n\tbc = barycentric;\n\tuv0 = texcoord2d0 * uvScale + uvOffset;\n\tworldPosition = model * vec4(position, 1.0);\n\n\t// worldPosition.x = snap(worldPosition.x, worldPosition.y);\n\t// worldPosition.z = snap(worldPosition.z, worldPosition.y);\n\n\tfloat height = texture2D(height, uv0).r;\n\tworldPosition.y = height * verticalScale;\n\t// worldPosition.y = 0.0;\n\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/default/test.frag":"// Test fragment shader drawing in blue \n\nprecision mediump float; \n\nvoid main(void) { \n\tgl_FragColor = vec4(0.1, 0.5, 0.8, 1.0); \n}","shaders/default/test.vert":"// Test pass-through shader that doesn't transform vertex\nattribute vec3 position; \nattribute vec3 normal; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\n\nvoid main(void) { \n\tfragNormal=mat3(modelview)*normal;\n\tfragPosition=projection*modelview*vec4(position, 1.0);\n\tgl_Position = fragPosition; \n}\n","shaders/default/transparent.frag":"// Unlit transparency shader\nprecision mediump float; \n\nuniform vec4 diffuse;\n\nuniform sampler2D diffuse0;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main(void) {\n\tgl_FragColor = diffuse*texture2D(diffuse0, fragTexcoord2d0);\n}","shaders/default/transparent.vert":"// Unlit transparency shader\nattribute vec3 position; \nattribute vec3 normal; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n\tfragNormal=mat3(modelview)*normal;\n\tfragPosition=modelview*vec4(position, 1.0);\n\tfragTexcoord2d0=texcoord2d0;\n\tgl_Position=projection*fragPosition;\n}\n","shaders/default/wireframe.frag":"// Test fragment shader drawing in blue \nprecision mediump float; \n\nvarying vec3 fragBarycentric;\n\nvoid main(void) { \n\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, \n\t\t\tpow(1.0-fragBarycentric.r, 32.0)+pow(1.0-fragBarycentric.g, 32.0)+pow(1.0-fragBarycentric.b, 32.0));\n}","shaders/default/wireframe.vert":"// Diffuse shader\nattribute vec3 position; \nattribute vec3 barycentric; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragBarycentric;\n\nvoid main(void) { \n\tgl_Position=projection*modelview*vec4(position, 1.0); \n\tfragBarycentric = barycentric;\n}"},webgl2:{"shaders/webgl2/DebugPackedDepthTexture.frag":"#version 300 es\n\nprecision highp float;\n\n#define USE_VSM\n\nuniform mat4 modelview;\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nin vec4 viewPosition;\nin vec3 viewNormal;\nin vec2 uv0;\n\nout vec4 fragColor;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\nfloat unpackHalf(vec2 c) {\n\treturn c.x + (c.y / 255.0);\n}\n\nvoid main(void) {\n\tvec4 texel = texture(diffuse0, uv0);\n\n#ifdef USE_VSM\n\tfragColor = vec4(0.0, unpackHalf(texel.xy), unpackHalf(texel.zw), 1.0);\n#else\n\tfloat depth = unpack(texel);\n\tfragColor = vec4(depth, depth, depth, 1.0);\n#endif\n}\n","shaders/webgl2/DebugPackedDepthTexture.vert":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout vec4 viewPosition;\nout vec3 viewNormal;\nout vec2 uv0;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tviewPosition = modelview * vec4(position, 1.0);\n\tviewNormal = normalize(mat3(modelview)*normal);\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/DepthRGBA.frag":"#version 300 es\n\n// Shader for rendering linear depth values into RGBA texture\nprecision highp float;\n\nuniform mat4 modelview;\n// uniform float linearDepthConstant;\n\n/** Packing Type:\n\t1 - packs depth value into RGBA\n\t2 - packs depth into RG and depth*depth into BA\n**/\nuniform int packingType;\n\nin vec4 viewPosition;\nout vec4 fragColor;\n\nvec4 pack(float depth) {\n\tconst vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n\tconst vec4 bitMask = vec4(0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tvec4 comp = fract(depth * bitShift);\n\tcomp -= comp.xxyz * bitMask;\n\treturn comp;\n}\n\nvec2 packHalf(float depth) {\n\tconst vec2 bias = vec2(1.0 / 255.0, 0.0);\n\tvec2 c = vec2(depth, fract(depth * 255.0));\n\treturn c - (c.yy * bias);\n}\n\nvoid main () {\n\tif (packingType==2) {\n\t\tfragColor = vec4(packHalf(gl_FragCoord.z), packHalf(gl_FragCoord.z*gl_FragCoord.z));\n\t}\n\telse {\n\t\tfragColor = pack(gl_FragCoord.z); // less precision, but works on most systems\n\t\t// float linearDepth = length(viewPosition) * linearDepthConstant;\n\t\t// fragColor = pack(linearDepth);\n\t}\n}\n","shaders/webgl2/DepthRGBA.vert":"#version 300 es\n\n// Shader for rendering linear depth values into RGBA texture\nin vec3 position;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout vec4 viewPosition;\n\nvoid main() {\n\tviewPosition = modelview * vec4(position, 1.0);\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/GaussianBlur.frag":"// Shader for rendering gaussian blurred image (horizontal)\nprecision highp float;\n\n#define MAX_BLUR_KERNEL_SIZE 10\n\nuniform float screenWidth;\nuniform float screenHeight;\nuniform int orientation; // 0 - horizontal, 1 - vertical\nuniform int kernelSize; // Recommended values: 3, 5, 7, 10 (10 is currently the maximum)\nuniform sampler2D tex0;\n\nvarying vec2 uv0;\n\nvoid main () {\n\tfloat halfSize = float(kernelSize)*0.5;\n\tvec2 texelSize = vec2(1.0/screenWidth, 1.0/screenHeight);\n\tvec4 color = vec4(0.0);\n\n\tif (orientation==1) {\n\t\t// vertical pass\n\t\tfor (int i=0; i<MAX_BLUR_KERNEL_SIZE; ++i) {\n\t\t\tif (i>=kernelSize)\n\t\t\t\tbreak;\n\t\t\tfloat offset = float(i)-halfSize;\n\t\t\tcolor += texture2D(tex0, uv0 + vec2(0.0, offset * texelSize.y));\n\t\t}\n\t}\n\telse {\n\t\t// horizontal pass\n\t\tfor (int i=0; i<MAX_BLUR_KERNEL_SIZE; ++i) {\n\t\t\tif (i>=kernelSize)\n\t\t\t\tbreak;\n\t\t\tfloat offset = float(i)-halfSize;\n\t\t\tcolor += texture2D(tex0, uv0 + vec2(offset * texelSize.x, 0.0));\n\t\t}\n\t}\n\tgl_FragColor = color / float(kernelSize);\n\t// gl_FragColor = texture2D(tex0, uv0);\n}\n","shaders/webgl2/GaussianBlur.vert":"// Shader for rendering gaussian blurred image (horizontal)\nattribute vec3 position;\nattribute vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform float screenWidth;\nuniform float screenHeight;\n\nvarying vec2 uv0;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\t\n\t// Resizes the rendered unit-quad to screen size\n\tvec4 viewPosition=modelview*vec4(position.x*screenWidth, position.y*screenHeight, position.z, 1.0);\n\tgl_Position=projection*viewPosition;\n}\n","shaders/webgl2/OITAccum.frag":"#version 300 es\n\n/**\n * Based on the following ideas:\n *\n *   - Weighted Blended Order-Independent Transparency\n *     http://jcgt.org/published/0002/02/09/\n *\n *   - Stochastic Transparency\n *     http://www.nvidia.com/object/nvidia_research_pub_016.html\n *\n *   - Simplex noise (C) Ashima Arts\n *     https://github.com/ashima/webgl-noise\n */\n\nprecision highp float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nuniform int render_mode;\n\nuniform mat4 viewInverse;\nuniform float zNear;\nuniform float zFar;\nuniform int useReflection;\nuniform float reflectivity;\n\nuniform samplerCube env0;\n\nin vec3 fragNormal;\nin vec4 fragPosition;\nin vec2 fragTexcoord2d0;\nin vec3 worldNormal;\nout vec4 fragColor;\n\nvec4 mod289(vec4 x) {\n\treturn x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nfloat mod289(float x) {\n\treturn x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec4 permute(vec4 x) {\n\treturn mod289(((x*34.0)+1.0)*x);\n}\n\nfloat permute(float x) {\n\treturn mod289(((x*34.0)+1.0)*x);\n}\n\nvec4 taylorInvSqrt(vec4 r) {\n\treturn 1.79284291400159 - 0.85373472095314 * r;\n}\n\nfloat taylorInvSqrt(float r) {\n\treturn 1.79284291400159 - 0.85373472095314 * r;\n}\n\nvec4 grad4(float j, vec4 ip) {\n\tconst vec4 ones = vec4(1.0, 1.0, 1.0, -1.0);\n\tvec4 p,s;\n\tp.xyz = floor( fract (vec3(j) * ip.xyz) * 7.0) * ip.z - 1.0;\n\tp.w = 1.5 - dot(abs(p.xyz), ones.xyz);\n\ts = vec4(lessThan(p, vec4(0.0)));\n\tp.xyz = p.xyz + (s.xyz*2.0 - 1.0) * s.www;\n\treturn p;\n}\n\n// (sqrt(5) - 1)/4 = F4, used once below\n#define F4 0.309016994374947451\n\nfloat snoise(vec4 v) {\n\tconst vec4 C = vec4(\n\t\t0.138196601125011, // (5 - sqrt(5))/20 G4\n\t\t0.276393202250021, // 2 * G4\n\t\t0.414589803375032, // 3 * G4\n\t\t-0.447213595499958); // -1 + 4 * G4\n\n\t// First corner\n\tvec4 i = floor(v + dot(v, vec4(F4)) );\n\tvec4 x0 = v - i + dot(i, C.xxxx);\n\n\t// Other corners\n\t// Rank sorting originally contributed by Bill Licea-Kane, AMD (formerly ATI)\n\tvec4 i0;\n\tvec3 isX = step( x0.yzw, x0.xxx );\n\tvec3 isYZ = step( x0.zww, x0.yyz );\n\t// i0.x = dot( isX, vec3( 1.0 ) );\n\ti0.x = isX.x + isX.y + isX.z;\n\ti0.yzw = 1.0 - isX;\n\t// i0.y += dot( isYZ.xy, vec2( 1.0 ) );\n\ti0.y += isYZ.x + isYZ.y;\n\ti0.zw += 1.0 - isYZ.xy;\n\ti0.z += isYZ.z;\n\ti0.w += 1.0 - isYZ.z;\n\n\t// i0 now contains the unique values 0,1,2,3 in each channel\n\tvec4 i3 = clamp( i0, 0.0, 1.0 );\n\tvec4 i2 = clamp( i0-1.0, 0.0, 1.0 );\n\tvec4 i1 = clamp( i0-2.0, 0.0, 1.0 );\n\t// x0 = x0 - 0.0 + 0.0 * C.xxxx\n\t// x1 = x0 - i1 + 1.0 * C.xxxx\n\t// x2 = x0 - i2 + 2.0 * C.xxxx\n\t// x3 = x0 - i3 + 3.0 * C.xxxx\n\t// x4 = x0 - 1.0 + 4.0 * C.xxxx\n\tvec4 x1 = x0 - i1 + C.xxxx;\n\tvec4 x2 = x0 - i2 + C.yyyy;\n\tvec4 x3 = x0 - i3 + C.zzzz;\n\tvec4 x4 = x0 + C.wwww;\n\n\t// Permutations\n\ti = mod289(i);\n\tfloat j0 = permute( permute( permute( permute(i.w) + i.z) + i.y) + i.x);\n\tvec4 j1 = permute( permute( permute( permute (\n\ti.w + vec4(i1.w, i2.w, i3.w, 1.0 ))\n\t+ i.z + vec4(i1.z, i2.z, i3.z, 1.0 ))\n\t+ i.y + vec4(i1.y, i2.y, i3.y, 1.0 ))\n\t+ i.x + vec4(i1.x, i2.x, i3.x, 1.0 ));\n\n\t// Gradients: 7x7x6 points over a cube, mapped onto a 4-cross polytope\n\t// 7*7*6 = 294, which is close to the ring size 17*17 = 289.\n\tvec4 ip = vec4(1.0/294.0, 1.0/49.0, 1.0/7.0, 0.0) ;\n\tvec4 p0 = grad4(j0, ip);\n\tvec4 p1 = grad4(j1.x, ip);\n\tvec4 p2 = grad4(j1.y, ip);\n\tvec4 p3 = grad4(j1.z, ip);\n\tvec4 p4 = grad4(j1.w, ip);\n\n\t// Normalise gradients\n\tvec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n\tp0 *= norm.x;\n\tp1 *= norm.y;\n\tp2 *= norm.z;\n\tp3 *= norm.w;\n\tp4 *= taylorInvSqrt(dot(p4,p4));\n\n\t// Mix contributions from the five corners\n\tvec3 m0 = max(0.6 - vec3(dot(x0,x0), dot(x1,x1), dot(x2,x2)), 0.0);\n\tvec2 m1 = max(0.6 - vec2(dot(x3,x3), dot(x4,x4) ), 0.0);\n\tm0 = m0 * m0;\n\tm1 = m1 * m1;\n\treturn 49.0 *\n\t\t( dot(m0*m0, vec3( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 )))\n\t\t+ dot(m1*m1, vec2( dot( p3, x3 ), dot( p4, x4 ) ) ) ) ;\n}\n\nfloat oit_weight(float z, vec4 color) {\n\treturn max(min(1.0, max(max(color.r, color.g), color.b) * color.a), color.a) * clamp(0.03 / (1e-5 + pow(z / 200.0, 4.0)), 1e-2, 3e3);\n}\n\nvec3 reflection() {\n\tvec3 eyeDirection = normalize(-fragPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = texture(env0, lookup);\n\treturn color.rgb;\n}\n\nvec4 lighting() {\n\t/* TODO: proper lighting for transparent surfaces */\n\tvec4 textureColor = texture(diffuse0, fragTexcoord2d0);\n\tvec4 color = diffuse * textureColor;\n\treturn color;\n}\n\nvoid main(void) {\n\tvec4 color = lighting();\n\n\tif (useReflection == 1) {\n\t\tvec3 refl = reflection();\n\t\tcolor.rgb = mix(refl, color.rgb, clamp(1.0 - reflectivity, 0.0, 1.0));\n\t}\n\n\t// Weighted Blended Order-Independent Transparency color pass\n\tif (render_mode == 0) {\n\t\tfloat linDepth = 2.0 * zNear * zFar / (zFar + zNear - (2.0 * -fragPosition.z - 1.0) * (zFar - zNear));\n\t\tfloat weight = oit_weight(linDepth, color);\n\t\tfragColor = vec4(color.rgb * color.a, color.a) * weight;\n\t}\n\n\t// Alpha reveal amount pass\n\telse if (render_mode == 1) {\n\t\tfragColor = vec4(color.a); // total amount revealed (blending: 0; 1-src.a)\n\t}\n\n\t// Alpha mapping pass\n\telse if (render_mode == 2) {\n\t\tif (color.a < 0.99)\n\t\t\tdiscard;\n\t\tfragColor = color;\n\t}\n\n\t// Stochastic transparency pass\n\telse if (render_mode == 3) {\n\t\tfloat random = snoise(fragPosition*150.0);\n\t\tif (random > color.a)\n\t\t\tdiscard;\n\t\tfragColor = vec4(color.rgb * color.a, 1.0);\n\t}\n}\n","shaders/webgl2/OITAccum.vert":"#version 300 es\n\n/** Order independent transparency - vertex program */\n\nin vec3 position;\nin vec3 normal;\nin vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout vec3 fragNormal;\nout vec4 fragPosition;\nout vec2 fragTexcoord2d0;\nout vec3 worldNormal;\n\nvoid main() {\n\tfragNormal = mat3(modelview) * normal;\n\tfragPosition = modelview * vec4(position, 1.0);\n\tfragTexcoord2d0 = texcoord2d0;\n\tworldNormal = normalize(mat3(model) * normal);\n\tgl_Position = projection * fragPosition;\n}\n","shaders/webgl2/OITRender.frag":"#version 300 es\n\n/**\n * Weighted Blended Order-Independent Transparency - Compositing program\n * Based on http://jcgt.org/published/0002/02/09/\n */\n\nprecision highp float;\n\nin vec2 uv;\n\nuniform vec2 ViewportSize;\nuniform int render_mode;\n\nuniform sampler2D src;\nuniform sampler2D oitAccum;\nuniform sampler2D oitWeight;\n\nout vec4 fragColor;\n\n\nvoid addRelevantSample(vec2 coords, float weight, inout vec4 accum) {\n\tvec4 texel = texture(oitAccum, coords);\n\tif (texel.a < 1.0)\n\t\treturn;\n\tfloat a = texture(oitWeight, coords).a;\n\tif (a>0.99)\n\t\treturn;\n\taccum += texel * weight * a;\n}\n\nvec4 avgColor(sampler2D s, vec2 coords) {\n\tvec2 step = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n\n\tvec2 kernel[8];\n\tkernel[0] = vec2(-step.x, step.y);\n\tkernel[1] = vec2(0.0, step.y);\n\tkernel[2] = vec2(step.x, step.y);\n\tkernel[3] = vec2(step.x, 0.0);\n\tkernel[4] = vec2(-step.x, 0.0);\n\tkernel[5] = vec2(-step.x, -step.y);\n\tkernel[6] = vec2(0.0, -step.y);\n\tkernel[7] = vec2(step.x, -step.y);\n\n\tvec4 sum = vec4(0.0);\n\tfloat weight = 1.0 / (2.0 + 1.0);\n\tfloat kernelSize = 1.0;\n\n\taddRelevantSample(coords, weight, sum);\n\n\tfor (int i=0; i<8; i++) {\n\t\taddRelevantSample(coords + kernel[i] * kernelSize, weight, sum);\n\t}\n\n\tkernelSize = 2.0;\n\tfor (int i=0; i<8; i++) {\n\t\taddRelevantSample(coords + kernel[i] * kernelSize, weight, sum);\n\t}\n\n\treturn sum;\n}\n\nvoid main(void) {\n\t// Blending: ONE_MINUS_SRC_ALPHA, SRC_ALPHA\n\n\tvec4 solidColor = texture(src, uv);\n\tfloat reveal = texture(oitWeight, uv).a;\n\tvec4 transparentColor;\n\n\t// Blended order transparency\n\tif (render_mode == 0) {\n\t\ttransparentColor = texture(oitAccum, uv);\n\n\t\tvec4 composite = vec4(transparentColor.rgb / max(transparentColor.a, 1e-5), reveal);\n\t\tfragColor = (1.0-composite.a) * composite +  composite.a * solidColor;\n\t}\n\n\t// Stochastic transparency\n\telse if (render_mode == 1) {\n\t\ttransparentColor = avgColor(oitAccum, uv);\n\t\tfragColor = (1.0 - reveal) * transparentColor + reveal * solidColor;\n\t}\n}\n","shaders/webgl2/OITRender.vert":"#version 300 es\n\n/** Order independent transparency - vertex program */\n\nin vec3 position;\nin vec2 uv0;\n\nout vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/ScreenQuad.frag":"// Shader for rendering a screen aligned quad for image space effects\n\nprecision highp float;\n\nvarying vec2 uv;\nuniform sampler2D tex0;\n\nvoid main () {\n\tgl_FragColor = texture2D(tex0, uv);\n}\n","shaders/webgl2/ScreenQuad.vert":"// Shader for rendering a screen aligned quad for image space effects\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nvarying vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/attributes.frag":"#version 300 es\n\n// Attributes shader\nprecision mediump float;\n\nuniform float texCoord2d0Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float texCoord2d1Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float texCoord2d2Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float texCoord2d3Multiplier;\t\t// Texture coordinates output multiplier between 0 and 1\nuniform float positionMultiplier;\t\t\t\t// Position output multiplier between 0 and 1\nuniform float tangentMultiplier;\t\t\t\t// Tangent output multiplier between 0 and 1\nuniform float bitangentMultiplier;\t\t\t// BiTangent output multiplier between 0 and 1\nuniform float normalMultiplier;\t\t\t\t\t// Normal output multiplier between 0 and 1\nuniform float barycentricMultiplier;\t\t// Barycentric output multiplier between 0 and 1\n\nin vec2 fragTexcoord2d0;\nin vec2 fragTexcoord2d1;\nin vec2 fragTexcoord2d2;\nin vec2 fragTexcoord2d3;\nin vec4 fragPosition;\nin vec4 fragTangent;\nin vec4 fragBitangent;\nin vec4 fragNormal;\nin vec3 fragBarycentric;\n\nout vec4 fragColor;\n\nvoid main(void) {\n\tfragColor =\n\t\tvec4(fragTexcoord2d0, 0.0, 1.0) * texCoord2d0Multiplier +\n\t\tvec4(fragTexcoord2d1, 0.0, 1.0) * texCoord2d1Multiplier +\n\t\tvec4(fragTexcoord2d2, 0.0, 1.0) * texCoord2d2Multiplier +\n\t\tvec4(fragTexcoord2d3, 0.0, 1.0) * texCoord2d3Multiplier +\n\t\tvec4(fragPosition.rgb, 1.0) * positionMultiplier +\n\t\tvec4(fragTangent.rgb, 1.0) * tangentMultiplier +\n\t\tvec4(fragBitangent.rgb, 1.0) * bitangentMultiplier +\n\t\tvec4(fragNormal.rgb, 1.0) * normalMultiplier +\n\t\tvec4(fragBarycentric, 1.0) * barycentricMultiplier;\n}\n","shaders/webgl2/attributes.vert":"#version 300 es\n\n// Attributes shader\nin vec3 position;\nin vec3 tangent;\nin vec3 bitangent;\nin vec3 normal;\nin vec3 barycentric;\nin vec2 texcoord2d0;\nin vec2 texcoord2d1;\nin vec2 texcoord2d2;\nin vec2 texcoord2d3;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout vec2 fragTexcoord2d0;\nout vec2 fragTexcoord2d1;\nout vec2 fragTexcoord2d2;\nout vec2 fragTexcoord2d3;\nout vec4 fragPosition;\nout vec4 fragTangent;\nout vec4 fragBitangent;\nout vec4 fragNormal;\nout vec3 fragBarycentric;\n\nvoid main() {\n\tfragNormal = projection * modelview * vec4(normal, 1.0);\n\tfragPosition = projection * modelview * vec4(position, 1.0);\n\tfragTangent = projection * modelview * vec4(tangent, 1.0);\n\tfragBitangent = projection * modelview * vec4(bitangent, 1.0);\n\tfragTexcoord2d0 = texcoord2d0;\n\tfragTexcoord2d1 = texcoord2d1;\n\tfragTexcoord2d2 = texcoord2d2;\n\tfragTexcoord2d3 = texcoord2d3;\n\tfragBarycentric = barycentric;\n\tgl_Position = fragPosition;\n}\n","shaders/webgl2/debug.frag":"#version 300 es\n\n// Fallback shader\nprecision mediump float;\n\nuniform vec4 color;\n\nout vec4 fragColor;\n\nvoid main(void) {\n\tfragColor = color;\n}\n","shaders/webgl2/debug.vert":"#version 300 es\n\n// Debug shader\nin vec3 position;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout vec4 fragPosition;\n\nvoid main() {\n\tfragPosition = projection * modelview * vec4(position, 1.0);\n\tgl_Position = fragPosition;\n}\n","shaders/webgl2/deferred_background.frag":"#version 300 es\n\nprecision highp float;\n\nuniform vec4 color;\n\nin vec2 uv;\nout vec4 fragColor;\n\nvoid main () {\n\tfragColor = color;\n}\n","shaders/webgl2/deferred_background.vert":"#version 300 es\n\nin vec3 position;\nin vec2 uv0;\n\nout vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/deferred_gbuffer.frag":"#version 300 es\n\nprecision highp float;\n\nuniform mat4 view;\nuniform mat4 viewInverse;\n\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\nuniform float lightContribution;\nuniform float reflectivity;\nuniform int useNormalmap;\nuniform int useReflection;\nuniform int receiveShadows;\n\nuniform float materialBlend;\n\nuniform sampler2D diffuse0;\nuniform sampler2D normal0;\nuniform samplerCube env0;\nuniform sampler2D mask;\n\nin float depth;\nin vec2 uv0;\nin vec4 worldPosition;\nin vec3 worldNormal;\nin vec4 viewPosition;\nin vec3 viewNormal;\n\nin mat3 tbn;\n\nlayout(location = 0) out vec4 gbuf_color;\nlayout(location = 1) out vec4 gbuf_normal;\nlayout(location = 2) out vec4 gbuf_position;\nlayout(location = 3) out vec4 gbuf_params;\n\nvec3 reflection() {\n\tvec3 eyeDirection = normalize(-viewPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = texture(env0, lookup);\n\treturn color.rgb;\n}\n\nvoid main() {\n\tvec4 textureColor = texture(diffuse0, uv0);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tvec3 N = viewNormal;\n\tif (useNormalmap == 1) {\n\t\tvec4 encodedNormal = texture(normal0, uv0);\n\t\tvec3 localCoords = vec3(2.0 * encodedNormal.rg - vec2(1.0), encodedNormal.b);\n\t\tN = normalize(tbn * localCoords);\n\t\tN = normalize(mat3(view) * N);\n\t}\n\n\tif (useReflection == 1) {\n\t\tvec3 refl = reflection();\n\t\tfloat maskValue = texture(mask, uv0).r;\n\t\tcolor.rgb = mix(refl, color.rgb, maskValue * materialBlend);\n\t}\n\n\tgbuf_color = vec4(color.rgb, specularStrength);\n\tgbuf_normal = vec4(N, depth);\n\tgbuf_position = vec4(worldPosition.xyz, float(specularPower)/255.0);\n\tgbuf_params = vec4(lightContribution, receiveShadows, reflectivity, 1.0);\n}\n","shaders/webgl2/deferred_gbuffer.vert":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 texcoord2d0;\nin vec3 tangent;\nin vec3 bitangent;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform float zNear;\nuniform float zFar;\n\nout float depth;\nout vec2 uv0;\nout vec4 worldPosition;\nout vec3 worldNormal;\nout vec4 viewPosition;\nout vec3 viewNormal;\n\nout mat3 tbn;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\tdepth = (-viewPosition.z - zNear) / (zFar - zNear);\n\n\ttbn[0] = normalize(vec3(model * vec4(tangent, 0.0)));\n\ttbn[1] = normalize(vec3(model * vec4(bitangent, 0.0)));\n\ttbn[2] = worldNormal;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/deferred_light_ambient.frag":"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D gb0;\nuniform sampler2D gb1;\nuniform sampler2D gb2;\nuniform sampler2D gb3;\nuniform sampler2D shadow0;\n\nuniform vec4 lightColor;\n\nin vec2 uv;\nout vec4 fragColor;\n\nvoid main () {\n\tvec4 data0 = texture(gb0, uv);\n\tvec3 color = data0.rgb * lightColor.rgb;\n\tfragColor = vec4(color, 1.0);\n}\n","shaders/webgl2/deferred_light_ambient.vert":"#version 300 es\n\nin vec3 position;\nin vec2 texcoord2d0;\n\nout vec2 uv;\n\nvoid main() {\n\tuv = texcoord2d0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/deferred_light_directional.frag":"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D gb0;\nuniform sampler2D gb1;\nuniform sampler2D gb2;\nuniform sampler2D gb3;\nuniform sampler2D shadow0;\n\nuniform vec3 cameraPosition;\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\n\nuniform mat4 view;\nuniform mat4 lightView;\nuniform mat4 lightProjection;\nuniform float shadowBias;\n\nuniform int useShadows;\nuniform int useSoftShadows;\nuniform int shadowOnly;\n\nin vec2 uv;\nout vec4 fragColor;\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap(vec4 worldPosition) {\n\tvec4 shadowPosition = lightProjection * lightView * worldPosition;\n\tvec2 shadowUV = shadowPosition.xy / shadowPosition.w;\n\tshadowUV = shadowUV * 0.5 + 0.5;\n\tvec4 shadowTexel = texture(shadow0, shadowUV);\n\n\treturn VSM(shadowTexel.xy, shadowPosition.z);\n\t// return step(shadowPosition.z - shadowBias, shadowTexel.r);\n}\n\nvoid main () {\n\tvec4 data2 = texture(gb2, uv); // position, specularPower/255\n\tvec4 data3 = texture(gb3, uv); // material parameters: (lightContribution, receiveShadows, reflectivity, unused)\n\tvec4 P = vec4(data2.xyz, 1.0);\n\n\tfloat shadow = 1.0;\n\n\tif (useShadows == 1 && data3.g > 0.0) {\n\t\tif (useSoftShadows == 1)\n\t\t\tshadow = texture(shadow0, uv).r;\n\t\telse\n\t\t\tshadow = shadowmap(P);\n\t}\n\n\tif (shadowOnly == 1) {\n\t\tfragColor = vec4(shadow, shadow, shadow, 1.0);\n\t\treturn;\n\t}\n\n\tvec4 data0 = texture(gb0, uv); // color, specularIntensity\n\n\tvec4 data1 = texture(gb1, uv); // normal, depth\n\n\tvec3 C = data0.xyz;\n\tvec3 N = data1.xyz;\n\tfloat specularIntensity = data0.w;\n\tfloat specularPower = 255.0*data2.w;\n\n\tvec4 viewPosition = view * P;\n\tvec3 L = normalize(mat3(view) * lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0);\n\tfloat specularLight = pow(clamp(dot(N, H), 0.0, 1.0), float(specularPower));\n\tvec3 diffuseColor = C * lightColor.rgb * diffuseLight * lightIntensity;\n\tvec3 specularColor = lightColor.rgb * specularLight * specularIntensity;\n\n\tvec3 lighting = diffuseColor + specularColor;\n\n\tvec3 final = shadow * mix(C, lighting, data3.r);\n\n\tfragColor = vec4(final, 1.0);\n}\n","shaders/webgl2/deferred_light_directional.vert":"#version 300 es\n\nin vec3 position;\nin vec2 texcoord2d0;\n\nout vec2 uv;\n\nvoid main() {\n\tuv = texcoord2d0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/deferred_light_omni.frag":"#version 300 es\n\nprecision highp float;\n\nuniform sampler2D gb0;\nuniform sampler2D gb1;\nuniform sampler2D gb2;\nuniform sampler2D gb3;\n\nuniform vec4 lightColor;\nuniform vec3 lightPosition;\nuniform float lightIntensity;\nuniform float lightRadius;\n\nuniform mat4 view;\nuniform vec3 cameraPosition;\n\nin vec4 screenPosition;\nout vec4 fragColor;\n\nvoid main() {\n\tvec2 uv = screenPosition.xy;\n\tuv /= screenPosition.w;\n\tuv = 0.5 * (vec2(uv.x, uv.y) + 1.0);\n\n\tvec4 data0 = texture(gb0, uv); // color.rgb, specularIntensity\n\tvec4 data1 = texture(gb1, uv); // normal.xyz, depth\n\tvec4 data2 = texture(gb2, uv); // position.xyz, specularPower/255\n\t// vec4 data3 = texture(gb3, uv); // unused\n\n\tvec3 C = data0.xyz;\n\tvec3 N = data1.xyz;\n\tvec3 P = data2.xyz;\n\tfloat specularIntensity = data0.w;\n\tfloat specularPower = 255.0*data2.w;\n\n\tvec3 lightVector = lightPosition - P;\n\tfloat attenuation = clamp(1.0 - length(lightVector)/lightRadius, 0.0, 1.0);\n\tlightVector = normalize(lightVector);\n\n\tvec4 viewPosition = view * vec4(P, 1.0);\n\tvec3 L = normalize(mat3(view) * lightVector);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0);\n\tfloat specularLight = pow(clamp(dot(N, H), 0.0, 1.0), float(specularPower));\n\tvec3 diffuseColor = C * lightColor.rgb * diffuseLight * lightIntensity;\n\tvec3 specularColor = lightColor.rgb * specularLight * specularIntensity;\n\n\tvec3 final = attenuation * (diffuseColor + specularColor);\n\n\tfragColor = vec4(final, 1.0);\n}\n","shaders/webgl2/deferred_light_omni.vert":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout vec4 screenPosition;\n\nvoid main() {\n\tscreenPosition = projection * view * model * vec4(position, 1.0);\n\tgl_Position = screenPosition;\n}\n","shaders/webgl2/deferred_shadow_directional.frag":"#version 300 es\n/** Directional light shadow-map */\nprecision highp float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nin float depth;\nin vec2 uv;\n\nout vec4 fragColor;\n\nvoid main() {\n\tvec4 textureColor = texture(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfloat dx = dFdx(depth);\n\tfloat dy = dFdy(depth);\n\tfragColor = vec4(depth, pow(depth, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n","shaders/webgl2/deferred_shadow_directional.vert":"#version 300 es\n/** Directional light shadow-map */\nin vec3 position;\nin vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout float depth;\nout vec2 uv;\n\nvoid main() {\n\tvec4 viewPosition = modelview * vec4(position, 1.0);\n\tvec4 clipPosition = projection * viewPosition;\n\tdepth = clipPosition.z;\n\tuv = texcoord2d0;\n\tgl_Position = clipPosition;\n}\n","shaders/webgl2/depth.frag":"#version 300 es\n\n// Shader for rendering linear depth values into a floating point texture\nprecision mediump float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nin float depth;\nin vec2 uv;\nout vec4 fragColor;\n\nvoid main() {\n\tvec4 textureColor = texture(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfragColor = vec4(depth, depth, depth, depth);\n}\n","shaders/webgl2/depth.vert":"#version 300 es\n\n// Shader for rendering linear depth values into a floating point texture\nin vec3 position;\nin vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform float zNear;\nuniform float zFar;\n\nout float depth;\nout vec2 uv;\n\nvoid main() {\n\tvec4 viewPosition = modelview * vec4(position, 1.0);\n\tdepth = (-viewPosition.z - zNear) / (zFar - zNear);\n\tuv = texcoord2d0;\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/diffuse.frag":"#version 300 es\n\nprecision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\n\nin vec2 uv0;\nin vec4 worldPosition;\nin vec3 worldNormal;\nin vec4 viewPosition;\nin vec3 viewNormal;\nin vec4 shadowPosition;\nout vec4 fragColor;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\n\treturn ambientColor + (diffuseColor + specularColor) * shadow;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tvec4 color = lighting(shadow);\n\tfragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/webgl2/diffuse.vert":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nout vec2 uv0;\nout vec4 worldPosition;\nout vec3 worldNormal;\nout vec4 viewPosition;\nout vec3 viewNormal;\nout vec4 shadowPosition;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/fallback.frag":"// Fallback shader\nprecision mediump float; \n\nvoid main(void) { \n\tgl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n}","shaders/webgl2/fallback.vert":"// Fallback shader\nattribute vec3 position; \nattribute vec3 normal; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n  fragNormal=modelview*vec4(normal, 1.0);\n\tfragPosition=projection*modelview*vec4(position, 1.0); \n  fragTexcoord2d0=texcoord2d0;\n\tgl_Position=fragPosition;\n}\n","shaders/webgl2/font.frag":"// Diffuse shader\nprecision mediump float; \n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform int page;\t\t\t\t\t\t// The font page texture\n\nuniform sampler2D page0;\t\t\nuniform sampler2D page1;\nuniform sampler2D page2;\nuniform sampler2D page3;\nuniform sampler2D page4;\nuniform sampler2D page5;\nuniform sampler2D page6;\nuniform sampler2D page7;\n\nvarying vec2 fragTexcoord2d0;\n\nvoid main(void) {\n\tvec4 c;\n\tif(page==0) c = texture2D(page0, fragTexcoord2d0);\n\tif(page==1) c = texture2D(page1, fragTexcoord2d0);\n\tif(page==2) c = texture2D(page2, fragTexcoord2d0);\n\tif(page==3) c = texture2D(page3, fragTexcoord2d0);\n\tif(page==4) c = texture2D(page4, fragTexcoord2d0);\n\tif(page==5) c = texture2D(page5, fragTexcoord2d0);\n\tif(page==6) c = texture2D(page6, fragTexcoord2d0);\n\tif(page==7) c = texture2D(page7, fragTexcoord2d0);\n\tgl_FragColor=vec4(diffuse.r*c.r, diffuse.g*c.g, diffuse.b*c.b, c.a);\n}","shaders/webgl2/font.vert":"// Font shader\nattribute vec3 position; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n\tfragPosition=projection*modelview*vec4(position, 1.0); \n\tfragTexcoord2d0=texcoord2d0;\n\tgl_Position=fragPosition;\n}\n","shaders/webgl2/forward_shadow.frag":"#version 300 es\n\n/** Directional light shadow-map */\nprecision highp float;\n\nuniform int hasFloat;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nin float depth;\nin vec2 uv;\nout vec4 fragColor;\n\nvec4 pack(float depth) {\n\tconst vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n\tconst vec4 bitMask = vec4(0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tvec4 comp = fract(depth * bitShift);\n\tcomp -= comp.xxyz * bitMask;\n\treturn comp;\n}\n\nvoid main() {\n\tvec4 textureColor = texture(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfloat d = (depth + 1.0) * 0.5;\n\n\tif (hasFloat == 1) {\n\t\tfragColor = vec4(d, d, d, 1.0);\n\t}\n\telse {\n\t\tfragColor = pack(d);\n\t}\n\n}\n","shaders/webgl2/forward_shadow.vert":"#version 300 es\n\n/** Directional light shadow-map */\nin vec3 position;\nin vec2 texcoord2d0;\n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nout float depth;\nout vec2 uv;\n\nvoid main() {\n\tvec4 viewPosition = modelview * vec4(position, 1.0);\n\tvec4 clipPosition = projection * viewPosition;\n\tdepth = clipPosition.z;\n\tuv = texcoord2d0;\n\tgl_Position = clipPosition;\n}\n","shaders/webgl2/forward_shadow_vsm.frag":"#version 300 es\n\n/** Directional light shadow-map */\nprecision highp float;\n\nuniform vec4 diffuse;\nuniform sampler2D diffuse0;\n\nin float depth;\nin vec2 uv;\nout vec4 fragColor;\n\nvoid main() {\n\tvec4 textureColor = texture(diffuse0, uv);\n\tvec4 color = diffuse * textureColor;\n\tif (color.a < 0.99)\n\t\tdiscard;\n\n\tfloat d = (depth + 1.0) * 0.5;\n\tfloat dx = dFdx(d);\n\tfloat dy = dFdy(d);\n\n\tfragColor = vec4(d, pow(d, 2.0) + 0.25*(dx * dx + dy * dy), 0.0, 1.0);\n}\n","shaders/webgl2/normalmapped.frag":"// Normal mapped diffuse shader\nprecision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D normal0;\nuniform sampler2D shadow0;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying mat3 tbn;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 encodedNormal = texture2D(normal0, uv0);\n\t// vec3 localCoords = 2.0 * encodedNormal.rgb - vec3(1.0);\n\tvec3 localCoords = vec3(2.0 * encodedNormal.rg - vec2(1.0), encodedNormal.b);\n\tvec3 normalDirection = normalize(tbn * localCoords);\n\tvec3 N = normalize(mat3(view) * normalDirection);\n\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\n\treturn ambientColor + (diffuseColor + specularColor) * shadow;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tvec4 color = lighting(shadow);\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/webgl2/normalmapped.vert":"// Normal mapped diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\nattribute vec3 tangent;\nattribute vec3 bitangent;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\nuniform vec3 lightDirection;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying mat3 tbn;\n\nhighp mat3 transpose(in highp mat3 m) {\n\thighp vec3 i0 = m[0];\n\thighp vec3 i1 = m[1];\n\thighp vec3 i2 = m[2];\n\thighp mat3 outMatrix = mat3(\n\t\tvec3(i0.x, i1.x, i2.x),\n\t\tvec3(i0.y, i1.y, i2.y),\n\t\tvec3(i0.z, i1.z, i2.z)\n\t);\n\treturn outMatrix;\n}\n\nvoid main() {\n\tuv0 = texcoord2d0; // TODO: In the future this will probably need to use texture offset and scale uniforms\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = normalize(mat3(modelview) * normal);\n\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\ttbn[0] = normalize(vec3(model * vec4(tangent, 0.0)));\n\ttbn[1] = normalize(vec3(model * vec4(bitangent, 0.0)));\n\ttbn[2] = worldNormal;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/positionbuffer.frag":"//Normal buffer\nprecision highp float;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform mat4 modelview;\n\nvarying vec4 worldPosition;\nvarying vec4 viewPosition;\nvarying vec3 worldNormal;\nvarying vec3 viewNormal;\n\nvec4 pack(float depth) {\n\tconst vec4 bitShift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);\n\tconst vec4 bitMask = vec4(0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tvec4 comp = fract(depth * bitShift);\n\tcomp -= comp.xxyz * bitMask;\n\treturn comp;\n}\n\nvoid main() {\n\tfloat linDepth = (-viewPosition.z - zNear) / (zFar - zNear);\n\tgl_FragColor = pack(linDepth);\n}\n","shaders/webgl2/positionbuffer.vert":"//Normal buffer\nattribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec4 worldPosition;\nvarying vec4 viewPosition;\nvarying vec3 worldNormal;\nvarying vec3 viewNormal;\n\nvoid main() {\n    worldPosition = model * vec4(position, 1.0);\n    viewPosition = view * worldPosition;\n    worldNormal = normalize(mat3(model)*normal);\n    viewNormal = mat3(modelview) * normal;\n    \n    gl_Position = projection * viewPosition;\n}","shaders/webgl2/postprocess_blur.frag":"#version 300 es\n\n/**\n * Blur post-process\n * http://www.sunsetlakesoftware.com/2013/10/21/optimizing-gaussian-blurs-mobile-gpu\n */\n\nprecision highp float;\n\nuniform sampler2D src;\n\nin highp vec2 blurCoords[5];\nout vec4 fragColor;\n\nvoid main () {\n\tlowp vec4 sum = vec4(0.0);\n\tsum += texture(src, blurCoords[0]) * 0.204164;\n\tsum += texture(src, blurCoords[1]) * 0.304005;\n\tsum += texture(src, blurCoords[2]) * 0.304005;\n\tsum += texture(src, blurCoords[3]) * 0.093913;\n\tsum += texture(src, blurCoords[4]) * 0.093913;\n\tfragColor = sum;\n}\n","shaders/webgl2/postprocess_blur.vert":"#version 300 es\n\n/**\n * Blur post-process\n * http://www.sunsetlakesoftware.com/2013/10/21/optimizing-gaussian-blurs-mobile-gpu\n */\n\nin vec3 position;\nin vec2 uv0;\n\nuniform vec2 ViewportSize;\nuniform vec2 BlurSize;\n\nout vec2 blurCoords[5];\n\nvoid main() {\n\tvec2 offset = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y) * BlurSize;\n\n\tblurCoords[0] = uv0;\n\tblurCoords[1] = uv0 + offset * 1.407333;\n\tblurCoords[2] = uv0 - offset * 1.407333;\n\tblurCoords[3] = uv0 + offset * 3.294215;\n\tblurCoords[4] = uv0 - offset * 3.294215;\n\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/postprocess_fxaa.frag":'#version 300 es\n\n/**\n * FXAA post-process\n *\n * Based on webgl-meincraft FXAA implementation.\n * https://github.com/mitsuhiko/webgl-meincraft/blob/master/assets/shaders/fxaa.glsl\n */\n\n/*\nCopyright (c) 2011 by Armin Ronacher.\n\nSome rights reserved.\n\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are\nmet:\n\n    * Redistributions of source code must retain the above copyright\n      notice, this list of conditions and the following disclaimer.\n\n    * Redistributions in binary form must reproduce the above\n      copyright notice, this list of conditions and the following\n      disclaimer in the documentation and/or other materials provided\n      with the distribution.\n\n    * The names of the contributors may not be used to endorse or\n      promote products derived from this software without specific\n      prior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\nOWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\nSPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\nLIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n*/\n\n/**\n * Basic FXAA implementation based on the code on geeks3d.com with the\n * modification that the texture2DLod stuff was removed since it\'s\n * unsupported by WebGL.\n */\n\nprecision highp float;\n\nuniform sampler2D src;\n\nuniform vec2 ViewportSize;\nuniform float reduce_min;\nuniform float reduce_mul;\nuniform float span_max;\n\nin vec2 uv;\nout vec4 fragColor;\n\nvec4 fxaa(sampler2D tex, vec2 texCoord) {\n\tvec4 color;\n\tvec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n\tvec3 rgbNW = texture(tex, texCoord + vec2(-1.0, -1.0) * inverseVP).xyz;\n\tvec3 rgbNE = texture(tex, texCoord + vec2(1.0, -1.0) * inverseVP).xyz;\n\tvec3 rgbSW = texture(tex, texCoord + vec2(-1.0, 1.0) * inverseVP).xyz;\n\tvec3 rgbSE = texture(tex, texCoord + vec2(1.0, 1.0) * inverseVP).xyz;\n\tvec3 rgbM = texture(tex, texCoord).xyz;\n\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\n\tfloat lumaNW = dot(rgbNW, luma);\n\tfloat lumaNE = dot(rgbNE, luma);\n\tfloat lumaSW = dot(rgbSW, luma);\n\tfloat lumaSE = dot(rgbSE, luma);\n\tfloat lumaM = dot(rgbM, luma);\n\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n\tvec2 dir;\n\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\tdir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * reduce_mul), reduce_min);\n\n\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\tdir = min(vec2(span_max, span_max), max(vec2(-span_max, -span_max), dir * rcpDirMin)) * inverseVP;\n\n\tvec3 rgbA = 0.5 * (\n\t\ttexture(tex, texCoord + dir * (1.0 / 3.0 - 0.5)).xyz +\n\t\ttexture(tex, texCoord + dir * (2.0 / 3.0 - 0.5)).xyz);\n\tvec3 rgbB = rgbA * 0.5 + 0.25 * (\n\t\ttexture(tex, texCoord + dir * -0.5).xyz +\n\t\ttexture(tex, texCoord + dir * 0.5).xyz);\n\n\tfloat lumaB = dot(rgbB, luma);\n\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\tcolor = vec4(rgbA, 1.0);\n\telse\n\t\tcolor = vec4(rgbB, 1.0);\n\treturn color;\n}\n\nvoid main () {\n\tfragColor = fxaa(src, uv);\n}\n',"shaders/webgl2/postprocess_fxaa.vert":"#version 300 es\n\n/** FXAA post-process effect vertex shader */\n\nin vec3 position;\nin vec2 uv0;\n\nout vec2 uv;\n\nvoid main() {\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/postprocess_ssao.frag":"#version 300 es\n\n/*\n * Screen space ambient occlusion post process\n *\n * SSAO GLSL shader v1.2\n * assembled by Martins Upitis (martinsh) (devlog-martinsh.blogspot.com)\n * original technique is made by Arkano22 (www.gamedev.net/topic/550699-ssao-no-halo-artifacts/)\n *\n * Changelog:\n * 1.2 - added fog calculation to mask AO. Minor fixes.\n * 1.1 - added spiral sampling method from here:\n * (http://www.cgafaq.info/wiki/Evenly_distributed_points_on_sphere)\n */\n\nprecision highp float;\n\n#define PI 3.14159265\n\nuniform sampler2D depth0;\nuniform sampler2D oitWeight;\nuniform sampler2D src;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform int ssaoOnly;\nuniform float gdisplace; // Gauss bell center, default: 0.3\nuniform float radius; // AO radius, default: 2.0\nuniform float brightness; // AO brightness, default: 1.0\nuniform float luminanceInfluence; // how much luminance affects occlusion, default: 0.7\n\nout vec4 fragColor;\n\nconst int samples = 16;\n// const int samples = 8;\n\nfloat aoclamp = 0.25; // depth clamp - reduces haloing at screen edges\nbool noise = true; // use noise instead of pattern for sample dithering\nfloat noiseamount = 0.0002; // dithering amount\nfloat diffarea = 0.4; // self-shadowing reduction\n\nvec2 rand(vec2 coord) {\n\tfloat noiseX = ((fract(1.0-coord.s*(ViewportSize.x/2.0))*0.25)+(fract(coord.t*(ViewportSize.y/2.0))*0.75))*2.0-1.0;\n\tfloat noiseY = ((fract(1.0-coord.s*(ViewportSize.x/2.0))*0.75)+(fract(coord.t*(ViewportSize.y/2.0))*0.25))*2.0-1.0;\n\tif (noise) {\n\t\tnoiseX = clamp(fract(sin(dot(coord, vec2(12.9898,78.233))) * 43758.5453),0.0,1.0)*2.0-1.0;\n\t\tnoiseY = clamp(fract(sin(dot(coord, vec2(12.9898,78.233)*2.0)) * 43758.5453),0.0,1.0)*2.0-1.0;\n\t}\n\treturn vec2(noiseX, noiseY) * noiseamount;\n}\n\nfloat readDepth(in vec2 coord) {\n\treturn texture(depth0, coord).r;\n}\n\nfloat compareDepths(in float depth1, in float depth2, inout int far) {\n\tfloat garea = 2.0; // gauss bell width\n\tfloat diff = (depth1 - depth2)*100.0; // depth difference (0-100)\n\t// reduce left bell width to avoid self-shadowing\n\tif (diff<gdisplace) {\n\t\tgarea = diffarea;\n\t}\n\telse {\n\t\tfar = 1;\n\t}\n\n\tfloat gauss = pow(2.7182,-2.0*(diff-gdisplace)*(diff-gdisplace)/(garea*garea));\n\treturn gauss;\n}\n\nfloat calAO(vec2 uv, float depth, float dw, float dh) {\n\tfloat dd = (1.0-depth) * radius;\n\n\tfloat temp = 0.0;\n\tfloat temp2 = 0.0;\n\tfloat coordw = uv.x + dw*dd;\n\tfloat coordh = uv.y + dh*dd;\n\tfloat coordw2 = uv.x - dw*dd;\n\tfloat coordh2 = uv.y - dh*dd;\n\n\tvec2 coord = vec2(coordw , coordh);\n\tvec2 coord2 = vec2(coordw2, coordh2);\n\n\tint far = 0;\n\ttemp = compareDepths(depth, readDepth(coord), far);\n\t//DEPTH EXTRAPOLATION:\n\tif (far > 0) {\n\t\ttemp2 = compareDepths(readDepth(coord2), depth, far);\n\t\ttemp += (1.0-temp)*temp2;\n\t}\n\n\treturn temp;\n}\n\nvoid main() {\n\tvec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n\tvec2 texCoord = gl_FragCoord.xy * inverseVP;\n\n\tvec2 noise = rand(texCoord);\n\tfloat depth = readDepth(texCoord);\n\tfloat reveal = texture(oitWeight, texCoord).a;\n\n\tfloat w = inverseVP.x/clamp(depth, aoclamp,1.0)+(noise.x*(1.0-noise.x));\n\tfloat h = inverseVP.y/clamp(depth, aoclamp,1.0)+(noise.y*(1.0-noise.y));\n\n\tfloat pw;\n\tfloat ph;\n\n\tfloat ao;\n\n\tfloat dl = PI*(3.0-sqrt(5.0));\n\tfloat dz = 1.0/float(samples);\n\tfloat l = 0.0;\n\tfloat z = 1.0 - dz/2.0;\n\n\tfor (int i = 0; i <= samples; i++) {\n\t\tfloat r = sqrt(1.0-z);\n\t\tpw = cos(l)*r;\n\t\tph = sin(l)*r;\n\t\tao += calAO(texCoord, depth, pw*w, ph*h);\n\t\tz = z - dz;\n\t\tl = l + dl;\n\t}\n\n\tao /= float(samples) * brightness;\n\tao = 1.0 - ao * reveal;\n\n\tvec3 color = texture(src, texCoord).rgb;\n\tvec3 lumcoeff = vec3(0.299, 0.587, 0.114);\n\tfloat lum = dot(color.rgb, lumcoeff);\n\tvec3 luminance = vec3(lum, lum, lum);\n\tvec3 final = vec3(color*mix(vec3(ao),vec3(1.0), luminance * luminanceInfluence));\n\n\tif (ssaoOnly == 1) {\n\t\tfinal = vec3(mix(vec3(ao),vec3(1.0),luminance * luminanceInfluence));\n\t}\n\n\tfragColor = vec4(final, 1.0);\n}\n","shaders/webgl2/postprocess_ssao.vert":"#version 300 es\n\n/*\n * Screen space ambient occlusion post process\n */\nin vec3 position;\n\nvoid main() {\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/reflective.frag":"precision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\nuniform mat4 viewInverse;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\nuniform samplerCube env0;\n\nuniform float materialBlend;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\nuniform int useLighting;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\nvec4 reflection() {\n\tvec3 eyeDirection = normalize(-viewPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = textureCube(env0, lookup);\n\treturn color;\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\tvec4 color = ambientColor + (diffuseColor + specularColor) * shadow;\n\treturn color;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tvec4 color = reflection();\n\n\tif (useLighting == 1) {\n\t\tcolor = mix(color, lighting(shadow), materialBlend);\n\t}\n\telse {\n\t\tvec4 textureColor = texture2D(diffuse0, uv0);\n\t\tcolor = mix(color, diffuse * textureColor, materialBlend);\n\t}\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/webgl2/reflective.vert":"// Diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/reflective_masked.frag":"precision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\nuniform mat4 viewInverse;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\nuniform samplerCube env0;\nuniform sampler2D mask;\n\nuniform float materialBlend;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\nuniform int useLighting;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\nvec4 reflection() {\n\tvec3 eyeDirection = normalize(-viewPosition.xyz);\n\tvec3 worldEyeDirection = normalize(mat3(viewInverse) * eyeDirection);\n\tvec3 lookup = reflect(worldEyeDirection, worldNormal) * vec3(-1.0, 1.0, 1.0);\n\tvec4 color = textureCube(env0, lookup);\n\treturn color;\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\tvec4 color = ambientColor + (diffuseColor + specularColor) * shadow;\n\treturn color;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\n\tfloat maskValue = texture2D(mask, uv0).r;\n\tvec4 color = reflection();\n\n\tif (useLighting == 1) {\n\t\tcolor = mix(color, lighting(shadow), maskValue * materialBlend);\n\t}\n\telse {\n\t\tvec4 textureColor = texture2D(diffuse0, uv0);\n\t\tcolor = mix(color, diffuse * textureColor, maskValue * materialBlend);\n\t}\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n}\n","shaders/webgl2/reflective_masked.vert":"// Diffuse shader\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvoid main() {\n\tuv0 = texcoord2d0;\n\tworldPosition = model * vec4(position, 1.0);\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/shadow_blur.frag":"/**\n * Shadow blur\n */\n\nprecision highp float;\n\nuniform sampler2D src;\n\nvarying vec2 uv;\nvarying highp vec2 blurCoords[14];\n\nvoid main () {\n\tlowp vec4 sum = vec4(0.0);\n\tsum += texture2D(src, blurCoords[ 0])*0.0044299121055113265;\n\tsum += texture2D(src, blurCoords[ 1])*0.00895781211794;\n\tsum += texture2D(src, blurCoords[ 2])*0.0215963866053;\n\tsum += texture2D(src, blurCoords[ 3])*0.0443683338718;\n\tsum += texture2D(src, blurCoords[ 4])*0.0776744219933;\n\tsum += texture2D(src, blurCoords[ 5])*0.115876621105;\n\tsum += texture2D(src, blurCoords[ 6])*0.147308056121;\n\tsum += texture2D(src, uv            )*0.159576912161;\n\tsum += texture2D(src, blurCoords[ 7])*0.147308056121;\n\tsum += texture2D(src, blurCoords[ 8])*0.115876621105;\n\tsum += texture2D(src, blurCoords[ 9])*0.0776744219933;\n\tsum += texture2D(src, blurCoords[10])*0.0443683338718;\n\tsum += texture2D(src, blurCoords[11])*0.0215963866053;\n\tsum += texture2D(src, blurCoords[12])*0.00895781211794;\n\tsum += texture2D(src, blurCoords[13])*0.0044299121055113265;\n\tgl_FragColor = sum;\n}\n","shaders/webgl2/shadow_blurh.vert":"/**\n * Shadow blur - horizontal\n */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nuniform sampler2D src;\n\nvarying vec2 uv;\nvarying vec2 blurCoords[14];\n\nvoid main() {\n\tfloat blurSize = 0.2;\n\tblurCoords[ 0] = uv0 + vec2(-0.028, 0.0) * blurSize;\n\tblurCoords[ 1] = uv0 + vec2(-0.024, 0.0) * blurSize;\n\tblurCoords[ 2] = uv0 + vec2(-0.020, 0.0) * blurSize;\n\tblurCoords[ 3] = uv0 + vec2(-0.016, 0.0) * blurSize;\n\tblurCoords[ 4] = uv0 + vec2(-0.012, 0.0) * blurSize;\n\tblurCoords[ 5] = uv0 + vec2(-0.008, 0.0) * blurSize;\n\tblurCoords[ 6] = uv0 + vec2(-0.004, 0.0) * blurSize;\n\tblurCoords[ 7] = uv0 + vec2( 0.004, 0.0) * blurSize;\n\tblurCoords[ 8] = uv0 + vec2( 0.008, 0.0) * blurSize;\n\tblurCoords[ 9] = uv0 + vec2( 0.012, 0.0) * blurSize;\n\tblurCoords[10] = uv0 + vec2( 0.016, 0.0) * blurSize;\n\tblurCoords[11] = uv0 + vec2( 0.020, 0.0) * blurSize;\n\tblurCoords[12] = uv0 + vec2( 0.024, 0.0) * blurSize;\n\tblurCoords[13] = uv0 + vec2( 0.028, 0.0) * blurSize;\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/shadow_blurv.vert":"/**\n * Shadow blur - vertical\n */\n\nattribute vec3 position;\nattribute vec2 uv0;\n\nuniform sampler2D src;\n\nvarying vec2 uv;\nvarying vec2 blurCoords[14];\n\nvoid main() {\n\tfloat blurSize = 0.2;\n\tblurCoords[ 0] = uv0 + vec2(0.0, -0.028) * blurSize;\n\tblurCoords[ 1] = uv0 + vec2(0.0, -0.024) * blurSize;\n\tblurCoords[ 2] = uv0 + vec2(0.0, -0.020) * blurSize;\n\tblurCoords[ 3] = uv0 + vec2(0.0, -0.016) * blurSize;\n\tblurCoords[ 4] = uv0 + vec2(0.0, -0.012) * blurSize;\n\tblurCoords[ 5] = uv0 + vec2(0.0, -0.008) * blurSize;\n\tblurCoords[ 6] = uv0 + vec2(0.0, -0.004) * blurSize;\n\tblurCoords[ 7] = uv0 + vec2(0.0,  0.004) * blurSize;\n\tblurCoords[ 8] = uv0 + vec2(0.0,  0.008) * blurSize;\n\tblurCoords[ 9] = uv0 + vec2(0.0,  0.012) * blurSize;\n\tblurCoords[10] = uv0 + vec2(0.0,  0.016) * blurSize;\n\tblurCoords[11] = uv0 + vec2(0.0,  0.020) * blurSize;\n\tblurCoords[12] = uv0 + vec2(0.0,  0.024) * blurSize;\n\tblurCoords[13] = uv0 + vec2(0.0,  0.028) * blurSize;\n\tuv = uv0;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n","shaders/webgl2/skybox.frag":"#version 300 es\n\nprecision highp float;\n\nuniform samplerCube skybox0;\n\nin vec3 uv0;\nout vec4 fragColor;\n\nvoid main(void) {\n\tfragColor = texture(skybox0, uv0);\n}\n","shaders/webgl2/skybox.vert":"#version 300 es\n\nin vec3 position;\nin vec3 normal;\nin vec2 texcoord2d0;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nout vec3 uv0;\n\nvoid main(void) {\n\tuv0 = vec3(position.x, -position.yz);\n\tgl_Position = projection * view * model * vec4(position, 1.0);\n}\n","shaders/webgl2/ssao.frag":"precision highp float;\n\nuniform sampler2D position0;\n\nuniform mat4 projection;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform float ssaoGDisplace;\nuniform float ssaoRadius;\nuniform float ssaoDivider;\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nfloat unpack(vec4 c) {\n    const vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n    return dot(c, bitShifts);\n}\n\nfloat getDepth(vec2 coord) {\n    float d = unpack(texture2D(position0, coord.xy));\n    if (d == 0.0)\n        d = 1.0;\n    return d;\n}\n\nfloat doAmbientOcclusion(vec2 coord, vec2 coord2, float d) {\n    float diff = getDepth(coord + coord2) - d;\n    float gDisplace = -0.0002 - (0.00002 * max(min(ssaoGDisplace, 10.0), 0.0));\n    //float gDisplace = -0.00032;\n    return (diff < gDisplace) ? pow(EULER, -2.0 * (diff - gDisplace) * (diff - gDisplace) * 10000.0 / 0.16) : 0.0;\n}\n\nvoid main() {\n    vec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n    \n    vec2 c = gl_FragCoord.xy * inverseVP;\n    \n    float ao = 0.0;\n\n    float dz = 1.0 / 8.0;\n    float z = 1.0 - dz / 2.0;\n    float l = 0.0;\n\n    float depth = getDepth(c);\n\n    for (int i = 0; i <= 8; i++) {\n        float r = sqrt(1.0 - z);\n\n        vec2 p = vec2(cos(l) * r, sin(l) * r);\n        ao += doAmbientOcclusion(c, p * ssaoRadius * inverseVP.x * (1.0 - depth), depth);\n        z = z - dz;\n        l = l + DL;\n    }\n\n    ao /= 8.0 + max(min(ssaoDivider, 1.0), -1.0);\n    //ao /= 8.5;\n    \n    ao = max(0.0, ao * 2.0 - 1.0);\n    ao = 1.0 - ao;\n    gl_FragColor = vec4(ao, ao, ao, 1.0);\n    //gl_FragColor = vec4(depth, depth, depth, 1.0);\n    //gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n}","shaders/webgl2/ssao.vert":"attribute vec3 position;\n\nvoid main() {\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}","shaders/webgl2/ssaoblur.frag":"precision highp float;\n\nuniform sampler2D ao0;\nuniform sampler2D src;\n\nuniform mat4 projection;\n\nuniform float zNear;\nuniform float zFar;\nuniform vec2 ViewportSize;\n\nuniform int ssaoBlurSize;\nuniform int ssaoOnly;\n\nfloat random(vec2 co) {\n    //co = mod(co, 128.0);\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvoid main() {\n    vec2 inverseVP = vec2(1.0 / ViewportSize.x, 1.0 / ViewportSize.y);\n    \n    const int MAXIMUM_BLUR = 32;\n    float result = 0.0;\n    vec2 hlim = vec2(float(-ssaoBlurSize) * 0.5 + 0.5);\n    for (int i = 0; i < MAXIMUM_BLUR; i++) {\n        if (i >= ssaoBlurSize)\n            break;\n        for (int j = 0; j < MAXIMUM_BLUR; j++) {\n            if (j >= ssaoBlurSize)\n                break;\n            vec2 offset = (hlim + vec2(float(i), float(j))) * inverseVP;\n            result += texture2D(ao0, gl_FragCoord.xy * inverseVP + offset).r;\n        }\n    }\n    result = result / float(ssaoBlurSize * ssaoBlurSize);\n\n    if (ssaoOnly == 1) {\n        gl_FragColor = vec4(vec3(result), 1.0);\n    }\n    else {\n        gl_FragColor = vec4(texture2D(src, gl_FragCoord.xy * inverseVP).xyz * result, 1.0);\n    }\n    //gl_FragColor = vec4(texture2D(src, gl_FragCoord.xy * inverseVP).xyz * texture2D(ao0, gl_FragCoord.xy * inverseVP/* / 2.0 + 0.5*/).xyz, 1.0);\n}","shaders/webgl2/ssaoblur.vert":"attribute vec3 position;\n\nvoid main() {\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}","shaders/webgl2/terrain.frag":"// Terrain shader for the forward renderer\n\nprecision highp float;\n\nuniform mat4 modelview;\nuniform mat4 view;\n\nuniform vec4 ambient;\nuniform vec4 diffuse;\nuniform float specularStrength;\nuniform int specularPower;\n\nuniform vec3 lightDirection;\nuniform vec4 lightColor;\nuniform float lightIntensity;\nuniform float shadowBias;\n\nuniform sampler2D diffuse0;\nuniform sampler2D shadow0;\n\nuniform int hasFloat;\nuniform int useVSM;\nuniform int useShadows;\nuniform int receiveShadows;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying vec3 bc;\n\nfloat unpack(vec4 c) {\n\tconst vec4 bitShifts = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);\n\treturn dot(c, bitShifts);\n}\n\n/** Computes color and directional lighting */\nvec4 lighting(float shadow) {\n\tvec4 textureColor = texture2D(diffuse0, uv0);\n\tvec3 N = normalize(viewNormal);\n\tvec3 L = normalize(mat3(view)*lightDirection);\n\tvec3 V = normalize(-viewPosition.xyz);\n\tvec3 H = normalize(L + V);\n\tfloat diffuseLight = max(dot(N, L), 0.0) * lightIntensity;\n\tfloat specularLight = min(max(dot(N, H), 0.0), 1.0);\n\tspecularLight = pow(specularLight, float(specularPower));\n\n\tvec4 ambientColor = ambient * textureColor;\n\tvec4 diffuseColor = diffuse * diffuse * textureColor * lightColor * diffuseLight;\n\tvec4 specularColor = lightColor * specularLight * specularStrength;\n\n\treturn ambientColor + (diffuseColor + specularColor) * shadow;\n}\n\nfloat linstep(float low, float high, float v) {\n\treturn clamp((v-low)/(high-low), 0.0, 1.0);\n}\n\nfloat VSM(vec2 moments, float compare) {\n\tfloat p = smoothstep(compare - shadowBias, compare, moments.x);\n\tfloat variance = max(moments.y - moments.x*moments.x, -0.001);\n\tfloat d = compare - moments.x;\n\tfloat p_max = linstep(0.2, 1.0, variance / (variance + d*d));\n\treturn clamp(max(p, p_max), 0.0, 1.0);\n}\n\nfloat shadowmap() {\n\tvec2 uv = shadowPosition.xy / shadowPosition.w;\n\tuv = uv * 0.5 + 0.5;\n\tvec4 shadowTexel = texture2D(shadow0, uv);\n\n\tfloat depth;\n\tif (hasFloat == 1)\n\t\tdepth = shadowTexel.r;\n\telse\n\t\tdepth = unpack(shadowTexel);\n\n\tfloat lightDepth = (shadowPosition.z + 1.0) * 0.5;\n\n\tif (useVSM == 1)\n\t\treturn VSM(shadowTexel.xy, lightDepth);\n\n\treturn step(lightDepth - shadowBias, depth);\n}\n\nvoid main(void) {\n\tfloat shadow = 1.0;\n\tif (useShadows > 0 && receiveShadows > 0) {\n\t\tshadow = shadowmap();\n\t}\n\tvec4 color = lighting(shadow);\n\tgl_FragColor = clamp(color, 0.0, 1.0);\n\n\t// gl_FragColor = vec4(bc, 1.0); // for debug\n}\n","shaders/webgl2/terrain.vert":"// Terrain shader for the forward renderer\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord2d0;\nattribute vec3 barycentric;\n\nuniform mat4 model;\nuniform mat4 view;\nuniform mat4 modelview;\nuniform mat4 projection;\nuniform mat4 lightProjection;\nuniform mat4 lightView;\n\nuniform sampler2D height;\n\nuniform float verticalScale;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\n\nvarying vec2 uv0;\nvarying vec4 worldPosition;\nvarying vec3 worldNormal;\nvarying vec4 viewPosition;\nvarying vec3 viewNormal;\nvarying vec4 shadowPosition;\n\nvarying vec3 bc;\n\nfloat snap(float f, float step) {\n\treturn step * floor(f / step);\n}\n\nvoid main() {\n\tbc = barycentric;\n\tuv0 = texcoord2d0 * uvScale + uvOffset;\n\tworldPosition = model * vec4(position, 1.0);\n\n\t// worldPosition.x = snap(worldPosition.x, worldPosition.y);\n\t// worldPosition.z = snap(worldPosition.z, worldPosition.y);\n\n\tfloat height = texture2D(height, uv0).r;\n\tworldPosition.y = height * verticalScale;\n\t// worldPosition.y = 0.0;\n\n\tworldNormal = normalize(mat3(model) * normal);\n\tviewPosition = view * worldPosition;\n\tviewNormal = mat3(modelview) * normal;\n\n\tshadowPosition = lightProjection * lightView * worldPosition;\n\n\tgl_Position = projection * viewPosition;\n}\n","shaders/webgl2/test.frag":"// Test fragment shader drawing in blue \n\nprecision mediump float; \n\nvoid main(void) { \n\tgl_FragColor = vec4(0.1, 0.5, 0.8, 1.0); \n}","shaders/webgl2/test.vert":"// Test pass-through shader that doesn't transform vertex\nattribute vec3 position; \nattribute vec3 normal; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\n\nvoid main(void) { \n\tfragNormal=mat3(modelview)*normal;\n\tfragPosition=projection*modelview*vec4(position, 1.0);\n\tgl_Position = fragPosition; \n}\n","shaders/webgl2/transparent.frag":"// Unlit transparency shader\nprecision mediump float; \n\nuniform vec4 diffuse;\n\nuniform sampler2D diffuse0;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main(void) {\n\tgl_FragColor = diffuse*texture2D(diffuse0, fragTexcoord2d0);\n}","shaders/webgl2/transparent.vert":"// Unlit transparency shader\nattribute vec3 position; \nattribute vec3 normal; \nattribute vec2 texcoord2d0; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragNormal;\nvarying vec4 fragPosition;\nvarying vec2 fragTexcoord2d0;\n\nvoid main() {\n\tfragNormal=mat3(modelview)*normal;\n\tfragPosition=modelview*vec4(position, 1.0);\n\tfragTexcoord2d0=texcoord2d0;\n\tgl_Position=projection*fragPosition;\n}\n","shaders/webgl2/wireframe.frag":"// Test fragment shader drawing in blue \nprecision mediump float; \n\nvarying vec3 fragBarycentric;\n\nvoid main(void) { \n\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, \n\t\t\tpow(1.0-fragBarycentric.r, 32.0)+pow(1.0-fragBarycentric.g, 32.0)+pow(1.0-fragBarycentric.b, 32.0));\n}","shaders/webgl2/wireframe.vert":"// Diffuse shader\nattribute vec3 position; \nattribute vec3 barycentric; \n\nuniform mat4 modelview;\nuniform mat4 projection;\n\nvarying vec3 fragBarycentric;\n\nvoid main(void) { \n\tgl_Position=projection*modelview*vec4(position, 1.0); \n\tfragBarycentric = barycentric;\n}"}};